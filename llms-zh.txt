================================================================================
HEMLOCK PROGRAMMING LANGUAGE - COMPLETE DOCUMENTATION (ä¸­æ–‡)
================================================================================

This file contains the complete documentation for the Hemlock programming
language and the hpm package manager in ä¸­æ–‡.
It is optimized for LLM consumption.

Source: https://github.com/hemlang/hem-doc

--------------------------------------------------------------------------------
TABLE OF CONTENTS
--------------------------------------------------------------------------------

  1. æ¬¢è¿
  2. è¯­è¨€å‚è€ƒ

[å¿«é€Ÿå…¥é—¨]
  3. å­¦ä¹ è·¯å¾„
  4. å®‰è£…
  5. å¿«é€Ÿå¼€å§‹
  6. æ•™ç¨‹

[è¯­è¨€æŒ‡å—]
  7. å†…å­˜ç®¡ç†
  8. å‡½æ•°
  9. å­—ç¬¦(Rune)
  10. å­—ç¬¦ä¸²
  11. å¯¹è±¡
  12. æ§åˆ¶æµ
  13. æ•°ç»„
  14. æ¨¡å—
  15. æ¨¡å¼åŒ¹é…
  16. ç±»å‹
  17. è¯­æ³•
  18. é”™è¯¯å¤„ç†

[é«˜çº§ä¸»é¢˜]
  19. FFI
  20. File IO
  21. ä¿¡å·å¤„ç†
  22. åŸå­æ“ä½œ
  23. å‘½ä»¤æ‰§è¡Œ
  24. å‘½ä»¤è¡Œå‚æ•°
  25. å¼‚æ­¥ä¸å¹¶å‘
  26. æ€§èƒ½åˆ†æ
  27. æ‰“åŒ…ä¸å‘å¸ƒ

[API å‚è€ƒ]
  28. å†…å­˜ API
  29. å†…ç½®å‡½æ•°
  30. å­—ç¬¦ä¸² API
  31. å¹¶å‘ API
  32. æ•°ç»„ API
  33. æ–‡ä»¶ API
  34. ç±»å‹ç³»ç»Ÿ
  35. è¿ç®—ç¬¦

[è®¾è®¡ä¸ç†å¿µ]
  36. å®ç°ç»†èŠ‚
  37. ç­¾åè¯­æ³•
  38. è®¾è®¡ç†å¿µ

[è´¡çŒ®æŒ‡å—]
  39. æµ‹è¯•
  40. è´¡çŒ®æŒ‡å—

[hpm: å¿«é€Ÿå…¥é—¨]
  41. å®‰è£…
  42. å¿«é€Ÿå¼€å§‹
  43. é¡¹ç›®è®¾ç½®

[hpm: ç”¨æˆ·æŒ‡å—]
  44. å‘½ä»¤
  45. æ•…éšœæ’é™¤
  46. é…ç½®

[hpm: åŒ…å¼€å‘]
  47. åˆ›å»ºåŒ…
  48. åŒ…è§„èŒƒ
  49. ç‰ˆæœ¬æ§åˆ¶

[hpm: å‚è€ƒ]
  50. æ¶æ„
  51. é€€å‡ºç 


================================================================================
DOCUMENTATION
================================================================================

--------------------------------------------------------------------------------
## æ¬¢è¿
--------------------------------------------------------------------------------

# æ¬¢è¿ä½¿ç”¨ Hemlock

> "ä¸€é—¨å°å·§çš„éå®‰å…¨è¯­è¨€ï¼Œç”¨äºå®‰å…¨åœ°ç¼–å†™ä¸å®‰å…¨çš„ä¸œè¥¿ã€‚"

**Hemlock** æ˜¯ä¸€é—¨ç³»ç»Ÿçº§è„šæœ¬è¯­è¨€ï¼Œå°† C è¯­è¨€çš„å¼ºå¤§åŠŸèƒ½ä¸ç°ä»£è„šæœ¬çš„ä¾¿æ·æ€§ç›¸ç»“åˆã€‚å®ƒå…·æœ‰æ‰‹åŠ¨å†…å­˜ç®¡ç†ã€æ˜¾å¼æ§åˆ¶ä»¥åŠå†…ç½®çš„ç»“æ„åŒ–å¼‚æ­¥å¹¶å‘ã€‚

## ä»€ä¹ˆæ˜¯ Hemlockï¼Ÿ

Hemlock ä¸“ä¸ºä»¥ä¸‹ç¨‹åºå‘˜è®¾è®¡ï¼š

- **æ˜¾å¼æ§åˆ¶** å†…å­˜å’Œæ‰§è¡Œæµç¨‹
- **ç±» C è¯­æ³•** é…åˆç°ä»£ä¾¿æ·ç‰¹æ€§
- **æ— éšè—è¡Œä¸º** æˆ–é­”æ³•
- **çœŸæ­£çš„å¹¶è¡Œå¼‚æ­¥**ï¼ŒåŸºäº pthread çš„å¹¶å‘

Hemlock ä¸æ˜¯ä¸€é—¨å¸¦æœ‰åƒåœ¾å›æ”¶çš„å†…å­˜å®‰å…¨è¯­è¨€ã€‚ç›¸åï¼Œå®ƒä¸ºæ‚¨æä¾›å®‰å…¨å·¥å…·ï¼ˆ`buffer`ã€ç±»å‹æ³¨è§£ã€è¾¹ç•Œæ£€æŸ¥ï¼‰ï¼Œä½†ä¸å¼ºåˆ¶æ‚¨ä½¿ç”¨å®ƒä»¬ï¼ˆ`ptr`ã€æ‰‹åŠ¨å†…å­˜ç®¡ç†ã€ä¸å®‰å…¨æ“ä½œï¼‰ã€‚

## å¿«é€Ÿç¤ºä¾‹

```hemlock
// ä½ å¥½ï¼ŒHemlockï¼
fn greet(name: string): string {
    return `ä½ å¥½ï¼Œ${name}ï¼`;
}

let message = greet("ä¸–ç•Œ");
print(message);

// æ‰‹åŠ¨å†…å­˜ç®¡ç†
let buf = buffer(64);
buf[0] = 72;  // 'H'
buf[1] = 105; // 'i'
print(buf);
free(buf);
```

## åŠŸèƒ½æ¦‚è§ˆ

| åŠŸèƒ½ | æè¿° |
|------|------|
| **ç±»å‹ç³»ç»Ÿ** | i8-i64ã€u8-u64ã€f32/f64ã€boolã€stringã€runeã€ptrã€bufferã€arrayã€object |
| **å†…å­˜** | ä½¿ç”¨ `alloc()`ã€`buffer()`ã€`free()` è¿›è¡Œæ‰‹åŠ¨ç®¡ç† |
| **å¼‚æ­¥** | å†…ç½® `async`/`await`ï¼Œæ”¯æŒçœŸæ­£çš„ pthread å¹¶è¡Œ |
| **FFI** | ç›´æ¥ä»å…±äº«åº“è°ƒç”¨ C å‡½æ•° |
| **æ ‡å‡†åº“** | 40 ä¸ªæ¨¡å—ï¼ŒåŒ…æ‹¬ cryptoã€httpã€sqliteã€json ç­‰ |

## å¿«é€Ÿå…¥é—¨

å‡†å¤‡å¥½å¼€å§‹äº†å—ï¼Ÿä»¥ä¸‹æ˜¯å¼€å§‹æ­¥éª¤ï¼š

1. **[å®‰è£…](#getting-started-installation)** - ä¸‹è½½å¹¶è®¾ç½® Hemlock
2. **[å¿«é€Ÿå¼€å§‹](#getting-started-quick-start)** - å‡ åˆ†é’Ÿå†…ç¼–å†™æ‚¨çš„ç¬¬ä¸€ä¸ªç¨‹åº
3. **[æ•™ç¨‹](#getting-started-tutorial)** - é€æ­¥å­¦ä¹  Hemlock

## æ–‡æ¡£ç« èŠ‚

- **å¿«é€Ÿå…¥é—¨** - å®‰è£…ã€å¿«é€Ÿå¼€å§‹æŒ‡å—å’Œæ•™ç¨‹
- **è¯­è¨€æŒ‡å—** - æ·±å…¥äº†è§£è¯­æ³•ã€ç±»å‹ã€å‡½æ•°ç­‰
- **é«˜çº§ä¸»é¢˜** - å¼‚æ­¥ç¼–ç¨‹ã€FFIã€ä¿¡å·å’ŒåŸå­æ“ä½œ
- **API å‚è€ƒ** - å†…ç½®å‡½æ•°å’Œæ ‡å‡†åº“çš„å®Œæ•´å‚è€ƒ
- **è®¾è®¡ä¸ç†å¿µ** - ç†è§£ Hemlock ä¸ºä½•å¦‚æ­¤è®¾è®¡

## åŒ…ç®¡ç†å™¨

Hemlock è‡ªå¸¦ **hpm** åŒ…ç®¡ç†å™¨ï¼Œç”¨äºç®¡ç†ä¾èµ–ï¼š

```bash
hpm init my-project
hpm add some-package
hpm run
```

è¯·å‚é˜… hpm æ–‡æ¡£ç« èŠ‚äº†è§£æ›´å¤šè¯¦æƒ…ã€‚

---

ä½¿ç”¨å·¦ä¾§å¯¼èˆªæµè§ˆæ–‡æ¡£ï¼Œæˆ–ä½¿ç”¨æœç´¢æ æŸ¥æ‰¾ç‰¹å®šä¸»é¢˜ã€‚


--------------------------------------------------------------------------------
## è¯­è¨€å‚è€ƒ
--------------------------------------------------------------------------------

# Hemlock è¯­è¨€è®¾è®¡ç†å¿µ

> "ä¸€é—¨å°å·§ã€éå®‰å…¨çš„è¯­è¨€ï¼Œç”¨äºå®‰å…¨åœ°ç¼–å†™éå®‰å…¨ä»£ç ã€‚"

æœ¬æ–‡æ¡£æ¦‚è¿°äº† Hemlock çš„è®¾è®¡ç†å¿µï¼Œå¹¶æä¾›è¯­è¨€å¿«é€Ÿå‚è€ƒã€‚
è¯·æµè§ˆå…¶ä»–æ–‡æ¡£ç« èŠ‚ï¼Œè·å–è¯¦ç»†æŒ‡å—å’Œ API å‚è€ƒã€‚

---

## æ ¸å¿ƒå®šä½

Hemlock æ˜¯ä¸€é—¨**ç³»ç»Ÿè„šæœ¬è¯­è¨€**ï¼Œå…·æœ‰æ‰‹åŠ¨å†…å­˜ç®¡ç†å’Œæ˜¾å¼æ§åˆ¶ï¼š
- æ‹¥æœ‰ C è¯­è¨€çš„èƒ½åŠ›ï¼ŒåŒæ—¶å…·å¤‡ç°ä»£è„šæœ¬çš„ä¾¿åˆ©æ€§
- å†…ç½®ç»“æ„åŒ–å¼‚æ­¥å¹¶å‘
- æ— éšè—è¡Œä¸ºæˆ–é­”æ³•

**Hemlock ä¸æ˜¯ï¼š** å†…å­˜å®‰å…¨çš„ã€å¸¦åƒåœ¾å›æ”¶çš„è¯­è¨€ï¼Œä¹Ÿä¸ä¼šéšè—å¤æ‚æ€§ã€‚
**Hemlock æ˜¯ï¼š** æ˜¾å¼ä¼˜äºéšå¼ã€å…·æœ‰æ•™è‚²æ„ä¹‰ã€ç³»ç»Ÿå·¥ä½œçš„"C è„šæœ¬å±‚"ã€‚

---

## è®¾è®¡åŸåˆ™

### 1. æ˜¾å¼ä¼˜äºéšå¼
- åˆ†å·æ˜¯å¼ºåˆ¶æ€§çš„ï¼ˆæ— è‡ªåŠ¨åˆ†å·æ’å…¥ï¼‰
- æ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼ˆalloc/freeï¼‰
- ç±»å‹æ³¨è§£å¯é€‰ï¼Œä½†åœ¨è¿è¡Œæ—¶æ£€æŸ¥

### 2. é»˜è®¤åŠ¨æ€ï¼Œå¯é€‰ç±»å‹
- æ¯ä¸ªå€¼éƒ½æœ‰è¿è¡Œæ—¶ç±»å‹æ ‡ç­¾
- å­—é¢é‡æ¨æ–­ç±»å‹ï¼š`42` â†’ i32ï¼Œ`5000000000` â†’ i64ï¼Œ`3.14` â†’ f64
- å¯é€‰çš„ç±»å‹æ³¨è§£å¼ºåˆ¶æ‰§è¡Œè¿è¡Œæ—¶æ£€æŸ¥

### 3. éå®‰å…¨æ˜¯ç‰¹æ€§
- å…è®¸æŒ‡é’ˆè¿ç®—ï¼ˆç”¨æˆ·è‡ªè¡Œè´Ÿè´£ï¼‰
- åŸå§‹ `ptr` æ— è¾¹ç•Œæ£€æŸ¥ï¼ˆä½¿ç”¨ `buffer` è·å¾—å®‰å…¨æ€§ï¼‰
- å…è®¸åŒé‡é‡Šæ”¾å¯¼è‡´å´©æºƒ

### 4. ç»“æ„åŒ–å¹¶å‘æ˜¯ä¸€ç­‰å…¬æ°‘
- å†…ç½® `async`/`await`ï¼ŒåŸºäº pthread çš„å¹¶è¡Œ
- ç”¨äºé€šä¿¡çš„ channel
- `spawn`/`join`/`detach` ç”¨äºä»»åŠ¡ç®¡ç†

### 5. ç±» C è¯­æ³•
- `{}` å—æ€»æ˜¯å¿…éœ€çš„
- æ³¨é‡Šï¼š`// è¡Œæ³¨é‡Š` å’Œ `/* å—æ³¨é‡Š */`
- è¿ç®—ç¬¦ä¸ C ä¸€è‡´ï¼š`+`ã€`-`ã€`*`ã€`%`ã€`&&`ã€`||`ã€`!`ã€`&`ã€`|`ã€`^`ã€`<<`ã€`>>`
- è‡ªå¢/è‡ªå‡ï¼š`++x`ã€`x++`ã€`--x`ã€`x--`ï¼ˆå‰ç¼€å’Œåç¼€ï¼‰
- å¤åˆèµ‹å€¼ï¼š`+=`ã€`-=`ã€`*=`ã€`/=`ã€`%=`ã€`&=`ã€`|=`ã€`^=`ã€`<<=`ã€`>>=`
- `/` æ€»æ˜¯è¿”å›æµ®ç‚¹æ•°ï¼ˆä½¿ç”¨ `divi()` è¿›è¡Œæ•´æ•°é™¤æ³•ï¼‰
- ç±»å‹è¯­æ³•ï¼š`let x: type = value;`

---

## å¿«é€Ÿå‚è€ƒ

### ç±»å‹
```
æœ‰ç¬¦å·ï¼š  i8, i16, i32, i64
æ— ç¬¦å·ï¼š  u8, u16, u32, u64
æµ®ç‚¹ï¼š    f32, f64
å…¶ä»–ï¼š    bool, string, rune, array, ptr, buffer, null, object, file, task, channel
åˆ«åï¼š    integer (i32), number (f64), byte (u8)
```

**ç±»å‹æå‡ï¼š** i8 â†’ i16 â†’ i32 â†’ i64 â†’ f32 â†’ f64ï¼ˆæµ®ç‚¹æ€»æ˜¯èµ¢ï¼Œä½† i64/u64 + f32 â†’ f64 ä»¥ä¿æŒç²¾åº¦ï¼‰

### å­—é¢é‡
```hemlock
let x = 42;              // i32
let big = 5000000000;    // i64 (> i32 æœ€å¤§å€¼)
let hex = 0xDEADBEEF;    // åå…­è¿›åˆ¶å­—é¢é‡
let bin = 0b1010;        // äºŒè¿›åˆ¶å­—é¢é‡
let oct = 0o777;         // å…«è¿›åˆ¶å­—é¢é‡
let sep = 1_000_000;     // å…è®¸æ•°å­—åˆ†éš”ç¬¦
let pi = 3.14;           // f64
let half = .5;           // f64 (æ— å‰å¯¼é›¶)
let s = "hello";         // string
let esc = "\x41\u{1F600}"; // åå…­è¿›åˆ¶å’Œ Unicode è½¬ä¹‰
let ch = 'A';            // rune
let emoji = 'ğŸš€';        // rune (Unicode)
let arr = [1, 2, 3];     // array
let obj = { x: 10 };     // object
```

### ç±»å‹è½¬æ¢
```hemlock
// ç±»å‹æ„é€ å‡½æ•° - å°†å­—ç¬¦ä¸²è§£æä¸ºç±»å‹
let n = i32("42");       // å°†å­—ç¬¦ä¸²è§£æä¸º i32
let f = f64("3.14");     // å°†å­—ç¬¦ä¸²è§£æä¸º f64
let b = bool("true");    // å°†å­—ç¬¦ä¸²è§£æä¸º bool ("true" æˆ– "false")

// æ”¯æŒæ‰€æœ‰æ•°å€¼ç±»å‹
let a = i8("-128");      // i8, i16, i32, i64
let c = u8("255");       // u8, u16, u32, u64
let d = f32("1.5");      // f32, f64

// åå…­è¿›åˆ¶å’Œè´Ÿæ•°
let hex = i32("0xFF");   // 255
let neg = i32("-42");    // -42

// ç±»å‹åˆ«åä¹Ÿé€‚ç”¨
let x = integer("100");  // ç­‰åŒäº i32("100")
let y = number("1.5");   // ç­‰åŒäº f64("1.5")
let z = byte("200");     // ç­‰åŒäº u8("200")

// æ•°å€¼ç±»å‹ä¹‹é—´çš„è½¬æ¢
let big = i64(42);       // i32 è½¬ i64
let truncated = i32(3.99); // f64 è½¬ i32 (æˆªæ–­ä¸º 3)

// ç±»å‹æ³¨è§£éªŒè¯ç±»å‹ï¼ˆä½†ä¸è§£æå­—ç¬¦ä¸²ï¼‰
let f: f64 = 100;        // é€šè¿‡æ³¨è§£å°† i32 è½¬ä¸º f64ï¼ˆæ•°å€¼å¼ºåˆ¶è½¬æ¢å¯è¡Œï¼‰
// let n: i32 = "42";    // é”™è¯¯ - ä½¿ç”¨ i32("42") è§£æå­—ç¬¦ä¸²
```

### å†…çœ
```hemlock
typeof(42);              // "i32"
typeof("hello");         // "string"
typeof([1, 2, 3]);       // "array"
typeof(null);            // "null"
len("hello");            // 5 (å­—ç¬¦ä¸²å­—èŠ‚é•¿åº¦)
len([1, 2, 3]);          // 3 (æ•°ç»„é•¿åº¦)
```

### å†…å­˜
```hemlock
let p = alloc(64);       // åŸå§‹æŒ‡é’ˆ
let b = buffer(64);      // å®‰å…¨ç¼“å†²åŒºï¼ˆè¾¹ç•Œæ£€æŸ¥ï¼‰
memset(p, 0, 64);
memcpy(dest, src, 64);
free(p);                 // éœ€è¦æ‰‹åŠ¨æ¸…ç†
```

### æ§åˆ¶æµ
```hemlock
if (x > 0) { } else if (x < 0) { } else { }
while (cond) { break; continue; }
for (let i = 0; i < 10; i++) { }
for (item in array) { }
loop { if (done) { break; } }   // æ— é™å¾ªç¯ï¼ˆæ¯” while(true) æ›´æ¸…æ™°ï¼‰
switch (x) { case 1: break; default: break; }  // C é£æ ¼è´¯ç©¿
defer cleanup();         // å‡½æ•°è¿”å›æ—¶æ‰§è¡Œ

// å¾ªç¯æ ‡ç­¾ç”¨äºåµŒå¥—å¾ªç¯ä¸­çš„å®šå‘ break/continue
outer: while (cond) {
    inner: for (let i = 0; i < 10; i++) {
        if (i == 5) { break outer; }     // è·³å‡ºå¤–å±‚å¾ªç¯
        if (i == 3) { continue outer; }  // ç»§ç»­å¤–å±‚å¾ªç¯
    }
}
```

### æ¨¡å¼åŒ¹é…
```hemlock
// match è¡¨è¾¾å¼ - è¿”å›å€¼
let result = match (value) {
    0 => "zero",                    // å­—é¢é‡æ¨¡å¼
    1 | 2 | 3 => "small",           // OR æ¨¡å¼
    n if n < 10 => "medium",        // å®ˆå«è¡¨è¾¾å¼
    n => "large: " + n              // å˜é‡ç»‘å®š
};

// ç±»å‹æ¨¡å¼
match (val) {
    n: i32 => "integer",
    s: string => "string",
    _ => "other"                    // é€šé…ç¬¦
}

// å¯¹è±¡è§£æ„
match (point) {
    { x: 0, y: 0 } => "origin",
    { x, y } => "at " + x + "," + y
}

// å¸¦å‰©ä½™éƒ¨åˆ†çš„æ•°ç»„è§£æ„
match (arr) {
    [] => "empty",
    [first, ...rest] => "head: " + first,
    _ => "other"
}

// åµŒå¥—æ¨¡å¼
match (user) {
    { name, address: { city } } => name + " in " + city
}
```

å®Œæ•´æ–‡æ¡£è¯·å‚é˜… `docs/language-guide/pattern-matching.md`ã€‚

### ç©ºå€¼åˆå¹¶è¿ç®—ç¬¦
```hemlock
// ç©ºå€¼åˆå¹¶ (??) - å¦‚æœå·¦ä¾§éç©ºåˆ™è¿”å›å·¦ä¾§ï¼Œå¦åˆ™è¿”å›å³ä¾§
let name = user.name ?? "Anonymous";
let first = a ?? b ?? c ?? "fallback";

// ç©ºå€¼åˆå¹¶èµ‹å€¼ (??=) - ä»…å½“ä¸ºç©ºæ—¶èµ‹å€¼
let config = null;
config ??= { timeout: 30 };    // config ç°åœ¨æ˜¯ { timeout: 30 }
config ??= { timeout: 60 };    // config ä¸å˜ï¼ˆéç©ºï¼‰

// é€‚ç”¨äºå±æ€§å’Œç´¢å¼•
obj.field ??= "default";
arr[0] ??= "first";

// å®‰å…¨å¯¼èˆª (?.) - å¦‚æœå¯¹è±¡ä¸ºç©ºåˆ™è¿”å› null
let city = user?.address?.city;  // å¦‚æœä»»ä½•éƒ¨åˆ†ä¸ºç©ºåˆ™ä¸º null
let upper = name?.to_upper();    // å®‰å…¨æ–¹æ³•è°ƒç”¨
let item = arr?.[0];             // å®‰å…¨ç´¢å¼•
```

### å‡½æ•°
```hemlock
fn add(a: i32, b: i32): i32 { return a + b; }
fn greet(name: string, msg?: "Hello") { print(msg + " " + name); }
let f = fn(x) { return x * 2; };  // åŒ¿å/é—­åŒ…

// è¡¨è¾¾å¼ä½“å‡½æ•°ï¼ˆç®­å¤´è¯­æ³•ï¼‰
fn double(x: i32): i32 => x * 2;
fn max(a: i32, b: i32): i32 => a > b ? a : b;
let square = fn(x: i32): i32 => x * x;  // åŒ¿åè¡¨è¾¾å¼ä½“

// å‚æ•°ä¿®é¥°ç¬¦
fn swap(ref a: i32, ref b: i32) { let t = a; a = b; b = t; }  // æŒ‰å¼•ç”¨ä¼ é€’
fn print_all(const items: array) { for (i in items) { print(i); } }  // ä¸å¯å˜
```

### å‘½åå‚æ•°
```hemlock
// å‡½æ•°å¯ä»¥ä½¿ç”¨å‘½åå‚æ•°è°ƒç”¨
fn create_user(name: string, age?: 18, active?: true) {
    print(name + " is " + age + " years old");
}

// ä½ç½®å‚æ•°ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰
create_user("Alice", 25, false);

// å‘½åå‚æ•° - å¯ä»¥ä»»æ„é¡ºåº
create_user(name: "Bob", age: 30);
create_user(age: 25, name: "Charlie", active: false);

// é€šè¿‡å‘½åæ‰€éœ€å‚æ•°æ¥è·³è¿‡å¯é€‰å‚æ•°
create_user("David", active: false);  // ä½¿ç”¨é»˜è®¤ age=18

// å‘½åå‚æ•°å¿…é¡»åœ¨ä½ç½®å‚æ•°ä¹‹å
create_user("Eve", age: 21);          // æ­£ç¡®ï¼šä½ç½®å‚æ•°åœ¨å‰ï¼Œå‘½åå‚æ•°åœ¨å
// create_user(name: "Bad", 25);      // é”™è¯¯ï¼šä½ç½®å‚æ•°åœ¨å‘½åå‚æ•°ä¹‹å
```

**è§„åˆ™ï¼š**
- å‘½åå‚æ•°ä½¿ç”¨ `name: value` è¯­æ³•
- å¯ä»¥åœ¨ä½ç½®å‚æ•°ä¹‹åä»¥ä»»æ„é¡ºåºå‡ºç°
- ä½ç½®å‚æ•°ä¸èƒ½è·Ÿåœ¨å‘½åå‚æ•°ä¹‹å
- ä¸é»˜è®¤/å¯é€‰å‚æ•°é…åˆä½¿ç”¨
- æœªçŸ¥å‚æ•°åä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯

### å¯¹è±¡å’Œæšä¸¾
```hemlock
define Person { name: string, age: i32, active?: true }
let p: Person = { name: "Alice", age: 30 };
let json = p.serialize();
let restored = json.deserialize();

// å¯¹è±¡ç®€å†™è¯­æ³•ï¼ˆES6 é£æ ¼ï¼‰
let name = "Alice";
let age = 30;
let person = { name, age };         // ç­‰åŒäº { name: name, age: age }

// å¯¹è±¡å±•å¼€è¿ç®—ç¬¦
let defaults = { theme: "dark", size: "medium" };
let config = { ...defaults, size: "large" };  // å¤åˆ¶ defaultsï¼Œè¦†ç›– size

enum Color { RED, GREEN, BLUE }
enum Status { OK = 0, ERROR = 1 }
```

### å¤åˆç±»å‹ï¼ˆäº¤å‰/é¸­å­ç±»å‹ï¼‰
```hemlock
// å®šä¹‰ç»“æ„ç±»å‹
define HasName { name: string }
define HasAge { age: i32 }
define HasEmail { email: string }

// å¤åˆç±»å‹ï¼šå¯¹è±¡å¿…é¡»æ»¡è¶³æ‰€æœ‰ç±»å‹
let person: HasName & HasAge = { name: "Alice", age: 30 };

// å¸¦å¤åˆç±»å‹çš„å‡½æ•°å‚æ•°
fn greet(p: HasName & HasAge) {
    print(p.name + " is " + p.age);
}

// ä¸‰ä¸ªæˆ–æ›´å¤šç±»å‹
fn describe(p: HasName & HasAge & HasEmail) {
    print(p.name + " <" + p.email + ">");
}

// å…è®¸é¢å¤–å­—æ®µï¼ˆé¸­å­ç±»å‹ï¼‰
let employee: HasName & HasAge = {
    name: "Bob",
    age: 25,
    department: "Engineering"  // æ­£ç¡® - é¢å¤–å­—æ®µè¢«å¿½ç•¥
};
```

å¤åˆç±»å‹æä¾›ç±»ä¼¼æ¥å£çš„è¡Œä¸ºï¼Œæ— éœ€å•ç‹¬çš„ `interface` å…³é”®å­—ï¼Œ
æ„å»ºåœ¨ç°æœ‰çš„ `define` å’Œé¸­å­ç±»å‹èŒƒå¼ä¹‹ä¸Šã€‚

### ç±»å‹åˆ«å
```hemlock
// ç®€å•ç±»å‹åˆ«å
type Integer = i32;
type Text = string;

// å‡½æ•°ç±»å‹åˆ«å
type Callback = fn(i32): void;
type Predicate = fn(i32): bool;
type AsyncHandler = async fn(string): i32;

// å¤åˆç±»å‹åˆ«åï¼ˆé€‚åˆå¯é‡ç”¨æ¥å£ï¼‰
define HasName { name: string }
define HasAge { age: i32 }
type Person = HasName & HasAge;

// æ³›å‹ç±»å‹åˆ«å
type Pair<T> = { first: T, second: T };

// ä½¿ç”¨ç±»å‹åˆ«å
let x: Integer = 42;
let cb: Callback = fn(n) { print(n); };
let p: Person = { name: "Alice", age: 30 };
```

ç±»å‹åˆ«åä¸ºå¤æ‚ç±»å‹åˆ›å»ºå‘½åå¿«æ·æ–¹å¼ï¼Œæé«˜å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### å‡½æ•°ç±»å‹
```hemlock
// å‡½æ•°ç±»å‹æ³¨è§£ç”¨äºå‚æ•°
fn apply_fn(f: fn(i32): i32, x: i32): i32 {
    return f(x);
}

// è¿”å›å‡½æ•°çš„é«˜é˜¶å‡½æ•°
fn make_adder(n: i32): fn(i32): i32 {
    return fn(x) { return x + n; };
}

// å¼‚æ­¥å‡½æ•°ç±»å‹
fn run_async(handler: async fn(): void) {
    spawn(handler);
}

// å¤šå‚æ•°å‡½æ•°ç±»å‹
type BinaryOp = fn(i32, i32): i32;
let add: BinaryOp = fn(a, b) { return a + b; };
```

### Const å‚æ•°
```hemlock
// Const å‚æ•° - æ·±åº¦ä¸å¯å˜æ€§
fn print_all(const items: array) {
    // items.push(4);  // é”™è¯¯ï¼šæ— æ³•ä¿®æ”¹ const å‚æ•°
    for (item in items) {
        print(item);
    }
}

// å¯¹è±¡çš„ const - æ— æ³•é€šè¿‡ä»»ä½•è·¯å¾„ä¿®æ”¹
fn describe(const person: object) {
    print(person.name);       // æ­£ç¡®ï¼šå…è®¸è¯»å–
    // person.name = "Bob";   // é”™è¯¯ï¼šæ— æ³•ä¿®æ”¹
}

// å…è®¸åµŒå¥—è¯»å–è®¿é—®
fn get_city(const user: object) {
    return user.address.city;  // æ­£ç¡®ï¼šè¯»å–åµŒå¥—å±æ€§
}
```

`const` ä¿®é¥°ç¬¦é˜²æ­¢å¯¹å‚æ•°çš„ä»»ä½•ä¿®æ”¹ï¼ŒåŒ…æ‹¬åµŒå¥—å±æ€§ã€‚
è¿™ä¸ºä¸åº”ä¿®æ”¹å…¶è¾“å…¥çš„å‡½æ•°æä¾›äº†ç¼–è¯‘æ—¶å®‰å…¨æ€§ã€‚

### Ref å‚æ•°ï¼ˆæŒ‰å¼•ç”¨ä¼ é€’ï¼‰
```hemlock
// Ref å‚æ•° - ç›´æ¥ä¿®æ”¹è°ƒç”¨è€…çš„å˜é‡
fn increment(ref x: i32) {
    x = x + 1;  // ä¿®æ”¹åŸå§‹å˜é‡
}

let count = 10;
increment(count);
print(count);  // 11 - åŸå§‹å€¼å·²ä¿®æ”¹

// ç»å…¸äº¤æ¢å‡½æ•°
fn swap(ref a: i32, ref b: i32) {
    let temp = a;
    a = b;
    b = temp;
}

let x = 1;
let y = 2;
swap(x, y);
print(x, y);  // 2 1

// æ··åˆ ref å’Œæ™®é€šå‚æ•°
fn add_to(ref target: i32, amount: i32) {
    target = target + amount;
}

let total = 100;
add_to(total, 50);
print(total);  // 150
```

`ref` ä¿®é¥°ç¬¦ä¼ é€’å¯¹è°ƒç”¨è€…å˜é‡çš„å¼•ç”¨ï¼Œå…è®¸å‡½æ•°ç›´æ¥ä¿®æ”¹å®ƒã€‚
æ²¡æœ‰ `ref` æ—¶ï¼ŒåŸå§‹ç±»å‹æŒ‰å€¼ä¼ é€’ï¼ˆå¤åˆ¶ï¼‰ã€‚å½“éœ€è¦åœ¨ä¸è¿”å›å€¼çš„æƒ…å†µä¸‹
ä¿®æ”¹è°ƒç”¨è€…çŠ¶æ€æ—¶ï¼Œä½¿ç”¨ `ref`ã€‚

**è§„åˆ™ï¼š**
- `ref` å‚æ•°å¿…é¡»ä¼ é€’å˜é‡ï¼Œä¸èƒ½æ˜¯å­—é¢é‡æˆ–è¡¨è¾¾å¼
- é€‚ç”¨äºæ‰€æœ‰ç±»å‹ï¼ˆåŸå§‹ç±»å‹ã€æ•°ç»„ã€å¯¹è±¡ï¼‰
- ä¸ç±»å‹æ³¨è§£ç»“åˆï¼š`ref x: i32`
- ä¸èƒ½ä¸ `const` ç»“åˆï¼ˆå®ƒä»¬æ˜¯å¯¹ç«‹çš„ï¼‰

### Define ä¸­çš„æ–¹æ³•ç­¾å
```hemlock
// å¸¦æ–¹æ³•ç­¾åçš„ defineï¼ˆæ¥å£æ¨¡å¼ï¼‰
define Comparable {
    value: i32,
    fn compare(other: Self): i32   // å¿…éœ€çš„æ–¹æ³•ç­¾å
}

// å¯¹è±¡å¿…é¡»æä¾›å¿…éœ€çš„æ–¹æ³•
let a: Comparable = {
    value: 10,
    compare: fn(other) { return self.value - other.value; }
};

// ä½¿ç”¨ ? è¡¨ç¤ºå¯é€‰æ–¹æ³•
define Serializable {
    fn serialize(): string,        // å¿…éœ€
    fn pretty?(): string           // å¯é€‰æ–¹æ³•
}

// Self ç±»å‹æŒ‡å‘å®šä¹‰ç±»å‹
define Cloneable {
    fn clone(): Self   // è¿”å›ä¸å¯¹è±¡ç›¸åŒçš„ç±»å‹
}
```

`define` å—ä¸­çš„æ–¹æ³•ç­¾åä½¿ç”¨é€—å·åˆ†éš”ï¼ˆç±»ä¼¼ TypeScript æ¥å£ï¼‰ï¼Œ
å»ºç«‹å¯¹è±¡å¿…é¡»æ»¡è¶³çš„å¥‘çº¦ï¼Œå¹¶é€šè¿‡ Hemlock çš„é¸­å­ç±»å‹ç³»ç»Ÿå®ç°
ç±»ä¼¼æ¥å£çš„ç¼–ç¨‹æ¨¡å¼ã€‚

### é”™è¯¯å¤„ç†
```hemlock
try { throw "error"; } catch (e) { print(e); } finally { cleanup(); }
panic("unrecoverable");  // ç«‹å³é€€å‡ºï¼Œä¸å¯æ•è·
```

### å¼‚æ­¥/å¹¶å‘
```hemlock
async fn compute(n: i32): i32 { return n * n; }
let task = spawn(compute, 42);
let result = await task;     // æˆ– join(task)
detach(spawn(background_work));

let ch = channel(10);
ch.send(value);
let val = ch.recv();
ch.close();
```

**å†…å­˜æ‰€æœ‰æƒï¼š** ä»»åŠ¡æ¥æ”¶åŸå§‹å€¼çš„å‰¯æœ¬ï¼Œä½†å…±äº«æŒ‡é’ˆã€‚å¦‚æœå°† `ptr` ä¼ é€’ç»™æ´¾ç”Ÿä»»åŠ¡ï¼Œ
å¿…é¡»ç¡®ä¿å†…å­˜åœ¨ä»»åŠ¡å®Œæˆå‰ä¿æŒæœ‰æ•ˆã€‚åœ¨ `free()` ä¹‹å‰ä½¿ç”¨ `join()`ï¼Œ
æˆ–ä½¿ç”¨ channel ä¿¡å·é€šçŸ¥å®Œæˆã€‚

### ç”¨æˆ·è¾“å…¥
```hemlock
let name = read_line();          // ä» stdin è¯»å–è¡Œï¼ˆé˜»å¡ï¼‰
print("Hello, " + name);
eprint("Error message");         // è¾“å‡ºåˆ° stderr

// read_line() åœ¨ EOF æ—¶è¿”å› null
while (true) {
    let line = read_line();
    if (line == null) { break; }
    print("Got:", line);
}
```

### æ–‡ä»¶ I/O
```hemlock
let f = open("file.txt", "r");  // æ¨¡å¼ï¼šr, w, a, r+, w+, a+
let content = f.read();
f.write("data");
f.seek(0);
f.close();
```

### ä¿¡å·
```hemlock
signal(SIGINT, fn(sig) { print("Interrupted"); });
raise(SIGUSR1);
```

---

## å­—ç¬¦ä¸²æ–¹æ³• (19 ä¸ª)

`substr`ã€`slice`ã€`find`ã€`contains`ã€`split`ã€`trim`ã€`to_upper`ã€`to_lower`ã€
`starts_with`ã€`ends_with`ã€`replace`ã€`replace_all`ã€`repeat`ã€`char_at`ã€
`byte_at`ã€`chars`ã€`bytes`ã€`to_bytes`ã€`deserialize`

æ¨¡æ¿å­—ç¬¦ä¸²ï¼š`` `Hello ${name}!` ``

**å­—ç¬¦ä¸²å¯å˜æ€§ï¼š** å­—ç¬¦ä¸²å¯é€šè¿‡ç´¢å¼•èµ‹å€¼ä¿®æ”¹ï¼ˆ`s[0] = 'H'`ï¼‰ï¼Œä½†æ‰€æœ‰å­—ç¬¦ä¸²æ–¹æ³•
è¿”å›æ–°å­—ç¬¦ä¸²è€Œä¸ä¿®æ”¹åŸå­—ç¬¦ä¸²ã€‚è¿™å…è®¸åœ¨éœ€è¦æ—¶è¿›è¡ŒåŸåœ°ä¿®æ”¹ï¼ŒåŒæ—¶ä¿æŒæ–¹æ³•é“¾çš„å‡½æ•°å¼é£æ ¼ã€‚

**å­—ç¬¦ä¸²é•¿åº¦å±æ€§ï¼š**
```hemlock
let s = "hello ğŸš€";
print(s.length);       // 7 (å­—ç¬¦/rune è®¡æ•°)
print(s.byte_length);  // 10 (å­—èŠ‚è®¡æ•° - emoji æ˜¯ 4 å­—èŠ‚ UTF-8)
```

## æ•°ç»„æ–¹æ³• (18 ä¸ª)

`push`ã€`pop`ã€`shift`ã€`unshift`ã€`insert`ã€`remove`ã€`find`ã€`contains`ã€
`slice`ã€`join`ã€`concat`ã€`reverse`ã€`first`ã€`last`ã€`clear`ã€`map`ã€`filter`ã€`reduce`

ç±»å‹åŒ–æ•°ç»„ï¼š`let nums: array<i32> = [1, 2, 3];`

---

## æ ‡å‡†åº“ (40 ä¸ªæ¨¡å—)

ä½¿ç”¨ `@stdlib/` å‰ç¼€å¯¼å…¥ï¼š
```hemlock
import { sin, cos, PI } from "@stdlib/math";
import { HashMap, Queue, Set } from "@stdlib/collections";
import { read_file, write_file } from "@stdlib/fs";
import { TcpStream, UdpSocket } from "@stdlib/net";
```

| æ¨¡å— | æè¿° |
|--------|-------------|
| `arena` | ç«æŠ€åœºå†…å­˜åˆ†é…å™¨ï¼ˆbump åˆ†é…ï¼‰ |
| `args` | å‘½ä»¤è¡Œå‚æ•°è§£æ |
| `assert` | æ–­è¨€å·¥å…· |
| `async` | ThreadPoolã€parallel_map |
| `async_fs` | å¼‚æ­¥æ–‡ä»¶ I/O æ“ä½œ |
| `collections` | HashMapã€Queueã€Stackã€Setã€LinkedListã€LRUCache |
| `compression` | gzipã€gunzipã€deflate |
| `crypto` | aes_encryptã€rsa_signã€random_bytes |
| `csv` | CSV è§£æå’Œç”Ÿæˆ |
| `datetime` | DateTime ç±»ã€æ ¼å¼åŒ–ã€è§£æ |
| `encoding` | base64_encodeã€hex_encodeã€url_encode |
| `env` | getenvã€setenvã€exitã€get_pid |
| `fmt` | å­—ç¬¦ä¸²æ ¼å¼åŒ–å·¥å…· |
| `fs` | read_fileã€write_fileã€list_dirã€exists |
| `glob` | æ–‡ä»¶æ¨¡å¼åŒ¹é… |
| `hash` | sha256ã€sha512ã€md5ã€djb2 |
| `http` | http_getã€http_postã€http_request |
| `ipc` | è¿›ç¨‹é—´é€šä¿¡ |
| `iter` | è¿­ä»£å™¨å·¥å…· |
| `json` | parseã€stringifyã€prettyã€getã€set |
| `logging` | å¸¦çº§åˆ«çš„æ—¥å¿—è®°å½•å™¨ |
| `math` | sinã€cosã€sqrtã€powã€randã€PIã€E |
| `net` | TcpListenerã€TcpStreamã€UdpSocket |
| `os` | platformã€archã€cpu_countã€hostname |
| `path` | æ–‡ä»¶è·¯å¾„æ“ä½œ |
| `process` | forkã€execã€waitã€kill |
| `random` | éšæœºæ•°ç”Ÿæˆ |
| `regex` | compileã€test (POSIX ERE) |
| `retry` | å¸¦é€€é¿çš„é‡è¯•é€»è¾‘ |
| `semver` | è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶ |
| `shell` | Shell å‘½ä»¤å·¥å…· |
| `sqlite` | SQLite æ•°æ®åº“ã€queryã€execã€äº‹åŠ¡ |
| `strings` | pad_leftã€is_alphaã€reverseã€lines |
| `terminal` | ANSI é¢œè‰²å’Œæ ·å¼ |
| `testing` | describeã€testã€expect |
| `time` | nowã€time_msã€sleepã€clock |
| `toml` | TOML è§£æå’Œç”Ÿæˆ |
| `url` | URL è§£æå’Œæ“ä½œ |
| `uuid` | UUID ç”Ÿæˆ |
| `websocket` | WebSocket å®¢æˆ·ç«¯ |

è¯¦ç»†æ¨¡å—æ–‡æ¡£è¯·å‚é˜… `stdlib/docs/`ã€‚

---

## FFIï¼ˆå¤–éƒ¨å‡½æ•°æ¥å£ï¼‰

ä»å…±äº«åº“å£°æ˜å’Œè°ƒç”¨ C å‡½æ•°ï¼š
```hemlock
import "libc.so.6";

extern fn strlen(s: string): i32;
extern fn getpid(): i32;

let len = strlen("Hello!");  // 6
let pid = getpid();
```

ä»æ¨¡å—å¯¼å‡º FFI å‡½æ•°ï¼š
```hemlock
// string_utils.hml
import "libc.so.6";

export extern fn strlen(s: string): i32;
export fn string_length(s: string): i32 {
    return strlen(s);
}
```

åŠ¨æ€ FFIï¼ˆè¿è¡Œæ—¶ç»‘å®šï¼‰ï¼š
```hemlock
let lib = ffi_open("libc.so.6");
let puts = ffi_bind(lib, "puts", [FFI_POINTER], FFI_INT);
puts("Hello from C!");
ffi_close(lib);
```

ç±»å‹ï¼š`FFI_INT`ã€`FFI_DOUBLE`ã€`FFI_POINTER`ã€`FFI_STRING`ã€`FFI_VOID` ç­‰ã€‚

---

## åŸå­æ“ä½œ

ä½¿ç”¨åŸå­æ“ä½œè¿›è¡Œæ— é”å¹¶å‘ç¼–ç¨‹ï¼š

```hemlock
// ä¸ºåŸå­ i32 åˆ†é…å†…å­˜
let p = alloc(4);
ptr_write_i32(p, 0);

// åŸå­åŠ è½½/å­˜å‚¨
let val = atomic_load_i32(p);        // åŸå­è¯»å–
atomic_store_i32(p, 42);             // åŸå­å†™å…¥

// è·å–å¹¶ä¿®æ”¹æ“ä½œï¼ˆè¿”å›æ—§å€¼ï¼‰
let old = atomic_add_i32(p, 10);     // åŠ æ³•ï¼Œè¿”å›æ—§å€¼
old = atomic_sub_i32(p, 5);          // å‡æ³•ï¼Œè¿”å›æ—§å€¼
old = atomic_and_i32(p, 0xFF);       // æŒ‰ä½ä¸
old = atomic_or_i32(p, 0x10);        // æŒ‰ä½æˆ–
old = atomic_xor_i32(p, 0x0F);       // æŒ‰ä½å¼‚æˆ–

// æ¯”è¾ƒå¹¶äº¤æ¢ (CAS)
let success = atomic_cas_i32(p, 42, 100);  // å¦‚æœ *p == 42ï¼Œè®¾ç½®ä¸º 100
// å¦‚æœäº¤æ¢æˆåŠŸè¿”å› trueï¼Œå¦åˆ™è¿”å› false

// åŸå­äº¤æ¢
old = atomic_exchange_i32(p, 999);   // äº¤æ¢ï¼Œè¿”å›æ—§å€¼

free(p);

// å¯ç”¨ i64 å˜ä½“ (atomic_load_i64, atomic_add_i64, ç­‰)

// å†…å­˜å±éšœï¼ˆå®Œå…¨å±éšœï¼‰
atomic_fence();
```

æ‰€æœ‰æ“ä½œä½¿ç”¨é¡ºåºä¸€è‡´æ€§ï¼ˆ`memory_order_seq_cst`ï¼‰ã€‚

---

## é¡¹ç›®ç»“æ„

```
hemlock/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ frontend/         # å…±äº«ï¼šè¯æ³•åˆ†æå™¨ã€è§£æå™¨ã€ASTã€æ¨¡å—
â”‚   â”œâ”€â”€ backends/
â”‚   â”‚   â”œâ”€â”€ interpreter/  # hemlockï¼šæ ‘éå†è§£é‡Šå™¨
â”‚   â”‚   â””â”€â”€ compiler/     # hemlockcï¼šC ä»£ç ç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”œâ”€â”€ lsp/          # è¯­è¨€æœåŠ¡å™¨åè®®
â”‚   â”‚   â””â”€â”€ bundler/      # æ‰“åŒ…/åŒ…å·¥å…·
â”œâ”€â”€ runtime/              # ç¼–è¯‘ç¨‹åºè¿è¡Œæ—¶ (libhemlock_runtime.a)
â”œâ”€â”€ stdlib/               # æ ‡å‡†åº“ (40 ä¸ªæ¨¡å—)
â”‚   â””â”€â”€ docs/             # æ¨¡å—æ–‡æ¡£
â”œâ”€â”€ docs/                 # å®Œæ•´æ–‡æ¡£
â”‚   â”œâ”€â”€ language-guide/   # ç±»å‹ã€å­—ç¬¦ä¸²ã€æ•°ç»„ç­‰
â”‚   â”œâ”€â”€ reference/        # API å‚è€ƒ
â”‚   â””â”€â”€ advanced/         # å¼‚æ­¥ã€FFIã€ä¿¡å·ç­‰
â”œâ”€â”€ tests/                # 625+ æµ‹è¯•
â””â”€â”€ examples/             # ç¤ºä¾‹ç¨‹åº
```

---

## ä»£ç é£æ ¼æŒ‡å—

### å¸¸é‡å’Œé­”æ³•æ•°å­—

åœ¨å‘ C ä»£ç åº“æ·»åŠ æ•°å€¼å¸¸é‡æ—¶ï¼Œè¯·éµå¾ªä»¥ä¸‹å‡†åˆ™ï¼š

1. **åœ¨ `include/hemlock_limits.h` ä¸­å®šä¹‰å¸¸é‡** - æ­¤æ–‡ä»¶æ˜¯æ‰€æœ‰ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶é™åˆ¶ã€å®¹é‡å’Œå‘½åå¸¸é‡çš„é›†ä¸­ä½ç½®ã€‚

2. **ä½¿ç”¨ `HML_` å‰ç¼€çš„æè¿°æ€§åç§°** - æ‰€æœ‰å¸¸é‡åº”ä»¥ `HML_` ä¸ºå‰ç¼€ä»¥æ˜ç¡®å‘½åç©ºé—´ã€‚

3. **é¿å…é­”æ³•æ•°å­—** - ç”¨å‘½åå¸¸é‡æ›¿æ¢ç¡¬ç¼–ç çš„æ•°å€¼ã€‚ç¤ºä¾‹ï¼š
   - ç±»å‹èŒƒå›´é™åˆ¶ï¼š`HML_I8_MIN`ã€`HML_I8_MAX`ã€`HML_U32_MAX`
   - ç¼“å†²åŒºå®¹é‡ï¼š`HML_INITIAL_ARRAY_CAPACITY`ã€`HML_INITIAL_LEXER_BUFFER_CAPACITY`
   - æ—¶é—´è½¬æ¢ï¼š`HML_NANOSECONDS_PER_SECOND`ã€`HML_MILLISECONDS_PER_SECOND`
   - å“ˆå¸Œç§å­ï¼š`HML_DJB2_HASH_SEED`
   - ASCII å€¼ï¼š`HML_ASCII_CASE_OFFSET`ã€`HML_ASCII_PRINTABLE_START`

4. **åŒ…å« `hemlock_limits.h`** - æºæ–‡ä»¶åº”åŒ…å«æ­¤å¤´æ–‡ä»¶ï¼ˆé€šå¸¸é€šè¿‡ `internal.h`ï¼‰ä»¥è®¿é—®å¸¸é‡ã€‚

5. **è®°å½•ç”¨é€”** - æ·»åŠ æ³¨é‡Šè¯´æ˜æ¯ä¸ªå¸¸é‡ä»£è¡¨ä»€ä¹ˆã€‚

---

## ç¦æ­¢äº‹é¡¹

- æ·»åŠ éšå¼è¡Œä¸ºï¼ˆASIã€GCã€è‡ªåŠ¨æ¸…ç†ï¼‰
- éšè—å¤æ‚æ€§ï¼ˆé­”æ³•ä¼˜åŒ–ã€éšè—å¼•ç”¨è®¡æ•°ï¼‰
- ç ´åç°æœ‰è¯­ä¹‰ï¼ˆåˆ†å·ã€æ‰‹åŠ¨å†…å­˜ã€å¯å˜å­—ç¬¦ä¸²ï¼‰
- åœ¨éšå¼è½¬æ¢ä¸­ä¸¢å¤±ç²¾åº¦
- ä½¿ç”¨é­”æ³•æ•°å­— - æ”¹ä¸ºåœ¨ `hemlock_limits.h` ä¸­å®šä¹‰å‘½åå¸¸é‡

---

## æµ‹è¯•

```bash
make test              # è¿è¡Œè§£é‡Šå™¨æµ‹è¯•
make test-compiler     # è¿è¡Œç¼–è¯‘å™¨æµ‹è¯•
make parity            # è¿è¡Œå¯¹ç­‰æµ‹è¯•ï¼ˆä¸¤è€…å¿…é¡»åŒ¹é…ï¼‰
make test-all          # è¿è¡Œæ‰€æœ‰æµ‹è¯•å¥—ä»¶
```

**é‡è¦ï¼š** ç”±äºå¼‚æ­¥/å¹¶å‘é—®é¢˜ï¼Œæµ‹è¯•å¯èƒ½ä¼šæŒ‚èµ·ã€‚è¿è¡Œæµ‹è¯•æ—¶å§‹ç»ˆä½¿ç”¨è¶…æ—¶ï¼š
```bash
timeout 60 make test   # 60 ç§’è¶…æ—¶
timeout 120 make parity
```

æµ‹è¯•ç±»åˆ«ï¼šprimitivesã€memoryã€stringsã€arraysã€functionsã€objectsã€asyncã€ffiã€deferã€signalsã€switchã€bitwiseã€typed_arraysã€modulesã€stdlib_*

---

## ç¼–è¯‘å™¨/è§£é‡Šå™¨æ¶æ„

Hemlock æœ‰ä¸¤ä¸ªå…±äº«é€šç”¨å‰ç«¯çš„æ‰§è¡Œåç«¯ï¼š

```
æºç  (.hml)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…±äº«å‰ç«¯                    â”‚
â”‚  - è¯æ³•åˆ†æå™¨ (src/frontend/)â”‚
â”‚  - è§£æå™¨ (src/frontend/)    â”‚
â”‚  - AST (src/frontend/)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è§£é‡Šå™¨    â”‚    â”‚   ç¼–è¯‘å™¨    â”‚
â”‚ (hemlock)  â”‚    â”‚ (hemlockc) â”‚
â”‚            â”‚    â”‚            â”‚
â”‚ æ ‘éå†     â”‚    â”‚ ç±»å‹æ£€æŸ¥   â”‚
â”‚ æ±‚å€¼       â”‚    â”‚ AST â†’ C    â”‚
â”‚            â”‚    â”‚ gcc é“¾æ¥   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼–è¯‘å™¨ç±»å‹æ£€æŸ¥

ç¼–è¯‘å™¨ï¼ˆ`hemlockc`ï¼‰åŒ…å«ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œ**é»˜è®¤å¯ç”¨**ï¼š

```bash
hemlockc program.hml -o program    # ç±»å‹æ£€æŸ¥ï¼Œç„¶åç¼–è¯‘
hemlockc --check program.hml       # ä»…ç±»å‹æ£€æŸ¥ï¼Œä¸ç¼–è¯‘
hemlockc --no-type-check prog.hml  # ç¦ç”¨ç±»å‹æ£€æŸ¥
hemlockc --strict-types prog.hml   # å¯¹éšå¼ 'any' ç±»å‹å‘å‡ºè­¦å‘Š
```

ç±»å‹æ£€æŸ¥å™¨ï¼š
- åœ¨ç¼–è¯‘æ—¶éªŒè¯ç±»å‹æ³¨è§£
- å°†æ— ç±»å‹ä»£ç è§†ä¸ºåŠ¨æ€ï¼ˆ`any` ç±»å‹ï¼‰- å§‹ç»ˆæœ‰æ•ˆ
- ä¸ºæ‹†ç®±æä¾›ä¼˜åŒ–æç¤º
- ä½¿ç”¨å®½æ¾çš„æ•°å€¼è½¬æ¢ï¼ˆèŒƒå›´åœ¨è¿è¡Œæ—¶éªŒè¯ï¼‰

### ç›®å½•ç»“æ„

```
hemlock/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ frontend/           # å…±äº«ï¼šè¯æ³•åˆ†æå™¨ã€è§£æå™¨ã€ASTã€æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ lexer.c
â”‚   â”‚   â”œâ”€â”€ parser/
â”‚   â”‚   â”œâ”€â”€ ast.c
â”‚   â”‚   â””â”€â”€ module.c
â”‚   â”œâ”€â”€ backends/
â”‚   â”‚   â”œâ”€â”€ interpreter/    # hemlockï¼šæ ‘éå†è§£é‡Šå™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ main.c
â”‚   â”‚   â”‚   â”œâ”€â”€ runtime/
â”‚   â”‚   â”‚   â””â”€â”€ builtins/
â”‚   â”‚   â””â”€â”€ compiler/       # hemlockcï¼šC ä»£ç ç”Ÿæˆå™¨
â”‚   â”‚       â”œâ”€â”€ main.c
â”‚   â”‚       â””â”€â”€ codegen/
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”œâ”€â”€ lsp/            # è¯­è¨€æœåŠ¡å™¨
â”‚   â”‚   â””â”€â”€ bundler/        # æ‰“åŒ…/åŒ…å·¥å…·
â”œâ”€â”€ runtime/                # ç¼–è¯‘ç¨‹åºçš„ libhemlock_runtime.a
â”œâ”€â”€ stdlib/                 # å…±äº«æ ‡å‡†åº“
â””â”€â”€ tests/
    â”œâ”€â”€ parity/             # å¿…é¡»é€šè¿‡ä¸¤ä¸ªåç«¯çš„æµ‹è¯•
    â”œâ”€â”€ interpreter/        # è§£é‡Šå™¨ç‰¹å®šæµ‹è¯•
    â””â”€â”€ compiler/           # ç¼–è¯‘å™¨ç‰¹å®šæµ‹è¯•
```

---

## å¯¹ç­‰ä¼˜å…ˆå¼€å‘

**è§£é‡Šå™¨å’Œç¼–è¯‘å™¨å¿…é¡»å¯¹ç›¸åŒè¾“å…¥äº§ç”Ÿç›¸åŒè¾“å‡ºã€‚**

### å¼€å‘ç­–ç•¥

æ·»åŠ æˆ–ä¿®æ”¹è¯­è¨€ç‰¹æ€§æ—¶ï¼š

1. **è®¾è®¡** - åœ¨å…±äº«å‰ç«¯å®šä¹‰ AST/è¯­ä¹‰æ›´æ”¹
2. **å®ç°è§£é‡Šå™¨** - æ·»åŠ æ ‘éå†æ±‚å€¼
3. **å®ç°ç¼–è¯‘å™¨** - æ·»åŠ  C ä»£ç ç”Ÿæˆ
4. **æ·»åŠ å¯¹ç­‰æµ‹è¯•** - åœ¨ `tests/parity/` ä¸­ç¼–å†™å¸¦ `.expected` æ–‡ä»¶çš„æµ‹è¯•
5. **éªŒè¯** - åˆå¹¶å‰è¿è¡Œ `make parity`

### å¯¹ç­‰æµ‹è¯•ç»“æ„

```
tests/parity/
â”œâ”€â”€ language/       # æ ¸å¿ƒè¯­è¨€ç‰¹æ€§ï¼ˆæ§åˆ¶æµã€é—­åŒ…ç­‰ï¼‰
â”œâ”€â”€ builtins/       # å†…ç½®å‡½æ•°ï¼ˆprintã€typeofã€memory ç­‰ï¼‰
â”œâ”€â”€ methods/        # å­—ç¬¦ä¸²å’Œæ•°ç»„æ–¹æ³•
â””â”€â”€ modules/        # import/exportã€stdlib å¯¼å…¥
```

æ¯ä¸ªæµ‹è¯•æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼š
- `feature.hml` - æµ‹è¯•ç¨‹åº
- `feature.expected` - é¢„æœŸè¾“å‡ºï¼ˆä¸¤ä¸ªåç«¯å¿…é¡»åŒ¹é…ï¼‰

### å¯¹ç­‰æµ‹è¯•ç»“æœ

| çŠ¶æ€ | å«ä¹‰ |
|--------|---------|
| `PASSED` | è§£é‡Šå™¨å’Œç¼–è¯‘å™¨éƒ½åŒ¹é…é¢„æœŸè¾“å‡º |
| `INTERP_ONLY` | è§£é‡Šå™¨å·¥ä½œï¼Œç¼–è¯‘å™¨å¤±è´¥ï¼ˆéœ€è¦ä¿®å¤ç¼–è¯‘å™¨ï¼‰ |
| `COMPILER_ONLY` | ç¼–è¯‘å™¨å·¥ä½œï¼Œè§£é‡Šå™¨å¤±è´¥ï¼ˆç½•è§ï¼‰ |
| `FAILED` | ä¸¤è€…éƒ½å¤±è´¥ï¼ˆæµ‹è¯•æˆ–å®ç°é”™è¯¯ï¼‰ |

### éœ€è¦å¯¹ç­‰çš„å†…å®¹

- æ‰€æœ‰è¯­è¨€ç»“æ„ï¼ˆifã€whileã€forã€switchã€deferã€try/catchï¼‰
- æ‰€æœ‰è¿ç®—ç¬¦ï¼ˆç®—æœ¯ã€ä½ã€é€»è¾‘ã€æ¯”è¾ƒï¼‰
- æ‰€æœ‰å†…ç½®å‡½æ•°ï¼ˆprintã€typeofã€alloc ç­‰ï¼‰
- æ‰€æœ‰å­—ç¬¦ä¸²å’Œæ•°ç»„æ–¹æ³•
- ç±»å‹å¼ºåˆ¶å’Œæå‡è§„åˆ™
- è¿è¡Œæ—¶é”™è¯¯çš„é”™è¯¯æ¶ˆæ¯

### å¯èƒ½ä¸åŒçš„å†…å®¹

- æ€§èƒ½ç‰¹å¾
- å†…å­˜å¸ƒå±€ç»†èŠ‚
- è°ƒè¯•/å †æ ˆè·Ÿè¸ªæ ¼å¼
- ç¼–è¯‘é”™è¯¯ï¼ˆç¼–è¯‘å™¨å¯èƒ½åœ¨ç¼–è¯‘æ—¶æ•è·æ›´å¤šï¼‰

### æ·»åŠ å¯¹ç­‰æµ‹è¯•

```bash
# 1. åˆ›å»ºæµ‹è¯•æ–‡ä»¶
cat > tests/parity/language/my_feature.hml << 'EOF'
// æµ‹è¯•æè¿°
let x = some_feature();
print(x);
EOF

# 2. ä»è§£é‡Šå™¨ç”Ÿæˆé¢„æœŸè¾“å‡º
./hemlock tests/parity/language/my_feature.hml > tests/parity/language/my_feature.expected

# 3. éªŒè¯å¯¹ç­‰
make parity
```

---

## ç‰ˆæœ¬

**v1.8.0** - å½“å‰ç‰ˆæœ¬ç‰¹æ€§ï¼š
- **æ¨¡å¼åŒ¹é…**ï¼ˆ`match` è¡¨è¾¾å¼ï¼‰- å¼ºå¤§çš„è§£æ„å’Œæ§åˆ¶æµï¼š
  - å­—é¢é‡ã€é€šé…ç¬¦å’Œå˜é‡ç»‘å®šæ¨¡å¼
  - OR æ¨¡å¼ï¼ˆ`1 | 2 | 3`ï¼‰
  - å®ˆå«è¡¨è¾¾å¼ï¼ˆ`n if n > 0`ï¼‰
  - å¯¹è±¡è§£æ„ï¼ˆ`{ x, y }`ï¼‰
  - å¸¦å‰©ä½™éƒ¨åˆ†çš„æ•°ç»„è§£æ„ï¼ˆ`[first, ...rest]`ï¼‰
  - ç±»å‹æ¨¡å¼ï¼ˆ`n: i32`ï¼‰
  - è§£é‡Šå™¨å’Œç¼–è¯‘å™¨å®Œå…¨å¯¹ç­‰
- **ç¼–è¯‘å™¨è¾…åŠ©æ³¨è§£** - 11 ä¸ªç”¨äº GCC/Clang æ§åˆ¶çš„ä¼˜åŒ–æ³¨è§£ï¼š
  - `@inline`ã€`@noinline` - å‡½æ•°å†…è”æ§åˆ¶
  - `@hot`ã€`@cold` - åˆ†æ”¯é¢„æµ‹æç¤º
  - `@pure`ã€`@const` - å‰¯ä½œç”¨æ³¨è§£
  - `@flatten` - å†…è”å‡½æ•°å†…çš„æ‰€æœ‰è°ƒç”¨
  - `@optimize(level)` - æ¯å‡½æ•°ä¼˜åŒ–çº§åˆ«ï¼ˆ"0"ã€"1"ã€"2"ã€"3"ã€"s"ã€"fast"ï¼‰
  - `@warn_unused` - å¿½ç•¥è¿”å›å€¼æ—¶è­¦å‘Š
  - `@section(name)` - è‡ªå®šä¹‰ ELF èŠ‚æ”¾ç½®ï¼ˆä¾‹å¦‚ `@section(".text.hot")`ï¼‰
- **è¡¨è¾¾å¼ä½“å‡½æ•°**ï¼ˆ`fn double(x): i32 => x * 2;`ï¼‰- ç®€æ´çš„å•è¡¨è¾¾å¼å‡½æ•°è¯­æ³•
- **å•è¡Œè¯­å¥** - æ— èŠ±æ‹¬å·çš„ `if`ã€`while`ã€`for` è¯­æ³•ï¼ˆä¾‹å¦‚ `if (x > 0) print(x);`ï¼‰
- **ç±»å‹åˆ«å**ï¼ˆ`type Name = Type;`ï¼‰- å¤æ‚ç±»å‹çš„å‘½åå¿«æ·æ–¹å¼
- **å‡½æ•°ç±»å‹æ³¨è§£**ï¼ˆ`fn(i32): i32`ï¼‰- ä¸€ç­‰å‡½æ•°ç±»å‹
- **Const å‚æ•°**ï¼ˆ`fn(const x: array)`ï¼‰- å‚æ•°çš„æ·±åº¦ä¸å¯å˜æ€§
- **Ref å‚æ•°**ï¼ˆ`fn(ref x: i32)`ï¼‰- æŒ‰å¼•ç”¨ä¼ é€’ç”¨äºç›´æ¥ä¿®æ”¹è°ƒç”¨è€…
- **define ä¸­çš„æ–¹æ³•ç­¾å**ï¼ˆ`fn method(): Type`ï¼‰- ç±»ä¼¼æ¥å£çš„å¥‘çº¦ï¼ˆé€—å·åˆ†éš”ï¼‰
- æ–¹æ³•ç­¾åä¸­çš„ **Self ç±»å‹** - æŒ‡å‘å®šä¹‰ç±»å‹
- **loop å…³é”®å­—**ï¼ˆ`loop { }`ï¼‰- æ›´æ¸…æ™°çš„æ— é™å¾ªç¯ï¼Œæ›¿ä»£ `while (true)`
- **å¾ªç¯æ ‡ç­¾**ï¼ˆ`outer: while`ï¼‰- åµŒå¥—å¾ªç¯çš„å®šå‘ break/continue
- **å¯¹è±¡ç®€å†™**ï¼ˆ`{ name }`ï¼‰- ES6 é£æ ¼ç®€å†™å±æ€§è¯­æ³•
- **å¯¹è±¡å±•å¼€**ï¼ˆ`{ ...obj }`ï¼‰- å¤åˆ¶å’Œåˆå¹¶å¯¹è±¡å­—æ®µ
- **å¤åˆé¸­å­ç±»å‹**ï¼ˆ`A & B & C`ï¼‰- ç»“æ„ç±»å‹çš„äº¤å‰ç±»å‹
- å‡½æ•°è°ƒç”¨çš„**å‘½åå‚æ•°**ï¼ˆ`foo(name: "value", age: 30)`ï¼‰
- **ç©ºå€¼åˆå¹¶è¿ç®—ç¬¦**ï¼ˆ`??`ã€`??=`ã€`?.`ï¼‰ç”¨äºå®‰å…¨çš„ç©ºå€¼å¤„ç†
- **å…«è¿›åˆ¶å­—é¢é‡**ï¼ˆ`0o777`ã€`0O123`ï¼‰
- **æ•°å­—åˆ†éš”ç¬¦**ï¼ˆ`1_000_000`ã€`0xFF_FF`ã€`0b1111_0000`ï¼‰
- **å—æ³¨é‡Š**ï¼ˆ`/* ... */`ï¼‰
- å­—ç¬¦ä¸²/rune ä¸­çš„**åå…­è¿›åˆ¶è½¬ä¹‰åºåˆ—**ï¼ˆ`\x41` = 'A'ï¼‰
- å­—ç¬¦ä¸²ä¸­çš„ **Unicode è½¬ä¹‰åºåˆ—**ï¼ˆ`\u{1F600}` = ğŸ˜€ï¼‰
- **æ— å‰å¯¼é›¶çš„æµ®ç‚¹å­—é¢é‡**ï¼ˆ`.5`ã€`.123`ã€`.5e2`ï¼‰
- hemlockc ä¸­çš„**ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥**ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
- **LSP é›†æˆ**ï¼Œå¸¦å®æ—¶è¯Šæ–­çš„ç±»å‹æ£€æŸ¥
- **å¤åˆèµ‹å€¼è¿ç®—ç¬¦**ï¼ˆ`+=`ã€`-=`ã€`*=`ã€`/=`ã€`%=`ã€`&=`ã€`|=`ã€`^=`ã€`<<=`ã€`>>=`ï¼‰
- **è‡ªå¢/è‡ªå‡è¿ç®—ç¬¦**ï¼ˆ`++x`ã€`x++`ã€`--x`ã€`x--`ï¼‰
- **ç±»å‹ç²¾åº¦ä¿®å¤**ï¼ši64/u64 + f32 â†’ f64 ä»¥ä¿æŒç²¾åº¦
- å¸¦æ‹†ç®±ä¼˜åŒ–æç¤ºçš„ç»Ÿä¸€ç±»å‹ç³»ç»Ÿ
- å®Œæ•´ç±»å‹ç³»ç»Ÿï¼ˆi8-i64ã€u8-u64ã€f32/f64ã€boolã€stringã€runeã€ptrã€bufferã€arrayã€objectã€enumã€fileã€taskã€channelï¼‰
- å¸¦ 19 ä¸ªæ–¹æ³•çš„ UTF-8 å­—ç¬¦ä¸²
- å¸¦ 18 ä¸ªæ–¹æ³•çš„æ•°ç»„ï¼ŒåŒ…æ‹¬ map/filter/reduce
- å¸¦ `talloc()` å’Œ `sizeof()` çš„æ‰‹åŠ¨å†…å­˜ç®¡ç†
- å¸¦çœŸæ­£ pthread å¹¶è¡Œçš„ async/await
- ç”¨äºæ— é”å¹¶å‘ç¼–ç¨‹çš„åŸå­æ“ä½œ
- 40 ä¸ª stdlib æ¨¡å—ï¼ˆ+ arenaã€assertã€semverã€tomlã€retryã€iterã€randomã€shellï¼‰
- C äº’æ“ä½œçš„ FFIï¼Œå¸¦ `export extern fn` ç”¨äºå¯é‡ç”¨åº“åŒ…è£…
- ç¼–è¯‘å™¨ä¸­çš„ FFI ç»“æ„æ”¯æŒï¼ˆæŒ‰å€¼ä¼ é€’ C ç»“æ„ï¼‰
- FFI æŒ‡é’ˆè¾…åŠ©å‡½æ•°ï¼ˆ`ptr_null`ã€`ptr_read_*`ã€`ptr_write_*`ï¼‰
- deferã€try/catch/finally/throwã€panic
- æ–‡ä»¶ I/Oã€ä¿¡å·å¤„ç†ã€å‘½ä»¤æ‰§è¡Œ
- [hpm](https://github.com/hemlang/hpm) åŒ…ç®¡ç†å™¨ï¼Œå¸¦åŸºäº GitHub çš„æ³¨å†Œè¡¨
- ç¼–è¯‘å™¨åç«¯ï¼ˆC ä»£ç ç”Ÿæˆï¼‰ï¼Œ100% è§£é‡Šå™¨å¯¹ç­‰
- LSP æœåŠ¡å™¨ï¼Œå¸¦è·³è½¬åˆ°å®šä¹‰å’ŒæŸ¥æ‰¾å¼•ç”¨
- AST ä¼˜åŒ–éå†å’Œ O(1) æŸ¥æ‰¾çš„å˜é‡è§£æ
- apply() å†…ç½®å‡½æ•°ç”¨äºåŠ¨æ€å‡½æ•°è°ƒç”¨
- æ— ç¼“å†² channel å’Œå¤šå‚æ•°æ”¯æŒ
- 159 ä¸ªå¯¹ç­‰æµ‹è¯•ï¼ˆ100% é€šè¿‡ç‡ï¼‰

---

## ç†å¿µ

> æˆ‘ä»¬æä¾›å®‰å…¨çš„å·¥å…·ï¼ˆ`buffer`ã€ç±»å‹æ³¨è§£ã€è¾¹ç•Œæ£€æŸ¥ï¼‰ï¼Œä½†ä¸å¼ºåˆ¶ä½ ä½¿ç”¨å®ƒä»¬ï¼ˆ`ptr`ã€æ‰‹åŠ¨å†…å­˜ã€éå®‰å…¨æ“ä½œï¼‰ã€‚

**å¦‚æœä½ ä¸ç¡®å®šæŸä¸ªç‰¹æ€§æ˜¯å¦é€‚åˆ Hemlockï¼Œè¯·é—®è‡ªå·±ï¼š"è¿™æ˜¯ç»™ç¨‹åºå‘˜æ›´å¤šæ˜¾å¼æ§åˆ¶ï¼Œè¿˜æ˜¯éšè—äº†ä»€ä¹ˆï¼Ÿ"**

å¦‚æœæ˜¯éšè—ï¼Œå®ƒå¯èƒ½ä¸å±äº Hemlockã€‚



################################################################################
# å¿«é€Ÿå…¥é—¨
################################################################################

--------------------------------------------------------------------------------
## å­¦ä¹ è·¯å¾„
--------------------------------------------------------------------------------

# å­¦ä¹ è·¯å¾„

ä¸åŒçš„ç›®æ ‡éœ€è¦ä¸åŒçš„çŸ¥è¯†ã€‚é€‰æ‹©ä¸æ‚¨æƒ³è¦æ„å»ºçš„å†…å®¹ç›¸åŒ¹é…çš„è·¯å¾„ã€‚

---

## è·¯å¾„ 1ï¼šå¿«é€Ÿè„šæœ¬å’Œè‡ªåŠ¨åŒ–

**ç›®æ ‡ï¼š** ç¼–å†™è„šæœ¬æ¥è‡ªåŠ¨åŒ–ä»»åŠ¡ã€å¤„ç†æ–‡ä»¶å¹¶å®Œæˆå·¥ä½œã€‚

**è¾¾åˆ°ç”Ÿäº§åŠ›çš„æ—¶é—´ï¼š** å¾ˆå¿« - æ‚¨å¯ä»¥ç«‹å³å¼€å§‹ç¼–å†™æœ‰ç”¨çš„è„šæœ¬ã€‚

### æ‚¨å°†å­¦åˆ°çš„å†…å®¹

1. **[å¿«é€Ÿå…¥é—¨](#getting-started-quick-start)** - æ‚¨çš„ç¬¬ä¸€ä¸ªç¨‹åºï¼ŒåŸºæœ¬è¯­æ³•
2. **[å­—ç¬¦ä¸²](#language-guide-strings)** - æ–‡æœ¬å¤„ç†ã€åˆ†å‰²ã€æœç´¢
3. **[æ•°ç»„](#language-guide-arrays)** - åˆ—è¡¨ã€è¿‡æ»¤ã€è½¬æ¢æ•°æ®
4. **[æ–‡ä»¶ I/O](#advanced-file-io)** - è¯»å†™æ–‡ä»¶
5. **[å‘½ä»¤è¡Œå‚æ•°](#advanced-command-line-args)** - è·å–ç”¨æˆ·è¾“å…¥

### æš‚æ—¶è·³è¿‡

- å†…å­˜ç®¡ç†ï¼ˆè„šæœ¬è‡ªåŠ¨å¤„ç†ï¼‰
- å¼‚æ­¥/å¹¶å‘ï¼ˆå¯¹äºç®€å•è„šæœ¬æ¥è¯´å¤ªå¤æ‚ï¼‰
- FFIï¼ˆåªæœ‰åœ¨éœ€è¦ C äº’æ“ä½œæ—¶æ‰éœ€è¦ï¼‰

### ç¤ºä¾‹é¡¹ç›®ï¼šæ–‡ä»¶é‡å‘½åå™¨

```hemlock
import { list_dir, rename } from "@stdlib/fs";

// å°†æ‰€æœ‰ .txt æ–‡ä»¶é‡å‘½åä¸º .md
let files = list_dir(".");
for (file in files) {
    if (file.ends_with(".txt")) {
        let new_name = file.replace(".txt", ".md");
        rename(file, new_name);
        print(`å·²é‡å‘½åï¼š${file} -> ${new_name}`);
    }
}
```

---

## è·¯å¾„ 2ï¼šæ•°æ®å¤„ç†ä¸åˆ†æ

**ç›®æ ‡ï¼š** è§£ææ•°æ®ã€è½¬æ¢æ•°æ®ã€ç”ŸæˆæŠ¥å‘Šã€‚

**è¾¾åˆ°ç”Ÿäº§åŠ›çš„æ—¶é—´ï¼š** å¾ˆå¿« - Hemlock çš„å­—ç¬¦ä¸²å’Œæ•°ç»„æ–¹æ³•ä½¿è¿™å˜å¾—å¾ˆå®¹æ˜“ã€‚

### æ‚¨å°†å­¦åˆ°çš„å†…å®¹

1. **[å¿«é€Ÿå…¥é—¨](#getting-started-quick-start)** - åŸºç¡€çŸ¥è¯†
2. **[å­—ç¬¦ä¸²](#language-guide-strings)** - è§£æã€åˆ†å‰²ã€æ ¼å¼åŒ–
3. **[æ•°ç»„](#language-guide-arrays)** - mapã€filterã€reduce ç”¨äºæ•°æ®è½¬æ¢
4. **[å¯¹è±¡](#language-guide-objects)** - ç»“æ„åŒ–æ•°æ®
5. **æ ‡å‡†åº“ï¼š**
   - **[@stdlib/json](#stdlib-json)** - JSON è§£æ
   - **[@stdlib/csv](#stdlib-csv)** - CSV æ–‡ä»¶
   - **[@stdlib/fs](#stdlib-fs)** - æ–‡ä»¶æ“ä½œ

### ç¤ºä¾‹é¡¹ç›®ï¼šCSV åˆ†æå™¨

```hemlock
import { read_file } from "@stdlib/fs";
import { parse } from "@stdlib/csv";

let data = parse(read_file("sales.csv"));

// è®¡ç®—æ€»é”€å”®é¢
let total = 0;
for (row in data) {
    total = total + f64(row.amount);
}

print(`æ€»é”€å”®é¢ï¼š$${total}`);

// æ‰¾å‡ºæœ€é«˜é”€å”®é¢
let top = data[0];
for (row in data) {
    if (f64(row.amount) > f64(top.amount)) {
        top = row;
    }
}

print(`æœ€é«˜é”€å”®ï¼š${top.product} - $${top.amount}`);
```

---

## è·¯å¾„ 3ï¼šWeb å’Œç½‘ç»œç¼–ç¨‹

**ç›®æ ‡ï¼š** æ„å»º HTTP å®¢æˆ·ç«¯ã€ä½¿ç”¨ APIã€åˆ›å»ºæœåŠ¡å™¨ã€‚

**è¾¾åˆ°ç”Ÿäº§åŠ›çš„æ—¶é—´ï¼š** ä¸­ç­‰ - éœ€è¦ç†è§£å¼‚æ­¥åŸºç¡€çŸ¥è¯†ã€‚

### æ‚¨å°†å­¦åˆ°çš„å†…å®¹

1. **[å¿«é€Ÿå…¥é—¨](#getting-started-quick-start)** - åŸºç¡€çŸ¥è¯†
2. **[å‡½æ•°](#language-guide-functions)** - å›è°ƒå’Œé—­åŒ…
3. **[é”™è¯¯å¤„ç†](#language-guide-error-handling)** - ç½‘ç»œé”™è¯¯çš„ try/catch
4. **[å¼‚æ­¥ä¸å¹¶å‘](#advanced-async-concurrency)** - spawnã€awaitã€channels
5. **æ ‡å‡†åº“ï¼š**
   - **[@stdlib/http](#stdlib-http)** - HTTP è¯·æ±‚
   - **[@stdlib/json](#stdlib-json)** - API çš„ JSON
   - **[@stdlib/net](#stdlib-net)** - TCP/UDP å¥—æ¥å­—
   - **[@stdlib/url](#stdlib-url)** - URL è§£æ

### ç¤ºä¾‹é¡¹ç›®ï¼šAPI å®¢æˆ·ç«¯

```hemlock
import { http_get, http_post } from "@stdlib/http";
import { parse, stringify } from "@stdlib/json";

// GET è¯·æ±‚
let response = http_get("https://api.example.com/users");
let users = parse(response.body);

for (user in users) {
    print(`${user.name}ï¼š${user.email}`);
}

// POST è¯·æ±‚
let new_user = { name: "Alice", email: "alice@example.com" };
let result = http_post("https://api.example.com/users", {
    body: stringify(new_user),
    headers: { "Content-Type": "application/json" }
});

print(`åˆ›å»ºçš„ç”¨æˆ· IDï¼š${parse(result.body).id}`);
```

---

## è·¯å¾„ 4ï¼šç³»ç»Ÿç¼–ç¨‹

**ç›®æ ‡ï¼š** ç¼–å†™åº•å±‚ä»£ç ã€æ“ä½œå†…å­˜ã€ä¸ C åº“äº¤äº’ã€‚

**è¾¾åˆ°ç”Ÿäº§åŠ›çš„æ—¶é—´ï¼š** è¾ƒé•¿ - éœ€è¦ç†è§£å†…å­˜ç®¡ç†ã€‚

### æ‚¨å°†å­¦åˆ°çš„å†…å®¹

1. **[å¿«é€Ÿå…¥é—¨](#getting-started-quick-start)** - åŸºç¡€çŸ¥è¯†
2. **[ç±»å‹](#language-guide-types)** - ç†è§£ i32ã€u8ã€ptr ç­‰
3. **[å†…å­˜ç®¡ç†](#language-guide-memory)** - allocã€freeã€ç¼“å†²åŒº
4. **[FFI](#advanced-ffi)** - è°ƒç”¨ C å‡½æ•°
5. **[ä¿¡å·](#advanced-signals)** - ä¿¡å·å¤„ç†

### å…³é”®æ¦‚å¿µ

**å†…å­˜å®‰å…¨æ¸…å•ï¼š**
- [ ] æ¯ä¸ª `alloc()` éƒ½æœ‰å¯¹åº”çš„ `free()`
- [ ] é™¤ééœ€è¦åŸå§‹ `ptr`ï¼Œå¦åˆ™ä½¿ç”¨ `buffer()`
- [ ] é‡Šæ”¾åå°†æŒ‡é’ˆè®¾ç½®ä¸º `null`
- [ ] ä½¿ç”¨ `try/finally` ä¿è¯æ¸…ç†

**FFI ç±»å‹æ˜ å°„ï¼š**
| Hemlock | C |
|---------|---|
| `i8` | `char` / `int8_t` |
| `i32` | `int` |
| `i64` | `long`ï¼ˆ64ä½ï¼‰|
| `u8` | `unsigned char` |
| `f64` | `double` |
| `ptr` | `void*` |

### ç¤ºä¾‹é¡¹ç›®ï¼šè‡ªå®šä¹‰å†…å­˜æ± 

```hemlock
// ç®€å•çš„ bump allocator
let pool_size = 1024 * 1024;  // 1MB
let pool = alloc(pool_size);
let pool_offset = 0;

fn pool_alloc(size: i32): ptr {
    if (pool_offset + size > pool_size) {
        throw "å†…å­˜æ± å·²è€—å°½";
    }
    let p = pool + pool_offset;
    pool_offset = pool_offset + size;
    return p;
}

fn pool_reset() {
    pool_offset = 0;
}

fn pool_destroy() {
    free(pool);
}

// ä½¿ç”¨å®ƒ
let a = pool_alloc(100);
let b = pool_alloc(200);
memset(a, 0, 100);
memset(b, 0, 200);

pool_reset();  // é‡ç”¨æ‰€æœ‰å†…å­˜
pool_destroy();  // æ¸…ç†
```

---

## è·¯å¾„ 5ï¼šå¹¶è¡Œä¸å¹¶å‘ç¨‹åº

**ç›®æ ‡ï¼š** åœ¨å¤šä¸ª CPU æ ¸å¿ƒä¸Šè¿è¡Œä»£ç ï¼Œæ„å»ºå“åº”å¼åº”ç”¨ç¨‹åºã€‚

**è¾¾åˆ°ç”Ÿäº§åŠ›çš„æ—¶é—´ï¼š** ä¸­ç­‰ - å¼‚æ­¥è¯­æ³•å¾ˆç®€å•ï¼Œä½†å¹¶è¡Œæ€ç»´éœ€è¦ç»ƒä¹ ã€‚

### æ‚¨å°†å­¦åˆ°çš„å†…å®¹

1. **[å¿«é€Ÿå…¥é—¨](#getting-started-quick-start)** - åŸºç¡€çŸ¥è¯†
2. **[å‡½æ•°](#language-guide-functions)** - é—­åŒ…ï¼ˆå¯¹å¼‚æ­¥å¾ˆé‡è¦ï¼‰
3. **[å¼‚æ­¥ä¸å¹¶å‘](#advanced-async-concurrency)** - å®Œæ•´æ·±å…¥è®²è§£
4. **[åŸå­æ“ä½œ](#advanced-atomics)** - æ— é”ç¼–ç¨‹

### å…³é”®æ¦‚å¿µ

**Hemlock çš„å¼‚æ­¥æ¨¡å‹ï¼š**
- `async fn` - å®šä¹‰å¯ä»¥åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œçš„å‡½æ•°
- `spawn(fn, args...)` - å¼€å§‹è¿è¡Œå®ƒï¼Œè¿”å›ä»»åŠ¡å¥æŸ„
- `join(task)` æˆ– `await task` - ç­‰å¾…å®ƒå®Œæˆï¼Œè·å–ç»“æœ
- `channel(size)` - åˆ›å»ºç”¨äºåœ¨ä»»åŠ¡ä¹‹é—´å‘é€æ•°æ®çš„é˜Ÿåˆ—

**é‡è¦ï¼š** ä»»åŠ¡æ¥æ”¶å€¼çš„*å‰¯æœ¬*ã€‚å¦‚æœæ‚¨ä¼ é€’ä¸€ä¸ªæŒ‡é’ˆï¼Œæ‚¨éœ€è¦è´Ÿè´£ç¡®ä¿å†…å­˜åœ¨ä»»åŠ¡å®Œæˆä¹‹å‰ä¿æŒæœ‰æ•ˆã€‚

### ç¤ºä¾‹é¡¹ç›®ï¼šå¹¶è¡Œæ–‡ä»¶å¤„ç†å™¨

```hemlock
import { list_dir, read_file } from "@stdlib/fs";

async fn process_file(path: string): i32 {
    let content = read_file(path);
    let lines = content.split("\n");
    return lines.length;
}

// å¹¶è¡Œå¤„ç†æ‰€æœ‰æ–‡ä»¶
let files = list_dir("data/");
let tasks = [];

for (file in files) {
    if (file.ends_with(".txt")) {
        let task = spawn(process_file, "data/" + file);
        tasks.push({ name: file, task: task });
    }
}

// æ”¶é›†ç»“æœ
let total_lines = 0;
for (item in tasks) {
    let count = join(item.task);
    print(`${item.name}ï¼š${count} è¡Œ`);
    total_lines = total_lines + count;
}

print(`æ€»è®¡ï¼š${total_lines} è¡Œ`);
```

---

## ä»»ä½•è·¯å¾„éƒ½åº”è¯¥é¦–å…ˆå­¦ä¹ çš„å†…å®¹

æ— è®ºæ‚¨çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Œä»è¿™äº›åŸºç¡€çŸ¥è¯†å¼€å§‹ï¼š

### ç¬¬ 1 å‘¨ï¼šæ ¸å¿ƒåŸºç¡€
1. **[å¿«é€Ÿå…¥é—¨](#getting-started-quick-start)** - ç¼–å†™å¹¶è¿è¡Œæ‚¨çš„ç¬¬ä¸€ä¸ªç¨‹åº
2. **[è¯­æ³•](#language-guide-syntax)** - å˜é‡ã€è¿ç®—ç¬¦ã€æ§åˆ¶æµ
3. **[å‡½æ•°](#language-guide-functions)** - å®šä¹‰å’Œè°ƒç”¨å‡½æ•°

### ç¬¬ 2 å‘¨ï¼šæ•°æ®å¤„ç†
4. **[å­—ç¬¦ä¸²](#language-guide-strings)** - æ–‡æœ¬æ“ä½œ
5. **[æ•°ç»„](#language-guide-arrays)** - é›†åˆå’Œè¿­ä»£
6. **[å¯¹è±¡](#language-guide-objects)** - ç»“æ„åŒ–æ•°æ®

### ç¬¬ 3 å‘¨ï¼šå¥å£®æ€§
7. **[é”™è¯¯å¤„ç†](#language-guide-error-handling)** - try/catch/throw
8. **[æ¨¡å—](#language-guide-modules)** - å¯¼å…¥/å¯¼å‡ºï¼Œä½¿ç”¨æ ‡å‡†åº“

### ç„¶åï¼šé€‰æ‹©æ‚¨ä¸Šé¢çš„è·¯å¾„

---

## é€ŸæŸ¥è¡¨ï¼šæ¥è‡ªå…¶ä»–è¯­è¨€

### æ¥è‡ª Python

| Python | Hemlock | æ³¨æ„äº‹é¡¹ |
|--------|---------|----------|
| `x = 42` | `let x = 42;` | éœ€è¦åˆ†å· |
| `def fn():` | `fn name() { }` | éœ€è¦èŠ±æ‹¬å· |
| `if x:` | `if (x) { }` | éœ€è¦æ‹¬å·å’ŒèŠ±æ‹¬å· |
| `for i in range(10):` | `for (let i = 0; i < 10; i++) { }` | C é£æ ¼çš„ for å¾ªç¯ |
| `for item in list:` | `for (item in array) { }` | for-in ç›¸åŒ |
| `list.append(x)` | `array.push(x);` | æ–¹æ³•åä¸åŒ |
| `len(s)` | `s.length` æˆ– `len(s)` | ä¸¤è€…éƒ½å¯ä»¥ |
| è‡ªåŠ¨å†…å­˜ç®¡ç† | `ptr` éœ€è¦æ‰‹åŠ¨ç®¡ç† | å¤§å¤šæ•°ç±»å‹è‡ªåŠ¨æ¸…ç† |

### æ¥è‡ª JavaScript

| JavaScript | Hemlock | æ³¨æ„äº‹é¡¹ |
|------------|---------|----------|
| `let x = 42` | `let x = 42;` | ç›¸åŒï¼ˆéœ€è¦åˆ†å·ï¼‰|
| `const x = 42` | `let x = 42;` | æ²¡æœ‰ const å…³é”®å­— |
| `function fn()` | `fn name() { }` | ä¸åŒçš„å…³é”®å­— |
| `() => x` | `fn() { return x; }` | æ²¡æœ‰ç®­å¤´å‡½æ•° |
| `async/await` | `async/await` | ç›¸åŒè¯­æ³• |
| `Promise` | `spawn/join` | ä¸åŒçš„æ¨¡å‹ |
| è‡ªåŠ¨ GC | `ptr` éœ€è¦æ‰‹åŠ¨ç®¡ç† | å¤§å¤šæ•°ç±»å‹è‡ªåŠ¨æ¸…ç† |

### æ¥è‡ª C/C++

| C | Hemlock | æ³¨æ„äº‹é¡¹ |
|---|---------|----------|
| `int x = 42;` | `let x: i32 = 42;` | ç±»å‹åœ¨å†’å·å |
| `malloc(n)` | `alloc(n)` | ç›¸åŒæ¦‚å¿µ |
| `free(p)` | `free(p)` | ç›¸åŒ |
| `char* s = "hi"` | `let s = "hi";` | å­—ç¬¦ä¸²æ˜¯æ‰˜ç®¡çš„ |
| `#include` | `import { } from` | æ¨¡å—å¯¼å…¥ |
| å…¨éƒ¨æ‰‹åŠ¨ç®¡ç† | å¤§å¤šæ•°ç±»å‹è‡ªåŠ¨ | åªæœ‰ `ptr` éœ€è¦æ‰‹åŠ¨ |

---

## è·å–å¸®åŠ©

- **[æœ¯è¯­è¡¨](../glossary.md)** - ç¼–ç¨‹æœ¯è¯­å®šä¹‰
- **[ç¤ºä¾‹](../../examples/)** - å®Œæ•´çš„å·¥ä½œç¨‹åº
- **[æµ‹è¯•](../../tests/)** - æŸ¥çœ‹åŠŸèƒ½çš„ä½¿ç”¨æ–¹å¼
- **GitHub Issues** - æé—®ã€æŠ¥å‘Šé”™è¯¯

---

## éš¾åº¦çº§åˆ«

åœ¨æ•´ä¸ªæ–‡æ¡£ä¸­ï¼Œæ‚¨ä¼šçœ‹åˆ°è¿™äº›æ ‡è®°ï¼š

| æ ‡è®° | å«ä¹‰ |
|------|------|
| **åˆå­¦è€…** | ä¸éœ€è¦å…ˆå‰çš„ç¼–ç¨‹ç»éªŒ |
| **ä¸­çº§** | å‡è®¾å…·æœ‰åŸºæœ¬çš„ç¼–ç¨‹çŸ¥è¯† |
| **é«˜çº§** | éœ€è¦ç†è§£ç³»ç»Ÿæ¦‚å¿µ |

å¦‚æœæ ‡è®°ä¸º"åˆå­¦è€…"çš„å†…å®¹è®©æ‚¨å›°æƒ‘ï¼Œè¯·æŸ¥çœ‹[æœ¯è¯­è¡¨](../glossary.md)äº†è§£æœ¯è¯­å®šä¹‰ã€‚


--------------------------------------------------------------------------------
## å®‰è£…
--------------------------------------------------------------------------------

# å®‰è£…æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨åœ¨ç³»ç»Ÿä¸Šæ„å»ºå’Œå®‰è£… Hemlockã€‚

## å¿«é€Ÿå®‰è£…ï¼ˆæ¨èï¼‰

å®‰è£… Hemlock æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€è¡Œå®‰è£…è„šæœ¬ï¼š

```bash
curl -fsSL https://raw.githubusercontent.com/hemlang/hemlock/main/install.sh | bash
```

è¿™å°†ä¸ºæ‚¨çš„å¹³å°ï¼ˆLinux æˆ– macOSï¼Œx86_64 æˆ– arm64ï¼‰ä¸‹è½½å¹¶å®‰è£…æœ€æ–°çš„é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

### å®‰è£…é€‰é¡¹

```bash
# å®‰è£…åˆ°è‡ªå®šä¹‰å‰ç¼€ï¼ˆé»˜è®¤ï¼š~/.localï¼‰
curl -fsSL https://raw.githubusercontent.com/hemlang/hemlock/main/install.sh | bash -s -- --prefix /usr/local

# å®‰è£…ç‰¹å®šç‰ˆæœ¬
curl -fsSL https://raw.githubusercontent.com/hemlang/hemlock/main/install.sh | bash -s -- --version v1.6.0

# å®‰è£…å¹¶è‡ªåŠ¨æ›´æ–° shell PATH
curl -fsSL https://raw.githubusercontent.com/hemlang/hemlock/main/install.sh | bash -s -- --update-path
```

å®‰è£…åï¼ŒéªŒè¯æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š

```bash
hemlock --version
```

---

## ä»æºä»£ç æ„å»º

å¦‚æœæ‚¨æ›´å–œæ¬¢ä»æºä»£ç æ„å»ºï¼Œæˆ–è€…é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸é€‚ç”¨äºæ‚¨çš„ç³»ç»Ÿï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹è¯´æ˜æ“ä½œã€‚

## å‰ç½®æ¡ä»¶

### å¿…éœ€çš„ä¾èµ–é¡¹

Hemlock æ„å»ºéœ€è¦ä»¥ä¸‹ä¾èµ–é¡¹ï¼š

- **C ç¼–è¯‘å™¨**ï¼šGCC æˆ– Clangï¼ˆC11 æ ‡å‡†ï¼‰
- **Make**ï¼šGNU Make
- **libffi**ï¼šå¤–éƒ¨å‡½æ•°æ¥å£åº“ï¼ˆç”¨äº FFI æ”¯æŒï¼‰
- **OpenSSL**ï¼šåŠ å¯†åº“ï¼ˆç”¨äºå“ˆå¸Œå‡½æ•°ï¼šmd5ã€sha1ã€sha256ï¼‰
- **libwebsockets**ï¼šWebSocket å’Œ HTTP å®¢æˆ·ç«¯/æœåŠ¡å™¨æ”¯æŒ
- **zlib**ï¼šå‹ç¼©åº“

### å®‰è£…ä¾èµ–é¡¹

**macOSï¼š**
```bash
# å¦‚æœå°šæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# å®‰è£… Xcode å‘½ä»¤è¡Œå·¥å…·
xcode-select --install

# é€šè¿‡ Homebrew å®‰è£…ä¾èµ–é¡¹
brew install libffi openssl@3 libwebsockets
```

**macOS ç”¨æˆ·æ³¨æ„**ï¼šMakefile ä¼šè‡ªåŠ¨æ£€æµ‹ Homebrew å®‰è£…å¹¶è®¾ç½®æ­£ç¡®çš„ include/library è·¯å¾„ã€‚Hemlock æ”¯æŒ Intelï¼ˆx86_64ï¼‰å’Œ Apple Siliconï¼ˆarm64ï¼‰æ¶æ„ã€‚

**Ubuntu/Debianï¼š**
```bash
sudo apt-get update
sudo apt-get install build-essential libffi-dev libssl-dev libwebsockets-dev zlib1g-dev
```

**Fedora/RHELï¼š**
```bash
sudo dnf install gcc make libffi-devel openssl-devel libwebsockets-devel zlib-devel
```

**Arch Linuxï¼š**
```bash
sudo pacman -S base-devel libffi openssl libwebsockets zlib
```

## ä»æºä»£ç æ„å»º

### 1. å…‹éš†ä»“åº“

```bash
git clone https://github.com/hemlang/hemlock.git
cd hemlock
```

### 2. æ„å»º Hemlock

```bash
make
```

è¿™å°†ç¼–è¯‘ Hemlock è§£é‡Šå™¨å¹¶å°†å¯æ‰§è¡Œæ–‡ä»¶æ”¾åœ¨å½“å‰ç›®å½•ä¸­ã€‚

### 3. éªŒè¯å®‰è£…

```bash
./hemlock --version
```

æ‚¨åº”è¯¥çœ‹åˆ° Hemlock ç‰ˆæœ¬ä¿¡æ¯ã€‚

### 4. æµ‹è¯•æ„å»º

è¿è¡Œæµ‹è¯•å¥—ä»¶ä»¥ç¡®ä¿ä¸€åˆ‡æ­£å¸¸å·¥ä½œï¼š

```bash
make test
```

æ‰€æœ‰æµ‹è¯•éƒ½åº”è¯¥é€šè¿‡ã€‚å¦‚æœæ‚¨çœ‹åˆ°ä»»ä½•å¤±è´¥ï¼Œè¯·å°†å…¶ä½œä¸ºé—®é¢˜æŠ¥å‘Šã€‚

## ç³»ç»Ÿçº§å®‰è£…ï¼ˆå¯é€‰ï¼‰

è¦åœ¨ç³»ç»Ÿçº§å®‰è£… Hemlockï¼ˆä¾‹å¦‚ï¼Œå®‰è£…åˆ° `/usr/local/bin`ï¼‰ï¼š

```bash
sudo make install
```

è¿™å…è®¸æ‚¨ä»ä»»ä½•ä½ç½®è¿è¡Œ `hemlock` è€Œæ— éœ€æŒ‡å®šå®Œæ•´è·¯å¾„ã€‚

## è¿è¡Œ Hemlock

### äº¤äº’å¼ REPL

å¯åŠ¨è¯»å–-æ±‚å€¼-æ‰“å°å¾ªç¯ï¼ˆREPLï¼‰ï¼š

```bash
./hemlock
```

æ‚¨å°†çœ‹åˆ°ä¸€ä¸ªæç¤ºç¬¦ï¼Œå¯ä»¥åœ¨å…¶ä¸­è¾“å…¥ Hemlock ä»£ç ï¼š

```
Hemlock REPL
> print("Hello, World!");
Hello, World!
> let x = 42;
> print(x * 2);
84
>
```

ä½¿ç”¨ `Ctrl+D` æˆ– `Ctrl+C` é€€å‡º REPLã€‚

### è¿è¡Œç¨‹åº

æ‰§è¡Œ Hemlock è„šæœ¬ï¼š

```bash
./hemlock program.hml
```

å¸¦æœ‰å‘½ä»¤è¡Œå‚æ•°ï¼š

```bash
./hemlock program.hml arg1 arg2 "å¸¦ç©ºæ ¼çš„å‚æ•°"
```

## ç›®å½•ç»“æ„

æ„å»ºåï¼Œæ‚¨çš„ Hemlock ç›®å½•å°†å¦‚ä¸‹æ‰€ç¤ºï¼š

```
hemlock/
â”œâ”€â”€ hemlock           # ç¼–è¯‘çš„è§£é‡Šå™¨å¯æ‰§è¡Œæ–‡ä»¶
â”œâ”€â”€ src/              # æºä»£ç 
â”œâ”€â”€ include/          # å¤´æ–‡ä»¶
â”œâ”€â”€ tests/            # æµ‹è¯•å¥—ä»¶
â”œâ”€â”€ examples/         # ç¤ºä¾‹ç¨‹åº
â”œâ”€â”€ docs/             # æ–‡æ¡£
â”œâ”€â”€ stdlib/           # æ ‡å‡†åº“
â”œâ”€â”€ Makefile          # æ„å»ºé…ç½®
â””â”€â”€ README.md         # é¡¹ç›®è¯´æ˜
```

## æ„å»ºé€‰é¡¹

### è°ƒè¯•æ„å»º

ä½¿ç”¨è°ƒè¯•ç¬¦å·å’Œæ— ä¼˜åŒ–è¿›è¡Œæ„å»ºï¼š

```bash
make debug
```

### æ¸…ç†æ„å»º

åˆ é™¤æ‰€æœ‰ç¼–è¯‘çš„æ–‡ä»¶ï¼š

```bash
make clean
```

ä»å¤´å¼€å§‹é‡æ–°æ„å»ºï¼š

```bash
make clean && make
```

## æ•…éšœæ’é™¤

### macOSï¼šæ‰¾ä¸åˆ°åº“é”™è¯¯

å¦‚æœæ‚¨æ”¶åˆ°å…³äºç¼ºå°‘åº“çš„é”™è¯¯ï¼ˆ`-lcrypto`ã€`-lffi` ç­‰ï¼‰ï¼š

1. ç¡®ä¿å·²å®‰è£… Homebrew ä¾èµ–é¡¹ï¼š
   ```bash
   brew install libffi openssl@3 libwebsockets
   ```

2. éªŒè¯ Homebrew è·¯å¾„ï¼š
   ```bash
   brew --prefix libffi
   brew --prefix openssl
   ```

3. Makefile åº”è¯¥ä¼šè‡ªåŠ¨æ£€æµ‹è¿™äº›è·¯å¾„ã€‚å¦‚æœæ²¡æœ‰ï¼Œè¯·æ£€æŸ¥ `brew` æ˜¯å¦åœ¨æ‚¨çš„ PATH ä¸­ï¼š
   ```bash
   which brew
   ```

### macOSï¼šBSD ç±»å‹é”™è¯¯ï¼ˆ`u_int`ã€`u_char` æœªæ‰¾åˆ°ï¼‰

å¦‚æœæ‚¨çœ‹åˆ°å…³äºæœªçŸ¥ç±»å‹åç§°ï¼ˆå¦‚ `u_int` æˆ– `u_char`ï¼‰çš„é”™è¯¯ï¼š

1. è¿™åœ¨ v1.0.0+ ä¸­å·²é€šè¿‡ä½¿ç”¨ `_DARWIN_C_SOURCE` è€Œä¸æ˜¯ `_POSIX_C_SOURCE` ä¿®å¤
2. ç¡®ä¿æ‚¨æ‹¥æœ‰æœ€æ–°ç‰ˆæœ¬çš„ä»£ç 
3. æ¸…ç†å¹¶é‡æ–°æ„å»ºï¼š
   ```bash
   make clean && make
   ```

### Linuxï¼šæ‰¾ä¸åˆ° libffi

å¦‚æœæ‚¨æ”¶åˆ°å…³äºç¼ºå°‘ `ffi.h` æˆ– `-lffi` çš„é”™è¯¯ï¼š

1. ç¡®ä¿å·²å®‰è£… `libffi-dev`ï¼ˆè¯·å‚é˜…ä¸Šé¢çš„ä¾èµ–é¡¹ï¼‰
2. æ£€æŸ¥ `pkg-config` æ˜¯å¦èƒ½æ‰¾åˆ°å®ƒï¼š
   ```bash
   pkg-config --cflags --libs libffi
   ```
3. å¦‚æœæœªæ‰¾åˆ°ï¼Œæ‚¨å¯èƒ½éœ€è¦è®¾ç½® `PKG_CONFIG_PATH`ï¼š
   ```bash
   export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
   ```

### ç¼–è¯‘é”™è¯¯

å¦‚æœé‡åˆ°ç¼–è¯‘é”™è¯¯ï¼š

1. ç¡®ä¿æ‚¨æœ‰å…¼å®¹ C11 çš„ç¼–è¯‘å™¨
2. åœ¨ macOS ä¸Šï¼Œå°è¯•ä½¿ç”¨ Clangï¼ˆé»˜è®¤ï¼‰ï¼š
   ```bash
   make CC=clang
   ```
3. åœ¨ Linux ä¸Šï¼Œå°è¯•ä½¿ç”¨ GCCï¼š
   ```bash
   make CC=gcc
   ```
4. æ£€æŸ¥æ˜¯å¦å·²å®‰è£…æ‰€æœ‰ä¾èµ–é¡¹
5. å°è¯•ä»å¤´å¼€å§‹é‡æ–°æ„å»ºï¼š
   ```bash
   make clean && make
   ```

### æµ‹è¯•å¤±è´¥

å¦‚æœæµ‹è¯•å¤±è´¥ï¼š

1. æ£€æŸ¥æ‚¨æ˜¯å¦æ‹¥æœ‰æœ€æ–°ç‰ˆæœ¬çš„ä»£ç 
2. å°è¯•ä»å¤´å¼€å§‹é‡æ–°æ„å»ºï¼š
   ```bash
   make clean && make test
   ```
3. åœ¨ macOS ä¸Šï¼Œç¡®ä¿æ‚¨æ‹¥æœ‰æœ€æ–°çš„ Xcode å‘½ä»¤è¡Œå·¥å…·ï¼š
   ```bash
   xcode-select --install
   ```
4. åœ¨ GitHub ä¸ŠæŠ¥å‘Šé—®é¢˜ï¼ŒåŒ…æ‹¬ï¼š
   - æ‚¨çš„å¹³å°ï¼ˆmacOS ç‰ˆæœ¬ / Linux å‘è¡Œç‰ˆï¼‰
   - æ¶æ„ï¼ˆx86_64 / arm64ï¼‰
   - æµ‹è¯•è¾“å‡º
   - `make -v` å’Œ `gcc --version`ï¼ˆæˆ– `clang --version`ï¼‰çš„è¾“å‡º

## ä¸‹ä¸€æ­¥

- [å¿«é€Ÿå…¥é—¨æŒ‡å—](#getting-started-quick-start) - ç¼–å†™æ‚¨çš„ç¬¬ä¸€ä¸ª Hemlock ç¨‹åº
- [æ•™ç¨‹](#getting-started-tutorial) - é€æ­¥å­¦ä¹  Hemlock
- [è¯­è¨€æŒ‡å—](#language-guide-syntax) - æ¢ç´¢ Hemlock ç‰¹æ€§


--------------------------------------------------------------------------------
## å¿«é€Ÿå¼€å§‹
--------------------------------------------------------------------------------

# å¿«é€Ÿå…¥é—¨

å‡ åˆ†é’Ÿå†…å¼€å§‹ä½¿ç”¨ Hemlockï¼

## æ‚¨çš„ç¬¬ä¸€ä¸ªç¨‹åº

åˆ›å»ºä¸€ä¸ªåä¸º `hello.hml` çš„æ–‡ä»¶ï¼š

```hemlock
print("Hello, Hemlock!");
```

ä½¿ç”¨è§£é‡Šå™¨è¿è¡Œï¼š

```bash
./hemlock hello.hml
```

æˆ–ç¼–è¯‘ä¸ºåŸç”Ÿå¯æ‰§è¡Œæ–‡ä»¶ï¼š

```bash
./hemlockc hello.hml -o hello
./hello
```

è¾“å‡ºï¼š
```
Hello, Hemlock!
```

### è§£é‡Šå™¨ vs ç¼–è¯‘å™¨

Hemlock æä¾›ä¸¤ç§è¿è¡Œç¨‹åºçš„æ–¹å¼ï¼š

| å·¥å…· | ç”¨ä¾‹ | ç±»å‹æ£€æŸ¥ |
|------|------|----------|
| `hemlock` | å¿«é€Ÿè„šæœ¬ã€REPLã€å¼€å‘ | ä»…è¿è¡Œæ—¶ |
| `hemlockc` | ç”Ÿäº§äºŒè¿›åˆ¶æ–‡ä»¶ã€æ›´å¥½çš„æ€§èƒ½ | ç¼–è¯‘æ—¶ï¼ˆé»˜è®¤ï¼‰|

ç¼–è¯‘å™¨ï¼ˆ`hemlockc`ï¼‰åœ¨ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ä¹‹å‰å¯¹ä»£ç è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œå¯ä»¥æå‰æ•è·é”™è¯¯ã€‚

## åŸºæœ¬è¯­æ³•

### å˜é‡

```hemlock
// ä½¿ç”¨ 'let' å£°æ˜å˜é‡
let x = 42;
let name = "Alice";
let pi = 3.14159;

// ç±»å‹æ³¨è§£æ˜¯å¯é€‰çš„
let count: i32 = 100;
let ratio: f64 = 0.618;
```

**é‡è¦**ï¼šåˆ†å·åœ¨ Hemlock ä¸­æ˜¯**å¿…éœ€çš„**ï¼

### ç±»å‹

Hemlock æ‹¥æœ‰ä¸°å¯Œçš„ç±»å‹ç³»ç»Ÿï¼š

```hemlock
// æ•´æ•°
let small: i8 = 127;          // 8ä½æœ‰ç¬¦å·
let byte: u8 = 255;           // 8ä½æ— ç¬¦å·
let num: i32 = 2147483647;    // 32ä½æœ‰ç¬¦å·ï¼ˆé»˜è®¤ï¼‰
let big: i64 = 9223372036854775807;  // 64ä½æœ‰ç¬¦å·

// æµ®ç‚¹æ•°
let f: f32 = 3.14;            // 32ä½æµ®ç‚¹
let d: f64 = 2.71828;         // 64ä½æµ®ç‚¹ï¼ˆé»˜è®¤ï¼‰

// å­—ç¬¦ä¸²å’Œå­—ç¬¦
let text: string = "Hello";   // UTF-8 å­—ç¬¦ä¸²
let emoji: rune = 'ğŸš€';       // Unicode ç ç‚¹

// å¸ƒå°”å€¼å’Œç©ºå€¼
let flag: bool = true;
let empty = null;
```

### æ§åˆ¶æµ

```hemlock
// if è¯­å¥
if (x > 0) {
    print("æ­£æ•°");
} else if (x < 0) {
    print("è´Ÿæ•°");
} else {
    print("é›¶");
}

// while å¾ªç¯
let i = 0;
while (i < 5) {
    print(i);
    i = i + 1;
}

// for å¾ªç¯
for (let j = 0; j < 10; j = j + 1) {
    print(j);
}
```

### å‡½æ•°

```hemlock
// å‘½åå‡½æ•°
fn add(a: i32, b: i32): i32 {
    return a + b;
}

let result = add(5, 3);  // 8

// åŒ¿åå‡½æ•°
let multiply = fn(x, y) {
    return x * y;
};

print(multiply(4, 7));  // 28
```

## å­—ç¬¦ä¸²æ“ä½œ

Hemlock ä¸­çš„å­—ç¬¦ä¸²æ˜¯**å¯å˜çš„**å’Œ **UTF-8** ç¼–ç çš„ï¼š

```hemlock
let s = "hello";
s[0] = 'H';              // ç°åœ¨æ˜¯ "Hello"
print(s);

// å­—ç¬¦ä¸²æ–¹æ³•
let upper = s.to_upper();     // "HELLO"
let words = "a,b,c".split(","); // ["a", "b", "c"]
let sub = s.substr(1, 3);     // "ell"

// è¿æ¥
let greeting = "Hello" + ", " + "World!";
print(greeting);  // "Hello, World!"
```

## æ•°ç»„

æ”¯æŒæ··åˆç±»å‹çš„åŠ¨æ€æ•°ç»„ï¼š

```hemlock
let numbers = [1, 2, 3, 4, 5];
print(numbers[0]);      // 1
print(numbers.length);  // 5

// æ•°ç»„æ–¹æ³•
numbers.push(6);        // [1, 2, 3, 4, 5, 6]
let last = numbers.pop();  // 6
let slice = numbers.slice(1, 4);  // [2, 3, 4]

// å…è®¸æ··åˆç±»å‹
let mixed = [1, "two", true, null];
```

## å¯¹è±¡

JavaScript é£æ ¼çš„å¯¹è±¡ï¼š

```hemlock
// å¯¹è±¡å­—é¢é‡
let person = {
    name: "Alice",
    age: 30,
    city: "NYC"
};

print(person.name);  // "Alice"
person.age = 31;     // ä¿®æ”¹å­—æ®µ

// ä½¿ç”¨ 'self' çš„æ–¹æ³•
let counter = {
    count: 0,
    increment: fn() {
        self.count = self.count + 1;
    }
};

counter.increment();
print(counter.count);  // 1
```

## å†…å­˜ç®¡ç†

Hemlock ä½¿ç”¨**æ‰‹åŠ¨å†…å­˜ç®¡ç†**ï¼š

```hemlock
// å®‰å…¨ç¼“å†²åŒºï¼ˆæ¨èï¼‰
let buf = buffer(64);   // åˆ†é… 64 å­—èŠ‚
buf[0] = 65;            // å°†ç¬¬ä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º 'A'
print(buf[0]);          // 65
free(buf);              // é‡Šæ”¾å†…å­˜

// åŸå§‹æŒ‡é’ˆï¼ˆé«˜çº§ï¼‰
let ptr = alloc(100);
memset(ptr, 0, 100);    // ç”¨é›¶å¡«å……
free(ptr);
```

**é‡è¦**ï¼šæ‚¨å¿…é¡» `free()` æ‚¨ `alloc()` çš„å†…å­˜ï¼

## é”™è¯¯å¤„ç†

```hemlock
fn divide(a, b) {
    if (b == 0) {
        throw "é™¤é›¶é”™è¯¯";
    }
    return a / b;
}

try {
    let result = divide(10, 0);
    print(result);
} catch (e) {
    print("é”™è¯¯ï¼š" + e);
} finally {
    print("å®Œæˆ");
}
```

## å‘½ä»¤è¡Œå‚æ•°

é€šè¿‡ `args` æ•°ç»„è®¿é—®ç¨‹åºå‚æ•°ï¼š

```hemlock
// script.hml
print("è„šæœ¬ï¼š", args[0]);
print(`å‚æ•°æ•°é‡ï¼š${args.length - 1}`);

let i = 1;
while (i < args.length) {
    print(`  å‚æ•° ${i}ï¼š${args[i]}`);
    i = i + 1;
}
```

è¿è¡Œï¼š
```bash
./hemlock script.hml hello world
```

è¾“å‡ºï¼š
```
è„šæœ¬ï¼šscript.hml
å‚æ•°æ•°é‡ï¼š2
  å‚æ•° 1ï¼šhello
  å‚æ•° 2ï¼šworld
```

## æ–‡ä»¶ I/O

```hemlock
// å†™å…¥æ–‡ä»¶
let f = open("data.txt", "w");
f.write("Hello, File!");
f.close();

// è¯»å–æ–‡ä»¶
let f2 = open("data.txt", "r");
let content = f2.read();
print(content);  // "Hello, File!"
f2.close();
```

## æ¥ä¸‹æ¥å­¦ä»€ä¹ˆï¼Ÿ

ç°åœ¨æ‚¨å·²ç»äº†è§£äº†åŸºç¡€çŸ¥è¯†ï¼Œå¯ä»¥æ¢ç´¢æ›´å¤šå†…å®¹ï¼š

- [æ•™ç¨‹](#getting-started-tutorial) - å…¨é¢çš„åˆ†æ­¥æŒ‡å—
- [è¯­è¨€æŒ‡å—](#language-guide-syntax) - æ·±å…¥äº†è§£æ‰€æœ‰ç‰¹æ€§
- [ç¤ºä¾‹](../../examples/) - çœŸå®ä¸–ç•Œçš„ç¤ºä¾‹ç¨‹åº
- [API å‚è€ƒ](#reference-builtins) - å®Œæ•´çš„ API æ–‡æ¡£

## å¸¸è§é™·é˜±

### å¿˜è®°åˆ†å·

```hemlock
// âŒ é”™è¯¯ï¼šç¼ºå°‘åˆ†å·
let x = 42
let y = 10

// âœ… æ­£ç¡®
let x = 42;
let y = 10;
```

### å¿˜è®°é‡Šæ”¾å†…å­˜

```hemlock
// âŒ å†…å­˜æ³„æ¼
let buf = buffer(100);
// ... ä½¿ç”¨ buf ...
// å¿˜è®°è°ƒç”¨ free(buf)ï¼

// âœ… æ­£ç¡®
let buf = buffer(100);
// ... ä½¿ç”¨ buf ...
free(buf);
```

### èŠ±æ‹¬å·æ˜¯å¿…éœ€çš„

```hemlock
// âŒ é”™è¯¯ï¼šç¼ºå°‘èŠ±æ‹¬å·
if (x > 0)
    print("æ­£æ•°");

// âœ… æ­£ç¡®
if (x > 0) {
    print("æ­£æ•°");
}
```

## è·å–å¸®åŠ©

- é˜…è¯»[å®Œæ•´æ–‡æ¡£](../README.md)
- æŸ¥çœ‹[ç¤ºä¾‹ç›®å½•](../../examples/)
- æŸ¥çœ‹[æµ‹è¯•æ–‡ä»¶](../../tests/)äº†è§£ä½¿ç”¨æ¨¡å¼
- åœ¨ GitHub ä¸ŠæŠ¥å‘Šé—®é¢˜


--------------------------------------------------------------------------------
## æ•™ç¨‹
--------------------------------------------------------------------------------

# Hemlock æ•™ç¨‹

å­¦ä¹  Hemlock çš„å…¨é¢åˆ†æ­¥æŒ‡å—ã€‚

## ç›®å½•

1. [Hello World](#hello-world)
2. [å˜é‡å’Œç±»å‹](#å˜é‡å’Œç±»å‹)
3. [ç®—æœ¯å’Œè¿ç®—](#ç®—æœ¯å’Œè¿ç®—)
4. [æ§åˆ¶æµ](#æ§åˆ¶æµ)
5. [å‡½æ•°](#å‡½æ•°)
6. [å­—ç¬¦ä¸²å’Œå­—ç¬¦](#å­—ç¬¦ä¸²å’Œå­—ç¬¦)
7. [æ•°ç»„](#æ•°ç»„)
8. [å¯¹è±¡](#å¯¹è±¡)
9. [å†…å­˜ç®¡ç†](#å†…å­˜ç®¡ç†)
10. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
11. [æ–‡ä»¶ I/O](#æ–‡ä»¶-io)
12. [ç»¼åˆç¤ºä¾‹](#ç»¼åˆç¤ºä¾‹)

## Hello World

è®©æˆ‘ä»¬ä»ä¼ ç»Ÿçš„ç¬¬ä¸€ä¸ªç¨‹åºå¼€å§‹ï¼š

```hemlock
print("Hello, World!");
```

å°†å…¶ä¿å­˜ä¸º `hello.hml` å¹¶è¿è¡Œï¼š

```bash
./hemlock hello.hml
```

**è¦ç‚¹ï¼š**
- `print()` æ˜¯ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º
- å­—ç¬¦ä¸²ç”¨åŒå¼•å·æ‹¬èµ·æ¥
- åˆ†å·æ˜¯**å¿…éœ€çš„**

## å˜é‡å’Œç±»å‹

### å£°æ˜å˜é‡

```hemlock
// åŸºæœ¬å˜é‡å£°æ˜
let x = 42;
let name = "Alice";
let pi = 3.14159;

print(x);      // 42
print(name);   // Alice
print(pi);     // 3.14159
```

### ç±»å‹æ³¨è§£

è™½ç„¶ç±»å‹é»˜è®¤æ˜¯æ¨æ–­çš„ï¼Œä½†æ‚¨å¯ä»¥æ˜¾å¼æŒ‡å®šï¼š

```hemlock
let age: i32 = 30;
let height: f64 = 5.9;
let initial: rune = 'A';
let active: bool = true;
```

### ç±»å‹æ¨æ–­

Hemlock æ ¹æ®å€¼æ¨æ–­ç±»å‹ï¼š

```hemlock
let small = 42;              // i32ï¼ˆé€‚åˆ 32 ä½ï¼‰
let large = 5000000000;      // i64ï¼ˆå¯¹äº i32 å¤ªå¤§ï¼‰
let decimal = 3.14;          // f64ï¼ˆæµ®ç‚¹æ•°é»˜è®¤å€¼ï¼‰
let text = "hello";          // string
let flag = true;             // bool
```

### ç±»å‹æ£€æŸ¥

```hemlock
// ä½¿ç”¨ typeof() æ£€æŸ¥ç±»å‹
print(typeof(42));        // "i32"
print(typeof(3.14));      // "f64"
print(typeof("hello"));   // "string"
print(typeof(true));      // "bool"
print(typeof(null));      // "null"
```

## ç®—æœ¯å’Œè¿ç®—

### åŸºæœ¬ç®—æœ¯

```hemlock
let a = 10;
let b = 3;

print(a + b);   // 13
print(a - b);   // 7
print(a * b);   // 30
print(a / b);   // 3ï¼ˆæ•´æ•°é™¤æ³•ï¼‰
print(a == b);  // false
print(a > b);   // true
```

### ç±»å‹æå‡

æ··åˆç±»å‹æ—¶ï¼ŒHemlock ä¼šæå‡åˆ°æ›´å¤§/æ›´ç²¾ç¡®çš„ç±»å‹ï¼š

```hemlock
let x: i32 = 10;
let y: f64 = 3.5;
let result = x + y;  // result æ˜¯ f64ï¼ˆ10.0 + 3.5 = 13.5ï¼‰

print(result);       // 13.5
print(typeof(result)); // "f64"
```

### ä½è¿ç®—

```hemlock
let a = 12;  // äºŒè¿›åˆ¶ 1100
let b = 10;  // äºŒè¿›åˆ¶ 1010

print(a & b);   // 8  (AND)
print(a | b);   // 14 (OR)
print(a ^ b);   // 6  (XOR)
print(a << 1);  // 24ï¼ˆå·¦ç§»ï¼‰
print(a >> 1);  // 6 ï¼ˆå³ç§»ï¼‰
print(~a);      // -13 (NOT)
```

## æ§åˆ¶æµ

### If è¯­å¥

```hemlock
let x = 10;

if (x > 0) {
    print("æ­£æ•°");
} else if (x < 0) {
    print("è´Ÿæ•°");
} else {
    print("é›¶");
}
```

**æ³¨æ„ï¼š** èŠ±æ‹¬å·**å§‹ç»ˆæ˜¯å¿…éœ€çš„**ï¼Œå³ä½¿æ˜¯å•ä¸ªè¯­å¥ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

### While å¾ªç¯

```hemlock
let count = 0;
while (count < 5) {
    print(`è®¡æ•°ï¼š${count}`);
    count = count + 1;
}
```

### For å¾ªç¯

```hemlock
// C é£æ ¼çš„ for å¾ªç¯
for (let i = 0; i < 10; i = i + 1) {
    print(i);
}

// for-in å¾ªç¯ï¼ˆæ•°ç»„ï¼‰
let items = [10, 20, 30, 40];
for (let item in items) {
    print(`é¡¹ç›®ï¼š${item}`);
}
```

### Switch è¯­å¥

```hemlock
let day = 3;

switch (day) {
    case 1:
        print("æ˜ŸæœŸä¸€");
        break;
    case 2:
        print("æ˜ŸæœŸäºŒ");
        break;
    case 3:
        print("æ˜ŸæœŸä¸‰");
        break;
    default:
        print("å…¶ä»–æ—¥å­");
        break;
}
```

### Break å’Œ Continue

```hemlock
// Breakï¼šæå‰é€€å‡ºå¾ªç¯
let i = 0;
while (i < 10) {
    if (i == 5) {
        break;
    }
    print(i);
    i = i + 1;
}
// è¾“å‡ºï¼š0, 1, 2, 3, 4

// Continueï¼šè·³åˆ°ä¸‹ä¸€æ¬¡è¿­ä»£
for (let j = 0; j < 5; j = j + 1) {
    if (j == 2) {
        continue;
    }
    print(j);
}
// è¾“å‡ºï¼š0, 1, 3, 4
```

## å‡½æ•°

### å‘½åå‡½æ•°

```hemlock
fn greet(name: string): string {
    return "ä½ å¥½ï¼Œ" + name + "ï¼";
}

let message = greet("Alice");
print(message);  // "ä½ å¥½ï¼ŒAliceï¼"
```

### åŒ¿åå‡½æ•°

```hemlock
let add = fn(a, b) {
    return a + b;
};

print(add(5, 3));  // 8
```

### é€’å½’

```hemlock
fn factorial(n: i32): i32 {
    if (n <= 1) {
        return 1;
    }
    return n * factorial(n - 1);
}

print(factorial(5));  // 120
```

### é—­åŒ…

å‡½æ•°æ•è·å…¶ç¯å¢ƒï¼š

```hemlock
fn makeCounter() {
    let count = 0;
    return fn() {
        count = count + 1;
        return count;
    };
}

let counter = makeCounter();
print(counter());  // 1
print(counter());  // 2
print(counter());  // 3
```

### é«˜é˜¶å‡½æ•°

```hemlock
fn apply(f, x) {
    return f(x);
}

fn double(n) {
    return n * 2;
}

let result = apply(double, 21);
print(result);  // 42
```

## å­—ç¬¦ä¸²å’Œå­—ç¬¦

### å­—ç¬¦ä¸²åŸºç¡€

å­—ç¬¦ä¸²æ˜¯**å¯å˜çš„**å’Œ **UTF-8** ç¼–ç çš„ï¼š

```hemlock
let s = "hello";
print(s.length);      // 5ï¼ˆå­—ç¬¦æ•°ï¼‰
print(s.byte_length); // 5ï¼ˆå­—èŠ‚æ•°ï¼‰

// ä¿®æ”¹
s[0] = 'H';
print(s);  // "Hello"
```

### å­—ç¬¦ä¸²æ–¹æ³•

```hemlock
let text = "  Hello, World!  ";

// å¤§å°å†™è½¬æ¢
print(text.to_upper());  // "  HELLO, WORLD!  "
print(text.to_lower());  // "  hello, world!  "

// å»é™¤ç©ºç™½
print(text.trim());      // "Hello, World!"

// å­å­—ç¬¦ä¸²æå–
let hello = text.substr(2, 5);  // "Hello"
let world = text.slice(9, 14);  // "World"

// æœç´¢
let pos = text.find("World");   // 9
let has = text.contains("o");   // true

// åˆ†å‰²
let parts = "a,b,c".split(","); // ["a", "b", "c"]

// æ›¿æ¢
let s = "hello world".replace("world", "there");
print(s);  // "hello there"
```

### å­—ç¬¦ï¼ˆUnicode ç ç‚¹ï¼‰

```hemlock
let ch: rune = 'A';
let emoji: rune = 'ğŸš€';

print(ch);      // 'A'
print(emoji);   // U+1F680

// å­—ç¬¦ + å­—ç¬¦ä¸²è¿æ¥
let msg = '>' + " é‡è¦";
print(msg);  // "> é‡è¦"

// å­—ç¬¦å’Œæ•´æ•°ä¹‹é—´çš„è½¬æ¢
let code: i32 = ch;     // 65ï¼ˆASCII ç ï¼‰
let r: rune = 128640;   // U+1F680ï¼ˆğŸš€ï¼‰
```

## æ•°ç»„

### æ•°ç»„åŸºç¡€

```hemlock
let numbers = [1, 2, 3, 4, 5];
print(numbers[0]);      // 1
print(numbers.length);  // 5

// ä¿®æ”¹å…ƒç´ 
numbers[2] = 99;
print(numbers[2]);  // 99
```

### æ•°ç»„æ–¹æ³•

```hemlock
let arr = [10, 20, 30];

// åœ¨æœ«å°¾æ·»åŠ /åˆ é™¤
arr.push(40);           // [10, 20, 30, 40]
let last = arr.pop();   // 40ï¼Œarr ç°åœ¨æ˜¯ [10, 20, 30]

// åœ¨å¼€å¤´æ·»åŠ /åˆ é™¤
arr.unshift(5);         // [5, 10, 20, 30]
let first = arr.shift(); // 5ï¼Œarr ç°åœ¨æ˜¯ [10, 20, 30]

// åœ¨ç´¢å¼•å¤„æ’å…¥/åˆ é™¤
arr.insert(1, 15);      // [10, 15, 20, 30]
let removed = arr.remove(2);  // 20

// æœç´¢
let index = arr.find(15);     // 1
let has = arr.contains(10);   // true

// åˆ‡ç‰‡
let slice = arr.slice(0, 2);  // [10, 15]

// è¿æ¥ä¸ºå­—ç¬¦ä¸²
let text = arr.join(", ");    // "10, 15, 30"
```

### è¿­ä»£

```hemlock
let items = ["è‹¹æœ", "é¦™è•‰", "æ¨±æ¡ƒ"];

// for-in å¾ªç¯
for (let item in items) {
    print(item);
}

// æ‰‹åŠ¨è¿­ä»£
let i = 0;
while (i < items.length) {
    print(items[i]);
    i = i + 1;
}
```

## å¯¹è±¡

### å¯¹è±¡å­—é¢é‡

```hemlock
let person = {
    name: "Alice",
    age: 30,
    city: "NYC"
};

print(person.name);  // "Alice"
print(person.age);   // 30

// æ·»åŠ /ä¿®æ”¹å­—æ®µ
person.email = "alice@example.com";
person.age = 31;
```

### æ–¹æ³•å’Œ `self`

```hemlock
let calculator = {
    value: 0,
    add: fn(x) {
        self.value = self.value + x;
    },
    get: fn() {
        return self.value;
    }
};

calculator.add(10);
calculator.add(5);
print(calculator.get());  // 15
```

### ç±»å‹å®šä¹‰ï¼ˆé¸­å­ç±»å‹ï¼‰

```hemlock
define Person {
    name: string,
    age: i32,
    active?: true,  // å¸¦é»˜è®¤å€¼çš„å¯é€‰å­—æ®µ
}

let p = { name: "Bob", age: 25 };
let typed: Person = p;  // é¸­å­ç±»å‹éªŒè¯ç»“æ„

print(typeof(typed));   // "Person"
print(typed.active);    // trueï¼ˆåº”ç”¨é»˜è®¤å€¼ï¼‰
```

### JSON åºåˆ—åŒ–

```hemlock
let obj = { x: 10, y: 20, name: "test" };

// å¯¹è±¡åˆ° JSON
let json = obj.serialize();
print(json);  // {"x":10,"y":20,"name":"test"}

// JSON åˆ°å¯¹è±¡
let restored = json.deserialize();
print(restored.name);  // "test"
```

## å†…å­˜ç®¡ç†

### å®‰å…¨ç¼“å†²åŒºï¼ˆæ¨èï¼‰

```hemlock
// åˆ†é…ç¼“å†²åŒº
let buf = buffer(10);
print(buf.length);    // 10
print(buf.capacity);  // 10

// è®¾ç½®å€¼ï¼ˆè¾¹ç•Œæ£€æŸ¥ï¼‰
buf[0] = 65;  // 'A'
buf[1] = 66;  // 'B'
buf[2] = 67;  // 'C'

// è®¿é—®å€¼
print(buf[0]);  // 65

// å®Œæˆåå¿…é¡»é‡Šæ”¾
free(buf);
```

### åŸå§‹æŒ‡é’ˆï¼ˆé«˜çº§ï¼‰

```hemlock
// åˆ†é…åŸå§‹å†…å­˜
let ptr = alloc(100);

// ç”¨é›¶å¡«å……
memset(ptr, 0, 100);

// å¤åˆ¶æ•°æ®
let src = alloc(50);
memcpy(ptr, src, 50);

// é‡Šæ”¾ä¸¤è€…
free(src);
free(ptr);
```

### å†…å­˜å‡½æ•°

```hemlock
// é‡æ–°åˆ†é…
let p = alloc(64);
p = realloc(p, 128);  // è°ƒæ•´ä¸º 128 å­—èŠ‚
free(p);

// ç±»å‹åŒ–åˆ†é…ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰
// let arr = talloc(i32, 100);  // 100 ä¸ª i32 çš„æ•°ç»„
```

## é”™è¯¯å¤„ç†

### Try/Catch

```hemlock
fn divide(a, b) {
    if (b == 0) {
        throw "é™¤é›¶é”™è¯¯";
    }
    return a / b;
}

try {
    let result = divide(10, 0);
    print(result);
} catch (e) {
    print("é”™è¯¯ï¼š" + e);
}
// è¾“å‡ºï¼šé”™è¯¯ï¼šé™¤é›¶é”™è¯¯
```

### Finally å—

```hemlock
let file = null;

try {
    file = open("data.txt", "r");
    let content = file.read();
    print(content);
} catch (e) {
    print("é”™è¯¯ï¼š" + e);
} finally {
    // å§‹ç»ˆè¿è¡Œ
    if (file != null) {
        file.close();
    }
}
```

### æŠ›å‡ºå¯¹è±¡

```hemlock
try {
    throw { code: 404, message: "æœªæ‰¾åˆ°" };
} catch (e) {
    print(`é”™è¯¯ ${e.code}ï¼š${e.message}`);
}
// è¾“å‡ºï¼šé”™è¯¯ 404ï¼šæœªæ‰¾åˆ°
```

### Panicï¼ˆä¸å¯æ¢å¤çš„é”™è¯¯ï¼‰

```hemlock
fn validate(x) {
    if (x < 0) {
        panic("x å¿…é¡»æ˜¯éè´Ÿæ•°");
    }
    return x * 2;
}

validate(-5);  // ç¨‹åºé€€å‡ºå¹¶æ˜¾ç¤ºï¼španic: x å¿…é¡»æ˜¯éè´Ÿæ•°
```

## æ–‡ä»¶ I/O

### è¯»å–æ–‡ä»¶

```hemlock
// è¯»å–æ•´ä¸ªæ–‡ä»¶
let f = open("data.txt", "r");
let content = f.read();
print(content);
f.close();

// è¯»å–æŒ‡å®šå­—èŠ‚æ•°
let f2 = open("data.txt", "r");
let chunk = f2.read(100);  // è¯»å– 100 å­—èŠ‚
f2.close();
```

### å†™å…¥æ–‡ä»¶

```hemlock
// å†™å…¥æ–‡æœ¬
let f = open("output.txt", "w");
f.write("Hello, File!\n");
f.write("ç¬¬äºŒè¡Œ\n");
f.close();

// è¿½åŠ åˆ°æ–‡ä»¶
let f2 = open("output.txt", "a");
f2.write("è¿½åŠ çš„è¡Œ\n");
f2.close();
```

### äºŒè¿›åˆ¶ I/O

```hemlock
// å†™å…¥äºŒè¿›åˆ¶æ•°æ®
let buf = buffer(256);
buf[0] = 255;
buf[1] = 128;

let f = open("data.bin", "w");
f.write_bytes(buf);
f.close();

// è¯»å–äºŒè¿›åˆ¶æ•°æ®
let f2 = open("data.bin", "r");
let data = f2.read_bytes(256);
print(data[0]);  // 255
f2.close();

free(buf);
free(data);
```

### æ–‡ä»¶å±æ€§

```hemlock
let f = open("/path/to/file.txt", "r");

print(f.path);    // "/path/to/file.txt"
print(f.mode);    // "r"
print(f.closed);  // false

f.close();
print(f.closed);  // true
```

## ç»¼åˆç¤ºä¾‹

è®©æˆ‘ä»¬æ„å»ºä¸€ä¸ªç®€å•çš„å•è¯è®¡æ•°ç¨‹åºï¼š

```hemlock
// wordcount.hml - è®¡ç®—æ–‡ä»¶ä¸­çš„å•è¯æ•°

fn count_words(filename: string): i32 {
    let file = null;
    let count = 0;

    try {
        file = open(filename, "r");
        let content = file.read();

        // æŒ‰ç©ºæ ¼åˆ†å‰²å¹¶è®¡æ•°
        let words = content.split(" ");
        count = words.length;

    } catch (e) {
        print("è¯»å–æ–‡ä»¶é”™è¯¯ï¼š" + e);
        return -1;
    } finally {
        if (file != null) {
            file.close();
        }
    }

    return count;
}

// ä¸»ç¨‹åº
if (args.length < 2) {
    print("ç”¨æ³•ï¼š" + args[0] + " <æ–‡ä»¶å>");
} else {
    let filename = args[1];
    let words = count_words(filename);

    if (words >= 0) {
        print(`å•è¯æ•°ï¼š${words}`);
    }
}
```

è¿è¡Œï¼š
```bash
./hemlock wordcount.hml data.txt
```

## ä¸‹ä¸€æ­¥

æ­å–œï¼æ‚¨å·²ç»å­¦ä¼šäº† Hemlock çš„åŸºç¡€çŸ¥è¯†ã€‚æ¥ä¸‹æ¥å¯ä»¥æ¢ç´¢ï¼š

- [å¼‚æ­¥ä¸å¹¶å‘](#advanced-async-concurrency) - çœŸæ­£çš„å¤šçº¿ç¨‹
- [FFI](#advanced-ffi) - è°ƒç”¨ C å‡½æ•°
- [ä¿¡å·å¤„ç†](#advanced-signals) - è¿›ç¨‹ä¿¡å·
- [API å‚è€ƒ](#reference-builtins) - å®Œæ•´çš„ API æ–‡æ¡£
- [ç¤ºä¾‹](../../examples/) - æ›´å¤šçœŸå®ä¸–ç•Œçš„ç¨‹åº

## ç»ƒä¹ é¢˜

å°è¯•æ„å»ºè¿™äº›ç¨‹åºæ¥ç»ƒä¹ ï¼š

1. **è®¡ç®—å™¨**ï¼šå®ç°ä¸€ä¸ªç®€å•çš„è®¡ç®—å™¨ï¼Œæ”¯æŒ +ã€-ã€*ã€/
2. **æ–‡ä»¶å¤åˆ¶**ï¼šå°†ä¸€ä¸ªæ–‡ä»¶å¤åˆ¶åˆ°å¦ä¸€ä¸ªæ–‡ä»¶
3. **æ–æ³¢é‚£å¥‘**ï¼šç”Ÿæˆæ–æ³¢é‚£å¥‘æ•°åˆ—
4. **JSON è§£æå™¨**ï¼šè¯»å–å’Œè§£æ JSON æ–‡ä»¶
5. **æ–‡æœ¬å¤„ç†å™¨**ï¼šåœ¨æ–‡ä»¶ä¸­æŸ¥æ‰¾å’Œæ›¿æ¢æ–‡æœ¬

ç¥æ‚¨ä½¿ç”¨ Hemlock ç¼–ç¨‹æ„‰å¿«ï¼



################################################################################
# è¯­è¨€æŒ‡å—
################################################################################

--------------------------------------------------------------------------------
## å†…å­˜ç®¡ç†
--------------------------------------------------------------------------------

# å†…å­˜ç®¡ç†

Hemlock é‡‡ç”¨**æ‰‹åŠ¨å†…å­˜ç®¡ç†**ï¼Œå¯¹åˆ†é…å’Œé‡Šæ”¾æœ‰æ˜¾å¼æ§åˆ¶ã€‚æœ¬æŒ‡å—æ¶µç›– Hemlock çš„å†…å­˜æ¨¡å‹ã€ä¸¤ç§æŒ‡é’ˆç±»å‹ä»¥åŠå®Œæ•´çš„å†…å­˜ APIã€‚

---

## å†…å­˜åŸºç¡€ 101

**ç¼–ç¨‹æ–°æ‰‹ï¼Ÿ** ä»è¿™é‡Œå¼€å§‹ã€‚å¦‚æœä½ å·²ç»ç†è§£å†…å­˜ç®¡ç†ï¼Œå¯ä»¥è·³åˆ° [è®¾è®¡ç†å¿µ](#è®¾è®¡ç†å¿µ)ã€‚

### ä»€ä¹ˆæ˜¯å†…å­˜ç®¡ç†ï¼Ÿ

å½“ä½ çš„ç¨‹åºéœ€è¦å­˜å‚¨æ•°æ®ï¼ˆæ–‡æœ¬ã€æ•°å­—ã€åˆ—è¡¨ï¼‰æ—¶ï¼Œå®ƒéœ€è¦ç©ºé—´æ¥æ”¾ç½®è¿™äº›æ•°æ®ã€‚è¿™ä¸ªç©ºé—´æ¥è‡ªè®¡ç®—æœºçš„å†…å­˜ï¼ˆRAMï¼‰ã€‚å†…å­˜ç®¡ç†æ¶‰åŠï¼š

1. **è·å–ç©ºé—´** - éœ€è¦æ—¶è¯·æ±‚å†…å­˜
2. **ä½¿ç”¨ç©ºé—´** - è¯»å†™æ•°æ®
3. **å½’è¿˜ç©ºé—´** - å®Œæˆåè¿”è¿˜å†…å­˜

### ä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ

æƒ³è±¡ä¸€ä¸ªä¹¦ç±æœ‰é™çš„å›¾ä¹¦é¦†ï¼š
- å¦‚æœä½ ä¸æ–­å€Ÿä¹¦å´ä»ä¸å½’è¿˜ï¼Œæœ€ç»ˆå°±æ²¡æœ‰ä¹¦å¯å€Ÿäº†
- å¦‚æœä½ è¯•å›¾é˜…è¯»å·²ç»å½’è¿˜çš„ä¹¦ï¼Œä¼šäº§ç”Ÿæ··ä¹±æˆ–é—®é¢˜

å†…å­˜çš„å·¥ä½œæ–¹å¼ç›¸åŒã€‚å¦‚æœä½ å¿˜è®°å½’è¿˜å†…å­˜ï¼Œç¨‹åºä¼šé€æ¸ä½¿ç”¨è¶Šæ¥è¶Šå¤šçš„å†…å­˜ï¼ˆ"å†…å­˜æ³„æ¼"ï¼‰ã€‚å¦‚æœä½ åœ¨å½’è¿˜åå°è¯•ä½¿ç”¨å†…å­˜ï¼Œä¼šå‘ç”Ÿç³Ÿç³•çš„äº‹æƒ…ã€‚

### å¥½æ¶ˆæ¯

**å¤§å¤šæ•°æ—¶å€™ï¼Œä½ ä¸éœ€è¦è€ƒè™‘è¿™äº›ï¼**

Hemlock è‡ªåŠ¨æ¸…ç†å¤§å¤šæ•°å¸¸è§ç±»å‹ï¼š

```hemlock
fn example() {
    let name = "Alice";       // Hemlock ç®¡ç†è¿™ä¸ª
    let numbers = [1, 2, 3];  // è¿˜æœ‰è¿™ä¸ª
    let person = { age: 30 }; // è¿˜æœ‰è¿™ä¸ª

    // å‡½æ•°ç»“æŸæ—¶ï¼Œæ‰€æœ‰è¿™äº›éƒ½è‡ªåŠ¨æ¸…ç†ï¼
}
```

### ä½•æ—¶éœ€è¦è€ƒè™‘

åªæœ‰åœ¨ä½¿ç”¨ä»¥ä¸‹æƒ…å†µæ—¶æ‰éœ€è¦æ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼š

1. **`alloc()`** - åŸå§‹å†…å­˜åˆ†é…ï¼ˆè¿”å› `ptr`ï¼‰
2. **`buffer()`** - å½“ä½ æƒ³æå‰é‡Šæ”¾æ—¶ï¼ˆå¯é€‰ - ä½œç”¨åŸŸç»“æŸæ—¶è‡ªåŠ¨é‡Šæ”¾ï¼‰

```hemlock
// è¿™éœ€è¦æ‰‹åŠ¨æ¸…ç†ï¼š
let raw = alloc(100);   // åŸå§‹å†…å­˜ - ä½ å¿…é¡»é‡Šæ”¾å®ƒ
// ... ä½¿ç”¨ raw ...
free(raw);              // å¿…éœ€ï¼å¦åˆ™ä¼šæœ‰å†…å­˜æ³„æ¼

// è¿™è‡ªåŠ¨æ¸…ç†ï¼ˆä½†ä½ å¯ä»¥æå‰é‡Šæ”¾ï¼‰ï¼š
let buf = buffer(100);  // å®‰å…¨ buffer
// ... ä½¿ç”¨ buf ...
// free(buf);           // å¯é€‰ - ä½œç”¨åŸŸç»“æŸæ—¶è‡ªåŠ¨é‡Šæ”¾
```

### ç®€å•è§„åˆ™

> **å¦‚æœä½ è°ƒç”¨ `alloc()`ï¼Œä½ å¿…é¡»è°ƒç”¨ `free()`ã€‚**
>
> å…¶ä»–ä¸€åˆ‡éƒ½ä¼šä¸ºä½ å¤„ç†ã€‚

### åº”è¯¥ä½¿ç”¨å“ªä¸ªï¼Ÿ

| åœºæ™¯ | ä½¿ç”¨è¿™ä¸ª | åŸå›  |
|-----------|----------|-----|
| **åˆšå¼€å§‹å­¦ä¹ ** | `buffer()` | å®‰å…¨ã€æœ‰è¾¹ç•Œæ£€æŸ¥ã€è‡ªåŠ¨æ¸…ç† |
| **éœ€è¦å­—èŠ‚å­˜å‚¨** | `buffer()` | å®‰å…¨ä¸”ç®€å• |
| **ä¸ C åº“äº¤äº’ï¼ˆFFIï¼‰** | `alloc()` / `ptr` | C äº’æ“ä½œå¿…éœ€ |
| **æœ€å¤§æ€§èƒ½** | `alloc()` / `ptr` | æ— è¾¹ç•Œæ£€æŸ¥å¼€é”€ |
| **ä¸ç¡®å®š** | `buffer()` | æ€»æ˜¯æ›´å®‰å…¨çš„é€‰æ‹© |

### å¿«é€Ÿç¤ºä¾‹ï¼šå®‰å…¨ä¸åŸå§‹

```hemlock
// æ¨èï¼šå®‰å…¨ buffer
fn safe_example() {
    let data = buffer(10);
    data[0] = 65;           // æ­£ç¡®
    data[5] = 66;           // æ­£ç¡®
    // data[100] = 67;      // é”™è¯¯ - Hemlock é˜»æ­¢ä½ ï¼ˆè¾¹ç•Œæ£€æŸ¥ï¼‰
    free(data);             // æ¸…ç†
}

// é«˜çº§ï¼šåŸå§‹æŒ‡é’ˆï¼ˆä»…åœ¨éœ€è¦æ—¶ä½¿ç”¨ï¼‰
fn raw_example() {
    let data = alloc(10);
    *data = 65;             // æ­£ç¡®
    *(data + 5) = 66;       // æ­£ç¡®
    *(data + 100) = 67;     // å±é™© - æ— è¾¹ç•Œæ£€æŸ¥ï¼Œç ´åå†…å­˜ï¼
    free(data);             // æ¸…ç†
}
```

**ä» `buffer()` å¼€å§‹ã€‚åªæœ‰åœ¨ç‰¹åˆ«éœ€è¦åŸå§‹æŒ‡é’ˆæ—¶æ‰ä½¿ç”¨ `alloc()`ã€‚**

---

## è®¾è®¡ç†å¿µ

Hemlock éµå¾ªæ˜¾å¼å†…å­˜ç®¡ç†ä¸åˆç†é»˜è®¤å€¼çš„åŸåˆ™ï¼š
- æ— åƒåœ¾å›æ”¶ï¼ˆæ— ä¸å¯é¢„æµ‹çš„æš‚åœï¼‰
- å¸¸è§ç±»å‹çš„å†…éƒ¨å¼•ç”¨è®¡æ•°ï¼ˆstring, array, object, bufferï¼‰
- åŸå§‹æŒ‡é’ˆï¼ˆ`ptr`ï¼‰éœ€è¦æ‰‹åŠ¨ `free()`

è¿™ç§æ··åˆæ–¹æ³•åœ¨éœ€è¦æ—¶ç»™ä½ å®Œå…¨æ§åˆ¶ï¼ˆåŸå§‹æŒ‡é’ˆï¼‰ï¼ŒåŒæ—¶é˜²æ­¢å…¸å‹ç”¨ä¾‹çš„å¸¸è§é”™è¯¯ï¼ˆå¼•ç”¨è®¡æ•°ç±»å‹åœ¨ä½œç”¨åŸŸé€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾ï¼‰ã€‚

## å†…éƒ¨å¼•ç”¨è®¡æ•°

è¿è¡Œæ—¶ä½¿ç”¨**å†…éƒ¨å¼•ç”¨è®¡æ•°**æ¥ç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸã€‚å¯¹äºå¤§å¤šæ•°å¼•ç”¨è®¡æ•°ç±»å‹çš„å±€éƒ¨å˜é‡ï¼Œæ¸…ç†æ˜¯è‡ªåŠ¨ä¸”ç¡®å®šæ€§çš„ã€‚

### å¼•ç”¨è®¡æ•°å¤„ç†ä»€ä¹ˆ

è¿è¡Œæ—¶åœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨ç®¡ç†å¼•ç”¨è®¡æ•°ï¼š

1. **å˜é‡é‡æ–°èµ‹å€¼** - æ—§å€¼è¢«é‡Šæ”¾ï¼š
   ```hemlock
   let x = "first";   // ref_count = 1
   x = "second";      // "first" å†…éƒ¨é‡Šæ”¾ï¼Œ"second" ref_count = 1
   ```

2. **ä½œç”¨åŸŸé€€å‡º** - å±€éƒ¨å˜é‡è¢«é‡Šæ”¾ï¼š
   ```hemlock
   fn example() {
       let arr = [1, 2, 3];  // ref_count = 1
   }  // å‡½æ•°è¿”å›æ—¶ arr è¢«é‡Šæ”¾
   ```

3. **å®¹å™¨è¢«é‡Šæ”¾** - å…ƒç´ è¢«é‡Šæ”¾ï¼š
   ```hemlock
   let arr = [obj1, obj2];
   free(arr);  // obj1 å’Œ obj2 çš„ ref_count é€’å‡
   ```

### ä½•æ—¶éœ€è¦ `free()` vs ä½•æ—¶è‡ªåŠ¨

**è‡ªåŠ¨ï¼ˆä¸éœ€è¦ `free()`ï¼‰ï¼š** å¼•ç”¨è®¡æ•°ç±»å‹çš„å±€éƒ¨å˜é‡åœ¨ä½œç”¨åŸŸé€€å‡ºæ—¶é‡Šæ”¾ï¼š

```hemlock
fn process_data() {
    let arr = [1, 2, 3];
    let obj = { name: "test" };
    let buf = buffer(64);
    // ... ä½¿ç”¨å®ƒä»¬ ...
}  // å‡½æ•°è¿”å›æ—¶å…¨éƒ¨è‡ªåŠ¨é‡Šæ”¾ - ä¸éœ€è¦ free()
```

**éœ€è¦æ‰‹åŠ¨ `free()`ï¼š**

1. **åŸå§‹æŒ‡é’ˆ** - `alloc()` æ²¡æœ‰å¼•ç”¨è®¡æ•°ï¼š
   ```hemlock
   let p = alloc(64);
   // ... ä½¿ç”¨ p ...
   free(p);  // æ€»æ˜¯éœ€è¦ - å¦åˆ™ä¼šæ³„æ¼
   ```

2. **æå‰æ¸…ç†** - åœ¨ä½œç”¨åŸŸç»“æŸå‰é‡Šæ”¾ä»¥æ›´æ—©é‡Šæ”¾å†…å­˜ï¼š
   ```hemlock
   fn long_running() {
       let big = buffer(10000000);  // 10MB
       // ... ç”¨å®Œ big ...
       free(big);  // ç°åœ¨é‡Šæ”¾ï¼Œä¸ç­‰å‡½æ•°è¿”å›
       // ... æ›´å¤šä¸éœ€è¦ big çš„å·¥ä½œ ...
   }
   ```

3. **é•¿æœŸå­˜æ´»çš„æ•°æ®** - å…¨å±€æ•°æ®æˆ–å­˜å‚¨åœ¨æŒä¹…ç»“æ„ä¸­çš„æ•°æ®ï¼š
   ```hemlock
   let cache = {};  // æ¨¡å—çº§åˆ«ï¼Œé™¤éé‡Šæ”¾å¦åˆ™å­˜æ´»åˆ°ç¨‹åºé€€å‡º

   fn cleanup() {
       free(cache);  // é•¿æœŸå­˜æ´»æ•°æ®çš„æ‰‹åŠ¨æ¸…ç†
   }
   ```

### å¼•ç”¨è®¡æ•° vs åƒåœ¾å›æ”¶

| æ–¹é¢ | Hemlock å¼•ç”¨è®¡æ•° | åƒåœ¾å›æ”¶ |
|--------|---------------------|-------------------|
| æ¸…ç†æ—¶æœº | ç¡®å®šæ€§ï¼ˆref ä¸º 0 æ—¶ç«‹å³æ¸…ç†ï¼‰ | éç¡®å®šæ€§ï¼ˆGC å†³å®šä½•æ—¶ï¼‰ |
| ç”¨æˆ·è´£ä»» | å¿…é¡»è°ƒç”¨ `free()` | å®Œå…¨è‡ªåŠ¨ |
| è¿è¡Œæ—¶æš‚åœ | æ—  | "åœæ­¢ä¸–ç•Œ"æš‚åœ |
| å¯è§æ€§ | éšè—çš„å®ç°ç»†èŠ‚ | é€šå¸¸ä¸å¯è§ |
| å¾ªç¯å¼•ç”¨ | é€šè¿‡ visited-set è·Ÿè¸ªå¤„ç† | é€šè¿‡è¿½è¸ªå¤„ç† |

### å“ªäº›ç±»å‹æœ‰å¼•ç”¨è®¡æ•°

| ç±»å‹ | å¼•ç”¨è®¡æ•° | å¤‡æ³¨ |
|------|------------|-------|
| `ptr` | å¦ | æ€»æ˜¯éœ€è¦æ‰‹åŠ¨ `free()` |
| `buffer` | æ˜¯ | ä½œç”¨åŸŸé€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾ï¼›æ‰‹åŠ¨ `free()` ç”¨äºæå‰æ¸…ç† |
| `array` | æ˜¯ | ä½œç”¨åŸŸé€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾ï¼›æ‰‹åŠ¨ `free()` ç”¨äºæå‰æ¸…ç† |
| `object` | æ˜¯ | ä½œç”¨åŸŸé€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾ï¼›æ‰‹åŠ¨ `free()` ç”¨äºæå‰æ¸…ç† |
| `string` | æ˜¯ | å®Œå…¨è‡ªåŠ¨ï¼Œä¸éœ€è¦ `free()` |
| `function` | æ˜¯ | å®Œå…¨è‡ªåŠ¨ï¼ˆé—­åŒ…ç¯å¢ƒï¼‰ |
| `task` | æ˜¯ | çº¿ç¨‹å®‰å…¨çš„åŸå­å¼•ç”¨è®¡æ•° |
| `channel` | æ˜¯ | çº¿ç¨‹å®‰å…¨çš„åŸå­å¼•ç”¨è®¡æ•° |
| åŸºæœ¬ç±»å‹ | å¦ | æ ˆåˆ†é…ï¼Œæ— å †åˆ†é… |

### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

è¿™ç§æ··åˆæ–¹æ³•ç»™ä½ ï¼š
- **æ˜¾å¼æ§åˆ¶** - ä½ å†³å®šä½•æ—¶é‡Šæ”¾
- **ä½œç”¨åŸŸé”™è¯¯å®‰å…¨** - é‡æ–°èµ‹å€¼ä¸ä¼šæ³„æ¼
- **å¯é¢„æµ‹æ€§èƒ½** - æ—  GC æš‚åœ
- **é—­åŒ…æ”¯æŒ** - å‡½æ•°å¯ä»¥å®‰å…¨æ•è·å˜é‡

ç†å¿µä¿æŒä¸å˜ï¼šä½ åœ¨æ§åˆ¶ï¼Œä½†è¿è¡Œæ—¶å¸®åŠ©é˜²æ­¢å¸¸è§é”™è¯¯ï¼Œå¦‚é‡æ–°èµ‹å€¼æ—¶çš„æ³„æ¼æˆ–å®¹å™¨ä¸­çš„åŒé‡é‡Šæ”¾ã€‚

## ä¸¤ç§æŒ‡é’ˆç±»å‹

Hemlock æä¾›ä¸¤ç§ä¸åŒçš„æŒ‡é’ˆç±»å‹ï¼Œå…·æœ‰ä¸åŒçš„å®‰å…¨ç‰¹æ€§ï¼š

### `ptr` - åŸå§‹æŒ‡é’ˆï¼ˆå±é™©ï¼‰

åŸå§‹æŒ‡é’ˆ**åªæ˜¯åœ°å€**ï¼Œå®‰å…¨ä¿è¯æœ€å°‘ï¼š

```hemlock
let p: ptr = alloc(64);
memset(p, 0, 64);
free(p);  // ä½ å¿…é¡»è®°å¾—é‡Šæ”¾
```

**ç‰¹æ€§ï¼š**
- åªæ˜¯ä¸€ä¸ª 8 å­—èŠ‚åœ°å€
- æ— è¾¹ç•Œæ£€æŸ¥
- æ— é•¿åº¦è·Ÿè¸ª
- ç”¨æˆ·å®Œå…¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
- é€‚åˆä¸“å®¶å’Œ FFI

**ä½¿ç”¨åœºæ™¯ï¼š**
- åº•å±‚ç³»ç»Ÿç¼–ç¨‹
- å¤–éƒ¨å‡½æ•°æ¥å£ï¼ˆFFIï¼‰
- æ€§èƒ½å…³é”®ä»£ç 
- éœ€è¦å®Œå…¨æ§åˆ¶æ—¶

**å±é™©ï¼š**
```hemlock
let p = alloc(10);
let q = p + 100;  // è¿œè¶…åˆ†é…èŒƒå›´ - å…è®¸ä½†å±é™©
free(p);
let x = *p;       // æ‚¬ç©ºæŒ‡é’ˆ - æœªå®šä¹‰è¡Œä¸º
free(p);          // åŒé‡é‡Šæ”¾ - ä¼šå´©æºƒ
```

### `buffer` - å®‰å…¨åŒ…è£…ï¼ˆæ¨èï¼‰

Buffer æä¾›**è¾¹ç•Œæ£€æŸ¥è®¿é—®**ï¼ŒåŒæ—¶ä»éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼š

```hemlock
let b: buffer = buffer(64);
b[0] = 65;              // è¾¹ç•Œæ£€æŸ¥
print(b.length);        // 64
free(b);                // ä»ç„¶æ˜¯æ‰‹åŠ¨çš„
```

**ç‰¹æ€§ï¼š**
- æŒ‡é’ˆ + é•¿åº¦ + å®¹é‡
- è®¿é—®æ—¶è¾¹ç•Œæ£€æŸ¥
- ä»éœ€è¦æ‰‹åŠ¨ `free()`
- å¤§å¤šæ•°ä»£ç çš„æ›´å¥½é»˜è®¤é€‰æ‹©

**å±æ€§ï¼š**
```hemlock
let buf = buffer(100);
print(buf.length);      // 100ï¼ˆå½“å‰å¤§å°ï¼‰
print(buf.capacity);    // 100ï¼ˆåˆ†é…çš„å®¹é‡ï¼‰
```

**è¾¹ç•Œæ£€æŸ¥ï¼š**
```hemlock
let buf = buffer(10);
buf[5] = 42;      // æ­£ç¡®
buf[100] = 42;    // é”™è¯¯ï¼šç´¢å¼•è¶Šç•Œ
```

## å†…å­˜ API

### æ ¸å¿ƒåˆ†é…

**`alloc(bytes)` - åˆ†é…åŸå§‹å†…å­˜**
```hemlock
let p = alloc(1024);  // åˆ†é… 1KBï¼Œè¿”å› ptr
// ... ä½¿ç”¨å†…å­˜
free(p);
```

**`buffer(size)` - åˆ†é…å®‰å…¨ buffer**
```hemlock
let buf = buffer(256);  // åˆ†é… 256 å­—èŠ‚ buffer
buf[0] = 65;            // 'A'
buf[1] = 66;            // 'B'
free(buf);
```

**`free(ptr)` - é‡Šæ”¾å†…å­˜**
```hemlock
let p = alloc(100);
free(p);  // å¿…é¡»é‡Šæ”¾ä»¥é¿å…å†…å­˜æ³„æ¼

let buf = buffer(100);
free(buf);  // å¯¹ ptr å’Œ buffer éƒ½æœ‰æ•ˆ
```

**é‡è¦ï¼š** `free()` å¯¹ `ptr` å’Œ `buffer` ç±»å‹éƒ½æœ‰æ•ˆã€‚

### å†…å­˜æ“ä½œ

**`memset(ptr, byte, size)` - å¡«å……å†…å­˜**
```hemlock
let p = alloc(100);
memset(p, 0, 100);     // å°† 100 å­—èŠ‚æ¸…é›¶
memset(p, 65, 10);     // å°†å‰ 10 å­—èŠ‚å¡«å……ä¸º 'A'
free(p);
```

**`memcpy(dest, src, size)` - å¤åˆ¶å†…å­˜**
```hemlock
let src = alloc(50);
let dst = alloc(50);
memset(src, 42, 50);
memcpy(dst, src, 50);  // ä» src å¤åˆ¶ 50 å­—èŠ‚åˆ° dst
free(src);
free(dst);
```

**`realloc(ptr, size)` - è°ƒæ•´åˆ†é…å¤§å°**
```hemlock
let p = alloc(100);
// ... ä½¿ç”¨ 100 å­—èŠ‚
p = realloc(p, 200);   // è°ƒæ•´ä¸º 200 å­—èŠ‚
// ... ä½¿ç”¨ 200 å­—èŠ‚
free(p);
```

**æ³¨æ„ï¼š** `realloc()` åï¼Œæ—§æŒ‡é’ˆå¯èƒ½æ— æ•ˆã€‚å§‹ç»ˆä½¿ç”¨è¿”å›çš„æŒ‡é’ˆã€‚

### ç±»å‹åŒ–åˆ†é…

Hemlock æä¾›ç±»å‹åŒ–åˆ†é…è¾…åŠ©å‡½æ•°ä»¥æ–¹ä¾¿ä½¿ç”¨ï¼š

```hemlock
let arr = talloc(i32, 100);  // åˆ†é… 100 ä¸ª i32 å€¼ï¼ˆ400 å­—èŠ‚ï¼‰
let size = sizeof(i32);      // è¿”å› 4ï¼ˆå­—èŠ‚ï¼‰
```

**`sizeof(type)`** è¿”å›ç±»å‹çš„å­—èŠ‚å¤§å°ï¼š
- `sizeof(i8)` / `sizeof(u8)` -> 1
- `sizeof(i16)` / `sizeof(u16)` -> 2
- `sizeof(i32)` / `sizeof(u32)` / `sizeof(f32)` -> 4
- `sizeof(i64)` / `sizeof(u64)` / `sizeof(f64)` -> 8
- `sizeof(ptr)` -> 8ï¼ˆ64 ä½ç³»ç»Ÿï¼‰

**`talloc(type, count)`** åˆ†é… `count` ä¸ª `type` ç±»å‹çš„å…ƒç´ ï¼š

```hemlock
let ints = talloc(i32, 10);   // 40 å­—èŠ‚ç”¨äº 10 ä¸ª i32 å€¼
let floats = talloc(f64, 5);  // 40 å­—èŠ‚ç”¨äº 5 ä¸ª f64 å€¼
free(ints);
free(floats);
```

## å¸¸è§æ¨¡å¼

### æ¨¡å¼ï¼šåˆ†é…ã€ä½¿ç”¨ã€é‡Šæ”¾

å†…å­˜ç®¡ç†çš„åŸºæœ¬æ¨¡å¼ï¼š

```hemlock
// 1. åˆ†é…
let data = alloc(1024);

// 2. ä½¿ç”¨
memset(data, 0, 1024);
// ... åšå·¥ä½œ

// 3. é‡Šæ”¾
free(data);
```

### æ¨¡å¼ï¼šå®‰å…¨ Buffer ä½¿ç”¨

ä¼˜å…ˆä½¿ç”¨ buffer è¿›è¡Œè¾¹ç•Œæ£€æŸ¥è®¿é—®ï¼š

```hemlock
let buf = buffer(256);

// å®‰å…¨è¿­ä»£
let i = 0;
while (i < buf.length) {
    buf[i] = i;
    i = i + 1;
}

free(buf);
```

### æ¨¡å¼ï¼šä½¿ç”¨ try/finally ç®¡ç†èµ„æº

å³ä½¿å‡ºé”™ä¹Ÿç¡®ä¿æ¸…ç†ï¼š

```hemlock
let data = alloc(1024);
try {
    // ... é£é™©æ“ä½œ
    process(data);
} finally {
    free(data);  // å³ä½¿å‡ºé”™ä¹Ÿä¼šé‡Šæ”¾
}
```

## å†…å­˜å®‰å…¨æ³¨æ„äº‹é¡¹

### åŒé‡é‡Šæ”¾

**å…è®¸ä½†ä¼šå´©æºƒï¼š**
```hemlock
let p = alloc(100);
free(p);
free(p);  // å´©æºƒï¼šæ£€æµ‹åˆ°åŒé‡é‡Šæ”¾
```

**é¢„é˜²ï¼š**
```hemlock
let p = alloc(100);
free(p);
p = null;  // é‡Šæ”¾åè®¾ä¸º null

if (p != null) {
    free(p);  // ä¸ä¼šæ‰§è¡Œ
}
```

### æ‚¬ç©ºæŒ‡é’ˆ

**å…è®¸ä½†æœªå®šä¹‰è¡Œä¸ºï¼š**
```hemlock
let p = alloc(100);
*p = 42;      // æ­£ç¡®
free(p);
let x = *p;   // æœªå®šä¹‰ï¼šè¯»å–å·²é‡Šæ”¾å†…å­˜
```

**é¢„é˜²ï¼š** é‡Šæ”¾åä¸è¦è®¿é—®å†…å­˜ã€‚

### å†…å­˜æ³„æ¼

**å®¹æ˜“åˆ›å»ºï¼Œéš¾ä»¥è°ƒè¯•ï¼š**
```hemlock
fn leak_memory() {
    let p = alloc(1000);
    // å¿˜è®°é‡Šæ”¾ï¼
    return;  // å†…å­˜æ³„æ¼
}
```

**é¢„é˜²ï¼š** å§‹ç»ˆå°† `alloc()` ä¸ `free()` é…å¯¹ï¼š
```hemlock
fn safe_function() {
    let p = alloc(1000);
    try {
        // ... ä½¿ç”¨ p
    } finally {
        free(p);  // æ€»æ˜¯é‡Šæ”¾
    }
}
```

### æŒ‡é’ˆç®—æœ¯

**å…è®¸ä½†å±é™©ï¼š**
```hemlock
let p = alloc(10);
let q = p + 100;  // è¿œè¶…åˆ†é…è¾¹ç•Œ
*q = 42;          // æœªå®šä¹‰ï¼šè¶Šç•Œå†™å…¥
free(p);
```

**ä½¿ç”¨ buffer è¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼š**
```hemlock
let buf = buffer(10);
buf[100] = 42;  // é”™è¯¯ï¼šè¾¹ç•Œæ£€æŸ¥é˜»æ­¢æº¢å‡º
```

## æœ€ä½³å®è·µ

1. **é»˜è®¤ä½¿ç”¨ `buffer`** - é™¤éç‰¹åˆ«éœ€è¦åŸå§‹ `ptr` å¦åˆ™ä½¿ç”¨ `buffer`
2. **åŒ¹é… alloc/free** - æ¯ä¸ª `alloc()` åº”è¯¥æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª `free()`
3. **ä½¿ç”¨ try/finally** - ä½¿ç”¨å¼‚å¸¸å¤„ç†ç¡®ä¿æ¸…ç†
4. **é‡Šæ”¾åç½®ç©º** - é‡Šæ”¾åå°†æŒ‡é’ˆè®¾ä¸º `null` ä»¥æ•è·é‡Šæ”¾åä½¿ç”¨
5. **è¾¹ç•Œæ£€æŸ¥** - ä½¿ç”¨ buffer ç´¢å¼•è¿›è¡Œè‡ªåŠ¨è¾¹ç•Œæ£€æŸ¥
6. **è®°å½•æ‰€æœ‰æƒ** - æ˜ç¡®å“ªäº›ä»£ç æ‹¥æœ‰å¹¶é‡Šæ”¾æ¯ä¸ªåˆ†é…

## ç¤ºä¾‹

### ç¤ºä¾‹ï¼šåŠ¨æ€å­—ç¬¦ä¸²æ„å»ºå™¨

```hemlock
fn build_message(count: i32): ptr {
    let size = count * 10;
    let buf = alloc(size);

    let i = 0;
    while (i < count) {
        memset(buf + (i * 10), 65 + i, 10);
        i = i + 1;
    }

    return buf;  // è°ƒç”¨è€…å¿…é¡»é‡Šæ”¾
}

let msg = build_message(5);
// ... ä½¿ç”¨ msg
free(msg);
```

### ç¤ºä¾‹ï¼šå®‰å…¨æ•°ç»„æ“ä½œ

```hemlock
fn process_array(size: i32) {
    let arr = buffer(size);

    try {
        // å¡«å……æ•°ç»„
        let i = 0;
        while (i < arr.length) {
            arr[i] = i * 2;
            i = i + 1;
        }

        // å¤„ç†
        i = 0;
        while (i < arr.length) {
            print(arr[i]);
            i = i + 1;
        }
    } finally {
        free(arr);  // æ€»æ˜¯æ¸…ç†
    }
}
```

### ç¤ºä¾‹ï¼šå†…å­˜æ± æ¨¡å¼

```hemlock
// ç®€å•å†…å­˜æ± ï¼ˆç®€åŒ–ç‰ˆï¼‰
let pool = alloc(10000);
let pool_offset = 0;

fn pool_alloc(size: i32): ptr {
    if (pool_offset + size > 10000) {
        throw "Pool exhausted";
    }

    let ptr = pool + pool_offset;
    pool_offset = pool_offset + size;
    return ptr;
}

// ä½¿ç”¨æ± 
let p1 = pool_alloc(100);
let p2 = pool_alloc(200);

// ä¸€æ¬¡æ€§é‡Šæ”¾æ•´ä¸ªæ± 
free(pool);
```

## é™åˆ¶

éœ€è¦æ³¨æ„çš„å½“å‰é™åˆ¶ï¼š

- **åŸå§‹æŒ‡é’ˆéœ€è¦æ‰‹åŠ¨é‡Šæ”¾** - `alloc()` è¿”å›æ²¡æœ‰å¼•ç”¨è®¡æ•°çš„ `ptr`
- **æ— è‡ªå®šä¹‰åˆ†é…å™¨** - åªæœ‰ç³»ç»Ÿ malloc/free

**æ³¨æ„ï¼š** å¼•ç”¨è®¡æ•°ç±»å‹ï¼ˆstring, array, object, bufferï¼‰åœ¨ä½œç”¨åŸŸé€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚åªæœ‰æ¥è‡ª `alloc()` çš„åŸå§‹ `ptr` éœ€è¦æ˜¾å¼ `free()`ã€‚

## ç›¸å…³ä¸»é¢˜

- [å­—ç¬¦ä¸²](#language-guide-strings) - å­—ç¬¦ä¸²å†…å­˜ç®¡ç†å’Œ UTF-8 ç¼–ç 
- [æ•°ç»„](#language-guide-arrays) - åŠ¨æ€æ•°ç»„åŠå…¶å†…å­˜ç‰¹æ€§
- [å¯¹è±¡](#language-guide-objects) - å¯¹è±¡åˆ†é…å’Œç”Ÿå‘½å‘¨æœŸ
- [é”™è¯¯å¤„ç†](#language-guide-error-handling) - ä½¿ç”¨ try/finally è¿›è¡Œæ¸…ç†

## å¦è¯·å‚é˜…

- **è®¾è®¡ç†å¿µ**ï¼šå‚è§ CLAUDE.md ä¸­çš„ "Memory Management" éƒ¨åˆ†
- **ç±»å‹ç³»ç»Ÿ**ï¼šå‚è§ [ç±»å‹](#language-guide-types) äº†è§£ `ptr` å’Œ `buffer` ç±»å‹è¯¦æƒ…
- **FFI**ï¼šåŸå§‹æŒ‡é’ˆå¯¹å¤–éƒ¨å‡½æ•°æ¥å£è‡³å…³é‡è¦


--------------------------------------------------------------------------------
## å‡½æ•°
--------------------------------------------------------------------------------

# å‡½æ•°

Hemlock ä¸­çš„å‡½æ•°æ˜¯**ä¸€ç­‰å…¬æ°‘**ï¼Œå¯ä»¥èµ‹å€¼ç»™å˜é‡ã€ä½œä¸ºå‚æ•°ä¼ é€’ä»¥åŠä»å…¶ä»–å‡½æ•°è¿”å›ã€‚æœ¬æŒ‡å—æ¶µç›–å‡½æ•°è¯­æ³•ã€é—­åŒ…ã€é€’å½’å’Œé«˜çº§æ¨¡å¼ã€‚

## æ¦‚è¿°

```hemlock
// å‘½åå‡½æ•°è¯­æ³•
fn add(a: i32, b: i32): i32 {
    return a + b;
}

// åŒ¿åå‡½æ•°
let multiply = fn(x, y) {
    return x * y;
};

// é—­åŒ…
fn makeAdder(x) {
    return fn(y) {
        return x + y;
    };
}

let add5 = makeAdder(5);
print(add5(3));  // 8
```

## å‡½æ•°å£°æ˜

### å‘½åå‡½æ•°

```hemlock
fn greet(name: string): string {
    return "Hello, " + name;
}

let msg = greet("Alice");  // "Hello, Alice"
```

**ç»„æˆéƒ¨åˆ†ï¼š**
- `fn` - å‡½æ•°å…³é”®å­—
- `greet` - å‡½æ•°å
- `(name: string)` - å¸¦å¯é€‰ç±»å‹çš„å‚æ•°
- `: string` - å¯é€‰çš„è¿”å›ç±»å‹
- `{ ... }` - å‡½æ•°ä½“

### åŒ¿åå‡½æ•°

æ²¡æœ‰åç§°çš„å‡½æ•°ï¼Œèµ‹å€¼ç»™å˜é‡ï¼š

```hemlock
let square = fn(x) {
    return x * x;
};

print(square(5));  // 25
```

**å‘½åå‡½æ•° vs åŒ¿åå‡½æ•°ï¼š**
```hemlock
// è¿™ä¸¤ç§æ–¹å¼ç­‰ä»·ï¼š
fn add(a, b) { return a + b; }

let add = fn(a, b) { return a + b; };
```

**æ³¨æ„ï¼š** å‘½åå‡½æ•°ä¼šè¢«è§£è¯­æ³•ç³–ä¸ºå¸¦åŒ¿åå‡½æ•°çš„å˜é‡èµ‹å€¼ã€‚

## å‚æ•°

### åŸºæœ¬å‚æ•°

```hemlock
fn example(a, b, c) {
    return a + b + c;
}

let result = example(1, 2, 3);  // 6
```

### ç±»å‹æ³¨è§£

å‚æ•°çš„å¯é€‰ç±»å‹æ³¨è§£ï¼š

```hemlock
fn add(a: i32, b: i32): i32 {
    return a + b;
}

add(5, 10);      // OK
add(5, 10.5);    // è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ä¼šæå‡ä¸º f64
```

**ç±»å‹æ£€æŸ¥ï¼š**
- å¦‚æœæœ‰æ³¨è§£ï¼Œå‚æ•°ç±»å‹åœ¨è°ƒç”¨æ—¶æ£€æŸ¥
- éšå¼ç±»å‹è½¬æ¢éµå¾ªæ ‡å‡†æå‡è§„åˆ™
- ç±»å‹ä¸åŒ¹é…ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯

### æŒ‰å€¼ä¼ é€’

æ‰€æœ‰å‚æ•°éƒ½æ˜¯**å¤åˆ¶**çš„ï¼ˆæŒ‰å€¼ä¼ é€’ï¼‰ï¼š

```hemlock
fn modify(x) {
    x = 100;  // åªä¿®æ”¹æœ¬åœ°å‰¯æœ¬
}

let a = 10;
modify(a);
print(a);  // ä»ç„¶æ˜¯ 10ï¼ˆæœªæ”¹å˜ï¼‰
```

**æ³¨æ„ï¼š** å¯¹è±¡å’Œæ•°ç»„æŒ‰å¼•ç”¨ä¼ é€’ï¼ˆå¼•ç”¨è¢«å¤åˆ¶ï¼‰ï¼Œå› æ­¤å¯ä»¥ä¿®æ”¹å®ƒä»¬çš„å†…å®¹ï¼š

```hemlock
fn modify_array(arr) {
    arr[0] = 99;  // ä¿®æ”¹åŸå§‹æ•°ç»„
}

let a = [1, 2, 3];
modify_array(a);
print(a[0]);  // 99ï¼ˆå·²ä¿®æ”¹ï¼‰
```

## è¿”å›å€¼

### Return è¯­å¥

```hemlock
fn get_max(a: i32, b: i32): i32 {
    if (a > b) {
        return a;
    } else {
        return b;
    }
}
```

### è¿”å›ç±»å‹æ³¨è§£

è¿”å›å€¼çš„å¯é€‰ç±»å‹æ³¨è§£ï¼š

```hemlock
fn calculate(): f64 {
    return 3.14159;
}

fn get_name(): string {
    return "Alice";
}
```

**ç±»å‹æ£€æŸ¥ï¼š**
- å¦‚æœæœ‰æ³¨è§£ï¼Œè¿”å›ç±»å‹åœ¨å‡½æ•°è¿”å›æ—¶æ£€æŸ¥
- ç±»å‹è½¬æ¢éµå¾ªæ ‡å‡†æå‡è§„åˆ™

### éšå¼è¿”å›

æ²¡æœ‰è¿”å›ç±»å‹æ³¨è§£çš„å‡½æ•°éšå¼è¿”å› `null`ï¼š

```hemlock
fn print_message(msg) {
    print(msg);
    // éšå¼è¿”å› null
}

let result = print_message("hello");  // result æ˜¯ null
```

### æå‰è¿”å›

```hemlock
fn find_first_negative(arr) {
    for (let i = 0; i < arr.length; i = i + 1) {
        if (arr[i] < 0) {
            return i;  // æå‰é€€å‡º
        }
    }
    return -1;  // æœªæ‰¾åˆ°
}
```

### æ— å€¼è¿”å›

`return;` ä¸å¸¦å€¼è¿”å› `null`ï¼š

```hemlock
fn maybe_process(value) {
    if (value < 0) {
        return;  // è¿”å› null
    }
    return value * 2;
}
```

## ä¸€ç­‰å‡½æ•°

å‡½æ•°å¯ä»¥åƒå…¶ä»–å€¼ä¸€æ ·è¢«èµ‹å€¼ã€ä¼ é€’å’Œè¿”å›ã€‚

### å‡½æ•°ä½œä¸ºå˜é‡

```hemlock
let operation = fn(x, y) { return x + y; };

print(operation(5, 3));  // 8

// é‡æ–°èµ‹å€¼
operation = fn(x, y) { return x * y; };
print(operation(5, 3));  // 15
```

### å‡½æ•°ä½œä¸ºå‚æ•°

```hemlock
fn apply(f, x) {
    return f(x);
}

fn double(n) {
    return n * 2;
}

let result = apply(double, 5);  // 10
```

### å‡½æ•°ä½œä¸ºè¿”å›å€¼

```hemlock
fn get_operation(op: string) {
    if (op == "add") {
        return fn(a, b) { return a + b; };
    } else if (op == "multiply") {
        return fn(a, b) { return a * b; };
    } else {
        return fn(a, b) { return 0; };
    }
}

let add = get_operation("add");
print(add(5, 3));  // 8
```

## é—­åŒ…

å‡½æ•°æ•è·å…¶å®šä¹‰ç¯å¢ƒï¼ˆè¯æ³•ä½œç”¨åŸŸï¼‰ã€‚

### åŸºæœ¬é—­åŒ…

```hemlock
fn makeCounter() {
    let count = 0;
    return fn() {
        count = count + 1;
        return count;
    };
}

let counter = makeCounter();
print(counter());  // 1
print(counter());  // 2
print(counter());  // 3
```

**å·¥ä½œåŸç†ï¼š**
- å†…éƒ¨å‡½æ•°ä»å¤–éƒ¨ä½œç”¨åŸŸæ•è· `count`
- `count` åœ¨è¿”å›å‡½æ•°çš„å¤šæ¬¡è°ƒç”¨é—´æŒä¹…åŒ–
- æ¯æ¬¡è°ƒç”¨ `makeCounter()` éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå¸¦æœ‰è‡ªå·± `count` çš„æ–°é—­åŒ…

### å¸¦å‚æ•°çš„é—­åŒ…

```hemlock
fn makeAdder(x) {
    return fn(y) {
        return x + y;
    };
}

let add5 = makeAdder(5);
let add10 = makeAdder(10);

print(add5(3));   // 8
print(add10(3));  // 13
```

### å¤šä¸ªé—­åŒ…

```hemlock
fn makeOperations(x) {
    let add = fn(y) { return x + y; };
    let multiply = fn(y) { return x * y; };

    return { add: add, multiply: multiply };
}

let ops = makeOperations(5);
print(ops.add(3));       // 8
print(ops.multiply(3));  // 15
```

### è¯æ³•ä½œç”¨åŸŸ

å‡½æ•°å¯ä»¥é€šè¿‡è¯æ³•ä½œç”¨åŸŸè®¿é—®å¤–éƒ¨ä½œç”¨åŸŸå˜é‡ï¼š

```hemlock
let global = 10;

fn outer() {
    let outer_var = 20;

    fn inner() {
        // å¯ä»¥è¯»å– global å’Œ outer_var
        print(global);      // 10
        print(outer_var);   // 20
    }

    inner();
}

outer();
```

é—­åŒ…é€šè¿‡å¼•ç”¨æ•è·å˜é‡ï¼Œå…è®¸è¯»å–å’Œä¿®æ”¹å¤–éƒ¨ä½œç”¨åŸŸå˜é‡ï¼ˆå¦‚ä¸Šé¢çš„ `makeCounter` ç¤ºä¾‹æ‰€ç¤ºï¼‰ã€‚

## é€’å½’

å‡½æ•°å¯ä»¥è°ƒç”¨è‡ªèº«ã€‚

### åŸºæœ¬é€’å½’

```hemlock
fn factorial(n: i32): i32 {
    if (n <= 1) {
        return 1;
    }
    return n * factorial(n - 1);
}

print(factorial(5));  // 120
```

### äº’é€’å½’

å‡½æ•°å¯ä»¥äº’ç›¸è°ƒç”¨ï¼š

```hemlock
fn is_even(n: i32): bool {
    if (n == 0) {
        return true;
    }
    return is_odd(n - 1);
}

fn is_odd(n: i32): bool {
    if (n == 0) {
        return false;
    }
    return is_even(n - 1);
}

print(is_even(4));  // true
print(is_odd(4));   // false
```

### é€’å½’æ•°æ®å¤„ç†

```hemlock
fn sum_array(arr: array, index: i32): i32 {
    if (index >= arr.length) {
        return 0;
    }
    return arr[index] + sum_array(arr, index + 1);
}

let numbers = [1, 2, 3, 4, 5];
print(sum_array(numbers, 0));  // 15
```

**æ³¨æ„ï¼š** å°šæ— å°¾è°ƒç”¨ä¼˜åŒ– - æ·±åº¦é€’å½’å¯èƒ½å¯¼è‡´æ ˆæº¢å‡ºã€‚

## é«˜é˜¶å‡½æ•°

æ¥å—æˆ–è¿”å›å…¶ä»–å‡½æ•°çš„å‡½æ•°ã€‚

### Map æ¨¡å¼

```hemlock
fn map(arr, f) {
    let result = [];
    let i = 0;
    while (i < arr.length) {
        result.push(f(arr[i]));
        i = i + 1;
    }
    return result;
}

fn double(x) { return x * 2; }

let numbers = [1, 2, 3, 4, 5];
let doubled = map(numbers, double);  // [2, 4, 6, 8, 10]
```

### Filter æ¨¡å¼

```hemlock
fn filter(arr, predicate) {
    let result = [];
    let i = 0;
    while (i < arr.length) {
        if (predicate(arr[i])) {
            result.push(arr[i]);
        }
        i = i + 1;
    }
    return result;
}

fn is_even(x) { return x % 2 == 0; }

let numbers = [1, 2, 3, 4, 5, 6];
let evens = filter(numbers, is_even);  // [2, 4, 6]
```

### Reduce æ¨¡å¼

```hemlock
fn reduce(arr, f, initial) {
    let accumulator = initial;
    let i = 0;
    while (i < arr.length) {
        accumulator = f(accumulator, arr[i]);
        i = i + 1;
    }
    return accumulator;
}

fn add(a, b) { return a + b; }

let numbers = [1, 2, 3, 4, 5];
let sum = reduce(numbers, add, 0);  // 15
```

### å‡½æ•°ç»„åˆ

```hemlock
fn compose(f, g) {
    return fn(x) {
        return f(g(x));
    };
}

fn double(x) { return x * 2; }
fn increment(x) { return x + 1; }

let double_then_increment = compose(increment, double);
print(double_then_increment(5));  // 11 (5*2 + 1)
```

## å¸¸è§æ¨¡å¼

### æ¨¡å¼ï¼šå·¥å‚å‡½æ•°

```hemlock
fn createPerson(name: string, age: i32) {
    return {
        name: name,
        age: age,
        greet: fn() {
            return "Hi, I'm " + self.name;
        }
    };
}

let person = createPerson("Alice", 30);
print(person.greet());  // "Hi, I'm Alice"
```

### æ¨¡å¼ï¼šå›è°ƒå‡½æ•°

```hemlock
fn process_async(data, callback) {
    // ... å¤„ç†
    callback(data);
}

process_async("test", fn(result) {
    print("Processing complete: " + result);
});
```

### æ¨¡å¼ï¼šéƒ¨åˆ†åº”ç”¨

```hemlock
fn partial(f, x) {
    return fn(y) {
        return f(x, y);
    };
}

fn multiply(a, b) {
    return a * b;
}

let double = partial(multiply, 2);
let triple = partial(multiply, 3);

print(double(5));  // 10
print(triple(5));  // 15
```

### æ¨¡å¼ï¼šè®°å¿†åŒ–

```hemlock
fn memoize(f) {
    let cache = {};

    return fn(x) {
        if (cache.has(x)) {
            return cache[x];
        }

        let result = f(x);
        cache[x] = result;
        return result;
    };
}

fn expensive_fibonacci(n) {
    if (n <= 1) { return n; }
    return expensive_fibonacci(n - 1) + expensive_fibonacci(n - 2);
}

let fast_fib = memoize(expensive_fibonacci);
print(fast_fib(10));  // ä½¿ç”¨ç¼“å­˜ä¼šå¿«å¾ˆå¤š
```

## å‡½æ•°è¯­ä¹‰

### è¿”å›ç±»å‹è¦æ±‚

å¸¦æœ‰è¿”å›ç±»å‹æ³¨è§£çš„å‡½æ•°**å¿…é¡»**è¿”å›å€¼ï¼š

```hemlock
fn get_value(): i32 {
    // é”™è¯¯ï¼šç¼ºå°‘ return è¯­å¥
}

fn get_value(): i32 {
    return 42;  // OK
}
```

### ç±»å‹æ£€æŸ¥

```hemlock
fn add(a: i32, b: i32): i32 {
    return a + b;
}

add(5, 10);        // OK
add(5.5, 10.5);    // æå‡ä¸º f64ï¼Œè¿”å› f64
add("a", "b");     // è¿è¡Œæ—¶é”™è¯¯ï¼šç±»å‹ä¸åŒ¹é…
```

### ä½œç”¨åŸŸè§„åˆ™

```hemlock
let global = "global";

fn outer() {
    let outer_var = "outer";

    fn inner() {
        let inner_var = "inner";
        // å¯ä»¥è®¿é—®ï¼šinner_varã€outer_varã€global
    }

    // å¯ä»¥è®¿é—®ï¼šouter_varã€global
    // ä¸èƒ½è®¿é—®ï¼šinner_var
}

// å¯ä»¥è®¿é—®ï¼šglobal
// ä¸èƒ½è®¿é—®ï¼šouter_varã€inner_var
```

## æœ€ä½³å®è·µ

1. **ä½¿ç”¨ç±»å‹æ³¨è§£** - æœ‰åŠ©äºå‘ç°é”™è¯¯å¹¶è®°å½•æ„å›¾
2. **ä¿æŒå‡½æ•°å°å·§** - æ¯ä¸ªå‡½æ•°åº”åªåšä¸€ä»¶äº‹
3. **ä¼˜å…ˆä½¿ç”¨çº¯å‡½æ•°** - å°½å¯èƒ½é¿å…å‰¯ä½œç”¨
4. **å‘½åè¦æ¸…æ™°** - ä½¿ç”¨æè¿°æ€§çš„åŠ¨è¯åç§°
5. **æå‰è¿”å›** - ä½¿ç”¨å®ˆå«å­å¥å‡å°‘åµŒå¥—
6. **è®°å½•å¤æ‚é—­åŒ…** - æ˜ç¡®æ•è·çš„å˜é‡
7. **é¿å…æ·±åº¦é€’å½’** - å°šæ— å°¾è°ƒç”¨ä¼˜åŒ–

## å¸¸è§é™·é˜±

### é™·é˜±ï¼šé€’å½’æ·±åº¦

```hemlock
// æ·±åº¦é€’å½’å¯èƒ½å¯¼è‡´æ ˆæº¢å‡º
fn count_down(n) {
    if (n == 0) { return; }
    count_down(n - 1);
}

count_down(100000);  // å¯èƒ½å› æ ˆæº¢å‡ºè€Œå´©æºƒ
```

### é™·é˜±ï¼šä¿®æ”¹æ•è·çš„å˜é‡

```hemlock
fn make_counter() {
    let count = 0;
    return fn() {
        count = count + 1;  // å¯ä»¥è¯»å–å’Œä¿®æ”¹æ•è·çš„å˜é‡
        return count;
    };
}
```

**æ³¨æ„ï¼š** è¿™æ˜¯å¯è¡Œçš„ï¼Œä½†è¦æ³¨æ„æ‰€æœ‰é—­åŒ…å…±äº«åŒä¸€ä¸ªæ•è·çš„ç¯å¢ƒã€‚

## ç¤ºä¾‹

### ç¤ºä¾‹ï¼šå‡½æ•°ç®¡é“

```hemlock
fn pipeline(value, ...functions) {
    let result = value;
    for (f in functions) {
        result = f(result);
    }
    return result;
}

fn double(x) { return x * 2; }
fn increment(x) { return x + 1; }
fn square(x) { return x * x; }

let result = pipeline(3, double, increment, square);
print(result);  // 49 ((3*2+1)^2)
```

### ç¤ºä¾‹ï¼šäº‹ä»¶å¤„ç†å™¨

```hemlock
let handlers = [];

fn on_event(name: string, handler) {
    handlers.push({ name: name, handler: handler });
}

fn trigger_event(name: string, data) {
    let i = 0;
    while (i < handlers.length) {
        if (handlers[i].name == name) {
            handlers[i].handler(data);
        }
        i = i + 1;
    }
}

on_event("click", fn(data) {
    print("Clicked: " + data);
});

trigger_event("click", "button1");
```

### ç¤ºä¾‹ï¼šè‡ªå®šä¹‰æ¯”è¾ƒå™¨æ’åº

```hemlock
fn sort(arr, compare) {
    // ä½¿ç”¨è‡ªå®šä¹‰æ¯”è¾ƒå™¨çš„å†’æ³¡æ’åº
    let n = arr.length;
    let i = 0;
    while (i < n) {
        let j = 0;
        while (j < n - i - 1) {
            if (compare(arr[j], arr[j + 1]) > 0) {
                let temp = arr[j];
                arr[j] = arr[j + 1];
                arr[j + 1] = temp;
            }
            j = j + 1;
        }
        i = i + 1;
    }
}

fn ascending(a, b) {
    if (a < b) { return -1; }
    if (a > b) { return 1; }
    return 0;
}

let numbers = [5, 2, 8, 1, 9];
sort(numbers, ascending);
print(numbers);  // [1, 2, 5, 8, 9]
```

## å¯é€‰å‚æ•°ï¼ˆé»˜è®¤å‚æ•°ï¼‰

å‡½æ•°å¯ä»¥ä½¿ç”¨ `?:` è¯­æ³•å®šä¹‰å¸¦é»˜è®¤å€¼çš„å¯é€‰å‚æ•°ï¼š

```hemlock
fn greet(name, greeting?: "Hello") {
    return greeting + " " + name;
}

print(greet("Alice"));           // "Hello Alice"
print(greet("Bob", "Hi"));       // "Hi Bob"

fn add(a, b?: 10, c?: 100) {
    return a + b + c;
}

print(add(1));          // 111 (1 + 10 + 100)
print(add(1, 2));       // 103 (1 + 2 + 100)
print(add(1, 2, 3));    // 6   (1 + 2 + 3)
```

**è§„åˆ™ï¼š**
- å¯é€‰å‚æ•°å¿…é¡»åœ¨å¿…éœ€å‚æ•°ä¹‹å
- é»˜è®¤å€¼å¯ä»¥æ˜¯ä»»ä½•è¡¨è¾¾å¼
- çœç•¥çš„å‚æ•°ä½¿ç”¨é»˜è®¤å€¼

## å¯å˜å‚æ•°å‡½æ•°ï¼ˆå‰©ä½™å‚æ•°ï¼‰

å‡½æ•°å¯ä»¥ä½¿ç”¨å‰©ä½™å‚æ•°ï¼ˆ`...`ï¼‰æ¥å—å¯å˜æ•°é‡çš„å‚æ•°ï¼š

```hemlock
fn sum(...args) {
    let total = 0;
    for (arg in args) {
        total = total + arg;
    }
    return total;
}

print(sum(1, 2, 3));        // 6
print(sum(1, 2, 3, 4, 5));  // 15
print(sum());               // 0

fn log(prefix, ...messages) {
    for (msg in messages) {
        print(prefix + ": " + msg);
    }
}

log("INFO", "Starting", "Running", "Done");
// INFO: Starting
// INFO: Running
// INFO: Done
```

**è§„åˆ™ï¼š**
- å‰©ä½™å‚æ•°å¿…é¡»æ˜¯æœ€åä¸€ä¸ªå‚æ•°
- å‰©ä½™å‚æ•°å°†æ‰€æœ‰å‰©ä½™å‚æ•°æ”¶é›†åˆ°ä¸€ä¸ªæ•°ç»„ä¸­
- å¯ä»¥ä¸æ™®é€šå‚æ•°å’Œå¯é€‰å‚æ•°ç»„åˆä½¿ç”¨

## å‡½æ•°ç±»å‹æ³¨è§£

å‡½æ•°ç±»å‹å…è®¸ä½ ä¸ºå‡½æ•°å‚æ•°å’Œè¿”å›å€¼æŒ‡å®šç²¾ç¡®çš„ç­¾åï¼š

### åŸºæœ¬å‡½æ•°ç±»å‹

```hemlock
// å‡½æ•°ç±»å‹è¯­æ³•ï¼šfn(param_types): return_type
fn apply(f: fn(i32): i32, x: i32): i32 {
    return f(x);
}

let double = fn(n) { return n * 2; };
let result = apply(double, 5);  // 10
```

### é«˜é˜¶å‡½æ•°ç±»å‹

```hemlock
// è¿”å›å‡½æ•°çš„å‡½æ•°
fn make_adder(n: i32): fn(i32): i32 {
    return fn(x) { return x + n; };
}

let add5 = make_adder(5);
print(add5(10));  // 15
```

### å¼‚æ­¥å‡½æ•°ç±»å‹

```hemlock
// å¼‚æ­¥å‡½æ•°ç±»å‹
fn run_task(handler: async fn(): void) {
    spawn(handler);
}

run_task(async fn() {
    print("Running async!");
});
```

### å‡½æ•°ç±»å‹åˆ«å

```hemlock
// åˆ›å»ºå‘½åå‡½æ•°ç±»å‹ä»¥æé«˜æ¸…æ™°åº¦
type Callback = fn(i32): void;
type Predicate = fn(any): bool;
type BinaryOp = fn(i32, i32): i32;

fn filter_with(arr: array, pred: Predicate): array {
    return arr.filter(pred);
}
```

## Const å‚æ•°

`const` ä¿®é¥°ç¬¦é˜²æ­¢åœ¨å‡½æ•°å†…ä¿®æ”¹å‚æ•°ï¼š

### åŸºæœ¬ Const å‚æ•°

```hemlock
fn print_all(const items: array) {
    // items.push(4);  // é”™è¯¯ï¼šä¸èƒ½ä¿®æ”¹ const å‚æ•°
    for (item in items) {
        print(item);   // OKï¼šå…è®¸è¯»å–
    }
}

let nums = [1, 2, 3];
print_all(nums);
```

### æ·±åº¦ä¸å¯å˜æ€§

Const å‚æ•°å¼ºåˆ¶æ·±åº¦ä¸å¯å˜æ€§ - ä¸èƒ½é€šè¿‡ä»»ä½•è·¯å¾„è¿›è¡Œä¿®æ”¹ï¼š

```hemlock
fn describe(const person: object) {
    print(person.name);       // OKï¼šå…è®¸è¯»å–
    // person.name = "Bob";   // é”™è¯¯ï¼šä¸èƒ½ä¿®æ”¹
    // person.address.city = "NYC";  // é”™è¯¯ï¼šæ·±åº¦ const
}
```

### Const é˜»æ­¢çš„æ“ä½œ

| ç±»å‹ | è¢« Const é˜»æ­¢ | å…è®¸çš„ |
|------|--------------|-------|
| array | push, pop, shift, unshift, insert, remove, clear, reverse | slice, concat, map, filter, find, contains |
| object | å­—æ®µèµ‹å€¼ | å­—æ®µè¯»å– |
| buffer | ç´¢å¼•èµ‹å€¼ | ç´¢å¼•è¯»å– |
| string | ç´¢å¼•èµ‹å€¼ | æ‰€æœ‰æ–¹æ³•ï¼ˆè¿”å›æ–°å­—ç¬¦ä¸²ï¼‰ |

## å‘½åå‚æ•°

å‡½æ•°å¯ä»¥ä½¿ç”¨å‘½åå‚æ•°è°ƒç”¨ä»¥æé«˜æ¸…æ™°åº¦å’Œçµæ´»æ€§ï¼š

### åŸºæœ¬å‘½åå‚æ•°

```hemlock
fn create_user(name: string, age?: 18, active?: true) {
    print(name + " is " + age + " years old");
}

// ä½ç½®å‚æ•°ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰
create_user("Alice", 25, false);

// å‘½åå‚æ•° - å¯ä»¥ä»»æ„é¡ºåº
create_user(name: "Bob", age: 30);
create_user(age: 25, name: "Charlie", active: false);
```

### æ··åˆä½ç½®å‚æ•°å’Œå‘½åå‚æ•°

```hemlock
// é€šè¿‡å‘½åæ¥è·³è¿‡å¯é€‰å‚æ•°
create_user("David", active: false);  // ä½¿ç”¨é»˜è®¤ age=18

// å‘½åå‚æ•°å¿…é¡»åœ¨ä½ç½®å‚æ•°ä¹‹å
create_user("Eve", age: 21);          // OK
// create_user(name: "Bad", 25);      // é”™è¯¯ï¼šä½ç½®å‚æ•°åœ¨å‘½åå‚æ•°ä¹‹å
```

### å‘½åå‚æ•°è§„åˆ™

- ä½¿ç”¨ `name: value` è¯­æ³•è¡¨ç¤ºå‘½åå‚æ•°
- å‘½åå‚æ•°å¯ä»¥åœ¨ä½ç½®å‚æ•°ä¹‹åä»¥ä»»æ„é¡ºåºå‡ºç°
- ä½ç½®å‚æ•°ä¸èƒ½è·Ÿåœ¨å‘½åå‚æ•°ä¹‹å
- ä¸é»˜è®¤/å¯é€‰å‚æ•°é…åˆä½¿ç”¨
- æœªçŸ¥çš„å‚æ•°åä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯

## é™åˆ¶

éœ€è¦æ³¨æ„çš„å½“å‰é™åˆ¶ï¼š

- **æ— æŒ‰å¼•ç”¨ä¼ é€’** - `ref` å…³é”®å­—å·²è§£æä½†æœªå®ç°
- **æ— å‡½æ•°é‡è½½** - æ¯ä¸ªåç§°åªèƒ½æœ‰ä¸€ä¸ªå‡½æ•°
- **æ— å°¾è°ƒç”¨ä¼˜åŒ–** - æ·±åº¦é€’å½’å—æ ˆå¤§å°é™åˆ¶

## ç›¸å…³ä¸»é¢˜

- [Control Flow](#language-guide-control-flow) - å‡½æ•°ä¸æ§åˆ¶ç»“æ„çš„é…åˆä½¿ç”¨
- [Objects](#language-guide-objects) - æ–¹æ³•æ˜¯å­˜å‚¨åœ¨å¯¹è±¡ä¸­çš„å‡½æ•°
- [Error Handling](#language-guide-error-handling) - å‡½æ•°å’Œå¼‚å¸¸å¤„ç†
- [Types](#language-guide-types) - ç±»å‹æ³¨è§£å’Œè½¬æ¢

## å¦è¯·å‚é˜…

- **é—­åŒ…**ï¼šå‚è§ CLAUDE.md ä¸­çš„"Functions"éƒ¨åˆ†äº†è§£é—­åŒ…è¯­ä¹‰
- **ä¸€ç­‰å…¬æ°‘**ï¼šå‡½æ•°æ˜¯ä¸å…¶ä»–å€¼ä¸€æ ·çš„å€¼
- **è¯æ³•ä½œç”¨åŸŸ**ï¼šå‡½æ•°æ•è·å…¶å®šä¹‰ç¯å¢ƒ


--------------------------------------------------------------------------------
## å­—ç¬¦(Rune)
--------------------------------------------------------------------------------

# Rune å­—ç¬¦

Rune è¡¨ç¤º **Unicode ç ç‚¹**ï¼ˆU+0000 åˆ° U+10FFFFï¼‰ï¼Œä½œä¸º Hemlock ä¸­å­—ç¬¦æ“ä½œçš„ç‹¬ç«‹ç±»å‹ã€‚ä¸å­—èŠ‚ï¼ˆu8ï¼‰ä¸åŒï¼Œrune æ˜¯å®Œæ•´çš„ Unicode å­—ç¬¦ï¼Œå¯ä»¥è¡¨ç¤ºä»»ä½•è¯­è¨€çš„å­—ç¬¦æˆ–è¡¨æƒ…ç¬¦å·ã€‚

## æ¦‚è¿°

```hemlock
let ch = 'A';           // Rune å­—é¢é‡
let emoji = 'ğŸš€';       // å¤šå­—èŠ‚å­—ç¬¦ä½œä¸ºå•ä¸ª rune
print(ch);              // 'A'
print(emoji);           // U+1F680

let s = "Hello " + '!'; // å­—ç¬¦ä¸² + rune è¿æ¥
let r = '>' + " msg";   // Rune + å­—ç¬¦ä¸²è¿æ¥
```

## ä»€ä¹ˆæ˜¯ Runeï¼Ÿ

Rune æ˜¯è¡¨ç¤º Unicode ç ç‚¹çš„ **32 ä½å€¼**ï¼š

- **èŒƒå›´ï¼š** 0 åˆ° 0x10FFFFï¼ˆ1,114,111 ä¸ªæœ‰æ•ˆç ç‚¹ï¼‰
- **ä¸æ˜¯æ•°å€¼ç±»å‹** - ç”¨äºå­—ç¬¦è¡¨ç¤º
- **ä¸ u8/char ä¸åŒ** - Rune æ˜¯å®Œæ•´çš„ Unicodeï¼Œu8 åªæ˜¯å­—èŠ‚
- **å­—ç¬¦ä¸²ç´¢å¼•è¿”å›** - `str[0]` è¿”å› runeï¼Œè€Œä¸æ˜¯å­—èŠ‚

**ä¸ºä»€ä¹ˆä½¿ç”¨ runeï¼Ÿ**
- Hemlock å­—ç¬¦ä¸²æ˜¯ UTF-8 ç¼–ç çš„
- å•ä¸ª Unicode å­—ç¬¦åœ¨ UTF-8 ä¸­å¯èƒ½æ˜¯ 1-4 ä¸ªå­—èŠ‚
- Rune å…è®¸å¤„ç†å®Œæ•´å­—ç¬¦ï¼Œè€Œä¸æ˜¯éƒ¨åˆ†å­—èŠ‚

## Rune å­—é¢é‡

### åŸºæœ¬è¯­æ³•

å•å¼•å·è¡¨ç¤º rune å­—é¢é‡ï¼š

```hemlock
let a = 'A';            // ASCII å­—ç¬¦
let b = '0';            // æ•°å­—å­—ç¬¦
let c = '!';            // æ ‡ç‚¹ç¬¦å·
let d = ' ';            // ç©ºæ ¼
```

### å¤šå­—èŠ‚ UTF-8 å­—ç¬¦

Rune å¯ä»¥è¡¨ç¤ºä»»ä½• Unicode å­—ç¬¦ï¼š

```hemlock
// è¡¨æƒ…ç¬¦å·
let rocket = 'ğŸš€';      // è¡¨æƒ…ç¬¦å·ï¼ˆU+1F680ï¼‰
let heart = 'â¤';        // å¿ƒå½¢ï¼ˆU+2764ï¼‰
let smile = 'ğŸ˜€';       // ç¬‘è„¸ï¼ˆU+1F600ï¼‰

// CJK å­—ç¬¦
let chinese = 'ä¸­';     // ä¸­æ–‡ï¼ˆU+4E2Dï¼‰
let japanese = 'ã‚';    // å¹³å‡åï¼ˆU+3042ï¼‰
let korean = 'í•œ';      // éŸ©æ–‡ï¼ˆU+D55Cï¼‰

// ç¬¦å·
let check = 'âœ“';        // å¯¹å‹¾ï¼ˆU+2713ï¼‰
let arrow = 'â†’';        // å³ç®­å¤´ï¼ˆU+2192ï¼‰
```

### è½¬ä¹‰åºåˆ—

ç‰¹æ®Šå­—ç¬¦çš„å¸¸ç”¨è½¬ä¹‰åºåˆ—ï¼š

```hemlock
let newline = '\n';     // æ¢è¡Œç¬¦ï¼ˆU+000Aï¼‰
let tab = '\t';         // åˆ¶è¡¨ç¬¦ï¼ˆU+0009ï¼‰
let backslash = '\\';   // åæ–œæ ï¼ˆU+005Cï¼‰
let quote = '\'';       // å•å¼•å·ï¼ˆU+0027ï¼‰
let dquote = '"';       // åŒå¼•å·ï¼ˆU+0022ï¼‰
let null_char = '\0';   // ç©ºå­—ç¬¦ï¼ˆU+0000ï¼‰
let cr = '\r';          // å›è½¦ç¬¦ï¼ˆU+000Dï¼‰
```

**å¯ç”¨çš„è½¬ä¹‰åºåˆ—ï¼š**
- `\n` - æ¢è¡Œç¬¦
- `\t` - æ°´å¹³åˆ¶è¡¨ç¬¦
- `\r` - å›è½¦ç¬¦
- `\0` - ç©ºå­—ç¬¦
- `\\` - åæ–œæ 
- `\'` - å•å¼•å·
- `\"` - åŒå¼•å·

### Unicode è½¬ä¹‰

ä½¿ç”¨ `\u{XXXXXX}` è¯­æ³•è¡¨ç¤º Unicode ç ç‚¹ï¼ˆæœ€å¤š 6 ä¸ªåå…­è¿›åˆ¶æ•°å­—ï¼‰ï¼š

```hemlock
let rocket = '\u{1F680}';   // ğŸš€ é€šè¿‡ Unicode è½¬ä¹‰è¡¨ç¤ºçš„è¡¨æƒ…ç¬¦å·
let heart = '\u{2764}';     // â¤ å¿ƒå½¢
let ascii = '\u{41}';       // 'A' é€šè¿‡è½¬ä¹‰è¡¨ç¤º
let max = '\u{10FFFF}';     // æœ€å¤§ Unicode ç ç‚¹

// å‰å¯¼é›¶æ˜¯å¯é€‰çš„
let a = '\u{41}';           // ä¸ '\u{0041}' ç›¸åŒ
let b = '\u{0041}';
```

**è§„åˆ™ï¼š**
- èŒƒå›´ï¼š`\u{0}` åˆ° `\u{10FFFF}`
- åå…­è¿›åˆ¶æ•°å­—ï¼š1 åˆ° 6 ä½
- ä¸åŒºåˆ†å¤§å°å†™ï¼š`\u{1F680}` æˆ– `\u{1f680}`
- è¶…å‡ºæœ‰æ•ˆ Unicode èŒƒå›´çš„å€¼ä¼šå¯¼è‡´é”™è¯¯

## å­—ç¬¦ä¸² + Rune è¿æ¥

Rune å¯ä»¥ä¸å­—ç¬¦ä¸²è¿æ¥ï¼š

```hemlock
// å­—ç¬¦ä¸² + rune
let greeting = "Hello" + '!';       // "Hello!"
let decorated = "Text" + 'âœ“';       // "Textâœ“"

// Rune + å­—ç¬¦ä¸²
let prefix = '>' + " Message";      // "> Message"
let bullet = 'â€¢' + " Item";         // "â€¢ Item"

// å¤šé‡è¿æ¥
let msg = "Hi " + 'ğŸ‘‹' + " World " + 'ğŸŒ';  // "Hi ğŸ‘‹ World ğŸŒ"

// æ–¹æ³•é“¾å¯ä»¥ä½¿ç”¨
let result = ('>' + " Important").to_upper();  // "> IMPORTANT"
```

**å·¥ä½œåŸç†ï¼š**
- Rune è‡ªåŠ¨ç¼–ç ä¸º UTF-8
- åœ¨è¿æ¥è¿‡ç¨‹ä¸­è½¬æ¢ä¸ºå­—ç¬¦ä¸²
- å­—ç¬¦ä¸²è¿æ¥è¿ç®—ç¬¦é€æ˜åœ°å¤„ç†è¿™ä¸€ç‚¹

## ç±»å‹è½¬æ¢

Rune å¯ä»¥ä¸å…¶ä»–ç±»å‹ç›¸äº’è½¬æ¢ã€‚

### æ•´æ•° â†” Rune

åœ¨æ•´æ•°å’Œ rune ä¹‹é—´è½¬æ¢ä»¥å¤„ç†ç ç‚¹å€¼ï¼š

```hemlock
// æ•´æ•°åˆ° runeï¼ˆç ç‚¹å€¼ï¼‰
let code: rune = 65;            // 'A'ï¼ˆASCII 65ï¼‰
let emoji_code: rune = 128640;  // U+1F680ï¼ˆğŸš€ï¼‰

// Rune åˆ°æ•´æ•°ï¼ˆè·å–ç ç‚¹å€¼ï¼‰
let r = 'Z';
let value: i32 = r;             // 90ï¼ˆASCII å€¼ï¼‰

let rocket = 'ğŸš€';
let code: i32 = rocket;         // 128640ï¼ˆU+1F680ï¼‰
```

**èŒƒå›´æ£€æŸ¥ï¼š**
- æ•´æ•°åˆ° runeï¼šå¿…é¡»åœ¨ [0, 0x10FFFF] èŒƒå›´å†…
- è¶…å‡ºèŒƒå›´çš„å€¼ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
- Rune åˆ°æ•´æ•°ï¼šå§‹ç»ˆæˆåŠŸï¼ˆè¿”å›ç ç‚¹ï¼‰

### Rune â†’ å­—ç¬¦ä¸²

Rune å¯ä»¥æ˜¾å¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼š

```hemlock
// æ˜¾å¼è½¬æ¢
let ch: string = 'H';           // "H"
let emoji: string = 'ğŸš€';       // "ğŸš€"

// è¿æ¥æ—¶è‡ªåŠ¨è½¬æ¢
let s = "" + 'A';               // "A"
let s2 = "x" + 'y' + "z";       // "xyz"
```

### u8ï¼ˆå­—èŠ‚ï¼‰â†’ Rune

ä»»ä½• u8 å€¼ï¼ˆ0-255ï¼‰éƒ½å¯ä»¥è½¬æ¢ä¸º runeï¼š

```hemlock
// ASCII èŒƒå›´ï¼ˆ0-127ï¼‰
let byte: u8 = 65;
let rune_val: rune = byte;      // 'A'

// æ‰©å±• ASCII / Latin-1ï¼ˆ128-255ï¼‰
let extended: u8 = 200;
let r: rune = extended;         // U+00C8ï¼ˆÃˆï¼‰

// æ³¨æ„ï¼š0-127 æ˜¯ ASCIIï¼Œ128-255 æ˜¯ Latin-1
```

### é“¾å¼è½¬æ¢

ç±»å‹è½¬æ¢å¯ä»¥é“¾å¼è¿›è¡Œï¼š

```hemlock
// i32 â†’ rune â†’ string
let code: i32 = 128512;         // ç¬‘è„¸ç ç‚¹
let r: rune = code;             // ğŸ˜€
let s: string = r;              // "ğŸ˜€"

// åœ¨ä¸€ä¸ªè¡¨è¾¾å¼ä¸­å®Œæˆ
let emoji: string = 128640;     // éšå¼ i32 â†’ rune â†’ stringï¼ˆğŸš€ï¼‰
```

## Rune æ“ä½œ

### æ‰“å°

Rune çš„æ˜¾ç¤ºæ–¹å¼å–å†³äºç ç‚¹ï¼š

```hemlock
let ascii = 'A';
print(ascii);                   // 'A'ï¼ˆå¸¦å¼•å·ï¼Œå¯æ‰“å° ASCIIï¼‰

let emoji = 'ğŸš€';
print(emoji);                   // U+1F680ï¼ˆé ASCII çš„ Unicode è¡¨ç¤ºæ³•ï¼‰

let tab = '\t';
print(tab);                     // U+0009ï¼ˆä¸å¯æ‰“å°å­—ç¬¦ç”¨åå…­è¿›åˆ¶è¡¨ç¤ºï¼‰

let space = ' ';
print(space);                   // ' 'ï¼ˆå¯æ‰“å°ï¼‰
```

**æ‰“å°æ ¼å¼ï¼š**
- å¯æ‰“å° ASCIIï¼ˆ32-126ï¼‰ï¼šå¸¦å¼•å·çš„å­—ç¬¦ `'A'`
- ä¸å¯æ‰“å°æˆ– Unicodeï¼šåå…­è¿›åˆ¶è¡¨ç¤ºæ³• `U+XXXX`

### ç±»å‹æ£€æŸ¥

ä½¿ç”¨ `typeof()` æ£€æŸ¥å€¼æ˜¯å¦ä¸º runeï¼š

```hemlock
let r = 'ğŸš€';
print(typeof(r));               // "rune"

let s = "text";
let ch = s[0];
print(typeof(ch));              // "rune"ï¼ˆç´¢å¼•è¿”å› runeï¼‰

let num = 65;
print(typeof(num));             // "i32"
```

### æ¯”è¾ƒ

Rune å¯ä»¥è¿›è¡Œç›¸ç­‰æ€§æ¯”è¾ƒï¼š

```hemlock
let a = 'A';
let b = 'B';
print(a == a);                  // true
print(a == b);                  // false

// åŒºåˆ†å¤§å°å†™
let upper = 'A';
let lower = 'a';
print(upper == lower);          // false

// Rune å¯ä»¥ä¸æ•´æ•°æ¯”è¾ƒï¼ˆç ç‚¹å€¼ï¼‰
print(a == 65);                 // trueï¼ˆéšå¼è½¬æ¢ï¼‰
print('ğŸš€' == 128640);          // true
```

**æ¯”è¾ƒè¿ç®—ç¬¦ï¼š**
- `==` - ç›¸ç­‰
- `!=` - ä¸ç›¸ç­‰
- `<`ã€`>`ã€`<=`ã€`>=` - ç ç‚¹é¡ºåº

```hemlock
print('A' < 'B');               // trueï¼ˆ65 < 66ï¼‰
print('a' > 'Z');               // trueï¼ˆ97 > 90ï¼‰
```

## å¤„ç†å­—ç¬¦ä¸²ç´¢å¼•

å­—ç¬¦ä¸²ç´¢å¼•è¿”å› runeï¼Œè€Œä¸æ˜¯å­—èŠ‚ï¼š

```hemlock
let s = "HelloğŸš€";
let h = s[0];                   // 'H'ï¼ˆruneï¼‰
let rocket = s[5];              // 'ğŸš€'ï¼ˆruneï¼‰

print(typeof(h));               // "rune"
print(typeof(rocket));          // "rune"

// å¦‚æœéœ€è¦å¯è½¬æ¢ä¸ºå­—ç¬¦ä¸²
let h_str: string = h;          // "H"
let rocket_str: string = rocket; // "ğŸš€"
```

**é‡è¦ï¼š** å­—ç¬¦ä¸²ç´¢å¼•ä½¿ç”¨ç ç‚¹ä½ç½®ï¼Œè€Œä¸æ˜¯å­—èŠ‚åç§»ï¼š

```hemlock
let text = "HiğŸš€!";
// ç ç‚¹ä½ç½®ï¼š0='H', 1='i', 2='ğŸš€', 3='!'
// å­—èŠ‚ä½ç½®ï¼š0='H', 1='i', 2-5='ğŸš€', 6='!'

let r = text[2];                // 'ğŸš€'ï¼ˆç ç‚¹ 2ï¼‰
print(typeof(r));               // "rune"
```

## ç¤ºä¾‹

### ç¤ºä¾‹ï¼šå­—ç¬¦åˆ†ç±»

```hemlock
fn is_digit(r: rune): bool {
    return r >= '0' && r <= '9';
}

fn is_upper(r: rune): bool {
    return r >= 'A' && r <= 'Z';
}

fn is_lower(r: rune): bool {
    return r >= 'a' && r <= 'z';
}

print(is_digit('5'));           // true
print(is_upper('A'));           // true
print(is_lower('z'));           // true
```

### ç¤ºä¾‹ï¼šå¤§å°å†™è½¬æ¢

```hemlock
fn to_upper_rune(r: rune): rune {
    if (r >= 'a' && r <= 'z') {
        // è½¬æ¢ä¸ºå¤§å†™ï¼ˆå‡å» 32ï¼‰
        let code: i32 = r;
        code = code - 32;
        return code;
    }
    return r;
}

fn to_lower_rune(r: rune): rune {
    if (r >= 'A' && r <= 'Z') {
        // è½¬æ¢ä¸ºå°å†™ï¼ˆåŠ ä¸Š 32ï¼‰
        let code: i32 = r;
        code = code + 32;
        return code;
    }
    return r;
}

print(to_upper_rune('a'));      // 'A'
print(to_lower_rune('Z'));      // 'z'
```

### ç¤ºä¾‹ï¼šå­—ç¬¦è¿­ä»£

```hemlock
fn print_chars(s: string) {
    let i = 0;
    while (i < s.length) {
        let ch = s[i];
        print("Position " + typeof(i) + ": " + typeof(ch));
        i = i + 1;
    }
}

print_chars("HiğŸš€");
// Position 0: 'H'
// Position 1: 'i'
// Position 2: U+1F680
```

### ç¤ºä¾‹ï¼šä» Rune æ„å»ºå­—ç¬¦ä¸²

```hemlock
fn repeat_char(ch: rune, count: i32): string {
    let result = "";
    let i = 0;
    while (i < count) {
        result = result + ch;
        i = i + 1;
    }
    return result;
}

let line = repeat_char('=', 40);  // "========================================"
let stars = repeat_char('â­', 5);  // "â­â­â­â­â­"
```

## å¸¸è§æ¨¡å¼

### æ¨¡å¼ï¼šå­—ç¬¦è¿‡æ»¤

```hemlock
fn filter_digits(s: string): string {
    let result = "";
    let i = 0;
    while (i < s.length) {
        let ch = s[i];
        if (ch >= '0' && ch <= '9') {
            result = result + ch;
        }
        i = i + 1;
    }
    return result;
}

let text = "abc123def456";
let digits = filter_digits(text);  // "123456"
```

### æ¨¡å¼ï¼šå­—ç¬¦è®¡æ•°

```hemlock
fn count_char(s: string, target: rune): i32 {
    let count = 0;
    let i = 0;
    while (i < s.length) {
        if (s[i] == target) {
            count = count + 1;
        }
        i = i + 1;
    }
    return count;
}

let text = "hello world";
let l_count = count_char(text, 'l');  // 3
let o_count = count_char(text, 'o');  // 2
```

## æœ€ä½³å®è·µ

1. **å¯¹å­—ç¬¦æ“ä½œä½¿ç”¨ rune** - ä¸è¦å°è¯•ç”¨å­—èŠ‚å¤„ç†æ–‡æœ¬
2. **å­—ç¬¦ä¸²ç´¢å¼•è¿”å› rune** - è®°ä½ `str[i]` ç»™ä½ çš„æ˜¯ rune
3. **Unicode æ„ŸçŸ¥çš„æ¯”è¾ƒ** - Rune å¯ä»¥å¤„ç†ä»»ä½• Unicode å­—ç¬¦
4. **éœ€è¦æ—¶è¿›è¡Œè½¬æ¢** - Rune å¯ä»¥è½»æ¾è½¬æ¢ä¸ºå­—ç¬¦ä¸²å’Œæ•´æ•°
5. **ç”¨è¡¨æƒ…ç¬¦å·æµ‹è¯•** - å§‹ç»ˆç”¨å¤šå­—èŠ‚å­—ç¬¦æµ‹è¯•å­—ç¬¦æ“ä½œ

## å¸¸è§é™·é˜±

### é™·é˜±ï¼šRune ä¸å­—èŠ‚æ··æ·†

```hemlock
// ä¸è¦ï¼šå°† rune å½“ä½œå­—èŠ‚
let r: rune = 'ğŸš€';
let b: u8 = r;              // é”™è¯¯ï¼šRune ç ç‚¹ 128640 æ— æ³•æ”¾å…¥ u8

// è¦ï¼šä½¿ç”¨é€‚å½“çš„è½¬æ¢
let r: rune = 'ğŸš€';
let code: i32 = r;          // å¯ä»¥ï¼š128640
```

### é™·é˜±ï¼šå­—ç¬¦ä¸²å­—èŠ‚ç´¢å¼•

```hemlock
// ä¸è¦ï¼šå‡è®¾å­—èŠ‚ç´¢å¼•
let s = "ğŸš€";
let byte = s.byte_at(0);    // 240ï¼ˆç¬¬ä¸€ä¸ª UTF-8 å­—èŠ‚ï¼Œä¸æ˜¯å®Œæ•´å­—ç¬¦ï¼‰

// è¦ï¼šä½¿ç”¨ç ç‚¹ç´¢å¼•
let s = "ğŸš€";
let rune = s[0];            // 'ğŸš€'ï¼ˆå®Œæ•´å­—ç¬¦ï¼‰
let rune2 = s.char_at(0);   // 'ğŸš€'ï¼ˆæ˜¾å¼æ–¹æ³•ï¼‰
```

## ç›¸å…³ä¸»é¢˜

- [å­—ç¬¦ä¸²](#language-guide-strings) - å­—ç¬¦ä¸²æ“ä½œå’Œ UTF-8 å¤„ç†
- [ç±»å‹](#language-guide-types) - ç±»å‹ç³»ç»Ÿå’Œè½¬æ¢
- [æ§åˆ¶æµ](#language-guide-control-flow) - åœ¨æ¯”è¾ƒä¸­ä½¿ç”¨ rune

## å¦è¯·å‚é˜…

- **Unicode æ ‡å‡†**ï¼šUnicode ç ç‚¹ç”± Unicode è”ç›Ÿå®šä¹‰
- **UTF-8 ç¼–ç **ï¼šæœ‰å…³ UTF-8 è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[å­—ç¬¦ä¸²](#language-guide-strings)
- **ç±»å‹è½¬æ¢**ï¼šæœ‰å…³è½¬æ¢è§„åˆ™ï¼Œè¯·å‚é˜…[ç±»å‹](#language-guide-types)


--------------------------------------------------------------------------------
## å­—ç¬¦ä¸²
--------------------------------------------------------------------------------

# å­—ç¬¦ä¸²

Hemlock å­—ç¬¦ä¸²æ˜¯**UTF-8 ä¼˜å…ˆçš„å¯å˜åºåˆ—**ï¼Œå…·æœ‰å®Œæ•´çš„ Unicode æ”¯æŒå’Œä¸°å¯Œçš„æ–‡æœ¬å¤„ç†æ–¹æ³•ã€‚ä¸è®¸å¤šè¯­è¨€ä¸åŒï¼ŒHemlock å­—ç¬¦ä¸²æ˜¯å¯å˜çš„ï¼Œå¹¶ä¸”åŸç”Ÿæ”¯æŒ Unicode ç ç‚¹æ“ä½œã€‚

## æ¦‚è¿°

```hemlock
let s = "hello";
s[0] = 'H';             // ä½¿ç”¨ rune ä¿®æ”¹ï¼ˆç°åœ¨æ˜¯ "Hello"ï¼‰
print(s.length);        // 5ï¼ˆç ç‚¹æ•°é‡ï¼‰
let c = s[0];           // è¿”å› runeï¼ˆUnicode ç ç‚¹ï¼‰
let msg = s + " world"; // è¿æ¥
let emoji = "ğŸš€";
print(emoji.length);    // 1ï¼ˆä¸€ä¸ªç ç‚¹ï¼‰
print(emoji.byte_length); // 4ï¼ˆå››ä¸ª UTF-8 å­—èŠ‚ï¼‰
```

## å±æ€§

Hemlock å­—ç¬¦ä¸²å…·æœ‰ä»¥ä¸‹å…³é”®ç‰¹æ€§ï¼š

- **UTF-8 ç¼–ç ** - å®Œæ•´çš„ Unicode æ”¯æŒï¼ˆU+0000 åˆ° U+10FFFFï¼‰
- **å¯å˜** - ä¸ Pythonã€JavaScript å’Œ Java çš„å­—ç¬¦ä¸²ä¸åŒ
- **åŸºäºç ç‚¹çš„ç´¢å¼•** - è¿”å› `rune`ï¼ˆUnicode ç ç‚¹ï¼‰ï¼Œè€Œéå­—èŠ‚
- **å †åˆ†é…** - å¸¦æœ‰å†…éƒ¨å®¹é‡è·Ÿè¸ª
- **ä¸¤ä¸ªé•¿åº¦å±æ€§**ï¼š
  - `.length` - ç ç‚¹æ•°é‡ï¼ˆå­—ç¬¦æ•°ï¼‰
  - `.byte_length` - å­—èŠ‚æ•°é‡ï¼ˆUTF-8 ç¼–ç å¤§å°ï¼‰

## UTF-8 è¡Œä¸º

æ‰€æœ‰å­—ç¬¦ä¸²æ“ä½œéƒ½ä½¿ç”¨**ç ç‚¹**ï¼ˆå­—ç¬¦ï¼‰ï¼Œè€Œéå­—èŠ‚ï¼š

```hemlock
let text = "HelloğŸš€World";
print(text.length);        // 11ï¼ˆç ç‚¹ï¼‰
print(text.byte_length);   // 15ï¼ˆå­—èŠ‚ï¼Œemoji æ˜¯ 4 å­—èŠ‚ï¼‰

// ç´¢å¼•ä½¿ç”¨ç ç‚¹
let h = text[0];           // 'H'ï¼ˆruneï¼‰
let rocket = text[5];      // 'ğŸš€'ï¼ˆruneï¼‰
```

**å¤šå­—èŠ‚å­—ç¬¦è®¡ä¸ºä¸€ä¸ªï¼š**
```hemlock
"Hello".length;      // 5
"ğŸš€".length;         // 1ï¼ˆä¸€ä¸ª emojiï¼‰
"ä½ å¥½".length;       // 2ï¼ˆä¸¤ä¸ªä¸­æ–‡å­—ç¬¦ï¼‰
"cafÃ©".length;       // 4ï¼ˆÃ© æ˜¯ä¸€ä¸ªç ç‚¹ï¼‰
```

## å­—ç¬¦ä¸²å­—é¢é‡

```hemlock
// åŸºæœ¬å­—ç¬¦ä¸²
let s1 = "hello";
let s2 = "world";

// å¸¦æœ‰è½¬ä¹‰åºåˆ—
let s3 = "Line 1\nLine 2\ttabbed";
let s4 = "Quote: \"Hello\"";
let s5 = "Backslash: \\";

// Unicode å­—ç¬¦
let s6 = "ğŸš€ Emoji";
let s7 = "ä¸­æ–‡å­—ç¬¦";
```

## æ¨¡æ¿å­—ç¬¦ä¸²ï¼ˆå­—ç¬¦ä¸²æ’å€¼ï¼‰

ä½¿ç”¨åå¼•å·åˆ›å»ºå¸¦æœ‰åµŒå…¥è¡¨è¾¾å¼çš„æ¨¡æ¿å­—ç¬¦ä¸²ï¼š

```hemlock
let name = "Alice";
let age = 30;

// åŸºæœ¬æ’å€¼
let greeting = `Hello, ${name}!`;           // "Hello, Alice!"
let info = `${name} is ${age} years old`;   // "Alice is 30 years old"

// æ’å€¼ä¸­çš„è¡¨è¾¾å¼
let x = 5;
let y = 10;
let sum = `${x} + ${y} = ${x + y}`;         // "5 + 10 = 15"

// æ–¹æ³•è°ƒç”¨
let upper = `Name: ${name.to_upper()}`;     // "Name: ALICE"

// åµŒå¥—å¯¹è±¡
let person = { name: "Bob", city: "NYC" };
let desc = `${person.name} lives in ${person.city}`;  // "Bob lives in NYC"

// å¤šè¡Œï¼ˆä¿ç•™æ¢è¡Œç¬¦ï¼‰
let multi = `Line 1
Line 2
Line 3`;
```

**æ¨¡æ¿å­—ç¬¦ä¸²ç‰¹æ€§ï¼š**
- `${...}` å†…çš„è¡¨è¾¾å¼ä¼šè¢«æ±‚å€¼å¹¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²
- å¯ä»¥ä½¿ç”¨ä»»ä½•æœ‰æ•ˆè¡¨è¾¾å¼ï¼ˆå˜é‡ã€å‡½æ•°è°ƒç”¨ã€ç®—æœ¯è¿ç®—ï¼‰
- åå¼•å·å­—ç¬¦ä¸²æ”¯æŒä¸æ™®é€šå­—ç¬¦ä¸²ç›¸åŒçš„è½¬ä¹‰åºåˆ—
- ç”¨äºæ„å»ºåŠ¨æ€å­—ç¬¦ä¸²è€Œæ— éœ€è¿æ¥æ“ä½œ

### æ¨¡æ¿å­—ç¬¦ä¸²ä¸­çš„è½¬ä¹‰

è¦åœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­åŒ…å«å­—é¢é‡ `${`ï¼Œè¯·è½¬ä¹‰ç¾å…ƒç¬¦å·ï¼š

```hemlock
let price = 100;
let text = `Price: \${price} or ${price}`;
// "Price: ${price} or 100"

// å­—é¢é‡åå¼•å·
let code = `Use \` for template strings`;
// "Use ` for template strings"
```

### å¤æ‚è¡¨è¾¾å¼

æ¨¡æ¿å­—ç¬¦ä¸²å¯ä»¥åŒ…å«ä»»ä½•æœ‰æ•ˆè¡¨è¾¾å¼ï¼š

```hemlock
// ç±»ä¸‰å…ƒè¡¨è¾¾å¼
let age = 25;
let status = `Status: ${age >= 18 ? "adult" : "minor"}`;

// æ•°ç»„è®¿é—®
let items = ["apple", "banana", "cherry"];
let first = `First item: ${items[0]}`;

// å¸¦å‚æ•°çš„å‡½æ•°è°ƒç”¨
fn format_price(p) { return "$" + p; }
let msg = `Total: ${format_price(99.99)}`;  // "Total: $99.99"

// é“¾å¼æ–¹æ³•è°ƒç”¨
let name = "alice";
let formatted = `Hello, ${name.to_upper().slice(0, 1)}${name.slice(1)}!`;
// "Hello, Alice!"
```

### æ¨¡æ¿å­—ç¬¦ä¸²ä¸è¿æ¥å¯¹æ¯”

æ¨¡æ¿å­—ç¬¦ä¸²é€šå¸¸æ¯”è¿æ¥æ›´æ¸…æ™°ï¼š

```hemlock
// è¿æ¥ï¼ˆè¾ƒéš¾é˜…è¯»ï¼‰
let msg1 = "Hello, " + name + "! You have " + count + " messages.";

// æ¨¡æ¿å­—ç¬¦ä¸²ï¼ˆæ›´æ˜“é˜…è¯»ï¼‰
let msg2 = `Hello, ${name}! You have ${count} messages.`;
```

## ç´¢å¼•å’Œä¿®æ”¹

### è¯»å–å­—ç¬¦

ç´¢å¼•è¿”å› `rune`ï¼ˆUnicode ç ç‚¹ï¼‰ï¼š

```hemlock
let s = "Hello";
let first = s[0];      // 'H'ï¼ˆruneï¼‰
let last = s[4];       // 'o'ï¼ˆruneï¼‰

// UTF-8 ç¤ºä¾‹
let emoji = "HiğŸš€!";
let rocket = emoji[2];  // 'ğŸš€'ï¼ˆç ç‚¹ç´¢å¼• 2 å¤„çš„ runeï¼‰
```

### å†™å…¥å­—ç¬¦

å­—ç¬¦ä¸²æ˜¯å¯å˜çš„ - å¯ä»¥ä¿®æ”¹å•ä¸ªå­—ç¬¦ï¼š

```hemlock
let s = "hello";
s[0] = 'H';            // ç°åœ¨æ˜¯ "Hello"
s[4] = '!';            // ç°åœ¨æ˜¯ "Hell!"

// Unicode ç¤ºä¾‹
let msg = "Go!";
msg[0] = 'ğŸš€';         // ç°åœ¨æ˜¯ "ğŸš€o!"
```

## è¿æ¥

ä½¿ç”¨ `+` è¿æ¥å­—ç¬¦ä¸²ï¼š

```hemlock
let greeting = "Hello" + " " + "World";  // "Hello World"

// ä½¿ç”¨å˜é‡
let name = "Alice";
let msg = "Hi, " + name + "!";  // "Hi, Alice!"

// ä½¿ç”¨ runeï¼ˆå‚è§ Runes æ–‡æ¡£ï¼‰
let s = "Hello" + '!';          // "Hello!"
```

## å­—ç¬¦ä¸²æ–¹æ³•

Hemlock æä¾› 19 ä¸ªå­—ç¬¦ä¸²æ–¹æ³•ç”¨äºå…¨é¢çš„æ–‡æœ¬æ“ä½œã€‚

### å­å­—ç¬¦ä¸²å’Œåˆ‡ç‰‡

**`substr(start, length)`** - æŒ‰ä½ç½®å’Œé•¿åº¦æå–å­å­—ç¬¦ä¸²ï¼š
```hemlock
let s = "hello world";
let sub = s.substr(6, 5);       // "world"ï¼ˆä» 6 å¼€å§‹ï¼Œé•¿åº¦ 5ï¼‰
let first = s.substr(0, 5);     // "hello"

// UTF-8 ç¤ºä¾‹
let text = "HiğŸš€!";
let emoji = text.substr(2, 1);  // "ğŸš€"ï¼ˆä½ç½® 2ï¼Œé•¿åº¦ 1ï¼‰
```

**`slice(start, end)`** - æŒ‰èŒƒå›´æå–å­å­—ç¬¦ä¸²ï¼ˆend ä¸åŒ…å«åœ¨å†…ï¼‰ï¼š
```hemlock
let s = "hello world";
let slice = s.slice(0, 5);      // "hello"ï¼ˆç´¢å¼• 0 åˆ° 4ï¼‰
let slice2 = s.slice(6, 11);    // "world"
```

**åŒºåˆ«ï¼š**
- `substr(start, length)` - ä½¿ç”¨é•¿åº¦å‚æ•°
- `slice(start, end)` - ä½¿ç”¨ç»“æŸç´¢å¼•ï¼ˆä¸åŒ…å«ï¼‰

### æœç´¢å’ŒæŸ¥æ‰¾

**`find(needle)`** - æŸ¥æ‰¾é¦–æ¬¡å‡ºç°çš„ä½ç½®ï¼š
```hemlock
let s = "hello world";
let pos = s.find("world");      // 6ï¼ˆé¦–æ¬¡å‡ºç°çš„ç´¢å¼•ï¼‰
let pos2 = s.find("foo");       // -1ï¼ˆæœªæ‰¾åˆ°ï¼‰
let pos3 = s.find("l");         // 2ï¼ˆç¬¬ä¸€ä¸ª 'l'ï¼‰
```

**`contains(needle)`** - æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«å­å­—ç¬¦ä¸²ï¼š
```hemlock
let s = "hello world";
let has = s.contains("world");  // true
let has2 = s.contains("foo");   // false
```

### åˆ†å‰²å’Œä¿®å‰ª

**`split(delimiter)`** - åˆ†å‰²æˆå­—ç¬¦ä¸²æ•°ç»„ï¼š
```hemlock
let csv = "apple,banana,cherry";
let parts = csv.split(",");     // ["apple", "banana", "cherry"]

let words = "one two three".split(" ");  // ["one", "two", "three"]

// ç©ºåˆ†éš”ç¬¦æŒ‰å­—ç¬¦åˆ†å‰²
let chars = "abc".split("");    // ["a", "b", "c"]
```

**`trim()`** - ç§»é™¤å‰åç©ºç™½ï¼š
```hemlock
let s = "  hello  ";
let clean = s.trim();           // "hello"

let s2 = "\t\ntext\n\t";
let clean2 = s2.trim();         // "text"
```

### å¤§å°å†™è½¬æ¢

**`to_upper()`** - è½¬æ¢ä¸ºå¤§å†™ï¼š
```hemlock
let s = "hello world";
let upper = s.to_upper();       // "HELLO WORLD"

// ä¿ç•™é ASCII å­—ç¬¦
let s2 = "cafÃ©";
let upper2 = s2.to_upper();     // "CAFÃ‰"
```

**`to_lower()`** - è½¬æ¢ä¸ºå°å†™ï¼š
```hemlock
let s = "HELLO WORLD";
let lower = s.to_lower();       // "hello world"
```

### å‰ç¼€/åç¼€æ£€æŸ¥

**`starts_with(prefix)`** - æ£€æŸ¥æ˜¯å¦ä»¥å‰ç¼€å¼€å¤´ï¼š
```hemlock
let s = "hello world";
let starts = s.starts_with("hello");  // true
let starts2 = s.starts_with("world"); // false
```

**`ends_with(suffix)`** - æ£€æŸ¥æ˜¯å¦ä»¥åç¼€ç»“å°¾ï¼š
```hemlock
let s = "hello world";
let ends = s.ends_with("world");      // true
let ends2 = s.ends_with("hello");     // false
```

### æ›¿æ¢

**`replace(old, new)`** - æ›¿æ¢é¦–æ¬¡å‡ºç°ï¼š
```hemlock
let s = "hello world";
let s2 = s.replace("world", "there");      // "hello there"

let s3 = "foo foo foo";
let s4 = s3.replace("foo", "bar");         // "bar foo foo"ï¼ˆä»…ç¬¬ä¸€ä¸ªï¼‰
```

**`replace_all(old, new)`** - æ›¿æ¢æ‰€æœ‰å‡ºç°ï¼š
```hemlock
let s = "foo foo foo";
let s2 = s.replace_all("foo", "bar");      // "bar bar bar"

let s3 = "hello world, world!";
let s4 = s3.replace_all("world", "hemlock"); // "hello hemlock, hemlock!"
```

### é‡å¤

**`repeat(count)`** - é‡å¤å­—ç¬¦ä¸² n æ¬¡ï¼š
```hemlock
let s = "ha";
let laugh = s.repeat(3);        // "hahaha"

let line = "=".repeat(40);      // "========================================"
```

### å­—ç¬¦å’Œå­—èŠ‚è®¿é—®

**`char_at(index)`** - è·å–æŒ‡å®šç´¢å¼•å¤„çš„ Unicode ç ç‚¹ï¼ˆè¿”å› runeï¼‰ï¼š
```hemlock
let s = "hello";
let char = s.char_at(0);        // 'h'ï¼ˆruneï¼‰

// UTF-8 ç¤ºä¾‹
let emoji = "ğŸš€";
let rocket = emoji.char_at(0);  // è¿”å› rune U+1F680
```

**`chars()`** - è½¬æ¢ä¸º rune æ•°ç»„ï¼ˆç ç‚¹ï¼‰ï¼š
```hemlock
let s = "hello";
let chars = s.chars();          // ['h', 'e', 'l', 'l', 'o']ï¼ˆrune æ•°ç»„ï¼‰

// UTF-8 ç¤ºä¾‹
let text = "HiğŸš€";
let chars2 = text.chars();      // ['H', 'i', 'ğŸš€']
```

**`byte_at(index)`** - è·å–æŒ‡å®šç´¢å¼•å¤„çš„å­—èŠ‚å€¼ï¼ˆè¿”å› u8ï¼‰ï¼š
```hemlock
let s = "hello";
let byte = s.byte_at(0);        // 104ï¼ˆ'h' çš„ ASCII å€¼ï¼‰

// UTF-8 ç¤ºä¾‹
let emoji = "ğŸš€";
let first_byte = emoji.byte_at(0);  // 240ï¼ˆç¬¬ä¸€ä¸ª UTF-8 å­—èŠ‚ï¼‰
```

**`bytes()`** - è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ï¼ˆu8 å€¼ï¼‰ï¼š
```hemlock
let s = "hello";
let bytes = s.bytes();          // [104, 101, 108, 108, 111]ï¼ˆu8 æ•°ç»„ï¼‰

// UTF-8 ç¤ºä¾‹
let emoji = "ğŸš€";
let bytes2 = emoji.bytes();     // [240, 159, 154, 128]ï¼ˆ4 ä¸ª UTF-8 å­—èŠ‚ï¼‰
```

**`to_bytes()`** - è½¬æ¢ä¸º buffer ä»¥è¿›è¡Œåº•å±‚è®¿é—®ï¼š
```hemlock
let s = "hello";
let buf = s.to_bytes();         // è¿”å›åŒ…å« UTF-8 å­—èŠ‚çš„ buffer
print(buf.length);              // 5
free(buf);                      // è®°å¾—é‡Šæ”¾
```

## æ–¹æ³•é“¾å¼è°ƒç”¨

æ‰€æœ‰å­—ç¬¦ä¸²æ–¹æ³•éƒ½è¿”å›æ–°å­—ç¬¦ä¸²ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ï¼š

```hemlock
let result = "  Hello World  "
    .trim()
    .to_lower()
    .replace("world", "hemlock");  // "hello hemlock"

let processed = "foo,bar,baz"
    .split(",")
    .join(" | ")
    .to_upper();                    // "FOO | BAR | BAZ"
```

## å®Œæ•´æ–¹æ³•å‚è€ƒ

| æ–¹æ³• | å‚æ•° | è¿”å›å€¼ | æè¿° |
|--------|-----------|---------|-------------|
| `substr(start, length)` | i32, i32 | string | æŒ‰ä½ç½®å’Œé•¿åº¦æå–å­å­—ç¬¦ä¸² |
| `slice(start, end)` | i32, i32 | string | æŒ‰èŒƒå›´æå–å­å­—ç¬¦ä¸²ï¼ˆend ä¸åŒ…å«åœ¨å†…ï¼‰ |
| `find(needle)` | string | i32 | æŸ¥æ‰¾é¦–æ¬¡å‡ºç°çš„ä½ç½®ï¼ˆæœªæ‰¾åˆ°è¿”å› -1ï¼‰ |
| `contains(needle)` | string | bool | æ£€æŸ¥æ˜¯å¦åŒ…å«å­å­—ç¬¦ä¸² |
| `split(delimiter)` | string | array | åˆ†å‰²æˆå­—ç¬¦ä¸²æ•°ç»„ |
| `trim()` | - | string | ç§»é™¤å‰åç©ºç™½ |
| `to_upper()` | - | string | è½¬æ¢ä¸ºå¤§å†™ |
| `to_lower()` | - | string | è½¬æ¢ä¸ºå°å†™ |
| `starts_with(prefix)` | string | bool | æ£€æŸ¥æ˜¯å¦ä»¥å‰ç¼€å¼€å¤´ |
| `ends_with(suffix)` | string | bool | æ£€æŸ¥æ˜¯å¦ä»¥åç¼€ç»“å°¾ |
| `replace(old, new)` | string, string | string | æ›¿æ¢é¦–æ¬¡å‡ºç° |
| `replace_all(old, new)` | string, string | string | æ›¿æ¢æ‰€æœ‰å‡ºç° |
| `repeat(count)` | i32 | string | é‡å¤å­—ç¬¦ä¸² n æ¬¡ |
| `char_at(index)` | i32 | rune | è·å–æŒ‡å®šç´¢å¼•å¤„çš„ç ç‚¹ |
| `byte_at(index)` | i32 | u8 | è·å–æŒ‡å®šç´¢å¼•å¤„çš„å­—èŠ‚å€¼ |
| `chars()` | - | array | è½¬æ¢ä¸º rune æ•°ç»„ |
| `bytes()` | - | array | è½¬æ¢ä¸º u8 å­—èŠ‚æ•°ç»„ |
| `to_bytes()` | - | buffer | è½¬æ¢ä¸º bufferï¼ˆéœ€è¦é‡Šæ”¾ï¼‰ |

## ç¤ºä¾‹

### ç¤ºä¾‹ï¼šæ–‡æœ¬å¤„ç†

```hemlock
fn process_input(text: string): string {
    return text
        .trim()
        .to_lower()
        .replace_all("  ", " ");  // è§„èŒƒåŒ–ç©ºç™½
}

let input = "  HELLO   WORLD  ";
let clean = process_input(input);  // "hello world"
```

### ç¤ºä¾‹ï¼šCSV è§£æå™¨

```hemlock
fn parse_csv_line(line: string): array {
    let trimmed = line.trim();
    let fields = trimmed.split(",");

    let result = [];
    let i = 0;
    while (i < fields.length) {
        result.push(fields[i].trim());
        i = i + 1;
    }

    return result;
}

let csv = "apple, banana , cherry";
let fields = parse_csv_line(csv);  // ["apple", "banana", "cherry"]
```

### ç¤ºä¾‹ï¼šå•è¯è®¡æ•°å™¨

```hemlock
fn count_words(text: string): i32 {
    let words = text.trim().split(" ");
    return words.length;
}

let sentence = "The quick brown fox";
let count = count_words(sentence);  // 4
```

### ç¤ºä¾‹ï¼šå­—ç¬¦ä¸²éªŒè¯

```hemlock
fn is_valid_email(email: string): bool {
    if (!email.contains("@")) {
        return false;
    }

    if (!email.contains(".")) {
        return false;
    }

    if (email.starts_with("@") || email.ends_with("@")) {
        return false;
    }

    return true;
}

print(is_valid_email("user@example.com"));  // true
print(is_valid_email("invalid"));            // false
```

## å†…å­˜ç®¡ç†

å­—ç¬¦ä¸²æ˜¯å †åˆ†é…çš„ï¼Œå¸¦æœ‰å†…éƒ¨å¼•ç”¨è®¡æ•°ï¼š

- **åˆ›å»º**ï¼šåœ¨å †ä¸Šåˆ†é…ï¼Œå¸¦æœ‰å®¹é‡è·Ÿè¸ª
- **è¿æ¥**ï¼šåˆ›å»ºæ–°å­—ç¬¦ä¸²ï¼ˆæ—§å­—ç¬¦ä¸²ä¸å˜ï¼‰
- **æ–¹æ³•**ï¼šå¤§å¤šæ•°æ–¹æ³•è¿”å›æ–°å­—ç¬¦ä¸²
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šå­—ç¬¦ä¸²ä½¿ç”¨å¼•ç”¨è®¡æ•°ï¼Œä½œç”¨åŸŸé€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾

**è‡ªåŠ¨æ¸…ç†ï¼š**
```hemlock
fn create_strings() {
    let s = "hello";
    let s2 = s + " world";  // æ–°åˆ†é…
}  // å‡½æ•°è¿”å›æ—¶ s å’Œ s2 éƒ½è‡ªåŠ¨é‡Šæ”¾
```

**æ³¨æ„ï¼š** å±€éƒ¨å­—ç¬¦ä¸²å˜é‡åœ¨è¶…å‡ºä½œç”¨åŸŸæ—¶è‡ªåŠ¨æ¸…ç†ã€‚ä»…åœ¨éœ€è¦æå‰æ¸…ç†ï¼ˆä½œç”¨åŸŸç»“æŸå‰ï¼‰æˆ–å¤„ç†é•¿æœŸå­˜æ´»/å…¨å±€æ•°æ®æ—¶ä½¿ç”¨ `free()`ã€‚è¯¦è§ [å†…å­˜ç®¡ç†](memory.md#internal-reference-counting)ã€‚

## æœ€ä½³å®è·µ

1. **ä½¿ç”¨ç ç‚¹ç´¢å¼•** - å­—ç¬¦ä¸²ä½¿ç”¨ç ç‚¹ä½ç½®ï¼Œè€Œéå­—èŠ‚åç§»
2. **ä½¿ç”¨ Unicode æµ‹è¯•** - å§‹ç»ˆä½¿ç”¨å¤šå­—èŠ‚å­—ç¬¦æµ‹è¯•å­—ç¬¦ä¸²æ“ä½œ
3. **ä¼˜å…ˆä½¿ç”¨ä¸å¯å˜æ“ä½œ** - ä½¿ç”¨è¿”å›æ–°å­—ç¬¦ä¸²çš„æ–¹æ³•ï¼Œè€Œéç›´æ¥ä¿®æ”¹
4. **æ£€æŸ¥è¾¹ç•Œ** - å­—ç¬¦ä¸²ç´¢å¼•ä¸è¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼ˆæ— æ•ˆæ—¶è¿”å› null/é”™è¯¯ï¼‰
5. **è§„èŒƒåŒ–è¾“å…¥** - å¯¹ç”¨æˆ·è¾“å…¥ä½¿ç”¨ `trim()` å’Œ `to_lower()`

## å¸¸è§é™·é˜±

### é™·é˜±ï¼šå­—èŠ‚ä¸ç ç‚¹æ··æ·†

```hemlock
let emoji = "ğŸš€";
print(emoji.length);        // 1ï¼ˆç ç‚¹ï¼‰
print(emoji.byte_length);   // 4ï¼ˆå­—èŠ‚ï¼‰

// ä¸è¦æ··ç”¨å­—èŠ‚å’Œç ç‚¹æ“ä½œ
let byte = emoji.byte_at(0);  // 240ï¼ˆç¬¬ä¸€ä¸ªå­—èŠ‚ï¼‰
let char = emoji.char_at(0);  // 'ğŸš€'ï¼ˆå®Œæ•´ç ç‚¹ï¼‰
```

### é™·é˜±ï¼šä¿®æ”¹çš„æ„å¤–æƒ…å†µ

```hemlock
let s1 = "hello";
let s2 = s1;       // æµ…æ‹·è´
s1[0] = 'H';       // ä¿®æ”¹ s1
print(s2);         // ä»ç„¶æ˜¯ "hello"ï¼ˆå­—ç¬¦ä¸²æ˜¯å€¼ç±»å‹ï¼‰
```

## ç›¸å…³ä¸»é¢˜

- [Runes](#language-guide-runes) - å­—ç¬¦ä¸²ç´¢å¼•ä¸­ä½¿ç”¨çš„ Unicode ç ç‚¹ç±»å‹
- [æ•°ç»„](#language-guide-arrays) - å­—ç¬¦ä¸²æ–¹æ³•ç»å¸¸è¿”å›æˆ–ä½¿ç”¨æ•°ç»„
- [ç±»å‹](#language-guide-types) - å­—ç¬¦ä¸²ç±»å‹è¯¦æƒ…å’Œè½¬æ¢

## å¦è¯·å‚é˜…

- **UTF-8 ç¼–ç **ï¼šå‚è§ CLAUDE.md ä¸­çš„ "Strings" éƒ¨åˆ†
- **ç±»å‹è½¬æ¢**ï¼šå‚è§ [ç±»å‹](#language-guide-types) äº†è§£å­—ç¬¦ä¸²è½¬æ¢
- **å†…å­˜**ï¼šå‚è§ [å†…å­˜](#language-guide-memory) äº†è§£å­—ç¬¦ä¸²åˆ†é…ç»†èŠ‚


--------------------------------------------------------------------------------
## å¯¹è±¡
--------------------------------------------------------------------------------

# å¯¹è±¡

Hemlock å®ç°äº† JavaScript é£æ ¼çš„å¯¹è±¡ï¼Œå…·æœ‰å †åˆ†é…ã€åŠ¨æ€å­—æ®µã€æ–¹æ³•å’Œé¸­å­ç±»å‹ã€‚å¯¹è±¡æ˜¯ç»“åˆæ•°æ®å’Œè¡Œä¸ºçš„çµæ´»æ•°æ®ç»“æ„ã€‚

## æ¦‚è¿°

```hemlock
// åŒ¿åå¯¹è±¡
let person = { name: "Alice", age: 30, city: "NYC" };
print(person.name);  // "Alice"

// å¸¦æ–¹æ³•çš„å¯¹è±¡
let counter = {
    count: 0,
    increment: fn() {
        self.count = self.count + 1;
    }
};

counter.increment();
print(counter.count);  // 1
```

## å¯¹è±¡å­—é¢é‡

### åŸºæœ¬è¯­æ³•

```hemlock
let person = {
    name: "Alice",
    age: 30,
    city: "NYC"
};
```

**è¯­æ³•ï¼š**
- èŠ±æ‹¬å· `{}` åŒ…å›´å¯¹è±¡
- é”®å€¼å¯¹ç”¨é€—å·åˆ†éš”
- é”®æ˜¯æ ‡è¯†ç¬¦ï¼ˆä¸éœ€è¦å¼•å·ï¼‰
- å€¼å¯ä»¥æ˜¯ä»»ä½•ç±»å‹

### ç©ºå¯¹è±¡

```hemlock
let obj = {};  // ç©ºå¯¹è±¡

// ç¨åæ·»åŠ å­—æ®µ
obj.name = "Alice";
obj.age = 30;
```

### åµŒå¥—å¯¹è±¡

```hemlock
let user = {
    info: {
        name: "Bob",
        age: 25
    },
    active: true,
    settings: {
        theme: "dark",
        notifications: true
    }
};

print(user.info.name);           // "Bob"
print(user.settings.theme);      // "dark"
```

### æ··åˆå€¼ç±»å‹

```hemlock
let mixed = {
    number: 42,
    text: "hello",
    flag: true,
    data: null,
    items: [1, 2, 3],
    config: { x: 10, y: 20 }
};
```

### ç®€å†™å±æ€§è¯­æ³•

å½“å˜é‡åä¸å±æ€§ååŒ¹é…æ—¶ï¼Œä½¿ç”¨ç®€å†™è¯­æ³•ï¼š

```hemlock
let name = "Alice";
let age = 30;
let active = true;

// ç®€å†™ï¼š{ name } ç­‰åŒäº { name: name }
let person = { name, age, active };

print(person.name);   // "Alice"
print(person.age);    // 30
print(person.active); // true
```

**æ··åˆç®€å†™å’Œå¸¸è§„å±æ€§ï¼š**
```hemlock
let city = "NYC";
let obj = { name, age, city, role: "admin" };
```

### å±•å¼€è¿ç®—ç¬¦

å±•å¼€è¿ç®—ç¬¦ï¼ˆ`...`ï¼‰å°†ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å­—æ®µå¤åˆ¶åˆ°å¦ä¸€ä¸ªå¯¹è±¡ä¸­ï¼š

```hemlock
let base = { x: 1, y: 2 };
let extended = { ...base, z: 3 };

print(extended.x);  // 1
print(extended.y);  // 2
print(extended.z);  // 3
```

**ä½¿ç”¨å±•å¼€è¦†ç›–å€¼ï¼š**
```hemlock
let defaults = { theme: "light", size: "medium", debug: false };
let custom = { ...defaults, theme: "dark" };

print(custom.theme);  // "dark"ï¼ˆè¢«è¦†ç›–ï¼‰
print(custom.size);   // "medium"ï¼ˆæ¥è‡ª defaultsï¼‰
print(custom.debug);  // falseï¼ˆæ¥è‡ª defaultsï¼‰
```

**å¤šä¸ªå±•å¼€ï¼ˆåé¢çš„è¦†ç›–å‰é¢çš„ï¼‰ï¼š**
```hemlock
let a = { x: 1 };
let b = { y: 2 };
let merged = { ...a, ...b, z: 3 };

print(merged.x);  // 1
print(merged.y);  // 2
print(merged.z);  // 3

// åé¢çš„å±•å¼€è¦†ç›–å‰é¢çš„
let first = { val: "first" };
let second = { val: "second" };
let combined = { ...first, ...second };
print(combined.val);  // "second"
```

**ç»“åˆç®€å†™å’Œå±•å¼€ï¼š**
```hemlock
let status = "active";
let data = { id: 1, name: "Item" };
let full = { ...data, status };

print(full.id);      // 1
print(full.name);    // "Item"
print(full.status);  // "active"
```

**é…ç½®è¦†ç›–æ¨¡å¼ï¼š**
```hemlock
let defaultConfig = {
    debug: false,
    timeout: 30,
    retries: 3
};

let prodConfig = { ...defaultConfig, timeout: 60 };
let devConfig = { ...defaultConfig, debug: true };

print(prodConfig.timeout);  // 60
print(devConfig.debug);     // true
```

**æ³¨æ„ï¼š** å±•å¼€æ‰§è¡Œæµ…æ‹·è´ã€‚åµŒå¥—å¯¹è±¡å…±äº«å¼•ç”¨ï¼š
```hemlock
let nested = { inner: { val: 42 } };
let copied = { ...nested };
print(copied.inner.val);  // 42ï¼ˆä¸ nested.inner ç›¸åŒçš„å¼•ç”¨ï¼‰
```

## å­—æ®µè®¿é—®

### ç‚¹è¯­æ³•

```hemlock
let person = { name: "Alice", age: 30 };

// è¯»å–å­—æ®µ
let name = person.name;      // "Alice"
let age = person.age;        // 30

// ä¿®æ”¹å­—æ®µ
person.age = 31;
print(person.age);           // 31
```

### åŠ¨æ€å­—æ®µæ·»åŠ 

åœ¨è¿è¡Œæ—¶æ·»åŠ æ–°å­—æ®µï¼š

```hemlock
let person = { name: "Alice" };

// æ·»åŠ æ–°å­—æ®µ
person.email = "alice@example.com";
person.phone = "555-1234";

print(person.email);  // "alice@example.com"
```

### å­—æ®µåˆ é™¤

**æ³¨æ„ï¼š** ç›®å‰ä¸æ”¯æŒå­—æ®µåˆ é™¤ã€‚æ”¹ä¸ºè®¾ç½®ä¸º `null`ï¼š

```hemlock
let obj = { x: 10, y: 20 };

// æ— æ³•åˆ é™¤å­—æ®µï¼ˆä¸æ”¯æŒï¼‰
// obj.x = undefined;  // Hemlock ä¸­æ²¡æœ‰ 'undefined'

// å˜é€šæ–¹æ³•ï¼šè®¾ç½®ä¸º null
obj.x = null;
```

## æ–¹æ³•å’Œ `self`

### å®šä¹‰æ–¹æ³•

æ–¹æ³•æ˜¯å­˜å‚¨åœ¨å¯¹è±¡å­—æ®µä¸­çš„å‡½æ•°ï¼š

```hemlock
let counter = {
    count: 0,
    increment: fn() {
        self.count = self.count + 1;
    },
    decrement: fn() {
        self.count = self.count - 1;
    },
    get: fn() {
        return self.count;
    }
};
```

### `self` å…³é”®å­—

å½“å‡½æ•°ä½œä¸ºæ–¹æ³•è°ƒç”¨æ—¶ï¼Œ`self` è‡ªåŠ¨ç»‘å®šåˆ°å¯¹è±¡ï¼š

```hemlock
let counter = {
    count: 0,
    increment: fn() {
        self.count = self.count + 1;  // self æŒ‡å‘ counter
    }
};

counter.increment();  // self ç»‘å®šåˆ° counter
print(counter.count);  // 1
```

**å·¥ä½œåŸç†ï¼š**
- é€šè¿‡æ£€æŸ¥å‡½æ•°è¡¨è¾¾å¼æ˜¯å¦ä¸ºå±æ€§è®¿é—®æ¥æ£€æµ‹æ–¹æ³•è°ƒç”¨
- `self` åœ¨è°ƒç”¨æ—¶è‡ªåŠ¨ç»‘å®šåˆ°å¯¹è±¡
- `self` æ˜¯åªè¯»çš„ï¼ˆæ— æ³•é‡æ–°èµ‹å€¼ `self` æœ¬èº«ï¼‰

### æ–¹æ³•è°ƒç”¨æ£€æµ‹

```hemlock
let obj = {
    value: 10,
    method: fn() {
        return self.value;
    }
};

// ä½œä¸ºæ–¹æ³•è°ƒç”¨ - self è¢«ç»‘å®š
print(obj.method());  // 10

// ä½œä¸ºå‡½æ•°è°ƒç”¨ - self ä¸º nullï¼ˆé”™è¯¯ï¼‰
let f = obj.method;
print(f());  // é”™è¯¯ï¼šself æœªå®šä¹‰
```

### å¸¦å‚æ•°çš„æ–¹æ³•

```hemlock
let calculator = {
    result: 0,
    add: fn(x) {
        self.result = self.result + x;
    },
    multiply: fn(x) {
        self.result = self.result * x;
    },
    get: fn() {
        return self.result;
    }
};

calculator.add(5);
calculator.multiply(2);
print(calculator.get());  // 10
```

## ä½¿ç”¨ `define` è¿›è¡Œç±»å‹å®šä¹‰

### åŸºæœ¬ç±»å‹å®šä¹‰

ä½¿ç”¨ `define` å®šä¹‰å¯¹è±¡ç»“æ„ï¼š

```hemlock
define Person {
    name: string,
    age: i32,
    active: bool,
}

// åˆ›å»ºå¯¹è±¡å¹¶èµ‹å€¼ç»™ç±»å‹åŒ–å˜é‡
let p = { name: "Alice", age: 30, active: true };
let typed_p: Person = p;  // é¸­å­ç±»å‹éªŒè¯ç»“æ„

print(typeof(typed_p));  // "Person"
```

**`define` çš„ä½œç”¨ï¼š**
- å£°æ˜å…·æœ‰å¿…éœ€å­—æ®µçš„ç±»å‹
- å¯ç”¨é¸­å­ç±»å‹éªŒè¯
- ä¸º `typeof()` è®¾ç½®å¯¹è±¡çš„ç±»å‹åç§°

### é¸­å­ç±»å‹

ä½¿ç”¨**ç»“æ„å…¼å®¹æ€§**éªŒè¯å¯¹è±¡æ˜¯å¦ç¬¦åˆ `define`ï¼š

```hemlock
define Person {
    name: string,
    age: i32,
}

// æ­£ç¡®ï¼šå…·æœ‰æ‰€æœ‰å¿…éœ€å­—æ®µ
let p1: Person = { name: "Alice", age: 30 };

// æ­£ç¡®ï¼šå…è®¸é¢å¤–å­—æ®µ
let p2: Person = {
    name: "Bob",
    age: 25,
    city: "NYC",
    active: true
};

// é”™è¯¯ï¼šç¼ºå°‘å¿…éœ€å­—æ®µ 'age'
let p3: Person = { name: "Carol" };

// é”™è¯¯ï¼š'age' ç±»å‹é”™è¯¯
let p4: Person = { name: "Dave", age: "thirty" };
```

**é¸­å­ç±»å‹è§„åˆ™ï¼š**
- æ‰€æœ‰å¿…éœ€å­—æ®µå¿…é¡»å­˜åœ¨
- å­—æ®µç±»å‹å¿…é¡»åŒ¹é…
- å…è®¸é¢å¤–å­—æ®µå¹¶ä¿ç•™
- éªŒè¯å‘ç”Ÿåœ¨èµ‹å€¼æ—¶

### å¯é€‰å­—æ®µ

å­—æ®µå¯ä»¥æ˜¯å¯é€‰çš„ï¼Œå¸¦æœ‰é»˜è®¤å€¼ï¼š

```hemlock
define Person {
    name: string,
    age: i32,
    active?: true,       // å¯é€‰ï¼Œå¸¦é»˜è®¤å€¼
    nickname?: string,   // å¯é€‰ï¼Œé»˜è®¤ä¸º null
}

// åªæœ‰å¿…éœ€å­—æ®µçš„å¯¹è±¡
let p = { name: "Alice", age: 30 };
let typed_p: Person = p;

print(typed_p.active);    // trueï¼ˆåº”ç”¨é»˜è®¤å€¼ï¼‰
print(typed_p.nickname);  // nullï¼ˆæ— é»˜è®¤å€¼ï¼‰

// å¯ä»¥è¦†ç›–å¯é€‰å­—æ®µ
let p2: Person = { name: "Bob", age: 25, active: false };
print(p2.active);  // falseï¼ˆè¢«è¦†ç›–ï¼‰
```

**å¯é€‰å­—æ®µè¯­æ³•ï¼š**
- `field?: default_value` - å¯é€‰ï¼Œå¸¦é»˜è®¤å€¼
- `field?: type` - å¯é€‰ï¼Œå¸¦ç±»å‹æ³¨è§£ï¼Œé»˜è®¤ä¸º null
- å¦‚æœç¼ºå°‘å¯é€‰å­—æ®µï¼Œåœ¨é¸­å­ç±»å‹æ£€æŸ¥æ—¶æ·»åŠ 

### ç±»å‹æ£€æŸ¥

```hemlock
define Point {
    x: i32,
    y: i32,
}

let p = { x: 10, y: 20 };
let point: Point = p;  // ç±»å‹æ£€æŸ¥å‘ç”Ÿåœ¨è¿™é‡Œ

print(typeof(point));  // "Point"
print(typeof(p));      // "object"ï¼ˆåŸå§‹å¯¹è±¡ä»æ˜¯åŒ¿åçš„ï¼‰
```

**ç±»å‹æ£€æŸ¥å‘ç”Ÿçš„æ—¶æœºï¼š**
- èµ‹å€¼ç»™ç±»å‹åŒ–å˜é‡æ—¶
- éªŒè¯æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨
- éªŒè¯å­—æ®µç±»å‹åŒ¹é…ï¼ˆå¸¦éšå¼è½¬æ¢ï¼‰
- è®¾ç½®å¯¹è±¡çš„ç±»å‹åç§°

## Define ä¸­çš„æ–¹æ³•ç­¾å

Define å—å¯ä»¥æŒ‡å®šæ–¹æ³•ç­¾åï¼Œåˆ›å»ºç±»ä¼¼æ¥å£çš„å¥‘çº¦ï¼š

### å¿…éœ€æ–¹æ³•

```hemlock
define Comparable {
    value: i32,
    fn compare(other: Self): i32;  // å¿…éœ€æ–¹æ³•ç­¾å
}

// å¯¹è±¡å¿…é¡»æä¾›å¿…éœ€æ–¹æ³•
let a: Comparable = {
    value: 10,
    compare: fn(other) { return self.value - other.value; }
};
```

### å¯é€‰æ–¹æ³•

```hemlock
define Serializable {
    fn serialize(): string;       // å¿…éœ€
    fn pretty?(): string;         // å¯é€‰æ–¹æ³•ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰
}
```

### `Self` ç±»å‹

`Self` æŒ‡å‘æ­£åœ¨å®šä¹‰çš„ç±»å‹ï¼Œæ”¯æŒé€’å½’ç±»å‹å®šä¹‰ï¼š

```hemlock
define Cloneable {
    fn clone(): Self;  // è¿”å›ä¸å¯¹è±¡ç›¸åŒçš„ç±»å‹
}

define Comparable {
    fn compare(other: Self): i32;  // æ¥å—ç›¸åŒç±»å‹ä½œä¸ºå‚æ•°
    fn equals(other: Self): bool;
}

let item: Cloneable = {
    value: 42,
    clone: fn() {
        return { value: self.value, clone: self.clone };
    }
};
```

### æ··åˆå­—æ®µå’Œæ–¹æ³•

```hemlock
define Entity {
    id: i32,
    name: string,
    fn validate(): bool;
    fn serialize(): string;
}

let user: Entity = {
    id: 1,
    name: "Alice",
    validate: fn() { return self.id > 0 && self.name != ""; },
    serialize: fn() { return '{"id":' + self.id + ',"name":"' + self.name + '"}'; }
};
```

## å¤åˆç±»å‹ï¼ˆäº¤å‰ç±»å‹ï¼‰

å¤åˆç±»å‹ä½¿ç”¨ `&` è¦æ±‚å¯¹è±¡æ»¡è¶³å¤šä¸ªç±»å‹å®šä¹‰ï¼š

### åŸºæœ¬å¤åˆç±»å‹

```hemlock
define HasName { name: string }
define HasAge { age: i32 }

// å¤åˆç±»å‹ï¼šå¯¹è±¡å¿…é¡»æ»¡è¶³æ‰€æœ‰ç±»å‹
let person: HasName & HasAge = { name: "Alice", age: 30 };
```

### å¸¦å¤åˆç±»å‹çš„å‡½æ•°å‚æ•°

```hemlock
fn greet(p: HasName & HasAge) {
    print(p.name + " is " + p.age);
}

greet({ name: "Bob", age: 25, city: "NYC" });  // å…è®¸é¢å¤–å­—æ®µ
```

### ä¸‰ä¸ªæˆ–æ›´å¤šç±»å‹

```hemlock
define HasEmail { email: string }

fn describe(p: HasName & HasAge & HasEmail) {
    print(p.name + " <" + p.email + ">");
}
```

### å¤åˆç±»å‹çš„ç±»å‹åˆ«å

```hemlock
// ä¸ºå¤åˆç±»å‹åˆ›å»ºå‘½ååˆ«å
type Person = HasName & HasAge;
type Employee = HasName & HasAge & HasEmail;

let emp: Employee = {
    name: "Charlie",
    age: 35,
    email: "charlie@example.com"
};
```

**å¤åˆç±»å‹çš„é¸­å­ç±»å‹ï¼š** å§‹ç»ˆå…è®¸é¢å¤–å­—æ®µ - å¯¹è±¡åªéœ€è¦è‡³å°‘å…·æœ‰æ‰€æœ‰ç»„æˆç±»å‹è¦æ±‚çš„å­—æ®µã€‚

## JSON åºåˆ—åŒ–

### åºåˆ—åŒ–ä¸º JSON

å°†å¯¹è±¡è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²ï¼š

```hemlock
// obj.serialize() - å°†å¯¹è±¡è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
let obj = { x: 10, y: 20, name: "test" };
let json = obj.serialize();
print(json);  // {"x":10,"y":20,"name":"test"}

// åµŒå¥—å¯¹è±¡
let nested = { inner: { a: 1, b: 2 }, outer: 3 };
print(nested.serialize());  // {"inner":{"a":1,"b":2},"outer":3}
```

### ä» JSON ååºåˆ—åŒ–

å°† JSON å­—ç¬¦ä¸²è§£æå›å¯¹è±¡ï¼š

```hemlock
// json.deserialize() - å°† JSON å­—ç¬¦ä¸²è§£æä¸ºå¯¹è±¡
let json_str = '{"x":10,"y":20,"name":"test"}';
let obj = json_str.deserialize();

print(obj.name);   // "test"
print(obj.x);      // 10
```

### å¾ªç¯å¼•ç”¨æ£€æµ‹

å¾ªç¯å¼•ç”¨ä¼šè¢«æ£€æµ‹åˆ°å¹¶å¯¼è‡´é”™è¯¯ï¼š

```hemlock
let obj = { x: 10 };
obj.me = obj;  // åˆ›å»ºå¾ªç¯å¼•ç”¨

obj.serialize();  // é”™è¯¯ï¼šserialize() æ£€æµ‹åˆ°å¾ªç¯å¼•ç”¨
```

### æ”¯æŒçš„ç±»å‹

JSON åºåˆ—åŒ–æ”¯æŒï¼š

- **æ•°å­—**ï¼ši8-i32, u8-u32, f32, f64
- **å¸ƒå°”å€¼**ï¼štrue, false
- **å­—ç¬¦ä¸²**ï¼šå¸¦è½¬ä¹‰åºåˆ—
- **Null**ï¼šnull å€¼
- **å¯¹è±¡**ï¼šåµŒå¥—å¯¹è±¡
- **æ•°ç»„**ï¼šåµŒå¥—æ•°ç»„

**ä¸æ”¯æŒï¼š**
- å‡½æ•°ï¼ˆé™é»˜çœç•¥ï¼‰
- æŒ‡é’ˆï¼ˆé”™è¯¯ï¼‰
- Bufferï¼ˆé”™è¯¯ï¼‰

### é”™è¯¯å¤„ç†

åºåˆ—åŒ–å’Œååºåˆ—åŒ–å¯èƒ½æŠ›å‡ºé”™è¯¯ï¼š

```hemlock
// æ— æ•ˆ JSON æŠ›å‡ºé”™è¯¯
try {
    let bad = "not valid json".deserialize();
} catch (e) {
    print("Parse error:", e);
}

// æŒ‡é’ˆæ— æ³•åºåˆ—åŒ–
let obj = { ptr: alloc(10) };
try {
    obj.serialize();
} catch (e) {
    print("Serialize error:", e);
}
```

### å¾€è¿”ç¤ºä¾‹

åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å®Œæ•´ç¤ºä¾‹ï¼š

```hemlock
define Config {
    host: string,
    port: i32,
    debug: bool
}

// åˆ›å»ºå¹¶åºåˆ—åŒ–
let config: Config = {
    host: "localhost",
    port: 8080,
    debug: true
};
let json = config.serialize();
print(json);  // {"host":"localhost","port":8080,"debug":true}

// ååºåˆ—åŒ–
let restored = json.deserialize();
print(restored.host);  // "localhost"
print(restored.port);  // 8080
```

## å†…ç½®å‡½æ•°

### `typeof(value)`

è¿”å›ç±»å‹åç§°ä½œä¸ºå­—ç¬¦ä¸²ï¼š

```hemlock
let obj = { x: 10 };
print(typeof(obj));  // "object"

define Person { name: string, age: i32 }
let p: Person = { name: "Alice", age: 30 };
print(typeof(p));    // "Person"
```

**è¿”å›å€¼ï¼š**
- åŒ¿åå¯¹è±¡ï¼š`"object"`
- ç±»å‹åŒ–å¯¹è±¡ï¼šè‡ªå®šä¹‰ç±»å‹åç§°ï¼ˆä¾‹å¦‚ `"Person"`ï¼‰

## å®ç°ç»†èŠ‚

### å†…å­˜æ¨¡å‹

- **å †åˆ†é…** - æ‰€æœ‰å¯¹è±¡éƒ½åœ¨å †ä¸Šåˆ†é…
- **æµ…æ‹·è´** - èµ‹å€¼å¤åˆ¶å¼•ç”¨ï¼Œè€Œéå¯¹è±¡
- **åŠ¨æ€å­—æ®µ** - å­˜å‚¨ä¸ºåç§°/å€¼å¯¹çš„åŠ¨æ€æ•°ç»„
- **å¼•ç”¨è®¡æ•°** - ä½œç”¨åŸŸé€€å‡ºæ—¶å¯¹è±¡è‡ªåŠ¨é‡Šæ”¾

### å¼•ç”¨è¯­ä¹‰

```hemlock
let obj1 = { x: 10 };
let obj2 = obj1;  // æµ…æ‹·è´ï¼ˆç›¸åŒå¼•ç”¨ï¼‰

obj2.x = 20;
print(obj1.x);  // 20ï¼ˆä¸¤è€…æŒ‡å‘ç›¸åŒå¯¹è±¡ï¼‰
```

### æ–¹æ³•å­˜å‚¨

æ–¹æ³•åªæ˜¯å­˜å‚¨åœ¨å­—æ®µä¸­çš„å‡½æ•°ï¼š

```hemlock
let obj = {
    value: 10,
    method: fn() { return self.value; }
};

// method æ˜¯å­˜å‚¨åœ¨ obj.method ä¸­çš„å‡½æ•°
print(typeof(obj.method));  // "function"
```

## å¸¸è§æ¨¡å¼

### æ¨¡å¼ï¼šæ„é€ å‡½æ•°

```hemlock
fn createPerson(name: string, age: i32) {
    return {
        name: name,
        age: age,
        greet: fn() {
            return "Hi, I'm " + self.name;
        }
    };
}

let person = createPerson("Alice", 30);
print(person.greet());  // "Hi, I'm Alice"
```

### æ¨¡å¼ï¼šå¯¹è±¡æ„å»ºå™¨

```hemlock
fn PersonBuilder() {
    return {
        name: null,
        age: null,

        setName: fn(n) {
            self.name = n;
            return self;  // æ”¯æŒé“¾å¼è°ƒç”¨
        },

        setAge: fn(a) {
            self.age = a;
            return self;
        },

        build: fn() {
            return { name: self.name, age: self.age };
        }
    };
}

let person = PersonBuilder()
    .setName("Alice")
    .setAge(30)
    .build();
```

### æ¨¡å¼ï¼šçŠ¶æ€å¯¹è±¡

```hemlock
let state = {
    status: "idle",
    data: null,
    error: null,

    setState: fn(new_status) {
        self.status = new_status;
    },

    setData: fn(new_data) {
        self.data = new_data;
        self.status = "success";
    },

    setError: fn(err) {
        self.error = err;
        self.status = "error";
    }
};
```

### æ¨¡å¼ï¼šé…ç½®å¯¹è±¡

```hemlock
let config = {
    defaults: {
        timeout: 30,
        retries: 3,
        debug: false
    },

    get: fn(key) {
        if (self.defaults[key] != null) {
            return self.defaults[key];
        }
        return null;
    },

    set: fn(key, value) {
        self.defaults[key] = value;
    }
};
```

## æœ€ä½³å®è·µ

1. **ä½¿ç”¨ `define` å®šä¹‰ç»“æ„** - è®°å½•é¢„æœŸçš„å¯¹è±¡å½¢çŠ¶
2. **ä¼˜å…ˆä½¿ç”¨å·¥å‚å‡½æ•°** - ä½¿ç”¨æ„é€ å‡½æ•°åˆ›å»ºå¯¹è±¡
3. **ä¿æŒå¯¹è±¡ç®€å•** - ä¸è¦åµŒå¥—å¤ªæ·±
4. **è®°å½• `self` ç”¨æ³•** - æ˜ç¡®æ–¹æ³•è¡Œä¸º
5. **åœ¨èµ‹å€¼æ—¶éªŒè¯** - ä½¿ç”¨é¸­å­ç±»å‹å°½æ—©æ•è·é”™è¯¯
6. **é¿å…å¾ªç¯å¼•ç”¨** - ä¼šå¯¼è‡´åºåˆ—åŒ–é”™è¯¯
7. **ä½¿ç”¨å¯é€‰å­—æ®µ** - æä¾›åˆç†çš„é»˜è®¤å€¼

## å¸¸è§é™·é˜±

### é™·é˜±ï¼šå¼•ç”¨ä¸å€¼

```hemlock
let obj1 = { x: 10 };
let obj2 = obj1;  // æµ…æ‹·è´

obj2.x = 20;
print(obj1.x);  // 20ï¼ˆæ„å¤–ï¼ä¸¤è€…éƒ½æ”¹å˜äº†ï¼‰

// é¿å…æ–¹æ³•ï¼šåˆ›å»ºæ–°å¯¹è±¡
let obj3 = { x: obj1.x };  // æ·±æ‹·è´ï¼ˆæ‰‹åŠ¨ï¼‰
```

### é™·é˜±ï¼šéæ–¹æ³•è°ƒç”¨ä¸­çš„ `self`

```hemlock
let obj = {
    value: 10,
    method: fn() { return self.value; }
};

// æœ‰æ•ˆï¼šä½œä¸ºæ–¹æ³•è°ƒç”¨
print(obj.method());  // 10

// é”™è¯¯ï¼šä½œä¸ºå‡½æ•°è°ƒç”¨
let f = obj.method;
print(f());  // é”™è¯¯ï¼šself æœªå®šä¹‰
```

### é™·é˜±ï¼šå¯¹è±¡ä¸­çš„åŸå§‹æŒ‡é’ˆ

```hemlock
// å¯¹è±¡ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œä½†å…¶ä¸­çš„åŸå§‹æŒ‡é’ˆä¸ä¼š
fn create_objects() {
    let obj = { data: alloc(1000) };  // åŸå§‹æŒ‡é’ˆéœ€è¦æ‰‹åŠ¨é‡Šæ”¾
    // ä½œç”¨åŸŸé€€å‡ºæ—¶ obj è‡ªåŠ¨é‡Šæ”¾ï¼Œä½† obj.data æ³„æ¼ï¼
}

// è§£å†³æ–¹æ¡ˆï¼šåœ¨ä½œç”¨åŸŸé€€å‡ºå‰é‡Šæ”¾åŸå§‹æŒ‡é’ˆ
fn safe_create() {
    let obj = { data: alloc(1000) };
    // ... ä½¿ç”¨ obj.data ...
    free(obj.data);  // æ˜¾å¼é‡Šæ”¾åŸå§‹æŒ‡é’ˆ
}  // obj æœ¬èº«è‡ªåŠ¨é‡Šæ”¾
```

### é™·é˜±ï¼šç±»å‹æ··æ·†

```hemlock
let obj = { x: 10 };

define Point { x: i32, y: i32 }

// é”™è¯¯ï¼šç¼ºå°‘å¿…éœ€å­—æ®µ 'y'
let p: Point = obj;
```

## ç¤ºä¾‹

### ç¤ºä¾‹ï¼šå‘é‡æ•°å­¦

```hemlock
fn createVector(x, y) {
    return {
        x: x,
        y: y,

        add: fn(other) {
            return createVector(
                self.x + other.x,
                self.y + other.y
            );
        },

        length: fn() {
            return sqrt(self.x * self.x + self.y * self.y);
        },

        toString: fn() {
            return "(" + typeof(self.x) + ", " + typeof(self.y) + ")";
        }
    };
}

let v1 = createVector(3, 4);
let v2 = createVector(1, 2);
let v3 = v1.add(v2);

print(v3.toString());  // "(4, 6)"
```

### ç¤ºä¾‹ï¼šç®€å•æ•°æ®åº“

```hemlock
fn createDatabase() {
    let records = [];
    let next_id = 1;

    return {
        insert: fn(data) {
            let record = { id: next_id, data: data };
            records.push(record);
            next_id = next_id + 1;
            return record.id;
        },

        find: fn(id) {
            let i = 0;
            while (i < records.length) {
                if (records[i].id == id) {
                    return records[i];
                }
                i = i + 1;
            }
            return null;
        },

        count: fn() {
            return records.length;
        }
    };
}

let db = createDatabase();
let id = db.insert({ name: "Alice", age: 30 });
let record = db.find(id);
print(record.data.name);  // "Alice"
```

### ç¤ºä¾‹ï¼šäº‹ä»¶å‘å°„å™¨

```hemlock
fn createEventEmitter() {
    let listeners = {};

    return {
        on: fn(event, handler) {
            if (listeners[event] == null) {
                listeners[event] = [];
            }
            listeners[event].push(handler);
        },

        emit: fn(event, data) {
            if (listeners[event] != null) {
                let i = 0;
                while (i < listeners[event].length) {
                    listeners[event][i](data);
                    i = i + 1;
                }
            }
        }
    };
}

let emitter = createEventEmitter();

emitter.on("message", fn(data) {
    print("Received: " + data);
});

emitter.emit("message", "Hello!");
```

## é™åˆ¶

å½“å‰é™åˆ¶ï¼š

- **æ— æ·±æ‹·è´** - å¿…é¡»æ‰‹åŠ¨å¤åˆ¶åµŒå¥—å¯¹è±¡ï¼ˆå±•å¼€æ˜¯æµ…æ‹·è´ï¼‰
- **æ— æŒ‰å€¼ä¼ é€’** - å¯¹è±¡å§‹ç»ˆæŒ‰å¼•ç”¨ä¼ é€’
- **æ— è®¡ç®—å±æ€§** - ä¸æ”¯æŒ `{[key]: value}` è¯­æ³•
- **`self` æ˜¯åªè¯»çš„** - æ— æ³•åœ¨æ–¹æ³•ä¸­é‡æ–°èµ‹å€¼ `self`
- **æ— å±æ€§åˆ é™¤** - ä¸€æ—¦æ·»åŠ å­—æ®µæ— æ³•åˆ é™¤

**æ³¨æ„ï¼š** å¯¹è±¡ä½¿ç”¨å¼•ç”¨è®¡æ•°ï¼Œä½œç”¨åŸŸé€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚è¯¦è§ [å†…å­˜ç®¡ç†](memory.md#internal-reference-counting)ã€‚

## ç›¸å…³ä¸»é¢˜

- [å‡½æ•°](#language-guide-functions) - æ–¹æ³•æ˜¯å­˜å‚¨åœ¨å¯¹è±¡ä¸­çš„å‡½æ•°
- [æ•°ç»„](#language-guide-arrays) - æ•°ç»„ä¹Ÿæ˜¯ç±»å¯¹è±¡çš„
- [ç±»å‹](#language-guide-types) - é¸­å­ç±»å‹å’Œç±»å‹å®šä¹‰
- [é”™è¯¯å¤„ç†](#language-guide-error-handling) - æŠ›å‡ºé”™è¯¯å¯¹è±¡

## å¦è¯·å‚é˜…

- **é¸­å­ç±»å‹**ï¼šå‚è§ CLAUDE.md ä¸­çš„ "Objects" éƒ¨åˆ†äº†è§£é¸­å­ç±»å‹è¯¦æƒ…
- **JSON**ï¼šå‚è§ CLAUDE.md äº†è§£ JSON åºåˆ—åŒ–è¯¦æƒ…
- **å†…å­˜**ï¼šå‚è§ [å†…å­˜](#language-guide-memory) äº†è§£å¯¹è±¡åˆ†é…


--------------------------------------------------------------------------------
## æ§åˆ¶æµ
--------------------------------------------------------------------------------

# æ§åˆ¶æµ

Hemlock æä¾›ç†Ÿæ‚‰çš„ C é£æ ¼æ§åˆ¶æµï¼Œè¦æ±‚å¼ºåˆ¶ä½¿ç”¨èŠ±æ‹¬å·å’Œæ˜¾å¼è¯­æ³•ã€‚æœ¬æŒ‡å—æ¶µç›–æ¡ä»¶è¯­å¥ã€å¾ªç¯ã€switch è¯­å¥å’Œè¿ç®—ç¬¦ã€‚

## æ¦‚è¿°

å¯ç”¨çš„æ§åˆ¶æµç‰¹æ€§ï¼š

- `if`/`else`/`else if` - æ¡ä»¶åˆ†æ”¯
- `while` å¾ªç¯ - åŸºäºæ¡ä»¶çš„è¿­ä»£
- `for` å¾ªç¯ - C é£æ ¼å’Œ for-in è¿­ä»£
- `loop` - æ— é™å¾ªç¯ï¼ˆæ¯” `while (true)` æ›´æ¸…æ™°ï¼‰
- `switch` è¯­å¥ - å¤šè·¯åˆ†æ”¯
- `break`/`continue` - å¾ªç¯æ§åˆ¶
- å¾ªç¯æ ‡ç­¾ - é’ˆå¯¹åµŒå¥—å¾ªç¯çš„å®šå‘ break/continue
- `defer` - å»¶è¿Ÿæ‰§è¡Œï¼ˆæ¸…ç†ï¼‰
- å¸ƒå°”è¿ç®—ç¬¦ï¼š`&&`ã€`||`ã€`!`
- æ¯”è¾ƒè¿ç®—ç¬¦ï¼š`==`ã€`!=`ã€`<`ã€`>`ã€`<=`ã€`>=`
- ä½è¿ç®—ç¬¦ï¼š`&`ã€`|`ã€`^`ã€`<<`ã€`>>`ã€`~`

## If è¯­å¥

### åŸºæœ¬ If/Else

```hemlock
if (x > 10) {
    print("large");
} else {
    print("small");
}
```

**è§„åˆ™ï¼š**
- æ‰€æœ‰åˆ†æ”¯éƒ½**å¿…é¡»**ä½¿ç”¨èŠ±æ‹¬å·
- æ¡ä»¶å¿…é¡»ç”¨æ‹¬å·åŒ…å›´
- ä¸æ”¯æŒå¯é€‰èŠ±æ‹¬å·ï¼ˆä¸ C ä¸åŒï¼‰

### æ—  Else çš„ If

```hemlock
if (x > 0) {
    print("positive");
}
// ä¸éœ€è¦ else åˆ†æ”¯
```

### Else-If é“¾

```hemlock
if (x > 100) {
    print("very large");
} else if (x > 50) {
    print("large");
} else if (x > 10) {
    print("medium");
} else {
    print("small");
}
```

**æ³¨æ„ï¼š** `else if` æ˜¯åµŒå¥— if è¯­å¥çš„è¯­æ³•ç³–ã€‚ä»¥ä¸‹ä¸¤ç§å†™æ³•ç­‰ä»·ï¼š

```hemlock
// else ifï¼ˆè¯­æ³•ç³–ï¼‰
if (a) {
    foo();
} else if (b) {
    bar();
}

// ç­‰ä»·çš„åµŒå¥— if
if (a) {
    foo();
} else {
    if (b) {
        bar();
    }
}
```

### åµŒå¥— If è¯­å¥

```hemlock
if (x > 0) {
    if (x < 10) {
        print("single digit positive");
    } else {
        print("multi-digit positive");
    }
} else {
    print("non-positive");
}
```

## While å¾ªç¯

åŸºäºæ¡ä»¶çš„è¿­ä»£ï¼š

```hemlock
let i = 0;
while (i < 10) {
    print(i);
    i = i + 1;
}
```

**æ— é™å¾ªç¯ï¼ˆæ—§å¼ï¼‰ï¼š**
```hemlock
while (true) {
    // ... æ‰§è¡Œå·¥ä½œ
    if (should_exit) {
        break;
    }
}
```

**æ³¨æ„ï¼š** å¯¹äºæ— é™å¾ªç¯ï¼Œæ¨èä½¿ç”¨ `loop` å…³é”®å­—ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚

## Loopï¼ˆæ— é™å¾ªç¯ï¼‰

`loop` å…³é”®å­—ä¸ºæ— é™å¾ªç¯æä¾›æ›´æ¸…æ™°çš„è¯­æ³•ï¼š

```hemlock
loop {
    // ... æ‰§è¡Œå·¥ä½œ
    if (should_exit) {
        break;
    }
}
```

**ç­‰ä»·äº `while (true)`ï¼Œä½†æ„å›¾æ›´æ˜ç¡®ã€‚**

### å¸¦ Break çš„åŸºæœ¬ Loop

```hemlock
let i = 0;
loop {
    if (i >= 5) {
        break;
    }
    print(i);
    i = i + 1;
}
// è¾“å‡ºï¼š0, 1, 2, 3, 4
```

### å¸¦ Continue çš„ Loop

```hemlock
let i = 0;
loop {
    i = i + 1;
    if (i > 5) {
        break;
    }
    if (i == 3) {
        continue;  // è·³è¿‡æ‰“å° 3
    }
    print(i);
}
// è¾“å‡ºï¼š1, 2, 4, 5
```

### åµŒå¥— Loop

```hemlock
let x = 0;
loop {
    if (x >= 2) { break; }
    let y = 0;
    loop {
        if (y >= 3) { break; }
        print(x * 10 + y);
        y = y + 1;
    }
    x = x + 1;
}
// è¾“å‡ºï¼š0, 1, 2, 10, 11, 12
```

### ä½•æ—¶ä½¿ç”¨ Loop

- **ä½¿ç”¨ `loop`** - ç”¨äºæ•…æ„çš„æ— é™å¾ªç¯ï¼Œé€šè¿‡ `break` é€€å‡º
- **ä½¿ç”¨ `while`** - å½“æœ‰è‡ªç„¶çš„ç»ˆæ­¢æ¡ä»¶æ—¶
- **ä½¿ç”¨ `for`** - å½“è¿­ä»£å·²çŸ¥æ¬¡æ•°æˆ–éå†é›†åˆæ—¶

## For å¾ªç¯

### C é£æ ¼ For

ç»å…¸çš„ä¸‰æ®µå¼ for å¾ªç¯ï¼š

```hemlock
for (let i = 0; i < 10; i = i + 1) {
    print(i);
}
```

**ç»„æˆéƒ¨åˆ†ï¼š**
- **åˆå§‹åŒ–å™¨**ï¼š`let i = 0` - å¾ªç¯å¼€å§‹å‰è¿è¡Œä¸€æ¬¡
- **æ¡ä»¶**ï¼š`i < 10` - æ¯æ¬¡è¿­ä»£å‰æ£€æŸ¥
- **æ›´æ–°**ï¼š`i = i + 1` - æ¯æ¬¡è¿­ä»£åè¿è¡Œ

**ä½œç”¨åŸŸï¼š**
```hemlock
for (let i = 0; i < 10; i = i + 1) {
    print(i);
}
// i åœ¨è¿™é‡Œä¸å¯è®¿é—®ï¼ˆå¾ªç¯ä½œç”¨åŸŸï¼‰
```

### For-In å¾ªç¯

éå†æ•°ç»„å…ƒç´ ï¼š

```hemlock
let arr = [1, 2, 3, 4, 5];
for (let item in arr) {
    print(item);  // æ‰“å°æ¯ä¸ªå…ƒç´ 
}
```

**å¸¦ç´¢å¼•å’Œå€¼ï¼š**
```hemlock
let arr = ["a", "b", "c"];
for (let i = 0; i < arr.length; i = i + 1) {
    print(`Index: ${i}, Value: ${arr[i]}`);
}
```

## Switch è¯­å¥

åŸºäºå€¼çš„å¤šè·¯åˆ†æ”¯ï¼š

### åŸºæœ¬ Switch

```hemlock
let x = 2;

switch (x) {
    case 1:
        print("one");
        break;
    case 2:
        print("two");
        break;
    case 3:
        print("three");
        break;
}
```

### å¸¦ Default çš„ Switch

```hemlock
let color = "blue";

switch (color) {
    case "red":
        print("stop");
        break;
    case "yellow":
        print("slow");
        break;
    case "green":
        print("go");
        break;
    default:
        print("unknown color");
        break;
}
```

**è§„åˆ™ï¼š**
- `default` åœ¨æ²¡æœ‰å…¶ä»– case åŒ¹é…æ—¶æ‰§è¡Œ
- `default` å¯ä»¥å‡ºç°åœ¨ switch ä½“çš„ä»»ä½•ä½ç½®
- åªå…è®¸ä¸€ä¸ª default case

### è´¯ç©¿è¡Œä¸º

æ²¡æœ‰ `break` çš„ case ä¼šè´¯ç©¿åˆ°ä¸‹ä¸€ä¸ª caseï¼ˆC é£æ ¼è¡Œä¸ºï¼‰ã€‚è¿™æ˜¯**æœ‰æ„çš„**ï¼Œå¯ç”¨äºåˆ†ç»„ caseï¼š

```hemlock
let grade = 85;

switch (grade) {
    case 100:
    case 95:
    case 90:
        print("A");
        break;
    case 85:
    case 80:
        print("B");
        break;
    default:
        print("C or below");
        break;
}
```

**æ˜¾å¼è´¯ç©¿ç¤ºä¾‹ï¼š**
```hemlock
let day = 3;

switch (day) {
    case 1:
    case 2:
    case 3:
    case 4:
    case 5:
        print("Weekday");
        break;
    case 6:
    case 7:
        print("Weekend");
        break;
}
```

**é‡è¦ï¼š** ä¸ä¸€äº›ç°ä»£è¯­è¨€ä¸åŒï¼ŒHemlock ä¸éœ€è¦æ˜¾å¼çš„ `fallthrough` å…³é”®å­—ã€‚é™¤éç”¨ `break`ã€`return` æˆ– `throw` ç»ˆæ­¢ï¼Œå¦åˆ™ case ä¼šè‡ªåŠ¨è´¯ç©¿ã€‚å§‹ç»ˆä½¿ç”¨ `break` é˜²æ­¢æ„å¤–è´¯ç©¿ã€‚

### å¸¦ Return çš„ Switch

åœ¨å‡½æ•°ä¸­ï¼Œ`return` ç«‹å³é€€å‡º switchï¼š

```hemlock
fn get_day_name(day: i32): string {
    switch (day) {
        case 1:
            return "Monday";
        case 2:
            return "Tuesday";
        case 3:
            return "Wednesday";
        default:
            return "Unknown";
    }
}
```

### Switch å€¼ç±»å‹

Switch é€‚ç”¨äºä»»ä½•å€¼ç±»å‹ï¼š

```hemlock
// æ•´æ•°
switch (count) {
    case 0: print("zero"); break;
    case 1: print("one"); break;
}

// å­—ç¬¦ä¸²
switch (name) {
    case "Alice": print("A"); break;
    case "Bob": print("B"); break;
}

// å¸ƒå°”å€¼
switch (flag) {
    case true: print("on"); break;
    case false: print("off"); break;
}
```

**æ³¨æ„ï¼š** Case ä½¿ç”¨å€¼ç›¸ç­‰æ€§è¿›è¡Œæ¯”è¾ƒã€‚

## Break å’Œ Continue

### Break

é€€å‡ºæœ€å†…å±‚çš„å¾ªç¯æˆ– switchï¼š

```hemlock
// åœ¨å¾ªç¯ä¸­
let i = 0;
while (true) {
    if (i >= 10) {
        break;  // é€€å‡ºå¾ªç¯
    }
    print(i);
    i = i + 1;
}

// åœ¨ switch ä¸­
switch (x) {
    case 1:
        print("one");
        break;  // é€€å‡º switch
    case 2:
        print("two");
        break;
}
```

### Continue

è·³åˆ°å¾ªç¯çš„ä¸‹ä¸€æ¬¡è¿­ä»£ï¼š

```hemlock
for (let i = 0; i < 10; i = i + 1) {
    if (i == 5) {
        continue;  // å½“ i ä¸º 5 æ—¶è·³è¿‡
    }
    print(i);  // æ‰“å° 0,1,2,3,4,6,7,8,9
}
```

**åŒºåˆ«ï¼š**
- `break` - å®Œå…¨é€€å‡ºå¾ªç¯
- `continue` - è·³åˆ°ä¸‹ä¸€æ¬¡è¿­ä»£

## å¾ªç¯æ ‡ç­¾

å¾ªç¯æ ‡ç­¾å…è®¸ `break` å’Œ `continue` é’ˆå¯¹ç‰¹å®šçš„å¤–å±‚å¾ªç¯ï¼Œè€Œä¸ä»…ä»…æ˜¯æœ€å†…å±‚å¾ªç¯ã€‚è¿™åœ¨éœ€è¦ä»å†…å±‚å¾ªç¯æ§åˆ¶å¤–å±‚å¾ªç¯çš„åµŒå¥—å¾ªç¯ä¸­å¾ˆæœ‰ç”¨ã€‚

### å¸¦æ ‡ç­¾çš„ Break

ä»å†…å±‚å¾ªç¯é€€å‡ºå¤–å±‚å¾ªç¯ï¼š

```hemlock
outer: while (i < 3) {
    let j = 0;
    while (j < 3) {
        if (i == 1 && j == 1) {
            break outer;  // é€€å‡ºå¤–å±‚ while å¾ªç¯
        }
        print(i * 10 + j);
        j = j + 1;
    }
    i = i + 1;
}
// è¾“å‡ºï¼š0, 1, 2, 10ï¼ˆåœ¨ i=1, j=1 å¤„åœæ­¢ï¼‰
```

### å¸¦æ ‡ç­¾çš„ Continue

è·³åˆ°å¤–å±‚å¾ªç¯çš„ä¸‹ä¸€æ¬¡è¿­ä»£ï¼š

```hemlock
let i = 0;
outer: while (i < 3) {
    i = i + 1;
    let j = 0;
    while (j < 3) {
        j = j + 1;
        if (i == 2 && j == 1) {
            continue outer;  // è·³è¿‡å†…å±‚å¾ªç¯å‰©ä½™éƒ¨åˆ†ï¼Œç»§ç»­å¤–å±‚å¾ªç¯
        }
        print(i * 10 + j);
    }
}
// å½“ i=2, j=1 æ—¶ï¼šè·³åˆ°å¤–å±‚å¾ªç¯çš„ä¸‹ä¸€æ¬¡è¿­ä»£
```

### For å¾ªç¯ä¸­çš„æ ‡ç­¾

æ ‡ç­¾é€‚ç”¨äºæ‰€æœ‰å¾ªç¯ç±»å‹ï¼š

```hemlock
outer: for (let x = 0; x < 3; x = x + 1) {
    for (let y = 0; y < 3; y = y + 1) {
        if (x == 1 && y == 1) {
            break outer;
        }
        print(x * 10 + y);
    }
}
```

### For-In å¾ªç¯ä¸­çš„æ ‡ç­¾

```hemlock
let arr1 = [1, 2, 3];
let arr2 = [10, 20, 30];

outer: for (let a in arr1) {
    for (let b in arr2) {
        if (a == 2 && b == 20) {
            break outer;
        }
        print(a * 100 + b);
    }
}
```

### Loop å…³é”®å­—ä¸­çš„æ ‡ç­¾

```hemlock
let x = 0;
outer: loop {
    let y = 0;
    loop {
        if (x == 1 && y == 1) {
            break outer;
        }
        print(x * 10 + y);
        y = y + 1;
        if (y >= 3) { break; }
    }
    x = x + 1;
    if (x >= 3) { break; }
}
```

### å¤šé‡æ ‡ç­¾

å¯ä»¥åœ¨ä¸åŒåµŒå¥—å±‚çº§ä½¿ç”¨æ ‡ç­¾ï¼š

```hemlock
outer: for (let a = 0; a < 2; a = a + 1) {
    inner: for (let b = 0; b < 3; b = b + 1) {
        for (let c = 0; c < 3; c = c + 1) {
            if (c == 1) {
                continue inner;  // è·³åˆ°ä¸­é—´å¾ªç¯çš„ä¸‹ä¸€æ¬¡è¿­ä»£
            }
            if (a == 1 && b == 1) {
                break outer;      // é€€å‡ºæœ€å¤–å±‚å¾ªç¯
            }
            print(a * 100 + b * 10 + c);
        }
    }
}
```

### å¸¦æ ‡ç­¾å¾ªç¯ä¸­çš„æ— æ ‡ç­¾ Break/Continue

æ— æ ‡ç­¾çš„ `break` å’Œ `continue` ä»ç„¶æ­£å¸¸å·¥ä½œï¼ˆå½±å“æœ€å†…å±‚å¾ªç¯ï¼‰ï¼Œå³ä½¿å¤–å±‚å¾ªç¯æœ‰æ ‡ç­¾ï¼š

```hemlock
outer: for (let x = 0; x < 3; x = x + 1) {
    for (let y = 0; y < 5; y = y + 1) {
        if (y == 2) {
            break;  // åªé€€å‡ºå†…å±‚å¾ªç¯
        }
        print(x * 10 + y);
    }
}
// è¾“å‡ºï¼š0, 1, 10, 11, 20, 21
```

### æ ‡ç­¾è¯­æ³•

- æ ‡ç­¾æ˜¯æ ‡è¯†ç¬¦åè·Ÿå†’å·
- æ ‡ç­¾å¿…é¡»ç´§æ¥åœ¨å¾ªç¯è¯­å¥ä¹‹å‰ï¼ˆ`while`ã€`for`ã€`loop`ï¼‰
- æ ‡ç­¾åéµå¾ªæ ‡è¯†ç¬¦è§„åˆ™ï¼ˆå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰
- å¸¸è§çº¦å®šï¼š`outer`ã€`inner`ã€`row`ã€`col`ã€æè¿°æ€§åç§°

## Defer è¯­å¥

`defer` è¯­å¥å®‰æ’ä»£ç åœ¨å½“å‰å‡½æ•°è¿”å›æ—¶æ‰§è¡Œã€‚è¿™å¯¹äºæ¸…ç†æ“ä½œå¾ˆæœ‰ç”¨ï¼Œå¦‚å…³é—­æ–‡ä»¶ã€é‡Šæ”¾èµ„æºæˆ–è§£é”ã€‚

### åŸºæœ¬ Defer

```hemlock
fn example() {
    print("start");
    defer print("cleanup");  // å‡½æ•°è¿”å›æ—¶è¿è¡Œ
    print("end");
}

example();
// è¾“å‡ºï¼š
// start
// end
// cleanup
```

**å…³é”®è¡Œä¸ºï¼š**
- å»¶è¿Ÿè¯­å¥åœ¨å‡½æ•°ä½“å®Œæˆ**ä¹‹å**æ‰§è¡Œ
- å»¶è¿Ÿè¯­å¥åœ¨å‡½æ•°è¿”å›ç»™è°ƒç”¨è€…**ä¹‹å‰**æ‰§è¡Œ
- å³ä½¿å‡½æ•°æŠ›å‡ºå¼‚å¸¸ï¼Œå»¶è¿Ÿè¯­å¥ä¹Ÿæ€»æ˜¯æ‰§è¡Œ

### å¤šä¸ª Deferï¼ˆLIFO é¡ºåºï¼‰

å½“ä½¿ç”¨å¤šä¸ª `defer` è¯­å¥æ—¶ï¼Œå®ƒä»¬æŒ‰**ç›¸åé¡ºåº**æ‰§è¡Œï¼ˆåè¿›å…ˆå‡ºï¼‰ï¼š

```hemlock
fn example() {
    defer print("first");   // æœ€åæ‰§è¡Œ
    defer print("second");  // ç¬¬äºŒä¸ªæ‰§è¡Œ
    defer print("third");   // ç¬¬ä¸€ä¸ªæ‰§è¡Œ
    print("body");
}

example();
// è¾“å‡ºï¼š
// body
// third
// second
// first
```

è¿™ç§ LIFO é¡ºåºæ˜¯æœ‰æ„çš„ - å®ƒç¬¦åˆåµŒå¥—èµ„æºæ¸…ç†çš„è‡ªç„¶é¡ºåºï¼ˆåœ¨å¤–éƒ¨èµ„æºä¹‹å‰å…³é—­å†…éƒ¨èµ„æºï¼‰ã€‚

### å¸¦ Return çš„ Defer

å»¶è¿Ÿè¯­å¥åœ¨ `return` è½¬ç§»æ§åˆ¶ä¹‹å‰æ‰§è¡Œï¼š

```hemlock
fn get_value(): i32 {
    defer print("cleanup");
    print("before return");
    return 42;
}

let result = get_value();
print("result:", result);
// è¾“å‡ºï¼š
// before return
// cleanup
// result: 42
```

### å¸¦å¼‚å¸¸çš„ Defer

å³ä½¿æŠ›å‡ºå¼‚å¸¸ï¼Œå»¶è¿Ÿè¯­å¥ä¹Ÿä¼šæ‰§è¡Œï¼š

```hemlock
fn risky() {
    defer print("cleanup 1");
    defer print("cleanup 2");
    print("before throw");
    throw "error!";
    print("after throw");  // æ°¸è¿œä¸ä¼šæ‰§è¡Œ
}

try {
    risky();
} catch (e) {
    print("Caught:", e);
}
// è¾“å‡ºï¼š
// before throw
// cleanup 2
// cleanup 1
// Caught: error!
```

### èµ„æºæ¸…ç†æ¨¡å¼

`defer` çš„ä¸»è¦ç”¨ä¾‹æ˜¯ç¡®ä¿èµ„æºè¢«æ¸…ç†ï¼š

```hemlock
fn process_file(filename: string) {
    let file = open(filename, "r");
    defer file.close();  // å³ä½¿å‡ºé”™ä¹Ÿæ€»æ˜¯å…³é—­

    let content = file.read();
    // ... å¤„ç†å†…å®¹ ...

    // å‡½æ•°è¿”å›æ—¶æ–‡ä»¶è‡ªåŠ¨å…³é—­
}
```

**ä¸ä½¿ç”¨ deferï¼ˆå®¹æ˜“å‡ºé”™ï¼‰ï¼š**
```hemlock
fn process_file_bad(filename: string) {
    let file = open(filename, "r");
    let content = file.read();
    // å¦‚æœè¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œfile.close() æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ï¼
    process(content);
    file.close();
}
```

### å¸¦é—­åŒ…çš„ Defer

Defer å¯ä»¥ä½¿ç”¨é—­åŒ…æ¥æ•è·çŠ¶æ€ï¼š

```hemlock
fn example() {
    let resource = acquire_resource();
    defer fn() {
        print("Releasing resource");
        release(resource);
    }();  // æ³¨æ„ï¼šç«‹å³è°ƒç”¨çš„å‡½æ•°è¡¨è¾¾å¼

    use_resource(resource);
}
```

### ä½•æ—¶ä½¿ç”¨ Defer

**ä½¿ç”¨ defer çš„åœºæ™¯ï¼š**
- å…³é—­æ–‡ä»¶å’Œç½‘ç»œè¿æ¥
- é‡Šæ”¾åˆ†é…çš„å†…å­˜
- é‡Šæ”¾é”å’Œäº’æ–¥é‡
- ä»»ä½•è·å–èµ„æºçš„å‡½æ•°ä¸­çš„æ¸…ç†

**Defer vs Finallyï¼š**
- `defer` å¯¹äºå•èµ„æºæ¸…ç†æ›´ç®€å•
- `try/finally` å¯¹äºå¸¦æ¢å¤çš„å¤æ‚é”™è¯¯å¤„ç†æ›´å¥½

### æœ€ä½³å®è·µ

1. **è·å–èµ„æºåç«‹å³ä½¿ç”¨ deferï¼š**
   ```hemlock
   let file = open("data.txt", "r");
   defer file.close();
   // ... ä½¿ç”¨æ–‡ä»¶ ...
   ```

2. **å¯¹å¤šä¸ªèµ„æºä½¿ç”¨å¤šä¸ª deferï¼š**
   ```hemlock
   let file1 = open("input.txt", "r");
   defer file1.close();

   let file2 = open("output.txt", "w");
   defer file2.close();

   // ä¸¤ä¸ªæ–‡ä»¶å°†æŒ‰ç›¸åé¡ºåºå…³é—­
   ```

3. **è®°ä½ LIFO é¡ºåºç”¨äºä¾èµ–èµ„æºï¼š**
   ```hemlock
   let outer = acquire_outer();
   defer release_outer(outer);

   let inner = acquire_inner(outer);
   defer release_inner(inner);

   // inner åœ¨ outer ä¹‹å‰é‡Šæ”¾ï¼ˆæ­£ç¡®çš„ä¾èµ–é¡ºåºï¼‰
   ```

## å¸ƒå°”è¿ç®—ç¬¦

### é€»è¾‘ä¸ (`&&`)

ä¸¤ä¸ªæ¡ä»¶éƒ½å¿…é¡»ä¸ºçœŸï¼š

```hemlock
if (x > 0 && x < 10) {
    print("single digit positive");
}
```

**çŸ­è·¯æ±‚å€¼ï¼š**
```hemlock
if (false && expensive_check()) {
    // expensive_check() æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨
}
```

### é€»è¾‘æˆ– (`||`)

è‡³å°‘ä¸€ä¸ªæ¡ä»¶å¿…é¡»ä¸ºçœŸï¼š

```hemlock
if (x < 0 || x > 100) {
    print("out of range");
}
```

**çŸ­è·¯æ±‚å€¼ï¼š**
```hemlock
if (true || expensive_check()) {
    // expensive_check() æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨
}
```

### é€»è¾‘é (`!`)

å–åå¸ƒå°”å€¼ï¼š

```hemlock
if (!is_valid) {
    print("invalid");
}

if (!(x > 10)) {
    // ç­‰åŒäºï¼šif (x <= 10)
}
```

## æ¯”è¾ƒè¿ç®—ç¬¦

### ç›¸ç­‰æ€§

```hemlock
if (x == 10) { }    // ç­‰äº
if (x != 10) { }    // ä¸ç­‰äº
```

é€‚ç”¨äºæ‰€æœ‰ç±»å‹ï¼š
```hemlock
"hello" == "hello"  // true
true == false       // false
null == null        // true
```

### å…³ç³»è¿ç®—ç¬¦

```hemlock
if (x < 10) { }     // å°äº
if (x > 10) { }     // å¤§äº
if (x <= 10) { }    // å°äºç­‰äº
if (x >= 10) { }    // å¤§äºç­‰äº
```

**ç±»å‹æå‡é€‚ç”¨ï¼š**
```hemlock
let a: i32 = 10;
let b: i64 = 10;
if (a == b) { }     // trueï¼ˆi32 æå‡ä¸º i64ï¼‰
```

## ä½è¿ç®—ç¬¦

Hemlock æä¾›ç”¨äºæ•´æ•°æ“ä½œçš„ä½è¿ç®—ç¬¦ã€‚è¿™äº›**åªèƒ½ç”¨äºæ•´æ•°ç±»å‹**ï¼ˆi8-i64ã€u8-u64ï¼‰ã€‚

### äºŒå…ƒä½è¿ç®—ç¬¦

**æŒ‰ä½ä¸ (`&`)**
```hemlock
let a = 12;  // äºŒè¿›åˆ¶ 1100
let b = 10;  // äºŒè¿›åˆ¶ 1010
print(a & b);   // 8 (1000)
```

**æŒ‰ä½æˆ– (`|`)**
```hemlock
print(a | b);   // 14 (1110)
```

**æŒ‰ä½å¼‚æˆ– (`^`)**
```hemlock
print(a ^ b);   // 6 (0110)
```

**å·¦ç§» (`<<`)**
```hemlock
print(a << 2);  // 48 (110000) - å·¦ç§» 2 ä½
```

**å³ç§» (`>>`)**
```hemlock
print(a >> 1);  // 6 (110) - å³ç§» 1 ä½
```

### ä¸€å…ƒä½è¿ç®—ç¬¦

**æŒ‰ä½å–å (`~`)**
```hemlock
let a = 12;
print(~a);      // -13ï¼ˆè¡¥ç ï¼‰

let c: u8 = 15;   // äºŒè¿›åˆ¶ 00001111
print(~c);        // 240 (11110000)ï¼Œu8 ç±»å‹
```

### ä½è¿ç®—ç¤ºä¾‹

**ä½¿ç”¨æ— ç¬¦å·ç±»å‹ï¼š**
```hemlock
let c: u8 = 15;   // äºŒè¿›åˆ¶ 00001111
let d: u8 = 7;    // äºŒè¿›åˆ¶ 00000111

print(c & d);     // 7  (00000111)
print(c | d);     // 15 (00001111)
print(c ^ d);     // 8  (00001000)
print(~c);        // 240 (11110000) - u8 ç±»å‹
```

**ç±»å‹ä¿æŒï¼š**
```hemlock
// ä½è¿ç®—ä¿æŒæ“ä½œæ•°çš„ç±»å‹
let x: u8 = 255;
let result = ~x;  // result æ˜¯ u8ï¼Œå€¼ä¸º 0

let y: i32 = 100;
let result2 = y << 2;  // result2 æ˜¯ i32ï¼Œå€¼ä¸º 400
```

**å¸¸è§æ¨¡å¼ï¼š**
```hemlock
// æ£€æŸ¥ä½æ˜¯å¦è®¾ç½®
if (flags & 0x04) {
    print("bit 2 is set");
}

// è®¾ç½®ä½
flags = flags | 0x08;

// æ¸…é™¤ä½
flags = flags & ~0x02;

// åˆ‡æ¢ä½
flags = flags ^ 0x01;
```

### è¿ç®—ç¬¦ä¼˜å…ˆçº§

ä½è¿ç®—ç¬¦éµå¾ª C é£æ ¼ä¼˜å…ˆçº§ï¼š

1. `~`ï¼ˆä¸€å…ƒå–åï¼‰- æœ€é«˜ï¼Œä¸ `!` å’Œ `-` åŒçº§
2. `<<`ã€`>>`ï¼ˆä½ç§»ï¼‰- é«˜äºæ¯”è¾ƒï¼Œä½äº `+`/`-`
3. `&`ï¼ˆæŒ‰ä½ä¸ï¼‰- é«˜äº `^` å’Œ `|`
4. `^`ï¼ˆæŒ‰ä½å¼‚æˆ–ï¼‰- åœ¨ `&` å’Œ `|` ä¹‹é—´
5. `|`ï¼ˆæŒ‰ä½æˆ–ï¼‰- ä½äº `&` å’Œ `^`ï¼Œé«˜äº `&&`
6. `&&`ã€`||`ï¼ˆé€»è¾‘ï¼‰- æœ€ä½ä¼˜å…ˆçº§

**ç¤ºä¾‹ï¼š**
```hemlock
// & ä¼˜å…ˆçº§é«˜äº |
let result1 = 12 | 10 & 8;  // (10 & 8) | 12 = 8 | 12 = 12

// ä½ç§»ä¼˜å…ˆçº§é«˜äºä½è¿ç®—ç¬¦
let result2 = 8 | 1 << 2;   // 8 | (1 << 2) = 8 | 4 = 12

// ä½¿ç”¨æ‹¬å·æé«˜æ¸…æ™°åº¦
let result3 = (5 & 3) | (2 << 1);  // 1 | 4 = 5
```

**é‡è¦æ³¨æ„äº‹é¡¹ï¼š**
- ä½è¿ç®—ç¬¦åªèƒ½ç”¨äºæ•´æ•°ç±»å‹ï¼ˆä¸èƒ½ç”¨äºæµ®ç‚¹æ•°ã€å­—ç¬¦ä¸²ç­‰ï¼‰
- ç±»å‹æå‡éµå¾ªæ ‡å‡†è§„åˆ™ï¼ˆè¾ƒå°ç±»å‹æå‡ä¸ºè¾ƒå¤§ç±»å‹ï¼‰
- å³ç§» (`>>`) å¯¹æœ‰ç¬¦å·ç±»å‹æ˜¯ç®—æœ¯ç§»ä½ï¼Œå¯¹æ— ç¬¦å·ç±»å‹æ˜¯é€»è¾‘ç§»ä½
- ç§»ä½é‡ä¸è¿›è¡ŒèŒƒå›´æ£€æŸ¥ï¼ˆå¤§ç§»ä½é‡çš„è¡Œä¸ºå–å†³äºå¹³å°ï¼‰

## è¿ç®—ç¬¦ä¼˜å…ˆçº§ï¼ˆå®Œæ•´ï¼‰

ä»é«˜åˆ°ä½ä¼˜å…ˆçº§ï¼š

1. **ä¸€å…ƒ**ï¼š`!`ã€`-`ã€`~`
2. **ä¹˜é™¤**ï¼š`*`ã€`/`ã€`%`
3. **åŠ å‡**ï¼š`+`ã€`-`
4. **ä½ç§»**ï¼š`<<`ã€`>>`
5. **å…³ç³»**ï¼š`<`ã€`>`ã€`<=`ã€`>=`
6. **ç›¸ç­‰**ï¼š`==`ã€`!=`
7. **æŒ‰ä½ä¸**ï¼š`&`
8. **æŒ‰ä½å¼‚æˆ–**ï¼š`^`
9. **æŒ‰ä½æˆ–**ï¼š`|`
10. **é€»è¾‘ä¸**ï¼š`&&`
11. **é€»è¾‘æˆ–**ï¼š`||`

**ä½¿ç”¨æ‹¬å·æé«˜æ¸…æ™°åº¦ï¼š**
```hemlock
// ä¸æ¸…æ™°
if (a || b && c) { }

// æ¸…æ™°
if (a || (b && c)) { }
if ((a || b) && c) { }
```

## å¸¸è§æ¨¡å¼

### æ¨¡å¼ï¼šè¾“å…¥éªŒè¯

```hemlock
fn validate_age(age: i32): bool {
    if (age < 0 || age > 150) {
        return false;
    }
    return true;
}
```

### æ¨¡å¼ï¼šèŒƒå›´æ£€æŸ¥

```hemlock
fn in_range(value: i32, min: i32, max: i32): bool {
    return value >= min && value <= max;
}

if (in_range(score, 0, 100)) {
    print("valid score");
}
```

### æ¨¡å¼ï¼šçŠ¶æ€æœº

```hemlock
let state = "start";

while (true) {
    switch (state) {
        case "start":
            print("Starting...");
            state = "running";
            break;

        case "running":
            if (should_pause) {
                state = "paused";
            } else if (should_stop) {
                state = "stopped";
            }
            break;

        case "paused":
            if (should_resume) {
                state = "running";
            }
            break;

        case "stopped":
            print("Stopped");
            break;
    }

    if (state == "stopped") {
        break;
    }
}
```

### æ¨¡å¼ï¼šå¸¦è¿‡æ»¤çš„è¿­ä»£

```hemlock
let arr = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

// åªæ‰“å°å¶æ•°
for (let i = 0; i < arr.length; i = i + 1) {
    if (arr[i] % 2 != 0) {
        continue;  // è·³è¿‡å¥‡æ•°
    }
    print(arr[i]);
}
```

### æ¨¡å¼ï¼šæå‰é€€å‡º

```hemlock
fn find_first_negative(arr: array): i32 {
    for (let i = 0; i < arr.length; i = i + 1) {
        if (arr[i] < 0) {
            return i;  // æå‰é€€å‡º
        }
    }
    return -1;  // æœªæ‰¾åˆ°
}
```

## æœ€ä½³å®è·µ

1. **å§‹ç»ˆä½¿ç”¨èŠ±æ‹¬å·** - å³ä½¿æ˜¯å•è¯­å¥å—ä¹Ÿè¦ï¼ˆè¯­æ³•å¼ºåˆ¶ï¼‰
2. **æ˜¾å¼æ¡ä»¶** - ä½¿ç”¨ `x == 0` è€Œä¸æ˜¯ `!x` ä»¥æé«˜æ¸…æ™°åº¦
3. **é¿å…æ·±å±‚åµŒå¥—** - å°†åµŒå¥—æ¡ä»¶æå–åˆ°å‡½æ•°ä¸­
4. **ä½¿ç”¨æå‰è¿”å›** - ç”¨å®ˆå«å­å¥å‡å°‘åµŒå¥—
5. **åˆ†è§£å¤æ‚æ¡ä»¶** - æ‹†åˆ†ä¸ºå‘½åçš„å¸ƒå°”å˜é‡
6. **switch ä¸­ä½¿ç”¨ default** - å§‹ç»ˆåŒ…å« default case
7. **æ³¨é‡Šè´¯ç©¿** - ä½¿æœ‰æ„çš„è´¯ç©¿æ˜ç¡®

## å¸¸è§é™·é˜±

### é™·é˜±ï¼šæ¡ä»¶ä¸­çš„èµ‹å€¼

```hemlock
// è¿™æ˜¯ä¸å…è®¸çš„ï¼ˆæ¡ä»¶ä¸­ä¸èƒ½èµ‹å€¼ï¼‰
if (x = 10) { }  // é”™è¯¯ï¼šè¯­æ³•é”™è¯¯

// ä½¿ç”¨æ¯”è¾ƒä»£æ›¿
if (x == 10) { }  // OK
```

### é™·é˜±ï¼šSwitch ä¸­ç¼ºå°‘ Break

```hemlock
// æ„å¤–è´¯ç©¿
switch (x) {
    case 1:
        print("one");
        // ç¼ºå°‘ break - ä¼šè´¯ç©¿ï¼
    case 2:
        print("two");  // å¯¹ 1 å’Œ 2 éƒ½æ‰§è¡Œ
        break;
}

// ä¿®å¤ï¼šæ·»åŠ  break
switch (x) {
    case 1:
        print("one");
        break;  // ç°åœ¨æ­£ç¡®
    case 2:
        print("two");
        break;
}
```

### é™·é˜±ï¼šå¾ªç¯å˜é‡ä½œç”¨åŸŸ

```hemlock
// i çš„ä½œç”¨åŸŸé™äºå¾ªç¯
for (let i = 0; i < 10; i = i + 1) {
    print(i);
}
print(i);  // é”™è¯¯ï¼ši åœ¨è¿™é‡Œæœªå®šä¹‰
```

## ç¤ºä¾‹

### ç¤ºä¾‹ï¼šFizzBuzz

```hemlock
for (let i = 1; i <= 100; i = i + 1) {
    if (i % 15 == 0) {
        print("FizzBuzz");
    } else if (i % 3 == 0) {
        print("Fizz");
    } else if (i % 5 == 0) {
        print("Buzz");
    } else {
        print(i);
    }
}
```

### ç¤ºä¾‹ï¼šç´ æ•°æ£€æŸ¥

```hemlock
fn is_prime(n: i32): bool {
    if (n < 2) {
        return false;
    }

    let i = 2;
    while (i * i <= n) {
        if (n % i == 0) {
            return false;
        }
        i = i + 1;
    }

    return true;
}
```

### ç¤ºä¾‹ï¼šèœå•ç³»ç»Ÿ

```hemlock
fn menu() {
    while (true) {
        print("1. Start");
        print("2. Settings");
        print("3. Exit");

        let choice = get_input();

        switch (choice) {
            case 1:
                start_game();
                break;
            case 2:
                show_settings();
                break;
            case 3:
                print("Goodbye!");
                return;
            default:
                print("Invalid choice");
                break;
        }
    }
}
```

## ç›¸å…³ä¸»é¢˜

- [Functions](#language-guide-functions) - å‡½æ•°è°ƒç”¨å’Œè¿”å›çš„æ§åˆ¶æµ
- [Error Handling](#language-guide-error-handling) - å¼‚å¸¸çš„æ§åˆ¶æµ
- [Types](#language-guide-types) - æ¡ä»¶ä¸­çš„ç±»å‹è½¬æ¢

## å¦è¯·å‚é˜…

- **è¯­æ³•**ï¼šå‚è§ [Syntax](#language-guide-syntax) äº†è§£è¯­å¥è¯­æ³•ç»†èŠ‚
- **è¿ç®—ç¬¦**ï¼šå‚è§ [Types](#language-guide-types) äº†è§£è¿ç®—ä¸­çš„ç±»å‹æå‡


--------------------------------------------------------------------------------
## æ•°ç»„
--------------------------------------------------------------------------------

# æ•°ç»„

Hemlock æä¾›**åŠ¨æ€æ•°ç»„**ï¼Œå…·æœ‰å…¨é¢çš„æ•°æ®æ“ä½œå’Œå¤„ç†æ–¹æ³•ã€‚æ•°ç»„å¯ä»¥å­˜å‚¨æ··åˆç±»å‹ï¼Œå¹¶æ ¹æ®éœ€è¦è‡ªåŠ¨å¢é•¿ã€‚

## æ¦‚è¿°

```hemlock
// æ•°ç»„å­—é¢é‡
let arr = [1, 2, 3, 4, 5];
print(arr[0]);         // 1
print(arr.length);     // 5

// å…è®¸æ··åˆç±»å‹
let mixed = [1, "hello", true, null];

// åŠ¨æ€å¤§å°è°ƒæ•´
arr.push(6);           // è‡ªåŠ¨å¢é•¿
arr.push(7);
print(arr.length);     // 7
```

## æ•°ç»„å­—é¢é‡

### åŸºæœ¬è¯­æ³•

```hemlock
let numbers = [1, 2, 3, 4, 5];
let strings = ["apple", "banana", "cherry"];
let booleans = [true, false, true];
```

### ç©ºæ•°ç»„

```hemlock
let arr = [];  // ç©ºæ•°ç»„

// ç¨åæ·»åŠ å…ƒç´ 
arr.push(1);
arr.push(2);
arr.push(3);
```

### æ··åˆç±»å‹

æ•°ç»„å¯ä»¥åŒ…å«ä¸åŒç±»å‹ï¼š

```hemlock
let mixed = [
    42,
    "hello",
    true,
    null,
    [1, 2, 3],
    { x: 10, y: 20 }
];

print(mixed[0]);  // 42
print(mixed[1]);  // "hello"
print(mixed[4]);  // [1, 2, 3]ï¼ˆåµŒå¥—æ•°ç»„ï¼‰
```

### åµŒå¥—æ•°ç»„

```hemlock
let matrix = [
    [1, 2, 3],
    [4, 5, 6],
    [7, 8, 9]
];

print(matrix[0][0]);  // 1
print(matrix[1][2]);  // 6
print(matrix[2][1]);  // 8
```

### ç±»å‹åŒ–æ•°ç»„

æ•°ç»„å¯ä»¥ä½¿ç”¨ç±»å‹æ³¨è§£æ¥å¼ºåˆ¶å…ƒç´ ç±»å‹ï¼š

```hemlock
// ç±»å‹åŒ–æ•°ç»„è¯­æ³•
let nums: array<i32> = [1, 2, 3, 4, 5];
let names: array<string> = ["Alice", "Bob", "Carol"];
let flags: array<bool> = [true, false, true];

// è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥
let valid: array<i32> = [1, 2, 3];       // æ­£ç¡®
let invalid: array<i32> = [1, "two", 3]; // è¿è¡Œæ—¶é”™è¯¯ï¼šç±»å‹ä¸åŒ¹é…

// åµŒå¥—ç±»å‹åŒ–æ•°ç»„
let matrix: array<array<i32>> = [
    [1, 2, 3],
    [4, 5, 6]
];
```

**ç±»å‹æ³¨è§£è¡Œä¸ºï¼š**
- å…ƒç´ åœ¨æ·»åŠ åˆ°æ•°ç»„æ—¶è¿›è¡Œç±»å‹æ£€æŸ¥
- ç±»å‹ä¸åŒ¹é…ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
- æ²¡æœ‰ç±»å‹æ³¨è§£æ—¶ï¼Œæ•°ç»„æ¥å—æ··åˆç±»å‹

## ç´¢å¼•

### è¯»å–å…ƒç´ 

ä»é›¶å¼€å§‹çš„ç´¢å¼•è®¿é—®ï¼š

```hemlock
let arr = [10, 20, 30, 40, 50];

print(arr[0]);  // 10ï¼ˆç¬¬ä¸€ä¸ªå…ƒç´ ï¼‰
print(arr[4]);  // 50ï¼ˆæœ€åä¸€ä¸ªå…ƒç´ ï¼‰

// è¶Šç•Œè®¿é—®è¿”å› nullï¼ˆä¸æŠ¥é”™ï¼‰
print(arr[10]);  // null
```

### å†™å…¥å…ƒç´ 

```hemlock
let arr = [1, 2, 3];

arr[0] = 10;    // ä¿®æ”¹ç°æœ‰å…ƒç´ 
arr[1] = 20;
print(arr);     // [10, 20, 3]

// å¯ä»¥åœ¨è¶…å‡ºå½“å‰é•¿åº¦çš„ä½ç½®èµ‹å€¼ï¼ˆæ•°ç»„ä¼šå¢é•¿ï¼‰
arr[5] = 60;    // åˆ›å»º [10, 20, 3, null, null, 60]
```

### è´Ÿæ•°ç´¢å¼•

**ä¸æ”¯æŒ** - åªèƒ½ä½¿ç”¨æ­£æ•°ç´¢å¼•ï¼š

```hemlock
let arr = [1, 2, 3];
print(arr[-1]);  // é”™è¯¯æˆ–æœªå®šä¹‰è¡Œä¸º

// ä½¿ç”¨ length è·å–æœ€åä¸€ä¸ªå…ƒç´ 
print(arr[arr.length - 1]);  // 3
```

## å±æ€§

### `.length` å±æ€§

è¿”å›å…ƒç´ æ•°é‡ï¼š

```hemlock
let arr = [1, 2, 3, 4, 5];
print(arr.length);  // 5

// ç©ºæ•°ç»„
let empty = [];
print(empty.length);  // 0

// ä¿®æ”¹å
arr.push(6);
print(arr.length);  // 6
```

## æ•°ç»„æ–¹æ³•

Hemlock æä¾› 18 ä¸ªæ•°ç»„æ–¹æ³•ç”¨äºå…¨é¢çš„æ“ä½œã€‚

### æ ˆæ“ä½œ

**`push(value)`** - åœ¨æœ«å°¾æ·»åŠ å…ƒç´ ï¼š
```hemlock
let arr = [1, 2, 3];
arr.push(4);           // [1, 2, 3, 4]
arr.push(5);           // [1, 2, 3, 4, 5]

print(arr.length);     // 5
```

**`pop()`** - ç§»é™¤å¹¶è¿”å›æœ€åä¸€ä¸ªå…ƒç´ ï¼š
```hemlock
let arr = [1, 2, 3, 4, 5];
let last = arr.pop();  // è¿”å› 5ï¼Œarr ç°åœ¨æ˜¯ [1, 2, 3, 4]

print(last);           // 5
print(arr.length);     // 4
```

### é˜Ÿåˆ—æ“ä½œ

**`shift()`** - ç§»é™¤å¹¶è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ ï¼š
```hemlock
let arr = [1, 2, 3];
let first = arr.shift();   // è¿”å› 1ï¼Œarr ç°åœ¨æ˜¯ [2, 3]

print(first);              // 1
print(arr);                // [2, 3]
```

**`unshift(value)`** - åœ¨å¼€å¤´æ·»åŠ å…ƒç´ ï¼š
```hemlock
let arr = [2, 3];
arr.unshift(1);            // [1, 2, 3]
arr.unshift(0);            // [0, 1, 2, 3]
```

### æ’å…¥å’Œåˆ é™¤

**`insert(index, value)`** - åœ¨æŒ‡å®šç´¢å¼•å¤„æ’å…¥å…ƒç´ ï¼š
```hemlock
let arr = [1, 2, 4, 5];
arr.insert(2, 3);      // åœ¨ç´¢å¼• 2 å¤„æ’å…¥ 3ï¼š[1, 2, 3, 4, 5]

arr.insert(0, 0);      // åœ¨å¼€å¤´æ’å…¥ï¼š[0, 1, 2, 3, 4, 5]
```

**`remove(index)`** - ç§»é™¤å¹¶è¿”å›æŒ‡å®šç´¢å¼•å¤„çš„å…ƒç´ ï¼š
```hemlock
let arr = [1, 2, 3, 4, 5];
let removed = arr.remove(2);  // è¿”å› 3ï¼Œarr ç°åœ¨æ˜¯ [1, 2, 4, 5]

print(removed);               // 3
print(arr);                   // [1, 2, 4, 5]
```

### æœç´¢æ“ä½œ

**`find(value)`** - æŸ¥æ‰¾é¦–æ¬¡å‡ºç°çš„ä½ç½®ï¼š
```hemlock
let arr = [10, 20, 30, 40];
let idx = arr.find(30);      // 2ï¼ˆé¦–æ¬¡å‡ºç°çš„ç´¢å¼•ï¼‰
let idx2 = arr.find(99);     // -1ï¼ˆæœªæ‰¾åˆ°ï¼‰

// é€‚ç”¨äºä»»ä½•ç±»å‹
let words = ["apple", "banana", "cherry"];
let idx3 = words.find("banana");  // 1
```

**`contains(value)`** - æ£€æŸ¥æ•°ç»„æ˜¯å¦åŒ…å«æŸå€¼ï¼š
```hemlock
let arr = [10, 20, 30, 40];
let has = arr.contains(20);  // true
let has2 = arr.contains(99); // false
```

### æå–æ“ä½œ

**`slice(start, end)`** - æå–å­æ•°ç»„ï¼ˆend ä¸åŒ…å«åœ¨å†…ï¼‰ï¼š
```hemlock
let arr = [1, 2, 3, 4, 5];
let sub = arr.slice(1, 4);   // [2, 3, 4]ï¼ˆç´¢å¼• 1, 2, 3ï¼‰
let first = arr.slice(0, 2); // [1, 2]

// åŸæ•°ç»„ä¸å˜
print(arr);                  // [1, 2, 3, 4, 5]
```

**`first()`** - è·å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆä¸ç§»é™¤ï¼‰ï¼š
```hemlock
let arr = [1, 2, 3];
let f = arr.first();         // 1ï¼ˆä¸ç§»é™¤ï¼‰
print(arr);                  // [1, 2, 3]ï¼ˆä¸å˜ï¼‰
```

**`last()`** - è·å–æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆä¸ç§»é™¤ï¼‰ï¼š
```hemlock
let arr = [1, 2, 3];
let l = arr.last();          // 3ï¼ˆä¸ç§»é™¤ï¼‰
print(arr);                  // [1, 2, 3]ï¼ˆä¸å˜ï¼‰
```

### è½¬æ¢æ“ä½œ

**`reverse()`** - åŸåœ°åè½¬æ•°ç»„ï¼š
```hemlock
let arr = [1, 2, 3, 4, 5];
arr.reverse();               // [5, 4, 3, 2, 1]

print(arr);                  // [5, 4, 3, 2, 1]ï¼ˆå·²ä¿®æ”¹ï¼‰
```

**`join(delimiter)`** - å°†å…ƒç´ è¿æ¥æˆå­—ç¬¦ä¸²ï¼š
```hemlock
let words = ["hello", "world", "foo"];
let joined = words.join(" ");  // "hello world foo"

let numbers = [1, 2, 3];
let csv = numbers.join(",");   // "1,2,3"

// é€‚ç”¨äºæ··åˆç±»å‹
let mixed = [1, "hello", true, null];
print(mixed.join(" | "));  // "1 | hello | true | null"
```

**`concat(other)`** - ä¸å¦ä¸€ä¸ªæ•°ç»„è¿æ¥ï¼š
```hemlock
let a = [1, 2, 3];
let b = [4, 5, 6];
let combined = a.concat(b);  // [1, 2, 3, 4, 5, 6]ï¼ˆæ–°æ•°ç»„ï¼‰

// åŸæ•°ç»„ä¸å˜
print(a);                    // [1, 2, 3]
print(b);                    // [4, 5, 6]
```

### å®ç”¨æ“ä½œ

**`clear()`** - ç§»é™¤æ‰€æœ‰å…ƒç´ ï¼š
```hemlock
let arr = [1, 2, 3, 4, 5];
arr.clear();                 // []

print(arr.length);           // 0
print(arr);                  // []
```

## æ–¹æ³•é“¾å¼è°ƒç”¨

è¿”å›æ•°ç»„æˆ–å€¼çš„æ–¹æ³•å¯ä»¥è¿›è¡Œé“¾å¼è°ƒç”¨ï¼š

```hemlock
let result = [1, 2, 3]
    .concat([4, 5, 6])
    .slice(2, 5);  // [3, 4, 5]

let text = ["apple", "banana", "cherry"]
    .slice(0, 2)
    .join(" and ");  // "apple and banana"

let numbers = [5, 3, 8, 1, 9]
    .slice(1, 4)
    .concat([10, 11]);  // [3, 8, 1, 10, 11]
```

## å®Œæ•´æ–¹æ³•å‚è€ƒ

| æ–¹æ³• | å‚æ•° | è¿”å›å€¼ | æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ | æè¿° |
|--------|-----------|---------|---------|-------------|
| `push(value)` | any | void | æ˜¯ | åœ¨æœ«å°¾æ·»åŠ å…ƒç´  |
| `pop()` | - | any | æ˜¯ | ç§»é™¤å¹¶è¿”å›æœ€åä¸€ä¸ªå…ƒç´  |
| `shift()` | - | any | æ˜¯ | ç§»é™¤å¹¶è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´  |
| `unshift(value)` | any | void | æ˜¯ | åœ¨å¼€å¤´æ·»åŠ å…ƒç´  |
| `insert(index, value)` | i32, any | void | æ˜¯ | åœ¨æŒ‡å®šç´¢å¼•å¤„æ’å…¥ |
| `remove(index)` | i32 | any | æ˜¯ | ç§»é™¤å¹¶è¿”å›æŒ‡å®šç´¢å¼•å¤„çš„å…ƒç´  |
| `find(value)` | any | i32 | å¦ | æŸ¥æ‰¾é¦–æ¬¡å‡ºç°çš„ä½ç½®ï¼ˆæœªæ‰¾åˆ°è¿”å› -1ï¼‰ |
| `contains(value)` | any | bool | å¦ | æ£€æŸ¥æ˜¯å¦åŒ…å«æŸå€¼ |
| `slice(start, end)` | i32, i32 | array | å¦ | æå–å­æ•°ç»„ï¼ˆæ–°æ•°ç»„ï¼‰ |
| `join(delimiter)` | string | string | å¦ | è¿æ¥æˆå­—ç¬¦ä¸² |
| `concat(other)` | array | array | å¦ | è¿æ¥æ•°ç»„ï¼ˆæ–°æ•°ç»„ï¼‰ |
| `reverse()` | - | void | æ˜¯ | åŸåœ°åè½¬ |
| `first()` | - | any | å¦ | è·å–ç¬¬ä¸€ä¸ªå…ƒç´  |
| `last()` | - | any | å¦ | è·å–æœ€åä¸€ä¸ªå…ƒç´  |
| `clear()` | - | void | æ˜¯ | ç§»é™¤æ‰€æœ‰å…ƒç´  |
| `map(callback)` | fn | array | å¦ | è½¬æ¢æ¯ä¸ªå…ƒç´  |
| `filter(predicate)` | fn | array | å¦ | é€‰æ‹©åŒ¹é…çš„å…ƒç´  |
| `reduce(callback, initial)` | fn, any | any | å¦ | å½’çº¦ä¸ºå•ä¸ªå€¼ |

## å®ç°ç»†èŠ‚

### å†…å­˜æ¨¡å‹

- **å †åˆ†é…** - åŠ¨æ€å®¹é‡
- **è‡ªåŠ¨å¢é•¿** - è¶…å‡ºå®¹é‡æ—¶ç¿»å€
- **ä¸è‡ªåŠ¨æ”¶ç¼©** - å®¹é‡ä¸ä¼šå‡å°‘
- **ç´¢å¼•æ— è¾¹ç•Œæ£€æŸ¥** - ä½¿ç”¨æ–¹æ³•ä»¥ç¡®ä¿å®‰å…¨

### å®¹é‡ç®¡ç†

```hemlock
let arr = [];  // åˆå§‹å®¹é‡ï¼š0

arr.push(1);   // å¢é•¿åˆ°å®¹é‡ 1
arr.push(2);   // å¢é•¿åˆ°å®¹é‡ 2
arr.push(3);   // å¢é•¿åˆ°å®¹é‡ 4ï¼ˆç¿»å€ï¼‰
arr.push(4);   // ä»ç„¶æ˜¯å®¹é‡ 4
arr.push(5);   // å¢é•¿åˆ°å®¹é‡ 8ï¼ˆç¿»å€ï¼‰
```

### å€¼æ¯”è¾ƒ

`find()` å’Œ `contains()` ä½¿ç”¨å€¼ç›¸ç­‰æ¯”è¾ƒï¼š

```hemlock
// åŸºæœ¬ç±»å‹ï¼šæŒ‰å€¼æ¯”è¾ƒ
let arr = [1, 2, 3];
arr.contains(2);  // true

// å­—ç¬¦ä¸²ï¼šæŒ‰å€¼æ¯”è¾ƒ
let words = ["hello", "world"];
words.contains("hello");  // true

// å¯¹è±¡ï¼šæŒ‰å¼•ç”¨æ¯”è¾ƒ
let obj1 = { x: 10 };
let obj2 = { x: 10 };
let arr2 = [obj1];
arr2.contains(obj1);  // trueï¼ˆç›¸åŒå¼•ç”¨ï¼‰
arr2.contains(obj2);  // falseï¼ˆä¸åŒå¼•ç”¨ï¼‰
```

## å¸¸è§æ¨¡å¼

### å‡½æ•°å¼æ“ä½œï¼ˆmap/filter/reduceï¼‰

æ•°ç»„å†…ç½® `map`ã€`filter` å’Œ `reduce` æ–¹æ³•ï¼š

```hemlock
// map - è½¬æ¢æ¯ä¸ªå…ƒç´ 
let numbers = [1, 2, 3, 4, 5];
let doubled = numbers.map(fn(x) { return x * 2; });
print(doubled);  // [2, 4, 6, 8, 10]

// filter - é€‰æ‹©åŒ¹é…çš„å…ƒç´ 
let evens = numbers.filter(fn(x) { return x % 2 == 0; });
print(evens);  // [2, 4]

// reduce - å½’çº¦ä¸ºå•ä¸ªå€¼
let sum = numbers.reduce(fn(acc, x) { return acc + x; }, 0);
print(sum);  // 15

// é“¾å¼è°ƒç”¨å‡½æ•°å¼æ“ä½œ
let result = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    .filter(fn(x) { return x % 2 == 0; })  // [2, 4, 6, 8, 10]
    .map(fn(x) { return x * x; })          // [4, 16, 36, 64, 100]
    .reduce(fn(acc, x) { return acc + x; }, 0);  // 220
```

### æ¨¡å¼ï¼šæ•°ç»„ä½œä¸ºæ ˆ

```hemlock
let stack = [];

// å‹å…¥æ ˆ
stack.push(1);
stack.push(2);
stack.push(3);

// å¼¹å‡ºæ ˆ
let top = stack.pop();    // 3
let next = stack.pop();   // 2
```

### æ¨¡å¼ï¼šæ•°ç»„ä½œä¸ºé˜Ÿåˆ—

```hemlock
let queue = [];

// å…¥é˜Ÿï¼ˆæ·»åŠ åˆ°æœ«å°¾ï¼‰
queue.push(1);
queue.push(2);
queue.push(3);

// å‡ºé˜Ÿï¼ˆä»å‰é¢ç§»é™¤ï¼‰
let first = queue.shift();   // 1
let second = queue.shift();  // 2
```

## æœ€ä½³å®è·µ

1. **ä½¿ç”¨æ–¹æ³•è€Œéç›´æ¥ç´¢å¼•** - è¾¹ç•Œæ£€æŸ¥å’Œä»£ç æ¸…æ™°åº¦
2. **æ£€æŸ¥è¾¹ç•Œ** - ç›´æ¥ç´¢å¼•ä¸è¿›è¡Œè¾¹ç•Œæ£€æŸ¥
3. **ä¼˜å…ˆä½¿ç”¨ä¸å¯å˜æ“ä½œ** - ä½¿ç”¨ `slice()` å’Œ `concat()` è€Œéä¿®æ”¹åŸæ•°ç»„
4. **é¢„å…ˆåˆå§‹åŒ–å®¹é‡** - å¦‚æœçŸ¥é“å¤§å°ï¼ˆç›®å‰ä¸æ”¯æŒï¼‰
5. **ä½¿ç”¨ `contains()` æ£€æŸ¥æˆå‘˜** - æ¯”æ‰‹åŠ¨å¾ªç¯æ›´æ¸…æ™°
6. **é“¾å¼è°ƒç”¨æ–¹æ³•** - æ¯”åµŒå¥—è°ƒç”¨æ›´æ˜“è¯»

## å¸¸è§é™·é˜±

### é™·é˜±ï¼šç›´æ¥ç´¢å¼•è¶Šç•Œ

```hemlock
let arr = [1, 2, 3];

// æ— è¾¹ç•Œæ£€æŸ¥ï¼
arr[10] = 99;  // åˆ›å»ºå¸¦æœ‰ null çš„ç¨€ç–æ•°ç»„
print(arr.length);  // 11ï¼ˆä¸æ˜¯ 3ï¼ï¼‰

// æ›´å¥½çš„åšæ³•ï¼šä½¿ç”¨ push() æˆ–æ£€æŸ¥é•¿åº¦
if (arr.length <= 10) {
    arr.push(99);
}
```

### é™·é˜±ï¼šä¿®æ”¹ä¸æ–°å»ºæ•°ç»„

```hemlock
let arr = [1, 2, 3];

// ä¿®æ”¹åŸæ•°ç»„
arr.reverse();
print(arr);  // [3, 2, 1]

// è¿”å›æ–°æ•°ç»„
let sub = arr.slice(0, 2);
print(arr);  // [3, 2, 1]ï¼ˆä¸å˜ï¼‰
print(sub);  // [3, 2]
```

### é™·é˜±ï¼šå¼•ç”¨ç›¸ç­‰

```hemlock
let obj = { x: 10 };
let arr = [obj];

// ç›¸åŒå¼•ç”¨ï¼štrue
arr.contains(obj);  // true

// ä¸åŒå¼•ç”¨ï¼šfalse
arr.contains({ x: 10 });  // falseï¼ˆä¸åŒå¯¹è±¡ï¼‰
```

### é™·é˜±ï¼šé•¿æœŸå­˜æ´»çš„æ•°ç»„

```hemlock
// å±€éƒ¨ä½œç”¨åŸŸä¸­çš„æ•°ç»„ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œä½†å…¨å±€/é•¿æœŸå­˜æ´»çš„æ•°ç»„éœ€è¦æ³¨æ„
let global_cache = [];  // æ¨¡å—çº§åˆ«ï¼ŒæŒç»­åˆ°ç¨‹åºé€€å‡º

fn add_to_cache(item) {
    global_cache.push(item);  // æ— é™å¢é•¿
}

// å¯¹äºé•¿æœŸå­˜æ´»çš„æ•°æ®ï¼Œè€ƒè™‘ï¼š
// - å®šæœŸæ¸…ç©ºæ•°ç»„ï¼šglobal_cache.clear();
// - æå‰é‡Šæ”¾ï¼šfree(global_cache);
```

## ç¤ºä¾‹

### ç¤ºä¾‹ï¼šæ•°ç»„ç»Ÿè®¡

```hemlock
fn mean(arr) {
    let sum = 0;
    let i = 0;
    while (i < arr.length) {
        sum = sum + arr[i];
        i = i + 1;
    }
    return sum / arr.length;
}

fn max(arr) {
    if (arr.length == 0) {
        return null;
    }

    let max_val = arr[0];
    let i = 1;
    while (i < arr.length) {
        if (arr[i] > max_val) {
            max_val = arr[i];
        }
        i = i + 1;
    }
    return max_val;
}

let numbers = [3, 7, 2, 9, 1];
print(mean(numbers));  // 4.4
print(max(numbers));   // 9
```

### ç¤ºä¾‹ï¼šæ•°ç»„å»é‡

```hemlock
fn unique(arr) {
    let result = [];
    let i = 0;
    while (i < arr.length) {
        if (!result.contains(arr[i])) {
            result.push(arr[i]);
        }
        i = i + 1;
    }
    return result;
}

let numbers = [1, 2, 2, 3, 1, 4, 3, 5];
let uniq = unique(numbers);  // [1, 2, 3, 4, 5]
```

### ç¤ºä¾‹ï¼šæ•°ç»„åˆ†å—

```hemlock
fn chunk(arr, size) {
    let result = [];
    let i = 0;

    while (i < arr.length) {
        let chunk = arr.slice(i, i + size);
        result.push(chunk);
        i = i + size;
    }

    return result;
}

let numbers = [1, 2, 3, 4, 5, 6, 7, 8];
let chunks = chunk(numbers, 3);
// [[1, 2, 3], [4, 5, 6], [7, 8]]
```

### ç¤ºä¾‹ï¼šæ•°ç»„æ‰å¹³åŒ–

```hemlock
fn flatten(arr) {
    let result = [];
    let i = 0;

    while (i < arr.length) {
        if (typeof(arr[i]) == "array") {
            // åµŒå¥—æ•°ç»„ - æ‰å¹³åŒ–å®ƒ
            let nested = flatten(arr[i]);
            let j = 0;
            while (j < nested.length) {
                result.push(nested[j]);
                j = j + 1;
            }
        } else {
            result.push(arr[i]);
        }
        i = i + 1;
    }

    return result;
}

let nested = [1, [2, 3], [4, [5, 6]], 7];
let flat = flatten(nested);  // [1, 2, 3, 4, 5, 6, 7]
```

### ç¤ºä¾‹ï¼šæ’åºï¼ˆå†’æ³¡æ’åºï¼‰

```hemlock
fn sort(arr) {
    let n = arr.length;
    let i = 0;

    while (i < n) {
        let j = 0;
        while (j < n - i - 1) {
            if (arr[j] > arr[j + 1]) {
                // äº¤æ¢
                let temp = arr[j];
                arr[j] = arr[j + 1];
                arr[j + 1] = temp;
            }
            j = j + 1;
        }
        i = i + 1;
    }
}

let numbers = [5, 2, 8, 1, 9];
sort(numbers);  // åŸåœ°ä¿®æ”¹
print(numbers);  // [1, 2, 5, 8, 9]
```

## é™åˆ¶

å½“å‰é™åˆ¶ï¼š

- **ç´¢å¼•æ— è¾¹ç•Œæ£€æŸ¥** - ç›´æ¥è®¿é—®ä¸æ£€æŸ¥è¾¹ç•Œ
- **å¯¹è±¡ä½¿ç”¨å¼•ç”¨ç›¸ç­‰** - `find()` å’Œ `contains()` ä½¿ç”¨å¼•ç”¨æ¯”è¾ƒ
- **æ— æ•°ç»„è§£æ„** - ä¸æ”¯æŒ `let [a, b] = arr` è¯­æ³•
- **æ— å±•å¼€è¿ç®—ç¬¦** - ä¸æ”¯æŒ `[...arr1, ...arr2]` è¯­æ³•

**æ³¨æ„ï¼š** æ•°ç»„ä½¿ç”¨å¼•ç”¨è®¡æ•°ï¼Œä½œç”¨åŸŸé€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚è¯¦è§ [å†…å­˜ç®¡ç†](memory.md#internal-reference-counting)ã€‚

## ç›¸å…³ä¸»é¢˜

- [å­—ç¬¦ä¸²](#language-guide-strings) - å­—ç¬¦ä¸²æ–¹æ³•ä¸æ•°ç»„æ–¹æ³•ç±»ä¼¼
- [å¯¹è±¡](#language-guide-objects) - æ•°ç»„ä¹Ÿæ˜¯ç±»å¯¹è±¡çš„
- [å‡½æ•°](#language-guide-functions) - æ•°ç»„ä¸é«˜é˜¶å‡½æ•°
- [æ§åˆ¶æµ](#language-guide-control-flow) - éå†æ•°ç»„

## å¦è¯·å‚é˜…

- **åŠ¨æ€å¤§å°**ï¼šæ•°ç»„é€šè¿‡å®¹é‡ç¿»å€è‡ªåŠ¨å¢é•¿
- **æ–¹æ³•**ï¼š18 ä¸ªå…¨é¢çš„æ“ä½œæ–¹æ³•ï¼ŒåŒ…æ‹¬ map/filter/reduce
- **å†…å­˜**ï¼šè¯¦è§ [å†…å­˜](#language-guide-memory) äº†è§£æ•°ç»„åˆ†é…ç»†èŠ‚


--------------------------------------------------------------------------------
## æ¨¡å—
--------------------------------------------------------------------------------

# Hemlock æ¨¡å—ç³»ç»Ÿ

æœ¬æ–‡æ¡£æè¿°äº†ä¸º Hemlock å®ç°çš„ ES6 é£æ ¼ import/export æ¨¡å—ç³»ç»Ÿã€‚

## æ¦‚è¿°

Hemlock æ”¯æŒåŸºäºæ–‡ä»¶çš„æ¨¡å—ç³»ç»Ÿï¼Œä½¿ç”¨ ES6 é£æ ¼çš„ import/export è¯­æ³•ã€‚æ¨¡å—å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
- **å•ä¾‹**ï¼šæ¯ä¸ªæ¨¡å—åªåŠ è½½ä¸€æ¬¡å¹¶è¢«ç¼“å­˜
- **åŸºäºæ–‡ä»¶**ï¼šæ¨¡å—å¯¹åº”ç£ç›˜ä¸Šçš„ .hml æ–‡ä»¶
- **æ˜¾å¼å¯¼å…¥**ï¼šä¾èµ–é€šè¿‡ import è¯­å¥å£°æ˜
- **æ‹“æ‰‘æ‰§è¡Œ**ï¼šä¾èµ–åœ¨ä¾èµ–è€…ä¹‹å‰æ‰§è¡Œ

æœ‰å…³åŒ…ç®¡ç†å’Œç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œè¯·å‚é˜… [hpm (Hemlock åŒ…ç®¡ç†å™¨)](https://github.com/hemlang/hpm)ã€‚

## è¯­æ³•

### Export è¯­å¥

**å†…è”å‘½åå¯¼å‡ºï¼š**
```hemlock
export fn add(a, b) {
    return a + b;
}

export const PI = 3.14159;
export let counter = 0;
```

**å¯¼å‡ºåˆ—è¡¨ï¼š**
```hemlock
fn add(a, b) { return a + b; }
fn subtract(a, b) { return a - b; }

export { add, subtract };
```

**å¯¼å‡º Externï¼ˆFFI å‡½æ•°ï¼‰ï¼š**
```hemlock
import "libc.so.6";

// å¯¼å‡º FFI å‡½æ•°ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
export extern fn strlen(s: string): i32;
export extern fn getpid(): i32;
```

æœ‰å…³å¯¼å‡º FFI å‡½æ•°çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [FFI æ–‡æ¡£](../advanced/ffi.md#exporting-ffi-functions)ã€‚

**å¯¼å‡º Defineï¼ˆç»“æ„ä½“ç±»å‹ï¼‰ï¼š**
```hemlock
// å¯¼å‡ºç»“æ„ä½“ç±»å‹å®šä¹‰
export define Vector2 {
    x: f32,
    y: f32,
}

export define Rectangle {
    x: f32,
    y: f32,
    width: f32,
    height: f32,
}
```

**é‡è¦è¯´æ˜ï¼š** å¯¼å‡ºçš„ç»“æ„ä½“ç±»å‹åœ¨æ¨¡å—åŠ è½½æ—¶å…¨å±€æ³¨å†Œã€‚å½“ä½ ä»æ¨¡å—å¯¼å…¥ä»»ä½•å†…å®¹æ—¶ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨å¯ç”¨ - ä½ ä¸éœ€è¦ï¼ˆä¹Ÿä¸èƒ½ï¼‰é€šè¿‡åç§°æ˜¾å¼å¯¼å…¥å®ƒä»¬ï¼š

```hemlock
// æ­£ç¡® - ä»»ä½•å¯¼å…¥åç»“æ„ä½“ç±»å‹è‡ªåŠ¨å¯ç”¨
import { some_function } from "./my_module.hml";
let v: Vector2 = { x: 1.0, y: 2.0 };  // å¯ä»¥å·¥ä½œï¼

// é”™è¯¯ - ä¸èƒ½æ˜¾å¼å¯¼å…¥ç»“æ„ä½“ç±»å‹
import { Vector2 } from "./my_module.hml";  // é”™è¯¯ï¼šæœªå®šä¹‰å˜é‡ 'Vector2'
```

æœ‰å…³å¯¼å‡ºç»“æ„ä½“ç±»å‹çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [FFI æ–‡æ¡£](../advanced/ffi.md#exporting-struct-types)ã€‚

**é‡æ–°å¯¼å‡ºï¼š**
```hemlock
// ä»å¦ä¸€ä¸ªæ¨¡å—é‡æ–°å¯¼å‡º
export { add, subtract } from "./math.hml";
```

### Import è¯­å¥

**å‘½åå¯¼å…¥ï¼š**
```hemlock
import { add, subtract } from "./math.hml";
print(add(1, 2));  // 3
```

**å‘½åç©ºé—´å¯¼å…¥ï¼š**
```hemlock
import * as math from "./math.hml";
print(math.add(1, 2));  // 3
print(math.PI);  // 3.14159
```

**åˆ«åï¼š**
```hemlock
import { add as sum, subtract as diff } from "./math.hml";
print(sum(1, 2));  // 3
```

## æ¨¡å—è§£æ

### è·¯å¾„ç±»å‹

**ç›¸å¯¹è·¯å¾„ï¼š**
```hemlock
import { foo } from "./module.hml";       // åŒä¸€ç›®å½•
import { bar } from "../parent.hml";      // çˆ¶ç›®å½•
import { baz } from "./sub/nested.hml";   // å­ç›®å½•
```

**ç»å¯¹è·¯å¾„ï¼š**
```hemlock
import { foo } from "/absolute/path/to/module.hml";
```

**æ‰©å±•åå¤„ç†ï¼š**
- `.hml` æ‰©å±•åå¯ä»¥çœç•¥ - ä¼šè‡ªåŠ¨æ·»åŠ 
- `./math` è§£æä¸º `./math.hml`

## ç‰¹æ€§

### å¾ªç¯ä¾èµ–æ£€æµ‹

æ¨¡å—ç³»ç»Ÿæ£€æµ‹å¾ªç¯ä¾èµ–å¹¶æŠ¥å‘Šé”™è¯¯ï¼š

```
Error: Circular dependency detected when loading '/path/to/a.hml'
```

### æ¨¡å—ç¼“å­˜

æ¨¡å—åªåŠ è½½ä¸€æ¬¡å¹¶è¢«ç¼“å­˜ã€‚å¤šæ¬¡å¯¼å…¥åŒä¸€æ¨¡å—è¿”å›ç›¸åŒçš„å®ä¾‹ï¼š

```hemlock
// counter.hml
export let count = 0;
export fn increment() {
    count = count + 1;
}

// a.hml
import { count, increment } from "./counter.hml";
increment();
print(count);  // 1

// b.hml
import { count } from "./counter.hml";  // åŒä¸€å®ä¾‹ï¼
print(count);  // ä»ç„¶æ˜¯ 1ï¼ˆå…±äº«çŠ¶æ€ï¼‰
```

### å¯¼å…¥ä¸å¯å˜æ€§

å¯¼å…¥çš„ç»‘å®šä¸èƒ½è¢«é‡æ–°èµ‹å€¼ï¼š

```hemlock
import { add } from "./math.hml";
add = fn() { };  // é”™è¯¯ï¼šä¸èƒ½é‡æ–°èµ‹å€¼å¯¼å…¥çš„ç»‘å®š
```

## å®ç°ç»†èŠ‚

### æ¶æ„

**æ–‡ä»¶ï¼š**
- `include/module.h` - æ¨¡å—ç³»ç»Ÿ API
- `src/module.c` - æ¨¡å—åŠ è½½ã€ç¼“å­˜å’Œæ‰§è¡Œ
- `src/parser.c` ä¸­çš„è§£æå™¨æ”¯æŒ
- `src/interpreter/runtime.c` ä¸­çš„è¿è¡Œæ—¶æ”¯æŒ

**å…³é”®ç»„ä»¶ï¼š**
1. **ModuleCache**ï¼šæŒ‰ç»å¯¹è·¯å¾„ç´¢å¼•ç»´æŠ¤å·²åŠ è½½çš„æ¨¡å—
2. **Module**ï¼šè¡¨ç¤ºå¸¦æœ‰ AST å’Œå¯¼å‡ºçš„å·²åŠ è½½æ¨¡å—
3. **è·¯å¾„è§£æ**ï¼šå°†ç›¸å¯¹/ç»å¯¹è·¯å¾„è§£æä¸ºè§„èŒƒè·¯å¾„
4. **æ‹“æ‰‘æ‰§è¡Œ**ï¼šæŒ‰ä¾èµ–é¡ºåºæ‰§è¡Œæ¨¡å—

### æ¨¡å—åŠ è½½è¿‡ç¨‹

1. **è§£æé˜¶æ®µ**ï¼šå¯¹æ¨¡å—æ–‡ä»¶è¿›è¡Œè¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æ
2. **ä¾èµ–è§£æ**ï¼šé€’å½’åŠ è½½å¯¼å…¥çš„æ¨¡å—
3. **å¾ªç¯æ£€æµ‹**ï¼šæ£€æŸ¥æ¨¡å—æ˜¯å¦å·²åœ¨åŠ è½½ä¸­
4. **ç¼“å­˜**ï¼šæŒ‰ç»å¯¹è·¯å¾„å°†æ¨¡å—å­˜å‚¨åœ¨ç¼“å­˜ä¸­
5. **æ‰§è¡Œé˜¶æ®µ**ï¼šæŒ‰æ‹“æ‰‘é¡ºåºæ‰§è¡Œï¼ˆä¾èµ–ä¼˜å…ˆï¼‰

### API

```c
// é«˜çº§ API
int execute_file_with_modules(const char *file_path,
                               int argc, char **argv,
                               ExecutionContext *ctx);

// ä½çº§ API
ModuleCache* module_cache_new(const char *initial_dir);
void module_cache_free(ModuleCache *cache);
Module* load_module(ModuleCache *cache, const char *module_path, ExecutionContext *ctx);
void execute_module(Module *module, ModuleCache *cache, ExecutionContext *ctx);
```

## æµ‹è¯•

æµ‹è¯•æ¨¡å—ä½äº `tests/modules/` å’Œ `tests/parity/modules/`ï¼š

- `math.hml` - å¸¦å¯¼å‡ºçš„åŸºæœ¬æ¨¡å—
- `test_import_named.hml` - å‘½åå¯¼å…¥æµ‹è¯•
- `test_import_namespace.hml` - å‘½åç©ºé—´å¯¼å…¥æµ‹è¯•
- `test_import_alias.hml` - å¯¼å…¥åˆ«åæµ‹è¯•
- `export_extern.hml` - å¯¼å‡º extern FFI å‡½æ•°æµ‹è¯•ï¼ˆLinuxï¼‰

## åŒ…å¯¼å…¥ï¼ˆhpmï¼‰

å®‰è£… [hpm](https://github.com/hemlang/hpm) åï¼Œä½ å¯ä»¥ä» GitHub å¯¼å…¥ç¬¬ä¸‰æ–¹åŒ…ï¼š

```hemlock
// ä»åŒ…æ ¹ç›®å½•å¯¼å…¥ï¼ˆä½¿ç”¨ package.json ä¸­çš„ "main"ï¼‰
import { app, router } from "hemlang/sprout";

// ä»å­è·¯å¾„å¯¼å…¥
import { middleware } from "hemlang/sprout/middleware";

// æ ‡å‡†åº“ï¼ˆå†…ç½®äº Hemlockï¼‰
import { HashMap } from "@stdlib/collections";
```

åŒ…å®‰è£…åˆ° `hem_modules/` å¹¶ä½¿ç”¨ GitHub `owner/repo` è¯­æ³•è§£æã€‚

```bash
# å®‰è£…åŒ…
hpm install hemlang/sprout

# å¸¦ç‰ˆæœ¬çº¦æŸå®‰è£…
hpm install hemlang/sprout@^1.0.0
```

æœ‰å…³å®Œæ•´è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [hpm æ–‡æ¡£](https://github.com/hemlang/hpm)ã€‚

## å½“å‰é™åˆ¶

1. **ä¸æ”¯æŒåŠ¨æ€å¯¼å…¥**ï¼š`import()` ä½œä¸ºè¿è¡Œæ—¶å‡½æ•°ä¸å—æ”¯æŒ
2. **ä¸æ”¯æŒæ¡ä»¶å¯¼å‡º**ï¼šå¯¼å‡ºå¿…é¡»åœ¨é¡¶å±‚
3. **é™æ€åº“è·¯å¾„**ï¼šFFI åº“å¯¼å…¥ä½¿ç”¨é™æ€è·¯å¾„ï¼ˆç‰¹å®šäºå¹³å°ï¼‰

## æœªæ¥å·¥ä½œ

- ä½¿ç”¨ `import()` å‡½æ•°çš„åŠ¨æ€å¯¼å…¥
- æ¡ä»¶å¯¼å‡º
- æ¨¡å—å…ƒæ•°æ®ï¼ˆ`import.meta`ï¼‰
- Tree shaking å’Œæ­»ä»£ç æ¶ˆé™¤

## ç¤ºä¾‹

æœ‰å…³æ¨¡å—ç³»ç»Ÿçš„å·¥ä½œç¤ºä¾‹ï¼Œè¯·å‚é˜… `tests/modules/`ã€‚

ç¤ºä¾‹æ¨¡å—ç»“æ„ï¼š
```
project/
â”œâ”€â”€ main.hml
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ math.hml
â”‚   â”œâ”€â”€ string.hml
â”‚   â””â”€â”€ index.hml (barrel æ¨¡å—)
â””â”€â”€ utils/
    â””â”€â”€ helpers.hml
```

ç¤ºä¾‹ç”¨æ³•ï¼š
```hemlock
// lib/math.hml
export fn add(a, b) { return a + b; }
export fn multiply(a, b) { return a * b; }

// lib/index.hml (barrel)
export { add, multiply } from "./math.hml";

// main.hml
import { add } from "./lib/index.hml";
print(add(2, 3));  // 5
```


--------------------------------------------------------------------------------
## æ¨¡å¼åŒ¹é…
--------------------------------------------------------------------------------

# æ¨¡å¼åŒ¹é…

Hemlock é€šè¿‡ `match` è¡¨è¾¾å¼æä¾›å¼ºå¤§çš„æ¨¡å¼åŒ¹é…åŠŸèƒ½ï¼Œæä¾›äº†ä¸€ç§ç®€æ´çš„æ–¹å¼æ¥è§£æ„å€¼ã€æ£€æŸ¥ç±»å‹å’Œå¤„ç†å¤šç§æƒ…å†µã€‚

## åŸºæœ¬è¯­æ³•

```hemlock
let result = match (value) {
    pattern1 => expression1,
    pattern2 => expression2,
    _ => default_expression
};
```

match è¡¨è¾¾å¼æŒ‰é¡ºåºå°† `value` ä¸æ¯ä¸ªæ¨¡å¼è¿›è¡ŒåŒ¹é…ï¼Œè¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…åˆ†æ”¯çš„è¡¨è¾¾å¼ç»“æœã€‚

## æ¨¡å¼ç±»å‹

### å­—é¢é‡æ¨¡å¼

åŒ¹é…ç²¾ç¡®å€¼ï¼š

```hemlock
let x = 42;
let msg = match (x) {
    0 => "zero",
    1 => "one",
    42 => "the answer",
    _ => "other"
};
print(msg);  // "the answer"
```

æ”¯æŒçš„å­—é¢é‡ï¼š
- **æ•´æ•°**ï¼š`0`ã€`42`ã€`-5`
- **æµ®ç‚¹æ•°**ï¼š`3.14`ã€`-0.5`
- **å­—ç¬¦ä¸²**ï¼š`"hello"`ã€`"world"`
- **å¸ƒå°”å€¼**ï¼š`true`ã€`false`
- **ç©ºå€¼**ï¼š`null`

### é€šé…ç¬¦æ¨¡å¼ï¼ˆ`_`ï¼‰

åŒ¹é…ä»»ä½•å€¼ä½†ä¸ç»‘å®šï¼š

```hemlock
let x = "anything";
let result = match (x) {
    "specific" => "found it",
    _ => "wildcard matched"
};
```

### å˜é‡ç»‘å®šæ¨¡å¼

å°†åŒ¹é…çš„å€¼ç»‘å®šåˆ°å˜é‡ï¼š

```hemlock
let x = 100;
let result = match (x) {
    0 => "zero",
    n => "value is " + n  // n ç»‘å®šåˆ° 100
};
print(result);  // "value is 100"
```

### OR æ¨¡å¼ï¼ˆ`|`ï¼‰

åŒ¹é…å¤šä¸ªæ›¿ä»£é¡¹ï¼š

```hemlock
let x = 2;
let size = match (x) {
    1 | 2 | 3 => "small",
    4 | 5 | 6 => "medium",
    _ => "large"
};

// ä¹Ÿé€‚ç”¨äºå­—ç¬¦ä¸²
let cmd = "quit";
let action = match (cmd) {
    "exit" | "quit" | "q" => "exiting",
    "help" | "h" | "?" => "showing help",
    _ => "unknown"
};
```

### å®ˆå«è¡¨è¾¾å¼ï¼ˆ`if`ï¼‰

ä¸ºæ¨¡å¼æ·»åŠ æ¡ä»¶ï¼š

```hemlock
let x = 15;
let category = match (x) {
    n if n < 0 => "negative",
    n if n == 0 => "zero",
    n if n < 10 => "small",
    n if n < 100 => "medium",
    n => "large: " + n
};
print(category);  // "medium"

// å¤æ‚å®ˆå«
let y = 12;
let result = match (y) {
    n if n % 2 == 0 && n > 10 => "even and greater than 10",
    n if n % 2 == 0 => "even",
    n => "odd"
};
```

### ç±»å‹æ¨¡å¼

åŸºäºç±»å‹æ£€æŸ¥å’Œç»‘å®šï¼š

```hemlock
let val = 42;
let desc = match (val) {
    num: i32 => "integer: " + num,
    str: string => "string: " + str,
    flag: bool => "boolean: " + flag,
    _ => "other type"
};
print(desc);  // "integer: 42"
```

æ”¯æŒçš„ç±»å‹ï¼š`i8`ã€`i16`ã€`i32`ã€`i64`ã€`u8`ã€`u16`ã€`u32`ã€`u64`ã€`f32`ã€`f64`ã€`bool`ã€`string`ã€`array`ã€`object`

## è§£æ„æ¨¡å¼

### å¯¹è±¡è§£æ„

ä»å¯¹è±¡ä¸­æå–å­—æ®µï¼š

```hemlock
let point = { x: 10, y: 20 };
let result = match (point) {
    { x, y } => "point at " + x + "," + y
};
print(result);  // "point at 10,20"

// å¸¦å­—é¢é‡å­—æ®µå€¼
let origin = { x: 0, y: 0 };
let name = match (origin) {
    { x: 0, y: 0 } => "origin",
    { x: 0, y } => "on y-axis at " + y,
    { x, y: 0 } => "on x-axis at " + x,
    { x, y } => "point at " + x + "," + y
};
print(name);  // "origin"
```

### æ•°ç»„è§£æ„

åŒ¹é…æ•°ç»„ç»“æ„å’Œå…ƒç´ ï¼š

```hemlock
let arr = [1, 2, 3];
let desc = match (arr) {
    [] => "empty",
    [x] => "single: " + x,
    [x, y] => "pair: " + x + "," + y,
    [x, y, z] => "triple: " + x + "," + y + "," + z,
    _ => "many elements"
};
print(desc);  // "triple: 1,2,3"

// å¸¦å­—é¢é‡å€¼
let pair = [1, 2];
let result = match (pair) {
    [0, 0] => "both zero",
    [1, x] => "starts with 1, second is " + x,
    [x, 1] => "ends with 1",
    _ => "other"
};
print(result);  // "starts with 1, second is 2"
```

### æ•°ç»„å‰©ä½™æ¨¡å¼ï¼ˆ`...`ï¼‰

æ•è·å‰©ä½™å…ƒç´ ï¼š

```hemlock
let nums = [1, 2, 3, 4, 5];

// å¤´éƒ¨å’Œå°¾éƒ¨
let result = match (nums) {
    [first, ...rest] => "first: " + first,
    [] => "empty"
};
print(result);  // "first: 1"

// å‰ä¸¤ä¸ªå…ƒç´ 
let result2 = match (nums) {
    [a, b, ...rest] => "first two: " + a + "," + b,
    _ => "too short"
};
print(result2);  // "first two: 1,2"
```

### åµŒå¥—è§£æ„

ç»„åˆæ¨¡å¼å¤„ç†å¤æ‚æ•°æ®ï¼š

```hemlock
let user = {
    name: "Alice",
    address: { city: "NYC", zip: 10001 }
};

let result = match (user) {
    { name, address: { city, zip } } => name + " lives in " + city,
    _ => "unknown"
};
print(result);  // "Alice lives in NYC"

// åŒ…å«æ•°ç»„çš„å¯¹è±¡
let data = { items: [1, 2, 3], count: 3 };
let result2 = match (data) {
    { items: [first, ...rest], count } => "first: " + first + ", total: " + count,
    _ => "no items"
};
print(result2);  // "first: 1, total: 3"
```

## Match ä½œä¸ºè¡¨è¾¾å¼

Match æ˜¯ä¸€ä¸ªè¿”å›å€¼çš„è¡¨è¾¾å¼ï¼š

```hemlock
// ç›´æ¥èµ‹å€¼
let grade = 85;
let letter = match (grade) {
    n if n >= 90 => "A",
    n if n >= 80 => "B",
    n if n >= 70 => "C",
    n if n >= 60 => "D",
    _ => "F"
};

// åœ¨å­—ç¬¦ä¸²è¿æ¥ä¸­
let msg = "Grade: " + match (grade) {
    n if n >= 70 => "passing",
    _ => "failing"
};

// åœ¨å‡½æ•°è¿”å›ä¸­
fn classify(n: i32): string {
    return match (n) {
        0 => "zero",
        n if n > 0 => "positive",
        _ => "negative"
    };
}
```

## æ¨¡å¼åŒ¹é…æœ€ä½³å®è·µ

1. **é¡ºåºå¾ˆé‡è¦**ï¼šæ¨¡å¼ä»ä¸Šåˆ°ä¸‹æ£€æŸ¥ï¼›å°†ç‰¹å®šæ¨¡å¼æ”¾åœ¨é€šç”¨æ¨¡å¼ä¹‹å‰
2. **ä½¿ç”¨é€šé…ç¬¦ç¡®ä¿å®Œæ•´æ€§**ï¼šé™¤éç¡®å®šæ‰€æœ‰æƒ…å†µéƒ½å·²è¦†ç›–ï¼Œå¦åˆ™å§‹ç»ˆåŒ…å« `_` å›é€€
3. **ä¼˜å…ˆä½¿ç”¨å®ˆå«è€ŒéåµŒå¥—æ¡ä»¶**ï¼šå®ˆå«ä½¿æ„å›¾æ›´æ¸…æ™°
4. **ä½¿ç”¨è§£æ„è€Œéæ‰‹åŠ¨å­—æ®µè®¿é—®**ï¼šæ›´ç®€æ´ä¸”æ›´å®‰å…¨

```hemlock
// å¥½ï¼šä½¿ç”¨å®ˆå«è¿›è¡ŒèŒƒå›´æ£€æŸ¥
match (score) {
    n if n >= 90 => "A",
    n if n >= 80 => "B",
    _ => "below B"
}

// å¥½ï¼šè§£æ„è€Œéè®¿é—®å­—æ®µ
match (point) {
    { x: 0, y: 0 } => "origin",
    { x, y } => "at " + x + "," + y
}

// é¿å…ï¼šè¿‡äºå¤æ‚çš„åµŒå¥—æ¨¡å¼
// è€ƒè™‘æ‹†åˆ†ä¸ºå¤šä¸ª match æˆ–ä½¿ç”¨å®ˆå«
```

## ä¸å…¶ä»–è¯­è¨€çš„æ¯”è¾ƒ

| ç‰¹æ€§ | Hemlock | Rust | JavaScript |
|---------|---------|------|------------|
| åŸºæœ¬åŒ¹é… | `match (x) { ... }` | `match x { ... }` | `switch (x) { ... }` |
| è§£æ„ | æ˜¯ | æ˜¯ | éƒ¨åˆ†ï¼ˆswitch ä¸è§£æ„ï¼‰ |
| å®ˆå« | `n if n > 0 =>` | `n if n > 0 =>` | ä¸é€‚ç”¨ |
| OR æ¨¡å¼ | `1 \| 2 \| 3 =>` | `1 \| 2 \| 3 =>` | `case 1: case 2: case 3:` |
| å‰©ä½™æ¨¡å¼ | `[a, ...rest]` | `[a, rest @ ..]` | ä¸é€‚ç”¨ |
| ç±»å‹æ¨¡å¼ | `n: i32` | é€šè¿‡ `match` åˆ†æ”¯çš„ç±»å‹ | ä¸é€‚ç”¨ |
| è¿”å›å€¼ | æ˜¯ | æ˜¯ | å¦ï¼ˆè¯­å¥ï¼‰ |

## å®ç°è¯´æ˜

æ¨¡å¼åŒ¹é…åœ¨è§£é‡Šå™¨å’Œç¼–è¯‘å™¨åç«¯éƒ½å®ç°äº†å®Œå…¨ä¸€è‡´æ€§ - ä¸¤è€…å¯¹ç›¸åŒè¾“å…¥äº§ç”Ÿç›¸åŒçš„ç»“æœã€‚è¯¥åŠŸèƒ½åœ¨ Hemlock v1.8.0+ ä¸­å¯ç”¨ã€‚


--------------------------------------------------------------------------------
## ç±»å‹
--------------------------------------------------------------------------------

# ç±»å‹ç³»ç»Ÿ

Hemlock å…·æœ‰**åŠ¨æ€ç±»å‹ç³»ç»Ÿ**ï¼Œæ”¯æŒå¯é€‰çš„ç±»å‹æ³¨è§£å’Œè¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ã€‚

---

## ç±»å‹é€‰æ‹©æŒ‡å—ï¼šæˆ‘åº”è¯¥ä½¿ç”¨ä»€ä¹ˆç±»å‹ï¼Ÿ

**ç±»å‹æ–°æ‰‹ï¼Ÿ** ä»è¿™é‡Œå¼€å§‹ã€‚å¦‚æœä½ ç†Ÿæ‚‰ç±»å‹ç³»ç»Ÿï¼Œå¯ä»¥è·³åˆ°[è®¾è®¡ç†å¿µ](#è®¾è®¡ç†å¿µ)ã€‚

### ç®€çŸ­ç­”æ¡ˆ

**è®© Hemlock è‡ªåŠ¨åˆ¤æ–­ï¼š**

```hemlock
let count = 42;        // Hemlock çŸ¥é“è¿™æ˜¯æ•´æ•°
let price = 19.99;     // Hemlock çŸ¥é“è¿™æ˜¯å°æ•°
let name = "Alice";    // Hemlock çŸ¥é“è¿™æ˜¯æ–‡æœ¬
let active = true;     // Hemlock çŸ¥é“è¿™æ˜¯å¸ƒå°”å€¼
```

Hemlock ä¼šè‡ªåŠ¨ä¸ºä½ çš„å€¼é€‰æ‹©æ­£ç¡®çš„ç±»å‹ã€‚ä½ *ä¸éœ€è¦*æŒ‡å®šç±»å‹ã€‚

### ä½•æ—¶æ·»åŠ ç±»å‹æ³¨è§£

åœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ·»åŠ ç±»å‹ï¼š

1. **éœ€è¦æŒ‡å®šå¤§å°** - `i8` ä¸ `i64` å¯¹äºå†…å­˜æˆ– FFI å¾ˆé‡è¦
2. **è®°å½•ä»£ç ** - ç±»å‹æ˜¾ç¤ºå‡½æ•°æœŸæœ›ä»€ä¹ˆ
3. **å°½æ—©å‘ç°é”™è¯¯** - Hemlock åœ¨è¿è¡Œæ—¶æ£€æŸ¥ç±»å‹

```hemlock
// æ— ç±»å‹ï¼ˆæ­£å¸¸å·¥ä½œï¼‰ï¼š
fn add(a, b) {
    return a + b;
}

// æœ‰ç±»å‹ï¼ˆæ›´æ˜ç¡®ï¼‰ï¼š
fn add(a: i32, b: i32): i32 {
    return a + b;
}
```

### å¿«é€Ÿå‚è€ƒï¼šé€‰æ‹©æ•°å­—ç±»å‹

| å­˜å‚¨å†…å®¹ | å»ºè®®ç±»å‹ | ç¤ºä¾‹ |
|---------|---------|------|
| æ™®é€šæ•´æ•° | `i32`ï¼ˆé»˜è®¤ï¼‰ | `let count = 42;` |
| éå¸¸å¤§çš„æ•°å­— | `i64` | `let population = 8000000000;` |
| æ°¸ä¸ä¸ºè´Ÿçš„è®¡æ•° | `u32` | `let items: u32 = 100;` |
| å­—èŠ‚ (0-255) | `u8` | `let pixel: u8 = 255;` |
| å°æ•°/åˆ†æ•° | `f64`ï¼ˆé»˜è®¤ï¼‰ | `let price = 19.99;` |
| æ€§èƒ½å…³é”®çš„å°æ•° | `f32` | `let x: f32 = 1.5;` |

### å¿«é€Ÿå‚è€ƒï¼šæ‰€æœ‰ç±»å‹

| ç±»åˆ« | ç±»å‹ | ä½•æ—¶ä½¿ç”¨ |
|-----|------|---------|
| **æ•´æ•°** | `i8`, `i16`, `i32`, `i64` | è®¡æ•°ã€IDã€å¹´é¾„ç­‰ |
| **ä»…æ­£æ•°** | `u8`, `u16`, `u32`, `u64` | å­—èŠ‚ã€å¤§å°ã€æ•°ç»„é•¿åº¦ |
| **å°æ•°** | `f32`, `f64` | é‡‘é¢ã€æµ‹é‡å€¼ã€æ•°å­¦è®¡ç®— |
| **æ˜¯/å¦** | `bool` | æ ‡å¿—ã€æ¡ä»¶ |
| **æ–‡æœ¬** | `string` | åç§°ã€æ¶ˆæ¯ã€ä»»ä½•æ–‡æœ¬ |
| **å•ä¸ªå­—ç¬¦** | `rune` | å•ä¸ªå­—æ¯ã€è¡¨æƒ…ç¬¦å· |
| **åˆ—è¡¨** | `array` | å€¼çš„é›†åˆ |
| **å‘½åå­—æ®µ** | `object` | åˆ†ç»„ç›¸å…³æ•°æ® |
| **åŸå§‹å†…å­˜** | `ptr`, `buffer` | ä½çº§ç¼–ç¨‹ |
| **ç©ºå€¼** | `null` | è¡¨ç¤ºæ²¡æœ‰å€¼ |

### å¸¸è§åœºæ™¯

**"æˆ‘åªéœ€è¦ä¸€ä¸ªæ•°å­—"**
```hemlock
let x = 42;  // å®Œæˆï¼Hemlock é€‰æ‹© i32
```

**"æˆ‘éœ€è¦å°æ•°"**
```hemlock
let price = 19.99;  // å®Œæˆï¼Hemlock é€‰æ‹© f64
```

**"æˆ‘åœ¨å¤„ç†å­—èŠ‚ï¼ˆæ–‡ä»¶ã€ç½‘ç»œï¼‰"**
```hemlock
let byte: u8 = 255;  // 0-255 èŒƒå›´
```

**"æˆ‘éœ€è¦éå¸¸å¤§çš„æ•°å­—"**
```hemlock
let big = 9000000000000;  // Hemlock è‡ªåŠ¨é€‰æ‹© i64ï¼ˆ> i32 æœ€å¤§å€¼ï¼‰
// æˆ–è€…æ˜ç¡®æŒ‡å®šï¼š
let big: i64 = 9000000000000;
```

**"æˆ‘åœ¨å­˜å‚¨é‡‘é¢"**
```hemlock
// é€‰é¡¹ 1ï¼šæµ®ç‚¹æ•°ï¼ˆç®€å•ï¼Œä½†æœ‰ç²¾åº¦é™åˆ¶ï¼‰
let price: f64 = 19.99;

// é€‰é¡¹ 2ï¼šä»¥åˆ†ä¸ºå•ä½å­˜å‚¨ï¼ˆæ›´ç²¾ç¡®ï¼‰
let price_cents: i32 = 1999;  // $19.99 ä½œä¸ºæ•´æ•°åˆ†
```

**"æˆ‘åœ¨å‘ C ä»£ç ä¼ é€’æ•°æ® (FFI)"**
```hemlock
// ç²¾ç¡®åŒ¹é… C ç±»å‹
let c_int: i32 = 100;      // C 'int'
let c_long: i64 = 100;     // C 'long'ï¼ˆ64 ä½ç³»ç»Ÿï¼‰
let c_char: u8 = 65;       // C 'char'
let c_double: f64 = 3.14;  // C 'double'
```

### ç±»å‹æ··åˆæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

å½“ä½ ç»„åˆä¸åŒç±»å‹æ—¶ï¼ŒHemlock ä¼šæå‡ä¸º"æ›´å¤§"çš„ç±»å‹ï¼š

```hemlock
let a: i32 = 10;
let b: f64 = 2.5;
let result = a + b;  // result æ˜¯ f64 (12.5)
// æ•´æ•°è‡ªåŠ¨å˜æˆäº†å°æ•°
```

**ç»éªŒæ³•åˆ™ï¼š** æµ®ç‚¹æ•°æ€»æ˜¯"èµ¢" - ä»»ä½•æ•´æ•°ä¸æµ®ç‚¹æ•°æ··åˆéƒ½ä¼šå¾—åˆ°æµ®ç‚¹æ•°ã€‚

### ç±»å‹é”™è¯¯

å¦‚æœä½ å°è¯•ä½¿ç”¨é”™è¯¯çš„ç±»å‹ï¼ŒHemlock ä¼šåœ¨è¿è¡Œæ—¶å‘Šè¯‰ä½ ï¼š

```hemlock
let age: i32 = "thirty";  // é”™è¯¯ï¼šç±»å‹ä¸åŒ¹é… - æœŸæœ› i32ï¼Œå¾—åˆ° string
```

è¦è½¬æ¢ç±»å‹ï¼Œä½¿ç”¨ç±»å‹æ„é€ å‡½æ•°ï¼š

```hemlock
let text = "42";
let number = i32(text);   // è§£æå­—ç¬¦ä¸²ä¸ºæ•´æ•°ï¼š42
let back = text + "";     // å·²ç»æ˜¯å­—ç¬¦ä¸²
```

---

## è®¾è®¡ç†å¿µ

- **é»˜è®¤åŠ¨æ€** - æ¯ä¸ªå€¼éƒ½æœ‰è¿è¡Œæ—¶ç±»å‹æ ‡ç­¾
- **å¯é€‰ç±»å‹** - å¯é€‰çš„ç±»å‹æ³¨è§£å¼ºåˆ¶è¿è¡Œæ—¶æ£€æŸ¥
- **æ˜¾å¼è½¬æ¢** - éšå¼è½¬æ¢éµå¾ªæ˜ç¡®çš„æå‡è§„åˆ™
- **ç±»å‹è¯šå®** - `typeof()` å§‹ç»ˆè¯´å®è¯

## åŸå§‹ç±»å‹

### æ•´æ•°ç±»å‹

**æœ‰ç¬¦å·æ•´æ•°ï¼š**
```hemlock
let tiny: i8 = 127;              // 8 ä½ï¼ˆ-128 åˆ° 127ï¼‰
let small: i16 = 32767;          // 16 ä½ï¼ˆ-32768 åˆ° 32767ï¼‰
let normal: i32 = 2147483647;    // 32 ä½ï¼ˆé»˜è®¤ï¼‰
let large: i64 = 9223372036854775807;  // 64 ä½
```

**æ— ç¬¦å·æ•´æ•°ï¼š**
```hemlock
let byte: u8 = 255;              // 8 ä½ï¼ˆ0 åˆ° 255ï¼‰
let word: u16 = 65535;           // 16 ä½ï¼ˆ0 åˆ° 65535ï¼‰
let dword: u32 = 4294967295;     // 32 ä½ï¼ˆ0 åˆ° 4294967295ï¼‰
let qword: u64 = 18446744073709551615;  // 64 ä½
```

**ç±»å‹åˆ«åï¼š**
```hemlock
let i: integer = 42;   // i32 çš„åˆ«å
let b: byte = 255;     // u8 çš„åˆ«å
```

### æµ®ç‚¹ç±»å‹

```hemlock
let f: f32 = 3.14159;        // 32 ä½æµ®ç‚¹æ•°
let d: f64 = 2.718281828;    // 64 ä½æµ®ç‚¹æ•°ï¼ˆé»˜è®¤ï¼‰
let n: number = 1.618;       // f64 çš„åˆ«å
```

### å¸ƒå°”ç±»å‹

```hemlock
let flag: bool = true;
let active: bool = false;
```

### å­—ç¬¦ä¸²ç±»å‹

```hemlock
let text: string = "Hello, World!";
let empty: string = "";
```

å­—ç¬¦ä¸²æ˜¯**å¯å˜çš„**ã€**UTF-8 ç¼–ç çš„**ã€**å †åˆ†é…çš„**ã€‚

è¯¦è§ [Strings](#language-guide-strings)ã€‚

### Rune ç±»å‹

```hemlock
let ch: rune = 'A';
let emoji: rune = 'ğŸš€';
let newline: rune = '\n';
let unicode: rune = '\u{1F680}';
```

Rune è¡¨ç¤º **Unicode ç ç‚¹**ï¼ˆU+0000 åˆ° U+10FFFFï¼‰ã€‚

è¯¦è§ [Runes](#language-guide-runes)ã€‚

### Null ç±»å‹

```hemlock
let nothing = null;
let uninitialized: string = null;
```

`null` æ˜¯å…·æœ‰å•ä¸€å€¼çš„ç‹¬ç«‹ç±»å‹ã€‚

## å¤åˆç±»å‹

### æ•°ç»„ç±»å‹

```hemlock
let numbers: array = [1, 2, 3, 4, 5];
let mixed = [1, "two", true, null];  // å…è®¸æ··åˆç±»å‹
let empty: array = [];
```

è¯¦è§ [Arrays](#language-guide-arrays)ã€‚

### å¯¹è±¡ç±»å‹

```hemlock
let obj: object = { x: 10, y: 20 };
let person = { name: "Alice", age: 30 };
```

è¯¦è§ [Objects](#language-guide-objects)ã€‚

### æŒ‡é’ˆç±»å‹

**åŸå§‹æŒ‡é’ˆï¼š**
```hemlock
let p: ptr = alloc(64);
// æ— è¾¹ç•Œæ£€æŸ¥ï¼Œæ‰‹åŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
free(p);
```

**å®‰å…¨ç¼“å†²åŒºï¼š**
```hemlock
let buf: buffer = buffer(64);
// æœ‰è¾¹ç•Œæ£€æŸ¥ï¼Œè·Ÿè¸ªé•¿åº¦å’Œå®¹é‡
free(buf);
```

è¯¦è§ [Memory Management](#language-guide-memory)ã€‚

## æšä¸¾ç±»å‹

æšä¸¾å®šä¹‰ä¸€ç»„å‘½åå¸¸é‡ï¼š

### åŸºæœ¬æšä¸¾

```hemlock
enum Color {
    RED,
    GREEN,
    BLUE
}

let c = Color.RED;
print(c);              // 0
print(typeof(c));      // "Color"

// æ¯”è¾ƒ
if (c == Color.RED) {
    print("It's red!");
}

// åœ¨æšä¸¾ä¸Šä½¿ç”¨ switch
switch (c) {
    case Color.RED:
        print("Stop");
        break;
    case Color.GREEN:
        print("Go");
        break;
    case Color.BLUE:
        print("Blue?");
        break;
}
```

### å¸¦å€¼çš„æšä¸¾

æšä¸¾å¯ä»¥æœ‰æ˜¾å¼çš„æ•´æ•°å€¼ï¼š

```hemlock
enum Status {
    OK = 0,
    ERROR = 1,
    PENDING = 2
}

print(Status.OK);      // 0
print(Status.ERROR);   // 1

enum HttpCode {
    OK = 200,
    NOT_FOUND = 404,
    SERVER_ERROR = 500
}

let code = HttpCode.NOT_FOUND;
print(code);           // 404
```

### è‡ªåŠ¨é€’å¢å€¼

æ²¡æœ‰æ˜¾å¼å€¼æ—¶ï¼Œæšä¸¾ä» 0 è‡ªåŠ¨é€’å¢ï¼š

```hemlock
enum Priority {
    LOW,       // 0
    MEDIUM,    // 1
    HIGH,      // 2
    CRITICAL   // 3
}

// å¯ä»¥æ··åˆæ˜¾å¼å’Œè‡ªåŠ¨å€¼
enum Level {
    DEBUG = 10,
    INFO,      // 11
    WARN,      // 12
    ERROR = 50,
    FATAL      // 51
}
```

### æšä¸¾ä½¿ç”¨æ¨¡å¼

```hemlock
// ä½œä¸ºå‡½æ•°å‚æ•°
fn set_priority(p: Priority) {
    if (p == Priority.CRITICAL) {
        print("Urgent!");
    }
}

set_priority(Priority.HIGH);

// åœ¨å¯¹è±¡ä¸­
define Task {
    name: string,
    priority: Priority
}

let task: Task = {
    name: "Fix bug",
    priority: Priority.HIGH
};
```

## ç‰¹æ®Šç±»å‹

### æ–‡ä»¶ç±»å‹

```hemlock
let f: file = open("data.txt", "r");
f.close();
```

è¡¨ç¤ºæ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ã€‚

### ä»»åŠ¡ç±»å‹

```hemlock
async fn compute(): i32 { return 42; }
let task = spawn(compute);
let result: i32 = join(task);
```

è¡¨ç¤ºå¼‚æ­¥ä»»åŠ¡å¥æŸ„ã€‚

### é€šé“ç±»å‹

```hemlock
let ch: channel = channel(10);
ch.send(42);
let value = ch.recv();
```

è¡¨ç¤ºä»»åŠ¡ä¹‹é—´çš„é€šä¿¡é€šé“ã€‚

### Void ç±»å‹

```hemlock
extern fn exit(code: i32): void;
```

ç”¨äºä¸è¿”å›å€¼çš„å‡½æ•°ï¼ˆä»…é™ FFIï¼‰ã€‚

## ç±»å‹æ¨æ–­

### æ•´æ•°å­—é¢é‡æ¨æ–­

Hemlock æ ¹æ®å€¼èŒƒå›´æ¨æ–­æ•´æ•°ç±»å‹ï¼š

```hemlock
let a = 42;              // i32ï¼ˆé€‚åˆ 32 ä½ï¼‰
let b = 5000000000;      // i64ï¼ˆ> i32 æœ€å¤§å€¼ï¼‰
let c = 128;             // i32
let d: u8 = 128;         // u8ï¼ˆæ˜¾å¼æ³¨è§£ï¼‰
```

**è§„åˆ™ï¼š**
- i32 èŒƒå›´å†…çš„å€¼ï¼ˆ-2147483648 åˆ° 2147483647ï¼‰ï¼šæ¨æ–­ä¸º `i32`
- è¶…å‡º i32 èŒƒå›´ä½†åœ¨ i64 èŒƒå›´å†…çš„å€¼ï¼šæ¨æ–­ä¸º `i64`
- å…¶ä»–ç±»å‹ï¼ˆi8ã€i16ã€u8ã€u16ã€u32ã€u64ï¼‰ä½¿ç”¨æ˜¾å¼æ³¨è§£

### æµ®ç‚¹å­—é¢é‡æ¨æ–­

```hemlock
let x = 3.14;        // f64ï¼ˆé»˜è®¤ï¼‰
let y: f32 = 3.14;   // f32ï¼ˆæ˜¾å¼ï¼‰
```

### ç§‘å­¦è®¡æ•°æ³•

Hemlock æ”¯æŒæ•°å­—å­—é¢é‡çš„ç§‘å­¦è®¡æ•°æ³•ï¼š

```hemlock
let a = 1e10;        // 10000000000.0 (f64)
let b = 1e-12;       // 0.000000000001 (f64)
let c = 3.14e2;      // 314.0 (f64)
let d = 2.5e-3;      // 0.0025 (f64)
let e = 1E10;        // å¤§å°å†™ä¸æ•æ„Ÿ
let f = 1e+5;        // æ˜¾å¼æ­£æŒ‡æ•°
```

**æ³¨æ„ï¼š** ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•çš„ä»»ä½•å­—é¢é‡å§‹ç»ˆæ¨æ–­ä¸º `f64`ã€‚

### å…¶ä»–ç±»å‹æ¨æ–­

```hemlock
let s = "hello";     // string
let ch = 'A';        // rune
let flag = true;     // bool
let arr = [1, 2, 3]; // array
let obj = { x: 10 }; // object
let nothing = null;  // null
```

## ç±»å‹æ³¨è§£

### å˜é‡æ³¨è§£

```hemlock
let age: i32 = 30;
let ratio: f64 = 1.618;
let name: string = "Alice";
```

### å‡½æ•°å‚æ•°æ³¨è§£

```hemlock
fn greet(name: string, age: i32) {
    print("Hello, " + name + "!");
}
```

### å‡½æ•°è¿”å›ç±»å‹æ³¨è§£

```hemlock
fn add(a: i32, b: i32): i32 {
    return a + b;
}
```

### å¯¹è±¡ç±»å‹æ³¨è§£ï¼ˆé¸­å­ç±»å‹ï¼‰

```hemlock
define Person {
    name: string,
    age: i32,
}

let p: Person = { name: "Bob", age: 25 };
```

## ç±»å‹æ£€æŸ¥

### è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥

ç±»å‹æ³¨è§£åœ¨**è¿è¡Œæ—¶**æ£€æŸ¥ï¼Œè€Œä¸æ˜¯ç¼–è¯‘æ—¶ï¼š

```hemlock
let x: i32 = 42;     // OK
let y: i32 = 3.14;   // è¿è¡Œæ—¶é”™è¯¯ï¼šç±»å‹ä¸åŒ¹é…

fn add(a: i32, b: i32): i32 {
    return a + b;
}

add(5, 3);           // OK
add(5, "hello");     // è¿è¡Œæ—¶é”™è¯¯ï¼šç±»å‹ä¸åŒ¹é…
```

### ç±»å‹æŸ¥è¯¢

ä½¿ç”¨ `typeof()` æ£€æŸ¥å€¼ç±»å‹ï¼š

```hemlock
print(typeof(42));         // "i32"
print(typeof(3.14));       // "f64"
print(typeof("hello"));    // "string"
print(typeof(true));       // "bool"
print(typeof(null));       // "null"
print(typeof([1, 2, 3]));  // "array"
print(typeof({ x: 10 }));  // "object"
```

## ç±»å‹è½¬æ¢

### éšå¼ç±»å‹æå‡

å½“æ“ä½œä¸­æ··åˆç±»å‹æ—¶ï¼ŒHemlock æå‡ä¸º"æ›´é«˜"çš„ç±»å‹ï¼š

**æå‡å±‚æ¬¡ï¼ˆä»ä½åˆ°é«˜ï¼‰ï¼š**
```
i8 â†’ i16 â†’ i32 â†’ u32 â†’ i64 â†’ u64 â†’ f32 â†’ f64
      â†‘     â†‘     â†‘
     u8    u16
```

**æµ®ç‚¹æ•°æ€»æ˜¯èµ¢ï¼š**
```hemlock
let x: i32 = 10;
let y: f64 = 3.5;
let result = x + y;  // result æ˜¯ f64 (13.5)
```

**æ›´å¤§çš„å°ºå¯¸èµ¢ï¼š**
```hemlock
let a: i32 = 100;
let b: i64 = 200;
let sum = a + b;     // sum æ˜¯ i64 (300)
```

**ç²¾åº¦ä¿æŒï¼š** å½“ 64 ä½æ•´æ•°ä¸ f32 æ··åˆæ—¶ï¼ŒHemlock æå‡ä¸º f64 ä»¥é¿å…ç²¾åº¦æŸå¤±ï¼ˆf32 åªæœ‰ 24 ä½å°¾æ•°ï¼Œä¸è¶³ä»¥è¡¨ç¤º i64/u64ï¼‰ï¼š
```hemlock
let big: i64 = 9007199254740993;
let small: f32 = 1.0;
let result = big + small;  // result æ˜¯ f64ï¼Œä¸æ˜¯ f32ï¼
```

**ç¤ºä¾‹ï¼š**
```hemlock
u8 + i32  â†’ i32
i32 + i64 â†’ i64
u32 + u64 â†’ u64
i32 + f32 â†’ f32    // f32 è¶³ä»¥è¡¨ç¤º i32
i64 + f32 â†’ f64    // éœ€è¦ f64 æ¥ä¿æŒ i64 ç²¾åº¦
i64 + f64 â†’ f64
i8 + f64  â†’ f64
```

### æ˜¾å¼ç±»å‹è½¬æ¢

**æ•´æ•°ä¸æµ®ç‚¹æ•°è½¬æ¢ï¼š**
```hemlock
let i: i32 = 42;
let f: f64 = i;      // i32 â†’ f64 (42.0)

let x: f64 = 3.14;
let n: i32 = x;      // f64 â†’ i32 (3ï¼Œæˆªæ–­)
```

**æ•´æ•°ä¸ Rune è½¬æ¢ï¼š**
```hemlock
let code: i32 = 65;
let ch: rune = code;  // i32 â†’ rune ('A')

let r: rune = 'Z';
let value: i32 = r;   // rune â†’ i32 (90)
```

**Rune è½¬å­—ç¬¦ä¸²ï¼š**
```hemlock
let ch: rune = 'ğŸš€';
let s: string = ch;   // rune â†’ string ("ğŸš€")
```

**u8 è½¬ Runeï¼š**
```hemlock
let b: u8 = 65;
let r: rune = b;      // u8 â†’ rune ('A')
```

### ç±»å‹æ„é€ å‡½æ•°

ç±»å‹åç§°å¯ä»¥ç”¨ä½œå‡½æ•°æ¥è½¬æ¢æˆ–è§£æå€¼ï¼š

**è§£æå­—ç¬¦ä¸²ä¸ºæ•°å­—ï¼š**
```hemlock
let n = i32("42");       // è§£æå­—ç¬¦ä¸²ä¸º i32ï¼š42
let f = f64("3.14159");  // è§£æå­—ç¬¦ä¸²ä¸º f64ï¼š3.14159
let b = bool("true");    // è§£æå­—ç¬¦ä¸²ä¸º boolï¼štrue

// æ”¯æŒæ‰€æœ‰æ•°å­—ç±»å‹
let a = i8("-128");      // è§£æä¸º i8
let c = u8("255");       // è§£æä¸º u8
let d = i16("1000");     // è§£æä¸º i16
let e = u16("50000");    // è§£æä¸º u16
let g = i64("9000000000000"); // è§£æä¸º i64
let h = u64("18000000000000"); // è§£æä¸º u64
let j = f32("1.5");      // è§£æä¸º f32
```

**åå…­è¿›åˆ¶å’Œè´Ÿæ•°ï¼š**
```hemlock
let hex = i32("0xFF");   // 255
let neg = i32("-42");    // -42
let bin = i32("0b1010"); // 10ï¼ˆäºŒè¿›åˆ¶ï¼‰
```

**ç±»å‹åˆ«åä¹Ÿå¯ä»¥ï¼š**
```hemlock
let x = integer("100");  // ç­‰åŒäº i32("100")
let y = number("1.5");   // ç­‰åŒäº f64("1.5")
let z = byte("200");     // ç­‰åŒäº u8("200")
```

**æ•°å­—ç±»å‹ä¹‹é—´è½¬æ¢ï¼š**
```hemlock
let big = i64(42);           // i32 è½¬ i64
let truncated = i32(3.99);   // f64 è½¬ i32ï¼ˆæˆªæ–­ä¸º 3ï¼‰
let promoted = f64(100);     // i32 è½¬ f64 (100.0)
let narrowed = i8(127);      // i32 è½¬ i8
```

**ç±»å‹æ³¨è§£æ‰§è¡Œæ•°å­—å¼ºåˆ¶è½¬æ¢ï¼ˆä½†ä¸è§£æå­—ç¬¦ä¸²ï¼‰ï¼š**
```hemlock
let f: f64 = 100;        // é€šè¿‡æ³¨è§£ i32 è½¬ f64ï¼ˆOKï¼‰
let s: string = 'A';     // é€šè¿‡æ³¨è§£ Rune è½¬ stringï¼ˆOKï¼‰
let code: i32 = 'A';     // é€šè¿‡æ³¨è§£ Rune è½¬ i32ï¼ˆè·å–ç ç‚¹ï¼ŒOKï¼‰

// å­—ç¬¦ä¸²è§£æéœ€è¦æ˜¾å¼ç±»å‹æ„é€ å‡½æ•°ï¼š
let n = i32("42");       // ä½¿ç”¨ç±»å‹æ„é€ å‡½æ•°è§£æå­—ç¬¦ä¸²
// let x: i32 = "42";    // é”™è¯¯ - ç±»å‹æ³¨è§£ä¸è§£æå­—ç¬¦ä¸²
```

**é”™è¯¯å¤„ç†ï¼š**
```hemlock
// ä½¿ç”¨ç±»å‹æ„é€ å‡½æ•°æ—¶ï¼Œæ— æ•ˆå­—ç¬¦ä¸²ä¼šæŠ›å‡ºé”™è¯¯
let bad = i32("hello");  // è¿è¡Œæ—¶é”™è¯¯ï¼šæ— æ³•å°† "hello" è§£æä¸º i32
let overflow = u8("256"); // è¿è¡Œæ—¶é”™è¯¯ï¼š256 è¶…å‡º u8 èŒƒå›´
```

**å¸ƒå°”è§£æï¼š**
```hemlock
let t = bool("true");    // true
let f = bool("false");   // false
let bad = bool("yes");   // è¿è¡Œæ—¶é”™è¯¯ï¼šå¿…é¡»æ˜¯ "true" æˆ– "false"
```

## èŒƒå›´æ£€æŸ¥

ç±»å‹æ³¨è§£åœ¨èµ‹å€¼æ—¶å¼ºåˆ¶èŒƒå›´æ£€æŸ¥ï¼š

```hemlock
let x: u8 = 255;    // OK
let y: u8 = 256;    // é”™è¯¯ï¼šè¶…å‡º u8 èŒƒå›´

let a: i8 = 127;    // OK
let b: i8 = 128;    // é”™è¯¯ï¼šè¶…å‡º i8 èŒƒå›´

let c: i64 = 2147483647;   // OK
let d: u64 = 4294967295;   // OK
let e: u64 = -1;           // é”™è¯¯ï¼šu64 ä¸èƒ½ä¸ºè´Ÿ
```

## ç±»å‹æå‡ç¤ºä¾‹

### æ··åˆæ•´æ•°ç±»å‹

```hemlock
let a: i8 = 10;
let b: i32 = 20;
let sum = a + b;     // i32 (30)

let c: u8 = 100;
let d: u32 = 200;
let total = c + d;   // u32 (300)
```

### æ•´æ•° + æµ®ç‚¹æ•°

```hemlock
let i: i32 = 5;
let f: f32 = 2.5;
let result = i * f;  // f32 (12.5)
```

### å¤æ‚è¡¨è¾¾å¼

```hemlock
let a: i8 = 10;
let b: i32 = 20;
let c: f64 = 3.0;

let result = a + b * c;  // f64 (70.0)
// è®¡ç®—è¿‡ç¨‹ï¼šb * c â†’ f64(60.0)
//           a + f64(60.0) â†’ f64(70.0)
```

## é¸­å­ç±»å‹ï¼ˆå¯¹è±¡ï¼‰

å¯¹è±¡ä½¿ç”¨**ç»“æ„ç±»å‹**ï¼ˆé¸­å­ç±»å‹ï¼‰ï¼š

```hemlock
define Person {
    name: string,
    age: i32,
}

// OKï¼šæœ‰æ‰€æœ‰å¿…éœ€å­—æ®µ
let p1: Person = { name: "Alice", age: 30 };

// OKï¼šå…è®¸é¢å¤–å­—æ®µ
let p2: Person = { name: "Bob", age: 25, city: "NYC" };

// é”™è¯¯ï¼šç¼ºå°‘ 'age' å­—æ®µ
let p3: Person = { name: "Carol" };

// é”™è¯¯ï¼š'age' ç±»å‹é”™è¯¯
let p4: Person = { name: "Dave", age: "thirty" };
```

**ç±»å‹æ£€æŸ¥åœ¨èµ‹å€¼æ—¶è¿›è¡Œï¼š**
- éªŒè¯æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨
- éªŒè¯å­—æ®µç±»å‹åŒ¹é…
- å…è®¸å¹¶ä¿ç•™é¢å¤–å­—æ®µ
- ä¸º `typeof()` è®¾ç½®å¯¹è±¡çš„ç±»å‹åç§°

## å¯é€‰å­—æ®µ

```hemlock
define Config {
    host: string,
    port: i32,
    debug?: false,     // å¸¦é»˜è®¤å€¼çš„å¯é€‰å­—æ®µ
    timeout?: i32,     // å¯é€‰ï¼Œé»˜è®¤ä¸º null
}

let cfg1: Config = { host: "localhost", port: 8080 };
print(cfg1.debug);    // falseï¼ˆé»˜è®¤ï¼‰
print(cfg1.timeout);  // null

let cfg2: Config = { host: "0.0.0.0", port: 80, debug: true };
print(cfg2.debug);    // trueï¼ˆå·²è¦†ç›–ï¼‰
```

## ç±»å‹åˆ«å

Hemlock ä½¿ç”¨ `type` å…³é”®å­—æ”¯æŒè‡ªå®šä¹‰ç±»å‹åˆ«åï¼š

### åŸºæœ¬ç±»å‹åˆ«å

```hemlock
// ç®€å•ç±»å‹åˆ«å
type Integer = i32;
type Text = string;

// ä½¿ç”¨åˆ«å
let x: Integer = 42;
let msg: Text = "hello";
```

### å‡½æ•°ç±»å‹åˆ«å

```hemlock
// å‡½æ•°ç±»å‹åˆ«å
type Callback = fn(i32): void;
type Predicate = fn(i32): bool;
type AsyncHandler = async fn(string): i32;

// ä½¿ç”¨å‡½æ•°ç±»å‹åˆ«å
let cb: Callback = fn(n) { print(n); };
let isEven: Predicate = fn(n) { return n % 2 == 0; };
```

### å¤åˆç±»å‹åˆ«å

```hemlock
// å°†å¤šä¸ª define ç»„åˆæˆä¸€ä¸ªç±»å‹
define HasName { name: string }
define HasAge { age: i32 }

type Person = HasName & HasAge;

let p: Person = { name: "Alice", age: 30 };
```

### æ³›å‹ç±»å‹åˆ«å

```hemlock
// æ³›å‹ç±»å‹åˆ«å
type Pair<T> = { first: T, second: T };
type Result<T, E> = { value: T?, error: E? };

// ä½¿ç”¨æ³›å‹åˆ«å
let coords: Pair<f64> = { first: 3.14, second: 2.71 };
```

**æ³¨æ„ï¼š** ç±»å‹åˆ«åæ˜¯é€æ˜çš„ - `typeof()` è¿”å›åº•å±‚ç±»å‹åç§°ï¼Œè€Œä¸æ˜¯åˆ«åã€‚

## ç±»å‹ç³»ç»Ÿé™åˆ¶

å½“å‰é™åˆ¶ï¼š

- **å‡½æ•°æ— æ³›å‹** - å°šä¸æ”¯æŒå‡½æ•°ç±»å‹å‚æ•°
- **æ— è”åˆç±»å‹** - æ— æ³•è¡¨è¾¾ "A æˆ– B"
- **æ— å¯ç©ºç±»å‹** - æ‰€æœ‰ç±»å‹éƒ½å¯ä»¥ä¸º nullï¼ˆä½¿ç”¨ `?` åç¼€è¡¨ç¤ºæ˜¾å¼å¯ç©ºï¼‰

**æ³¨æ„ï¼š** ç¼–è¯‘å™¨ï¼ˆ`hemlockc`ï¼‰æä¾›ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ã€‚è§£é‡Šå™¨ä»…æ‰§è¡Œè¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ã€‚è¯¦è§[ç¼–è¯‘å™¨æ–‡æ¡£](#design-implementation)ã€‚

## æœ€ä½³å®è·µ

### ä½•æ—¶ä½¿ç”¨ç±»å‹æ³¨è§£

**åº”è¯¥ä½¿ç”¨æ³¨è§£çš„æƒ…å†µï¼š**
- ç²¾ç¡®ç±»å‹å¾ˆé‡è¦ï¼ˆä¾‹å¦‚ï¼Œå­—èŠ‚å€¼ä½¿ç”¨ `u8`ï¼‰
- è®°å½•å‡½æ•°æ¥å£
- å¼ºåˆ¶çº¦æŸï¼ˆä¾‹å¦‚ï¼ŒèŒƒå›´æ£€æŸ¥ï¼‰

```hemlock
fn hash(data: buffer, length: u32): u64 {
    // å®ç°
}
```

**ä¸éœ€è¦ä½¿ç”¨æ³¨è§£çš„æƒ…å†µï¼š**
- ç±»å‹ä»å­—é¢é‡æ˜æ˜¾å¯çŸ¥
- å†…éƒ¨å®ç°ç»†èŠ‚
- ä¸å¿…è¦çš„å½¢å¼åŒ–

```hemlock
// ä¸å¿…è¦
let x: i32 = 42;

// æ›´å¥½
let x = 42;
```

### ç±»å‹å®‰å…¨æ¨¡å¼

**ä½¿ç”¨å‰æ£€æŸ¥ï¼š**
```hemlock
if (typeof(value) == "i32") {
    // å¯ä»¥å®‰å…¨åœ°ä½œä¸º i32 ä½¿ç”¨
}
```

**éªŒè¯å‡½æ•°å‚æ•°ï¼š**
```hemlock
fn divide(a, b) {
    if (typeof(a) != "i32" || typeof(b) != "i32") {
        throw "arguments must be integers";
    }
    if (b == 0) {
        throw "division by zero";
    }
    return a / b;
}
```

**ä½¿ç”¨é¸­å­ç±»å‹è·å¾—çµæ´»æ€§ï¼š**
```hemlock
define Printable {
    toString: fn,
}

fn print_item(item: Printable) {
    print(item.toString());
}
```

## ä¸‹ä¸€æ­¥

- [Strings](#language-guide-strings) - UTF-8 å­—ç¬¦ä¸²ç±»å‹å’Œæ“ä½œ
- [Runes](#language-guide-runes) - Unicode ç ç‚¹ç±»å‹
- [Arrays](#language-guide-arrays) - åŠ¨æ€æ•°ç»„ç±»å‹
- [Objects](#language-guide-objects) - å¯¹è±¡å­—é¢é‡å’Œé¸­å­ç±»å‹
- [Memory](#language-guide-memory) - æŒ‡é’ˆå’Œç¼“å†²åŒºç±»å‹


--------------------------------------------------------------------------------
## è¯­æ³•
--------------------------------------------------------------------------------

# è¯­æ³•æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç» Hemlock ç¨‹åºçš„åŸºæœ¬è¯­æ³•è§„åˆ™å’Œç»“æ„ã€‚

## æ ¸å¿ƒè¯­æ³•è§„åˆ™

### åˆ†å·æ˜¯å¿…éœ€çš„

ä¸ JavaScript æˆ– Python ä¸åŒï¼Œè¯­å¥æœ«å°¾**å¿…é¡»**ä½¿ç”¨åˆ†å·ï¼š

```hemlock
let x = 42;
let y = 10;
print(x + y);
```

**ä»¥ä¸‹ä»£ç ä¼šå¯¼è‡´é”™è¯¯ï¼š**
```hemlock
let x = 42  // é”™è¯¯ï¼šç¼ºå°‘åˆ†å·
let y = 10  // é”™è¯¯ï¼šç¼ºå°‘åˆ†å·
```

### èŠ±æ‹¬å·æ˜¯å¿…éœ€çš„

æ‰€æœ‰æ§åˆ¶æµä»£ç å—éƒ½å¿…é¡»ä½¿ç”¨èŠ±æ‹¬å·ï¼Œå³ä½¿åªæœ‰å•æ¡è¯­å¥ï¼š

```hemlock
// æ­£ç¡®
if (x > 0) {
    print("positive");
}

// é”™è¯¯ï¼šç¼ºå°‘èŠ±æ‹¬å·
if (x > 0)
    print("positive");
```

### æ³¨é‡Š

```hemlock
// è¿™æ˜¯å•è¡Œæ³¨é‡Š

/*
   è¿™æ˜¯
   å¤šè¡Œæ³¨é‡Š
*/

let x = 42;  // è¡Œå†…æ³¨é‡Š
```

## å˜é‡

### å£°æ˜

ä½¿ç”¨ `let` å£°æ˜å˜é‡ï¼š

```hemlock
let count = 0;
let name = "Alice";
let pi = 3.14159;
```

### ç±»å‹æ³¨è§£ï¼ˆå¯é€‰ï¼‰

```hemlock
let age: i32 = 30;
let ratio: f64 = 1.618;
let flag: bool = true;
let text: string = "hello";
```

### å¸¸é‡

ä½¿ç”¨ `const` å£°æ˜ä¸å¯å˜å€¼ï¼š

```hemlock
const MAX_SIZE: i32 = 1000;
const PI: f64 = 3.14159;
```

å°è¯•é‡æ–°èµ‹å€¼å¸¸é‡ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ï¼š"Cannot assign to const variable"ã€‚

## è¡¨è¾¾å¼

### ç®—æœ¯è¿ç®—ç¬¦

```hemlock
let a = 10;
let b = 3;

print(a + b);   // 13 - åŠ æ³•
print(a - b);   // 7  - å‡æ³•
print(a * b);   // 30 - ä¹˜æ³•
print(a / b);   // 3  - é™¤æ³•ï¼ˆæ•´æ•°ï¼‰
```

### æ¯”è¾ƒè¿ç®—ç¬¦

```hemlock
print(a == b);  // false - ç­‰äº
print(a != b);  // true  - ä¸ç­‰äº
print(a > b);   // true  - å¤§äº
print(a < b);   // false - å°äº
print(a >= b);  // true  - å¤§äºç­‰äº
print(a <= b);  // false - å°äºç­‰äº
```

### é€»è¾‘è¿ç®—ç¬¦

```hemlock
let x = true;
let y = false;

print(x && y);  // false - ä¸
print(x || y);  // true  - æˆ–
print(!x);      // false - é
```

### ä½è¿ç®—ç¬¦

```hemlock
let a = 12;  // 1100
let b = 10;  // 1010

print(a & b);   // 8  - æŒ‰ä½ä¸
print(a | b);   // 14 - æŒ‰ä½æˆ–
print(a ^ b);   // 6  - æŒ‰ä½å¼‚æˆ–
print(a << 2);  // 48 - å·¦ç§»
print(a >> 1);  // 6  - å³ç§»
print(~a);      // -13 - æŒ‰ä½å–å
```

### è¿ç®—ç¬¦ä¼˜å…ˆçº§

ä»é«˜åˆ°ä½ï¼š

1. `()` - åˆ†ç»„
2. `!`, `~`, `-`ï¼ˆä¸€å…ƒï¼‰- ä¸€å…ƒè¿ç®—ç¬¦
3. `*`, `/` - ä¹˜æ³•ã€é™¤æ³•
4. `+`, `-` - åŠ æ³•ã€å‡æ³•
5. `<<`, `>>` - ä½ç§»
6. `<`, `<=`, `>`, `>=` - æ¯”è¾ƒ
7. `==`, `!=` - ç›¸ç­‰æ€§
8. `&` - æŒ‰ä½ä¸
9. `^` - æŒ‰ä½å¼‚æˆ–
10. `|` - æŒ‰ä½æˆ–
11. `&&` - é€»è¾‘ä¸
12. `||` - é€»è¾‘æˆ–

**ç¤ºä¾‹ï¼š**
```hemlock
let x = 2 + 3 * 4;      // 14ï¼ˆä¸æ˜¯ 20ï¼‰
let y = (2 + 3) * 4;    // 20
let z = 5 << 2 + 1;     // 40 (5 << 3)
```

## æ§åˆ¶æµ

### If è¯­å¥

```hemlock
if (condition) {
    // ä¸»ä½“
}

if (condition) {
    // then åˆ†æ”¯
} else {
    // else åˆ†æ”¯
}

if (condition1) {
    // åˆ†æ”¯ 1
} else if (condition2) {
    // åˆ†æ”¯ 2
} else {
    // é»˜è®¤åˆ†æ”¯
}
```

### While å¾ªç¯

```hemlock
while (condition) {
    // ä¸»ä½“
}
```

**ç¤ºä¾‹ï¼š**
```hemlock
let i = 0;
while (i < 10) {
    print(i);
    i = i + 1;
}
```

### For å¾ªç¯

**C é£æ ¼ forï¼š**
```hemlock
for (initializer; condition; increment) {
    // ä¸»ä½“
}
```

**ç¤ºä¾‹ï¼š**
```hemlock
for (let i = 0; i < 10; i = i + 1) {
    print(i);
}
```

**For-inï¼ˆæ•°ç»„ï¼‰ï¼š**
```hemlock
for (let item in array) {
    // ä¸»ä½“
}
```

**ç¤ºä¾‹ï¼š**
```hemlock
let items = [10, 20, 30];
for (let x in items) {
    print(x);
}
```

### Switch è¯­å¥

```hemlock
switch (expression) {
    case value1:
        // ä¸»ä½“
        break;
    case value2:
        // ä¸»ä½“
        break;
    default:
        // é»˜è®¤ä¸»ä½“
        break;
}
```

**ç¤ºä¾‹ï¼š**
```hemlock
let day = 3;
switch (day) {
    case 1:
        print("Monday");
        break;
    case 2:
        print("Tuesday");
        break;
    case 3:
        print("Wednesday");
        break;
    default:
        print("Other");
        break;
}
```

### Break å’Œ Continue

```hemlock
// Breakï¼šé€€å‡ºå¾ªç¯
for (let i = 0; i < 10; i = i + 1) {
    if (i == 5) {
        break;
    }
    print(i);
}

// Continueï¼šè·³åˆ°ä¸‹ä¸€æ¬¡è¿­ä»£
for (let i = 0; i < 10; i = i + 1) {
    if (i == 5) {
        continue;
    }
    print(i);
}
```

## å‡½æ•°

### å‘½åå‡½æ•°

```hemlock
fn function_name(param1: type1, param2: type2): return_type {
    // ä¸»ä½“
    return value;
}
```

**ç¤ºä¾‹ï¼š**
```hemlock
fn add(a: i32, b: i32): i32 {
    return a + b;
}
```

### åŒ¿åå‡½æ•°

```hemlock
let func = fn(params) {
    // ä¸»ä½“
};
```

**ç¤ºä¾‹ï¼š**
```hemlock
let multiply = fn(x, y) {
    return x * y;
};
```

### ç±»å‹æ³¨è§£ï¼ˆå¯é€‰ï¼‰

```hemlock
// æ— æ³¨è§£ï¼ˆç±»å‹æ¨æ–­ï¼‰
fn greet(name) {
    return "Hello, " + name;
}

// æœ‰æ³¨è§£ï¼ˆè¿è¡Œæ—¶æ£€æŸ¥ï¼‰
fn divide(a: i32, b: i32): f64 {
    return a / b;
}
```

## å¯¹è±¡

### å¯¹è±¡å­—é¢é‡

```hemlock
let obj = {
    field1: value1,
    field2: value2,
};
```

**ç¤ºä¾‹ï¼š**
```hemlock
let person = {
    name: "Alice",
    age: 30,
    active: true,
};
```

### æ–¹æ³•

```hemlock
let obj = {
    method: fn() {
        self.field = value;
    },
};
```

**ç¤ºä¾‹ï¼š**
```hemlock
let counter = {
    count: 0,
    increment: fn() {
        self.count = self.count + 1;
    },
};
```

### ç±»å‹å®šä¹‰

```hemlock
define TypeName {
    field1: type1,
    field2: type2,
    optional_field?: default_value,
}
```

**ç¤ºä¾‹ï¼š**
```hemlock
define Person {
    name: string,
    age: i32,
    active?: true,
}
```

## æ•°ç»„

### æ•°ç»„å­—é¢é‡

```hemlock
let arr = [element1, element2, element3];
```

**ç¤ºä¾‹ï¼š**
```hemlock
let numbers = [1, 2, 3, 4, 5];
let mixed = [1, "two", true, null];
let empty = [];
```

### æ•°ç»„ç´¢å¼•

```hemlock
let arr = [10, 20, 30];
print(arr[0]);   // 10
arr[1] = 99;     // ä¿®æ”¹å…ƒç´ 
```

## é”™è¯¯å¤„ç†

### Try/Catch

```hemlock
try {
    // å¯èƒ½å‡ºé”™çš„ä»£ç 
} catch (e) {
    // å¤„ç†é”™è¯¯
}
```

### Try/Finally

```hemlock
try {
    // å¯èƒ½å‡ºé”™çš„ä»£ç 
} finally {
    // æ€»æ˜¯æ‰§è¡Œ
}
```

### Try/Catch/Finally

```hemlock
try {
    // å¯èƒ½å‡ºé”™çš„ä»£ç 
} catch (e) {
    // å¤„ç†é”™è¯¯
} finally {
    // æ¸…ç†
}
```

### Throw

```hemlock
throw expression;
```

**ç¤ºä¾‹ï¼š**
```hemlock
if (x < 0) {
    throw "x must be positive";
}
```

### Panic

```hemlock
panic(message);
```

**ç¤ºä¾‹ï¼š**
```hemlock
panic("unrecoverable error");
```

## æ¨¡å—ï¼ˆå®éªŒæ€§ï¼‰

### å¯¼å‡ºè¯­å¥

```hemlock
export fn function_name() { }
export const CONSTANT = value;
export let variable = value;
export { name1, name2 };
```

### å¯¼å…¥è¯­å¥

```hemlock
import { name1, name2 } from "./module.hml";
import * as namespace from "./module.hml";
import { name as alias } from "./module.hml";
```

## å¼‚æ­¥ï¼ˆå®éªŒæ€§ï¼‰

### å¼‚æ­¥å‡½æ•°

```hemlock
async fn function_name(params): return_type {
    // ä¸»ä½“
}
```

### Spawn/Join

```hemlock
let task = spawn(async_function, arg1, arg2);
let result = join(task);
```

### é€šé“

```hemlock
let ch = channel(capacity);
ch.send(value);
let value = ch.recv();
ch.close();
```

## FFIï¼ˆå¤–éƒ¨å‡½æ•°æ¥å£ï¼‰

### å¯¼å…¥å…±äº«åº“

```hemlock
import "library_name.so";
```

### å£°æ˜å¤–éƒ¨å‡½æ•°

```hemlock
extern fn function_name(param: type): return_type;
```

**ç¤ºä¾‹ï¼š**
```hemlock
import "libc.so.6";
extern fn strlen(s: string): i32;
```

## å­—é¢é‡

### æ•´æ•°å­—é¢é‡

```hemlock
let decimal = 42;
let negative = -100;
let large = 5000000000;  // è‡ªåŠ¨ i64

// åå…­è¿›åˆ¶ï¼ˆ0x å‰ç¼€ï¼‰
let hex = 0xDEADBEEF;
let hex2 = 0xFF;

// äºŒè¿›åˆ¶ï¼ˆ0b å‰ç¼€ï¼‰
let bin = 0b1010;
let bin2 = 0b11110000;

// å…«è¿›åˆ¶ï¼ˆ0o å‰ç¼€ï¼‰
let oct = 0o777;
let oct2 = 0O123;

// æ•°å­—åˆ†éš”ç¬¦æé«˜å¯è¯»æ€§
let million = 1_000_000;
let hex_sep = 0xFF_FF_FF;
let bin_sep = 0b1111_0000_1010_0101;
let oct_sep = 0o77_77;
```

### æµ®ç‚¹å­—é¢é‡

```hemlock
let f = 3.14;
let e = 2.71828;
let sci = 1.5e-10;       // ç§‘å­¦è®¡æ•°æ³•
let sci2 = 2.5E+3;       // å¤§å†™ E ä¹Ÿå¯ä»¥
let no_lead = .5;        // æ— å‰å¯¼é›¶ (0.5)
let sep = 3.14_159_265;  // æ•°å­—åˆ†éš”ç¬¦
```

### å­—ç¬¦ä¸²å­—é¢é‡

```hemlock
let s = "hello";
let escaped = "line1\nline2\ttabbed";
let quote = "She said \"hello\"";

// åå…­è¿›åˆ¶è½¬ä¹‰åºåˆ—
let hex_esc = "\x48\x65\x6c\x6c\x6f";  // "Hello"

// Unicode è½¬ä¹‰åºåˆ—
let emoji = "\u{1F600}";               // ğŸ˜€
let heart = "\u{2764}";                // â¤
let mixed = "Hello \u{1F30D}!";        // Hello ğŸŒ!
```

**è½¬ä¹‰åºåˆ—ï¼š**
- `\n` - æ¢è¡Œ
- `\t` - åˆ¶è¡¨ç¬¦
- `\r` - å›è½¦
- `\\` - åæ–œæ 
- `\"` - åŒå¼•å·
- `\'` - å•å¼•å·
- `\0` - ç©ºå­—ç¬¦
- `\xNN` - åå…­è¿›åˆ¶è½¬ä¹‰ï¼ˆ2 ä½ï¼‰
- `\u{XXXX}` - Unicode è½¬ä¹‰ï¼ˆ1-6 ä½ï¼‰

### Rune å­—é¢é‡

```hemlock
let ch = 'A';
let emoji = 'ğŸš€';
let escaped = '\n';
let unicode = '\u{1F680}';
let hex_rune = '\x41';      // 'A'
```

### å¸ƒå°”å­—é¢é‡

```hemlock
let t = true;
let f = false;
```

### Null å­—é¢é‡

```hemlock
let nothing = null;
```

## ä½œç”¨åŸŸè§„åˆ™

### å—ä½œç”¨åŸŸ

å˜é‡çš„ä½œç”¨åŸŸä¸ºæœ€è¿‘çš„å°é—­å—ï¼š

```hemlock
let x = 1;  // å¤–éƒ¨ä½œç”¨åŸŸ

if (true) {
    let x = 2;  // å†…éƒ¨ä½œç”¨åŸŸï¼ˆé®è”½å¤–éƒ¨ï¼‰
    print(x);   // 2
}

print(x);  // 1
```

### å‡½æ•°ä½œç”¨åŸŸ

å‡½æ•°åˆ›å»ºè‡ªå·±çš„ä½œç”¨åŸŸï¼š

```hemlock
let global = "global";

fn foo() {
    let local = "local";
    print(global);  // å¯ä»¥è¯»å–å¤–éƒ¨ä½œç”¨åŸŸ
}

foo();
// print(local);  // é”™è¯¯ï¼š'local' åœ¨æ­¤å¤„æœªå®šä¹‰
```

### é—­åŒ…ä½œç”¨åŸŸ

é—­åŒ…æ•è·å°é—­ä½œç”¨åŸŸçš„å˜é‡ï¼š

```hemlock
fn makeCounter() {
    let count = 0;
    return fn() {
        count = count + 1;  // æ•è· 'count'
        return count;
    };
}

let counter = makeCounter();
print(counter());  // 1
print(counter());  // 2
```

## ç©ºç™½å’Œæ ¼å¼

### ç¼©è¿›

Hemlock ä¸å¼ºåˆ¶ç‰¹å®šç¼©è¿›ï¼Œä½†å»ºè®®ä½¿ç”¨ 4 ä¸ªç©ºæ ¼ï¼š

```hemlock
fn example() {
    if (true) {
        print("indented");
    }
}
```

### æ¢è¡Œ

è¯­å¥å¯ä»¥è·¨è¶Šå¤šè¡Œï¼š

```hemlock
let result =
    very_long_function_name(
        arg1,
        arg2,
        arg3
    );
```

## Loop è¯­å¥

`loop` å…³é”®å­—ä¸ºæ— é™å¾ªç¯æä¾›æ›´æ¸…æ™°çš„è¯­æ³•ï¼š

```hemlock
loop {
    // ... æ‰§è¡Œå·¥ä½œ
    if (done) {
        break;
    }
}
```

è¿™ç­‰ä»·äº `while (true)`ï¼Œä½†æ„å›¾æ›´æ˜ç¡®ã€‚

## ä¿ç•™å…³é”®å­—

ä»¥ä¸‹å…³é”®å­—åœ¨ Hemlock ä¸­æ˜¯ä¿ç•™çš„ï¼š

```
let, const, fn, if, else, while, for, in, loop, break, continue,
return, true, false, null, typeof, import, export, from,
try, catch, finally, throw, panic, async, await, spawn, join,
detach, channel, define, switch, case, default, extern, self,
type, defer, enum, ref, buffer, Self
```

## ä¸‹ä¸€æ­¥

- [ç±»å‹ç³»ç»Ÿ](#language-guide-types) - äº†è§£ Hemlock çš„ç±»å‹ç³»ç»Ÿ
- [æ§åˆ¶æµ](#language-guide-control-flow) - æ·±å…¥äº†è§£æ§åˆ¶ç»“æ„
- [å‡½æ•°](#language-guide-functions) - æŒæ¡å‡½æ•°å’Œé—­åŒ…
- [å†…å­˜ç®¡ç†](#language-guide-memory) - ç†è§£æŒ‡é’ˆå’Œç¼“å†²åŒº


--------------------------------------------------------------------------------
## é”™è¯¯å¤„ç†
--------------------------------------------------------------------------------

# é”™è¯¯å¤„ç†

Hemlock é€šè¿‡ `try`ã€`catch`ã€`finally`ã€`throw` å’Œ `panic` æ”¯æŒåŸºäºå¼‚å¸¸çš„é”™è¯¯å¤„ç†ã€‚æœ¬æŒ‡å—æ¶µç›–äº†ä½¿ç”¨å¼‚å¸¸å¤„ç†å¯æ¢å¤é”™è¯¯ä»¥åŠä½¿ç”¨ panic å¤„ç†ä¸å¯æ¢å¤é”™è¯¯çš„å†…å®¹ã€‚

## æ¦‚è¿°

```hemlock
// åŸºæœ¬é”™è¯¯å¤„ç†
try {
    risky_operation();
} catch (e) {
    print("Error: " + e);
}

// å¸¦æ¸…ç†æ“ä½œ
try {
    process_file();
} catch (e) {
    print("Failed: " + e);
} finally {
    cleanup();
}

// æŠ›å‡ºé”™è¯¯
fn divide(a, b) {
    if (b == 0) {
        throw "division by zero";
    }
    return a / b;
}
```

## Try-Catch-Finally

### è¯­æ³•

**åŸºæœ¬ try/catchï¼š**
```hemlock
try {
    // æœ‰é£é™©çš„ä»£ç 
} catch (e) {
    // å¤„ç†é”™è¯¯ï¼Œe åŒ…å«æŠ›å‡ºçš„å€¼
}
```

**Try/finallyï¼š**
```hemlock
try {
    // æœ‰é£é™©çš„ä»£ç 
} finally {
    // å§‹ç»ˆæ‰§è¡Œï¼Œå³ä½¿æŠ›å‡ºå¼‚å¸¸
}
```

**Try/catch/finallyï¼š**
```hemlock
try {
    // æœ‰é£é™©çš„ä»£ç 
} catch (e) {
    // å¤„ç†é”™è¯¯
} finally {
    // æ¸…ç†ä»£ç 
}
```

### Try å—

try å—æŒ‰é¡ºåºæ‰§è¡Œè¯­å¥ï¼š

```hemlock
try {
    print("Starting...");
    risky_operation();
    print("Success!");  // ä»…åœ¨æ²¡æœ‰å¼‚å¸¸æ—¶æ‰§è¡Œ
}
```

**è¡Œä¸ºï¼š**
- æŒ‰é¡ºåºæ‰§è¡Œè¯­å¥
- å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼šè·³è½¬åˆ° `catch` æˆ– `finally`
- å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼šæ‰§è¡Œ `finally`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ç„¶åç»§ç»­

### Catch å—

catch å—æ¥æ”¶æŠ›å‡ºçš„å€¼ï¼š

```hemlock
try {
    throw "oops";
} catch (error) {
    print("Caught: " + error);  // error = "oops"
    // error åªèƒ½åœ¨è¿™é‡Œè®¿é—®
}
// error åœ¨è¿™é‡Œæ— æ³•è®¿é—®
```

**Catch å‚æ•°ï¼š**
- æ¥æ”¶æŠ›å‡ºçš„å€¼ï¼ˆä»»æ„ç±»å‹ï¼‰
- ä½œç”¨åŸŸä»…é™äº catch å—
- å¯ä»¥å‘½åä¸ºä»»ä½•åç§°ï¼ˆé€šå¸¸ä½¿ç”¨ `e`ã€`err` æˆ– `error`ï¼‰

**åœ¨ catch ä¸­å¯ä»¥åšçš„äº‹æƒ…ï¼š**
```hemlock
try {
    risky_operation();
} catch (e) {
    // è®°å½•é”™è¯¯
    print("Error: " + e);

    // é‡æ–°æŠ›å‡ºç›¸åŒé”™è¯¯
    throw e;

    // æŠ›å‡ºä¸åŒé”™è¯¯
    throw "different error";

    // è¿”å›é»˜è®¤å€¼
    return null;

    // å¤„ç†å¹¶ç»§ç»­
    // ï¼ˆä¸é‡æ–°æŠ›å‡ºï¼‰
}
```

### Finally å—

finally å—**å§‹ç»ˆæ‰§è¡Œ**ï¼š

```hemlock
try {
    print("1: try");
    throw "error";
} catch (e) {
    print("2: catch");
} finally {
    print("3: finally");  // å§‹ç»ˆè¿è¡Œ
}
print("4: after");

// è¾“å‡ºï¼š1: try, 2: catch, 3: finally, 4: after
```

**finally ä½•æ—¶è¿è¡Œï¼š**
- åœ¨ try å—ä¹‹åï¼ˆå¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼‰
- åœ¨ catch å—ä¹‹åï¼ˆå¦‚æœæ•è·äº†å¼‚å¸¸ï¼‰
- å³ä½¿ try/catch åŒ…å« `return`ã€`break` æˆ– `continue`
- åœ¨æ§åˆ¶æµé€€å‡º try/catch ä¹‹å‰

**Finally ä¸ returnï¼š**
```hemlock
fn example() {
    try {
        return 1;  // åœ¨ finally è¿è¡Œåè¿”å› 1
    } finally {
        print("cleanup");  // åœ¨è¿”å›ä¹‹å‰è¿è¡Œ
    }
}

fn example2() {
    try {
        return 1;
    } finally {
        return 2;  // finally çš„ return è¦†ç›–åŸå€¼ - è¿”å› 2
    }
}
```

**Finally ä¸æ§åˆ¶æµï¼š**
```hemlock
for (let i = 0; i < 10; i = i + 1) {
    try {
        if (i == 5) {
            break;  // åœ¨ finally è¿è¡Œå break
        }
    } finally {
        print("cleanup " + typeof(i));
    }
}
```

## Throw è¯­å¥

### åŸºæœ¬ Throw

æŠ›å‡ºä»»æ„å€¼ä½œä¸ºå¼‚å¸¸ï¼š

```hemlock
throw "error message";
throw 404;
throw { code: 500, message: "Internal error" };
throw null;
throw ["error", "details"];
```

**æ‰§è¡Œè¿‡ç¨‹ï¼š**
1. è®¡ç®—è¡¨è¾¾å¼
2. ç«‹å³è·³è½¬åˆ°æœ€è¿‘çš„ `catch`
3. å¦‚æœæ²¡æœ‰ `catch`ï¼Œå‘ä¸Šä¼ æ’­è°ƒç”¨æ ˆ

### æŠ›å‡ºé”™è¯¯

```hemlock
fn validate_age(age: i32) {
    if (age < 0) {
        throw "Age cannot be negative";
    }
    if (age > 150) {
        throw "Age is unrealistic";
    }
}

try {
    validate_age(-5);
} catch (e) {
    print("Validation error: " + e);
}
```

### æŠ›å‡ºé”™è¯¯å¯¹è±¡

åˆ›å»ºç»“æ„åŒ–çš„é”™è¯¯ä¿¡æ¯ï¼š

```hemlock
fn read_file(path: string) {
    if (!file_exists(path)) {
        throw {
            type: "FileNotFound",
            path: path,
            message: "File does not exist"
        };
    }
    // ... è¯»å–æ–‡ä»¶
}

try {
    read_file("missing.txt");
} catch (e) {
    if (e.type == "FileNotFound") {
        print("File not found: " + e.path);
    }
}
```

### é‡æ–°æŠ›å‡º

æ•è·å¹¶é‡æ–°æŠ›å‡ºé”™è¯¯ï¼š

```hemlock
fn wrapper() {
    try {
        risky_operation();
    } catch (e) {
        print("Logging error: " + e);
        throw e;  // é‡æ–°æŠ›ç»™è°ƒç”¨è€…
    }
}

try {
    wrapper();
} catch (e) {
    print("Caught in main: " + e);
}
```

## æœªæ•è·çš„å¼‚å¸¸

å¦‚æœå¼‚å¸¸ä¼ æ’­åˆ°è°ƒç”¨æ ˆé¡¶éƒ¨è€Œæœªè¢«æ•è·ï¼š

```hemlock
fn foo() {
    throw "uncaught!";
}

foo();  // å´©æºƒå¹¶æ˜¾ç¤ºï¼šRuntime error: uncaught!
```

**è¡Œä¸ºï¼š**
- ç¨‹åºå´©æºƒ
- å‘ stderr æ‰“å°é”™è¯¯æ¶ˆæ¯
- ä»¥éé›¶çŠ¶æ€ç é€€å‡º
- å †æ ˆè·Ÿè¸ªå°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­æ·»åŠ 

## Panic - ä¸å¯æ¢å¤é”™è¯¯

### ä»€ä¹ˆæ˜¯ Panicï¼Ÿ

`panic()` ç”¨äº**ä¸å¯æ¢å¤çš„é”™è¯¯**ï¼Œåº”ç«‹å³ç»ˆæ­¢ç¨‹åºï¼š

```hemlock
panic();                    // é»˜è®¤æ¶ˆæ¯ï¼š"panic!"
panic("custom message");    // è‡ªå®šä¹‰æ¶ˆæ¯
panic(42);                  // éå­—ç¬¦ä¸²å€¼ä¼šè¢«æ‰“å°
```

**è¯­ä¹‰ï¼š**
- **ç«‹å³é€€å‡º**ç¨‹åºï¼Œé€€å‡ºç ä¸º 1
- å‘ stderr æ‰“å°é”™è¯¯æ¶ˆæ¯ï¼š`panic: <message>`
- **æ— æ³•**é€šè¿‡ try/catch æ•è·
- ç”¨äº bug å’Œä¸å¯æ¢å¤çš„é”™è¯¯

### Panic vs Throw

```hemlock
// throw - å¯æ¢å¤é”™è¯¯ï¼ˆå¯ä»¥è¢«æ•è·ï¼‰
try {
    throw "recoverable error";
} catch (e) {
    print("Caught: " + e);  // æˆåŠŸæ•è·
}

// panic - ä¸å¯æ¢å¤é”™è¯¯ï¼ˆæ— æ³•è¢«æ•è·ï¼‰
try {
    panic("unrecoverable error");  // ç¨‹åºç«‹å³é€€å‡º
} catch (e) {
    print("This never runs");       // æ°¸è¿œä¸ä¼šæ‰§è¡Œ
}
```

### ä½•æ—¶ä½¿ç”¨ Panic

**ä½¿ç”¨ panic çš„æƒ…å†µï¼š**
- **Bug**ï¼šåˆ°è¾¾äº†ä¸åº”è¯¥åˆ°è¾¾çš„ä»£ç 
- **æ— æ•ˆçŠ¶æ€**ï¼šæ£€æµ‹åˆ°æ•°æ®ç»“æ„æŸå
- **ä¸å¯æ¢å¤é”™è¯¯**ï¼šå…³é”®èµ„æºä¸å¯ç”¨
- **æ–­è¨€å¤±è´¥**ï¼šå½“ `assert()` ä¸å¤Ÿç”¨æ—¶

**ç¤ºä¾‹ï¼š**
```hemlock
// ä¸å¯è¾¾ä»£ç 
fn process_state(state: i32) {
    if (state == 1) {
        return "ready";
    } else if (state == 2) {
        return "running";
    } else if (state == 3) {
        return "stopped";
    } else {
        panic("invalid state: " + typeof(state));  // ä¸åº”è¯¥å‘ç”Ÿ
    }
}

// å…³é”®èµ„æºæ£€æŸ¥
fn init_system() {
    let config = read_file("config.json");
    if (config == null) {
        panic("config.json not found - cannot start");
    }
    // ...
}

// æ•°æ®ç»“æ„ä¸å˜é‡
fn pop_stack(stack) {
    if (stack.length == 0) {
        panic("pop() called on empty stack");
    }
    return stack.pop();
}
```

### ä½•æ—¶ä¸ä½¿ç”¨ Panic

**ä»¥ä¸‹æƒ…å†µä½¿ç”¨ throwï¼š**
- ç”¨æˆ·è¾“å…¥éªŒè¯
- æ–‡ä»¶æœªæ‰¾åˆ°
- ç½‘ç»œé”™è¯¯
- é¢„æœŸçš„é”™è¯¯æ¡ä»¶

```hemlock
// ä¸å¥½ï¼šå¯¹é¢„æœŸé”™è¯¯ä½¿ç”¨ panic
fn divide(a, b) {
    if (b == 0) {
        panic("division by zero");  // å¤ªä¸¥å‰äº†
    }
    return a / b;
}

// å¥½ï¼šå¯¹é¢„æœŸé”™è¯¯ä½¿ç”¨ throw
fn divide(a, b) {
    if (b == 0) {
        throw "division by zero";  // å¯æ¢å¤
    }
    return a / b;
}
```

## æ§åˆ¶æµäº¤äº’

### Try/Catch/Finally ä¸­çš„ Return

```hemlock
fn example() {
    try {
        return 1;  // åœ¨ finally è¿è¡Œåè¿”å› 1
    } finally {
        print("cleanup");
    }
}

fn example2() {
    try {
        return 1;
    } finally {
        return 2;  // finally çš„ return è¦†ç›– try çš„ return - è¿”å› 2
    }
}
```

**è§„åˆ™ï¼š** finally å—çš„è¿”å›å€¼ä¼šè¦†ç›– try/catch çš„è¿”å›å€¼ã€‚

### Try/Catch/Finally ä¸­çš„ Break/Continue

```hemlock
for (let i = 0; i < 10; i = i + 1) {
    try {
        if (i == 5) { break; }  // åœ¨ finally è¿è¡Œå break
    } finally {
        print("cleanup " + typeof(i));
    }
}
```

**è§„åˆ™ï¼š** break/continue åœ¨ finally å—ä¹‹åæ‰§è¡Œã€‚

### åµŒå¥— Try/Catch

```hemlock
try {
    try {
        throw "inner";
    } catch (e) {
        print("Caught: " + e);  // æ‰“å°ï¼šCaught: inner
        throw "outer";  // é‡æ–°æŠ›å‡ºä¸åŒé”™è¯¯
    }
} catch (e) {
    print("Caught: " + e);  // æ‰“å°ï¼šCaught: outer
}
```

**è§„åˆ™ï¼š** åµŒå¥—çš„ try/catch å—æŒ‰é¢„æœŸå·¥ä½œï¼Œå†…å±‚ catch å…ˆæ‰§è¡Œã€‚

## å¸¸è§æ¨¡å¼

### æ¨¡å¼ï¼šèµ„æºæ¸…ç†

å§‹ç»ˆä½¿ç”¨ `finally` è¿›è¡Œæ¸…ç†ï¼š

```hemlock
fn process_file(filename) {
    let file = null;
    try {
        file = open(filename);
        let content = file.read();
        process(content);
    } catch (e) {
        print("Error processing file: " + e);
    } finally {
        if (file != null) {
            file.close();  // å³ä½¿å‡ºé”™ä¹Ÿä¼šå…³é—­
        }
    }
}
```

### æ¨¡å¼ï¼šé”™è¯¯åŒ…è£…

ç”¨ä¸Šä¸‹æ–‡åŒ…è£…åº•å±‚é”™è¯¯ï¼š

```hemlock
fn load_config(path) {
    try {
        let content = read_file(path);
        return parse_json(content);
    } catch (e) {
        throw "Failed to load config from " + path + ": " + e;
    }
}
```

### æ¨¡å¼ï¼šé”™è¯¯æ¢å¤

å‡ºé”™æ—¶æä¾›å›é€€å€¼ï¼š

```hemlock
fn safe_divide(a, b) {
    try {
        if (b == 0) {
            throw "division by zero";
        }
        return a / b;
    } catch (e) {
        print("Error: " + e);
        return null;  // å›é€€å€¼
    }
}
```

### æ¨¡å¼ï¼šéªŒè¯

ä½¿ç”¨å¼‚å¸¸è¿›è¡ŒéªŒè¯ï¼š

```hemlock
fn validate_user(user) {
    if (user.name == null || user.name == "") {
        throw "Name is required";
    }
    if (user.age < 0 || user.age > 150) {
        throw "Invalid age";
    }
    if (user.email == null || !user.email.contains("@")) {
        throw "Invalid email";
    }
}

try {
    validate_user({ name: "Alice", age: -5, email: "invalid" });
} catch (e) {
    print("Validation failed: " + e);
}
```

### æ¨¡å¼ï¼šå¤šç§é”™è¯¯ç±»å‹

ä½¿ç”¨é”™è¯¯å¯¹è±¡åŒºåˆ†é”™è¯¯ç±»å‹ï¼š

```hemlock
fn process_data(data) {
    if (data == null) {
        throw { type: "NullData", message: "Data is null" };
    }

    if (typeof(data) != "array") {
        throw { type: "TypeError", message: "Expected array" };
    }

    if (data.length == 0) {
        throw { type: "EmptyData", message: "Array is empty" };
    }

    // ... å¤„ç†
}

try {
    process_data(null);
} catch (e) {
    if (e.type == "NullData") {
        print("No data provided");
    } else if (e.type == "TypeError") {
        print("Wrong data type: " + e.message);
    } else {
        print("Error: " + e.message);
    }
}
```

## æœ€ä½³å®è·µ

1. **å¯¹å¼‚å¸¸æƒ…å†µä½¿ç”¨å¼‚å¸¸** - ä¸è¦ç”¨äºæ­£å¸¸æ§åˆ¶æµ
2. **æŠ›å‡ºæœ‰æ„ä¹‰çš„é”™è¯¯** - ä½¿ç”¨å¸¦ä¸Šä¸‹æ–‡çš„å­—ç¬¦ä¸²æˆ–å¯¹è±¡
3. **å§‹ç»ˆä½¿ç”¨ finally è¿›è¡Œæ¸…ç†** - ç¡®ä¿èµ„æºè¢«é‡Šæ”¾
4. **ä¸è¦æ•è·åå¿½ç•¥** - è‡³å°‘è®°å½•é”™è¯¯
5. **é€‚å½“æ—¶é‡æ–°æŠ›å‡º** - å¦‚æœä½ æ— æ³•å¤„ç†ï¼Œè®©è°ƒç”¨è€…å¤„ç†
6. **å¯¹ bug ä½¿ç”¨ panic** - å¯¹ä¸å¯æ¢å¤çš„é”™è¯¯ä½¿ç”¨ panic
7. **æ–‡æ¡£åŒ–å¼‚å¸¸** - æ˜ç¡®è¯´æ˜å“ªäº›å‡½æ•°å¯èƒ½æŠ›å‡ºå¼‚å¸¸

## å¸¸è§é™·é˜±

### é™·é˜±ï¼šåæ‰é”™è¯¯

```hemlock
// ä¸å¥½ï¼šé™é»˜å¤±è´¥
try {
    risky_operation();
} catch (e) {
    // é”™è¯¯è¢«å¿½ç•¥ - é™é»˜å¤±è´¥
}

// å¥½ï¼šè®°å½•æˆ–å¤„ç†
try {
    risky_operation();
} catch (e) {
    print("Operation failed: " + e);
    // é€‚å½“å¤„ç†
}
```

### é™·é˜±ï¼šFinally è¦†ç›–

```hemlock
// ä¸å¥½ï¼šfinally è¦†ç›–è¿”å›å€¼
fn get_value() {
    try {
        return 42;
    } finally {
        return 0;  // è¿”å› 0ï¼Œè€Œä¸æ˜¯ 42ï¼
    }
}

// å¥½ï¼šä¸è¦åœ¨ finally ä¸­è¿”å›
fn get_value() {
    try {
        return 42;
    } finally {
        cleanup();  // åªåšæ¸…ç†ï¼Œä¸è¿”å›
    }
}
```

### é™·é˜±ï¼šå¿˜è®°æ¸…ç†

```hemlock
// ä¸å¥½ï¼šå‡ºé”™æ—¶æ–‡ä»¶å¯èƒ½ä¸ä¼šå…³é—­
fn process() {
    let file = open("data.txt");
    let content = file.read();  // å¯èƒ½æŠ›å‡ºå¼‚å¸¸
    file.close();  // å¦‚æœå‡ºé”™æ°¸è¿œä¸ä¼šåˆ°è¾¾
}

// å¥½ï¼šä½¿ç”¨ finally
fn process() {
    let file = null;
    try {
        file = open("data.txt");
        let content = file.read();
    } finally {
        if (file != null) {
            file.close();
        }
    }
}
```

### é™·é˜±ï¼šå¯¹é¢„æœŸé”™è¯¯ä½¿ç”¨ Panic

```hemlock
// ä¸å¥½ï¼šå¯¹é¢„æœŸé”™è¯¯ä½¿ç”¨ panic
fn read_config(path) {
    if (!file_exists(path)) {
        panic("Config file not found");  // å¤ªä¸¥å‰äº†
    }
    return read_file(path);
}

// å¥½ï¼šå¯¹é¢„æœŸé”™è¯¯ä½¿ç”¨ throw
fn read_config(path) {
    if (!file_exists(path)) {
        throw "Config file not found: " + path;  // å¯æ¢å¤
    }
    return read_file(path);
}
```

## ç¤ºä¾‹

### ç¤ºä¾‹ï¼šåŸºæœ¬é”™è¯¯å¤„ç†

```hemlock
fn divide(a, b) {
    if (b == 0) {
        throw "division by zero";
    }
    return a / b;
}

try {
    print(divide(10, 0));
} catch (e) {
    print("Error: " + e);  // æ‰“å°ï¼šError: division by zero
}
```

### ç¤ºä¾‹ï¼šèµ„æºç®¡ç†

```hemlock
fn copy_file(src, dst) {
    let src_file = null;
    let dst_file = null;

    try {
        src_file = open(src, "r");
        dst_file = open(dst, "w");

        let content = src_file.read();
        dst_file.write(content);

        print("File copied successfully");
    } catch (e) {
        print("Failed to copy file: " + e);
        throw e;  // é‡æ–°æŠ›å‡º
    } finally {
        if (src_file != null) { src_file.close(); }
        if (dst_file != null) { dst_file.close(); }
    }
}
```

### ç¤ºä¾‹ï¼šåµŒå¥—é”™è¯¯å¤„ç†

```hemlock
fn process_users(users) {
    let success_count = 0;
    let error_count = 0;

    let i = 0;
    while (i < users.length) {
        try {
            validate_user(users[i]);
            save_user(users[i]);
            success_count = success_count + 1;
        } catch (e) {
            print("Failed to process user: " + e);
            error_count = error_count + 1;
        }
        i = i + 1;
    }

    print("Processed: " + typeof(success_count) + " success, " + typeof(error_count) + " errors");
}
```

### ç¤ºä¾‹ï¼šè‡ªå®šä¹‰é”™è¯¯ç±»å‹

```hemlock
fn create_error(type, message, details) {
    return {
        type: type,
        message: message,
        details: details,
        toString: fn() {
            return self.type + ": " + self.message;
        }
    };
}

fn divide(a, b) {
    if (typeof(a) != "i32" && typeof(a) != "f64") {
        throw create_error("TypeError", "a must be a number", { value: a });
    }
    if (typeof(b) != "i32" && typeof(b) != "f64") {
        throw create_error("TypeError", "b must be a number", { value: b });
    }
    if (b == 0) {
        throw create_error("DivisionByZero", "Cannot divide by zero", { a: a, b: b });
    }
    return a / b;
}

try {
    divide(10, 0);
} catch (e) {
    print(e.toString());
    if (e.type == "DivisionByZero") {
        print("Details: a=" + typeof(e.details.a) + ", b=" + typeof(e.details.b));
    }
}
```

### ç¤ºä¾‹ï¼šé‡è¯•é€»è¾‘

```hemlock
fn retry(operation, max_attempts) {
    let attempt = 0;

    while (attempt < max_attempts) {
        try {
            return operation();  // æˆåŠŸï¼
        } catch (e) {
            attempt = attempt + 1;
            if (attempt >= max_attempts) {
                throw "Operation failed after " + typeof(max_attempts) + " attempts: " + e;
            }
            print("Attempt " + typeof(attempt) + " failed, retrying...");
        }
    }
}

fn unreliable_operation() {
    // æ¨¡æ‹Ÿä¸ç¨³å®šçš„æ“ä½œ
    if (random() < 0.7) {
        throw "Operation failed";
    }
    return "Success";
}

try {
    let result = retry(unreliable_operation, 3);
    print(result);
} catch (e) {
    print("All retries failed: " + e);
}
```

## æ‰§è¡Œé¡ºåº

ç†è§£æ‰§è¡Œé¡ºåºï¼š

```hemlock
try {
    print("1: try block start");
    throw "error";
    print("2: never reached");
} catch (e) {
    print("3: catch block");
} finally {
    print("4: finally block");
}
print("5: after try/catch/finally");

// è¾“å‡ºï¼š
// 1: try block start
// 3: catch block
// 4: finally block
// 5: after try/catch/finally
```

## å½“å‰é™åˆ¶

- **æ²¡æœ‰å †æ ˆè·Ÿè¸ª** - æœªæ•è·çš„å¼‚å¸¸ä¸æ˜¾ç¤ºå †æ ˆè·Ÿè¸ªï¼ˆå·²è®¡åˆ’ï¼‰
- **æŸäº›å†…ç½®å‡½æ•°ä¼šé€€å‡º** - æŸäº›å†…ç½®å‡½æ•°ä»ç„¶ä½¿ç”¨ `exit()` è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼ˆå¾…å®¡æŸ¥ï¼‰
- **æ²¡æœ‰è‡ªå®šä¹‰å¼‚å¸¸ç±»å‹** - ä»»ä½•å€¼éƒ½å¯ä»¥è¢«æŠ›å‡ºï¼Œä½†æ²¡æœ‰æ­£å¼çš„å¼‚å¸¸å±‚æ¬¡ç»“æ„

## ç›¸å…³ä¸»é¢˜

- [å‡½æ•°](#language-guide-functions) - å¼‚å¸¸å’Œå‡½æ•°è¿”å›
- [æ§åˆ¶æµ](#language-guide-control-flow) - å¼‚å¸¸å¦‚ä½•å½±å“æ§åˆ¶æµ
- [å†…å­˜](#language-guide-memory) - ä½¿ç”¨ finally è¿›è¡Œå†…å­˜æ¸…ç†

## å¦è¯·å‚é˜…

- **å¼‚å¸¸è¯­ä¹‰**ï¼šå‚è§ CLAUDE.md ä¸­çš„"é”™è¯¯å¤„ç†"éƒ¨åˆ†
- **Panic vs Throw**ï¼šä¸åŒé”™è¯¯ç±»å‹çš„ä¸åŒç”¨ä¾‹
- **Finally ä¿è¯**ï¼šå§‹ç»ˆæ‰§è¡Œï¼Œå³ä½¿æœ‰ return/break/continue



################################################################################
# é«˜çº§ä¸»é¢˜
################################################################################

--------------------------------------------------------------------------------
## FFI
--------------------------------------------------------------------------------

# Hemlock å¤–éƒ¨å‡½æ•°æ¥å£ï¼ˆFFIï¼‰

Hemlock æä¾› **FFIï¼ˆå¤–éƒ¨å‡½æ•°æ¥å£ï¼‰**ï¼Œå¯ä½¿ç”¨ libffi è°ƒç”¨å…±äº«åº“ä¸­çš„ C å‡½æ•°ï¼Œå®ç°ä¸ç°æœ‰ C åº“å’Œç³»ç»Ÿ API çš„é›†æˆã€‚

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [å½“å‰çŠ¶æ€](#å½“å‰çŠ¶æ€)
- [æ”¯æŒçš„ç±»å‹](#æ”¯æŒçš„ç±»å‹)
- [åŸºæœ¬æ¦‚å¿µ](#åŸºæœ¬æ¦‚å¿µ)
- [å¯¼å‡º FFI å‡½æ•°](#å¯¼å‡º-ffi-å‡½æ•°)
- [ç”¨ä¾‹](#ç”¨ä¾‹)
- [æœªæ¥å‘å±•](#æœªæ¥å‘å±•)
- [FFI å›è°ƒ](#ffi-å›è°ƒ)
- [FFI ç»“æ„ä½“](#ffi-ç»“æ„ä½“)
- [å½“å‰é™åˆ¶](#å½“å‰é™åˆ¶)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## æ¦‚è¿°

å¤–éƒ¨å‡½æ•°æ¥å£ï¼ˆFFIï¼‰å…è®¸ Hemlock ç¨‹åºï¼š
- ä»å…±äº«åº“ï¼ˆ.soã€.dylibã€.dllï¼‰è°ƒç”¨ C å‡½æ•°
- ä½¿ç”¨ç°æœ‰ C åº“è€Œæ— éœ€ç¼–å†™åŒ…è£…ä»£ç 
- ç›´æ¥è®¿é—®ç³»ç»Ÿ API
- ä¸ç¬¬ä¸‰æ–¹åŸç”Ÿåº“é›†æˆ
- å°† Hemlock ä¸åº•å±‚ç³»ç»ŸåŠŸèƒ½æ¡¥æ¥

**å…³é”®èƒ½åŠ›ï¼š**
- åŠ¨æ€åº“åŠ è½½
- C å‡½æ•°ç»‘å®š
- Hemlock å’Œ C ç±»å‹ä¹‹é—´çš„è‡ªåŠ¨ç±»å‹è½¬æ¢
- æ”¯æŒæ‰€æœ‰åŸå§‹ç±»å‹
- åŸºäº libffi çš„å®ç°ï¼Œå…·æœ‰å¯ç§»æ¤æ€§

## å½“å‰çŠ¶æ€

Hemlock ä¸­çš„ FFI æ”¯æŒå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

**å·²å®ç°ï¼š**
- ä»å…±äº«åº“è°ƒç”¨ C å‡½æ•°
- æ”¯æŒæ‰€æœ‰åŸå§‹ç±»å‹ï¼ˆæ•´æ•°ã€æµ®ç‚¹æ•°ã€æŒ‡é’ˆï¼‰
- è‡ªåŠ¨ç±»å‹è½¬æ¢
- åŸºäº libffi çš„å®ç°
- åŠ¨æ€åº“åŠ è½½
- **å‡½æ•°æŒ‡é’ˆå›è°ƒ** - å°† Hemlock å‡½æ•°ä¼ é€’ç»™ C
- **å¯¼å‡º extern å‡½æ•°** - è·¨æ¨¡å—å…±äº« FFI ç»‘å®š
- **ç»“æ„ä½“ä¼ é€’å’Œè¿”å›å€¼** - æŒ‰å€¼ä¼ é€’ C å…¼å®¹çš„ç»“æ„ä½“
- **å®Œæ•´çš„æŒ‡é’ˆè¾…åŠ©å‡½æ•°** - è¯»å†™æ‰€æœ‰ç±»å‹ï¼ˆi8-i64, u8-u64, f32, f64, ptrï¼‰
- **ç¼“å†²åŒº/æŒ‡é’ˆè½¬æ¢** - `buffer_ptr()`ã€`ptr_to_buffer()`
- **FFI ç±»å‹å¤§å°** - `ffi_sizeof()` ç”¨äºå¹³å°æ„ŸçŸ¥çš„ç±»å‹å¤§å°
- **å¹³å°ç±»å‹** - æ”¯æŒ `size_t`ã€`usize`ã€`isize`ã€`intptr_t`

**å¼€å‘ä¸­ï¼š**
- å­—ç¬¦ä¸²å°é€è¾…åŠ©å‡½æ•°
- é”™è¯¯å¤„ç†æ”¹è¿›

## æ”¯æŒçš„ç±»å‹

### åŸå§‹ç±»å‹

ä»¥ä¸‹ Hemlock ç±»å‹å¯ä»¥ä¼ é€’ç»™ C å‡½æ•°æˆ–ä» C å‡½æ•°è¿”å›ï¼š

| Hemlock ç±»å‹ | C ç±»å‹ | å¤§å° | è¯´æ˜ |
|--------------|--------|------|------|
| `i8` | `int8_t` | 1 å­—èŠ‚ | æœ‰ç¬¦å· 8 ä½æ•´æ•° |
| `i16` | `int16_t` | 2 å­—èŠ‚ | æœ‰ç¬¦å· 16 ä½æ•´æ•° |
| `i32` | `int32_t` | 4 å­—èŠ‚ | æœ‰ç¬¦å· 32 ä½æ•´æ•° |
| `i64` | `int64_t` | 8 å­—èŠ‚ | æœ‰ç¬¦å· 64 ä½æ•´æ•° |
| `u8` | `uint8_t` | 1 å­—èŠ‚ | æ— ç¬¦å· 8 ä½æ•´æ•° |
| `u16` | `uint16_t` | 2 å­—èŠ‚ | æ— ç¬¦å· 16 ä½æ•´æ•° |
| `u32` | `uint32_t` | 4 å­—èŠ‚ | æ— ç¬¦å· 32 ä½æ•´æ•° |
| `u64` | `uint64_t` | 8 å­—èŠ‚ | æ— ç¬¦å· 64 ä½æ•´æ•° |
| `f32` | `float` | 4 å­—èŠ‚ | 32 ä½æµ®ç‚¹æ•° |
| `f64` | `double` | 8 å­—èŠ‚ | 64 ä½æµ®ç‚¹æ•° |
| `ptr` | `void*` | 8 å­—èŠ‚ | åŸå§‹æŒ‡é’ˆ |

### ç±»å‹è½¬æ¢

**è‡ªåŠ¨è½¬æ¢ï¼š**
- Hemlock æ•´æ•° -> C æ•´æ•°ï¼ˆå¸¦èŒƒå›´æ£€æŸ¥ï¼‰
- Hemlock æµ®ç‚¹æ•° -> C æµ®ç‚¹æ•°
- Hemlock æŒ‡é’ˆ -> C æŒ‡é’ˆ
- C è¿”å›å€¼ -> Hemlock å€¼

**ç¤ºä¾‹ç±»å‹æ˜ å°„ï¼š**
```hemlock
// Hemlock -> C
let i: i32 = 42;         // -> int32_t (4 å­—èŠ‚)
let f: f64 = 3.14;       // -> double (8 å­—èŠ‚)
let p: ptr = alloc(64);  // -> void* (8 å­—èŠ‚)

// C -> Hemlockï¼ˆè¿”å›å€¼ï¼‰
// int32_t foo() -> i32
// double bar() -> f64
// void* baz() -> ptr
```

## åŸºæœ¬æ¦‚å¿µ

### å…±äº«åº“

FFI ä¸ç¼–è¯‘åçš„å…±äº«åº“é…åˆä½¿ç”¨ï¼š

**Linux:** `.so` æ–‡ä»¶
```
libexample.so
/usr/lib/libm.so
```

**macOS:** `.dylib` æ–‡ä»¶
```
libexample.dylib
/usr/lib/libSystem.dylib
```

**Windows:** `.dll` æ–‡ä»¶
```
example.dll
kernel32.dll
```

### å‡½æ•°ç­¾å

C å‡½æ•°å¿…é¡»å…·æœ‰å·²çŸ¥çš„ç­¾åæ‰èƒ½è®© FFI æ­£å¸¸å·¥ä½œï¼š

```c
// ç¤ºä¾‹ C å‡½æ•°ç­¾å
int add(int a, int b);
double sqrt(double x);
void* malloc(size_t size);
void free(void* ptr);
```

ä¸€æ—¦åŠ è½½åº“å¹¶ç»‘å®šå‡½æ•°ï¼Œå°±å¯ä»¥ä» Hemlock è°ƒç”¨è¿™äº›å‡½æ•°ã€‚

### å¹³å°å…¼å®¹æ€§

FFI ä½¿ç”¨ **libffi** å®ç°å¯ç§»æ¤æ€§ï¼š
- é€‚ç”¨äº x86ã€x86-64ã€ARMã€ARM64
- è‡ªåŠ¨å¤„ç†è°ƒç”¨çº¦å®š
- æŠ½è±¡å¹³å°ç‰¹å®šçš„ ABI ç»†èŠ‚
- æ”¯æŒ Linuxã€macOSã€Windowsï¼ˆéœ€è¦é€‚å½“çš„ libffiï¼‰

## å¯¼å‡º FFI å‡½æ•°

ä½¿ç”¨ `extern fn` å£°æ˜çš„ FFI å‡½æ•°å¯ä»¥ä»æ¨¡å—å¯¼å‡ºï¼Œå…è®¸æ‚¨åˆ›å»ºå¯è·¨å¤šä¸ªæ–‡ä»¶å…±äº«çš„å¯é‡ç”¨åº“åŒ…è£…å™¨ã€‚

### åŸºæœ¬å¯¼å‡ºè¯­æ³•

```hemlock
// string_utils.hml - åŒ…è£… C å­—ç¬¦ä¸²å‡½æ•°çš„åº“æ¨¡å—
import "libc.so.6";

// ç›´æ¥å¯¼å‡º extern å‡½æ•°
export extern fn strlen(s: string): i32;
export extern fn strcmp(s1: string, s2: string): i32;

// æ‚¨ä¹Ÿå¯ä»¥åœ¨ extern å‡½æ•°æ—è¾¹å¯¼å‡ºåŒ…è£…å‡½æ•°
export fn string_length(s: string): i32 {
    return strlen(s);
}

export fn strings_equal(a: string, b: string): bool {
    return strcmp(a, b) == 0;
}
```

### å¯¼å…¥å¯¼å‡ºçš„ FFI å‡½æ•°

```hemlock
// main.hml - ä½¿ç”¨å¯¼å‡ºçš„ FFI å‡½æ•°
import { strlen, string_length, strings_equal } from "./string_utils.hml";

let msg = "Hello, World!";
print(strlen(msg));           // 13 - ç›´æ¥ extern è°ƒç”¨
print(string_length(msg));    // 13 - åŒ…è£…å‡½æ•°

print(strings_equal("foo", "foo"));  // true
print(strings_equal("foo", "bar"));  // false
```

### Export Extern çš„ç”¨ä¾‹

**1. å¹³å°æŠ½è±¡**
```hemlock
// platform.hml - æŠ½è±¡å¹³å°å·®å¼‚
import "libc.so.6";  // Linux

export extern fn getpid(): i32;
export extern fn getuid(): i32;
export extern fn geteuid(): i32;
```

**2. åº“åŒ…è£…å™¨**
```hemlock
// crypto_lib.hml - åŒ…è£…åŠ å¯†åº“å‡½æ•°
import "libcrypto.so";

export extern fn SHA256(data: ptr, len: u64, out: ptr): ptr;
export extern fn MD5(data: ptr, len: u64, out: ptr): ptr;

// æ·»åŠ  Hemlock å‹å¥½çš„åŒ…è£…å™¨
export fn sha256_string(s: string): string {
    // ä½¿ç”¨ extern å‡½æ•°çš„å®ç°
}
```

**3. é›†ä¸­å¼ FFI å£°æ˜**
```hemlock
// libc.hml - libc ç»‘å®šçš„ä¸­å¤®æ¨¡å—
import "libc.so.6";

// å­—ç¬¦ä¸²å‡½æ•°
export extern fn strlen(s: string): i32;
export extern fn strcpy(dest: ptr, src: string): ptr;
export extern fn strcat(dest: ptr, src: string): ptr;

// å†…å­˜å‡½æ•°
export extern fn malloc(size: u64): ptr;
export extern fn realloc(p: ptr, size: u64): ptr;
export extern fn calloc(nmemb: u64, size: u64): ptr;

// è¿›ç¨‹å‡½æ•°
export extern fn getpid(): i32;
export extern fn getppid(): i32;
export extern fn getenv(name: string): ptr;
```

ç„¶ååœ¨æ•´ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨ï¼š
```hemlock
import { strlen, malloc, getpid } from "./libc.hml";
```

## ç”¨ä¾‹

### 1. ç³»ç»Ÿåº“

è®¿é—®æ ‡å‡† C åº“å‡½æ•°ï¼š

**æ•°å­¦å‡½æ•°ï¼š**
```hemlock
// ä» libm è°ƒç”¨ sqrt
let result = sqrt(16.0);  // 4.0
```

**å†…å­˜åˆ†é…ï¼š**
```hemlock
// ä» libc è°ƒç”¨ malloc/free
let ptr = malloc(1024);
free(ptr);
```

### 2. ç¬¬ä¸‰æ–¹åº“

ä½¿ç”¨ç°æœ‰çš„ C åº“ï¼š

**ç¤ºä¾‹ï¼šå›¾åƒå¤„ç†**
```hemlock
// åŠ è½½ libpng æˆ– libjpeg
// ä½¿ç”¨ C åº“å‡½æ•°å¤„ç†å›¾åƒ
```

**ç¤ºä¾‹ï¼šåŠ å¯†**
```hemlock
// ä½¿ç”¨ OpenSSL æˆ– libsodium
// é€šè¿‡ FFI è¿›è¡ŒåŠ å¯†/è§£å¯†
```

### 3. ç³»ç»Ÿ API

ç›´æ¥ç³»ç»Ÿè°ƒç”¨ï¼š

**ç¤ºä¾‹ï¼šPOSIX API**
```hemlock
// è°ƒç”¨ getpidã€getuid ç­‰
// è®¿é—®åº•å±‚ç³»ç»ŸåŠŸèƒ½
```

### 4. æ€§èƒ½å…³é”®ä»£ç 

è°ƒç”¨ä¼˜åŒ–çš„ C å®ç°ï¼š

```hemlock
// ä½¿ç”¨é«˜åº¦ä¼˜åŒ–çš„ C åº“
// SIMD æ“ä½œã€å‘é‡åŒ–ä»£ç 
// ç¡¬ä»¶åŠ é€Ÿå‡½æ•°
```

## FFI å›è°ƒ

Hemlock æ”¯æŒä½¿ç”¨ libffi é—­åŒ…å°†å‡½æ•°ä½œä¸ºå›è°ƒä¼ é€’ç»™ C ä»£ç ã€‚è¿™ä½¿å¾—èƒ½å¤Ÿä¸æœŸæœ›å‡½æ•°æŒ‡é’ˆçš„ C API é›†æˆï¼Œå¦‚ `qsort`ã€äº‹ä»¶å¾ªç¯å’ŒåŸºäºå›è°ƒçš„åº“ã€‚

### åˆ›å»ºå›è°ƒ

ä½¿ç”¨ `callback()` ä» Hemlock å‡½æ•°åˆ›å»º C å¯è°ƒç”¨çš„å‡½æ•°æŒ‡é’ˆï¼š

```hemlock
// callback(function, param_types, return_type) -> ptr
let cb = callback(my_function, ["ptr", "ptr"], "i32");
```

**å‚æ•°ï¼š**
- `function`ï¼šè¦åŒ…è£…çš„ Hemlock å‡½æ•°
- `param_types`ï¼šç±»å‹åç§°å­—ç¬¦ä¸²æ•°ç»„ï¼ˆå¦‚ `["ptr", "i32"]`ï¼‰
- `return_type`ï¼šè¿”å›ç±»å‹å­—ç¬¦ä¸²ï¼ˆå¦‚ `"i32"`ã€`"void"`ï¼‰

**æ”¯æŒçš„å›è°ƒç±»å‹ï¼š**
- `"i8"`, `"i16"`, `"i32"`, `"i64"` - æœ‰ç¬¦å·æ•´æ•°
- `"u8"`, `"u16"`, `"u32"`, `"u64"` - æ— ç¬¦å·æ•´æ•°
- `"f32"`, `"f64"` - æµ®ç‚¹æ•°
- `"ptr"` - æŒ‡é’ˆ
- `"void"` - æ— è¿”å›å€¼
- `"bool"` - å¸ƒå°”å€¼

### ç¤ºä¾‹ï¼šqsort

```hemlock
import "libc.so.6";
extern fn qsort(base: ptr, nmemb: u64, size: u64, compar: ptr): void;

// æ•´æ•°æ¯”è¾ƒå‡½æ•°ï¼ˆå‡åºï¼‰
fn compare_ints(a: ptr, b: ptr): i32 {
    let va = ptr_deref_i32(a);
    let vb = ptr_deref_i32(b);
    if (va < vb) { return -1; }
    if (va > vb) { return 1; }
    return 0;
}

// åˆ†é… 5 ä¸ªæ•´æ•°çš„æ•°ç»„
let arr = alloc(20);  // 5 * 4 å­—èŠ‚
ptr_write_i32(arr, 5);
ptr_write_i32(ptr_offset(arr, 1, 4), 2);
ptr_write_i32(ptr_offset(arr, 2, 4), 8);
ptr_write_i32(ptr_offset(arr, 3, 4), 1);
ptr_write_i32(ptr_offset(arr, 4, 4), 9);

// åˆ›å»ºå›è°ƒå¹¶æ’åº
let cmp = callback(compare_ints, ["ptr", "ptr"], "i32");
qsort(arr, 5, 4, cmp);

// æ•°ç»„ç°åœ¨å·²æ’åºï¼š[1, 2, 5, 8, 9]

// æ¸…ç†
callback_free(cmp);
free(arr);
```

### æŒ‡é’ˆè¾…åŠ©å‡½æ•°

Hemlock æä¾›å…¨é¢çš„è¾…åŠ©å‡½æ•°ç”¨äºå¤„ç†åŸå§‹æŒ‡é’ˆã€‚è¿™äº›å¯¹äº FFI å›è°ƒå’Œç›´æ¥å†…å­˜æ“ä½œè‡³å…³é‡è¦ã€‚

#### æ•´æ•°ç±»å‹è¾…åŠ©å‡½æ•°

| å‡½æ•° | æè¿° |
|------|------|
| `ptr_deref_i8(ptr)` | è§£å¼•ç”¨æŒ‡é’ˆï¼Œè¯»å– i8 |
| `ptr_deref_i16(ptr)` | è§£å¼•ç”¨æŒ‡é’ˆï¼Œè¯»å– i16 |
| `ptr_deref_i32(ptr)` | è§£å¼•ç”¨æŒ‡é’ˆï¼Œè¯»å– i32 |
| `ptr_deref_i64(ptr)` | è§£å¼•ç”¨æŒ‡é’ˆï¼Œè¯»å– i64 |
| `ptr_deref_u8(ptr)` | è§£å¼•ç”¨æŒ‡é’ˆï¼Œè¯»å– u8 |
| `ptr_deref_u16(ptr)` | è§£å¼•ç”¨æŒ‡é’ˆï¼Œè¯»å– u16 |
| `ptr_deref_u32(ptr)` | è§£å¼•ç”¨æŒ‡é’ˆï¼Œè¯»å– u32 |
| `ptr_deref_u64(ptr)` | è§£å¼•ç”¨æŒ‡é’ˆï¼Œè¯»å– u64 |
| `ptr_write_i8(ptr, value)` | å‘æŒ‡é’ˆä½ç½®å†™å…¥ i8 |
| `ptr_write_i16(ptr, value)` | å‘æŒ‡é’ˆä½ç½®å†™å…¥ i16 |
| `ptr_write_i32(ptr, value)` | å‘æŒ‡é’ˆä½ç½®å†™å…¥ i32 |
| `ptr_write_i64(ptr, value)` | å‘æŒ‡é’ˆä½ç½®å†™å…¥ i64 |
| `ptr_write_u8(ptr, value)` | å‘æŒ‡é’ˆä½ç½®å†™å…¥ u8 |
| `ptr_write_u16(ptr, value)` | å‘æŒ‡é’ˆä½ç½®å†™å…¥ u16 |
| `ptr_write_u32(ptr, value)` | å‘æŒ‡é’ˆä½ç½®å†™å…¥ u32 |
| `ptr_write_u64(ptr, value)` | å‘æŒ‡é’ˆä½ç½®å†™å…¥ u64 |

#### æµ®ç‚¹ç±»å‹è¾…åŠ©å‡½æ•°

| å‡½æ•° | æè¿° |
|------|------|
| `ptr_deref_f32(ptr)` | è§£å¼•ç”¨æŒ‡é’ˆï¼Œè¯»å– f32 (float) |
| `ptr_deref_f64(ptr)` | è§£å¼•ç”¨æŒ‡é’ˆï¼Œè¯»å– f64 (double) |
| `ptr_write_f32(ptr, value)` | å‘æŒ‡é’ˆä½ç½®å†™å…¥ f32 |
| `ptr_write_f64(ptr, value)` | å‘æŒ‡é’ˆä½ç½®å†™å…¥ f64 |

#### æŒ‡é’ˆç±»å‹è¾…åŠ©å‡½æ•°

| å‡½æ•° | æè¿° |
|------|------|
| `ptr_deref_ptr(ptr)` | è§£å¼•ç”¨æŒ‡å‘æŒ‡é’ˆçš„æŒ‡é’ˆ |
| `ptr_write_ptr(ptr, value)` | å‘æŒ‡é’ˆä½ç½®å†™å…¥æŒ‡é’ˆ |
| `ptr_offset(ptr, index, size)` | è®¡ç®—åç§»ï¼š`ptr + index * size` |
| `ptr_read_i32(ptr)` | é€šè¿‡æŒ‡å‘æŒ‡é’ˆçš„æŒ‡é’ˆè¯»å– i32ï¼ˆç”¨äº qsort å›è°ƒï¼‰ |
| `ptr_null()` | è·å–ç©ºæŒ‡é’ˆå¸¸é‡ |

#### ç¼“å†²åŒºè½¬æ¢è¾…åŠ©å‡½æ•°

| å‡½æ•° | æè¿° |
|------|------|
| `buffer_ptr(buffer)` | ä»ç¼“å†²åŒºè·å–åŸå§‹æŒ‡é’ˆ |
| `ptr_to_buffer(ptr, size)` | ä»æŒ‡é’ˆå¤åˆ¶æ•°æ®åˆ°æ–°ç¼“å†²åŒº |

#### FFI å®ç”¨å‡½æ•°

| å‡½æ•° | æè¿° |
|------|------|
| `ffi_sizeof(type_name)` | è·å– FFI ç±»å‹çš„å­—èŠ‚å¤§å° |

**`ffi_sizeof` æ”¯æŒçš„ç±»å‹åç§°ï¼š**
- `"i8"`, `"i16"`, `"i32"`, `"i64"` - æœ‰ç¬¦å·æ•´æ•°ï¼ˆ1, 2, 4, 8 å­—èŠ‚ï¼‰
- `"u8"`, `"u16"`, `"u32"`, `"u64"` - æ— ç¬¦å·æ•´æ•°ï¼ˆ1, 2, 4, 8 å­—èŠ‚ï¼‰
- `"f32"`, `"f64"` - æµ®ç‚¹æ•°ï¼ˆ4, 8 å­—èŠ‚ï¼‰
- `"ptr"` - æŒ‡é’ˆï¼ˆ64 ä½ç³»ç»Ÿä¸Š 8 å­—èŠ‚ï¼‰
- `"size_t"`, `"usize"` - å¹³å°ç›¸å…³çš„å¤§å°ç±»å‹
- `"intptr_t"`, `"isize"` - å¹³å°ç›¸å…³çš„æœ‰ç¬¦å·æŒ‡é’ˆç±»å‹

### é‡Šæ”¾å›è°ƒ

**é‡è¦ï¼š** å§‹ç»ˆåœ¨ä½¿ç”¨å®Œå›è°ƒåé‡Šæ”¾å®ƒä»¬ä»¥é˜²æ­¢å†…å­˜æ³„æ¼ï¼š

```hemlock
let cb = callback(my_fn, ["ptr"], "void");
// ... ä½¿ç”¨å›è°ƒ ...
callback_free(cb);  // ä½¿ç”¨å®Œåé‡Šæ”¾
```

ç¨‹åºé€€å‡ºæ—¶å›è°ƒä¹Ÿä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚

### å›è°ƒä¸­çš„é—­åŒ…

å›è°ƒæ•è·å…¶é—­åŒ…ç¯å¢ƒï¼Œå› æ­¤å¯ä»¥è®¿é—®å¤–éƒ¨ä½œç”¨åŸŸå˜é‡ï¼š

```hemlock
let multiplier = 10;

fn scale(a: ptr, b: ptr): i32 {
    let va = ptr_deref_i32(a);
    let vb = ptr_deref_i32(b);
    // å¯ä»¥è®¿é—®å¤–éƒ¨ä½œç”¨åŸŸçš„ 'multiplier'
    return (va * multiplier) - (vb * multiplier);
}

let cmp = callback(scale, ["ptr", "ptr"], "i32");
```

### çº¿ç¨‹å®‰å…¨

å›è°ƒè°ƒç”¨é€šè¿‡äº’æ–¥é”åºåˆ—åŒ–ä»¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œå› ä¸º Hemlock è§£é‡Šå™¨ä¸æ˜¯å®Œå…¨çº¿ç¨‹å®‰å…¨çš„ã€‚è¿™æ„å‘³ç€ï¼š
- ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªå›è°ƒ
- å¯ä»¥å®‰å…¨åœ°ä¸å¤šçº¿ç¨‹ C åº“ä¸€èµ·ä½¿ç”¨
- å¦‚æœå›è°ƒä»å¤šä¸ªçº¿ç¨‹é¢‘ç¹è°ƒç”¨ï¼Œå¯èƒ½å½±å“æ€§èƒ½

### å›è°ƒä¸­çš„é”™è¯¯å¤„ç†

åœ¨å›è°ƒä¸­æŠ›å‡ºçš„å¼‚å¸¸æ— æ³•ä¼ æ’­åˆ° C ä»£ç ã€‚ç›¸åï¼š
- å‘ stderr æ‰“å°è­¦å‘Š
- å›è°ƒè¿”å›é»˜è®¤å€¼ï¼ˆ0 æˆ– NULLï¼‰
- å¼‚å¸¸è¢«è®°å½•ä½†ä¸ä¼ æ’­

```hemlock
fn risky_callback(a: ptr): i32 {
    throw "Something went wrong";  // æ‰“å°è­¦å‘Šï¼Œè¿”å› 0
}
```

ä¸ºäº†å¥å£®çš„é”™è¯¯å¤„ç†ï¼Œè¯·éªŒè¯è¾“å…¥å¹¶é¿å…åœ¨å›è°ƒä¸­æŠ›å‡ºå¼‚å¸¸ã€‚

## FFI ç»“æ„ä½“

Hemlock æ”¯æŒæŒ‰å€¼å‘ C å‡½æ•°ä¼ é€’ç»“æ„ä½“ã€‚å½“æ‚¨ä½¿ç”¨ç±»å‹æ³¨è§£å®šä¹‰ç»“æ„ä½“æ—¶ï¼Œç»“æ„ä½“ç±»å‹ä¼šè‡ªåŠ¨ä¸º FFI æ³¨å†Œã€‚

### å®šä¹‰ FFI å…¼å®¹çš„ç»“æ„ä½“

å½“æ‰€æœ‰å­—æ®µéƒ½å…·æœ‰ä½¿ç”¨ FFI å…¼å®¹ç±»å‹çš„æ˜¾å¼ç±»å‹æ³¨è§£æ—¶ï¼Œç»“æ„ä½“å°±æ˜¯ FFI å…¼å®¹çš„ï¼š

```hemlock
// FFI å…¼å®¹çš„ç»“æ„ä½“
define Point {
    x: f64,
    y: f64,
}

// å…·æœ‰å¤šç§å­—æ®µç±»å‹çš„ FFI å…¼å®¹ç»“æ„ä½“
define Rectangle {
    top_left: Point,      // åµŒå¥—ç»“æ„ä½“
    width: f64,
    height: f64,
}

// ä¸æ˜¯ FFI å…¼å®¹çš„ï¼ˆå­—æ®µæ²¡æœ‰ç±»å‹æ³¨è§£ï¼‰
define DynamicObject {
    name,                 // æ²¡æœ‰ç±»å‹ - ä¸èƒ½ç”¨äº FFI
    value,
}
```

### åœ¨ FFI ä¸­ä½¿ç”¨ç»“æ„ä½“

å£°æ˜ä½¿ç”¨ç»“æ„ä½“ç±»å‹çš„ extern å‡½æ•°ï¼š

```hemlock
// å®šä¹‰ç»“æ„ä½“ç±»å‹
define Vector2D {
    x: f64,
    y: f64,
}

// å¯¼å…¥ C åº“
import "libmath.so";

// å£°æ˜æ¥å—/è¿”å›ç»“æ„ä½“çš„ extern å‡½æ•°
extern fn vector_add(a: Vector2D, b: Vector2D): Vector2D;
extern fn vector_length(v: Vector2D): f64;

// è‡ªç„¶åœ°ä½¿ç”¨å®ƒ
let a: Vector2D = { x: 3.0, y: 0.0 };
let b: Vector2D = { x: 0.0, y: 4.0 };
let result = vector_add(a, b);
print(result.x);  // 3.0
print(result.y);  // 4.0

let len = vector_length(result);
print(len);       // 5.0
```

### æ”¯æŒçš„å­—æ®µç±»å‹

ç»“æ„ä½“å­—æ®µå¿…é¡»ä½¿ç”¨ä»¥ä¸‹ FFI å…¼å®¹ç±»å‹ï¼š

| Hemlock ç±»å‹ | C ç±»å‹ | å¤§å° |
|--------------|--------|------|
| `i8` | `int8_t` | 1 å­—èŠ‚ |
| `i16` | `int16_t` | 2 å­—èŠ‚ |
| `i32` | `int32_t` | 4 å­—èŠ‚ |
| `i64` | `int64_t` | 8 å­—èŠ‚ |
| `u8` | `uint8_t` | 1 å­—èŠ‚ |
| `u16` | `uint16_t` | 2 å­—èŠ‚ |
| `u32` | `uint32_t` | 4 å­—èŠ‚ |
| `u64` | `uint64_t` | 8 å­—èŠ‚ |
| `f32` | `float` | 4 å­—èŠ‚ |
| `f64` | `double` | 8 å­—èŠ‚ |
| `ptr` | `void*` | 8 å­—èŠ‚ |
| `string` | `char*` | 8 å­—èŠ‚ |
| `bool` | `int` | å¯å˜ |
| åµŒå¥—ç»“æ„ä½“ | struct | å¯å˜ |

### ç»“æ„ä½“å¸ƒå±€

Hemlock ä½¿ç”¨å¹³å°çš„åŸç”Ÿç»“æ„ä½“å¸ƒå±€è§„åˆ™ï¼ˆåŒ¹é… C ABIï¼‰ï¼š
- å­—æ®µæŒ‰å…¶ç±»å‹å¯¹é½
- æ ¹æ®éœ€è¦æ’å…¥å¡«å……
- æ€»å¤§å°å¡«å……ä»¥å¯¹é½æœ€å¤§æˆå‘˜

```hemlock
// ç¤ºä¾‹ï¼šC å…¼å®¹å¸ƒå±€
define Mixed {
    a: i8,    // åç§» 0ï¼Œå¤§å° 1
              // 3 å­—èŠ‚å¡«å……
    b: i32,   // åç§» 4ï¼Œå¤§å° 4
}
// æ€»å¤§å°ï¼š8 å­—èŠ‚ï¼ˆåŒ…å«å¡«å……ï¼‰

define Point3D {
    x: f64,   // åç§» 0ï¼Œå¤§å° 8
    y: f64,   // åç§» 8ï¼Œå¤§å° 8
    z: f64,   // åç§» 16ï¼Œå¤§å° 8
}
// æ€»å¤§å°ï¼š24 å­—èŠ‚ï¼ˆä¸éœ€è¦å¡«å……ï¼‰
```

### åµŒå¥—ç»“æ„ä½“

ç»“æ„ä½“å¯ä»¥åŒ…å«å…¶ä»–ç»“æ„ä½“ï¼š

```hemlock
define Inner {
    x: i32,
    y: i32,
}

define Outer {
    inner: Inner,
    z: i32,
}

import "mylib.so";
extern fn process_nested(data: Outer): i32;

let obj: Outer = {
    inner: { x: 1, y: 2 },
    z: 3,
};
let result = process_nested(obj);
```

### ç»“æ„ä½“è¿”å›å€¼

C å‡½æ•°å¯ä»¥è¿”å›ç»“æ„ä½“ï¼š

```hemlock
define Point {
    x: f64,
    y: f64,
}

import "libmath.so";
extern fn get_origin(): Point;

let p = get_origin();
print(p.x);  // 0.0
print(p.y);  // 0.0
```

### é™åˆ¶

- **ç»“æ„ä½“å­—æ®µå¿…é¡»æœ‰ç±»å‹æ³¨è§£** - æ²¡æœ‰ç±»å‹çš„å­—æ®µä¸æ˜¯ FFI å…¼å®¹çš„
- **ç»“æ„ä½“ä¸­æ²¡æœ‰æ•°ç»„** - æ”¹ç”¨æŒ‡é’ˆ
- **æ²¡æœ‰è”åˆä½“** - ä»…æ”¯æŒç»“æ„ä½“ç±»å‹
- **å›è°ƒä¸èƒ½è¿”å›ç»“æ„ä½“** - å›è°ƒè¿”å›å€¼ä½¿ç”¨æŒ‡é’ˆ

## å½“å‰é™åˆ¶

FFI æœ‰ä»¥ä¸‹é™åˆ¶ï¼š

**1. æ‰‹åŠ¨ç±»å‹è½¬æ¢**
- å¿…é¡»æ‰‹åŠ¨ç®¡ç†å­—ç¬¦ä¸²è½¬æ¢
- æ²¡æœ‰è‡ªåŠ¨çš„ Hemlock å­—ç¬¦ä¸² <-> C å­—ç¬¦ä¸²è½¬æ¢

**2. æœ‰é™çš„é”™è¯¯å¤„ç†**
- åŸºæœ¬é”™è¯¯æŠ¥å‘Š
- å›è°ƒä¸­çš„å¼‚å¸¸æ— æ³•ä¼ æ’­åˆ° C

**3. æ‰‹åŠ¨åº“åŠ è½½**
- å¿…é¡»æ‰‹åŠ¨åŠ è½½åº“
- æ²¡æœ‰è‡ªåŠ¨ç»‘å®šç”Ÿæˆ

**4. å¹³å°ç‰¹å®šä»£ç **
- åº“è·¯å¾„å› å¹³å°è€Œå¼‚
- å¿…é¡»å¤„ç† .so vs .dylib vs .dll

## æœ€ä½³å®è·µ

è™½ç„¶å…¨é¢çš„ FFI æ–‡æ¡£ä»åœ¨å¼€å‘ä¸­ï¼Œä»¥ä¸‹æ˜¯ä¸€èˆ¬çš„æœ€ä½³å®è·µï¼š

### 1. ç±»å‹å®‰å…¨

```hemlock
// æ˜ç¡®ç±»å‹
let x: i32 = 42;
let result: f64 = c_function(x);
```

### 2. å†…å­˜ç®¡ç†

```hemlock
// è®°ä½é‡Šæ”¾åˆ†é…çš„å†…å­˜
let ptr = c_malloc(1024);
// ... ä½¿ç”¨ ptr
c_free(ptr);
```

### 3. é”™è¯¯æ£€æŸ¥

```hemlock
// æ£€æŸ¥è¿”å›å€¼
let result = c_function();
if (result == null) {
    print("C function failed");
}
```

### 4. å¹³å°å…¼å®¹æ€§

```hemlock
// å¤„ç†å¹³å°å·®å¼‚
// ä½¿ç”¨é€‚å½“çš„åº“æ‰©å±•åï¼ˆ.soã€.dylibã€.dllï¼‰
```

## æ€»ç»“

Hemlock çš„ FFI æä¾›ï¼š

- ä»å…±äº«åº“è°ƒç”¨ C å‡½æ•°
- åŸå§‹ç±»å‹æ”¯æŒï¼ˆi8-i64, u8-u64, f32, f64, ptrï¼‰
- è‡ªåŠ¨ç±»å‹è½¬æ¢
- åŸºäº libffi çš„å¯ç§»æ¤æ€§
- åŸç”Ÿåº“é›†æˆåŸºç¡€
- **å‡½æ•°æŒ‡é’ˆå›è°ƒ** - å°† Hemlock å‡½æ•°ä¼ é€’ç»™ C
- **å¯¼å‡º extern å‡½æ•°** - è·¨æ¨¡å—å…±äº« FFI ç»‘å®š
- **ç»“æ„ä½“ä¼ é€’å’Œè¿”å›** - æŒ‰å€¼ä¼ é€’ C å…¼å®¹çš„ç»“æ„ä½“
- **å¯¼å‡º define** - è·¨æ¨¡å—å…±äº«ç»“æ„ä½“ç±»å‹å®šä¹‰ï¼ˆè‡ªåŠ¨å…¨å±€å¯¼å…¥ï¼‰
- **å®Œæ•´çš„æŒ‡é’ˆè¾…åŠ©å‡½æ•°** - è¯»å†™æ‰€æœ‰ç±»å‹ï¼ˆi8-i64, u8-u64, f32, f64, ptrï¼‰
- **ç¼“å†²åŒº/æŒ‡é’ˆè½¬æ¢** - ç”¨äºæ•°æ®å°é€çš„ `buffer_ptr()`ã€`ptr_to_buffer()`
- **FFI ç±»å‹å¤§å°** - å¹³å°æ„ŸçŸ¥ç±»å‹å¤§å°çš„ `ffi_sizeof()`
- **å¹³å°ç±»å‹** - æ”¯æŒ `size_t`ã€`usize`ã€`isize`ã€`intptr_t`ã€`uintptr_t`

**å½“å‰çŠ¶æ€ï¼š** FFI åŠŸèƒ½å®Œå¤‡ï¼Œæ”¯æŒåŸå§‹ç±»å‹ã€ç»“æ„ä½“ã€å›è°ƒã€æ¨¡å—å¯¼å‡ºå’Œå®Œæ•´çš„æŒ‡é’ˆè¾…åŠ©å‡½æ•°

**æœªæ¥ï¼š** å­—ç¬¦ä¸²å°é€è¾…åŠ©å‡½æ•°

**ç”¨ä¾‹ï¼š** ç³»ç»Ÿåº“ã€ç¬¬ä¸‰æ–¹åº“ã€qsortã€äº‹ä»¶å¾ªç¯ã€åŸºäºå›è°ƒçš„ APIã€å¯é‡ç”¨çš„åº“åŒ…è£…å™¨


--------------------------------------------------------------------------------
## File IO
--------------------------------------------------------------------------------

# Hemlock æ–‡ä»¶ I/O

Hemlock æä¾›**æ–‡ä»¶å¯¹è±¡ API**ç”¨äºæ–‡ä»¶æ“ä½œï¼Œå…·æœ‰é€‚å½“çš„é”™è¯¯å¤„ç†å’Œèµ„æºç®¡ç†ã€‚

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ‰“å¼€æ–‡ä»¶](#æ‰“å¼€æ–‡ä»¶)
- [æ–‡ä»¶æ–¹æ³•](#æ–‡ä»¶æ–¹æ³•)
- [æ–‡ä»¶å±æ€§](#æ–‡ä»¶å±æ€§)
- [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
- [èµ„æºç®¡ç†](#èµ„æºç®¡ç†)
- [å®Œæ•´ API å‚è€ƒ](#å®Œæ•´-api-å‚è€ƒ)
- [å¸¸è§æ¨¡å¼](#å¸¸è§æ¨¡å¼)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## æ¦‚è¿°

æ–‡ä»¶å¯¹è±¡ API æä¾›ï¼š

- **æ˜¾å¼èµ„æºç®¡ç†** - æ–‡ä»¶å¿…é¡»æ‰‹åŠ¨å…³é—­
- **å¤šç§æ‰“å¼€æ¨¡å¼** - è¯»å–ã€å†™å…¥ã€è¿½åŠ ã€è¯»å†™
- **æ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ“ä½œ** - è¯»å†™æ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ•°æ®
- **å®šä½æ”¯æŒ** - æ–‡ä»¶å†…çš„éšæœºè®¿é—®
- **å…¨é¢çš„é”™è¯¯æ¶ˆæ¯** - ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„é”™è¯¯æŠ¥å‘Š

**é‡è¦ï¼š** æ–‡ä»¶ä¸ä¼šè‡ªåŠ¨å…³é—­ã€‚æ‚¨å¿…é¡»è°ƒç”¨ `f.close()` ä»¥é¿å…æ–‡ä»¶æè¿°ç¬¦æ³„æ¼ã€‚

## æ‰“å¼€æ–‡ä»¶

ä½¿ç”¨ `open(path, mode?)` æ‰“å¼€æ–‡ä»¶ï¼š

```hemlock
let f = open("data.txt", "r");     // è¯»å–æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
let f2 = open("output.txt", "w");  // å†™å…¥æ¨¡å¼ï¼ˆæˆªæ–­ï¼‰
let f3 = open("log.txt", "a");     // è¿½åŠ æ¨¡å¼
let f4 = open("data.bin", "r+");   // è¯»å†™æ¨¡å¼
```

### æ‰“å¼€æ¨¡å¼

| æ¨¡å¼ | æè¿° | æ–‡ä»¶å¿…é¡»å­˜åœ¨ | æˆªæ–­ | ä½ç½® |
|------|------|------------|------|------|
| `"r"` | è¯»å–ï¼ˆé»˜è®¤ï¼‰ | æ˜¯ | å¦ | å¼€å§‹ |
| `"w"` | å†™å…¥ | å¦ï¼ˆåˆ›å»ºï¼‰ | æ˜¯ | å¼€å§‹ |
| `"a"` | è¿½åŠ  | å¦ï¼ˆåˆ›å»ºï¼‰ | å¦ | ç»“æŸ |
| `"r+"` | è¯»å†™ | æ˜¯ | å¦ | å¼€å§‹ |
| `"w+"` | è¯»å†™ | å¦ï¼ˆåˆ›å»ºï¼‰ | æ˜¯ | å¼€å§‹ |
| `"a+"` | è¯»å–å’Œè¿½åŠ  | å¦ï¼ˆåˆ›å»ºï¼‰ | å¦ | ç»“æŸ |

### ç¤ºä¾‹

**è¯»å–ç°æœ‰æ–‡ä»¶ï¼š**
```hemlock
let f = open("config.json", "r");
// æˆ–ç®€å•åœ°ï¼š
let f = open("config.json");  // "r" æ˜¯é»˜è®¤å€¼
```

**åˆ›å»ºæ–°æ–‡ä»¶ç”¨äºå†™å…¥ï¼š**
```hemlock
let f = open("output.txt", "w");  // åˆ›å»ºæˆ–æˆªæ–­
```

**è¿½åŠ åˆ°æ–‡ä»¶ï¼š**
```hemlock
let f = open("log.txt", "a");  // å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
```

**è¯»å†™æ¨¡å¼ï¼š**
```hemlock
let f = open("data.bin", "r+");  // ç°æœ‰æ–‡ä»¶ï¼Œå¯è¯»å†™
```

## æ–‡ä»¶æ–¹æ³•

### è¯»å–

#### read(size?: i32): string

ä»æ–‡ä»¶è¯»å–æ–‡æœ¬ï¼ˆå¯é€‰çš„å¤§å°å‚æ•°ï¼‰ã€‚

**ä¸å¸¦å¤§å°ï¼ˆè¯»å–å…¨éƒ¨ï¼‰ï¼š**
```hemlock
let f = open("data.txt", "r");
let all = f.read();  // ä»å½“å‰ä½ç½®è¯»å–åˆ° EOF
f.close();
```

**å¸¦å¤§å°ï¼ˆè¯»å–æŒ‡å®šå­—èŠ‚ï¼‰ï¼š**
```hemlock
let f = open("data.txt", "r");
let chunk = f.read(1024);  // è¯»å–æœ€å¤š 1024 å­—èŠ‚
let next = f.read(1024);   // è¯»å–ä¸‹ä¸€ä¸ª 1024 å­—èŠ‚
f.close();
```

**è¿”å›ï¼š** åŒ…å«è¯»å–æ•°æ®çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœåœ¨ EOF åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²

**ç¤ºä¾‹ - è¯»å–æ•´ä¸ªæ–‡ä»¶ï¼š**
```hemlock
let f = open("poem.txt", "r");
let content = f.read();
print(content);
f.close();
```

**ç¤ºä¾‹ - åˆ†å—è¯»å–ï¼š**
```hemlock
let f = open("large.txt", "r");
while (true) {
    let chunk = f.read(4096);  // 4KB å—
    if (chunk == "") { break; }  // åˆ°è¾¾ EOF
    process(chunk);
}
f.close();
```

#### read_bytes(size: i32): buffer

è¯»å–äºŒè¿›åˆ¶æ•°æ®ï¼ˆè¿”å›ç¼“å†²åŒºï¼‰ã€‚

**å‚æ•°ï¼š**
- `size` (i32) - è¦è¯»å–çš„å­—èŠ‚æ•°

**è¿”å›ï¼š** åŒ…å«è¯»å–å­—èŠ‚çš„ç¼“å†²åŒº

```hemlock
let f = open("image.png", "r");
let binary = f.read_bytes(256);  // è¯»å– 256 å­—èŠ‚
print(binary.length);  // 256ï¼ˆå¦‚æœ EOF åˆ™æ›´å°‘ï¼‰

// è®¿é—®å•ä¸ªå­—èŠ‚
let first_byte = binary[0];
print(first_byte);

f.close();
```

### å†™å…¥

#### write(data: string): i32

å‘æ–‡ä»¶å†™å…¥æ–‡æœ¬ï¼ˆè¿”å›å†™å…¥çš„å­—èŠ‚æ•°ï¼‰ã€‚

**å‚æ•°ï¼š**
- `data` (string) - è¦å†™å…¥çš„æ–‡æœ¬

**è¿”å›ï¼š** å†™å…¥çš„å­—èŠ‚æ•° (i32)

```hemlock
let f = open("output.txt", "w");
let written = f.write("Hello, World!\n");
print("Wrote " + typeof(written) + " bytes");  // "Wrote 14 bytes"
f.close();
```

**ç¤ºä¾‹ - å†™å…¥å¤šè¡Œï¼š**
```hemlock
let f = open("output.txt", "w");
f.write("Line 1\n");
f.write("Line 2\n");
f.write("Line 3\n");
f.close();
```

**ç¤ºä¾‹ - è¿½åŠ åˆ°æ—¥å¿—æ–‡ä»¶ï¼š**
```hemlock
let f = open("app.log", "a");
f.write("[INFO] Application started\n");
f.write("[INFO] User logged in\n");
f.close();
```

#### write_bytes(data: buffer): i32

å†™å…¥äºŒè¿›åˆ¶æ•°æ®ï¼ˆè¿”å›å†™å…¥çš„å­—èŠ‚æ•°ï¼‰ã€‚

**å‚æ•°ï¼š**
- `data` (buffer) - è¦å†™å…¥çš„äºŒè¿›åˆ¶æ•°æ®

**è¿”å›ï¼š** å†™å…¥çš„å­—èŠ‚æ•° (i32)

```hemlock
let f = open("output.bin", "w");

// åˆ›å»ºäºŒè¿›åˆ¶æ•°æ®
let buf = buffer(10);
buf[0] = 65;  // 'A'
buf[1] = 66;  // 'B'
buf[2] = 67;  // 'C'

let bytes = f.write_bytes(buf);
print("Wrote " + typeof(bytes) + " bytes");

f.close();
```

### å®šä½

#### seek(position: i32): i32

ç§»åŠ¨åˆ°æŒ‡å®šä½ç½®ï¼ˆè¿”å›æ–°ä½ç½®ï¼‰ã€‚

**å‚æ•°ï¼š**
- `position` (i32) - ä»æ–‡ä»¶å¼€å¤´çš„å­—èŠ‚åç§»é‡

**è¿”å›ï¼š** æ–°ä½ç½® (i32)

```hemlock
let f = open("data.txt", "r");

// ç§»åŠ¨åˆ°ç¬¬ 100 å­—èŠ‚
f.seek(100);

// ä»ä½ç½® 100 è¯»å–
let data = f.read(50);

// é‡ç½®åˆ°å¼€å¤´
f.seek(0);

f.close();
```

**ç¤ºä¾‹ - éšæœºè®¿é—®ï¼š**
```hemlock
let f = open("records.dat", "r");

// è¯»å–åç§»é‡ 1000 å¤„çš„è®°å½•
f.seek(1000);
let record1 = f.read_bytes(100);

// è¯»å–åç§»é‡ 2000 å¤„çš„è®°å½•
f.seek(2000);
let record2 = f.read_bytes(100);

f.close();
```

#### tell(): i32

è·å–æ–‡ä»¶ä¸­çš„å½“å‰ä½ç½®ã€‚

**è¿”å›ï¼š** å½“å‰å­—èŠ‚åç§»é‡ (i32)

```hemlock
let f = open("data.txt", "r");

let pos1 = f.tell();  // 0ï¼ˆåœ¨å¼€å§‹å¤„ï¼‰

f.read(100);
let pos2 = f.tell();  // 100ï¼ˆè¯»å– 100 å­—èŠ‚åï¼‰

f.seek(500);
let pos3 = f.tell();  // 500ï¼ˆå®šä½åï¼‰

f.close();
```

### å…³é—­

#### close()

å…³é—­æ–‡ä»¶ï¼ˆå¹‚ç­‰ï¼Œå¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼‰ã€‚

```hemlock
let f = open("data.txt", "r");
// ... ä½¿ç”¨æ–‡ä»¶
f.close();
f.close();  // å®‰å…¨ - ç¬¬äºŒæ¬¡å…³é—­ä¸æŠ¥é”™
```

**é‡è¦è¯´æ˜ï¼š**
- å§‹ç»ˆåœ¨ä½¿ç”¨å®Œåå…³é—­æ–‡ä»¶ä»¥é¿å…æ–‡ä»¶æè¿°ç¬¦æ³„æ¼
- å…³é—­æ˜¯å¹‚ç­‰çš„ - å¯ä»¥å®‰å…¨åœ°å¤šæ¬¡è°ƒç”¨
- å…³é—­åï¼Œæ‰€æœ‰å…¶ä»–æ“ä½œå°†æŠ¥é”™
- ä½¿ç”¨ `finally` å—ç¡®ä¿å³ä½¿å‡ºé”™ä¹Ÿèƒ½å…³é—­æ–‡ä»¶

## æ–‡ä»¶å±æ€§

æ–‡ä»¶å¯¹è±¡æœ‰ä¸‰ä¸ªåªè¯»å±æ€§ï¼š

### path: string

ç”¨äºæ‰“å¼€æ–‡ä»¶çš„æ–‡ä»¶è·¯å¾„ã€‚

```hemlock
let f = open("/path/to/file.txt", "r");
print(f.path);  // "/path/to/file.txt"
f.close();
```

### mode: string

æ–‡ä»¶æ‰“å¼€æ—¶ä½¿ç”¨çš„æ¨¡å¼ã€‚

```hemlock
let f = open("data.txt", "r");
print(f.mode);  // "r"
f.close();

let f2 = open("output.txt", "w");
print(f2.mode);  // "w"
f2.close();
```

### closed: bool

æ–‡ä»¶æ˜¯å¦å·²å…³é—­ã€‚

```hemlock
let f = open("data.txt", "r");
print(f.closed);  // false

f.close();
print(f.closed);  // true
```

**ç¤ºä¾‹ - æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ‰“å¼€ï¼š**
```hemlock
let f = open("data.txt", "r");

if (!f.closed) {
    let content = f.read();
    // ... å¤„ç†å†…å®¹
}

f.close();

if (f.closed) {
    print("File is now closed");
}
```

## é”™è¯¯å¤„ç†

æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½åŒ…å«å¸¦ä¸Šä¸‹æ–‡çš„é€‚å½“é”™è¯¯æ¶ˆæ¯ã€‚

### å¸¸è§é”™è¯¯

**æ–‡ä»¶æœªæ‰¾åˆ°ï¼š**
```hemlock
let f = open("missing.txt", "r");
// é”™è¯¯ï¼šFailed to open 'missing.txt': No such file or directory
```

**ä»å·²å…³é—­çš„æ–‡ä»¶è¯»å–ï¼š**
```hemlock
let f = open("data.txt", "r");
f.close();
f.read();
// é”™è¯¯ï¼šCannot read from closed file 'data.txt'
```

**å‘åªè¯»æ–‡ä»¶å†™å…¥ï¼š**
```hemlock
let f = open("readonly.txt", "r");
f.write("data");
// é”™è¯¯ï¼šCannot write to file 'readonly.txt' opened in read-only mode
```

**ä»åªå†™æ–‡ä»¶è¯»å–ï¼š**
```hemlock
let f = open("output.txt", "w");
f.read();
// é”™è¯¯ï¼šCannot read from file 'output.txt' opened in write-only mode
```

### ä½¿ç”¨ try/catch

```hemlock
try {
    let f = open("data.txt", "r");
    let content = f.read();
    f.close();
    process(content);
} catch (e) {
    print("Error reading file: " + e);
}
```

## èµ„æºç®¡ç†

### åŸºæœ¬æ¨¡å¼

å§‹ç»ˆæ˜¾å¼å…³é—­æ–‡ä»¶ï¼š

```hemlock
let f = open("data.txt", "r");
let content = f.read();
f.close();
```

### å¸¦é”™è¯¯å¤„ç†ï¼ˆæ¨èï¼‰

ä½¿ç”¨ `finally` ç¡®ä¿å³ä½¿å‡ºé”™ä¹Ÿèƒ½å…³é—­æ–‡ä»¶ï¼š

```hemlock
let f = open("data.txt", "r");
try {
    let content = f.read();
    process(content);
} finally {
    f.close();  // å§‹ç»ˆå…³é—­ï¼Œå³ä½¿å‡ºé”™
}
```

### å¤šä¸ªæ–‡ä»¶

```hemlock
let src = null;
let dst = null;

try {
    src = open("input.txt", "r");
    dst = open("output.txt", "w");

    let content = src.read();
    dst.write(content);
} finally {
    if (src != null) { src.close(); }
    if (dst != null) { dst.close(); }
}
```

### è¾…åŠ©å‡½æ•°æ¨¡å¼

```hemlock
fn with_file(path: string, mode: string, callback) {
    let f = open(path, mode);
    try {
        return callback(f);
    } finally {
        f.close();
    }
}

// ä½¿ç”¨ï¼š
with_file("data.txt", "r", fn(f) {
    return f.read();
});
```

## å®Œæ•´ API å‚è€ƒ

### å‡½æ•°

| å‡½æ•° | å‚æ•° | è¿”å› | æè¿° |
|------|------|------|------|
| `open(path, mode?)` | path: string, mode?: string | File | æ‰“å¼€æ–‡ä»¶ï¼ˆæ¨¡å¼é»˜è®¤ä¸º "r"ï¼‰ |

### æ–¹æ³•

| æ–¹æ³• | å‚æ•° | è¿”å› | æè¿° |
|------|------|------|------|
| `read(size?)` | size?: i32 | string | è¯»å–æ–‡æœ¬ï¼ˆå…¨éƒ¨æˆ–æŒ‡å®šå­—èŠ‚ï¼‰ |
| `read_bytes(size)` | size: i32 | buffer | è¯»å–äºŒè¿›åˆ¶æ•°æ® |
| `write(data)` | data: string | i32 | å†™å…¥æ–‡æœ¬ï¼Œè¿”å›å†™å…¥çš„å­—èŠ‚æ•° |
| `write_bytes(data)` | data: buffer | i32 | å†™å…¥äºŒè¿›åˆ¶æ•°æ®ï¼Œè¿”å›å†™å…¥çš„å­—èŠ‚æ•° |
| `seek(position)` | position: i32 | i32 | å®šä½åˆ°ä½ç½®ï¼Œè¿”å›æ–°ä½ç½® |
| `tell()` | - | i32 | è·å–å½“å‰ä½ç½® |
| `close()` | - | null | å…³é—­æ–‡ä»¶ï¼ˆå¹‚ç­‰ï¼‰ |

### å±æ€§ï¼ˆåªè¯»ï¼‰

| å±æ€§ | ç±»å‹ | æè¿° |
|------|------|------|
| `path` | string | æ–‡ä»¶è·¯å¾„ |
| `mode` | string | æ‰“å¼€æ¨¡å¼ |
| `closed` | bool | æ–‡ä»¶æ˜¯å¦å·²å…³é—­ |

## å¸¸è§æ¨¡å¼

### è¯»å–æ•´ä¸ªæ–‡ä»¶

```hemlock
fn read_file(path: string): string {
    let f = open(path, "r");
    try {
        return f.read();
    } finally {
        f.close();
    }
}

let content = read_file("config.json");
```

### å†™å…¥æ•´ä¸ªæ–‡ä»¶

```hemlock
fn write_file(path: string, content: string) {
    let f = open(path, "w");
    try {
        f.write(content);
    } finally {
        f.close();
    }
}

write_file("output.txt", "Hello, World!");
```

### è¿½åŠ åˆ°æ–‡ä»¶

```hemlock
fn append_file(path: string, content: string) {
    let f = open(path, "a");
    try {
        f.write(content);
    } finally {
        f.close();
    }
}

append_file("log.txt", "[INFO] Event occurred\n");
```

### è¯»å–è¡Œ

```hemlock
fn read_lines(path: string) {
    let f = open(path, "r");
    try {
        let content = f.read();
        return content.split("\n");
    } finally {
        f.close();
    }
}

let lines = read_lines("data.txt");
let i = 0;
while (i < lines.length) {
    print("Line " + typeof(i) + ": " + lines[i]);
    i = i + 1;
}
```

### åˆ†å—å¤„ç†å¤§æ–‡ä»¶

```hemlock
fn process_large_file(path: string) {
    let f = open(path, "r");
    try {
        while (true) {
            let chunk = f.read(4096);  // 4KB å—
            if (chunk == "") { break; }

            // å¤„ç†å—
            process_chunk(chunk);
        }
    } finally {
        f.close();
    }
}
```

### äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶

```hemlock
fn copy_file(src_path: string, dst_path: string) {
    let src = null;
    let dst = null;

    try {
        src = open(src_path, "r");
        dst = open(dst_path, "w");

        while (true) {
            let chunk = src.read_bytes(4096);
            if (chunk.length == 0) { break; }

            dst.write_bytes(chunk);
        }
    } finally {
        if (src != null) { src.close(); }
        if (dst != null) { dst.close(); }
    }
}

copy_file("input.dat", "output.dat");
```

### æ–‡ä»¶æˆªæ–­

```hemlock
fn truncate_file(path: string) {
    let f = open(path, "w");  // "w" æ¨¡å¼æˆªæ–­
    f.close();
}

truncate_file("empty_me.txt");
```

### éšæœºè®¿é—®è¯»å–

```hemlock
fn read_at_offset(path: string, offset: i32, size: i32): string {
    let f = open(path, "r");
    try {
        f.seek(offset);
        return f.read(size);
    } finally {
        f.close();
    }
}

let data = read_at_offset("records.dat", 1000, 100);
```

## æœ€ä½³å®è·µ

### 1. å§‹ç»ˆä½¿ç”¨ try/finally

```hemlock
// å¥½
let f = open("data.txt", "r");
try {
    let content = f.read();
    process(content);
} finally {
    f.close();
}

// ä¸å¥½ - å‡ºé”™æ—¶æ–‡ä»¶å¯èƒ½ä¸å…³é—­
let f = open("data.txt", "r");
let content = f.read();
process(content);  // å¦‚æœè¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œæ–‡ä»¶æ³„æ¼
f.close();
```

### 2. æ“ä½œå‰æ£€æŸ¥æ–‡ä»¶çŠ¶æ€

```hemlock
let f = open("data.txt", "r");

if (!f.closed) {
    let content = f.read();
    // ... ä½¿ç”¨å†…å®¹
}

f.close();
```

### 3. ä½¿ç”¨é€‚å½“çš„æ¨¡å¼

```hemlock
// åªè¯»ï¼Ÿä½¿ç”¨ "r"
let f = open("config.json", "r");

// å®Œå…¨æ›¿æ¢ï¼Ÿä½¿ç”¨ "w"
let f = open("output.txt", "w");

// æ·»åŠ åˆ°æœ«å°¾ï¼Ÿä½¿ç”¨ "a"
let f = open("log.txt", "a");
```

### 4. ä¼˜é›…åœ°å¤„ç†é”™è¯¯

```hemlock
fn safe_read_file(path: string): string {
    try {
        let f = open(path, "r");
        try {
            return f.read();
        } finally {
            f.close();
        }
    } catch (e) {
        print("Warning: Could not read " + path + ": " + e);
        return "";
    }
}
```

### 5. æŒ‰æ‰“å¼€çš„ç›¸åé¡ºåºå…³é—­æ–‡ä»¶

```hemlock
let f1 = null;
let f2 = null;
let f3 = null;

try {
    f1 = open("file1.txt", "r");
    f2 = open("file2.txt", "r");
    f3 = open("file3.txt", "r");

    // ... ä½¿ç”¨æ–‡ä»¶
} finally {
    // æŒ‰ç›¸åé¡ºåºå…³é—­
    if (f3 != null) { f3.close(); }
    if (f2 != null) { f2.close(); }
    if (f1 != null) { f1.close(); }
}
```

### 6. é¿å…å®Œå…¨è¯»å–å¤§æ–‡ä»¶

```hemlock
// å¯¹å¤§æ–‡ä»¶ä¸å¥½
let f = open("huge.log", "r");
let content = f.read();  // å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜
f.close();

// å¥½ - åˆ†å—å¤„ç†
let f = open("huge.log", "r");
try {
    while (true) {
        let chunk = f.read(4096);
        if (chunk == "") { break; }
        process_chunk(chunk);
    }
} finally {
    f.close();
}
```

## æ€»ç»“

Hemlock çš„æ–‡ä»¶ I/O API æä¾›ï¼š

- ç®€å•ã€æ˜¾å¼çš„æ–‡ä»¶æ“ä½œ
- æ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ”¯æŒ
- ä½¿ç”¨ seek/tell çš„éšæœºè®¿é—®
- å¸¦ä¸Šä¸‹æ–‡çš„æ¸…æ™°é”™è¯¯æ¶ˆæ¯
- å¹‚ç­‰çš„å…³é—­æ“ä½œ

è¯·è®°ä½ï¼š
- å§‹ç»ˆæ‰‹åŠ¨å…³é—­æ–‡ä»¶
- ä½¿ç”¨ try/finally ç¡®ä¿èµ„æºå®‰å…¨
- é€‰æ‹©é€‚å½“çš„æ‰“å¼€æ¨¡å¼
- ä¼˜é›…åœ°å¤„ç†é”™è¯¯
- åˆ†å—å¤„ç†å¤§æ–‡ä»¶


--------------------------------------------------------------------------------
## ä¿¡å·å¤„ç†
--------------------------------------------------------------------------------

# Hemlock ä¿¡å·å¤„ç†

Hemlock æä¾› **POSIX ä¿¡å·å¤„ç†**ï¼Œç”¨äºç®¡ç†ç³»ç»Ÿä¿¡å·å¦‚ SIGINTï¼ˆCtrl+Cï¼‰ã€SIGTERM å’Œè‡ªå®šä¹‰ä¿¡å·ã€‚è¿™ä½¿å¾—åº•å±‚è¿›ç¨‹æ§åˆ¶å’Œè¿›ç¨‹é—´é€šä¿¡æˆä¸ºå¯èƒ½ã€‚

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [ä¿¡å· API](#ä¿¡å·-api)
- [ä¿¡å·å¸¸é‡](#ä¿¡å·å¸¸é‡)
- [åŸºæœ¬ä¿¡å·å¤„ç†](#åŸºæœ¬ä¿¡å·å¤„ç†)
- [é«˜çº§æ¨¡å¼](#é«˜çº§æ¨¡å¼)
- [ä¿¡å·å¤„ç†å™¨è¡Œä¸º](#ä¿¡å·å¤„ç†å™¨è¡Œä¸º)
- [å®‰å…¨è€ƒè™‘](#å®‰å…¨è€ƒè™‘)
- [å¸¸è§ç”¨ä¾‹](#å¸¸è§ç”¨ä¾‹)
- [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)

## æ¦‚è¿°

ä¿¡å·å¤„ç†å…è®¸ç¨‹åºï¼š
- å“åº”ç”¨æˆ·ä¸­æ–­ï¼ˆCtrl+Cã€Ctrl+Zï¼‰
- å®ç°ä¼˜é›…å…³é—­
- å¤„ç†ç»ˆæ­¢è¯·æ±‚
- ä½¿ç”¨è‡ªå®šä¹‰ä¿¡å·è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡
- åˆ›å»ºè­¦æŠ¥/å®šæ—¶å™¨æœºåˆ¶

**é‡è¦ï¼š** æŒ‰ç…§ Hemlock çš„å“²å­¦ï¼Œä¿¡å·å¤„ç†**æœ¬è´¨ä¸Šæ˜¯ä¸å®‰å…¨çš„**ã€‚å¤„ç†å™¨å¯ä»¥åœ¨ä»»ä½•æ—¶å€™è¢«è°ƒç”¨ï¼Œä¸­æ–­æ­£å¸¸æ‰§è¡Œã€‚ç”¨æˆ·è´Ÿè´£é€‚å½“çš„åŒæ­¥ã€‚

## ä¿¡å· API

### signal(signum, handler_fn)

æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°ã€‚

**å‚æ•°ï¼š**
- `signum` (i32) - ä¿¡å·ç¼–å·ï¼ˆå¦‚ SIGINTã€SIGTERM å¸¸é‡ï¼‰
- `handler_fn` (function æˆ– null) - æ¥æ”¶åˆ°ä¿¡å·æ—¶è°ƒç”¨çš„å‡½æ•°ï¼Œæˆ– `null` é‡ç½®ä¸ºé»˜è®¤

**è¿”å›ï¼š** ä¹‹å‰çš„å¤„ç†å‡½æ•°ï¼ˆå¦‚æœæ²¡æœ‰åˆ™è¿”å› `null`ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
fn my_handler(sig) {
    print("Caught signal: " + typeof(sig));
}

let old_handler = signal(SIGINT, my_handler);
```

**é‡ç½®ä¸ºé»˜è®¤ï¼š**
```hemlock
signal(SIGINT, null);  // å°† SIGINT é‡ç½®ä¸ºé»˜è®¤è¡Œä¸º
```

### raise(signum)

å‘å½“å‰è¿›ç¨‹å‘é€ä¿¡å·ã€‚

**å‚æ•°ï¼š**
- `signum` (i32) - è¦å‘é€çš„ä¿¡å·ç¼–å·

**è¿”å›ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
raise(SIGUSR1);  // è§¦å‘ SIGUSR1 å¤„ç†å™¨
```

## ä¿¡å·å¸¸é‡

Hemlock æä¾›æ ‡å‡† POSIX ä¿¡å·å¸¸é‡ä½œä¸º i32 å€¼ã€‚

### ä¸­æ–­å’Œç»ˆæ­¢

| å¸¸é‡ | å€¼ | æè¿° | å¸¸è§è§¦å‘ |
|------|------|------|----------|
| `SIGINT` | 2 | é”®ç›˜ä¸­æ–­ | Ctrl+C |
| `SIGTERM` | 15 | ç»ˆæ­¢è¯·æ±‚ | `kill` å‘½ä»¤ |
| `SIGQUIT` | 3 | é”®ç›˜é€€å‡º | Ctrl+\ |
| `SIGHUP` | 1 | æ£€æµ‹åˆ°æŒ‚æ–­ | ç»ˆç«¯å…³é—­ |
| `SIGABRT` | 6 | ä¸­æ­¢ä¿¡å· | `abort()` å‡½æ•° |

**ç¤ºä¾‹ï¼š**
```hemlock
signal(SIGINT, handle_interrupt);   // Ctrl+C
signal(SIGTERM, handle_terminate);  // kill å‘½ä»¤
signal(SIGHUP, handle_hangup);      // ç»ˆç«¯å…³é—­
```

### ç”¨æˆ·å®šä¹‰ä¿¡å·

| å¸¸é‡ | å€¼ | æè¿° | ç”¨ä¾‹ |
|------|------|------|------|
| `SIGUSR1` | 10 | ç”¨æˆ·å®šä¹‰ä¿¡å· 1 | è‡ªå®šä¹‰ IPC |
| `SIGUSR2` | 12 | ç”¨æˆ·å®šä¹‰ä¿¡å· 2 | è‡ªå®šä¹‰ IPC |

**ç¤ºä¾‹ï¼š**
```hemlock
// ç”¨äºè‡ªå®šä¹‰é€šä¿¡
signal(SIGUSR1, reload_config);
signal(SIGUSR2, rotate_logs);
```

### è¿›ç¨‹æ§åˆ¶

| å¸¸é‡ | å€¼ | æè¿° | è¯´æ˜ |
|------|------|------|------|
| `SIGALRM` | 14 | è­¦æŠ¥æ—¶é’Ÿå®šæ—¶å™¨ | `alarm()` å |
| `SIGCHLD` | 17 | å­è¿›ç¨‹çŠ¶æ€æ”¹å˜ | è¿›ç¨‹ç®¡ç† |
| `SIGCONT` | 18 | å¦‚æœåœæ­¢åˆ™ç»§ç»­ | åœ¨ SIGSTOP åæ¢å¤ |
| `SIGSTOP` | 19 | åœæ­¢è¿›ç¨‹ | **æ— æ³•æ•è·** |
| `SIGTSTP` | 20 | ç»ˆç«¯åœæ­¢ | Ctrl+Z |

**ç¤ºä¾‹ï¼š**
```hemlock
signal(SIGALRM, handle_timeout);
signal(SIGCHLD, handle_child_exit);
```

### I/O ä¿¡å·

| å¸¸é‡ | å€¼ | æè¿° | ä½•æ—¶å‘é€ |
|------|------|------|----------|
| `SIGPIPE` | 13 | ç®¡é“æ–­å¼€ | å†™å…¥å·²å…³é—­çš„ç®¡é“ |
| `SIGTTIN` | 21 | åå°ä»ç»ˆç«¯è¯»å– | åå°è¿›ç¨‹è¯»å– TTY |
| `SIGTTOU` | 22 | åå°å†™å…¥ç»ˆç«¯ | åå°è¿›ç¨‹å†™å…¥ TTY |

**ç¤ºä¾‹ï¼š**
```hemlock
signal(SIGPIPE, handle_broken_pipe);
```

## åŸºæœ¬ä¿¡å·å¤„ç†

### æ•è· Ctrl+C

```hemlock
let interrupted = false;

fn handle_interrupt(sig) {
    print("Caught SIGINT!");
    interrupted = true;
}

signal(SIGINT, handle_interrupt);

// ç¨‹åºç»§ç»­è¿è¡Œ...
// ç”¨æˆ·æŒ‰ Ctrl+C -> è°ƒç”¨ handle_interrupt()

while (!interrupted) {
    // åšå·¥ä½œ...
}

print("Exiting due to interrupt");
```

### å¤„ç†å‡½æ•°ç­¾å

ä¿¡å·å¤„ç†å™¨æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼šä¿¡å·ç¼–å· (i32)

```hemlock
fn my_handler(signum) {
    print("Received signal: " + typeof(signum));
    // signum åŒ…å«ä¿¡å·ç¼–å·ï¼ˆå¦‚ SIGINT ä¸º 2ï¼‰

    if (signum == SIGINT) {
        print("This is SIGINT");
    }
}

signal(SIGINT, my_handler);
signal(SIGTERM, my_handler);  // å¤šä¸ªä¿¡å·ä½¿ç”¨åŒä¸€å¤„ç†å™¨
```

### å¤šä¸ªä¿¡å·å¤„ç†å™¨

ä¸åŒä¿¡å·ä½¿ç”¨ä¸åŒå¤„ç†å™¨ï¼š

```hemlock
fn handle_int(sig) {
    print("SIGINT received");
}

fn handle_term(sig) {
    print("SIGTERM received");
}

fn handle_usr1(sig) {
    print("SIGUSR1 received");
}

signal(SIGINT, handle_int);
signal(SIGTERM, handle_term);
signal(SIGUSR1, handle_usr1);
```

### é‡ç½®ä¸ºé»˜è®¤è¡Œä¸º

ä¼ é€’ `null` ä½œä¸ºå¤„ç†å™¨ä»¥é‡ç½®ä¸ºé»˜è®¤è¡Œä¸ºï¼š

```hemlock
// æ³¨å†Œè‡ªå®šä¹‰å¤„ç†å™¨
signal(SIGINT, my_handler);

// ç¨åï¼Œé‡ç½®ä¸ºé»˜è®¤ï¼ˆSIGINT æ—¶ç»ˆæ­¢ï¼‰
signal(SIGINT, null);
```

### æ‰‹åŠ¨è§¦å‘ä¿¡å·

å‘è‡ªå·±çš„è¿›ç¨‹å‘é€ä¿¡å·ï¼š

```hemlock
let count = 0;

fn increment(sig) {
    count = count + 1;
}

signal(SIGUSR1, increment);

// æ‰‹åŠ¨è§¦å‘å¤„ç†å™¨
raise(SIGUSR1);
raise(SIGUSR1);

print(count);  // 2
```

## é«˜çº§æ¨¡å¼

### ä¼˜é›…å…³é—­æ¨¡å¼

ç»ˆæ­¢æ—¶æ¸…ç†çš„å¸¸è§æ¨¡å¼ï¼š

```hemlock
let should_exit = false;

fn handle_shutdown(sig) {
    print("Shutting down gracefully...");
    should_exit = true;
}

signal(SIGINT, handle_shutdown);
signal(SIGTERM, handle_shutdown);

// ä¸»å¾ªç¯
while (!should_exit) {
    // åšå·¥ä½œ...
    // å®šæœŸæ£€æŸ¥ should_exit æ ‡å¿—
}

print("Cleanup complete");
```

### ä¿¡å·è®¡æ•°å™¨

è·Ÿè¸ªæ¥æ”¶çš„ä¿¡å·æ•°é‡ï¼š

```hemlock
let signal_count = 0;

fn count_signals(sig) {
    signal_count = signal_count + 1;
    print("Received " + typeof(signal_count) + " signals");
}

signal(SIGUSR1, count_signals);

// ç¨å...
print("Total signals: " + typeof(signal_count));
```

### ä¿¡å·é‡æ–°åŠ è½½é…ç½®

```hemlock
let config = load_config();

fn reload_config(sig) {
    print("Reloading configuration...");
    config = load_config();
    print("Configuration reloaded");
}

signal(SIGHUP, reload_config);  // æ”¶åˆ° SIGHUP æ—¶é‡æ–°åŠ è½½

// ä» shell å‘é€ SIGHUP åˆ°è¿›ç¨‹ä»¥é‡æ–°åŠ è½½é…ç½®
// kill -HUP <pid>
```

### ä½¿ç”¨ SIGALRM çš„è¶…æ—¶

```hemlock
let timed_out = false;

fn handle_alarm(sig) {
    print("Timeout!");
    timed_out = true;
}

signal(SIGALRM, handle_alarm);

// è®¾ç½®è­¦æŠ¥ï¼ˆHemlock ä¸­å°šæœªå®ç°ï¼Œä»…ç¤ºä¾‹ï¼‰
// alarm(5);  // 5 ç§’è¶…æ—¶

while (!timed_out) {
    // å¸¦è¶…æ—¶çš„å·¥ä½œ
}
```

### åŸºäºä¿¡å·çš„çŠ¶æ€æœº

```hemlock
let state = 0;

fn next_state(sig) {
    state = (state + 1) % 3;
    print("State: " + typeof(state));
}

fn prev_state(sig) {
    state = (state - 1 + 3) % 3;
    print("State: " + typeof(state));
}

signal(SIGUSR1, next_state);  // å‰è¿›çŠ¶æ€
signal(SIGUSR2, prev_state);  // åé€€çŠ¶æ€

// æ§åˆ¶çŠ¶æ€æœºï¼š
// kill -USR1 <pid>  # ä¸‹ä¸€çŠ¶æ€
// kill -USR2 <pid>  # ä¸Šä¸€çŠ¶æ€
```

## ä¿¡å·å¤„ç†å™¨è¡Œä¸º

### é‡è¦è¯´æ˜

**å¤„ç†å™¨æ‰§è¡Œï¼š**
- å¤„ç†å™¨åœ¨æ¥æ”¶åˆ°ä¿¡å·æ—¶**åŒæ­¥**è°ƒç”¨
- å¤„ç†å™¨åœ¨å½“å‰è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
- ä¿¡å·å¤„ç†å™¨å…±äº«å®šä¹‰å®ƒä»¬çš„å‡½æ•°çš„é—­åŒ…ç¯å¢ƒ
- å¤„ç†å™¨å¯ä»¥è®¿é—®å’Œä¿®æ”¹å¤–éƒ¨ä½œç”¨åŸŸå˜é‡ï¼ˆå¦‚å…¨å±€å˜é‡æˆ–æ•è·çš„å˜é‡ï¼‰

**æœ€ä½³å®è·µï¼š**
- ä¿æŒå¤„ç†å™¨ç®€å•å¿«é€Ÿ - é¿å…é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œ
- è®¾ç½®æ ‡å¿—è€Œä¸æ˜¯æ‰§è¡Œå¤æ‚é€»è¾‘
- é¿å…è°ƒç”¨å¯èƒ½è·å–é”çš„å‡½æ•°
- æ³¨æ„å¤„ç†å™¨å¯ä»¥ä¸­æ–­ä»»ä½•æ“ä½œ

### å“ªäº›ä¿¡å·å¯ä»¥æ•è·

**å¯ä»¥æ•è·å’Œå¤„ç†ï¼š**
- SIGINTã€SIGTERMã€SIGUSR1ã€SIGUSR2ã€SIGHUPã€SIGQUIT
- SIGALRMã€SIGCHLDã€SIGCONTã€SIGTSTP
- SIGPIPEã€SIGTTINã€SIGTTOU
- SIGABRTï¼ˆä½†å¤„ç†å™¨è¿”å›åç¨‹åºå°†ä¸­æ­¢ï¼‰

**æ— æ³•æ•è·ï¼š**
- `SIGKILL` (9) - å§‹ç»ˆç»ˆæ­¢è¿›ç¨‹
- `SIGSTOP` (19) - å§‹ç»ˆåœæ­¢è¿›ç¨‹

**ç³»ç»Ÿç›¸å…³ï¼š**
- æŸäº›ä¿¡å·çš„é»˜è®¤è¡Œä¸ºå¯èƒ½å› ç³»ç»Ÿè€Œå¼‚
- æŸ¥çœ‹æ‚¨å¹³å°çš„ä¿¡å·æ–‡æ¡£äº†è§£è¯¦æƒ…

### å¤„ç†å™¨é™åˆ¶

```hemlock
fn complex_handler(sig) {
    // åœ¨ä¿¡å·å¤„ç†å™¨ä¸­é¿å…è¿™äº›ï¼š

    // âŒ é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œ
    // process_large_file();

    // âŒ é˜»å¡ I/O
    // let f = open("log.txt", "a");
    // f.write("Signal received\n");

    // âŒ å¤æ‚çš„çŠ¶æ€æ›´æ”¹
    // rebuild_entire_data_structure();

    // âœ… ç®€å•çš„æ ‡å¿—è®¾ç½®æ˜¯å®‰å…¨çš„
    let should_stop = true;

    // âœ… ç®€å•çš„è®¡æ•°å™¨æ›´æ–°é€šå¸¸æ˜¯å®‰å…¨çš„
    let signal_count = signal_count + 1;
}
```

## å®‰å…¨è€ƒè™‘

æŒ‰ç…§ Hemlock çš„å“²å­¦ï¼Œä¿¡å·å¤„ç†**æœ¬è´¨ä¸Šæ˜¯ä¸å®‰å…¨çš„**ã€‚

### ç«äº‰æ¡ä»¶

å¤„ç†å™¨å¯ä»¥åœ¨ä»»ä½•æ—¶å€™è¢«è°ƒç”¨ï¼Œä¸­æ–­æ­£å¸¸æ‰§è¡Œï¼š

```hemlock
let counter = 0;

fn increment(sig) {
    counter = counter + 1;  // å¦‚æœåœ¨ counter æ›´æ–°æœŸé—´è°ƒç”¨ä¼šæœ‰ç«äº‰æ¡ä»¶
}

signal(SIGUSR1, increment);

// ä¸»ä»£ç ä¹Ÿä¿®æ”¹ counter
counter = counter + 1;  // å¯èƒ½è¢«ä¿¡å·å¤„ç†å™¨ä¸­æ–­
```

**é—®é¢˜ï¼š** å¦‚æœä¿¡å·åœ¨ä¸»ä»£ç æ›´æ–° `counter` æ—¶åˆ°è¾¾ï¼Œç»“æœæ˜¯ä¸å¯é¢„æµ‹çš„ã€‚

### å¼‚æ­¥ä¿¡å·å®‰å…¨

Hemlock **ä¸**ä¿è¯å¼‚æ­¥ä¿¡å·å®‰å…¨ï¼š
- å¤„ç†å™¨å¯ä»¥è°ƒç”¨ä»»ä½• Hemlock ä»£ç ï¼ˆä¸åƒ C çš„å—é™å¼‚æ­¥ä¿¡å·å®‰å…¨å‡½æ•°ï¼‰
- è¿™æä¾›äº†çµæ´»æ€§ä½†éœ€è¦ç”¨æˆ·è°¨æ…
- å¦‚æœå¤„ç†å™¨ä¿®æ”¹å…±äº«çŠ¶æ€ï¼Œå¯èƒ½å‡ºç°ç«äº‰æ¡ä»¶

### å®‰å…¨ä¿¡å·å¤„ç†çš„æœ€ä½³å®è·µ

**1. ä½¿ç”¨åŸå­æ ‡å¿—**

ç®€å•çš„å¸ƒå°”èµ‹å€¼é€šå¸¸æ˜¯å®‰å…¨çš„ï¼š

```hemlock
let should_exit = false;

fn handler(sig) {
    should_exit = true;  // ç®€å•èµ‹å€¼æ˜¯å®‰å…¨çš„
}

signal(SIGINT, handler);

while (!should_exit) {
    // å·¥ä½œ...
}
```

**2. æœ€å°åŒ–å…±äº«çŠ¶æ€**

```hemlock
let interrupt_count = 0;

fn handler(sig) {
    // åªä¿®æ”¹è¿™ä¸€ä¸ªå˜é‡
    interrupt_count = interrupt_count + 1;
}
```

**3. å»¶è¿Ÿå¤æ‚æ“ä½œ**

```hemlock
let pending_reload = false;

fn signal_reload(sig) {
    pending_reload = true;  // åªè®¾ç½®æ ‡å¿—
}

signal(SIGHUP, signal_reload);

// åœ¨ä¸»å¾ªç¯ä¸­ï¼š
while (true) {
    if (pending_reload) {
        reload_config();  // åœ¨è¿™é‡Œæ‰§è¡Œå¤æ‚å·¥ä½œ
        pending_reload = false;
    }

    // æ­£å¸¸å·¥ä½œ...
}
```

**4. é¿å…é‡å…¥é—®é¢˜**

```hemlock
let in_critical_section = false;
let data = [];

fn careful_handler(sig) {
    if (in_critical_section) {
        // ä¸»ä»£ç ä½¿ç”¨æ•°æ®æ—¶ä¸è¦ä¿®æ”¹å®ƒ
        return;
    }
    // å¯ä»¥å®‰å…¨ç»§ç»­
}
```

## å¸¸è§ç”¨ä¾‹

### 1. ä¼˜é›…çš„æœåŠ¡å™¨å…³é—­

```hemlock
let running = true;

fn shutdown(sig) {
    print("Shutdown signal received");
    running = false;
}

signal(SIGINT, shutdown);
signal(SIGTERM, shutdown);

// æœåŠ¡å™¨ä¸»å¾ªç¯
while (running) {
    handle_client_request();
}

cleanup_resources();
print("Server stopped");
```

### 2. é…ç½®é‡æ–°åŠ è½½ï¼ˆæ— éœ€é‡å¯ï¼‰

```hemlock
let config = load_config("app.conf");
let reload_needed = false;

fn trigger_reload(sig) {
    reload_needed = true;
}

signal(SIGHUP, trigger_reload);

while (true) {
    if (reload_needed) {
        print("Reloading configuration...");
        config = load_config("app.conf");
        reload_needed = false;
    }

    // ä½¿ç”¨é…ç½®...
}
```

### 3. æ—¥å¿—è½®è½¬

```hemlock
let log_file = open("app.log", "a");
let rotate_needed = false;

fn trigger_rotate(sig) {
    rotate_needed = true;
}

signal(SIGUSR1, trigger_rotate);

while (true) {
    if (rotate_needed) {
        log_file.close();
        // é‡å‘½åæ—§æ—¥å¿—ï¼Œæ‰“å¼€æ–°çš„
        exec("mv app.log app.log.old");
        log_file = open("app.log", "a");
        rotate_needed = false;
    }

    // æ­£å¸¸æ—¥å¿—è®°å½•...
    log_file.write("Log entry\n");
}
```

### 4. çŠ¶æ€æŠ¥å‘Š

```hemlock
let requests_handled = 0;

fn report_status(sig) {
    print("Status: " + typeof(requests_handled) + " requests handled");
}

signal(SIGUSR1, report_status);

while (true) {
    handle_request();
    requests_handled = requests_handled + 1;
}

// ä» shellï¼škill -USR1 <pid>
```

### 5. è°ƒè¯•æ¨¡å¼åˆ‡æ¢

```hemlock
let debug_mode = false;

fn toggle_debug(sig) {
    debug_mode = !debug_mode;
    if (debug_mode) {
        print("Debug mode: ON");
    } else {
        print("Debug mode: OFF");
    }
}

signal(SIGUSR2, toggle_debug);

// ä» shellï¼škill -USR2 <pid> åˆ‡æ¢
```

## å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå¸¦æ¸…ç†çš„ä¸­æ–­å¤„ç†å™¨

```hemlock
let running = true;
let signal_count = 0;

fn handle_signal(signum) {
    signal_count = signal_count + 1;

    if (signum == SIGINT) {
        print("Interrupt detected (Ctrl+C)");
        running = false;
    }

    if (signum == SIGUSR1) {
        print("User signal 1 received");
    }
}

// æ³¨å†Œå¤„ç†å™¨
signal(SIGINT, handle_signal);
signal(SIGUSR1, handle_signal);

// æ¨¡æ‹Ÿä¸€äº›å·¥ä½œ
let i = 0;
while (running && i < 100) {
    print("Working... " + typeof(i));

    // æ¯ 10 æ¬¡è¿­ä»£è§¦å‘ SIGUSR1
    if (i == 10 || i == 20) {
        raise(SIGUSR1);
    }

    i = i + 1;
}

print("Total signals received: " + typeof(signal_count));
```

### ç¤ºä¾‹ 2ï¼šå¤šä¿¡å·çŠ¶æ€æœº

```hemlock
let state = "idle";
let request_count = 0;

fn start_processing(sig) {
    state = "processing";
    print("State: " + state);
}

fn stop_processing(sig) {
    state = "idle";
    print("State: " + state);
}

fn report_stats(sig) {
    print("State: " + state);
    print("Requests: " + typeof(request_count));
}

signal(SIGUSR1, start_processing);
signal(SIGUSR2, stop_processing);
signal(SIGHUP, report_stats);

while (true) {
    if (state == "processing") {
        // åšå·¥ä½œ
        request_count = request_count + 1;
    }

    // æ¯æ¬¡è¿­ä»£æ£€æŸ¥...
}
```

### ç¤ºä¾‹ 3ï¼šå·¥ä½œæ± æ§åˆ¶å™¨

```hemlock
let worker_count = 4;
let should_exit = false;

fn increase_workers(sig) {
    worker_count = worker_count + 1;
    print("Workers: " + typeof(worker_count));
}

fn decrease_workers(sig) {
    if (worker_count > 1) {
        worker_count = worker_count - 1;
    }
    print("Workers: " + typeof(worker_count));
}

fn shutdown(sig) {
    print("Shutting down...");
    should_exit = true;
}

signal(SIGUSR1, increase_workers);
signal(SIGUSR2, decrease_workers);
signal(SIGINT, shutdown);
signal(SIGTERM, shutdown);

// ä¸»å¾ªç¯æ ¹æ® worker_count è°ƒæ•´å·¥ä½œæ± 
while (!should_exit) {
    // æ ¹æ® worker_count ç®¡ç†å·¥ä½œè€…
    // ...
}
```

## è°ƒè¯•ä¿¡å·å¤„ç†å™¨

### æ·»åŠ è¯Šæ–­æ‰“å°

```hemlock
fn debug_handler(sig) {
    print("Handler called for signal: " + typeof(sig));
    print("Stack: (not yet available)");

    // ä½ çš„å¤„ç†å™¨é€»è¾‘...
}

signal(SIGINT, debug_handler);
```

### è®¡æ•°ä¿¡å·è°ƒç”¨

```hemlock
let handler_calls = 0;

fn counting_handler(sig) {
    handler_calls = handler_calls + 1;
    print("Handler call #" + typeof(handler_calls));

    // ä½ çš„å¤„ç†å™¨é€»è¾‘...
}
```

### ä½¿ç”¨ raise() æµ‹è¯•

```hemlock
fn test_handler(sig) {
    print("Test signal received: " + typeof(sig));
}

signal(SIGUSR1, test_handler);

// é€šè¿‡æ‰‹åŠ¨è§¦å‘æµ‹è¯•
raise(SIGUSR1);
print("Handler should have been called");
```

## æ€»ç»“

Hemlock çš„ä¿¡å·å¤„ç†æä¾›ï¼š

- ç”¨äºåº•å±‚è¿›ç¨‹æ§åˆ¶çš„ POSIX ä¿¡å·å¤„ç†
- 15 ä¸ªæ ‡å‡†ä¿¡å·å¸¸é‡
- ç®€å•çš„ signal() å’Œ raise() API
- çµæ´»çš„å¤„ç†å‡½æ•°ï¼Œæ”¯æŒé—­åŒ…
- å¤šä¸ªä¿¡å·å¯ä»¥å…±äº«å¤„ç†å™¨

è¯·è®°ä½ï¼š
- ä¿¡å·å¤„ç†æœ¬è´¨ä¸Šæ˜¯ä¸å®‰å…¨çš„ - è°¨æ…ä½¿ç”¨
- ä¿æŒå¤„ç†å™¨ç®€å•å¿«é€Ÿ
- ä½¿ç”¨æ ‡å¿—è¿›è¡ŒçŠ¶æ€æ›´æ”¹ï¼Œè€Œä¸æ˜¯å¤æ‚æ“ä½œ
- å¤„ç†å™¨å¯ä»¥åœ¨ä»»ä½•æ—¶å€™ä¸­æ–­æ‰§è¡Œ
- æ— æ³•æ•è· SIGKILL æˆ– SIGSTOP
- ä½¿ç”¨ raise() å½»åº•æµ‹è¯•å¤„ç†å™¨

å¸¸è§æ¨¡å¼ï¼š
- ä¼˜é›…å…³é—­ï¼ˆSIGINTã€SIGTERMï¼‰
- é…ç½®é‡æ–°åŠ è½½ï¼ˆSIGHUPï¼‰
- æ—¥å¿—è½®è½¬ï¼ˆSIGUSR1ï¼‰
- çŠ¶æ€æŠ¥å‘Šï¼ˆSIGUSR1/SIGUSR2ï¼‰
- è°ƒè¯•æ¨¡å¼åˆ‡æ¢ï¼ˆSIGUSR2ï¼‰


--------------------------------------------------------------------------------
## åŸå­æ“ä½œ
--------------------------------------------------------------------------------

# åŸå­æ“ä½œ

Hemlock æä¾›åŸå­æ“ä½œç”¨äº**æ— é”å¹¶å‘ç¼–ç¨‹**ã€‚è¿™äº›æ“ä½œä½¿å¾—åœ¨å¤šä¸ªçº¿ç¨‹é—´å®‰å…¨æ“ä½œå…±äº«å†…å­˜æˆä¸ºå¯èƒ½ï¼Œæ— éœ€ä¼ ç»Ÿçš„é”æˆ–äº’æ–¥é”ã€‚

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [ä½•æ—¶ä½¿ç”¨åŸå­æ“ä½œ](#ä½•æ—¶ä½¿ç”¨åŸå­æ“ä½œ)
- [å†…å­˜æ¨¡å‹](#å†…å­˜æ¨¡å‹)
- [åŸå­åŠ è½½å’Œå­˜å‚¨](#åŸå­åŠ è½½å’Œå­˜å‚¨)
- [è·å–å¹¶ä¿®æ”¹æ“ä½œ](#è·å–å¹¶ä¿®æ”¹æ“ä½œ)
- [æ¯”è¾ƒå¹¶äº¤æ¢ (CAS)](#æ¯”è¾ƒå¹¶äº¤æ¢-cas)
- [åŸå­äº¤æ¢](#åŸå­äº¤æ¢)
- [å†…å­˜æ …æ ](#å†…å­˜æ …æ )
- [å‡½æ•°å‚è€ƒ](#å‡½æ•°å‚è€ƒ)
- [å¸¸è§æ¨¡å¼](#å¸¸è§æ¨¡å¼)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [é™åˆ¶](#é™åˆ¶)

---

## æ¦‚è¿°

åŸå­æ“ä½œæ˜¯**ä¸å¯åˆ†å‰²çš„**æ“ä½œï¼Œå®Œæˆæ—¶ä¸å¯èƒ½è¢«ä¸­æ–­ã€‚å½“ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŸå­æ“ä½œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è§‚å¯Ÿåˆ°æ“ä½œçš„éƒ¨åˆ†å®ŒæˆçŠ¶æ€ã€‚

**ä¸»è¦ç‰¹æ€§ï¼š**
- æ‰€æœ‰æ“ä½œä½¿ç”¨**é¡ºåºä¸€è‡´æ€§**ï¼ˆ`memory_order_seq_cst`ï¼‰
- æ”¯æŒçš„ç±»å‹ï¼š**i32** å’Œ **i64**
- æ“ä½œé€‚ç”¨äºé€šè¿‡ `alloc()` åˆ†é…çš„åŸå§‹æŒ‡é’ˆ
- æ— éœ€æ˜¾å¼é”å³å¯ä¿è¯çº¿ç¨‹å®‰å…¨

**å¯ç”¨æ“ä½œï¼š**
- Load/Store - åŸå­è¯»å–å’Œå†™å…¥å€¼
- Add/Sub - è¿”å›æ—§å€¼çš„ç®—æœ¯æ“ä½œ
- And/Or/Xor - è¿”å›æ—§å€¼çš„ä½è¿ç®—æ“ä½œ
- CAS - æ¡ä»¶æ›´æ–°çš„æ¯”è¾ƒå¹¶äº¤æ¢
- Exchange - åŸå­äº¤æ¢å€¼
- Fence - å®Œæ•´å†…å­˜å±éšœ

---

## ä½•æ—¶ä½¿ç”¨åŸå­æ“ä½œ

**ä½¿ç”¨åŸå­æ“ä½œçš„åœºæ™¯ï¼š**
- è·¨ä»»åŠ¡å…±äº«çš„è®¡æ•°å™¨ï¼ˆå¦‚è¯·æ±‚è®¡æ•°ã€è¿›åº¦è·Ÿè¸ªï¼‰
- æ ‡å¿—å’ŒçŠ¶æ€æŒ‡ç¤ºå™¨
- æ— é”æ•°æ®ç»“æ„
- ç®€å•çš„åŒæ­¥åŸè¯­
- æ€§èƒ½å…³é”®çš„å¹¶å‘ä»£ç 

**æ”¹ç”¨é€šé“çš„åœºæ™¯ï¼š**
- åœ¨ä»»åŠ¡é—´ä¼ é€’å¤æ‚æ•°æ®
- å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼
- éœ€è¦æ¶ˆæ¯ä¼ é€’è¯­ä¹‰æ—¶

**ç¤ºä¾‹ç”¨ä¾‹ - å…±äº«è®¡æ•°å™¨ï¼š**
```hemlock
// åˆ†é…å…±äº«è®¡æ•°å™¨
let counter = alloc(4);
ptr_write_i32(counter, 0);

async fn worker(counter: ptr, id: i32) {
    let i = 0;
    while (i < 1000) {
        atomic_add_i32(counter, 1);
        i = i + 1;
    }
}

// ç”Ÿæˆå¤šä¸ªå·¥ä½œè€…
let t1 = spawn(worker, counter, 1);
let t2 = spawn(worker, counter, 2);
let t3 = spawn(worker, counter, 3);

join(t1);
join(t2);
join(t3);

// è®¡æ•°å™¨å°†æ°å¥½æ˜¯ 3000ï¼ˆæ— æ•°æ®ç«äº‰ï¼‰
print(atomic_load_i32(counter));

free(counter);
```

---

## å†…å­˜æ¨¡å‹

æ‰€æœ‰ Hemlock åŸå­æ“ä½œä½¿ç”¨**é¡ºåºä¸€è‡´æ€§**ï¼ˆ`memory_order_seq_cst`ï¼‰ï¼Œæä¾›æœ€å¼ºçš„å†…å­˜æ’åºä¿è¯ï¼š

1. **åŸå­æ€§**ï¼šæ¯ä¸ªæ“ä½œéƒ½æ˜¯ä¸å¯åˆ†å‰²çš„
2. **å…¨å±€æ’åº**ï¼šæ‰€æœ‰çº¿ç¨‹çœ‹åˆ°ç›¸åŒçš„æ“ä½œé¡ºåº
3. **æ— é‡æ’åº**ï¼šæ“ä½œä¸ä¼šè¢«ç¼–è¯‘å™¨æˆ– CPU é‡æ’åº

è¿™ä½¿å¾—å¹¶å‘ä»£ç çš„æ¨ç†æ›´ç®€å•ï¼Œä½†ä¸è¾ƒå¼±çš„å†…å­˜æ’åºç›¸æ¯”å¯èƒ½æœ‰ä¸€äº›æ€§èƒ½æˆæœ¬ã€‚

---

## åŸå­åŠ è½½å’Œå­˜å‚¨

### atomic_load_i32 / atomic_load_i64

åŸå­åœ°ä»å†…å­˜è¯»å–å€¼ã€‚

**ç­¾åï¼š**
```hemlock
atomic_load_i32(ptr: ptr): i32
atomic_load_i64(ptr: ptr): i64
```

**å‚æ•°ï¼š**
- `ptr` - æŒ‡å‘å†…å­˜ä½ç½®çš„æŒ‡é’ˆï¼ˆå¿…é¡»æ­£ç¡®å¯¹é½ï¼‰

**è¿”å›ï¼š** å†…å­˜ä½ç½®çš„å€¼

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(4);
ptr_write_i32(p, 42);

let value = atomic_load_i32(p);
print(value);  // 42

free(p);
```

---

### atomic_store_i32 / atomic_store_i64

åŸå­åœ°å‘å†…å­˜å†™å…¥å€¼ã€‚

**ç­¾åï¼š**
```hemlock
atomic_store_i32(ptr: ptr, value: i32): null
atomic_store_i64(ptr: ptr, value: i64): null
```

**å‚æ•°ï¼š**
- `ptr` - æŒ‡å‘å†…å­˜ä½ç½®çš„æŒ‡é’ˆ
- `value` - è¦å­˜å‚¨çš„å€¼

**è¿”å›ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(8);

atomic_store_i64(p, 5000000000);
print(atomic_load_i64(p));  // 5000000000

free(p);
```

---

## è·å–å¹¶ä¿®æ”¹æ“ä½œ

è¿™äº›æ“ä½œåŸå­åœ°ä¿®æ”¹å€¼å¹¶è¿”å›**æ—§çš„**ï¼ˆä¹‹å‰çš„ï¼‰å€¼ã€‚

### atomic_add_i32 / atomic_add_i64

åŸå­åœ°åŠ æ³•ã€‚

**ç­¾åï¼š**
```hemlock
atomic_add_i32(ptr: ptr, value: i32): i32
atomic_add_i64(ptr: ptr, value: i64): i64
```

**è¿”å›ï¼š** **æ—§çš„**å€¼ï¼ˆåŠ æ³•ä¹‹å‰ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(4);
ptr_write_i32(p, 100);

let old = atomic_add_i32(p, 10);
print(old);                    // 100ï¼ˆæ—§å€¼ï¼‰
print(atomic_load_i32(p));     // 110ï¼ˆæ–°å€¼ï¼‰

free(p);
```

---

### atomic_sub_i32 / atomic_sub_i64

åŸå­åœ°å‡æ³•ã€‚

**ç­¾åï¼š**
```hemlock
atomic_sub_i32(ptr: ptr, value: i32): i32
atomic_sub_i64(ptr: ptr, value: i64): i64
```

**è¿”å›ï¼š** **æ—§çš„**å€¼ï¼ˆå‡æ³•ä¹‹å‰ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(4);
ptr_write_i32(p, 100);

let old = atomic_sub_i32(p, 25);
print(old);                    // 100ï¼ˆæ—§å€¼ï¼‰
print(atomic_load_i32(p));     // 75ï¼ˆæ–°å€¼ï¼‰

free(p);
```

---

### atomic_and_i32 / atomic_and_i64

åŸå­åœ°æ‰§è¡ŒæŒ‰ä½ä¸ã€‚

**ç­¾åï¼š**
```hemlock
atomic_and_i32(ptr: ptr, value: i32): i32
atomic_and_i64(ptr: ptr, value: i64): i64
```

**è¿”å›ï¼š** **æ—§çš„**å€¼ï¼ˆä¸è¿ç®—ä¹‹å‰ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(4);
ptr_write_i32(p, 0xFF);  // äºŒè¿›åˆ¶ 255ï¼š11111111

let old = atomic_and_i32(p, 0x0F);  // ä¸ 00001111 è¿›è¡Œä¸è¿ç®—
print(old);                    // 255ï¼ˆæ—§å€¼ï¼‰
print(atomic_load_i32(p));     // 15 (0xFF & 0x0F = 0x0F)

free(p);
```

---

### atomic_or_i32 / atomic_or_i64

åŸå­åœ°æ‰§è¡ŒæŒ‰ä½æˆ–ã€‚

**ç­¾åï¼š**
```hemlock
atomic_or_i32(ptr: ptr, value: i32): i32
atomic_or_i64(ptr: ptr, value: i64): i64
```

**è¿”å›ï¼š** **æ—§çš„**å€¼ï¼ˆæˆ–è¿ç®—ä¹‹å‰ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(4);
ptr_write_i32(p, 0x0F);  // äºŒè¿›åˆ¶ 15ï¼š00001111

let old = atomic_or_i32(p, 0xF0);  // ä¸ 11110000 è¿›è¡Œæˆ–è¿ç®—
print(old);                    // 15ï¼ˆæ—§å€¼ï¼‰
print(atomic_load_i32(p));     // 255 (0x0F | 0xF0 = 0xFF)

free(p);
```

---

### atomic_xor_i32 / atomic_xor_i64

åŸå­åœ°æ‰§è¡ŒæŒ‰ä½å¼‚æˆ–ã€‚

**ç­¾åï¼š**
```hemlock
atomic_xor_i32(ptr: ptr, value: i32): i32
atomic_xor_i64(ptr: ptr, value: i64): i64
```

**è¿”å›ï¼š** **æ—§çš„**å€¼ï¼ˆå¼‚æˆ–è¿ç®—ä¹‹å‰ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(4);
ptr_write_i32(p, 0xAA);  // äºŒè¿›åˆ¶ 170ï¼š10101010

let old = atomic_xor_i32(p, 0xFF);  // ä¸ 11111111 è¿›è¡Œå¼‚æˆ–è¿ç®—
print(old);                    // 170ï¼ˆæ—§å€¼ï¼‰
print(atomic_load_i32(p));     // 85 (0xAA ^ 0xFF = 0x55)

free(p);
```

---

## æ¯”è¾ƒå¹¶äº¤æ¢ (CAS)

æœ€å¼ºå¤§çš„åŸå­æ“ä½œã€‚åŸå­åœ°å°†å½“å‰å€¼ä¸æœŸæœ›å€¼æ¯”è¾ƒï¼Œå¦‚æœåŒ¹é…åˆ™æ›¿æ¢ä¸ºæ–°å€¼ã€‚

### atomic_cas_i32 / atomic_cas_i64

**ç­¾åï¼š**
```hemlock
atomic_cas_i32(ptr: ptr, expected: i32, desired: i32): bool
atomic_cas_i64(ptr: ptr, expected: i64, desired: i64): bool
```

**å‚æ•°ï¼š**
- `ptr` - æŒ‡å‘å†…å­˜ä½ç½®çš„æŒ‡é’ˆ
- `expected` - æˆ‘ä»¬æœŸæœ›æ‰¾åˆ°çš„å€¼
- `desired` - å¦‚æœæœŸæœ›åŒ¹é…åˆ™å­˜å‚¨çš„å€¼

**è¿”å›ï¼š**
- `true` - äº¤æ¢æˆåŠŸï¼ˆå€¼æ˜¯ `expected`ï¼Œç°åœ¨æ˜¯ `desired`ï¼‰
- `false` - äº¤æ¢å¤±è´¥ï¼ˆå€¼ä¸æ˜¯ `expected`ï¼Œæœªæ”¹å˜ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(4);
ptr_write_i32(p, 100);

// CAS æˆåŠŸï¼šå€¼æ˜¯ 100ï¼Œäº¤æ¢ä¸º 999
let success1 = atomic_cas_i32(p, 100, 999);
print(success1);               // true
print(atomic_load_i32(p));     // 999

// CAS å¤±è´¥ï¼šå€¼æ˜¯ 999ï¼Œä¸æ˜¯ 100
let success2 = atomic_cas_i32(p, 100, 888);
print(success2);               // false
print(atomic_load_i32(p));     // 999ï¼ˆæœªæ”¹å˜ï¼‰

free(p);
```

**ç”¨ä¾‹ï¼š**
- å®ç°é”å’Œä¿¡å·é‡
- æ— é”æ•°æ®ç»“æ„
- ä¹è§‚å¹¶å‘æ§åˆ¶
- åŸå­æ¡ä»¶æ›´æ–°

---

## åŸå­äº¤æ¢

åŸå­åœ°äº¤æ¢å€¼ï¼Œè¿”å›æ—§å€¼ã€‚

### atomic_exchange_i32 / atomic_exchange_i64

**ç­¾åï¼š**
```hemlock
atomic_exchange_i32(ptr: ptr, value: i32): i32
atomic_exchange_i64(ptr: ptr, value: i64): i64
```

**å‚æ•°ï¼š**
- `ptr` - æŒ‡å‘å†…å­˜ä½ç½®çš„æŒ‡é’ˆ
- `value` - è¦å­˜å‚¨çš„æ–°å€¼

**è¿”å›ï¼š** **æ—§çš„**å€¼ï¼ˆäº¤æ¢ä¹‹å‰ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(4);
ptr_write_i32(p, 100);

let old = atomic_exchange_i32(p, 200);
print(old);                    // 100ï¼ˆæ—§å€¼ï¼‰
print(atomic_load_i32(p));     // 200ï¼ˆæ–°å€¼ï¼‰

free(p);
```

---

## å†…å­˜æ …æ 

å®Œæ•´çš„å†…å­˜å±éšœï¼Œç¡®ä¿æ …æ ä¹‹å‰çš„æ‰€æœ‰å†…å­˜æ“ä½œå¯¹æ‰€æœ‰çº¿ç¨‹å¯è§ï¼Œç„¶åæ‰æ‰§è¡Œæ …æ ä¹‹åçš„ä»»ä½•æ“ä½œã€‚

### atomic_fence

**ç­¾åï¼š**
```hemlock
atomic_fence(): null
```

**è¿”å›ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
// ç¡®ä¿ä¹‹å‰çš„æ‰€æœ‰å†™å…¥å¯¹å…¶ä»–çº¿ç¨‹å¯è§
atomic_fence();
```

**æ³¨æ„ï¼š** åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ ä¸éœ€è¦æ˜¾å¼çš„æ …æ ï¼Œå› ä¸ºæ‰€æœ‰åŸå­æ“ä½œå·²ç»ä½¿ç”¨é¡ºåºä¸€è‡´æ€§ã€‚æ …æ åœ¨éœ€è¦åŒæ­¥éåŸå­å†…å­˜æ“ä½œæ—¶å¾ˆæœ‰ç”¨ã€‚

---

## å‡½æ•°å‚è€ƒ

### i32 æ“ä½œ

| å‡½æ•° | ç­¾å | è¿”å› | æè¿° |
|------|------|------|------|
| `atomic_load_i32` | `(ptr)` | `i32` | åŸå­åŠ è½½å€¼ |
| `atomic_store_i32` | `(ptr, value)` | `null` | åŸå­å­˜å‚¨å€¼ |
| `atomic_add_i32` | `(ptr, value)` | `i32` | åŠ æ³•å¹¶è¿”å›æ—§å€¼ |
| `atomic_sub_i32` | `(ptr, value)` | `i32` | å‡æ³•å¹¶è¿”å›æ—§å€¼ |
| `atomic_and_i32` | `(ptr, value)` | `i32` | æŒ‰ä½ä¸å¹¶è¿”å›æ—§å€¼ |
| `atomic_or_i32` | `(ptr, value)` | `i32` | æŒ‰ä½æˆ–å¹¶è¿”å›æ—§å€¼ |
| `atomic_xor_i32` | `(ptr, value)` | `i32` | æŒ‰ä½å¼‚æˆ–å¹¶è¿”å›æ—§å€¼ |
| `atomic_cas_i32` | `(ptr, expected, desired)` | `bool` | æ¯”è¾ƒå¹¶äº¤æ¢ |
| `atomic_exchange_i32` | `(ptr, value)` | `i32` | äº¤æ¢å¹¶è¿”å›æ—§å€¼ |

### i64 æ“ä½œ

| å‡½æ•° | ç­¾å | è¿”å› | æè¿° |
|------|------|------|------|
| `atomic_load_i64` | `(ptr)` | `i64` | åŸå­åŠ è½½å€¼ |
| `atomic_store_i64` | `(ptr, value)` | `null` | åŸå­å­˜å‚¨å€¼ |
| `atomic_add_i64` | `(ptr, value)` | `i64` | åŠ æ³•å¹¶è¿”å›æ—§å€¼ |
| `atomic_sub_i64` | `(ptr, value)` | `i64` | å‡æ³•å¹¶è¿”å›æ—§å€¼ |
| `atomic_and_i64` | `(ptr, value)` | `i64` | æŒ‰ä½ä¸å¹¶è¿”å›æ—§å€¼ |
| `atomic_or_i64` | `(ptr, value)` | `i64` | æŒ‰ä½æˆ–å¹¶è¿”å›æ—§å€¼ |
| `atomic_xor_i64` | `(ptr, value)` | `i64` | æŒ‰ä½å¼‚æˆ–å¹¶è¿”å›æ—§å€¼ |
| `atomic_cas_i64` | `(ptr, expected, desired)` | `bool` | æ¯”è¾ƒå¹¶äº¤æ¢ |
| `atomic_exchange_i64` | `(ptr, value)` | `i64` | äº¤æ¢å¹¶è¿”å›æ—§å€¼ |

### å†…å­˜å±éšœ

| å‡½æ•° | ç­¾å | è¿”å› | æè¿° |
|------|------|------|------|
| `atomic_fence` | `()` | `null` | å®Œæ•´å†…å­˜å±éšœ |

---

## å¸¸è§æ¨¡å¼

### æ¨¡å¼ï¼šåŸå­è®¡æ•°å™¨

```hemlock
// çº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨
let counter = alloc(4);
ptr_write_i32(counter, 0);

fn increment(): i32 {
    return atomic_add_i32(counter, 1);
}

fn decrement(): i32 {
    return atomic_sub_i32(counter, 1);
}

fn get_count(): i32 {
    return atomic_load_i32(counter);
}

// ä½¿ç”¨
increment();  // è¿”å› 0ï¼ˆæ—§å€¼ï¼‰
increment();  // è¿”å› 1
increment();  // è¿”å› 2
print(get_count());  // 3

free(counter);
```

### æ¨¡å¼ï¼šè‡ªæ—‹é”

```hemlock
// ç®€å•çš„è‡ªæ—‹é”å®ç°
let lock = alloc(4);
ptr_write_i32(lock, 0);  // 0 = æœªé”å®šï¼Œ1 = å·²é”å®š

fn acquire() {
    // è‡ªæ—‹ç›´åˆ°æˆåŠŸå°†é”ä» 0 è®¾ç½®ä¸º 1
    while (!atomic_cas_i32(lock, 0, 1)) {
        // å¿™ç­‰å¾…
    }
}

fn release() {
    atomic_store_i32(lock, 0);
}

// ä½¿ç”¨
acquire();
// ... ä¸´ç•ŒåŒº ...
release();

free(lock);
```

### æ¨¡å¼ï¼šä¸€æ¬¡æ€§åˆå§‹åŒ–

```hemlock
let initialized = alloc(4);
ptr_write_i32(initialized, 0);  // 0 = æœªåˆå§‹åŒ–ï¼Œ1 = å·²åˆå§‹åŒ–

fn ensure_initialized() {
    // å°è¯•æˆä¸ºåˆå§‹åŒ–è€…
    if (atomic_cas_i32(initialized, 0, 1)) {
        // æˆ‘ä»¬èµ¢å¾—äº†ç«äº‰ï¼Œæ‰§è¡Œåˆå§‹åŒ–
        do_expensive_init();
    }
    // å¦åˆ™ï¼Œå·²ç»åˆå§‹åŒ–è¿‡äº†
}
```

### æ¨¡å¼ï¼šåŸå­æ ‡å¿—

```hemlock
let flag = alloc(4);
ptr_write_i32(flag, 0);

fn set_flag() {
    atomic_store_i32(flag, 1);
}

fn clear_flag() {
    atomic_store_i32(flag, 0);
}

fn test_and_set(): bool {
    // å¦‚æœæ ‡å¿—å·²ç»è®¾ç½®åˆ™è¿”å› true
    return atomic_exchange_i32(flag, 1) == 1;
}

fn check_flag(): bool {
    return atomic_load_i32(flag) == 1;
}
```

### æ¨¡å¼ï¼šæœ‰ç•Œè®¡æ•°å™¨

```hemlock
let counter = alloc(4);
ptr_write_i32(counter, 0);
let max_value = 100;

fn try_increment(): bool {
    while (true) {
        let current = atomic_load_i32(counter);
        if (current >= max_value) {
            return false;  // å·²è¾¾æœ€å¤§å€¼
        }
        if (atomic_cas_i32(counter, current, current + 1)) {
            return true;  // æˆåŠŸé€’å¢
        }
        // CAS å¤±è´¥ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å€¼ - é‡è¯•
    }
}
```

---

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨æ­£ç¡®çš„å¯¹é½

æŒ‡é’ˆå¿…é¡»ä¸ºæ•°æ®ç±»å‹æ­£ç¡®å¯¹é½ï¼š
- i32ï¼š4 å­—èŠ‚å¯¹é½
- i64ï¼š8 å­—èŠ‚å¯¹é½

æ¥è‡ª `alloc()` çš„å†…å­˜é€šå¸¸æ˜¯æ­£ç¡®å¯¹é½çš„ã€‚

### 2. ä¼˜å…ˆä½¿ç”¨æ›´é«˜çº§çš„æŠ½è±¡

å¦‚æœå¯èƒ½ï¼Œä½¿ç”¨é€šé“è¿›è¡Œä»»åŠ¡é—´é€šä¿¡ã€‚åŸå­æ“ä½œæ˜¯æ›´åº•å±‚çš„ï¼Œéœ€è¦ä»”ç»†æ¨ç†ã€‚

```hemlock
// ä¼˜å…ˆè¿™æ ·ï¼š
let ch = channel(10);
spawn(fn() { ch.send(result); });
let value = ch.recv();

// è€Œä¸æ˜¯åœ¨é€‚å½“æ—¶ä½¿ç”¨æ‰‹åŠ¨åŸå­åè°ƒ
```

### 3. æ³¨æ„ ABA é—®é¢˜

CAS å¯èƒ½é­å— ABA é—®é¢˜ï¼šå€¼ä» A å˜ä¸º B ç„¶ååˆå˜å› Aã€‚ä½ çš„ CAS æˆåŠŸäº†ï¼Œä½†çŠ¶æ€å¯èƒ½åœ¨ä¸­é—´å·²ç»æ”¹å˜ã€‚

### 4. åœ¨å…±äº«ä¹‹å‰åˆå§‹åŒ–

å§‹ç»ˆåœ¨ç”Ÿæˆè®¿é—®åŸå­å˜é‡çš„ä»»åŠ¡ä¹‹å‰åˆå§‹åŒ–å®ƒä»¬ï¼š

```hemlock
let counter = alloc(4);
ptr_write_i32(counter, 0);  // åœ¨ç”Ÿæˆä¹‹å‰åˆå§‹åŒ–

let task = spawn(worker, counter);
```

### 5. åœ¨æ‰€æœ‰ä»»åŠ¡å®Œæˆåé‡Šæ”¾

ä¸è¦åœ¨ä»»åŠ¡å¯èƒ½ä»åœ¨è®¿é—®åŸå­å†…å­˜æ—¶é‡Šæ”¾å®ƒï¼š

```hemlock
let counter = alloc(4);
ptr_write_i32(counter, 0);

let t1 = spawn(worker, counter);
let t2 = spawn(worker, counter);

join(t1);
join(t2);

// ç°åœ¨å¯ä»¥å®‰å…¨é‡Šæ”¾
free(counter);
```

---

## é™åˆ¶

### å½“å‰é™åˆ¶

1. **ä»…æ”¯æŒ i32 å’Œ i64** - å…¶ä»–ç±»å‹æ²¡æœ‰åŸå­æ“ä½œ
2. **æ²¡æœ‰æŒ‡é’ˆåŸå­æ“ä½œ** - æ— æ³•åŸå­åœ°åŠ è½½/å­˜å‚¨æŒ‡é’ˆ
3. **ä»…é¡ºåºä¸€è‡´æ€§** - æ²¡æœ‰è¾ƒå¼±çš„å†…å­˜æ’åºå¯ç”¨
4. **æ²¡æœ‰åŸå­æµ®ç‚¹æ•°** - å¦‚æœéœ€è¦è¯·ä½¿ç”¨æ•´æ•°è¡¨ç¤º

### å¹³å°è¯´æ˜

- åŸå­æ“ä½œåº•å±‚ä½¿ç”¨ C11 `<stdatomic.h>`
- åœ¨æ‰€æœ‰æ”¯æŒ POSIX çº¿ç¨‹çš„å¹³å°ä¸Šå¯ç”¨
- åœ¨ç°ä»£ 64 ä½ç³»ç»Ÿä¸Šä¿è¯æ— é”

---

## å¦è¯·å‚é˜…

- [å¼‚æ­¥/å¹¶å‘](#advanced-async-concurrency) - ä»»åŠ¡ç”Ÿæˆå’Œé€šé“
- [å†…å­˜ç®¡ç†](#language-guide-memory) - æŒ‡é’ˆå’Œç¼“å†²åŒºåˆ†é…
- [å†…å­˜ API](#reference-memory-api) - åˆ†é…å‡½æ•°


--------------------------------------------------------------------------------
## å‘½ä»¤æ‰§è¡Œ
--------------------------------------------------------------------------------

# Hemlock å‘½ä»¤æ‰§è¡Œ

Hemlock æä¾› **`exec()` å†…ç½®å‡½æ•°**æ¥æ‰§è¡Œ shell å‘½ä»¤å¹¶æ•è·è¾“å‡ºã€‚

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [exec() å‡½æ•°](#exec-å‡½æ•°)
- [ç»“æœå¯¹è±¡](#ç»“æœå¯¹è±¡)
- [åŸºæœ¬ç”¨æ³•](#åŸºæœ¬ç”¨æ³•)
- [é«˜çº§ç¤ºä¾‹](#é«˜çº§ç¤ºä¾‹)
- [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
- [å®ç°ç»†èŠ‚](#å®ç°ç»†èŠ‚)
- [å®‰å…¨è€ƒè™‘](#å®‰å…¨è€ƒè™‘)
- [é™åˆ¶](#é™åˆ¶)
- [ç”¨ä¾‹](#ç”¨ä¾‹)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)

## æ¦‚è¿°

`exec()` å‡½æ•°å…è®¸ Hemlock ç¨‹åºï¼š
- æ‰§è¡Œ shell å‘½ä»¤
- æ•è·æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰
- æ£€æŸ¥é€€å‡ºçŠ¶æ€ç 
- ä½¿ç”¨ shell ç‰¹æ€§ï¼ˆç®¡é“ã€é‡å®šå‘ç­‰ï¼‰
- ä¸ç³»ç»Ÿå·¥å…·é›†æˆ

**é‡è¦ï¼š** å‘½ä»¤é€šè¿‡ `/bin/sh` æ‰§è¡Œï¼Œæä¾›å®Œæ•´çš„ shell åŠŸèƒ½ï¼Œä½†ä¹Ÿå¼•å…¥äº†å®‰å…¨è€ƒè™‘ã€‚

## exec() å‡½æ•°

### ç­¾å

```hemlock
exec(command: string): object
```

**å‚æ•°ï¼š**
- `command` (string) - è¦æ‰§è¡Œçš„ shell å‘½ä»¤

**è¿”å›ï¼š** åŒ…å«ä¸¤ä¸ªå­—æ®µçš„å¯¹è±¡ï¼š
- `output` (string) - å‘½ä»¤çš„ stdout è¾“å‡º
- `exit_code` (i32) - å‘½ä»¤çš„é€€å‡ºçŠ¶æ€ç 

### åŸºæœ¬ç¤ºä¾‹

```hemlock
let result = exec("echo hello");
print(result.output);      // "hello\n"
print(result.exit_code);   // 0
```

## ç»“æœå¯¹è±¡

`exec()` è¿”å›çš„å¯¹è±¡å…·æœ‰ä»¥ä¸‹ç»“æ„ï¼š

```hemlock
{
    output: string,      // å‘½ä»¤ stdoutï¼ˆæ•è·çš„è¾“å‡ºï¼‰
    exit_code: i32       // è¿›ç¨‹é€€å‡ºçŠ¶æ€ï¼ˆ0 = æˆåŠŸï¼‰
}
```

### output å­—æ®µ

åŒ…å«å‘½ä»¤å†™å…¥ stdout çš„æ‰€æœ‰æ–‡æœ¬ã€‚

**å±æ€§ï¼š**
- å¦‚æœå‘½ä»¤æ²¡æœ‰è¾“å‡ºåˆ™ä¸ºç©ºå­—ç¬¦ä¸²
- åŸæ ·åŒ…å«æ¢è¡Œç¬¦å’Œç©ºç™½
- å¤šè¡Œè¾“å‡ºä¿ç•™
- å¤§å°æ— é™åˆ¶ï¼ˆåŠ¨æ€åˆ†é…ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let r1 = exec("echo test");
print(r1.output);  // "test\n"

let r2 = exec("ls");
print(r2.output);  // å¸¦æ¢è¡Œç¬¦çš„ç›®å½•åˆ—è¡¨

let r3 = exec("true");
print(r3.output);  // ""ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰
```

### exit_code å­—æ®µ

å‘½ä»¤çš„é€€å‡ºçŠ¶æ€ç ã€‚

**å€¼ï¼š**
- `0` é€šå¸¸è¡¨ç¤ºæˆåŠŸ
- `1-255` è¡¨ç¤ºé”™è¯¯ï¼ˆçº¦å®šå› å‘½ä»¤è€Œå¼‚ï¼‰
- `-1` å¦‚æœå‘½ä»¤æ— æ³•æ‰§è¡Œæˆ–å¼‚å¸¸ç»ˆæ­¢

**ç¤ºä¾‹ï¼š**
```hemlock
let r1 = exec("true");
print(r1.exit_code);  // 0ï¼ˆæˆåŠŸï¼‰

let r2 = exec("false");
print(r2.exit_code);  // 1ï¼ˆå¤±è´¥ï¼‰

let r3 = exec("ls /nonexistent");
print(r3.exit_code);  // 2ï¼ˆæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œå› å‘½ä»¤è€Œå¼‚ï¼‰
```

## åŸºæœ¬ç”¨æ³•

### ç®€å•å‘½ä»¤

```hemlock
let r = exec("ls -la");
print(r.output);
print("Exit code: " + typeof(r.exit_code));
```

### æ£€æŸ¥é€€å‡ºçŠ¶æ€

```hemlock
let r = exec("grep pattern file.txt");
if (r.exit_code == 0) {
    print("Found: " + r.output);
} else {
    print("Pattern not found");
}
```

### å¸¦ç®¡é“çš„å‘½ä»¤

```hemlock
let r = exec("ps aux | grep hemlock");
print(r.output);
```

### å¤šæ¡å‘½ä»¤

```hemlock
let r = exec("cd /tmp && ls -la");
print(r.output);
```

### å‘½ä»¤æ›¿æ¢

```hemlock
let r = exec("echo $(date)");
print(r.output);  // å½“å‰æ—¥æœŸ
```

## é«˜çº§ç¤ºä¾‹

### å¤„ç†å¤±è´¥

```hemlock
let r = exec("ls /nonexistent");
if (r.exit_code != 0) {
    print("Command failed with code: " + typeof(r.exit_code));
    print("Error output: " + r.output);  // æ³¨æ„ï¼šstderr æœªæ•è·
}
```

### å¤„ç†å¤šè¡Œè¾“å‡º

```hemlock
let r = exec("cat file.txt");
let lines = r.output.split("\n");
let i = 0;
while (i < lines.length) {
    print("Line " + typeof(i) + ": " + lines[i]);
    i = i + 1;
}
```

### å‘½ä»¤é“¾

**ä½¿ç”¨ &&ï¼ˆä¸ï¼‰ï¼š**
```hemlock
let r1 = exec("mkdir -p /tmp/test && touch /tmp/test/file.txt");
if (r1.exit_code == 0) {
    print("Setup complete");
}
```

**ä½¿ç”¨ ||ï¼ˆæˆ–ï¼‰ï¼š**
```hemlock
let r = exec("command1 || command2");
// ä»…å½“ command1 å¤±è´¥æ—¶è¿è¡Œ command2
```

**ä½¿ç”¨ ;ï¼ˆé¡ºåºï¼‰ï¼š**
```hemlock
let r = exec("command1; command2");
// æ— è®ºæˆåŠŸ/å¤±è´¥éƒ½è¿è¡Œä¸¤è€…
```

### ä½¿ç”¨ç®¡é“

```hemlock
let r = exec("echo 'data' | base64");
print("Base64: " + r.output);
```

**å¤æ‚ç®¡é“ï¼š**
```hemlock
let r = exec("cat /etc/passwd | grep root | cut -d: -f1");
print(r.output);
```

### é€€å‡ºç æ¨¡å¼

ä¸åŒçš„é€€å‡ºç è¡¨ç¤ºä¸åŒçš„æ¡ä»¶ï¼š

```hemlock
let r = exec("test -f myfile.txt");
if (r.exit_code == 0) {
    print("File exists");
} else if (r.exit_code == 1) {
    print("File does not exist");
} else {
    print("Test command failed: " + typeof(r.exit_code));
}
```

### è¾“å‡ºé‡å®šå‘

```hemlock
// å°† stdout é‡å®šå‘åˆ°æ–‡ä»¶ï¼ˆåœ¨ shell å†…ï¼‰
let r1 = exec("echo 'test' > /tmp/output.txt");

// å°† stderr é‡å®šå‘åˆ° stdoutï¼ˆæ³¨æ„ï¼šHemlock ä»æœªæ•è· stderrï¼‰
let r2 = exec("command 2>&1");
```

### ç¯å¢ƒå˜é‡

```hemlock
let r = exec("export VAR=value && echo $VAR");
print(r.output);  // "value\n"
```

### å·¥ä½œç›®å½•æ›´æ”¹

```hemlock
let r = exec("cd /tmp && pwd");
print(r.output);  // "/tmp\n"
```

## é”™è¯¯å¤„ç†

### exec() ä½•æ—¶æŠ›å‡ºå¼‚å¸¸

å¦‚æœå‘½ä»¤æ— æ³•æ‰§è¡Œï¼Œ`exec()` å‡½æ•°ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š

```hemlock
try {
    let r = exec("nonexistent_command_xyz");
} catch (e) {
    print("Failed to execute: " + e);
}
```

**æŠ›å‡ºå¼‚å¸¸çš„æƒ…å†µï¼š**
- `popen()` å¤±è´¥ï¼ˆå¦‚æ— æ³•åˆ›å»ºç®¡é“ï¼‰
- ç³»ç»Ÿèµ„æºé™åˆ¶è¶…å‡º
- å†…å­˜åˆ†é…å¤±è´¥

### exec() ä½•æ—¶ä¸æŠ›å‡ºå¼‚å¸¸

```hemlock
// å‘½ä»¤è¿è¡Œä½†è¿”å›éé›¶é€€å‡ºç 
let r1 = exec("false");
print(r1.exit_code);  // 1ï¼ˆä¸æ˜¯å¼‚å¸¸ï¼‰

// å‘½ä»¤æ²¡æœ‰è¾“å‡º
let r2 = exec("true");
print(r2.output);  // ""ï¼ˆä¸æ˜¯å¼‚å¸¸ï¼‰

// shell æ‰¾ä¸åˆ°å‘½ä»¤
let r3 = exec("nonexistent_cmd");
print(r3.exit_code);  // 127ï¼ˆä¸æ˜¯å¼‚å¸¸ï¼‰
```

### å®‰å…¨æ‰§è¡Œæ¨¡å¼

```hemlock
fn safe_exec(command: string) {
    try {
        let r = exec(command);
        if (r.exit_code != 0) {
            print("Warning: Command failed with code " + typeof(r.exit_code));
            return "";
        }
        return r.output;
    } catch (e) {
        print("Error executing command: " + e);
        return "";
    }
}

let output = safe_exec("ls -la");
```

## å®ç°ç»†èŠ‚

### å·¥ä½œåŸç†

**åº•å±‚å®ç°ï¼š**
- ä½¿ç”¨ `popen()` é€šè¿‡ `/bin/sh` æ‰§è¡Œå‘½ä»¤
- ä»…æ•è· stdoutï¼ˆstderr æœªæ•è·ï¼‰
- è¾“å‡ºåŠ¨æ€ç¼“å†²ï¼ˆä» 4KB å¼€å§‹ï¼ŒæŒ‰éœ€å¢é•¿ï¼‰
- ä½¿ç”¨ `WIFEXITED()` å’Œ `WEXITSTATUS()` å®æå–é€€å‡ºçŠ¶æ€
- è¾“å‡ºå­—ç¬¦ä¸²æ­£ç¡®ä»¥ null ç»“å°¾

**è¿›ç¨‹æµç¨‹ï¼š**
1. `popen(command, "r")` åˆ›å»ºç®¡é“å¹¶ fork è¿›ç¨‹
2. å­è¿›ç¨‹æ‰§è¡Œ `/bin/sh -c "command"`
3. çˆ¶è¿›ç¨‹é€šè¿‡ç®¡é“å°† stdout è¯»å…¥å¢é•¿çš„ç¼“å†²åŒº
4. `pclose()` ç­‰å¾…å­è¿›ç¨‹å¹¶è¿”å›é€€å‡ºçŠ¶æ€
5. æå–é€€å‡ºçŠ¶æ€å¹¶å­˜å‚¨åœ¨ç»“æœå¯¹è±¡ä¸­

### æ€§èƒ½è€ƒè™‘

**å¼€é”€ï¼š**
- æ¯æ¬¡è°ƒç”¨åˆ›å»ºæ–°çš„ shell è¿›ç¨‹ï¼ˆçº¦ 1-5ms å¼€é”€ï¼‰
- è¾“å‡ºå®Œå…¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ˆéæµå¼ï¼‰
- ä¸æ”¯æŒæµå¼ä¼ è¾“ï¼ˆç­‰å¾…å‘½ä»¤å®Œæˆï¼‰
- é€‚ç”¨äºè¾“å‡ºå¤§å°åˆç†çš„å‘½ä»¤

**ä¼˜åŒ–ï¼š**
- ç¼“å†²åŒºä» 4KB å¼€å§‹ï¼Œæ»¡æ—¶ç¿»å€ï¼ˆé«˜æ•ˆå†…å­˜ä½¿ç”¨ï¼‰
- å•ä¸€è¯»å–å¾ªç¯æœ€å°åŒ–ç³»ç»Ÿè°ƒç”¨
- æ— é¢å¤–å­—ç¬¦ä¸²å¤åˆ¶

**ä½•æ—¶ä½¿ç”¨ï¼š**
- çŸ­æ—¶è¿è¡Œçš„å‘½ä»¤ï¼ˆ< 1 ç§’ï¼‰
- ä¸­ç­‰è¾“å‡ºå¤§å°ï¼ˆ< 10MBï¼‰
- å…·æœ‰åˆç†é—´éš”çš„æ‰¹é‡æ“ä½œ

**ä½•æ—¶ä¸ä½¿ç”¨ï¼š**
- é•¿æ—¶è¿è¡Œçš„å®ˆæŠ¤è¿›ç¨‹æˆ–æœåŠ¡
- äº§ç”Ÿ GB çº§è¾“å‡ºçš„å‘½ä»¤
- å®æ—¶æµæ•°æ®å¤„ç†
- é«˜é¢‘æ‰§è¡Œï¼ˆ> 100 æ¬¡/ç§’ï¼‰

## å®‰å…¨è€ƒè™‘

### Shell æ³¨å…¥é£é™©

**å…³é”®ï¼š** å‘½ä»¤ç”± shellï¼ˆ`/bin/sh`ï¼‰æ‰§è¡Œï¼Œè¿™æ„å‘³ç€ **shell æ³¨å…¥æ˜¯å¯èƒ½çš„**ã€‚

**æ˜“å—æ”»å‡»çš„ä»£ç ï¼š**
```hemlock
// å±é™© - ä¸è¦è¿™æ ·åš
let filename = args[1];  // ç”¨æˆ·è¾“å…¥
let r = exec("cat " + filename);  // Shell æ³¨å…¥ï¼
```

**æ”»å‡»ï¼š**
```bash
./hemlock script.hml "; rm -rf /; echo pwned"
# æ‰§è¡Œ: cat ; rm -rf /; echo pwned
```

### å®‰å…¨å®è·µ

**1. æ°¸è¿œä¸è¦ä½¿ç”¨æœªç»å‡€åŒ–çš„ç”¨æˆ·è¾“å…¥ï¼š**
```hemlock
// ä¸å¥½
let user_input = args[1];
let r = exec("process " + user_input);  // å±é™©

// å¥½ - å…ˆéªŒè¯
fn is_safe_filename(name: string): bool {
    // åªå…è®¸å­—æ¯æ•°å­—ã€ç ´æŠ˜å·ã€ä¸‹åˆ’çº¿ã€ç‚¹
    let i = 0;
    while (i < name.length) {
        let c = name[i];
        if (!(c >= 'a' && c <= 'z') &&
            !(c >= 'A' && c <= 'Z') &&
            !(c >= '0' && c <= '9') &&
            c != '-' && c != '_' && c != '.') {
            return false;
        }
        i = i + 1;
    }
    return true;
}

let filename = args[1];
if (is_safe_filename(filename)) {
    let r = exec("cat " + filename);
} else {
    print("Invalid filename");
}
```

**2. ä½¿ç”¨ç™½åå•ï¼Œè€Œä¸æ˜¯é»‘åå•ï¼š**
```hemlock
// å¥½ - ä¸¥æ ¼çš„ç™½åå•
let allowed_commands = ["status", "start", "stop", "restart"];
let cmd = args[1];

let found = false;
for (let allowed in allowed_commands) {
    if (cmd == allowed) {
        found = true;
        break;
    }
}

if (found) {
    exec("service myapp " + cmd);
} else {
    print("Invalid command");
}
```

**3. è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼š**
```hemlock
fn shell_escape(s: string): string {
    // ç®€å•è½¬ä¹‰ - ç”¨å•å¼•å·åŒ…è£¹å¹¶è½¬ä¹‰å•å¼•å·
    let escaped = s.replace_all("'", "'\\''");
    return "'" + escaped + "'";
}

let user_file = args[1];
let safe = shell_escape(user_file);
let r = exec("cat " + safe);
```

**4. é¿å…å¯¹æ–‡ä»¶æ“ä½œä½¿ç”¨ exec()ï¼š**
```hemlock
// ä¸å¥½ - ä½¿ç”¨ exec è¿›è¡Œæ–‡ä»¶æ“ä½œ
let r = exec("cat file.txt");

// å¥½ - ä½¿ç”¨ Hemlock çš„æ–‡ä»¶ API
let f = open("file.txt", "r");
let content = f.read();
f.close();
```

### æƒé™è€ƒè™‘

å‘½ä»¤ä»¥ä¸ Hemlock è¿›ç¨‹ç›¸åŒçš„æƒé™è¿è¡Œï¼š

```hemlock
// å¦‚æœ Hemlock ä»¥ root è¿è¡Œï¼Œexec() å‘½ä»¤ä¹Ÿä»¥ root è¿è¡Œï¼
let r = exec("rm -rf /important");  // å¦‚æœä»¥ root è¿è¡Œåˆ™å±é™©
```

**æœ€ä½³å®è·µï¼š** ä»¥æ‰€éœ€çš„æœ€å°æƒé™è¿è¡Œ Hemlockã€‚

## é™åˆ¶

### 1. æ—  stderr æ•è·

åªæ•è· stdoutï¼Œstderr è¾“å‡ºåˆ°ç»ˆç«¯ï¼š

```hemlock
let r = exec("ls /nonexistent");
// r.output ä¸ºç©º
// é”™è¯¯æ¶ˆæ¯å‡ºç°åœ¨ç»ˆç«¯ä¸Šï¼Œæœªæ•è·
```

**å˜é€šæ–¹æ³• - å°† stderr é‡å®šå‘åˆ° stdoutï¼š**
```hemlock
let r = exec("ls /nonexistent 2>&1");
// ç°åœ¨é”™è¯¯æ¶ˆæ¯åœ¨ r.output ä¸­
```

### 2. æ— æµå¼ä¼ è¾“

å¿…é¡»ç­‰å¾…å‘½ä»¤å®Œæˆï¼š

```hemlock
let r = exec("long_running_command");
// é˜»å¡ç›´åˆ°å‘½ä»¤å®Œæˆ
// æ— æ³•å¢é‡å¤„ç†è¾“å‡º
```

### 3. æ— è¶…æ—¶

å‘½ä»¤å¯ä»¥æ— é™æœŸè¿è¡Œï¼š

```hemlock
let r = exec("sleep 1000");
// é˜»å¡ 1000 ç§’
// æ— æ³•è¶…æ—¶æˆ–å–æ¶ˆ
```

**å˜é€šæ–¹æ³• - ä½¿ç”¨ timeout å‘½ä»¤ï¼š**
```hemlock
let r = exec("timeout 5 long_command");
// 5 ç§’åè¶…æ—¶
```

### 4. æ— ä¿¡å·å¤„ç†

æ— æ³•å‘è¿è¡Œä¸­çš„å‘½ä»¤å‘é€ä¿¡å·ï¼š

```hemlock
let r = exec("long_command");
// æ— æ³•å‘å‘½ä»¤å‘é€ SIGINTã€SIGTERM ç­‰
```

### 5. æ— è¿›ç¨‹æ§åˆ¶

å¯åŠ¨åæ— æ³•ä¸å‘½ä»¤äº¤äº’ï¼š

```hemlock
let r = exec("interactive_program");
// æ— æ³•å‘ç¨‹åºå‘é€è¾“å…¥
// æ— æ³•æ§åˆ¶æ‰§è¡Œ
```

## ç”¨ä¾‹

### é€‚åˆçš„ç”¨ä¾‹

**1. è¿è¡Œç³»ç»Ÿå·¥å…·ï¼š**
```hemlock
let r = exec("ls -la");
let r = exec("grep pattern file.txt");
let r = exec("find /path -name '*.txt'");
```

**2. ä½¿ç”¨ Unix å·¥å…·å¿«é€Ÿå¤„ç†æ•°æ®ï¼š**
```hemlock
let r = exec("cat data.txt | sort | uniq | wc -l");
print("Unique lines: " + r.output);
```

**3. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ï¼š**
```hemlock
let r = exec("df -h");
print("Disk usage:\n" + r.output);
```

**4. æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥ï¼š**
```hemlock
let r = exec("test -f myfile.txt");
if (r.exit_code == 0) {
    print("File exists");
}
```

**5. ç”ŸæˆæŠ¥å‘Šï¼š**
```hemlock
let r = exec("ps aux | grep myapp | wc -l");
let count = r.output.trim();
print("Running instances: " + count);
```

**6. è‡ªåŠ¨åŒ–è„šæœ¬ï¼š**
```hemlock
exec("git add .");
exec("git commit -m 'Auto commit'");
let r = exec("git push");
if (r.exit_code != 0) {
    print("Push failed");
}
```

### ä¸æ¨èçš„ç”¨ä¾‹

**1. é•¿æ—¶è¿è¡Œçš„æœåŠ¡ï¼š**
```hemlock
// ä¸å¥½
let r = exec("nginx");  // æ°¸è¿œé˜»å¡
```

**2. äº¤äº’å¼å‘½ä»¤ï¼š**
```hemlock
// ä¸å¥½ - æ— æ³•æä¾›è¾“å…¥
let r = exec("ssh user@host");
```

**3. äº§ç”Ÿå·¨å¤§è¾“å‡ºçš„å‘½ä»¤ï¼š**
```hemlock
// ä¸å¥½ - å°†æ•´ä¸ªè¾“å‡ºåŠ è½½åˆ°å†…å­˜
let r = exec("cat 10GB_file.log");
```

**4. å®æ—¶æµå¼ä¼ è¾“ï¼š**
```hemlock
// ä¸å¥½ - æ— æ³•å¢é‡å¤„ç†è¾“å‡º
let r = exec("tail -f /var/log/app.log");
```

**5. å…³é”®ä»»åŠ¡é”™è¯¯å¤„ç†ï¼š**
```hemlock
// ä¸å¥½ - stderr æœªæ•è·
let r = exec("critical_operation");
// æ— æ³•çœ‹åˆ°è¯¦ç»†é”™è¯¯æ¶ˆæ¯
```

## æœ€ä½³å®è·µ

### 1. å§‹ç»ˆæ£€æŸ¥é€€å‡ºç 

```hemlock
let r = exec("important_command");
if (r.exit_code != 0) {
    print("Command failed!");
    // å¤„ç†é”™è¯¯
}
```

### 2. éœ€è¦æ—¶ä¿®å‰ªè¾“å‡º

```hemlock
let r = exec("echo test");
let clean = r.output.trim();  // ç§»é™¤å°¾éšæ¢è¡Œç¬¦
print(clean);  // "test"ï¼ˆæ— æ¢è¡Œç¬¦ï¼‰
```

### 3. æ‰§è¡Œå‰éªŒè¯

```hemlock
fn is_valid_command(cmd: string): bool {
    // éªŒè¯å‘½ä»¤æ˜¯å¦å®‰å…¨
    return true;  // ä½ çš„éªŒè¯é€»è¾‘
}

if (is_valid_command(user_cmd)) {
    exec(user_cmd);
}
```

### 4. å¯¹å…³é”®æ“ä½œä½¿ç”¨ try/catch

```hemlock
try {
    let r = exec("critical_command");
    if (r.exit_code != 0) {
        throw "Command failed";
    }
} catch (e) {
    print("Error: " + e);
    // æ¸…ç†æˆ–æ¢å¤
}
```

### 5. ä¼˜å…ˆä½¿ç”¨ Hemlock API è€Œä¸æ˜¯ exec()

```hemlock
// ä¸å¥½ - ä½¿ç”¨ exec è¿›è¡Œæ–‡ä»¶æ“ä½œ
let r = exec("cat file.txt");

// å¥½ - ä½¿ç”¨ Hemlock çš„æ–‡ä»¶ API
let f = open("file.txt", "r");
let content = f.read();
f.close();
```

### 6. éœ€è¦æ—¶æ•è· stderr

```hemlock
// å°† stderr é‡å®šå‘åˆ° stdout
let r = exec("command 2>&1");
// ç°åœ¨ r.output åŒæ—¶åŒ…å« stdout å’Œ stderr
```

### 7. æ˜æ™ºä½¿ç”¨ Shell ç‰¹æ€§

```hemlock
// ä½¿ç”¨ç®¡é“æé«˜æ•ˆç‡
let r = exec("cat large.txt | grep pattern | head -n 10");

// ä½¿ç”¨å‘½ä»¤æ›¿æ¢
let r = exec("echo Current user: $(whoami)");

// ä½¿ç”¨æ¡ä»¶æ‰§è¡Œ
let r = exec("test -f file.txt && cat file.txt");
```

## å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šç³»ç»Ÿä¿¡æ¯æ”¶é›†å™¨

```hemlock
fn get_system_info() {
    print("=== System Information ===");

    // ä¸»æœºå
    let r1 = exec("hostname");
    print("Hostname: " + r1.output.trim());

    // è¿è¡Œæ—¶é—´
    let r2 = exec("uptime");
    print("Uptime: " + r2.output.trim());

    // ç£ç›˜ä½¿ç”¨
    let r3 = exec("df -h /");
    print("\nDisk Usage:");
    print(r3.output);

    // å†…å­˜ä½¿ç”¨
    let r4 = exec("free -h");
    print("Memory Usage:");
    print(r4.output);
}

get_system_info();
```

### ç¤ºä¾‹ 2ï¼šæ—¥å¿—åˆ†æå™¨

```hemlock
fn analyze_log(logfile: string) {
    print("Analyzing log: " + logfile);

    // ç»Ÿè®¡æ€»è¡Œæ•°
    let r1 = exec("wc -l " + logfile);
    print("Total lines: " + r1.output.trim());

    // ç»Ÿè®¡é”™è¯¯æ•°
    let r2 = exec("grep -c ERROR " + logfile + " 2>/dev/null");
    let errors = r2.output.trim();
    if (r2.exit_code == 0) {
        print("Errors: " + errors);
    } else {
        print("Errors: 0");
    }

    // ç»Ÿè®¡è­¦å‘Šæ•°
    let r3 = exec("grep -c WARN " + logfile + " 2>/dev/null");
    let warnings = r3.output.trim();
    if (r3.exit_code == 0) {
        print("Warnings: " + warnings);
    } else {
        print("Warnings: 0");
    }

    // æœ€è¿‘çš„é”™è¯¯
    print("\nRecent errors:");
    let r4 = exec("grep ERROR " + logfile + " | tail -n 5");
    print(r4.output);
}

if (args.length < 2) {
    print("Usage: " + args[0] + " <logfile>");
} else {
    analyze_log(args[1]);
}
```

### ç¤ºä¾‹ 3ï¼šGit åŠ©æ‰‹

```hemlock
fn git_status() {
    let r = exec("git status --short");
    if (r.exit_code != 0) {
        print("Error: Not a git repository");
        return;
    }

    if (r.output == "") {
        print("Working directory clean");
    } else {
        print("Changes:");
        print(r.output);
    }
}

fn git_quick_commit(message: string) {
    print("Adding all changes...");
    let r1 = exec("git add -A");
    if (r1.exit_code != 0) {
        print("Error adding files");
        return;
    }

    print("Committing...");
    let safe_msg = message.replace_all("'", "'\\''");
    let r2 = exec("git commit -m '" + safe_msg + "'");
    if (r2.exit_code != 0) {
        print("Error committing");
        return;
    }

    print("Committed successfully");
    print(r2.output);
}

// ç”¨æ³•
git_status();
if (args.length > 1) {
    git_quick_commit(args[1]);
}
```

### ç¤ºä¾‹ 4ï¼šå¤‡ä»½è„šæœ¬

```hemlock
fn backup_directory(source: string, dest: string) {
    print("Backing up " + source + " to " + dest);

    // åˆ›å»ºå¤‡ä»½ç›®å½•
    let r1 = exec("mkdir -p " + dest);
    if (r1.exit_code != 0) {
        print("Error creating backup directory");
        return false;
    }

    // åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„å‹ç¼©åŒ…
    let r2 = exec("date +%Y%m%d_%H%M%S");
    let timestamp = r2.output.trim();
    let backup_file = dest + "/backup_" + timestamp + ".tar.gz";

    print("Creating archive: " + backup_file);
    let r3 = exec("tar -czf " + backup_file + " " + source + " 2>&1");
    if (r3.exit_code != 0) {
        print("Error creating backup:");
        print(r3.output);
        return false;
    }

    print("Backup completed successfully");

    // æ˜¾ç¤ºå¤‡ä»½å¤§å°
    let r4 = exec("du -h " + backup_file);
    print("Backup size: " + r4.output.trim());

    return true;
}

if (args.length < 3) {
    print("Usage: " + args[0] + " <source> <destination>");
} else {
    backup_directory(args[1], args[2]);
}
```

## æ€»ç»“

Hemlock çš„ `exec()` å‡½æ•°æä¾›ï¼š

- ç®€å•çš„ shell å‘½ä»¤æ‰§è¡Œ
- è¾“å‡ºæ•è·ï¼ˆstdoutï¼‰
- é€€å‡ºç æ£€æŸ¥
- å®Œæ•´çš„ shell ç‰¹æ€§è®¿é—®ï¼ˆç®¡é“ã€é‡å®šå‘ç­‰ï¼‰
- ä¸ç³»ç»Ÿå·¥å…·çš„é›†æˆ

è¯·è®°ä½ï¼š
- å§‹ç»ˆæ£€æŸ¥é€€å‡ºç 
- æ³¨æ„å®‰å…¨éšæ‚£ï¼ˆshell æ³¨å…¥ï¼‰
- åœ¨å‘½ä»¤ä¸­ä½¿ç”¨å‰éªŒè¯ç”¨æˆ·è¾“å…¥
- å¯ç”¨æ—¶ä¼˜å…ˆä½¿ç”¨ Hemlock API è€Œä¸æ˜¯ exec()
- stderr æœªæ•è·ï¼ˆä½¿ç”¨ `2>&1` é‡å®šå‘ï¼‰
- å‘½ä»¤é˜»å¡ç›´åˆ°å®Œæˆ
- ç”¨äºçŸ­æ—¶è¿è¡Œçš„å·¥å…·ï¼Œä¸æ˜¯é•¿æ—¶è¿è¡Œçš„æœåŠ¡

**å®‰å…¨æ£€æŸ¥æ¸…å•ï¼š**
- æ°¸è¿œä¸è¦ä½¿ç”¨æœªç»å‡€åŒ–çš„ç”¨æˆ·è¾“å…¥
- éªŒè¯æ‰€æœ‰è¾“å…¥
- å¯¹å‘½ä»¤ä½¿ç”¨ç™½åå•
- å¿…è¦æ—¶è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
- ä»¥æœ€å°æƒé™è¿è¡Œ
- ä¼˜å…ˆä½¿ç”¨ Hemlock API è€Œä¸æ˜¯ shell å‘½ä»¤


--------------------------------------------------------------------------------
## å‘½ä»¤è¡Œå‚æ•°
--------------------------------------------------------------------------------

# Hemlock å‘½ä»¤è¡Œå‚æ•°

Hemlock ç¨‹åºå¯ä»¥é€šè¿‡å†…ç½®çš„ **`args` æ•°ç»„**è®¿é—®å‘½ä»¤è¡Œå‚æ•°ï¼Œè¯¥æ•°ç»„åœ¨ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨å¡«å……ã€‚

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [args æ•°ç»„](#args-æ•°ç»„)
- [å±æ€§](#å±æ€§)
- [è¿­ä»£æ¨¡å¼](#è¿­ä»£æ¨¡å¼)
- [å¸¸è§ç”¨ä¾‹](#å¸¸è§ç”¨ä¾‹)
- [å‚æ•°è§£ææ¨¡å¼](#å‚æ•°è§£ææ¨¡å¼)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)

## æ¦‚è¿°

`args` æ•°ç»„æä¾›å¯¹ä¼ é€’ç»™ Hemlock ç¨‹åºçš„å‘½ä»¤è¡Œå‚æ•°çš„è®¿é—®ï¼š

- **å§‹ç»ˆå¯ç”¨** - æ‰€æœ‰ Hemlock ç¨‹åºä¸­çš„å†…ç½®å…¨å±€å˜é‡
- **åŒ…å«è„šæœ¬åç§°** - `args[0]` å§‹ç»ˆåŒ…å«è„šæœ¬è·¯å¾„/åç§°
- **å­—ç¬¦ä¸²æ•°ç»„** - æ‰€æœ‰å‚æ•°éƒ½æ˜¯å­—ç¬¦ä¸²
- **ä»é›¶å¼€å§‹ç´¢å¼•** - æ ‡å‡†æ•°ç»„ç´¢å¼•ï¼ˆ0ã€1ã€2ã€...ï¼‰

## args æ•°ç»„

### åŸºæœ¬ç»“æ„

```hemlock
// args[0] å§‹ç»ˆæ˜¯è„šæœ¬æ–‡ä»¶å
// args[1] åˆ° args[n-1] æ˜¯å®é™…å‚æ•°
print(args[0]);        // "script.hml"
print(args.length);    // å‚æ•°æ€»æ•°ï¼ˆåŒ…æ‹¬è„šæœ¬åç§°ï¼‰
```

### ä½¿ç”¨ç¤ºä¾‹

**å‘½ä»¤ï¼š**
```bash
./hemlock script.hml hello world "test 123"
```

**åœ¨ script.hml ä¸­ï¼š**
```hemlock
print("Script name: " + args[0]);     // "script.hml"
print("Total args: " + typeof(args.length));  // "4"
print("First arg: " + args[1]);       // "hello"
print("Second arg: " + args[2]);      // "world"
print("Third arg: " + args[3]);       // "test 123"
```

### ç´¢å¼•å‚è€ƒ

| ç´¢å¼• | åŒ…å« | ç¤ºä¾‹å€¼ |
|-------|----------|---------------|
| `args[0]` | è„šæœ¬è·¯å¾„/åç§° | `"script.hml"` æˆ– `"./script.hml"` |
| `args[1]` | ç¬¬ä¸€ä¸ªå‚æ•° | `"hello"` |
| `args[2]` | ç¬¬äºŒä¸ªå‚æ•° | `"world"` |
| `args[3]` | ç¬¬ä¸‰ä¸ªå‚æ•° | `"test 123"` |
| ... | ... | ... |
| `args[n-1]` | æœ€åä¸€ä¸ªå‚æ•° | ï¼ˆä¸å®šï¼‰ |

## å±æ€§

### å§‹ç»ˆå­˜åœ¨

`args` æ˜¯**æ‰€æœ‰** Hemlock ç¨‹åºä¸­å¯ç”¨çš„å…¨å±€æ•°ç»„ï¼š

```hemlock
// æ— éœ€å£°æ˜æˆ–å¯¼å…¥
print(args.length);  // ç«‹å³å¯ç”¨
```

### åŒ…å«è„šæœ¬åç§°

`args[0]` å§‹ç»ˆåŒ…å«è„šæœ¬è·¯å¾„/åç§°ï¼š

```hemlock
print("Running: " + args[0]);
```

**args[0] çš„å¯èƒ½å€¼ï¼š**
- `"script.hml"` - ä»…æ–‡ä»¶å
- `"./script.hml"` - ç›¸å¯¹è·¯å¾„
- `"/home/user/script.hml"` - ç»å¯¹è·¯å¾„
- å–å†³äºè„šæœ¬çš„è°ƒç”¨æ–¹å¼

### ç±»å‹ï¼šå­—ç¬¦ä¸²æ•°ç»„

æ‰€æœ‰å‚æ•°éƒ½å­˜å‚¨ä¸ºå­—ç¬¦ä¸²ï¼š

```hemlock
// å‚æ•°: ./hemlock script.hml 42 3.14 true

print(args[1]);  // "42"ï¼ˆå­—ç¬¦ä¸²ï¼Œä¸æ˜¯æ•°å­—ï¼‰
print(args[2]);  // "3.14"ï¼ˆå­—ç¬¦ä¸²ï¼Œä¸æ˜¯æ•°å­—ï¼‰
print(args[3]);  // "true"ï¼ˆå­—ç¬¦ä¸²ï¼Œä¸æ˜¯å¸ƒå°”å€¼ï¼‰

// æ ¹æ®éœ€è¦è½¬æ¢ï¼š
let num = 42;  // å¦‚éœ€è¦å¯æ‰‹åŠ¨è§£æ
```

### æœ€å°é•¿åº¦

å§‹ç»ˆè‡³å°‘ä¸º 1ï¼ˆè„šæœ¬åç§°ï¼‰ï¼š

```hemlock
print(args.length);  // æœ€å°å€¼: 1
```

**å³ä½¿æ²¡æœ‰å‚æ•°ï¼š**
```bash
./hemlock script.hml
```

```hemlock
// åœ¨ script.hml ä¸­ï¼š
print(args.length);  // 1ï¼ˆä»…è„šæœ¬åç§°ï¼‰
```

### REPL è¡Œä¸º

åœ¨ REPL ä¸­ï¼Œ`args.length` ä¸º 0ï¼ˆç©ºæ•°ç»„ï¼‰ï¼š

```hemlock
# REPL ä¼šè¯
> print(args.length);
0
```

## è¿­ä»£æ¨¡å¼

### åŸºæœ¬è¿­ä»£

è·³è¿‡ `args[0]`ï¼ˆè„šæœ¬åç§°ï¼‰å¹¶å¤„ç†å®é™…å‚æ•°ï¼š

```hemlock
let i = 1;
while (i < args.length) {
    print("Argument " + typeof(i) + ": " + args[i]);
    i = i + 1;
}
```

**å¯¹äº `./hemlock script.hml foo bar baz` çš„è¾“å‡ºï¼š**
```
Argument 1: foo
Argument 2: bar
Argument 3: baz
```

### For-In è¿­ä»£ï¼ˆåŒ…æ‹¬è„šæœ¬åç§°ï¼‰

```hemlock
for (let arg in args) {
    print(arg);
}
```

**è¾“å‡ºï¼š**
```
script.hml
foo
bar
baz
```

### æ£€æŸ¥å‚æ•°æ•°é‡

```hemlock
if (args.length < 2) {
    print("Usage: " + args[0] + " <argument>");
    // é€€å‡ºæˆ–è¿”å›
} else {
    let arg = args[1];
    // å¤„ç† arg
}
```

### å¤„ç†é™¤è„šæœ¬åç§°å¤–çš„æ‰€æœ‰å‚æ•°

```hemlock
let actual_args = args.slice(1, args.length);

for (let arg in actual_args) {
    print("Processing: " + arg);
}
```

## å¸¸è§ç”¨ä¾‹

### 1. ç®€å•å‚æ•°å¤„ç†

æ£€æŸ¥å¿…éœ€å‚æ•°ï¼š

```hemlock
if (args.length < 2) {
    print("Usage: " + args[0] + " <filename>");
} else {
    let filename = args[1];
    print("Processing file: " + filename);
    // ... å¤„ç†æ–‡ä»¶
}
```

**ç”¨æ³•ï¼š**
```bash
./hemlock script.hml data.txt
# è¾“å‡º: Processing file: data.txt
```

### 2. å¤šä¸ªå‚æ•°

```hemlock
if (args.length < 3) {
    print("Usage: " + args[0] + " <input> <output>");
} else {
    let input_file = args[1];
    let output_file = args[2];

    print("Input: " + input_file);
    print("Output: " + output_file);

    // å¤„ç†æ–‡ä»¶...
}
```

**ç”¨æ³•ï¼š**
```bash
./hemlock convert.hml input.txt output.txt
```

### 3. å¯å˜æ•°é‡çš„å‚æ•°

å¤„ç†æ‰€æœ‰æä¾›çš„å‚æ•°ï¼š

```hemlock
if (args.length < 2) {
    print("Usage: " + args[0] + " <file1> [file2] [file3] ...");
} else {
    print("Processing " + typeof(args.length - 1) + " files:");

    let i = 1;
    while (i < args.length) {
        print("  " + args[i]);
        process_file(args[i]);
        i = i + 1;
    }
}
```

**ç”¨æ³•ï¼š**
```bash
./hemlock batch.hml file1.txt file2.txt file3.txt
```

### 4. å¸®åŠ©ä¿¡æ¯

```hemlock
if (args.length < 2 || args[1] == "--help" || args[1] == "-h") {
    print("Usage: " + args[0] + " [OPTIONS] <file>");
    print("Options:");
    print("  -h, --help     Show this help message");
    print("  -v, --verbose  Enable verbose output");
} else {
    // æ­£å¸¸å¤„ç†
}
```

### 5. å‚æ•°éªŒè¯

```hemlock
fn validate_file(filename: string): bool {
    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆç¤ºä¾‹ï¼‰
    return filename != "";
}

if (args.length < 2) {
    print("Error: No filename provided");
} else if (!validate_file(args[1])) {
    print("Error: Invalid file: " + args[1]);
} else {
    print("Processing: " + args[1]);
}
```

## å‚æ•°è§£ææ¨¡å¼

### å‘½åå‚æ•°ï¼ˆæ ‡å¿—ï¼‰

å‘½åå‚æ•°çš„ç®€å•æ¨¡å¼ï¼š

```hemlock
let verbose = false;
let output_file = "";
let input_file = "";

let i = 1;
while (i < args.length) {
    if (args[i] == "--verbose" || args[i] == "-v") {
        verbose = true;
    } else if (args[i] == "--output" || args[i] == "-o") {
        i = i + 1;
        if (i < args.length) {
            output_file = args[i];
        }
    } else {
        input_file = args[i];
    }
    i = i + 1;
}

if (verbose) {
    print("Verbose mode enabled");
}
print("Input: " + input_file);
print("Output: " + output_file);
```

**ç”¨æ³•ï¼š**
```bash
./hemlock script.hml --verbose --output out.txt input.txt
./hemlock script.hml -v -o out.txt input.txt
```

### å¸ƒå°”æ ‡å¿—

```hemlock
let debug = false;
let verbose = false;
let force = false;

let i = 1;
while (i < args.length) {
    if (args[i] == "--debug") {
        debug = true;
    } else if (args[i] == "--verbose") {
        verbose = true;
    } else if (args[i] == "--force") {
        force = true;
    }
    i = i + 1;
}
```

### å€¼å‚æ•°

```hemlock
let config_file = "default.conf";
let port = 8080;

let i = 1;
while (i < args.length) {
    if (args[i] == "--config") {
        i = i + 1;
        if (i < args.length) {
            config_file = args[i];
        }
    } else if (args[i] == "--port") {
        i = i + 1;
        if (i < args.length) {
            port = 8080;  // éœ€è¦å°†å­—ç¬¦ä¸²è§£æä¸ºæ•´æ•°
        }
    }
    i = i + 1;
}
```

### æ··åˆä½ç½®å‚æ•°å’Œå‘½åå‚æ•°

```hemlock
let input_file = "";
let output_file = "";
let verbose = false;

let i = 1;
let positional = [];

while (i < args.length) {
    if (args[i] == "--verbose") {
        verbose = true;
    } else {
        // ä½œä¸ºä½ç½®å‚æ•°å¤„ç†
        positional.push(args[i]);
    }
    i = i + 1;
}

// åˆ†é…ä½ç½®å‚æ•°
if (positional.length > 0) {
    input_file = positional[0];
}
if (positional.length > 1) {
    output_file = positional[1];
}
```

### å‚æ•°è§£æå™¨è¾…åŠ©å‡½æ•°

```hemlock
fn parse_args() {
    let options = {
        verbose: false,
        output: "",
        files: []
    };

    let i = 1;
    while (i < args.length) {
        let arg = args[i];

        if (arg == "--verbose" || arg == "-v") {
            options.verbose = true;
        } else if (arg == "--output" || arg == "-o") {
            i = i + 1;
            if (i < args.length) {
                options.output = args[i];
            }
        } else {
            // ä½ç½®å‚æ•°
            options.files.push(arg);
        }

        i = i + 1;
    }

    return options;
}

let opts = parse_args();
print("Verbose: " + typeof(opts.verbose));
print("Output: " + opts.output);
print("Files: " + typeof(opts.files.length));
```

## æœ€ä½³å®è·µ

### 1. å§‹ç»ˆæ£€æŸ¥å‚æ•°æ•°é‡

```hemlock
// å¥½çš„åšæ³•
if (args.length < 2) {
    print("Usage: " + args[0] + " <file>");
} else {
    process_file(args[1]);
}

// ä¸å¥½çš„åšæ³• - å¦‚æœæ²¡æœ‰å‚æ•°å¯èƒ½ä¼šå´©æºƒ
process_file(args[1]);  // å¦‚æœ args.length == 1 ä¼šå‡ºé”™
```

### 2. æä¾›ç”¨æ³•ä¿¡æ¯

```hemlock
fn show_usage() {
    print("Usage: " + args[0] + " [OPTIONS] <file>");
    print("Options:");
    print("  -h, --help     Show help");
    print("  -v, --verbose  Verbose output");
}

if (args.length < 2) {
    show_usage();
}
```

### 3. éªŒè¯å‚æ•°

```hemlock
fn validate_args() {
    if (args.length < 2) {
        print("Error: Missing required argument");
        return false;
    }

    if (args[1] == "") {
        print("Error: Empty argument");
        return false;
    }

    return true;
}

if (!validate_args()) {
    // é€€å‡ºæˆ–æ˜¾ç¤ºç”¨æ³•
}
```

### 4. ä½¿ç”¨æè¿°æ€§å˜é‡å

```hemlock
// å¥½çš„åšæ³•
let input_filename = args[1];
let output_filename = args[2];
let max_iterations = args[3];

// ä¸å¥½çš„åšæ³•
let a = args[1];
let b = args[2];
let c = args[3];
```

### 5. å¤„ç†å¸¦ç©ºæ ¼çš„å¼•å·å‚æ•°

Shell ä¼šè‡ªåŠ¨å¤„ç†ï¼š

```bash
./hemlock script.hml "file with spaces.txt"
```

```hemlock
print(args[1]);  // "file with spaces.txt"
```

### 6. åˆ›å»ºå‚æ•°å¯¹è±¡

```hemlock
fn get_args() {
    return {
        script: args[0],
        input: args[1],
        output: args[2]
    };
}

let arguments = get_args();
print("Input: " + arguments.input);
```

## å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šæ–‡ä»¶å¤„ç†å™¨

```hemlock
// ç”¨æ³•: ./hemlock process.hml <input> <output>

fn show_usage() {
    print("Usage: " + args[0] + " <input_file> <output_file>");
}

if (args.length < 3) {
    show_usage();
} else {
    let input = args[1];
    let output = args[2];

    print("Processing " + input + " -> " + output);

    // å¤„ç†æ–‡ä»¶
    let f_in = open(input, "r");
    let f_out = open(output, "w");

    try {
        let content = f_in.read();
        let processed = content.to_upper();  // ç¤ºä¾‹å¤„ç†
        f_out.write(processed);

        print("Done!");
    } finally {
        f_in.close();
        f_out.close();
    }
}
```

### ç¤ºä¾‹ 2ï¼šæ‰¹é‡æ–‡ä»¶å¤„ç†å™¨

```hemlock
// ç”¨æ³•: ./hemlock batch.hml <file1> <file2> <file3> ...

if (args.length < 2) {
    print("Usage: " + args[0] + " <file1> [file2] [file3] ...");
} else {
    print("Processing " + typeof(args.length - 1) + " files:");

    let i = 1;
    while (i < args.length) {
        let filename = args[i];
        print("  Processing: " + filename);

        try {
            let f = open(filename, "r");
            let content = f.read();
            f.close();

            // å¤„ç†å†…å®¹...
            print("    " + typeof(content.length) + " bytes");
        } catch (e) {
            print("    Error: " + e);
        }

        i = i + 1;
    }

    print("Done!");
}
```

### ç¤ºä¾‹ 3ï¼šé«˜çº§å‚æ•°è§£æå™¨

```hemlock
// ç”¨æ³•: ./hemlock app.hml [OPTIONS] <files...>
// é€‰é¡¹:
//   --verbose, -v     å¯ç”¨è¯¦ç»†è¾“å‡º
//   --output, -o FILE è®¾ç½®è¾“å‡ºæ–‡ä»¶
//   --help, -h        æ˜¾ç¤ºå¸®åŠ©

fn parse_arguments() {
    let config = {
        verbose: false,
        output: "output.txt",
        help: false,
        files: []
    };

    let i = 1;
    while (i < args.length) {
        let arg = args[i];

        if (arg == "--verbose" || arg == "-v") {
            config.verbose = true;
        } else if (arg == "--output" || arg == "-o") {
            i = i + 1;
            if (i < args.length) {
                config.output = args[i];
            } else {
                print("Error: --output requires a value");
            }
        } else if (arg == "--help" || arg == "-h") {
            config.help = true;
        } else if (arg.starts_with("--")) {
            print("Error: Unknown option: " + arg);
        } else {
            config.files.push(arg);
        }

        i = i + 1;
    }

    return config;
}

fn show_help() {
    print("Usage: " + args[0] + " [OPTIONS] <files...>");
    print("Options:");
    print("  --verbose, -v     Enable verbose output");
    print("  --output, -o FILE Set output file");
    print("  --help, -h        Show this help");
}

let config = parse_arguments();

if (config.help) {
    show_help();
} else if (config.files.length == 0) {
    print("Error: No input files specified");
    show_help();
} else {
    if (config.verbose) {
        print("Verbose mode enabled");
        print("Output file: " + config.output);
        print("Input files: " + typeof(config.files.length));
    }

    // å¤„ç†æ–‡ä»¶
    for (let file in config.files) {
        if (config.verbose) {
            print("Processing: " + file);
        }
        // ... å¤„ç†æ–‡ä»¶
    }
}
```

### ç¤ºä¾‹ 4ï¼šé…ç½®å·¥å…·

```hemlock
// ç”¨æ³•: ./hemlock config.hml <action> [arguments]
// æ“ä½œ:
//   get <key>
//   set <key> <value>
//   list

fn show_usage() {
    print("Usage: " + args[0] + " <action> [arguments]");
    print("Actions:");
    print("  get <key>         Get configuration value");
    print("  set <key> <value> Set configuration value");
    print("  list              List all configuration");
}

if (args.length < 2) {
    show_usage();
} else {
    let action = args[1];

    if (action == "get") {
        if (args.length < 3) {
            print("Error: 'get' requires a key");
        } else {
            let key = args[2];
            print("Getting: " + key);
            // ... ä»é…ç½®è·å–
        }
    } else if (action == "set") {
        if (args.length < 4) {
            print("Error: 'set' requires key and value");
        } else {
            let key = args[2];
            let value = args[3];
            print("Setting " + key + " = " + value);
            // ... è®¾ç½®é…ç½®
        }
    } else if (action == "list") {
        print("Listing all configuration:");
        // ... åˆ—å‡ºé…ç½®
    } else {
        print("Error: Unknown action: " + action);
        show_usage();
    }
}
```

## æ€»ç»“

Hemlock çš„å‘½ä»¤è¡Œå‚æ•°æ”¯æŒæä¾›ï¼š

- å…¨å±€å¯ç”¨çš„å†…ç½® `args` æ•°ç»„
- ç®€å•çš„åŸºäºæ•°ç»„çš„å‚æ•°è®¿é—®
- è„šæœ¬åç§°åœ¨ `args[0]`
- æ‰€æœ‰å‚æ•°éƒ½æ˜¯å­—ç¬¦ä¸²
- å¯ç”¨çš„æ•°ç»„æ–¹æ³•ï¼ˆ.lengthã€.slice ç­‰ï¼‰

è¯·è®°ä½ï¼š
- è®¿é—®å…ƒç´ å‰å§‹ç»ˆæ£€æŸ¥ `args.length`
- `args[0]` æ˜¯è„šæœ¬åç§°
- å®é™…å‚æ•°ä» `args[1]` å¼€å§‹
- æ‰€æœ‰å‚æ•°éƒ½æ˜¯å­—ç¬¦ä¸² - æ ¹æ®éœ€è¦è½¬æ¢
- ä¸ºç”¨æˆ·å‹å¥½çš„å·¥å…·æä¾›ç”¨æ³•ä¿¡æ¯
- å¤„ç†å‰éªŒè¯å‚æ•°

å¸¸è§æ¨¡å¼ï¼š
- ç®€å•ä½ç½®å‚æ•°
- å‘½å/æ ‡å¿—å‚æ•°ï¼ˆ--flagï¼‰
- å€¼å‚æ•°ï¼ˆ--option valueï¼‰
- å¸®åŠ©ä¿¡æ¯ï¼ˆ--helpï¼‰
- å‚æ•°éªŒè¯


--------------------------------------------------------------------------------
## å¼‚æ­¥ä¸å¹¶å‘
--------------------------------------------------------------------------------

# Hemlock å¼‚æ­¥/å¹¶å‘ç¼–ç¨‹

Hemlock æä¾›**ç»“æ„åŒ–å¹¶å‘**ï¼Œæ”¯æŒ async/await è¯­æ³•ã€ä»»åŠ¡ç”Ÿæˆå’Œé€šé“é€šä¿¡ã€‚å®ç°åŸºäº POSIX çº¿ç¨‹ï¼ˆpthreadsï¼‰ï¼Œå®ç°**çœŸæ­£çš„å¤šçº¿ç¨‹å¹¶è¡Œ**ã€‚

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [çº¿ç¨‹æ¨¡å‹](#çº¿ç¨‹æ¨¡å‹)
- [å¼‚æ­¥å‡½æ•°](#å¼‚æ­¥å‡½æ•°)
- [ä»»åŠ¡ç”Ÿæˆ](#ä»»åŠ¡ç”Ÿæˆ)
- [é€šé“](#é€šé“)
- [å¼‚å¸¸ä¼ æ’­](#å¼‚å¸¸ä¼ æ’­)
- [å®ç°ç»†èŠ‚](#å®ç°ç»†èŠ‚)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [æ€§èƒ½ç‰¹æ€§](#æ€§èƒ½ç‰¹æ€§)
- [å½“å‰é™åˆ¶](#å½“å‰é™åˆ¶)

## æ¦‚è¿°

**è¿™æ„å‘³ç€ï¼š**
- çœŸæ­£çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ - æ¯ä¸ªç”Ÿæˆçš„ä»»åŠ¡è¿è¡Œåœ¨ç‹¬ç«‹çš„ pthreadï¼ˆPOSIX çº¿ç¨‹ï¼‰ä¸Š
- çœŸæ­£çš„å¹¶è¡Œ - ä»»åŠ¡åœ¨å¤šä¸ª CPU æ ¸å¿ƒä¸ŠåŒæ—¶æ‰§è¡Œ
- å†…æ ¸è°ƒåº¦ - æ“ä½œç³»ç»Ÿè°ƒåº¦å™¨å°†ä»»åŠ¡åˆ†é…åˆ°å¯ç”¨çš„æ ¸å¿ƒä¸Š
- çº¿ç¨‹å®‰å…¨çš„é€šé“ - ä½¿ç”¨ pthread äº’æ–¥é”å’Œæ¡ä»¶å˜é‡è¿›è¡ŒåŒæ­¥

**è¿™ä¸æ˜¯ï¼š**
- ä¸æ˜¯ç»¿è‰²çº¿ç¨‹ - ä¸æ˜¯ç”¨æˆ·ç©ºé—´çš„åä½œå¼å¤šä»»åŠ¡
- ä¸æ˜¯ async/await åç¨‹ - ä¸æ˜¯åƒ JavaScript/Python asyncio é‚£æ ·çš„å•çº¿ç¨‹äº‹ä»¶å¾ªç¯
- ä¸æ˜¯æ¨¡æ‹Ÿå¹¶å‘ - ä¸æ˜¯æ¨¡æ‹Ÿçš„å¹¶è¡Œ

è¿™ä¸ **Cã€C++ å’Œ Rust** ä½¿ç”¨æ“ä½œç³»ç»Ÿçº¿ç¨‹æ—¶çš„**çº¿ç¨‹æ¨¡å‹ç›¸åŒ**ã€‚ä½ å¯ä»¥è·å¾—è·¨å¤šä¸ªæ ¸å¿ƒçš„çœŸæ­£å¹¶è¡Œæ‰§è¡Œã€‚

## çº¿ç¨‹æ¨¡å‹

### 1:1 çº¿ç¨‹æ¨¡å‹

Hemlock ä½¿ç”¨ **1:1 çº¿ç¨‹æ¨¡å‹**ï¼Œå…¶ä¸­ï¼š
- æ¯ä¸ªç”Ÿæˆçš„ä»»åŠ¡é€šè¿‡ `pthread_create()` åˆ›å»ºä¸“ç”¨çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹
- æ“ä½œç³»ç»Ÿå†…æ ¸åœ¨å¯ç”¨çš„ CPU æ ¸å¿ƒé—´è°ƒåº¦çº¿ç¨‹
- æŠ¢å å¼å¤šä»»åŠ¡ - æ“ä½œç³»ç»Ÿå¯ä»¥ä¸­æ–­å¹¶åœ¨çº¿ç¨‹ä¹‹é—´åˆ‡æ¢
- **æ—  GIL** - ä¸åƒ Pythonï¼Œæ²¡æœ‰å…¨å±€è§£é‡Šå™¨é”é™åˆ¶å¹¶è¡Œæ€§

### åŒæ­¥æœºåˆ¶

- **äº’æ–¥é”** - é€šé“ä½¿ç”¨ `pthread_mutex_t` å®ç°çº¿ç¨‹å®‰å…¨è®¿é—®
- **æ¡ä»¶å˜é‡** - é˜»å¡çš„å‘é€/æ¥æ”¶ä½¿ç”¨ `pthread_cond_t` å®ç°é«˜æ•ˆç­‰å¾…
- **æ— é”æ“ä½œ** - ä»»åŠ¡çŠ¶æ€è½¬æ¢æ˜¯åŸå­çš„

## å¼‚æ­¥å‡½æ•°

å‡½æ•°å¯ä»¥å£°æ˜ä¸º `async`ï¼Œè¡¨ç¤ºå®ƒä»¬è®¾è®¡ç”¨äºå¹¶å‘æ‰§è¡Œï¼š

```hemlock
async fn compute(n: i32): i32 {
    let sum = 0;
    let i = 0;
    while (i < n) {
        sum = sum + i;
        i = i + 1;
    }
    return sum;
}
```

### è¦ç‚¹

- `async fn` å£°æ˜å¼‚æ­¥å‡½æ•°
- å¼‚æ­¥å‡½æ•°å¯ä»¥ä½¿ç”¨ `spawn()` ä½œä¸ºå¹¶å‘ä»»åŠ¡ç”Ÿæˆ
- å¼‚æ­¥å‡½æ•°ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ï¼ˆåœ¨å½“å‰çº¿ç¨‹åŒæ­¥è¿è¡Œï¼‰
- ç”Ÿæˆæ—¶ï¼Œæ¯ä¸ªä»»åŠ¡è¿è¡Œåœ¨**è‡ªå·±çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹**ä¸Šï¼ˆä¸æ˜¯åç¨‹ï¼ï¼‰
- `await` å…³é”®å­—ä¿ç•™ä¾›å°†æ¥ä½¿ç”¨

### ç¤ºä¾‹ï¼šç›´æ¥è°ƒç”¨ vs ç”Ÿæˆ

```hemlock
async fn factorial(n: i32): i32 {
    if (n <= 1) { return 1; }
    return n * factorial(n - 1);
}

// ç›´æ¥è°ƒç”¨ - åŒæ­¥è¿è¡Œ
let result1 = factorial(5);  // 120

// ç”Ÿæˆä»»åŠ¡ - åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸Šè¿è¡Œ
let task = spawn(factorial, 5);
let result2 = join(task);  // 120
```

## ä»»åŠ¡ç”Ÿæˆ

ä½¿ç”¨ `spawn()` åœ¨**ç‹¬ç«‹çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šå¹¶è¡Œ**è¿è¡Œå¼‚æ­¥å‡½æ•°ï¼š

```hemlock
async fn factorial(n: i32): i32 {
    if (n <= 1) { return 1; }
    return n * factorial(n - 1);
}

// ç”Ÿæˆå¤šä¸ªä»»åŠ¡ - è¿™äº›åœ¨ä¸åŒçš„ CPU æ ¸å¿ƒä¸Šå¹¶è¡Œè¿è¡Œï¼
let t1 = spawn(factorial, 5);  // çº¿ç¨‹ 1
let t2 = spawn(factorial, 6);  // çº¿ç¨‹ 2
let t3 = spawn(factorial, 7);  // çº¿ç¨‹ 3

// ä¸‰ä¸ªä»»åŠ¡ç°åœ¨æ­£åœ¨åŒæ—¶è®¡ç®—ï¼

// ç­‰å¾…ç»“æœ
let f5 = join(t1);  // 120
let f6 = join(t2);  // 720
let f7 = join(t3);  // 5040
```

### å†…ç½®å‡½æ•°

#### spawn(async_fn, arg1, arg2, ...)

åœ¨æ–°çš„ pthread ä¸Šåˆ›å»ºæ–°ä»»åŠ¡ï¼Œè¿”å›ä»»åŠ¡å¥æŸ„ã€‚

**å‚æ•°ï¼š**
- `async_fn` - è¦æ‰§è¡Œçš„å¼‚æ­¥å‡½æ•°
- `arg1, arg2, ...` - ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°

**è¿”å›ï¼š** ä»»åŠ¡å¥æŸ„ï¼ˆä¸ `join()` æˆ– `detach()` ä¸€èµ·ä½¿ç”¨çš„ä¸é€æ˜å€¼ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
async fn process(data: string, count: i32): i32 {
    // ... å¤„ç†é€»è¾‘
    return count * 2;
}

let task = spawn(process, "test", 42);
```

#### join(task)

ç­‰å¾…ä»»åŠ¡å®Œæˆï¼ˆé˜»å¡ç›´åˆ°çº¿ç¨‹ç»“æŸï¼‰ï¼Œè¿”å›ç»“æœã€‚

**å‚æ•°ï¼š**
- `task` - ä» `spawn()` è¿”å›çš„ä»»åŠ¡å¥æŸ„

**è¿”å›ï¼š** å¼‚æ­¥å‡½æ•°è¿”å›çš„å€¼

**ç¤ºä¾‹ï¼š**
```hemlock
let task = spawn(compute, 1000);
let result = join(task);  // é˜»å¡ç›´åˆ° compute() å®Œæˆ
print(result);
```

**é‡è¦ï¼š** æ¯ä¸ªä»»åŠ¡åªèƒ½ join ä¸€æ¬¡ã€‚åç»­çš„ join å°†ä¼šæŠ¥é”™ã€‚

#### detach(task)

å³å‘å³å¿˜æ‰§è¡Œï¼ˆçº¿ç¨‹ç‹¬ç«‹è¿è¡Œï¼Œä¸å…è®¸ joinï¼‰ã€‚

**å‚æ•°ï¼š**
- `task` - ä» `spawn()` è¿”å›çš„ä»»åŠ¡å¥æŸ„

**è¿”å›ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
async fn background_work() {
    // é•¿æ—¶é—´è¿è¡Œçš„åå°ä»»åŠ¡
    // ...
}

let task = spawn(background_work);
detach(task);  // ä»»åŠ¡ç‹¬ç«‹è¿è¡Œï¼Œæ— æ³• join
```

**é‡è¦ï¼š** åˆ†ç¦»çš„ä»»åŠ¡æ— æ³• joinã€‚å½“ä»»åŠ¡å®Œæˆæ—¶ï¼Œpthread å’Œ Task ç»“æ„éƒ½ä¼šè‡ªåŠ¨æ¸…ç†ã€‚

## é€šé“

é€šé“ä½¿ç”¨æœ‰ç•Œç¼“å†²åŒºå’Œé˜»å¡è¯­ä¹‰ï¼Œæä¾›ä»»åŠ¡é—´çš„çº¿ç¨‹å®‰å…¨é€šä¿¡ã€‚

### åˆ›å»ºé€šé“

```hemlock
let ch = channel(10);  // åˆ›å»ºç¼“å†²åŒºå¤§å°ä¸º 10 çš„é€šé“
```

**å‚æ•°ï¼š**
- `capacity` (i32) - é€šé“å¯å®¹çº³çš„æœ€å¤§å€¼æ•°é‡

**è¿”å›ï¼š** é€šé“å¯¹è±¡

### é€šé“æ–¹æ³•

#### send(value)

å‘é€šé“å‘é€å€¼ï¼ˆå¦‚æœå·²æ»¡åˆ™é˜»å¡ï¼‰ã€‚

```hemlock
async fn producer(ch, count: i32) {
    let i = 0;
    while (i < count) {
        ch.send(i * 10);
        i = i + 1;
    }
    ch.close();
    return null;
}

let ch = channel(10);
let task = spawn(producer, ch, 5);
```

**è¡Œä¸ºï¼š**
- å¦‚æœé€šé“æœ‰ç©ºé—´ï¼Œå€¼ä¼šç«‹å³æ·»åŠ 
- å¦‚æœé€šé“å·²æ»¡ï¼Œå‘é€è€…é˜»å¡ç›´åˆ°æœ‰ç©ºé—´å¯ç”¨
- å¦‚æœé€šé“å·²å…³é—­ï¼ŒæŠ›å‡ºå¼‚å¸¸

#### recv()

ä»é€šé“æ¥æ”¶å€¼ï¼ˆå¦‚æœä¸ºç©ºåˆ™é˜»å¡ï¼‰ã€‚

```hemlock
async fn consumer(ch, count: i32): i32 {
    let sum = 0;
    let i = 0;
    while (i < count) {
        let val = ch.recv();
        sum = sum + val;
        i = i + 1;
    }
    return sum;
}

let ch = channel(10);
let task = spawn(consumer, ch, 5);
```

**è¡Œä¸ºï¼š**
- å¦‚æœé€šé“æœ‰å€¼ï¼Œç«‹å³è¿”å›ä¸‹ä¸€ä¸ªå€¼
- å¦‚æœé€šé“ä¸ºç©ºï¼Œæ¥æ”¶è€…é˜»å¡ç›´åˆ°æœ‰å€¼å¯ç”¨
- å¦‚æœé€šé“å·²å…³é—­ä¸”ä¸ºç©ºï¼Œè¿”å› `null`

#### close()

å…³é—­é€šé“ï¼ˆåœ¨å·²å…³é—­çš„é€šé“ä¸Š recv è¿”å› nullï¼‰ã€‚

```hemlock
ch.close();
```

**è¡Œä¸ºï¼š**
- é˜»æ­¢è¿›ä¸€æ­¥çš„ `send()` æ“ä½œï¼ˆå°†æŠ›å‡ºå¼‚å¸¸ï¼‰
- å…è®¸æŒ‚èµ·çš„ `recv()` æ“ä½œå®Œæˆ
- ä¸€æ—¦ä¸ºç©ºï¼Œ`recv()` è¿”å› `null`

### ä½¿ç”¨ select() å¤šè·¯å¤ç”¨

`select()` å‡½æ•°å…è®¸åŒæ—¶ç­‰å¾…å¤šä¸ªé€šé“ï¼Œå½“ä»»ä½•é€šé“æœ‰æ•°æ®å¯ç”¨æ—¶è¿”å›ã€‚

**ç­¾åï¼š**
```hemlock
select(channels: array, timeout_ms?: i32): object | null
```

**å‚æ•°ï¼š**
- `channels` - é€šé“å€¼æ•°ç»„
- `timeout_ms`ï¼ˆå¯é€‰ï¼‰- è¶…æ—¶æ¯«ç§’æ•°ï¼ˆ-1 æˆ–çœç•¥è¡¨ç¤ºæ— é™ç­‰å¾…ï¼‰

**è¿”å›ï¼š**
- `{ channel, value }` - åŒ…å«æœ‰æ•°æ®çš„é€šé“å’Œæ¥æ”¶åˆ°çš„å€¼çš„å¯¹è±¡
- `null` - è¶…æ—¶æ—¶ï¼ˆå¦‚æœæŒ‡å®šäº†è¶…æ—¶ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let ch1 = channel(1);
let ch2 = channel(1);

// ç”Ÿäº§è€…ä»»åŠ¡
spawn(fn() {
    sleep(100);
    ch1.send("from channel 1");
});

spawn(fn() {
    sleep(50);
    ch2.send("from channel 2");
});

// ç­‰å¾…ç¬¬ä¸€ä¸ªç»“æœï¼ˆch2 åº”è¯¥æ›´å¿«ï¼‰
let result = select([ch1, ch2]);
print(result.value);  // "from channel 2"

// ç­‰å¾…ç¬¬äºŒä¸ªç»“æœ
let result2 = select([ch1, ch2]);
print(result2.value);  // "from channel 1"
```

**å¸¦è¶…æ—¶ï¼š**
```hemlock
let ch = channel(1);

// æ²¡æœ‰å‘é€è€…ï¼Œå°†è¶…æ—¶
let result = select([ch], 100);  // 100ms è¶…æ—¶
if (result == null) {
    print("Timed out!");
}
```

**ä½¿ç”¨åœºæ™¯ï¼š**
- ç­‰å¾…å¤šä¸ªæ•°æ®æºä¸­æœ€å¿«çš„ä¸€ä¸ª
- åœ¨é€šé“æ“ä½œä¸Šå®ç°è¶…æ—¶
- å…·æœ‰å¤šä¸ªäº‹ä»¶æºçš„äº‹ä»¶å¾ªç¯æ¨¡å¼
- æ‰‡å…¥ï¼šå°†å¤šä¸ªé€šé“åˆå¹¶ä¸ºä¸€ä¸ª

**æ‰‡å…¥æ¨¡å¼ï¼š**
```hemlock
fn fan_in(channels: array, output: channel) {
    while (true) {
        let result = select(channels);
        if (result == null) {
            break;  // æ‰€æœ‰é€šé“å·²å…³é—­
        }
        output.send(result.value);
    }
    output.close();
}
```

### å®Œæ•´çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…ç¤ºä¾‹

```hemlock
async fn producer(ch, count: i32) {
    let i = 0;
    while (i < count) {
        ch.send(i * 10);
        i = i + 1;
    }
    ch.close();
    return null;
}

async fn consumer(ch, count: i32): i32 {
    let sum = 0;
    let i = 0;
    while (i < count) {
        let val = ch.recv();
        sum = sum + val;
        i = i + 1;
    }
    return sum;
}

// åˆ›å»ºå¸¦ç¼“å†²åŒºå¤§å°çš„é€šé“
let ch = channel(10);

// ç”Ÿæˆç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
let p = spawn(producer, ch, 5);
let c = spawn(consumer, ch, 5);

// ç­‰å¾…å®Œæˆ
join(p);
let total = join(c);  // 100 (0+10+20+30+40)
print(total);
```

### å¤šç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…

é€šé“å¯ä»¥åœ¨å¤šä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´å®‰å…¨å…±äº«ï¼š

```hemlock
async fn producer(id: i32, ch, count: i32) {
    let i = 0;
    while (i < count) {
        ch.send(id * 100 + i);
        i = i + 1;
    }
}

async fn consumer(id: i32, ch, count: i32): i32 {
    let sum = 0;
    let i = 0;
    while (i < count) {
        let val = ch.recv();
        sum = sum + val;
        i = i + 1;
    }
    return sum;
}

let ch = channel(20);

// å¤šä¸ªç”Ÿäº§è€…
let p1 = spawn(producer, 1, ch, 5);
let p2 = spawn(producer, 2, ch, 5);

// å¤šä¸ªæ¶ˆè´¹è€…
let c1 = spawn(consumer, 1, ch, 5);
let c2 = spawn(consumer, 2, ch, 5);

// ç­‰å¾…æ‰€æœ‰
join(p1);
join(p2);
let sum1 = join(c1);
let sum2 = join(c2);
print(sum1 + sum2);
```

## å¼‚å¸¸ä¼ æ’­

åœ¨ç”Ÿæˆçš„ä»»åŠ¡ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¼šåœ¨ join æ—¶ä¼ æ’­ï¼š

```hemlock
async fn risky_operation(should_fail: i32): i32 {
    if (should_fail == 1) {
        throw "Task failed!";
    }
    return 42;
}

let t = spawn(risky_operation, 1);
try {
    let result = join(t);
} catch (e) {
    print("Caught: " + e);  // "Caught: Task failed!"
}
```

### å¼‚å¸¸å¤„ç†æ¨¡å¼

**æ¨¡å¼ 1ï¼šåœ¨ä»»åŠ¡ä¸­å¤„ç†**
```hemlock
async fn safe_task() {
    try {
        // æœ‰é£é™©çš„æ“ä½œ
    } catch (e) {
        print("Error in task: " + e);
        return null;
    }
}

let task = spawn(safe_task);
join(task);  // æ²¡æœ‰å¼‚å¸¸ä¼ æ’­
```

**æ¨¡å¼ 2ï¼šä¼ æ’­ç»™è°ƒç”¨è€…**
```hemlock
async fn task_that_throws() {
    throw "error";
}

let task = spawn(task_that_throws);
try {
    join(task);
} catch (e) {
    print("Caught from task: " + e);
}
```

**æ¨¡å¼ 3ï¼šå¸¦å¼‚å¸¸çš„åˆ†ç¦»ä»»åŠ¡**
```hemlock
async fn detached_task() {
    try {
        // å·¥ä½œ
    } catch (e) {
        // å¿…é¡»åœ¨å†…éƒ¨å¤„ç† - æ— æ³•ä¼ æ’­
        print("Error: " + e);
    }
}

let task = spawn(detached_task);
detach(task);  // æ— æ³•ä»åˆ†ç¦»çš„ä»»åŠ¡æ•è·å¼‚å¸¸
```

## å®ç°ç»†èŠ‚

### çº¿ç¨‹æ¶æ„

- **1:1 çº¿ç¨‹** - æ¯ä¸ªç”Ÿæˆçš„ä»»åŠ¡é€šè¿‡ `pthread_create()` åˆ›å»ºä¸“ç”¨çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹
- **å†…æ ¸è°ƒåº¦** - æ“ä½œç³»ç»Ÿå†…æ ¸åœ¨å¯ç”¨çš„ CPU æ ¸å¿ƒé—´è°ƒåº¦çº¿ç¨‹
- **æŠ¢å å¼å¤šä»»åŠ¡** - æ“ä½œç³»ç»Ÿå¯ä»¥ä¸­æ–­å¹¶åœ¨çº¿ç¨‹ä¹‹é—´åˆ‡æ¢
- **æ—  GIL** - ä¸åƒ Pythonï¼Œæ²¡æœ‰å…¨å±€è§£é‡Šå™¨é”é™åˆ¶å¹¶è¡Œæ€§

### é€šé“å®ç°

é€šé“ä½¿ç”¨å¸¦ pthread åŒæ­¥çš„å¾ªç¯ç¼“å†²åŒºï¼š

```
é€šé“ç»“æ„ï¼š
- buffer[] - å›ºå®šå¤§å°çš„ Values æ•°ç»„
- capacity - æœ€å¤§å…ƒç´ æ•°
- size - å½“å‰å…ƒç´ æ•°
- head - è¯»å–ä½ç½®
- tail - å†™å…¥ä½ç½®
- mutex - pthread_mutex_t ç”¨äºçº¿ç¨‹å®‰å…¨è®¿é—®
- not_empty - pthread_cond_t ç”¨äºé˜»å¡ recv
- not_full - pthread_cond_t ç”¨äºé˜»å¡ send
- closed - å¸ƒå°”æ ‡å¿—
- refcount - ç”¨äºæ¸…ç†çš„å¼•ç”¨è®¡æ•°
```

**é˜»å¡è¡Œä¸ºï¼š**
- åœ¨æ»¡é€šé“ä¸Š `send()`ï¼šç­‰å¾… `not_full` æ¡ä»¶å˜é‡
- åœ¨ç©ºé€šé“ä¸Š `recv()`ï¼šç­‰å¾… `not_empty` æ¡ä»¶å˜é‡
- ä¸¤è€…éƒ½ç”±ç›¸åçš„æ“ä½œåœ¨é€‚å½“æ—¶å‘å‡ºä¿¡å·

### å†…å­˜å’Œæ¸…ç†

- **å·² join çš„ä»»åŠ¡ï¼š** åœ¨ `join()` è¿”å›åè‡ªåŠ¨æ¸…ç†
- **åˆ†ç¦»çš„ä»»åŠ¡ï¼š** åœ¨ä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨æ¸…ç†
- **é€šé“ï¼š** å¼•ç”¨è®¡æ•°ï¼Œä¸å†ä½¿ç”¨æ—¶é‡Šæ”¾

## æœ€ä½³å®è·µ

### 1. å§‹ç»ˆå…³é—­é€šé“

```hemlock
async fn producer(ch) {
    // ... å‘é€å€¼
    ch.close();  // é‡è¦ï¼šè¡¨ç¤ºæ²¡æœ‰æ›´å¤šçš„å€¼
}
```

### 2. ä½¿ç”¨ç»“æ„åŒ–å¹¶å‘

åœ¨åŒä¸€ä½œç”¨åŸŸä¸­ç”Ÿæˆä»»åŠ¡å¹¶ join å®ƒä»¬ï¼š

```hemlock
fn process_data(data) {
    // ç”Ÿæˆä»»åŠ¡
    let t1 = spawn(worker, data);
    let t2 = spawn(worker, data);

    // è¿”å›å‰å§‹ç»ˆ join
    let r1 = join(t1);
    let r2 = join(t2);

    return r1 + r2;
}
```

### 3. é€‚å½“å¤„ç†å¼‚å¸¸

```hemlock
async fn task() {
    try {
        // æœ‰é£é™©çš„æ“ä½œ
    } catch (e) {
        // è®°å½•é”™è¯¯
        throw e;  // å¦‚æœè°ƒç”¨è€…éœ€è¦çŸ¥é“åˆ™é‡æ–°æŠ›å‡º
    }
}
```

### 4. ä½¿ç”¨é€‚å½“çš„é€šé“å®¹é‡

- **å°å®¹é‡ï¼ˆ1-10ï¼‰ï¼š** ç”¨äºåè°ƒ/ä¿¡å·
- **ä¸­ç­‰å®¹é‡ï¼ˆ10-100ï¼‰ï¼š** ç”¨äºä¸€èˆ¬ç”Ÿäº§è€…-æ¶ˆè´¹è€…
- **å¤§å®¹é‡ï¼ˆ100+ï¼‰ï¼š** ç”¨äºé«˜ååé‡åœºæ™¯

```hemlock
let signal_ch = channel(1);      // åè°ƒ
let work_ch = channel(50);       // å·¥ä½œé˜Ÿåˆ—
let buffer_ch = channel(1000);   // é«˜ååé‡
```

### 5. ä»…åœ¨å¿…è¦æ—¶åˆ†ç¦»

ä¼˜å…ˆä½¿ç”¨ `join()` è€Œä¸æ˜¯ `detach()` ä»¥æ›´å¥½åœ°ç®¡ç†èµ„æºï¼š

```hemlock
// å¥½ï¼šJoin å¹¶è·å–ç»“æœ
let task = spawn(work);
let result = join(task);

// ä»…å¯¹çœŸæ­£çš„å³å‘å³å¿˜ä½¿ç”¨ detach
let bg_task = spawn(background_logging);
detach(bg_task);  // å°†ç‹¬ç«‹è¿è¡Œ
```

## æ€§èƒ½ç‰¹æ€§

### çœŸæ­£çš„å¹¶è¡Œ

- **N ä¸ªç”Ÿæˆçš„ä»»åŠ¡å¯ä»¥åŒæ—¶åˆ©ç”¨ N ä¸ª CPU æ ¸å¿ƒ**
- ç»éªŒè¯çš„åŠ é€Ÿ - å‹åŠ›æµ‹è¯•æ˜¾ç¤º CPU æ—¶é—´ vs å¢™é’Ÿæ—¶é—´ä¸º 8-9 å€ï¼ˆå¤šæ ¸å·¥ä½œï¼‰
- éšæ ¸å¿ƒæ•°çº¿æ€§æ‰©å±•ï¼ˆç›´åˆ°çº¿ç¨‹æ•°ï¼‰

### çº¿ç¨‹å¼€é”€

- æ¯ä¸ªä»»åŠ¡æœ‰çº¦ 8KB æ ˆ + pthread å¼€é”€
- çº¿ç¨‹åˆ›å»ºæˆæœ¬ï¼šçº¦ 10-20 å¾®ç§’
- ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ï¼šçº¦ 1-5 å¾®ç§’

### ä½•æ—¶ä½¿ç”¨å¼‚æ­¥

**å¥½çš„ä½¿ç”¨åœºæ™¯ï¼š**
- å¯å¹¶è¡ŒåŒ–çš„ CPU å¯†é›†å‹è®¡ç®—
- I/O å¯†é›†å‹æ“ä½œï¼ˆå°½ç®¡ I/O ä»ç„¶æ˜¯é˜»å¡çš„ï¼‰
- ç‹¬ç«‹æ•°æ®çš„å¹¶å‘å¤„ç†
- ä½¿ç”¨é€šé“çš„æµæ°´çº¿æ¶æ„

**ä¸ç†æƒ³çš„åœºæ™¯ï¼š**
- éå¸¸çŸ­çš„ä»»åŠ¡ï¼ˆçº¿ç¨‹å¼€é”€å ä¸»å¯¼ï¼‰
- æœ‰å¤§é‡åŒæ­¥çš„ä»»åŠ¡ï¼ˆç«äº‰å¼€é”€ï¼‰
- å•æ ¸ç³»ç»Ÿï¼ˆæ²¡æœ‰å¹¶è¡Œæ€§æ”¶ç›Šï¼‰

### é˜»å¡ I/O å®‰å…¨

ä¸€ä¸ªä»»åŠ¡ä¸­çš„é˜»å¡æ“ä½œä¸ä¼šé˜»å¡å…¶ä»–ä»»åŠ¡ï¼š

```hemlock
async fn reader(filename: string) {
    let f = open(filename, "r");  // åªé˜»å¡æ­¤çº¿ç¨‹
    let content = f.read();       // åªé˜»å¡æ­¤çº¿ç¨‹
    f.close();
    return content;
}

// ä¸¤è€…å¹¶å‘è¯»å–ï¼ˆåœ¨ä¸åŒçº¿ç¨‹ä¸Šï¼‰
let t1 = spawn(reader, "file1.txt");
let t2 = spawn(reader, "file2.txt");

let c1 = join(t1);
let c2 = join(t2);
```

## çº¿ç¨‹å®‰å…¨æ¨¡å‹

Hemlock ä½¿ç”¨**æ¶ˆæ¯ä¼ é€’**å¹¶å‘æ¨¡å‹ï¼Œä»»åŠ¡é€šè¿‡é€šé“è€Œä¸æ˜¯å…±äº«å¯å˜çŠ¶æ€è¿›è¡Œé€šä¿¡ã€‚

### å‚æ•°éš”ç¦»

å½“ä½ ç”Ÿæˆä»»åŠ¡æ—¶ï¼Œ**å‚æ•°ä¼šæ·±æ‹·è´**ä»¥é˜²æ­¢æ•°æ®ç«äº‰ï¼š

```hemlock
async fn modify_array(arr: array): array {
    arr.push(999);    // ä¿®æ”¹çš„æ˜¯å‰¯æœ¬ï¼Œä¸æ˜¯åŸå§‹æ•°ç»„
    arr[0] = -1;
    return arr;
}

let original = [1, 2, 3];
let task = spawn(modify_array, original);
let modified = join(task);

print(original.length);  // 3 - æœªæ”¹å˜ï¼
print(modified.length);  // 4 - æœ‰æ–°å…ƒç´ 
```

**ä¼šæ·±æ‹·è´çš„ï¼š**
- æ•°ç»„ï¼ˆåŠæ‰€æœ‰å…ƒç´ é€’å½’ï¼‰
- å¯¹è±¡ï¼ˆåŠæ‰€æœ‰å­—æ®µé€’å½’ï¼‰
- å­—ç¬¦ä¸²
- ç¼“å†²åŒº

**ä¼šå…±äº«çš„ï¼ˆä¿ç•™å¼•ç”¨ï¼‰ï¼š**
- é€šé“ï¼ˆé€šä¿¡æœºåˆ¶ - æ•…æ„å…±äº«ï¼‰
- ä»»åŠ¡å¥æŸ„ï¼ˆç”¨äºåè°ƒï¼‰
- å‡½æ•°ï¼ˆä»£ç æ˜¯ä¸å¯å˜çš„ï¼‰
- æ–‡ä»¶å¥æŸ„ï¼ˆæ“ä½œç³»ç»Ÿç®¡ç†å¹¶å‘è®¿é—®ï¼‰
- å¥—æ¥å­—å¥æŸ„ï¼ˆæ“ä½œç³»ç»Ÿç®¡ç†å¹¶å‘è®¿é—®ï¼‰

**ä¸èƒ½ä¼ é€’çš„ï¼š**
- åŸå§‹æŒ‡é’ˆï¼ˆ`ptr`ï¼‰- æ”¹ç”¨ `buffer`

### ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯ä¼ é€’ï¼Ÿ

è¿™éµå¾ª Hemlock çš„"æ˜¾å¼ä¼˜äºéšå¼"å“²å­¦ï¼š

```hemlock
// ä¸å¥½ï¼šå…±äº«å¯å˜çŠ¶æ€ï¼ˆä¼šå¯¼è‡´æ•°æ®ç«äº‰ï¼‰
let counter = { value: 0 };
let t1 = spawn(fn() { counter.value = counter.value + 1; });  // ç«äº‰ï¼
let t2 = spawn(fn() { counter.value = counter.value + 1; });  // ç«äº‰ï¼

// å¥½ï¼šé€šè¿‡é€šé“çš„æ¶ˆæ¯ä¼ é€’
async fn increment(ch) {
    let val = ch.recv();
    ch.send(val + 1);
}

let ch = channel(1);
ch.send(0);
let t1 = spawn(increment, ch);
join(t1);
let result = ch.recv();  // 1 - æ²¡æœ‰ç«äº‰æ¡ä»¶
```

### å¼•ç”¨è®¡æ•°çº¿ç¨‹å®‰å…¨

æ‰€æœ‰å¼•ç”¨è®¡æ•°æ“ä½œä½¿ç”¨**åŸå­æ“ä½œ**ä»¥é˜²æ­¢é‡Šæ”¾åä½¿ç”¨é”™è¯¯ï¼š
- `string_retain/release` - åŸå­
- `array_retain/release` - åŸå­
- `object_retain/release` - åŸå­
- `buffer_retain/release` - åŸå­
- `function_retain/release` - åŸå­
- `channel_retain/release` - åŸå­
- `task_retain/release` - åŸå­

è¿™ç¡®ä¿å³ä½¿å€¼è·¨çº¿ç¨‹å…±äº«ä¹Ÿèƒ½å®‰å…¨åœ°è¿›è¡Œå†…å­˜ç®¡ç†ã€‚

### é—­åŒ…ç¯å¢ƒè®¿é—®

ä»»åŠ¡å¯ä»¥è®¿é—®é—­åŒ…ç¯å¢ƒï¼š
- å†…ç½®å‡½æ•°ï¼ˆ`print`ã€`len` ç­‰ï¼‰
- å…¨å±€å‡½æ•°å®šä¹‰
- å¸¸é‡å’Œå˜é‡

é—­åŒ…ç¯å¢ƒç”±æ¯ä¸ªç¯å¢ƒçš„äº’æ–¥é”ä¿æŠ¤ï¼Œä½¿å¹¶å‘è¯»å†™çº¿ç¨‹å®‰å…¨ï¼š

```hemlock
let x = 10;

async fn read_closure(): i32 {
    return x;  // OKï¼šè¯»å–é—­åŒ…å˜é‡ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
}

async fn modify_closure() {
    x = 20;  // OKï¼šå†™å…¥é—­åŒ…å˜é‡ï¼ˆä¸äº’æ–¥é”åŒæ­¥ï¼‰
}
```

**æ³¨æ„ï¼š** è™½ç„¶å¹¶å‘è®¿é—®æ˜¯åŒæ­¥çš„ï¼Œä½†ä»å¤šä¸ªä»»åŠ¡ä¿®æ”¹å…±äº«çŠ¶æ€ä»å¯èƒ½å¯¼è‡´é€»è¾‘ç«äº‰æ¡ä»¶ï¼ˆéç¡®å®šæ€§é¡ºåºï¼‰ã€‚ä¸ºäº†å¯é¢„æµ‹çš„è¡Œä¸ºï¼Œä½¿ç”¨é€šé“è¿›è¡Œä»»åŠ¡é€šä¿¡æˆ–ä½¿ç”¨ä»»åŠ¡è¿”å›å€¼ã€‚

å¦‚æœéœ€è¦ä»ä»»åŠ¡è¿”å›æ•°æ®ï¼Œä½¿ç”¨è¿”å›å€¼æˆ–é€šé“ã€‚

## å½“å‰é™åˆ¶

### 1. æ²¡æœ‰å·¥ä½œçªƒå–è°ƒåº¦å™¨

æ¯ä¸ªä»»åŠ¡ä½¿ç”¨ 1 ä¸ªçº¿ç¨‹ï¼Œå¯¹äºè®¸å¤šçŸ­ä»»åŠ¡å¯èƒ½æ•ˆç‡ä¸é«˜ã€‚

**å½“å‰ï¼š** 1000 ä¸ªä»»åŠ¡ = 1000 ä¸ªçº¿ç¨‹ï¼ˆå¼€é”€å¤§ï¼‰

**è®¡åˆ’ä¸­ï¼š** å¸¦å·¥ä½œçªƒå–çš„çº¿ç¨‹æ± ä»¥æé«˜æ•ˆç‡

### 3. æ²¡æœ‰å¼‚æ­¥ I/O é›†æˆ

æ–‡ä»¶/ç½‘ç»œæ“ä½œä»ç„¶é˜»å¡çº¿ç¨‹ï¼š

```hemlock
async fn read_file(path: string) {
    let f = open(path, "r");
    let content = f.read();  // é˜»å¡çº¿ç¨‹
    f.close();
    return content;
}
```

**å˜é€šæ–¹æ³•ï¼š** ä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œå¹¶å‘ I/O æ“ä½œ

### 4. å›ºå®šé€šé“å®¹é‡

é€šé“å®¹é‡åœ¨åˆ›å»ºæ—¶è®¾ç½®ï¼Œæ— æ³•è°ƒæ•´å¤§å°ï¼š

```hemlock
let ch = channel(10);
// æ— æ³•åŠ¨æ€è°ƒæ•´åˆ° 20
```

### 5. é€šé“å¤§å°å›ºå®š

é€šé“ç¼“å†²åŒºå¤§å°åœ¨åˆ›å»ºåæ— æ³•æ›´æ”¹ã€‚

## å¸¸è§æ¨¡å¼

### å¹¶è¡Œ Map

```hemlock
async fn map_worker(ch_in, ch_out, fn_transform) {
    while (true) {
        let val = ch_in.recv();
        if (val == null) { break; }

        let result = fn_transform(val);
        ch_out.send(result);
    }
    ch_out.close();
}

fn parallel_map(data, fn_transform, workers: i32) {
    let ch_in = channel(100);
    let ch_out = channel(100);

    // ç”Ÿæˆå·¥ä½œè€…
    let tasks = [];
    let i = 0;
    while (i < workers) {
        tasks.push(spawn(map_worker, ch_in, ch_out, fn_transform));
        i = i + 1;
    }

    // å‘é€æ•°æ®
    let i = 0;
    while (i < data.length) {
        ch_in.send(data[i]);
        i = i + 1;
    }
    ch_in.close();

    // æ”¶é›†ç»“æœ
    let results = [];
    let i = 0;
    while (i < data.length) {
        results.push(ch_out.recv());
        i = i + 1;
    }

    // ç­‰å¾…å·¥ä½œè€…
    let i = 0;
    while (i < tasks.length) {
        join(tasks[i]);
        i = i + 1;
    }

    return results;
}
```

### æµæ°´çº¿æ¶æ„

```hemlock
async fn stage1(input_ch, output_ch) {
    while (true) {
        let val = input_ch.recv();
        if (val == null) { break; }
        output_ch.send(val * 2);
    }
    output_ch.close();
}

async fn stage2(input_ch, output_ch) {
    while (true) {
        let val = input_ch.recv();
        if (val == null) { break; }
        output_ch.send(val + 10);
    }
    output_ch.close();
}

// åˆ›å»ºæµæ°´çº¿
let ch1 = channel(10);
let ch2 = channel(10);
let ch3 = channel(10);

let s1 = spawn(stage1, ch1, ch2);
let s2 = spawn(stage2, ch2, ch3);

// è¾“å…¥æ•°æ®
ch1.send(1);
ch1.send(2);
ch1.send(3);
ch1.close();

// æ”¶é›†è¾“å‡º
print(ch3.recv());  // 12 (1 * 2 + 10)
print(ch3.recv());  // 14 (2 * 2 + 10)
print(ch3.recv());  // 16 (3 * 2 + 10)

join(s1);
join(s2);
```

### æ‰‡å‡ºï¼Œæ‰‡å…¥

```hemlock
async fn worker(id: i32, input_ch, output_ch) {
    while (true) {
        let val = input_ch.recv();
        if (val == null) { break; }

        // å¤„ç†å€¼
        let result = val * id;
        output_ch.send(result);
    }
}

let input = channel(10);
let output = channel(10);

// æ‰‡å‡ºï¼šå¤šä¸ªå·¥ä½œè€…
let workers = 4;
let tasks = [];
let i = 0;
while (i < workers) {
    tasks.push(spawn(worker, i, input, output));
    i = i + 1;
}

// å‘é€å·¥ä½œ
let i = 0;
while (i < 10) {
    input.send(i);
    i = i + 1;
}
input.close();

// æ‰‡å…¥ï¼šæ”¶é›†æ‰€æœ‰ç»“æœ
let results = [];
let i = 0;
while (i < 10) {
    results.push(output.recv());
    i = i + 1;
}

// ç­‰å¾…æ‰€æœ‰å·¥ä½œè€…
let i = 0;
while (i < tasks.length) {
    join(tasks[i]);
    i = i + 1;
}
```

## æ€»ç»“

Hemlock çš„å¼‚æ­¥/å¹¶å‘æ¨¡å‹æä¾›ï¼š

- ä½¿ç”¨æ“ä½œç³»ç»Ÿçº¿ç¨‹çš„çœŸæ­£å¤šçº¿ç¨‹å¹¶è¡Œ
- ç®€å•çš„ç»“æ„åŒ–å¹¶å‘åŸè¯­
- çº¿ç¨‹å®‰å…¨çš„é€šé“é€šä¿¡
- è·¨ä»»åŠ¡çš„å¼‚å¸¸ä¼ æ’­
- åœ¨å¤šæ ¸ç³»ç»Ÿä¸Šç»éªŒè¯çš„æ€§èƒ½
- **å‚æ•°éš”ç¦»** - æ·±æ‹·è´é˜²æ­¢æ•°æ®ç«äº‰
- **åŸå­å¼•ç”¨è®¡æ•°** - è·¨çº¿ç¨‹å®‰å…¨çš„å†…å­˜ç®¡ç†

è¿™ä½¿ Hemlock é€‚ç”¨äºï¼š
- å¹¶è¡Œè®¡ç®—
- å¹¶å‘ I/O æ“ä½œ
- æµæ°´çº¿æ¶æ„
- ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

åŒæ—¶é¿å…ä»¥ä¸‹å¤æ‚æ€§ï¼š
- æ‰‹åŠ¨çº¿ç¨‹ç®¡ç†
- ä½çº§åŒæ­¥åŸè¯­
- å®¹æ˜“æ­»é”çš„åŸºäºé”çš„è®¾è®¡
- å…±äº«å¯å˜çŠ¶æ€é”™è¯¯


--------------------------------------------------------------------------------
## æ€§èƒ½åˆ†æ
--------------------------------------------------------------------------------

# æ€§èƒ½åˆ†æ

Hemlock åŒ…å«ä¸€ä¸ªå†…ç½®çš„æ€§èƒ½åˆ†æå™¨ï¼Œç”¨äº **CPU æ—¶é—´åˆ†æ**ã€**å†…å­˜è·Ÿè¸ª**å’Œ**æ³„æ¼æ£€æµ‹**ã€‚åˆ†æå™¨å¸®åŠ©è¯†åˆ«ç¨‹åºä¸­çš„æ€§èƒ½ç“¶é¢ˆå’Œå†…å­˜é—®é¢˜ã€‚

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [åˆ†ææ¨¡å¼](#åˆ†ææ¨¡å¼)
- [è¾“å‡ºæ ¼å¼](#è¾“å‡ºæ ¼å¼)
- [æ³„æ¼æ£€æµ‹](#æ³„æ¼æ£€æµ‹)
- [ç†è§£æŠ¥å‘Š](#ç†è§£æŠ¥å‘Š)
- [ç«ç„°å›¾ç”Ÿæˆ](#ç«ç„°å›¾ç”Ÿæˆ)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¦‚è¿°

é€šè¿‡ `profile` å­å‘½ä»¤è®¿é—®åˆ†æå™¨ï¼š

```bash
hemlock profile [OPTIONS] <FILE>
```

**ä¸»è¦ç‰¹æ€§ï¼š**
- **CPU åˆ†æ** - æµ‹é‡æ¯ä¸ªå‡½æ•°èŠ±è´¹çš„æ—¶é—´ï¼ˆè‡ªèº«æ—¶é—´å’Œæ€»æ—¶é—´ï¼‰
- **å†…å­˜åˆ†æ** - è·Ÿè¸ªæ‰€æœ‰åˆ†é…åŠå…¶æºä½ç½®
- **æ³„æ¼æ£€æµ‹** - è¯†åˆ«ä»æœªé‡Šæ”¾çš„å†…å­˜
- **å¤šç§è¾“å‡ºæ ¼å¼** - æ–‡æœ¬ã€JSON å’Œç«ç„°å›¾å…¼å®¹çš„è¾“å‡º
- **æ¯å‡½æ•°å†…å­˜ç»Ÿè®¡** - æŸ¥çœ‹å“ªäº›å‡½æ•°åˆ†é…æœ€å¤šå†…å­˜

---

## å¿«é€Ÿå¼€å§‹

### åˆ†æ CPU æ—¶é—´ï¼ˆé»˜è®¤ï¼‰

```bash
hemlock profile script.hml
```

### åˆ†æå†…å­˜åˆ†é…

```bash
hemlock profile --memory script.hml
```

### æ£€æµ‹å†…å­˜æ³„æ¼

```bash
hemlock profile --leaks script.hml
```

### ç”Ÿæˆç«ç„°å›¾æ•°æ®

```bash
hemlock profile --flamegraph script.hml > profile.folded
flamegraph.pl profile.folded > profile.svg
```

---

## åˆ†ææ¨¡å¼

### CPU åˆ†æï¼ˆé»˜è®¤ï¼‰

æµ‹é‡æ¯ä¸ªå‡½æ•°èŠ±è´¹çš„æ—¶é—´ï¼ŒåŒºåˆ†ï¼š
- **è‡ªèº«æ—¶é—´** - æ‰§è¡Œå‡½æ•°è‡ªèº«ä»£ç èŠ±è´¹çš„æ—¶é—´
- **æ€»æ—¶é—´** - è‡ªèº«æ—¶é—´åŠ ä¸Šè°ƒç”¨çš„å‡½æ•°èŠ±è´¹çš„æ—¶é—´

```bash
hemlock profile script.hml
hemlock profile --cpu script.hml  # æ˜¾å¼æŒ‡å®š
```

**ç¤ºä¾‹è¾“å‡ºï¼š**
```
=== Hemlock Profiler Report ===

Total time: 1.234ms
Functions called: 5 unique

--- Top 5 by Self Time ---

Function                        Self      Total   Calls
--------                        ----      -----   -----
expensive_calc              0.892ms    0.892ms     100  (72.3%)
process_data                0.234ms    1.126ms      10  (19.0%)
helper                      0.067ms    0.067ms     500  (5.4%)
main                        0.041ms    1.234ms       1  (3.3%)
```

---

### å†…å­˜åˆ†æ

è·Ÿè¸ªæ‰€æœ‰å†…å­˜åˆ†é…ï¼ˆ`alloc`ã€`buffer`ã€`talloc`ã€`realloc`ï¼‰åŠå…¶æºä½ç½®ã€‚

```bash
hemlock profile --memory script.hml
```

**ç¤ºä¾‹è¾“å‡ºï¼š**
```
=== Hemlock Profiler Report ===

Total time: 0.543ms
Functions called: 3 unique
Total allocations: 15 (4.2KB)

--- Top 3 by Self Time ---

Function                        Self      Total   Calls      Alloc      Count
--------                        ----      -----   -----      -----      -----
allocator                   0.312ms    0.312ms      10      3.2KB         10  (57.5%)
buffer_ops                  0.156ms    0.156ms       5       1KB          5  (28.7%)
main                        0.075ms    0.543ms       1        0B          0  (13.8%)

--- Top 10 Allocation Sites ---

Location                                      Total    Count
--------                                      -----    -----
src/data.hml:42                               1.5KB        5
src/data.hml:67                               1.0KB       10
src/main.hml:15                               512B         1
```

---

### è°ƒç”¨è®¡æ•°æ¨¡å¼

æœ€å°å¼€é”€æ¨¡å¼ï¼Œä»…è®¡ç®—å‡½æ•°è°ƒç”¨ï¼ˆæ— è®¡æ—¶ï¼‰ã€‚

```bash
hemlock profile --calls script.hml
```

---

## è¾“å‡ºæ ¼å¼

### æ–‡æœ¬ï¼ˆé»˜è®¤ï¼‰

å¸¦è¡¨æ ¼çš„äººç±»å¯è¯»æ‘˜è¦ã€‚

```bash
hemlock profile script.hml
```

---

### JSON

æœºå™¨å¯è¯»æ ¼å¼ï¼Œç”¨äºä¸å…¶ä»–å·¥å…·é›†æˆã€‚

```bash
hemlock profile --json script.hml
```

**ç¤ºä¾‹è¾“å‡ºï¼š**
```json
{
  "total_time_ns": 1234567,
  "function_count": 5,
  "total_alloc_bytes": 4096,
  "total_alloc_count": 15,
  "functions": [
    {
      "name": "expensive_calc",
      "source_file": "script.hml",
      "line": 10,
      "self_time_ns": 892000,
      "total_time_ns": 892000,
      "call_count": 100,
      "alloc_bytes": 0,
      "alloc_count": 0
    }
  ],
  "alloc_sites": [
    {
      "source_file": "script.hml",
      "line": 42,
      "total_bytes": 1536,
      "alloc_count": 5,
      "current_bytes": 0
    }
  ]
}
```

---

### ç«ç„°å›¾

ç”Ÿæˆä¸ [flamegraph.pl](https://github.com/brendangregg/FlameGraph) å…¼å®¹çš„æŠ˜å æ ˆæ ¼å¼ã€‚

```bash
hemlock profile --flamegraph script.hml > profile.folded

# ä½¿ç”¨ flamegraph.pl ç”Ÿæˆ SVG
flamegraph.pl profile.folded > profile.svg
```

**æŠ˜å è¾“å‡ºç¤ºä¾‹ï¼š**
```
main;process_data;expensive_calc 892
main;process_data;helper 67
main;process_data 234
main 41
```

---

## æ³„æ¼æ£€æµ‹

`--leaks` æ ‡å¿—ä»…æ˜¾ç¤ºä»æœªé‡Šæ”¾çš„åˆ†é…ï¼Œä½¿å†…å­˜æ³„æ¼çš„è¯†åˆ«å˜å¾—å®¹æ˜“ã€‚

```bash
hemlock profile --leaks script.hml
```

**æœ‰æ³„æ¼çš„ç¤ºä¾‹ç¨‹åºï¼š**
```hemlock
fn leaky() {
    let p1 = alloc(100);    // æ³„æ¼ - ä»æœªé‡Šæ”¾
    let p2 = alloc(200);    // OK - ä¸‹é¢é‡Šæ”¾äº†
    free(p2);
}

fn clean() {
    let b = buffer(64);
    free(b);                // æ­£ç¡®é‡Šæ”¾
}

leaky();
clean();
```

**å¸¦ --leaks çš„è¾“å‡ºï¼š**
```
=== Hemlock Profiler Report ===

Total time: 0.034ms
Functions called: 2 unique
Total allocations: 3 (388B)

--- Top 2 by Self Time ---

Function                        Self      Total   Calls      Alloc      Count
--------                        ----      -----   -----      -----      -----
leaky                       0.021ms    0.021ms       1       300B          2  (61.8%)
clean                       0.013ms    0.013ms       1        88B          1  (38.2%)

--- Memory Leaks (1 site) ---

Location                                     Leaked      Total    Count
--------                                     ------      -----    -----
script.hml:2                                   100B       100B        1
```

æ³„æ¼æŠ¥å‘Šæ˜¾ç¤ºï¼š
- **Leaked** - ç¨‹åºé€€å‡ºæ—¶å½“å‰æœªé‡Šæ”¾çš„å­—èŠ‚
- **Total** - åœ¨æ­¤ä½ç½®æ›¾ç»åˆ†é…çš„æ€»å­—èŠ‚
- **Count** - åœ¨æ­¤ä½ç½®çš„åˆ†é…æ¬¡æ•°

---

## ç†è§£æŠ¥å‘Š

### å‡½æ•°ç»Ÿè®¡

| åˆ— | æè¿° |
|------|------|
| Function | å‡½æ•°å |
| Self | å‡½æ•°ä¸­èŠ±è´¹çš„æ—¶é—´ï¼ˆä¸åŒ…æ‹¬è¢«è°ƒç”¨è€…ï¼‰ |
| Total | åŒ…æ‹¬æ‰€æœ‰è¢«è°ƒç”¨å‡½æ•°çš„æ—¶é—´ |
| Calls | å‡½æ•°è¢«è°ƒç”¨çš„æ¬¡æ•° |
| Alloc | æ­¤å‡½æ•°åˆ†é…çš„æ€»å­—èŠ‚æ•° |
| Count | æ­¤å‡½æ•°çš„åˆ†é…æ¬¡æ•° |
| (%) | å ç¨‹åºæ€»æ—¶é—´çš„ç™¾åˆ†æ¯” |

### åˆ†é…ä½ç½®

| åˆ— | æè¿° |
|------|------|
| Location | æºæ–‡ä»¶å’Œè¡Œå· |
| Total | åœ¨æ­¤ä½ç½®åˆ†é…çš„æ€»å­—èŠ‚æ•° |
| Count | åˆ†é…æ¬¡æ•° |
| Leaked | ç¨‹åºé€€å‡ºæ—¶ä»åˆ†é…çš„å­—èŠ‚ï¼ˆä»… --leaksï¼‰ |

### æ—¶é—´å•ä½

åˆ†æå™¨è‡ªåŠ¨é€‰æ‹©é€‚å½“çš„å•ä½ï¼š
- `ns` - çº³ç§’ï¼ˆ< 1å¾®ç§’ï¼‰
- `us` - å¾®ç§’ï¼ˆ< 1æ¯«ç§’ï¼‰
- `ms` - æ¯«ç§’ï¼ˆ< 1ç§’ï¼‰
- `s` - ç§’

---

## å‘½ä»¤å‚è€ƒ

```
hemlock profile [OPTIONS] <FILE>

OPTIONS:
    --cpu           CPU/æ—¶é—´åˆ†æï¼ˆé»˜è®¤ï¼‰
    --memory        å†…å­˜åˆ†é…åˆ†æ
    --calls         ä»…è°ƒç”¨è®¡æ•°ï¼ˆæœ€å°å¼€é”€ï¼‰
    --leaks         ä»…æ˜¾ç¤ºæœªé‡Šæ”¾çš„åˆ†é…ï¼ˆéšå« --memoryï¼‰
    --json          ä»¥ JSON æ ¼å¼è¾“å‡º
    --flamegraph    ä»¥ç«ç„°å›¾å…¼å®¹æ ¼å¼è¾“å‡º
    --top N         æ˜¾ç¤ºå‰ N æ¡è®°å½•ï¼ˆé»˜è®¤ï¼š20ï¼‰
```

---

## ç«ç„°å›¾ç”Ÿæˆ

ç«ç„°å›¾å¯è§†åŒ–ç¨‹åºèŠ±è´¹æ—¶é—´çš„ä½ç½®ï¼Œè¾ƒå®½çš„æ¡è¡¨ç¤ºèŠ±è´¹æ›´å¤šæ—¶é—´ã€‚

### ç”Ÿæˆç«ç„°å›¾

1. å®‰è£… flamegraph.plï¼š
   ```bash
   git clone https://github.com/brendangregg/FlameGraph
   ```

2. åˆ†æä½ çš„ç¨‹åºï¼š
   ```bash
   hemlock profile --flamegraph script.hml > profile.folded
   ```

3. ç”Ÿæˆ SVGï¼š
   ```bash
   ./FlameGraph/flamegraph.pl profile.folded > profile.svg
   ```

4. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `profile.svg` è·å¾—äº¤äº’å¼å¯è§†åŒ–ã€‚

### é˜…è¯»ç«ç„°å›¾

- **X è½´**ï¼šæ€»æ—¶é—´çš„ç™¾åˆ†æ¯”ï¼ˆå®½åº¦ = æ—¶é—´æ¯”ä¾‹ï¼‰
- **Y è½´**ï¼šè°ƒç”¨æ ˆæ·±åº¦ï¼ˆåº•éƒ¨ = å…¥å£ç‚¹ï¼Œé¡¶éƒ¨ = å¶å‡½æ•°ï¼‰
- **é¢œè‰²**ï¼šéšæœºï¼Œä»…ç”¨äºè§†è§‰åŒºåˆ†
- **ç‚¹å‡»**ï¼šæ”¾å¤§ä¸€ä¸ªå‡½æ•°ä»¥æŸ¥çœ‹å…¶è¢«è°ƒç”¨è€…

---

## æœ€ä½³å®è·µ

### 1. åˆ†æä»£è¡¨æ€§å·¥ä½œè´Ÿè½½

ä½¿ç”¨çœŸå®æ•°æ®å’Œä½¿ç”¨æ¨¡å¼è¿›è¡Œåˆ†æã€‚å°çš„æµ‹è¯•ç”¨ä¾‹å¯èƒ½æ— æ³•æ­ç¤ºçœŸæ­£çš„ç“¶é¢ˆã€‚

```bash
# å¥½ï¼šä½¿ç”¨ç±»ä¼¼ç”Ÿäº§çš„æ•°æ®è¿›è¡Œåˆ†æ
hemlock profile --memory process_large_file.hml large_input.txt

# ä¸å¤ªæœ‰ç”¨ï¼šå¾®å°çš„æµ‹è¯•ç”¨ä¾‹
hemlock profile quick_test.hml
```

### 2. åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨ --leaks

å®šæœŸè¿è¡Œæ³„æ¼æ£€æµ‹ä»¥å°½æ—©å‘ç°å†…å­˜æ³„æ¼ï¼š

```bash
hemlock profile --leaks my_program.hml
```

### 3. ä¼˜åŒ–å‰åå¯¹æ¯”

åœ¨ä¼˜åŒ–å‰åè¿›è¡Œåˆ†æä»¥æµ‹é‡å½±å“ï¼š

```bash
# ä¼˜åŒ–å‰
hemlock profile --json script.hml > before.json

# ä¼˜åŒ–å
hemlock profile --json script.hml > after.json

# æ¯”è¾ƒç»“æœ
```

### 4. å¯¹å¤§å‹ç¨‹åºä½¿ç”¨ --top

é™åˆ¶è¾“å‡ºä»¥å…³æ³¨æœ€é‡è¦çš„å‡½æ•°ï¼š

```bash
hemlock profile --top 10 large_program.hml
```

### 5. ç»“åˆç«ç„°å›¾ä½¿ç”¨

å¯¹äºå¤æ‚çš„è°ƒç”¨æ¨¡å¼ï¼Œç«ç„°å›¾æä¾›æ¯”æ–‡æœ¬è¾“å‡ºæ›´å¥½çš„å¯è§†åŒ–ï¼š

```bash
hemlock profile --flamegraph complex_app.hml > app.folded
flamegraph.pl app.folded > app.svg
```

---

## åˆ†æå™¨å¼€é”€

åˆ†æå™¨ä¼šç»™ç¨‹åºæ‰§è¡Œå¢åŠ ä¸€äº›å¼€é”€ï¼š

| æ¨¡å¼ | å¼€é”€ | ç”¨ä¾‹ |
|------|------|------|
| `--calls` | æœ€å° | ä»…è®¡ç®—å‡½æ•°è°ƒç”¨ |
| `--cpu` | ä½ | ä¸€èˆ¬æ€§èƒ½åˆ†æ |
| `--memory` | ä¸­ç­‰ | å†…å­˜åˆ†æå’Œæ³„æ¼æ£€æµ‹ |

ä¸ºäº†è·å¾—æœ€å‡†ç¡®çš„ç»“æœï¼Œå¤šæ¬¡åˆ†æå¹¶å¯»æ‰¾ä¸€è‡´çš„æ¨¡å¼ã€‚

---

## å¦è¯·å‚é˜…

- [å†…å­˜ç®¡ç†](#language-guide-memory) - æŒ‡é’ˆå’Œç¼“å†²åŒº
- [å†…å­˜ API](#reference-memory-api) - allocã€freeã€buffer å‡½æ•°
- [å¼‚æ­¥/å¹¶å‘](#advanced-async-concurrency) - åˆ†æå¼‚æ­¥ä»£ç 


--------------------------------------------------------------------------------
## æ‰“åŒ…ä¸å‘å¸ƒ
--------------------------------------------------------------------------------

# æ‰“åŒ…ä¸åˆ†å‘

Hemlock æä¾›å†…ç½®å·¥å…·ï¼Œå¯å°†å¤šæ–‡ä»¶é¡¹ç›®æ‰“åŒ…æˆå•ä¸ªå¯åˆ†å‘æ–‡ä»¶å¹¶åˆ›å»ºç‹¬ç«‹çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

## æ¦‚è¿°

| å‘½ä»¤ | è¾“å‡º | ç”¨ä¾‹ |
|------|------|------|
| `--bundle` | `.hmlc` æˆ– `.hmlb` | åˆ†å‘å­—èŠ‚ç ï¼ˆéœ€è¦ Hemlock è¿è¡Œï¼‰ |
| `--package` | å¯æ‰§è¡Œæ–‡ä»¶ | ç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ— ä¾èµ–ï¼‰ |
| `--compile` | `.hmlc` | ç¼–è¯‘å•ä¸ªæ–‡ä»¶ï¼ˆæ— å¯¼å…¥è§£æï¼‰ |

## æ‰“åŒ…

æ‰“åŒ…å™¨ä»å…¥å£ç‚¹è§£ææ‰€æœ‰ `import` è¯­å¥ï¼Œå¹¶å°†å®ƒä»¬å±•å¹³ä¸ºå•ä¸ªæ–‡ä»¶ã€‚

### åŸºæœ¬ç”¨æ³•

```bash
# å°† app.hml åŠå…¶æ‰€æœ‰å¯¼å…¥æ‰“åŒ…æˆ app.hmlc
hemlock --bundle app.hml

# æŒ‡å®šè¾“å‡ºè·¯å¾„
hemlock --bundle app.hml -o dist/app.hmlc

# åˆ›å»ºå‹ç¼©åŒ…ï¼ˆ.hmlbï¼‰- æ›´å°çš„æ–‡ä»¶å¤§å°
hemlock --bundle app.hml --compress -o app.hmlb

# è¯¦ç»†è¾“å‡ºï¼ˆæ˜¾ç¤ºè§£æçš„æ¨¡å—ï¼‰
hemlock --bundle app.hml --verbose
```

### è¾“å‡ºæ ¼å¼

**`.hmlc`ï¼ˆæœªå‹ç¼©ï¼‰**
- åºåˆ—åŒ–çš„ AST æ ¼å¼
- åŠ è½½å’Œæ‰§è¡Œé€Ÿåº¦å¿«
- é»˜è®¤è¾“å‡ºæ ¼å¼

**`.hmlb`ï¼ˆå‹ç¼©ï¼‰**
- zlib å‹ç¼©çš„ `.hmlc`
- æ–‡ä»¶å¤§å°æ›´å°ï¼ˆé€šå¸¸å‡å°‘ 50-70%ï¼‰
- ç”±äºè§£å‹ç¼©ï¼Œå¯åŠ¨ç¨æ…¢

### è¿è¡Œæ‰“åŒ…æ–‡ä»¶

```bash
# è¿è¡Œæœªå‹ç¼©åŒ…
hemlock app.hmlc

# è¿è¡Œå‹ç¼©åŒ…
hemlock app.hmlb

# ä¼ é€’å‚æ•°
hemlock app.hmlc arg1 arg2
```

### ç¤ºä¾‹ï¼šå¤šæ¨¡å—é¡¹ç›®

```
myapp/
â”œâ”€â”€ main.hml
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ math.hml
â”‚   â””â”€â”€ utils.hml
â””â”€â”€ config.hml
```

```hemlock
// main.hml
import { add, multiply } from "./lib/math.hml";
import { log } from "./lib/utils.hml";
import { VERSION } from "./config.hml";

log(`App v${VERSION}`);
print(add(2, 3));
```

```bash
hemlock --bundle myapp/main.hml -o myapp.hmlc
hemlock myapp.hmlc  # è¿è¡Œæ—¶æ‰€æœ‰ä¾èµ–éƒ½å·²æ‰“åŒ…
```

### stdlib å¯¼å…¥

æ‰“åŒ…å™¨è‡ªåŠ¨è§£æ `@stdlib/` å¯¼å…¥ï¼š

```hemlock
import { HashMap } from "@stdlib/collections";
import { now } from "@stdlib/time";
```

æ‰“åŒ…æ—¶ï¼Œstdlib æ¨¡å—ä¼šåŒ…å«åœ¨è¾“å‡ºä¸­ã€‚

## å°è£…

å°è£…é€šè¿‡å°†æ‰“åŒ…çš„å­—èŠ‚ç åµŒå…¥ Hemlock è§£é‡Šå™¨å‰¯æœ¬æ¥åˆ›å»ºç‹¬ç«‹çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

### åŸºæœ¬ç”¨æ³•

```bash
# ä» app.hml åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
hemlock --package app.hml

# æŒ‡å®šè¾“å‡ºåç§°
hemlock --package app.hml -o myapp

# è·³è¿‡å‹ç¼©ï¼ˆå¯åŠ¨æ›´å¿«ï¼Œæ–‡ä»¶æ›´å¤§ï¼‰
hemlock --package app.hml --no-compress

# è¯¦ç»†è¾“å‡º
hemlock --package app.hml --verbose
```

### è¿è¡Œå°è£…çš„å¯æ‰§è¡Œæ–‡ä»¶

```bash
# å°è£…çš„å¯æ‰§è¡Œæ–‡ä»¶ç›´æ¥è¿è¡Œ
./myapp

# å‚æ•°ä¼ é€’ç»™è„šæœ¬
./myapp arg1 arg2
```

### å°è£…æ ¼å¼

å°è£…çš„å¯æ‰§è¡Œæ–‡ä»¶ä½¿ç”¨ HMLP æ ¼å¼ï¼š

```
[hemlock äºŒè¿›åˆ¶æ–‡ä»¶][HMLB/HMLC è½½è·][payload_size:u64][HMLP é­”æ•°:u32]
```

å½“å°è£…çš„å¯æ‰§è¡Œæ–‡ä»¶è¿è¡Œæ—¶ï¼š
1. æ£€æŸ¥æ–‡ä»¶æœ«å°¾æ˜¯å¦æœ‰åµŒå…¥çš„è½½è·
2. å¦‚æœæ‰¾åˆ°ï¼Œè§£å‹ç¼©å¹¶æ‰§è¡Œè½½è·
3. å¦‚æœæœªæ‰¾åˆ°ï¼Œä½œä¸ºæ™®é€š Hemlock è§£é‡Šå™¨è¿è¡Œ

### å‹ç¼©é€‰é¡¹

| æ ‡å¿— | æ ¼å¼ | å¯åŠ¨ | å¤§å° |
|------|------|------|------|
| ï¼ˆé»˜è®¤ï¼‰ | HMLB | æ­£å¸¸ | è¾ƒå° |
| `--no-compress` | HMLC | æ›´å¿« | è¾ƒå¤§ |

å¯¹äºå¯åŠ¨æ—¶é—´é‡è¦çš„ CLI å·¥å…·ï¼Œä½¿ç”¨ `--no-compress`ã€‚

## æ£€æŸ¥åŒ…

ä½¿ç”¨ `--info` æ£€æŸ¥æ‰“åŒ…æˆ–ç¼–è¯‘çš„æ–‡ä»¶ï¼š

```bash
hemlock --info app.hmlc
```

è¾“å‡ºï¼š
```
=== File Info: app.hmlc ===
Size: 12847 bytes
Format: HMLC (compiled AST)
Version: 1
Flags: 0x0001 [DEBUG]
Strings: 42
Statements: 156
```

```bash
hemlock --info app.hmlb
```

è¾“å‡ºï¼š
```
=== File Info: app.hmlb ===
Size: 5234 bytes
Format: HMLB (compressed bundle)
Version: 1
Uncompressed: 12847 bytes
Compressed: 5224 bytes
Ratio: 59.3% reduction
```

## åŸç”Ÿç¼–è¯‘

è¦è·å¾—çœŸæ­£çš„åŸç”Ÿå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ— è§£é‡Šå™¨ï¼‰ï¼Œä½¿ç”¨ Hemlock ç¼–è¯‘å™¨ï¼š

```bash
# é€šè¿‡ C ç¼–è¯‘ä¸ºåŸç”Ÿå¯æ‰§è¡Œæ–‡ä»¶
hemlockc app.hml -o app

# ä¿ç•™ç”Ÿæˆçš„ C ä»£ç 
hemlockc app.hml -o app --keep-c

# ä»…ç”Ÿæˆ Cï¼ˆä¸ç¼–è¯‘ï¼‰
hemlockc app.hml -c -o app.c

# ä¼˜åŒ–çº§åˆ«
hemlockc app.hml -o app -O2
```

ç¼–è¯‘å™¨ç”Ÿæˆ C ä»£ç å¹¶è°ƒç”¨ GCC äº§ç”ŸåŸç”ŸäºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™éœ€è¦ï¼š
- Hemlock è¿è¡Œæ—¶åº“ï¼ˆ`libhemlock_runtime`ï¼‰
- C ç¼–è¯‘å™¨ï¼ˆé»˜è®¤ GCCï¼‰

### ç¼–è¯‘å™¨é€‰é¡¹

| é€‰é¡¹ | æè¿° |
|------|------|
| `-o <file>` | è¾“å‡ºå¯æ‰§è¡Œæ–‡ä»¶å |
| `-c` | ä»…ç”Ÿæˆ C ä»£ç  |
| `--emit-c <file>` | å°† C å†™å…¥æŒ‡å®šæ–‡ä»¶ |
| `-k, --keep-c` | ç¼–è¯‘åä¿ç•™ç”Ÿæˆçš„ C |
| `-O<level>` | ä¼˜åŒ–çº§åˆ«ï¼ˆ0-3ï¼‰ |
| `--cc <path>` | ä½¿ç”¨çš„ C ç¼–è¯‘å™¨ |
| `--runtime <path>` | è¿è¡Œæ—¶åº“è·¯å¾„ |
| `-v, --verbose` | è¯¦ç»†è¾“å‡º |

## æ¯”è¾ƒ

| æ–¹æ³• | å¯ç§»æ¤æ€§ | å¯åŠ¨ | å¤§å° | ä¾èµ– |
|------|----------|------|------|------|
| `.hml` | ä»…æºç  | è§£ææ—¶é—´ | æœ€å° | Hemlock |
| `.hmlc` | ä»… Hemlock | å¿« | å° | Hemlock |
| `.hmlb` | ä»… Hemlock | å¿« | æ›´å° | Hemlock |
| `--package` | ç‹¬ç«‹ | å¿« | è¾ƒå¤§ | æ—  |
| `hemlockc` | åŸç”Ÿ | æœ€å¿« | ä¸å®š | è¿è¡Œæ—¶åº“ |

## æœ€ä½³å®è·µ

1. **å¼€å‘**ï¼šç›´æ¥è¿è¡Œ `.hml` æ–‡ä»¶ä»¥å¿«é€Ÿè¿­ä»£
2. **åˆ†å‘ï¼ˆæœ‰ Hemlockï¼‰**ï¼šä½¿ç”¨ `--compress` æ‰“åŒ…ä»¥è·å¾—æ›´å°çš„æ–‡ä»¶
3. **åˆ†å‘ï¼ˆç‹¬ç«‹ï¼‰**ï¼šå°è£…ä»¥å®ç°é›¶ä¾èµ–éƒ¨ç½²
4. **æ€§èƒ½å…³é”®**ï¼šä½¿ç”¨ `hemlockc` è¿›è¡ŒåŸç”Ÿç¼–è¯‘

## æ•…éšœæ’é™¤

### "Cannot find stdlib"

æ‰“åŒ…å™¨åœ¨ä»¥ä¸‹ä½ç½®æŸ¥æ‰¾ stdlibï¼š
1. `./stdlib`ï¼ˆç›¸å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶ï¼‰
2. `../stdlib`ï¼ˆç›¸å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶ï¼‰
3. `/usr/local/lib/hemlock/stdlib`

ç¡®ä¿ Hemlock å·²æ­£ç¡®å®‰è£…æˆ–ä»æºç›®å½•è¿è¡Œã€‚

### å¾ªç¯ä¾èµ–

```
Error: Circular dependency detected when loading 'path/to/module.hml'
```

é‡æ„ä½ çš„å¯¼å…¥ä»¥æ‰“ç ´å¾ªç¯ã€‚è€ƒè™‘ä½¿ç”¨å…±äº«æ¨¡å—å­˜æ”¾å…¬å…±ç±»å‹ã€‚

### å°è£…å¤§å°è¿‡å¤§

- ä½¿ç”¨é»˜è®¤å‹ç¼©ï¼ˆä¸è¦ä½¿ç”¨ `--no-compress`ï¼‰
- å°è£…å¤§å°åŒ…å«å®Œæ•´è§£é‡Šå™¨ï¼ˆåŸºç¡€çº¦ 500KB-1MBï¼‰
- è¦è·å¾—æœ€å°å¤§å°ï¼Œä½¿ç”¨ `hemlockc` è¿›è¡ŒåŸç”Ÿç¼–è¯‘



################################################################################
# API å‚è€ƒ
################################################################################

--------------------------------------------------------------------------------
## å†…å­˜ API
--------------------------------------------------------------------------------

# å†…å­˜ API å‚è€ƒ

Hemlock å†…å­˜ç®¡ç†å‡½æ•°å’ŒæŒ‡é’ˆç±»å‹çš„å®Œæ•´å‚è€ƒæ–‡æ¡£ã€‚

---

## æ¦‚è¿°

Hemlock æä¾›**æ‰‹åŠ¨å†…å­˜ç®¡ç†**ï¼Œå…·æœ‰æ˜¾å¼çš„åˆ†é…å’Œé‡Šæ”¾ã€‚å†…å­˜é€šè¿‡ä¸¤ç§æŒ‡é’ˆç±»å‹ç®¡ç†ï¼šåŸå§‹æŒ‡é’ˆï¼ˆ`ptr`ï¼‰å’Œå®‰å…¨ç¼“å†²åŒºï¼ˆ`buffer`ï¼‰ã€‚

**æ ¸å¿ƒåŸåˆ™ï¼š**
- æ˜¾å¼åˆ†é…å’Œé‡Šæ”¾
- æ— åƒåœ¾å›æ”¶
- ç”¨æˆ·è´Ÿè´£è°ƒç”¨ `free()`
- å†…éƒ¨å¼•ç”¨è®¡æ•°ç”¨äºä½œç”¨åŸŸ/é‡æ–°èµ‹å€¼å®‰å…¨ï¼ˆè§ä¸‹æ–‡ï¼‰

### å†…éƒ¨å¼•ç”¨è®¡æ•°

è¿è¡Œæ—¶å†…éƒ¨ä½¿ç”¨å¼•ç”¨è®¡æ•°æ¥ç®¡ç†å¯¹è±¡åœ¨ä½œç”¨åŸŸä¸­çš„ç”Ÿå‘½å‘¨æœŸã€‚å¯¹äºå¤§å¤šæ•°å±€éƒ¨å˜é‡ï¼Œæ¸…ç†æ˜¯è‡ªåŠ¨çš„ã€‚

**è‡ªåŠ¨ï¼ˆæ— éœ€ `free()`ï¼‰ï¼š**
- å¼•ç”¨è®¡æ•°ç±»å‹ï¼ˆbufferã€arrayã€objectã€stringï¼‰çš„å±€éƒ¨å˜é‡åœ¨ä½œç”¨åŸŸé€€å‡ºæ—¶é‡Šæ”¾
- å˜é‡é‡æ–°èµ‹å€¼æ—¶é‡Šæ”¾æ—§å€¼
- å®¹å™¨é‡Šæ”¾æ—¶é‡Šæ”¾å®¹å™¨å…ƒç´ 

**éœ€è¦æ‰‹åŠ¨ `free()`ï¼š**
- æ¥è‡ª `alloc()` çš„åŸå§‹æŒ‡é’ˆ - å§‹ç»ˆéœ€è¦
- ä½œç”¨åŸŸç»“æŸå‰çš„æå‰æ¸…ç†
- é•¿æœŸå­˜åœ¨/å…¨å±€æ•°æ®

è¯¦è§ [å†…å­˜ç®¡ç†æŒ‡å—](../language-guide/memory.md#internal-reference-counting)ã€‚

---

## æŒ‡é’ˆç±»å‹

### ptrï¼ˆåŸå§‹æŒ‡é’ˆï¼‰

**ç±»å‹ï¼š** `ptr`

**æè¿°ï¼š** åŸå§‹å†…å­˜åœ°å€ï¼Œæ— è¾¹ç•Œæ£€æŸ¥æˆ–è·Ÿè¸ªã€‚

**å¤§å°ï¼š** 8 å­—èŠ‚

**ç”¨ä¾‹ï¼š**
- åº•å±‚å†…å­˜æ“ä½œ
- FFIï¼ˆå¤–éƒ¨å‡½æ•°æ¥å£ï¼‰
- æœ€é«˜æ€§èƒ½ï¼ˆæ— å¼€é”€ï¼‰

**å®‰å…¨æ€§ï¼š** ä¸å®‰å…¨ - æ— è¾¹ç•Œæ£€æŸ¥ï¼Œç”¨æˆ·å¿…é¡»è·Ÿè¸ªç”Ÿå‘½å‘¨æœŸ

**ç¤ºä¾‹ï¼š**
```hemlock
let p: ptr = alloc(64);
memset(p, 0, 64);
free(p);
```

---

### bufferï¼ˆå®‰å…¨ç¼“å†²åŒºï¼‰

**ç±»å‹ï¼š** `buffer`

**æè¿°ï¼š** å¸¦è¾¹ç•Œæ£€æŸ¥çš„å®‰å…¨æŒ‡é’ˆåŒ…è£…å™¨ã€‚

**ç»“æ„ï¼š** æŒ‡é’ˆ + é•¿åº¦ + å®¹é‡ + å¼•ç”¨è®¡æ•°

**å±æ€§ï¼š**
- `.length` - ç¼“å†²åŒºå¤§å° (i32)
- `.capacity` - å·²åˆ†é…å®¹é‡ (i32)

**ç”¨ä¾‹ï¼š**
- å¤§å¤šæ•°å†…å­˜åˆ†é…
- å®‰å…¨æ€§é‡è¦æ—¶
- åŠ¨æ€æ•°ç»„

**å®‰å…¨æ€§ï¼š** ç´¢å¼•è®¿é—®æ—¶è¿›è¡Œè¾¹ç•Œæ£€æŸ¥

**å¼•ç”¨è®¡æ•°ï¼š** ç¼“å†²åŒºå†…éƒ¨è¿›è¡Œå¼•ç”¨è®¡æ•°ã€‚ä½œç”¨åŸŸé€€å‡ºæˆ–å˜é‡é‡æ–°èµ‹å€¼æ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚ä½¿ç”¨ `free()` è¿›è¡Œæå‰æ¸…ç†æˆ–ç”¨äºé•¿æœŸå­˜åœ¨çš„æ•°æ®ã€‚

**ç¤ºä¾‹ï¼š**
```hemlock
let b: buffer = buffer(64);
b[0] = 65;              // è¾¹ç•Œæ£€æŸ¥
print(b.length);        // 64
free(b);
```

---

## å†…å­˜åˆ†é…å‡½æ•°

### alloc

åˆ†é…åŸå§‹å†…å­˜ã€‚

**ç­¾åï¼š**
```hemlock
alloc(size: i32): ptr
```

**å‚æ•°ï¼š**
- `size` - è¦åˆ†é…çš„å­—èŠ‚æ•°

**è¿”å›å€¼ï¼š** æŒ‡å‘å·²åˆ†é…å†…å­˜çš„æŒ‡é’ˆ (`ptr`)

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(1024);        // åˆ†é… 1KB
memset(p, 0, 1024);         // åˆå§‹åŒ–ä¸ºé›¶
free(p);                    // å®Œæˆåé‡Šæ”¾

// ä¸ºç»“æ„åˆ†é…
let struct_size = 16;
let p2 = alloc(struct_size);
```

**è¡Œä¸ºï¼š**
- è¿”å›æœªåˆå§‹åŒ–çš„å†…å­˜
- å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾å†…å­˜
- åˆ†é…å¤±è´¥æ—¶è¿”å› `null`ï¼ˆè°ƒç”¨è€…å¿…é¡»æ£€æŸ¥ï¼‰

**å¦è¯·å‚é˜…ï¼š** `buffer()` ä½œä¸ºæ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆ

---

### buffer

åˆ†é…å¸¦è¾¹ç•Œæ£€æŸ¥çš„å®‰å…¨ç¼“å†²åŒºã€‚

**ç­¾åï¼š**
```hemlock
buffer(size: i32): buffer
```

**å‚æ•°ï¼š**
- `size` - ç¼“å†²åŒºå¤§å°ï¼ˆå­—èŠ‚ï¼‰

**è¿”å›å€¼ï¼š** ç¼“å†²åŒºå¯¹è±¡

**ç¤ºä¾‹ï¼š**
```hemlock
let buf = buffer(256);
print(buf.length);          // 256
print(buf.capacity);        // 256

// å¸¦è¾¹ç•Œæ£€æŸ¥çš„è®¿é—®
buf[0] = 65;                // 'A'
buf[255] = 90;              // 'Z'
// buf[256] = 0;            // é”™è¯¯ï¼šè¶Šç•Œ

free(buf);
```

**å±æ€§ï¼š**
- `.length` - å½“å‰å¤§å° (i32)
- `.capacity` - å·²åˆ†é…å®¹é‡ (i32)

**è¡Œä¸ºï¼š**
- å°†å†…å­˜åˆå§‹åŒ–ä¸ºé›¶
- åœ¨ç´¢å¼•è®¿é—®æ—¶æä¾›è¾¹ç•Œæ£€æŸ¥
- åˆ†é…å¤±è´¥æ—¶è¿”å› `null`ï¼ˆè°ƒç”¨è€…å¿…é¡»æ£€æŸ¥ï¼‰
- å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾

---

### free

é‡Šæ”¾å·²åˆ†é…çš„å†…å­˜ã€‚

**ç­¾åï¼š**
```hemlock
free(ptr: ptr | buffer): null
```

**å‚æ•°ï¼š**
- `ptr` - è¦é‡Šæ”¾çš„æŒ‡é’ˆæˆ–ç¼“å†²åŒº

**è¿”å›å€¼ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
// é‡Šæ”¾åŸå§‹æŒ‡é’ˆ
let p = alloc(1024);
free(p);

// é‡Šæ”¾ç¼“å†²åŒº
let buf = buffer(256);
free(buf);
```

**è¡Œä¸ºï¼š**
- é‡Šæ”¾ç”± `alloc()` æˆ– `buffer()` åˆ†é…çš„å†…å­˜
- åŒé‡é‡Šæ”¾ä¼šå¯¼è‡´å´©æºƒï¼ˆç”¨æˆ·æœ‰è´£ä»»é¿å…ï¼‰
- é‡Šæ”¾æ— æ•ˆæŒ‡é’ˆä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸º

**é‡è¦ï¼š** ä½ åˆ†é…ï¼Œä½ é‡Šæ”¾ã€‚æ²¡æœ‰è‡ªåŠ¨æ¸…ç†ã€‚

---

### realloc

è°ƒæ•´å·²åˆ†é…å†…å­˜çš„å¤§å°ã€‚

**ç­¾åï¼š**
```hemlock
realloc(ptr: ptr, new_size: i32): ptr
```

**å‚æ•°ï¼š**
- `ptr` - è¦è°ƒæ•´å¤§å°çš„æŒ‡é’ˆ
- `new_size` - æ–°å¤§å°ï¼ˆå­—èŠ‚ï¼‰

**è¿”å›å€¼ï¼š** æŒ‡å‘è°ƒæ•´å¤§å°åå†…å­˜çš„æŒ‡é’ˆï¼ˆå¯èƒ½æ˜¯ä¸åŒçš„åœ°å€ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(100);
// ... ä½¿ç”¨å†…å­˜ ...

// éœ€è¦æ›´å¤šç©ºé—´
p = realloc(p, 200);        // ç°åœ¨æ˜¯ 200 å­—èŠ‚
// ... ä½¿ç”¨æ‰©å±•çš„å†…å­˜ ...

free(p);
```

**è¡Œä¸ºï¼š**
- å¯èƒ½å°†å†…å­˜ç§»åŠ¨åˆ°æ–°ä½ç½®
- ä¿ç•™ç°æœ‰æ•°æ®ï¼ˆç›´åˆ°æ—§/æ–°å¤§å°çš„æœ€å°å€¼ï¼‰
- æˆåŠŸ realloc åæ—§æŒ‡é’ˆæ— æ•ˆï¼ˆä½¿ç”¨è¿”å›çš„æŒ‡é’ˆï¼‰
- å¦‚æœ new_size æ›´å°ï¼Œæ•°æ®ä¼šè¢«æˆªæ–­
- åˆ†é…å¤±è´¥æ—¶è¿”å› `null`ï¼ˆåŸå§‹æŒ‡é’ˆä»ç„¶æœ‰æ•ˆï¼‰

**é‡è¦ï¼š** å§‹ç»ˆæ£€æŸ¥ `null` å¹¶ç”¨ç»“æœæ›´æ–°æŒ‡é’ˆå˜é‡ã€‚

---

## å†…å­˜æ“ä½œ

### memset

ç”¨å­—èŠ‚å€¼å¡«å……å†…å­˜ã€‚

**ç­¾åï¼š**
```hemlock
memset(ptr: ptr, byte: i32, size: i32): null
```

**å‚æ•°ï¼š**
- `ptr` - æŒ‡å‘å†…å­˜çš„æŒ‡é’ˆ
- `byte` - è¦å¡«å……çš„å­—èŠ‚å€¼ (0-255)
- `size` - è¦å¡«å……çš„å­—èŠ‚æ•°

**è¿”å›å€¼ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(100);

// æ¸…é›¶å†…å­˜
memset(p, 0, 100);

// ç”¨ç‰¹å®šå€¼å¡«å……
memset(p, 0xFF, 100);

// åˆå§‹åŒ–ç¼“å†²åŒº
let buf = alloc(256);
memset(buf, 65, 256);       // ç”¨ 'A' å¡«å……

free(p);
free(buf);
```

**è¡Œä¸ºï¼š**
- å°†å­—èŠ‚å€¼å†™å…¥èŒƒå›´å†…çš„æ¯ä¸ªå­—èŠ‚
- å­—èŠ‚å€¼æˆªæ–­ä¸º 8 ä½ (0-255)
- æ— è¾¹ç•Œæ£€æŸ¥ï¼ˆä¸å®‰å…¨ï¼‰

---

### memcpy

ä»æºå¤åˆ¶å†…å­˜åˆ°ç›®æ ‡ã€‚

**ç­¾åï¼š**
```hemlock
memcpy(dest: ptr, src: ptr, size: i32): null
```

**å‚æ•°ï¼š**
- `dest` - ç›®æ ‡æŒ‡é’ˆ
- `src` - æºæŒ‡é’ˆ
- `size` - è¦å¤åˆ¶çš„å­—èŠ‚æ•°

**è¿”å›å€¼ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
let src = alloc(100);
let dest = alloc(100);

// åˆå§‹åŒ–æº
memset(src, 65, 100);

// å¤åˆ¶åˆ°ç›®æ ‡
memcpy(dest, src, 100);

// dest ç°åœ¨åŒ…å«ä¸ src ç›¸åŒçš„æ•°æ®

free(src);
free(dest);
```

**è¡Œä¸ºï¼š**
- é€å­—èŠ‚ä» src å¤åˆ¶åˆ° dest
- æ— è¾¹ç•Œæ£€æŸ¥ï¼ˆä¸å®‰å…¨ï¼‰
- é‡å åŒºåŸŸè¡Œä¸ºæœªå®šä¹‰ï¼ˆå°å¿ƒä½¿ç”¨ï¼‰

---

## ç±»å‹åŒ–å†…å­˜æ“ä½œ

### sizeof

è·å–ç±»å‹çš„å­—èŠ‚å¤§å°ã€‚

**ç­¾åï¼š**
```hemlock
sizeof(type): i32
```

**å‚æ•°ï¼š**
- `type` - ç±»å‹æ ‡è¯†ç¬¦ï¼ˆä¾‹å¦‚ `i32`ã€`f64`ã€`ptr`ï¼‰

**è¿”å›å€¼ï¼š** å­—èŠ‚å¤§å° (i32)

**ç±»å‹å¤§å°ï¼š**

| ç±»å‹ | å¤§å°ï¼ˆå­—èŠ‚ï¼‰|
|------|--------------|
| `i8` | 1 |
| `i16` | 2 |
| `i32`ã€`integer` | 4 |
| `i64` | 8 |
| `u8`ã€`byte` | 1 |
| `u16` | 2 |
| `u32` | 4 |
| `u64` | 8 |
| `f32` | 4 |
| `f64`ã€`number` | 8 |
| `bool` | 1 |
| `ptr` | 8 |
| `rune` | 4 |

**ç¤ºä¾‹ï¼š**
```hemlock
let int_size = sizeof(i32);      // 4
let ptr_size = sizeof(ptr);      // 8
let float_size = sizeof(f64);    // 8
let byte_size = sizeof(u8);      // 1
let rune_size = sizeof(rune);    // 4

// è®¡ç®—æ•°ç»„åˆ†é…å¤§å°
let count = 100;
let total = sizeof(i32) * count; // 400 å­—èŠ‚
```

**è¡Œä¸ºï¼š**
- å¯¹æœªçŸ¥ç±»å‹è¿”å› 0
- æ¥å—ç±»å‹æ ‡è¯†ç¬¦å’Œç±»å‹å­—ç¬¦ä¸²

---

### talloc

åˆ†é…ç±»å‹åŒ–å€¼æ•°ç»„ã€‚

**ç­¾åï¼š**
```hemlock
talloc(type, count: i32): ptr
```

**å‚æ•°ï¼š**
- `type` - è¦åˆ†é…çš„ç±»å‹ï¼ˆä¾‹å¦‚ `i32`ã€`f64`ã€`ptr`ï¼‰
- `count` - å…ƒç´ æ•°é‡ï¼ˆå¿…é¡»ä¸ºæ­£æ•°ï¼‰

**è¿”å›å€¼ï¼š** æŒ‡å‘å·²åˆ†é…æ•°ç»„çš„æŒ‡é’ˆï¼Œåˆ†é…å¤±è´¥æ—¶è¿”å› `null`

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = talloc(i32, 100);      // 100 ä¸ª i32 çš„æ•°ç»„ï¼ˆ400 å­—èŠ‚ï¼‰
let floats = talloc(f64, 50);    // 50 ä¸ª f64 çš„æ•°ç»„ï¼ˆ400 å­—èŠ‚ï¼‰
let bytes = talloc(u8, 1024);    // 1024 å­—èŠ‚çš„æ•°ç»„

// å§‹ç»ˆæ£€æŸ¥åˆ†é…å¤±è´¥
if (arr == null) {
    panic("allocation failed");
}

// ä½¿ç”¨å·²åˆ†é…çš„å†…å­˜
// ...

free(arr);
free(floats);
free(bytes);
```

**è¡Œä¸ºï¼š**
- åˆ†é… `sizeof(type) * count` å­—èŠ‚
- è¿”å›æœªåˆå§‹åŒ–çš„å†…å­˜
- å¿…é¡»ä½¿ç”¨ `free()` æ‰‹åŠ¨é‡Šæ”¾å†…å­˜
- åˆ†é…å¤±è´¥æ—¶è¿”å› `null`ï¼ˆè°ƒç”¨è€…å¿…é¡»æ£€æŸ¥ï¼‰
- å¦‚æœ count ä¸æ˜¯æ­£æ•°åˆ™ panic

---

## ç¼“å†²åŒºå±æ€§

### .length

è·å–ç¼“å†²åŒºå¤§å°ã€‚

**ç±»å‹ï¼š** `i32`

**è®¿é—®ï¼š** åªè¯»

**ç¤ºä¾‹ï¼š**
```hemlock
let buf = buffer(256);
print(buf.length);          // 256

let buf2 = buffer(1024);
print(buf2.length);         // 1024
```

---

### .capacity

è·å–ç¼“å†²åŒºå®¹é‡ã€‚

**ç±»å‹ï¼š** `i32`

**è®¿é—®ï¼š** åªè¯»

**ç¤ºä¾‹ï¼š**
```hemlock
let buf = buffer(256);
print(buf.capacity);        // 256
```

**æ³¨æ„ï¼š** ç›®å‰ï¼Œå¯¹äºä½¿ç”¨ `buffer()` åˆ›å»ºçš„ç¼“å†²åŒºï¼Œ`.length` å’Œ `.capacity` ç›¸åŒã€‚

---

## ä½¿ç”¨æ¨¡å¼

### åŸºæœ¬åˆ†é…æ¨¡å¼

```hemlock
// åˆ†é…
let p = alloc(1024);
if (p == null) {
    panic("allocation failed");
}

// ä½¿ç”¨
memset(p, 0, 1024);

// é‡Šæ”¾
free(p);
```

### å®‰å…¨ç¼“å†²åŒºæ¨¡å¼

```hemlock
// åˆ†é…ç¼“å†²åŒº
let buf = buffer(256);
if (buf == null) {
    panic("buffer allocation failed");
}

// å¸¦è¾¹ç•Œæ£€æŸ¥ä½¿ç”¨
let i = 0;
while (i < buf.length) {
    buf[i] = i;
    i = i + 1;
}

// é‡Šæ”¾
free(buf);
```

### åŠ¨æ€å¢é•¿æ¨¡å¼

```hemlock
let size = 100;
let p = alloc(size);
if (p == null) {
    panic("allocation failed");
}

// ... ä½¿ç”¨å†…å­˜ ...

// éœ€è¦æ›´å¤šç©ºé—´ - æ£€æŸ¥å¤±è´¥
let new_p = realloc(p, 200);
if (new_p == null) {
    // åŸå§‹æŒ‡é’ˆä»ç„¶æœ‰æ•ˆï¼Œæ¸…ç†
    free(p);
    panic("realloc failed");
}
p = new_p;
size = 200;

// ... ä½¿ç”¨æ‰©å±•çš„å†…å­˜ ...

free(p);
```

### å†…å­˜å¤åˆ¶æ¨¡å¼

```hemlock
let original = alloc(100);
memset(original, 65, 100);

// åˆ›å»ºå‰¯æœ¬
let copy = alloc(100);
memcpy(copy, original, 100);

free(original);
free(copy);
```

---

## å®‰å…¨æ³¨æ„äº‹é¡¹

**Hemlock å†…å­˜ç®¡ç†è®¾è®¡ä¸Šæ˜¯ä¸å®‰å…¨çš„ï¼š**

### å¸¸è§é™·é˜±

**1. å†…å­˜æ³„æ¼**
```hemlock
// é”™è¯¯ï¼šå†…å­˜æ³„æ¼
fn create_buffer() {
    let p = alloc(1024);
    return null;  // å†…å­˜æ³„æ¼ï¼
}

// æ­£ç¡®ï¼šé€‚å½“æ¸…ç†
fn create_buffer() {
    let p = alloc(1024);
    // ... ä½¿ç”¨å†…å­˜ ...
    free(p);
    return null;
}
```

**2. é‡Šæ”¾åä½¿ç”¨**
```hemlock
// é”™è¯¯ï¼šé‡Šæ”¾åä½¿ç”¨
let p = alloc(100);
free(p);
memset(p, 0, 100);  // å´©æºƒï¼šä½¿ç”¨å·²é‡Šæ”¾çš„å†…å­˜

// æ­£ç¡®ï¼šé‡Šæ”¾åä¸ä½¿ç”¨
let p2 = alloc(100);
memset(p2, 0, 100);
free(p2);
// æ­¤åä¸è¦ä½¿ç”¨ p2
```

**3. åŒé‡é‡Šæ”¾**
```hemlock
// é”™è¯¯ï¼šåŒé‡é‡Šæ”¾
let p = alloc(100);
free(p);
free(p);  // å´©æºƒï¼šåŒé‡é‡Šæ”¾

// æ­£ç¡®ï¼šåªé‡Šæ”¾ä¸€æ¬¡
let p2 = alloc(100);
free(p2);
```

**4. ç¼“å†²åŒºæº¢å‡ºï¼ˆptrï¼‰**
```hemlock
// é”™è¯¯ï¼šptr çš„ç¼“å†²åŒºæº¢å‡º
let p = alloc(10);
memset(p, 65, 100);  // å´©æºƒï¼šå†™å…¥è¶…è¿‡åˆ†é…èŒƒå›´

// æ­£ç¡®ï¼šä½¿ç”¨ buffer è¿›è¡Œè¾¹ç•Œæ£€æŸ¥
let buf = buffer(10);
// buf[100] = 65;  // é”™è¯¯ï¼šè¾¹ç•Œæ£€æŸ¥å¤±è´¥
```

**5. æ‚¬ç©ºæŒ‡é’ˆ**
```hemlock
// é”™è¯¯ï¼šæ‚¬ç©ºæŒ‡é’ˆ
let p1 = alloc(100);
let p2 = p1;
free(p1);
memset(p2, 0, 100);  // å´©æºƒï¼šp2 æ˜¯æ‚¬ç©ºçš„

// æ­£ç¡®ï¼šä»”ç»†è·Ÿè¸ªæ‰€æœ‰æƒ
let p = alloc(100);
// ... ä½¿ç”¨ p ...
free(p);
// ä¸è¦ä¿ç•™å¯¹ p çš„å…¶ä»–å¼•ç”¨
```

**6. æœªæ£€æŸ¥çš„åˆ†é…å¤±è´¥**
```hemlock
// é”™è¯¯ï¼šä¸æ£€æŸ¥ null
let p = alloc(1000000000);  // åœ¨ä½å†…å­˜æ—¶å¯èƒ½å¤±è´¥
memset(p, 0, 1000000000);   // å´©æºƒï¼šp æ˜¯ null

// æ­£ç¡®ï¼šå§‹ç»ˆæ£€æŸ¥åˆ†é…ç»“æœ
let p2 = alloc(1000000000);
if (p2 == null) {
    panic("out of memory");
}
memset(p2, 0, 1000000000);
free(p2);
```

---

## ä½•æ—¶ä½¿ç”¨ä»€ä¹ˆ

### ä½¿ç”¨ `buffer()` å½“ï¼š
- éœ€è¦è¾¹ç•Œæ£€æŸ¥æ—¶
- å¤„ç†åŠ¨æ€æ•°æ®æ—¶
- å®‰å…¨æ€§é‡è¦æ—¶
- å­¦ä¹  Hemlock æ—¶

### ä½¿ç”¨ `alloc()` å½“ï¼š
- éœ€è¦æœ€é«˜æ€§èƒ½æ—¶
- FFI/ä¸ C æ¥å£æ—¶
- çŸ¥é“ç¡®åˆ‡çš„å†…å­˜å¸ƒå±€æ—¶
- ä½ æ˜¯ä¸“å®¶æ—¶

### ä½¿ç”¨ `realloc()` å½“ï¼š
- å¢é•¿/ç¼©å°åˆ†é…æ—¶
- åŠ¨æ€æ•°ç»„
- éœ€è¦ä¿ç•™æ•°æ®æ—¶

---

## å®Œæ•´å‡½æ•°æ€»ç»“

| å‡½æ•°      | ç­¾å                                   | è¿”å›å€¼   | æè¿°                       |
|-----------|----------------------------------------|----------|----------------------------|
| `alloc`   | `(size: i32)`                          | `ptr`    | åˆ†é…åŸå§‹å†…å­˜               |
| `buffer`  | `(size: i32)`                          | `buffer` | åˆ†é…å®‰å…¨ç¼“å†²åŒº             |
| `free`    | `(ptr: ptr \| buffer)`                 | `null`   | é‡Šæ”¾å†…å­˜                   |
| `realloc` | `(ptr: ptr, new_size: i32)`            | `ptr`    | è°ƒæ•´åˆ†é…å¤§å°               |
| `memset`  | `(ptr: ptr, byte: i32, size: i32)`     | `null`   | å¡«å……å†…å­˜                   |
| `memcpy`  | `(dest: ptr, src: ptr, size: i32)`     | `null`   | å¤åˆ¶å†…å­˜                   |
| `sizeof`  | `(type)`                               | `i32`    | è·å–ç±»å‹å­—èŠ‚å¤§å°           |
| `talloc`  | `(type, count: i32)`                   | `ptr`    | åˆ†é…ç±»å‹åŒ–æ•°ç»„             |

---

## å¦è¯·å‚é˜…

- [ç±»å‹ç³»ç»Ÿ](#reference-type-system) - æŒ‡é’ˆå’Œç¼“å†²åŒºç±»å‹
- [å†…ç½®å‡½æ•°](#reference-builtins) - æ‰€æœ‰å†…ç½®å‡½æ•°
- [å­—ç¬¦ä¸² API](#reference-string-api) - å­—ç¬¦ä¸² `.to_bytes()` æ–¹æ³•


--------------------------------------------------------------------------------
## å†…ç½®å‡½æ•°
--------------------------------------------------------------------------------

# å†…ç½®å‡½æ•°å‚è€ƒ

Hemlock æ‰€æœ‰å†…ç½®å‡½æ•°å’Œå¸¸é‡çš„å®Œæ•´å‚è€ƒæ–‡æ¡£ã€‚

---

## æ¦‚è¿°

Hemlock æä¾›äº†ä¸€ç»„å†…ç½®å‡½æ•°ï¼Œç”¨äº I/Oã€ç±»å‹è‡ªçœã€å†…å­˜ç®¡ç†ã€å¹¶å‘å’Œç³»ç»Ÿäº¤äº’ã€‚æ‰€æœ‰å†…ç½®å‡½æ•°å…¨å±€å¯ç”¨ï¼Œæ— éœ€å¯¼å…¥ã€‚

---

## I/O å‡½æ•°

### print

å°†å€¼æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºå¹¶æ¢è¡Œã€‚

**ç­¾åï¼š**
```hemlock
print(...values): null
```

**å‚æ•°ï¼š**
- `...values` - ä»»æ„æ•°é‡çš„è¦æ‰“å°çš„å€¼

**è¿”å›å€¼ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
print("Hello, World!");
print(42);
print(3.14);
print(true);
print([1, 2, 3]);
print({ x: 10, y: 20 });

// å¤šä¸ªå€¼
print("x =", 10, "y =", 20);
```

**è¡Œä¸ºï¼š**
- å°†æ‰€æœ‰å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²
- å¤šä¸ªå€¼ä¹‹é—´ç”¨ç©ºæ ¼åˆ†éš”
- æœ«å°¾æ·»åŠ æ¢è¡Œç¬¦
- åˆ·æ–°æ ‡å‡†è¾“å‡º

---

### read_line

ä»æ ‡å‡†è¾“å…¥è¯»å–ä¸€è¡Œæ–‡æœ¬ï¼ˆç”¨æˆ·è¾“å…¥ï¼‰ã€‚

**ç­¾åï¼š**
```hemlock
read_line(): string | null
```

**å‚æ•°ï¼š** æ— 

**è¿”å›å€¼ï¼š**
- `string` - ä»æ ‡å‡†è¾“å…¥è¯»å–çš„è¡Œï¼ˆå·²å»é™¤æ¢è¡Œç¬¦ï¼‰
- `null` - åœ¨ EOFï¼ˆæ–‡ä»¶ç»“æŸ/è¾“å…¥ç»“æŸï¼‰æ—¶

**ç¤ºä¾‹ï¼š**
```hemlock
// ç®€å•æç¤º
print("What is your name?");
let name = read_line();
print("Hello, " + name + "!");

// è¯»å–æ•°å­—ï¼ˆéœ€è¦æ‰‹åŠ¨è§£æï¼‰
print("Enter a number:");
let input = read_line();
let num = parse_int(input);  // å‚è§ä¸‹é¢çš„ parse_int
print("Double:", num * 2);

// å¤„ç† EOF
let line = read_line();
if (line == null) {
    print("End of input");
}

// è¯»å–å¤šè¡Œ
print("Enter lines (Ctrl+D to stop):");
while (true) {
    let line = read_line();
    if (line == null) {
        break;
    }
    print("You said:", line);
}
```

**è¡Œä¸ºï¼š**
- é˜»å¡ç›´åˆ°ç”¨æˆ·æŒ‰ä¸‹å›è½¦
- å»é™¤å°¾éƒ¨çš„æ¢è¡Œç¬¦ï¼ˆ`\n`ï¼‰å’Œå›è½¦ç¬¦ï¼ˆ`\r`ï¼‰
- åœ¨ EOF æ—¶è¿”å› `null`ï¼ˆUnix ä¸Šä¸º Ctrl+Dï¼ŒWindows ä¸Šä¸º Ctrl+Zï¼‰
- ä»…ä»æ ‡å‡†è¾“å…¥è¯»å–ï¼ˆä¸ä»æ–‡ä»¶è¯»å–ï¼‰

**è§£æç”¨æˆ·è¾“å…¥ï¼š**

ç”±äº `read_line()` æ€»æ˜¯è¿”å›å­—ç¬¦ä¸²ï¼Œä½ éœ€è¦æ‰‹åŠ¨è§£ææ•°å­—è¾“å…¥ï¼š

```hemlock
// ç®€å•çš„æ•´æ•°è§£æå™¨
fn parse_int(s: string): i32 {
    let result: i32 = 0;
    let negative = false;
    let i = 0;

    if (s.length > 0 && s.char_at(0) == '-') {
        negative = true;
        i = 1;
    }

    while (i < s.length) {
        let c = s.char_at(i);
        let code: i32 = c;
        if (code >= 48 && code <= 57) {
            result = result * 10 + (code - 48);
        } else {
            break;
        }
        i = i + 1;
    }

    if (negative) {
        return -result;
    }
    return result;
}

// ä½¿ç”¨
print("Enter your age:");
let age = parse_int(read_line());
print("In 10 years you'll be", age + 10);
```

**å¦è¯·å‚é˜…ï¼š** [æ–‡ä»¶ API](#reference-file-api) ä»æ–‡ä»¶è¯»å–

---

### eprint

å°†å€¼æ‰“å°åˆ°æ ‡å‡†é”™è¯¯å¹¶æ¢è¡Œã€‚

**ç­¾åï¼š**
```hemlock
eprint(value: any): null
```

**å‚æ•°ï¼š**
- `value` - è¦æ‰“å°åˆ°æ ‡å‡†é”™è¯¯çš„å•ä¸ªå€¼

**è¿”å›å€¼ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
eprint("Error: file not found");
eprint(404);
eprint("Warning: " + message);

// å…¸å‹çš„é”™è¯¯å¤„ç†æ¨¡å¼
fn load_config(path: string) {
    if (!exists(path)) {
        eprint("Error: config file not found: " + path);
        return null;
    }
    // ...
}
```

**è¡Œä¸ºï¼š**
- æ‰“å°åˆ°æ ‡å‡†é”™è¯¯ï¼ˆstderrï¼‰
- æœ«å°¾æ·»åŠ æ¢è¡Œç¬¦
- åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼ˆä¸ `print` ä¸åŒï¼‰
- é€‚ç”¨äºä¸åº”ä¸æ­£å¸¸è¾“å‡ºæ··åˆçš„é”™è¯¯æ¶ˆæ¯

**ä¸ print çš„åŒºåˆ«ï¼š**
- `print()` â†’ stdoutï¼ˆæ­£å¸¸è¾“å‡ºï¼Œå¯ç”¨ `>` é‡å®šå‘ï¼‰
- `eprint()` â†’ stderrï¼ˆé”™è¯¯è¾“å‡ºï¼Œå¯ç”¨ `2>` é‡å®šå‘ï¼‰

```bash
# Shell ç¤ºä¾‹ï¼šåˆ†ç¦» stdout å’Œ stderr
./hemlock script.hml > output.txt 2> errors.txt
```

---

## ç±»å‹è‡ªçœ

### typeof

è·å–å€¼çš„ç±»å‹åç§°ã€‚

**ç­¾åï¼š**
```hemlock
typeof(value: any): string
```

**å‚æ•°ï¼š**
- `value` - ä»»æ„å€¼

**è¿”å›å€¼ï¼š** ç±»å‹åç§°å­—ç¬¦ä¸²

**ç¤ºä¾‹ï¼š**
```hemlock
print(typeof(42));              // "i32"
print(typeof(3.14));            // "f64"
print(typeof("hello"));         // "string"
print(typeof('A'));             // "rune"
print(typeof(true));            // "bool"
print(typeof(null));            // "null"
print(typeof([1, 2, 3]));       // "array"
print(typeof({ x: 10 }));       // "object"

// ç±»å‹åŒ–å¯¹è±¡
define Person { name: string }
let p: Person = { name: "Alice" };
print(typeof(p));               // "Person"

// å…¶ä»–ç±»å‹
print(typeof(alloc(10)));       // "ptr"
print(typeof(buffer(10)));      // "buffer"
print(typeof(open("file.txt"))); // "file"
```

**ç±»å‹åç§°ï¼š**
- åŸºæœ¬ç±»å‹ï¼š`"i8"`ã€`"i16"`ã€`"i32"`ã€`"i64"`ã€`"u8"`ã€`"u16"`ã€`"u32"`ã€`"u64"`ã€`"f32"`ã€`"f64"`ã€`"bool"`ã€`"string"`ã€`"rune"`ã€`"null"`
- å¤åˆç±»å‹ï¼š`"array"`ã€`"object"`ã€`"ptr"`ã€`"buffer"`ã€`"function"`
- ç‰¹æ®Šç±»å‹ï¼š`"file"`ã€`"task"`ã€`"channel"`
- è‡ªå®šä¹‰ç±»å‹ï¼šæ¥è‡ª `define` çš„ç”¨æˆ·å®šä¹‰ç±»å‹åç§°

**å¦è¯·å‚é˜…ï¼š** [ç±»å‹ç³»ç»Ÿ](#reference-type-system)

---

## å‘½ä»¤æ‰§è¡Œ

### exec

æ‰§è¡Œ shell å‘½ä»¤å¹¶æ•è·è¾“å‡ºã€‚

**ç­¾åï¼š**
```hemlock
exec(command: string): object
```

**å‚æ•°ï¼š**
- `command` - è¦æ‰§è¡Œçš„ shell å‘½ä»¤

**è¿”å›å€¼ï¼š** åŒ…å«ä»¥ä¸‹å­—æ®µçš„å¯¹è±¡ï¼š
- `output` (string) - å‘½ä»¤çš„æ ‡å‡†è¾“å‡º
- `exit_code` (i32) - é€€å‡ºçŠ¶æ€ç ï¼ˆ0 = æˆåŠŸï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let result = exec("echo hello");
print(result.output);      // "hello\n"
print(result.exit_code);   // 0

// æ£€æŸ¥é€€å‡ºçŠ¶æ€
let r = exec("grep pattern file.txt");
if (r.exit_code == 0) {
    print("Found:", r.output);
} else {
    print("Pattern not found");
}

// å¤„ç†å¤šè¡Œè¾“å‡º
let r2 = exec("ls -la");
let lines = r2.output.split("\n");
```

**è¡Œä¸ºï¼š**
- é€šè¿‡ `/bin/sh` æ‰§è¡Œå‘½ä»¤
- ä»…æ•è·æ ‡å‡†è¾“å‡ºï¼ˆæ ‡å‡†é”™è¯¯è¾“å‡ºåˆ°ç»ˆç«¯ï¼‰
- é˜»å¡ç›´åˆ°å‘½ä»¤å®Œæˆ
- å¦‚æœæ²¡æœ‰è¾“å‡ºåˆ™è¿”å›ç©ºå­—ç¬¦ä¸²

**é”™è¯¯å¤„ç†ï¼š**
```hemlock
try {
    let r = exec("nonexistent_command");
} catch (e) {
    print("Failed to execute:", e);
}
```

**å®‰å…¨è­¦å‘Šï¼š** å­˜åœ¨ shell æ³¨å…¥é£é™©ã€‚å§‹ç»ˆéªŒè¯/æ¸…ç†ç”¨æˆ·è¾“å…¥ã€‚

**é™åˆ¶ï¼š**
- æ— æ ‡å‡†é”™è¯¯æ•è·
- æ— æµå¼å¤„ç†
- æ— è¶…æ—¶
- æ— ä¿¡å·å¤„ç†

---

### exec_argv

ä½¿ç”¨æ˜¾å¼å‚æ•°æ•°ç»„æ‰§è¡Œå‘½ä»¤ï¼ˆæ—  shell è§£é‡Šï¼‰ã€‚

**ç­¾åï¼š**
```hemlock
exec_argv(argv: array): object
```

**å‚æ•°ï¼š**
- `argv` - å­—ç¬¦ä¸²æ•°ç»„ï¼š`[command, arg1, arg2, ...]`

**è¿”å›å€¼ï¼š** åŒ…å«ä»¥ä¸‹å­—æ®µçš„å¯¹è±¡ï¼š
- `output` (string) - å‘½ä»¤çš„æ ‡å‡†è¾“å‡º
- `exit_code` (i32) - é€€å‡ºçŠ¶æ€ç ï¼ˆ0 = æˆåŠŸï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
// ç®€å•å‘½ä»¤
let result = exec_argv(["ls", "-la"]);
print(result.output);

// åŒ…å«ç©ºæ ¼çš„å‚æ•°ï¼ˆå®‰å…¨ï¼ï¼‰
let r = exec_argv(["grep", "hello world", "file.txt"]);

// å¸¦å‚æ•°è¿è¡Œè„šæœ¬
let r2 = exec_argv(["python", "script.py", "--input", "data.json"]);
print(r2.exit_code);
```

**ä¸ exec çš„åŒºåˆ«ï¼š**
```hemlock
// exec() ä½¿ç”¨ shell - å¯¹ç”¨æˆ·è¾“å…¥ä¸å®‰å…¨
exec("ls " + user_input);  // Shell æ³¨å…¥é£é™©ï¼

// exec_argv() ç»•è¿‡ shell - å®‰å…¨
exec_argv(["ls", user_input]);  // ä¸å¯èƒ½æ³¨å…¥
```

**ä½•æ—¶ä½¿ç”¨ï¼š**
- å½“å‚æ•°åŒ…å«ç©ºæ ¼ã€å¼•å·æˆ–ç‰¹æ®Šå­—ç¬¦æ—¶
- å¤„ç†ç”¨æˆ·è¾“å…¥æ—¶ï¼ˆå®‰å…¨æ€§ï¼‰
- å½“éœ€è¦å¯é¢„æµ‹çš„å‚æ•°è§£ææ—¶

**å¦è¯·å‚é˜…ï¼š** ç®€å• shell å‘½ä»¤ä½¿ç”¨ `exec()`

---

## é”™è¯¯å¤„ç†

### throw

æŠ›å‡ºå¼‚å¸¸ã€‚

**ç­¾åï¼š**
```hemlock
throw expression
```

**å‚æ•°ï¼š**
- `expression` - è¦æŠ›å‡ºçš„å€¼ï¼ˆä»»æ„ç±»å‹ï¼‰

**è¿”å›å€¼ï¼š** æ°¸ä¸è¿”å›ï¼ˆè½¬ç§»æ§åˆ¶æƒï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
throw "error message";
throw 404;
throw { code: 500, message: "Internal error" };
throw null;
```

**å¦è¯·å‚é˜…ï¼š** try/catch/finally è¯­å¥

---

### panic

ç«‹å³ç»ˆæ­¢ç¨‹åºå¹¶æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼ˆä¸å¯æ¢å¤ï¼‰ã€‚

**ç­¾åï¼š**
```hemlock
panic(message?: any): never
```

**å‚æ•°ï¼š**
- `message`ï¼ˆå¯é€‰ï¼‰- è¦æ‰“å°çš„é”™è¯¯æ¶ˆæ¯

**è¿”å›å€¼ï¼š** æ°¸ä¸è¿”å›ï¼ˆç¨‹åºé€€å‡ºï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
panic();                          // é»˜è®¤ï¼š"panic!"
panic("unreachable code reached");
panic(42);

// å¸¸è§ç”¨ä¾‹
fn process_state(state: i32): string {
    if (state == 1) { return "ready"; }
    if (state == 2) { return "running"; }
    panic("invalid state: " + typeof(state));
}
```

**è¡Œä¸ºï¼š**
- å°†é”™è¯¯æ‰“å°åˆ°æ ‡å‡†é”™è¯¯ï¼š`panic: <message>`
- ä»¥ä»£ç  1 é€€å‡º
- **ä¸èƒ½**ç”¨ try/catch æ•è·
- ç”¨äº bug å’Œä¸å¯æ¢å¤çš„é”™è¯¯

**panic ä¸ throw çš„åŒºåˆ«ï¼š**
- `panic()` - ä¸å¯æ¢å¤çš„é”™è¯¯ï¼Œç«‹å³é€€å‡º
- `throw` - å¯æ¢å¤çš„é”™è¯¯ï¼Œå¯ä»¥è¢«æ•è·

---

### assert

æ–­è¨€æ¡ä»¶ä¸ºçœŸï¼Œå¦åˆ™ç»ˆæ­¢å¹¶æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ã€‚

**ç­¾åï¼š**
```hemlock
assert(condition: any, message?: string): null
```

**å‚æ•°ï¼š**
- `condition` - è¦æ£€æŸ¥æ˜¯å¦ä¸ºçœŸçš„å€¼
- `message`ï¼ˆå¯é€‰ï¼‰- æ–­è¨€å¤±è´¥æ—¶çš„è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯

**è¿”å›å€¼ï¼š** `null`ï¼ˆå¦‚æœæ–­è¨€é€šè¿‡ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
// åŸºæœ¬æ–­è¨€
assert(x > 0);
assert(name != null);
assert(arr.length > 0, "Array must not be empty");

// å¸¦è‡ªå®šä¹‰æ¶ˆæ¯
fn divide(a: i32, b: i32): f64 {
    assert(b != 0, "Division by zero");
    return a / b;
}

// éªŒè¯å‡½æ•°å‚æ•°
fn process_data(data: array) {
    assert(data != null, "data cannot be null");
    assert(data.length > 0, "data cannot be empty");
    // ...
}
```

**è¡Œä¸ºï¼š**
- å¦‚æœæ¡ä»¶ä¸ºçœŸï¼šè¿”å› `null`ï¼Œç»§ç»­æ‰§è¡Œ
- å¦‚æœæ¡ä»¶ä¸ºå‡ï¼šæ‰“å°é”™è¯¯å¹¶ä»¥ä»£ç  1 é€€å‡º
- å‡å€¼ï¼š`false`ã€`0`ã€`0.0`ã€`null`ã€`""`ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰
- çœŸå€¼ï¼šå…¶ä»–æ‰€æœ‰å€¼

**å¤±è´¥æ—¶çš„è¾“å‡ºï¼š**
```
Assertion failed: Array must not be empty
```

**ä½•æ—¶ä½¿ç”¨ï¼š**
- éªŒè¯å‡½æ•°å‰ç½®æ¡ä»¶
- åœ¨å¼€å‘æœŸé—´æ£€æŸ¥ä¸å˜é‡
- å°½æ—©æ•è·ç¨‹åºå‘˜é”™è¯¯

**assert ä¸ panic çš„åŒºåˆ«ï¼š**
- `assert(cond, msg)` - æ£€æŸ¥æ¡ä»¶ï¼Œå¦‚æœä¸ºå‡åˆ™å¤±è´¥
- `panic(msg)` - æ— æ¡ä»¶å¤±è´¥

---

## ä¿¡å·å¤„ç†

### signal

æ³¨å†Œæˆ–é‡ç½®ä¿¡å·å¤„ç†ç¨‹åºã€‚

**ç­¾åï¼š**
```hemlock
signal(signum: i32, handler: function | null): function | null
```

**å‚æ•°ï¼š**
- `signum` - ä¿¡å·ç¼–å·ï¼ˆä½¿ç”¨ `SIGINT` ç­‰å¸¸é‡ï¼‰
- `handler` - æ”¶åˆ°ä¿¡å·æ—¶è°ƒç”¨çš„å‡½æ•°ï¼Œæˆ– `null` é‡ç½®ä¸ºé»˜è®¤å€¼

**è¿”å›å€¼ï¼š** å…ˆå‰çš„å¤„ç†ç¨‹åºå‡½æ•°ï¼Œæˆ– `null`

**ç¤ºä¾‹ï¼š**
```hemlock
fn handle_interrupt(sig) {
    print("Caught SIGINT!");
}

signal(SIGINT, handle_interrupt);

// é‡ç½®ä¸ºé»˜è®¤
signal(SIGINT, null);
```

**å¤„ç†ç¨‹åºç­¾åï¼š**
```hemlock
fn handler(signum: i32) {
    // signum åŒ…å«ä¿¡å·ç¼–å·
}
```

**å¦è¯·å‚é˜…ï¼š**
- [ä¿¡å·å¸¸é‡](#ä¿¡å·å¸¸é‡)
- `raise()`

---

### raise

å‘å½“å‰è¿›ç¨‹å‘é€ä¿¡å·ã€‚

**ç­¾åï¼š**
```hemlock
raise(signum: i32): null
```

**å‚æ•°ï¼š**
- `signum` - è¦å‘é€çš„ä¿¡å·ç¼–å·

**è¿”å›å€¼ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
let count = 0;

fn increment(sig) {
    count = count + 1;
}

signal(SIGUSR1, increment);

raise(SIGUSR1);
raise(SIGUSR1);
print(count);  // 2
```

---

## å…¨å±€å˜é‡

### args

å‘½ä»¤è¡Œå‚æ•°æ•°ç»„ã€‚

**ç±»å‹ï¼š** å­—ç¬¦ä¸² `array`

**ç»“æ„ï¼š**
- `args[0]` - è„šæœ¬æ–‡ä»¶å
- `args[1..n]` - å‘½ä»¤è¡Œå‚æ•°

**ç¤ºä¾‹ï¼š**
```bash
# å‘½ä»¤ï¼š./hemlock script.hml hello world
```

```hemlock
print(args[0]);        // "script.hml"
print(args.length);    // 3
print(args[1]);        // "hello"
print(args[2]);        // "world"

// éå†å‚æ•°
let i = 1;
while (i < args.length) {
    print("Argument", i, ":", args[i]);
    i = i + 1;
}
```

**REPL è¡Œä¸ºï¼š** åœ¨ REPL ä¸­ï¼Œ`args.length` ä¸º 0ï¼ˆç©ºæ•°ç»„ï¼‰

---

## ä¿¡å·å¸¸é‡

æ ‡å‡† POSIX ä¿¡å·å¸¸é‡ï¼ˆi32 å€¼ï¼‰ï¼š

### ä¸­æ–­å’Œç»ˆæ­¢

| å¸¸é‡       | å€¼    | æè¿°                               |
|------------|-------|----------------------------------------|
| `SIGINT`   | 2     | æ¥è‡ªé”®ç›˜çš„ä¸­æ–­ï¼ˆCtrl+Cï¼‰               |
| `SIGTERM`  | 15    | ç»ˆæ­¢è¯·æ±‚                               |
| `SIGQUIT`  | 3     | æ¥è‡ªé”®ç›˜çš„é€€å‡ºï¼ˆCtrl+\ï¼‰               |
| `SIGHUP`   | 1     | åœ¨æ§åˆ¶ç»ˆç«¯ä¸Šæ£€æµ‹åˆ°æŒ‚æ–­                 |
| `SIGABRT`  | 6     | ä¸­æ­¢ä¿¡å·                               |

### ç”¨æˆ·å®šä¹‰

| å¸¸é‡       | å€¼    | æè¿°                     |
|------------|-------|--------------------------|
| `SIGUSR1`  | 10    | ç”¨æˆ·å®šä¹‰ä¿¡å· 1           |
| `SIGUSR2`  | 12    | ç”¨æˆ·å®šä¹‰ä¿¡å· 2           |

### è¿›ç¨‹æ§åˆ¶

| å¸¸é‡       | å€¼    | æè¿°                          |
|------------|-------|-------------------------------|
| `SIGALRM`  | 14    | é—¹é’Ÿå®šæ—¶å™¨                    |
| `SIGCHLD`  | 17    | å­è¿›ç¨‹çŠ¶æ€å˜åŒ–                |
| `SIGCONT`  | 18    | å¦‚æœåœæ­¢åˆ™ç»§ç»­                |
| `SIGSTOP`  | 19    | åœæ­¢è¿›ç¨‹ï¼ˆä¸èƒ½è¢«æ•è·ï¼‰        |
| `SIGTSTP`  | 20    | ç»ˆç«¯åœæ­¢ï¼ˆCtrl+Zï¼‰            |

### I/O

| å¸¸é‡       | å€¼    | æè¿°                           |
|------------|-------|--------------------------------|
| `SIGPIPE`  | 13    | ç®¡é“ç ´è£‚                       |
| `SIGTTIN`  | 21    | åå°ä»ç»ˆç«¯è¯»å–                 |
| `SIGTTOU`  | 22    | åå°å†™å…¥ç»ˆç«¯                   |

**ç¤ºä¾‹ï¼š**
```hemlock
fn handle_signal(sig) {
    if (sig == SIGINT) {
        print("Interrupt detected");
    }
    if (sig == SIGTERM) {
        print("Termination requested");
    }
}

signal(SIGINT, handle_signal);
signal(SIGTERM, handle_signal);
```

**æ³¨æ„ï¼š** `SIGKILL` (9) å’Œ `SIGSTOP` (19) ä¸èƒ½è¢«æ•è·æˆ–å¿½ç•¥ã€‚

---

## æ•°å­¦/ç®—æœ¯å‡½æ•°

### div

è¿”å›æµ®ç‚¹æ•°çš„å‘ä¸‹æ•´é™¤ã€‚

**ç­¾åï¼š**
```hemlock
div(a: number, b: number): f64
```

**å‚æ•°ï¼š**
- `a` - è¢«é™¤æ•°
- `b` - é™¤æ•°

**è¿”å›å€¼ï¼š** `a / b` çš„å‘ä¸‹å–æ•´ç»“æœï¼Œä½œä¸ºæµ®ç‚¹æ•° (f64)

**ç¤ºä¾‹ï¼š**
```hemlock
let result = div(7, 2);    // 3.0ï¼ˆä¸æ˜¯ 3.5ï¼‰
let result2 = div(10, 3);  // 3.0
let result3 = div(-7, 2);  // -4.0ï¼ˆå‘ä¸‹å–æ•´æœå‘è´Ÿæ— ç©·ï¼‰
```

**æ³¨æ„ï¼š** åœ¨ Hemlock ä¸­ï¼Œ`/` è¿ç®—ç¬¦æ€»æ˜¯è¿”å›æµ®ç‚¹æ•°ã€‚å½“éœ€è¦æ•´æ•°éƒ¨åˆ†ä½œä¸ºæµ®ç‚¹æ•°æ—¶ä½¿ç”¨ `div()`ï¼Œæˆ–è€…å½“éœ€è¦æ•´æ•°ç»“æœæ—¶ä½¿ç”¨ `divi()`ã€‚

---

### divi

è¿”å›æ•´æ•°çš„å‘ä¸‹æ•´é™¤ã€‚

**ç­¾åï¼š**
```hemlock
divi(a: number, b: number): i64
```

**å‚æ•°ï¼š**
- `a` - è¢«é™¤æ•°
- `b` - é™¤æ•°

**è¿”å›å€¼ï¼š** `a / b` çš„å‘ä¸‹å–æ•´ç»“æœï¼Œä½œä¸ºæ•´æ•° (i64)

**ç¤ºä¾‹ï¼š**
```hemlock
let result = divi(7, 2);    // 3
let result2 = divi(10, 3);  // 3
let result3 = divi(-7, 2);  // -4ï¼ˆå‘ä¸‹å–æ•´æœå‘è´Ÿæ— ç©·ï¼‰
```

**æ¯”è¾ƒï¼š**
```hemlock
print(7 / 2);      // 3.5ï¼ˆå¸¸è§„é™¤æ³•ï¼Œæ€»æ˜¯æµ®ç‚¹æ•°ï¼‰
print(div(7, 2));  // 3.0ï¼ˆå‘ä¸‹æ•´é™¤ï¼Œæµ®ç‚¹æ•°ç»“æœï¼‰
print(divi(7, 2)); // 3  ï¼ˆå‘ä¸‹æ•´é™¤ï¼Œæ•´æ•°ç»“æœï¼‰
```

---

## å†…å­˜ç®¡ç†å‡½æ•°

å‚è§ [å†…å­˜ API](#reference-memory-api) è·å–å®Œæ•´å‚è€ƒï¼š
- `alloc(size)` - åˆ†é…åŸå§‹å†…å­˜
- `free(ptr)` - é‡Šæ”¾å†…å­˜
- `buffer(size)` - åˆ†é…å®‰å…¨ç¼“å†²åŒº
- `memset(ptr, byte, size)` - å¡«å……å†…å­˜
- `memcpy(dest, src, size)` - å¤åˆ¶å†…å­˜
- `realloc(ptr, new_size)` - è°ƒæ•´åˆ†é…å¤§å°

### sizeof

è·å–ç±»å‹çš„å­—èŠ‚å¤§å°ã€‚

**ç­¾åï¼š**
```hemlock
sizeof(type): i32
```

**å‚æ•°ï¼š**
- `type` - ç±»å‹å¸¸é‡ï¼ˆ`i32`ã€`f64`ã€`ptr` ç­‰ï¼‰æˆ–ç±»å‹åç§°å­—ç¬¦ä¸²

**è¿”å›å€¼ï¼š** å­—èŠ‚å¤§å°ï¼Œä½œä¸º `i32`

**ç¤ºä¾‹ï¼š**
```hemlock
print(sizeof(i8));       // 1
print(sizeof(i16));      // 2
print(sizeof(i32));      // 4
print(sizeof(i64));      // 8
print(sizeof(f32));      // 4
print(sizeof(f64));      // 8
print(sizeof(ptr));      // 8
print(sizeof(rune));     // 4

// ä½¿ç”¨ç±»å‹åˆ«å
print(sizeof(byte));     // 1ï¼ˆä¸ u8 ç›¸åŒï¼‰
print(sizeof(integer));  // 4ï¼ˆä¸ i32 ç›¸åŒï¼‰
print(sizeof(number));   // 8ï¼ˆä¸ f64 ç›¸åŒï¼‰

// å­—ç¬¦ä¸²å½¢å¼ä¹Ÿå¯ä»¥
print(sizeof("i32"));    // 4
```

**æ”¯æŒçš„ç±»å‹ï¼š**
| ç±»å‹ | å¤§å° | åˆ«å |
|------|------|---------|
| `i8` | 1 | - |
| `i16` | 2 | - |
| `i32` | 4 | `integer` |
| `i64` | 8 | - |
| `u8` | 1 | `byte` |
| `u16` | 2 | - |
| `u32` | 4 | - |
| `u64` | 8 | - |
| `f32` | 4 | - |
| `f64` | 8 | `number` |
| `ptr` | 8 | - |
| `rune` | 4 | - |
| `bool` | 1 | - |

**å¦è¯·å‚é˜…ï¼š** `talloc()` ç”¨äºç±»å‹åŒ–åˆ†é…

---

### talloc

ä¸ºç±»å‹åŒ–æ•°ç»„åˆ†é…å†…å­˜ï¼ˆç±»å‹æ„ŸçŸ¥åˆ†é…ï¼‰ã€‚

**ç­¾åï¼š**
```hemlock
talloc(type, count: i32): ptr
```

**å‚æ•°ï¼š**
- `type` - ç±»å‹å¸¸é‡ï¼ˆ`i32`ã€`f64`ã€`ptr` ç­‰ï¼‰
- `count` - è¦åˆ†é…çš„å…ƒç´ æ•°é‡

**è¿”å›å€¼ï¼š** æŒ‡å‘å·²åˆ†é…å†…å­˜çš„ `ptr`ï¼Œå¤±è´¥æ—¶è¿”å› `null`

**ç¤ºä¾‹ï¼š**
```hemlock
// åˆ†é… 10 ä¸ª i32 çš„æ•°ç»„ï¼ˆ40 å­—èŠ‚ï¼‰
let int_arr = talloc(i32, 10);
ptr_write_i32(int_arr, 42);
ptr_write_i32(ptr_offset(int_arr, 1, 4), 100);

// åˆ†é… 5 ä¸ª f64 çš„æ•°ç»„ï¼ˆ40 å­—èŠ‚ï¼‰
let float_arr = talloc(f64, 5);

// åˆ†é… 100 å­—èŠ‚çš„æ•°ç»„
let byte_arr = talloc(u8, 100);

// åˆ«å¿˜äº†é‡Šæ”¾ï¼
free(int_arr);
free(float_arr);
free(byte_arr);
```

**ä¸ alloc çš„æ¯”è¾ƒï¼š**
```hemlock
// è¿™äº›æ˜¯ç­‰ä»·çš„ï¼š
let p1 = talloc(i32, 10);      // ç±»å‹æ„ŸçŸ¥ï¼š10 ä¸ª i32
let p2 = alloc(sizeof(i32) * 10);  // æ‰‹åŠ¨è®¡ç®—

// talloc æ›´æ¸…æ™°ï¼Œæ›´ä¸å®¹æ˜“å‡ºé”™
```

**é”™è¯¯å¤„ç†ï¼š**
- åˆ†é…å¤±è´¥æ—¶è¿”å› `null`
- å¦‚æœ count ä¸æ˜¯æ­£æ•°åˆ™é€€å‡ºå¹¶æŠ¥é”™
- æ£€æŸ¥å¤§å°æº¢å‡ºï¼ˆcount * element_sizeï¼‰

**å¦è¯·å‚é˜…ï¼š** `alloc()`ã€`sizeof()`ã€`free()`

---

## FFI æŒ‡é’ˆè¾…åŠ©å‡½æ•°

è¿™äº›å‡½æ•°å¸®åŠ©è¯»å†™åŸå§‹å†…å­˜ä¸­çš„ç±»å‹åŒ–å€¼ï¼Œå¯¹ FFI å’Œåº•å±‚å†…å­˜æ“ä½œå¾ˆæœ‰ç”¨ã€‚

### ptr_null

åˆ›å»ºç©ºæŒ‡é’ˆã€‚

**ç­¾åï¼š**
```hemlock
ptr_null(): ptr
```

**è¿”å›å€¼ï¼š** ç©ºæŒ‡é’ˆ

**ç¤ºä¾‹ï¼š**
```hemlock
let p = ptr_null();
if (p == null) {
    print("Pointer is null");
}
```

---

### ptr_offset

è®¡ç®—æŒ‡é’ˆåç§»ï¼ˆæŒ‡é’ˆç®—æœ¯ï¼‰ã€‚

**ç­¾åï¼š**
```hemlock
ptr_offset(ptr: ptr, index: i32, element_size: i32): ptr
```

**å‚æ•°ï¼š**
- `ptr` - åŸºæŒ‡é’ˆ
- `index` - å…ƒç´ ç´¢å¼•
- `element_size` - æ¯ä¸ªå…ƒç´ çš„å­—èŠ‚å¤§å°

**è¿”å›å€¼ï¼š** æŒ‡å‘ç»™å®šç´¢å¼•å¤„å…ƒç´ çš„æŒ‡é’ˆ

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = talloc(i32, 10);
ptr_write_i32(arr, 100);                      // arr[0] = 100
ptr_write_i32(ptr_offset(arr, 1, 4), 200);    // arr[1] = 200
ptr_write_i32(ptr_offset(arr, 2, 4), 300);    // arr[2] = 300

print(ptr_read_i32(ptr_offset(arr, 1, 4)));   // 200
free(arr);
```

---

### æŒ‡é’ˆè¯»å–å‡½æ•°

ä»å†…å­˜è¯»å–ç±»å‹åŒ–å€¼ã€‚

| å‡½æ•° | ç­¾å | è¿”å›å€¼ | æè¿° |
|----------|-----------|---------|-------------|
| `ptr_read_i8` | `(ptr)` | `i8` | è¯»å–æœ‰ç¬¦å· 8 ä½æ•´æ•° |
| `ptr_read_i16` | `(ptr)` | `i16` | è¯»å–æœ‰ç¬¦å· 16 ä½æ•´æ•° |
| `ptr_read_i32` | `(ptr)` | `i32` | è¯»å–æœ‰ç¬¦å· 32 ä½æ•´æ•° |
| `ptr_read_i64` | `(ptr)` | `i64` | è¯»å–æœ‰ç¬¦å· 64 ä½æ•´æ•° |
| `ptr_read_u8` | `(ptr)` | `u8` | è¯»å–æ— ç¬¦å· 8 ä½æ•´æ•° |
| `ptr_read_u16` | `(ptr)` | `u16` | è¯»å–æ— ç¬¦å· 16 ä½æ•´æ•° |
| `ptr_read_u32` | `(ptr)` | `u32` | è¯»å–æ— ç¬¦å· 32 ä½æ•´æ•° |
| `ptr_read_u64` | `(ptr)` | `u64` | è¯»å–æ— ç¬¦å· 64 ä½æ•´æ•° |
| `ptr_read_f32` | `(ptr)` | `f32` | è¯»å– 32 ä½æµ®ç‚¹æ•° |
| `ptr_read_f64` | `(ptr)` | `f64` | è¯»å– 64 ä½æµ®ç‚¹æ•° |
| `ptr_read_ptr` | `(ptr)` | `ptr` | è¯»å–æŒ‡é’ˆå€¼ |

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(8);
ptr_write_f64(p, 3.14159);
let value = ptr_read_f64(p);
print(value);  // 3.14159
free(p);
```

---

### æŒ‡é’ˆå†™å…¥å‡½æ•°

å‘å†…å­˜å†™å…¥ç±»å‹åŒ–å€¼ã€‚

| å‡½æ•° | ç­¾å | è¿”å›å€¼ | æè¿° |
|----------|-----------|---------|-------------|
| `ptr_write_i8` | `(ptr, value)` | `null` | å†™å…¥æœ‰ç¬¦å· 8 ä½æ•´æ•° |
| `ptr_write_i16` | `(ptr, value)` | `null` | å†™å…¥æœ‰ç¬¦å· 16 ä½æ•´æ•° |
| `ptr_write_i32` | `(ptr, value)` | `null` | å†™å…¥æœ‰ç¬¦å· 32 ä½æ•´æ•° |
| `ptr_write_i64` | `(ptr, value)` | `null` | å†™å…¥æœ‰ç¬¦å· 64 ä½æ•´æ•° |
| `ptr_write_u8` | `(ptr, value)` | `null` | å†™å…¥æ— ç¬¦å· 8 ä½æ•´æ•° |
| `ptr_write_u16` | `(ptr, value)` | `null` | å†™å…¥æ— ç¬¦å· 16 ä½æ•´æ•° |
| `ptr_write_u32` | `(ptr, value)` | `null` | å†™å…¥æ— ç¬¦å· 32 ä½æ•´æ•° |
| `ptr_write_u64` | `(ptr, value)` | `null` | å†™å…¥æ— ç¬¦å· 64 ä½æ•´æ•° |
| `ptr_write_f32` | `(ptr, value)` | `null` | å†™å…¥ 32 ä½æµ®ç‚¹æ•° |
| `ptr_write_f64` | `(ptr, value)` | `null` | å†™å…¥ 64 ä½æµ®ç‚¹æ•° |
| `ptr_write_ptr` | `(ptr, value)` | `null` | å†™å…¥æŒ‡é’ˆå€¼ |

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(4);
ptr_write_i32(p, 42);
print(ptr_read_i32(p));  // 42
free(p);
```

---

### ç¼“å†²åŒº/æŒ‡é’ˆè½¬æ¢

#### buffer_ptr

ä»ç¼“å†²åŒºè·å–åŸå§‹æŒ‡é’ˆã€‚

**ç­¾åï¼š**
```hemlock
buffer_ptr(buf: buffer): ptr
```

**ç¤ºä¾‹ï¼š**
```hemlock
let buf = buffer(64);
let p = buffer_ptr(buf);
// ç°åœ¨ p æŒ‡å‘ä¸ buf ç›¸åŒçš„å†…å­˜
```

#### ptr_to_buffer

å›´ç»•åŸå§‹æŒ‡é’ˆåˆ›å»ºç¼“å†²åŒºåŒ…è£…å™¨ã€‚

**ç­¾åï¼š**
```hemlock
ptr_to_buffer(ptr: ptr, size: i32): buffer
```

**ç¤ºä¾‹ï¼š**
```hemlock
let p = alloc(64);
let buf = ptr_to_buffer(p, 64);
buf[0] = 65;  // ç°åœ¨æœ‰è¾¹ç•Œæ£€æŸ¥
// æ³¨æ„ï¼šé‡Šæ”¾ buf å°†é‡Šæ”¾åº•å±‚å†…å­˜
```

---

## æ–‡ä»¶ I/O å‡½æ•°

å‚è§ [æ–‡ä»¶ API](#reference-file-api) è·å–å®Œæ•´å‚è€ƒï¼š
- `open(path, mode?)` - æ‰“å¼€æ–‡ä»¶

---

## å¹¶å‘å‡½æ•°

å‚è§ [å¹¶å‘ API](#reference-concurrency-api) è·å–å®Œæ•´å‚è€ƒï¼š
- `spawn(fn, args...)` - æ´¾ç”Ÿä»»åŠ¡
- `join(task)` - ç­‰å¾…ä»»åŠ¡
- `detach(task)` - åˆ†ç¦»ä»»åŠ¡
- `channel(capacity)` - åˆ›å»ºé€šé“

### apply

ä½¿ç”¨å‚æ•°æ•°ç»„åŠ¨æ€è°ƒç”¨å‡½æ•°ã€‚

**ç­¾åï¼š**
```hemlock
apply(fn: function, args: array): any
```

**å‚æ•°ï¼š**
- `fn` - è¦è°ƒç”¨çš„å‡½æ•°
- `args` - è¦ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°æ•°ç»„

**è¿”å›å€¼ï¼š** è¢«è°ƒç”¨å‡½æ•°çš„è¿”å›å€¼

**ç¤ºä¾‹ï¼š**
```hemlock
fn add(a, b) {
    return a + b;
}

// ä½¿ç”¨å‚æ•°æ•°ç»„è°ƒç”¨
let result = apply(add, [2, 3]);
print(result);  // 5

// åŠ¨æ€åˆ†æ´¾
let operations = {
    add: fn(a, b) { return a + b; },
    mul: fn(a, b) { return a * b; },
    sub: fn(a, b) { return a - b; }
};

fn calculate(op: string, args: array) {
    return apply(operations[op], args);
}

print(calculate("add", [10, 5]));  // 15
print(calculate("mul", [10, 5]));  // 50
print(calculate("sub", [10, 5]));  // 5

// å¯å˜å‚æ•°
fn sum(...nums) {
    let total = 0;
    for (n in nums) {
        total = total + n;
    }
    return total;
}

let numbers = [1, 2, 3, 4, 5];
print(apply(sum, numbers));  // 15
```

**ç”¨ä¾‹ï¼š**
- åŸºäºè¿è¡Œæ—¶å€¼çš„åŠ¨æ€å‡½æ•°åˆ†æ´¾
- è°ƒç”¨å…·æœ‰å¯å˜å‚æ•°åˆ—è¡¨çš„å‡½æ•°
- å®ç°é«˜é˜¶å·¥å…·ï¼ˆmapã€filter ç­‰ï¼‰
- æ’ä»¶/æ‰©å±•ç³»ç»Ÿ

---

### select

ç­‰å¾…å¤šä¸ªé€šé“çš„æ•°æ®ï¼Œå½“ä»»ä¸€é€šé“æœ‰æ•°æ®æ—¶è¿”å›ã€‚

**ç­¾åï¼š**
```hemlock
select(channels: array, timeout_ms?: i32): object | null
```

**å‚æ•°ï¼š**
- `channels` - é€šé“å€¼æ•°ç»„
- `timeout_ms`ï¼ˆå¯é€‰ï¼‰- è¶…æ—¶æ¯«ç§’æ•°ï¼ˆ-1 æˆ–çœç•¥è¡¨ç¤ºæ— é™ç­‰å¾…ï¼‰

**è¿”å›å€¼ï¼š**
- `{ channel, value }` - åŒ…å«æœ‰æ•°æ®çš„é€šé“å’Œæ¥æ”¶åˆ°çš„å€¼çš„å¯¹è±¡
- `null` - è¶…æ—¶æ—¶

**ç¤ºä¾‹ï¼š**
```hemlock
let ch1 = channel(1);
let ch2 = channel(1);

// ç”Ÿäº§è€…ä»»åŠ¡
spawn(fn() {
    sleep(100);
    ch1.send("from channel 1");
});

spawn(fn() {
    sleep(50);
    ch2.send("from channel 2");
});

// ç­‰å¾…ç¬¬ä¸€æ¡æ¶ˆæ¯
let result = select([ch1, ch2]);
print(result.value);  // "from channel 2"ï¼ˆå…ˆåˆ°è¾¾ï¼‰

// å¸¦è¶…æ—¶
let result2 = select([ch1, ch2], 1000);  // ç­‰å¾…æœ€å¤š 1 ç§’
if (result2 == null) {
    print("Timeout - no data received");
} else {
    print("Received:", result2.value);
}

// è¿ç»­ select å¾ªç¯
while (true) {
    let msg = select([ch1, ch2], 5000);
    if (msg == null) {
        print("No activity for 5 seconds");
        break;
    }
    print("Got message:", msg.value);
}
```

**è¡Œä¸ºï¼š**
- é˜»å¡ç›´åˆ°ä¸€ä¸ªé€šé“æœ‰æ•°æ®æˆ–è¶…æ—¶åˆ°æœŸ
- å¦‚æœé€šé“å·²æœ‰æ•°æ®åˆ™ç«‹å³è¿”å›
- å¦‚æœé€šé“å·²å…³é—­ä¸”ä¸ºç©ºï¼Œè¿”å› `{ channel, value: null }`
- æŒ‰é¡ºåºè½®è¯¢é€šé“ï¼ˆç¬¬ä¸€ä¸ªå°±ç»ªçš„é€šé“è·èƒœï¼‰

**ç”¨ä¾‹ï¼š**
- å¤šè·¯å¤ç”¨å¤šä¸ªç”Ÿäº§è€…
- åœ¨é€šé“æ“ä½œä¸Šå®ç°è¶…æ—¶
- æ„å»ºå…·æœ‰å¤šä¸ªæºçš„äº‹ä»¶å¾ªç¯

---

## æ€»ç»“è¡¨

### å‡½æ•°

| å‡½æ•°       | ç±»åˆ«            | è¿”å›å€¼       | æè¿°                            |
|------------|-----------------|--------------|----------------------------------|
| `print`    | I/O             | `null`       | æ‰“å°åˆ°æ ‡å‡†è¾“å‡º                   |
| `read_line`| I/O             | `string?`    | ä»æ ‡å‡†è¾“å…¥è¯»å–è¡Œ                 |
| `eprint`   | I/O             | `null`       | æ‰“å°åˆ°æ ‡å‡†é”™è¯¯                   |
| `typeof`   | ç±»å‹            | `string`     | è·å–ç±»å‹åç§°                     |
| `exec`     | å‘½ä»¤            | `object`     | æ‰§è¡Œ shell å‘½ä»¤                  |
| `exec_argv`| å‘½ä»¤            | `object`     | ä½¿ç”¨å‚æ•°æ•°ç»„æ‰§è¡Œ                 |
| `assert`   | é”™è¯¯            | `null`       | æ–­è¨€æ¡ä»¶æˆ–é€€å‡º                   |
| `panic`    | é”™è¯¯            | `never`      | ä¸å¯æ¢å¤çš„é”™è¯¯ï¼ˆé€€å‡ºï¼‰           |
| `signal`   | ä¿¡å·            | `function?`  | æ³¨å†Œä¿¡å·å¤„ç†ç¨‹åº                 |
| `raise`    | ä¿¡å·            | `null`       | å‘è¿›ç¨‹å‘é€ä¿¡å·                   |
| `alloc`    | å†…å­˜            | `ptr`        | åˆ†é…åŸå§‹å†…å­˜                     |
| `talloc`   | å†…å­˜            | `ptr`        | ç±»å‹åŒ–åˆ†é…                       |
| `sizeof`   | å†…å­˜            | `i32`        | è·å–ç±»å‹å­—èŠ‚å¤§å°                 |
| `free`     | å†…å­˜            | `null`       | é‡Šæ”¾å†…å­˜                         |
| `buffer`   | å†…å­˜            | `buffer`     | åˆ†é…å®‰å…¨ç¼“å†²åŒº                   |
| `memset`   | å†…å­˜            | `null`       | å¡«å……å†…å­˜                         |
| `memcpy`   | å†…å­˜            | `null`       | å¤åˆ¶å†…å­˜                         |
| `realloc`  | å†…å­˜            | `ptr`        | è°ƒæ•´åˆ†é…å¤§å°                     |
| `open`     | æ–‡ä»¶ I/O        | `file`       | æ‰“å¼€æ–‡ä»¶                         |
| `spawn`    | å¹¶å‘            | `task`       | æ´¾ç”Ÿå¹¶å‘ä»»åŠ¡                     |
| `join`     | å¹¶å‘            | `any`        | ç­‰å¾…ä»»åŠ¡ç»“æœ                     |
| `detach`   | å¹¶å‘            | `null`       | åˆ†ç¦»ä»»åŠ¡                         |
| `channel`  | å¹¶å‘            | `channel`    | åˆ›å»ºé€šä¿¡é€šé“                     |
| `select`   | å¹¶å‘            | `object?`    | ç­‰å¾…å¤šä¸ªé€šé“                     |
| `apply`    | å‡½æ•°            | `any`        | ä½¿ç”¨å‚æ•°æ•°ç»„è°ƒç”¨å‡½æ•°             |

### å…¨å±€å˜é‡

| å˜é‡       | ç±»å‹     | æè¿°                              |
|------------|----------|-----------------------------------|
| `args`     | `array`  | å‘½ä»¤è¡Œå‚æ•°                        |

### å¸¸é‡

| å¸¸é‡       | ç±»å‹  | ç±»åˆ«   | å€¼    | æè¿°                      |
|------------|-------|--------|-------|---------------------------|
| `SIGINT`   | `i32` | ä¿¡å·   | 2     | é”®ç›˜ä¸­æ–­                  |
| `SIGTERM`  | `i32` | ä¿¡å·   | 15    | ç»ˆæ­¢è¯·æ±‚                  |
| `SIGQUIT`  | `i32` | ä¿¡å·   | 3     | é”®ç›˜é€€å‡º                  |
| `SIGHUP`   | `i32` | ä¿¡å·   | 1     | æŒ‚æ–­                      |
| `SIGABRT`  | `i32` | ä¿¡å·   | 6     | ä¸­æ­¢                      |
| `SIGUSR1`  | `i32` | ä¿¡å·   | 10    | ç”¨æˆ·å®šä¹‰ 1                |
| `SIGUSR2`  | `i32` | ä¿¡å·   | 12    | ç”¨æˆ·å®šä¹‰ 2                |
| `SIGALRM`  | `i32` | ä¿¡å·   | 14    | é—¹é’Ÿå®šæ—¶å™¨                |
| `SIGCHLD`  | `i32` | ä¿¡å·   | 17    | å­è¿›ç¨‹çŠ¶æ€å˜åŒ–            |
| `SIGCONT`  | `i32` | ä¿¡å·   | 18    | ç»§ç»­                      |
| `SIGSTOP`  | `i32` | ä¿¡å·   | 19    | åœæ­¢ï¼ˆä¸å¯æ•è·ï¼‰          |
| `SIGTSTP`  | `i32` | ä¿¡å·   | 20    | ç»ˆç«¯åœæ­¢                  |
| `SIGPIPE`  | `i32` | ä¿¡å·   | 13    | ç®¡é“ç ´è£‚                  |
| `SIGTTIN`  | `i32` | ä¿¡å·   | 21    | åå°ç»ˆç«¯è¯»å–              |
| `SIGTTOU`  | `i32` | ä¿¡å·   | 22    | åå°ç»ˆç«¯å†™å…¥              |

---

## å¦è¯·å‚é˜…

- [ç±»å‹ç³»ç»Ÿ](#reference-type-system) - ç±»å‹å’Œè½¬æ¢
- [å†…å­˜ API](#reference-memory-api) - å†…å­˜åˆ†é…å‡½æ•°
- [æ–‡ä»¶ API](#reference-file-api) - æ–‡ä»¶ I/O å‡½æ•°
- [å¹¶å‘ API](#reference-concurrency-api) - å¼‚æ­¥/å¹¶å‘å‡½æ•°
- [å­—ç¬¦ä¸² API](#reference-string-api) - å­—ç¬¦ä¸²æ–¹æ³•
- [æ•°ç»„ API](#reference-array-api) - æ•°ç»„æ–¹æ³•


--------------------------------------------------------------------------------
## å­—ç¬¦ä¸² API
--------------------------------------------------------------------------------

# å­—ç¬¦ä¸² API å‚è€ƒ

Hemlock å­—ç¬¦ä¸²ç±»å‹åŠå…¨éƒ¨ 19 ä¸ªå­—ç¬¦ä¸²æ–¹æ³•çš„å®Œæ•´å‚è€ƒã€‚

---

## æ¦‚è¿°

Hemlock ä¸­çš„å­—ç¬¦ä¸²æ˜¯ **UTF-8 ç¼–ç ã€å¯å˜ã€å †åˆ†é…**çš„åºåˆ—ï¼Œå…·æœ‰å®Œæ•´çš„ Unicode æ”¯æŒã€‚æ‰€æœ‰æ“ä½œéƒ½åŸºäº**ç ç‚¹**ï¼ˆå­—ç¬¦ï¼‰è€Œéå­—èŠ‚ã€‚

**ä¸»è¦ç‰¹æ€§ï¼š**
- UTF-8 ç¼–ç  (U+0000 åˆ° U+10FFFF)
- å¯å˜ï¼ˆå¯ä»¥åŸåœ°ä¿®æ”¹å­—ç¬¦ï¼‰
- åŸºäºç ç‚¹çš„ç´¢å¼•
- 19 ä¸ªå†…ç½®æ–¹æ³•
- ä½¿ç”¨ `+` è¿ç®—ç¬¦è‡ªåŠ¨è¿æ¥

---

## å­—ç¬¦ä¸²ç±»å‹

**ç±»å‹ï¼š** `string`

**å±æ€§ï¼š**
- `.length` - ç ç‚¹ï¼ˆå­—ç¬¦ï¼‰æ•°é‡
- `.byte_length` - UTF-8 å­—èŠ‚æ•°é‡

**å­—é¢é‡è¯­æ³•ï¼š** åŒå¼•å· `"text"`

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello";
print(s.length);        // 5 (codepoints)
print(s.byte_length);   // 5 (bytes)

let emoji = "ğŸš€";
print(emoji.length);        // 1 (one codepoint)
print(emoji.byte_length);   // 4 (four UTF-8 bytes)
```

---

## ç´¢å¼•

å­—ç¬¦ä¸²æ”¯æŒä½¿ç”¨ `[]` è¿›è¡ŒåŸºäºç ç‚¹çš„ç´¢å¼•ï¼š

**è¯»å–è®¿é—®ï¼š**
```hemlock
let s = "hello";
let ch = s[0];          // Returns rune 'h'
```

**å†™å…¥è®¿é—®ï¼š**
```hemlock
let s = "hello";
s[0] = 'H';             // Mutate with rune (now "Hello")
```

**UTF-8 ç¤ºä¾‹ï¼š**
```hemlock
let text = "HiğŸš€!";
print(text[0]);         // 'H'
print(text[1]);         // 'i'
print(text[2]);         // 'ğŸš€' (one codepoint)
print(text[3]);         // '!'
```

---

## è¿æ¥

ä½¿ç”¨ `+` è¿ç®—ç¬¦è¿æ¥å­—ç¬¦ä¸²å’Œ runeï¼š

**å­—ç¬¦ä¸² + å­—ç¬¦ä¸²ï¼š**
```hemlock
let s = "hello" + " " + "world";  // "hello world"
let msg = "Count: " + typeof(42); // "Count: 42"
```

**å­—ç¬¦ä¸² + Runeï¼š**
```hemlock
let greeting = "Hello" + '!';      // "Hello!"
let decorated = "Text" + 'âœ“';      // "Textâœ“"
```

**Rune + å­—ç¬¦ä¸²ï¼š**
```hemlock
let prefix = '>' + " Message";     // "> Message"
let bullet = 'â€¢' + " Item";        // "â€¢ Item"
```

**å¤šé‡è¿æ¥ï¼š**
```hemlock
let msg = "Hi " + 'ğŸ‘‹' + " World " + 'ğŸŒ';  // "Hi ğŸ‘‹ World ğŸŒ"
```

---

## å­—ç¬¦ä¸²å±æ€§

### .length

è·å– Unicode ç ç‚¹ï¼ˆå­—ç¬¦ï¼‰æ•°é‡ã€‚

**ç±»å‹ï¼š** `i32`

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello";
print(s.length);        // 5

let emoji = "ğŸš€";
print(emoji.length);    // 1 (one codepoint)

let text = "Hello ğŸŒ!";
print(text.length);     // 8 (7 ASCII + 1 emoji)
```

---

### .byte_length

è·å– UTF-8 å­—èŠ‚æ•°é‡ã€‚

**ç±»å‹ï¼š** `i32`

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello";
print(s.byte_length);   // 5 (1 byte per ASCII char)

let emoji = "ğŸš€";
print(emoji.byte_length); // 4 (emoji is 4 UTF-8 bytes)

let text = "Hello ğŸŒ!";
print(text.byte_length);  // 11 (7 ASCII + 4 for emoji)
```

---

## å­—ç¬¦ä¸²æ–¹æ³•

### å­å­—ç¬¦ä¸²å’Œåˆ‡ç‰‡

#### substr

æŒ‰ä½ç½®å’Œé•¿åº¦æå–å­å­—ç¬¦ä¸²ã€‚

**ç­¾åï¼š**
```hemlock
string.substr(start: i32, length: i32): string
```

**å‚æ•°ï¼š**
- `start` - èµ·å§‹ç ç‚¹ç´¢å¼•ï¼ˆä» 0 å¼€å§‹ï¼‰
- `length` - è¦æå–çš„ç ç‚¹æ•°é‡

**è¿”å›å€¼ï¼š** æ–°å­—ç¬¦ä¸²

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello world";
let sub = s.substr(6, 5);       // "world"
let first = s.substr(0, 5);     // "hello"

// UTF-8 example
let text = "HiğŸš€!";
let emoji = text.substr(2, 1);  // "ğŸš€"
```

---

#### slice

æŒ‰èŒƒå›´æå–å­å­—ç¬¦ä¸²ï¼ˆç»“æŸä½ç½®ä¸åŒ…å«ï¼‰ã€‚

**ç­¾åï¼š**
```hemlock
string.slice(start: i32, end: i32): string
```

**å‚æ•°ï¼š**
- `start` - èµ·å§‹ç ç‚¹ç´¢å¼•ï¼ˆä» 0 å¼€å§‹ï¼‰
- `end` - ç»“æŸç ç‚¹ç´¢å¼•ï¼ˆä¸åŒ…å«ï¼‰

**è¿”å›å€¼ï¼š** æ–°å­—ç¬¦ä¸²

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello world";
let sub = s.slice(0, 5);        // "hello"
let world = s.slice(6, 11);     // "world"

// UTF-8 example
let text = "HiğŸš€!";
let first_three = text.slice(0, 3);  // "HiğŸš€"
```

---

### æœç´¢å’ŒæŸ¥æ‰¾

#### find

æŸ¥æ‰¾å­å­—ç¬¦ä¸²çš„ç¬¬ä¸€æ¬¡å‡ºç°ã€‚

**ç­¾åï¼š**
```hemlock
string.find(needle: string): i32
```

**å‚æ•°ï¼š**
- `needle` - è¦æœç´¢çš„å­å­—ç¬¦ä¸²

**è¿”å›å€¼ï¼š** ç¬¬ä¸€æ¬¡å‡ºç°çš„ç ç‚¹ç´¢å¼•ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› `-1`

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello world";
let pos = s.find("world");      // 6
let pos2 = s.find("foo");       // -1 (not found)
let pos3 = s.find("l");         // 2 (first 'l')
```

---

#### contains

æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«å­å­—ç¬¦ä¸²ã€‚

**ç­¾åï¼š**
```hemlock
string.contains(needle: string): bool
```

**å‚æ•°ï¼š**
- `needle` - è¦æœç´¢çš„å­å­—ç¬¦ä¸²

**è¿”å›å€¼ï¼š** å¦‚æœæ‰¾åˆ°è¿”å› `true`ï¼Œå¦åˆ™è¿”å› `false`

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello world";
let has = s.contains("world");  // true
let has2 = s.contains("foo");   // false
```

---

### åˆ†å‰²å’Œè¿æ¥

#### split

æŒ‰åˆ†éš”ç¬¦å°†å­—ç¬¦ä¸²åˆ†å‰²ä¸ºæ•°ç»„ã€‚

**ç­¾åï¼š**
```hemlock
string.split(delimiter: string): array
```

**å‚æ•°ï¼š**
- `delimiter` - åˆ†å‰²ä¾æ®çš„å­—ç¬¦ä¸²

**è¿”å›å€¼ï¼š** å­—ç¬¦ä¸²æ•°ç»„

**ç¤ºä¾‹ï¼š**
```hemlock
let csv = "a,b,c";
let parts = csv.split(",");     // ["a", "b", "c"]

let path = "/usr/local/bin";
let dirs = path.split("/");     // ["", "usr", "local", "bin"]

let text = "hello world foo";
let words = text.split(" ");    // ["hello", "world", "foo"]
```

---

#### trim

ç§»é™¤é¦–å°¾ç©ºç™½å­—ç¬¦ã€‚

**ç­¾åï¼š**
```hemlock
string.trim(): string
```

**è¿”å›å€¼ï¼š** ç§»é™¤ç©ºç™½åçš„æ–°å­—ç¬¦ä¸²

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "  hello  ";
let clean = s.trim();           // "hello"

let text = "\n\t  world  \n";
let clean2 = text.trim();       // "world"
```

---

### å¤§å°å†™è½¬æ¢

#### to_upper

å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¤§å†™ã€‚

**ç­¾åï¼š**
```hemlock
string.to_upper(): string
```

**è¿”å›å€¼ï¼š** å¤§å†™çš„æ–°å­—ç¬¦ä¸²

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello world";
let upper = s.to_upper();       // "HELLO WORLD"

let mixed = "HeLLo";
let upper2 = mixed.to_upper();  // "HELLO"
```

---

#### to_lower

å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå°å†™ã€‚

**ç­¾åï¼š**
```hemlock
string.to_lower(): string
```

**è¿”å›å€¼ï¼š** å°å†™çš„æ–°å­—ç¬¦ä¸²

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "HELLO WORLD";
let lower = s.to_lower();       // "hello world"

let mixed = "HeLLo";
let lower2 = mixed.to_lower();  // "hello"
```

---

### å‰ç¼€å’Œåç¼€

#### starts_with

æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä»¥æŒ‡å®šå‰ç¼€å¼€å§‹ã€‚

**ç­¾åï¼š**
```hemlock
string.starts_with(prefix: string): bool
```

**å‚æ•°ï¼š**
- `prefix` - è¦æ£€æŸ¥çš„å‰ç¼€

**è¿”å›å€¼ï¼š** å¦‚æœå­—ç¬¦ä¸²ä»¥è¯¥å‰ç¼€å¼€å§‹è¿”å› `true`ï¼Œå¦åˆ™è¿”å› `false`

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello world";
let starts = s.starts_with("hello");  // true
let starts2 = s.starts_with("world"); // false
```

---

#### ends_with

æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä»¥æŒ‡å®šåç¼€ç»“æŸã€‚

**ç­¾åï¼š**
```hemlock
string.ends_with(suffix: string): bool
```

**å‚æ•°ï¼š**
- `suffix` - è¦æ£€æŸ¥çš„åç¼€

**è¿”å›å€¼ï¼š** å¦‚æœå­—ç¬¦ä¸²ä»¥è¯¥åç¼€ç»“æŸè¿”å› `true`ï¼Œå¦åˆ™è¿”å› `false`

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello world";
let ends = s.ends_with("world");      // true
let ends2 = s.ends_with("hello");     // false
```

---

### æ›¿æ¢

#### replace

æ›¿æ¢å­å­—ç¬¦ä¸²çš„ç¬¬ä¸€æ¬¡å‡ºç°ã€‚

**ç­¾åï¼š**
```hemlock
string.replace(old: string, new: string): string
```

**å‚æ•°ï¼š**
- `old` - è¦æ›¿æ¢çš„å­å­—ç¬¦ä¸²
- `new` - æ›¿æ¢å­—ç¬¦ä¸²

**è¿”å›å€¼ï¼š** æ›¿æ¢ç¬¬ä¸€æ¬¡å‡ºç°åçš„æ–°å­—ç¬¦ä¸²

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello world";
let s2 = s.replace("world", "there");  // "hello there"

let text = "foo foo foo";
let text2 = text.replace("foo", "bar"); // "bar foo foo" (only first)
```

---

#### replace_all

æ›¿æ¢å­å­—ç¬¦ä¸²çš„æ‰€æœ‰å‡ºç°ã€‚

**ç­¾åï¼š**
```hemlock
string.replace_all(old: string, new: string): string
```

**å‚æ•°ï¼š**
- `old` - è¦æ›¿æ¢çš„å­å­—ç¬¦ä¸²
- `new` - æ›¿æ¢å­—ç¬¦ä¸²

**è¿”å›å€¼ï¼š** æ›¿æ¢æ‰€æœ‰å‡ºç°åçš„æ–°å­—ç¬¦ä¸²

**ç¤ºä¾‹ï¼š**
```hemlock
let text = "foo foo foo";
let text2 = text.replace_all("foo", "bar"); // "bar bar bar"

let s = "hello world hello";
let s2 = s.replace_all("hello", "hi");      // "hi world hi"
```

---

### é‡å¤

#### repeat

å°†å­—ç¬¦ä¸²é‡å¤ n æ¬¡ã€‚

**ç­¾åï¼š**
```hemlock
string.repeat(count: i32): string
```

**å‚æ•°ï¼š**
- `count` - é‡å¤æ¬¡æ•°

**è¿”å›å€¼ï¼š** é‡å¤ count æ¬¡åçš„æ–°å­—ç¬¦ä¸²

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "ha";
let repeated = s.repeat(3);     // "hahaha"

let line = "-";
let separator = line.repeat(40); // "----------------------------------------"
```

---

### å­—ç¬¦è®¿é—®

#### char_at

è·å–æŒ‡å®šç´¢å¼•å¤„çš„ Unicode ç ç‚¹ã€‚

**ç­¾åï¼š**
```hemlock
string.char_at(index: i32): rune
```

**å‚æ•°ï¼š**
- `index` - ç ç‚¹ç´¢å¼•ï¼ˆä» 0 å¼€å§‹ï¼‰

**è¿”å›å€¼ï¼š** Runeï¼ˆUnicode ç ç‚¹ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello";
let ch = s.char_at(0);          // 'h'
let ch2 = s.char_at(1);         // 'e'

// UTF-8 example
let emoji = "ğŸš€";
let ch3 = emoji.char_at(0);     // U+1F680 (rocket)
```

---

#### chars

å°†å­—ç¬¦ä¸²è½¬æ¢ä¸º rune æ•°ç»„ã€‚

**ç­¾åï¼š**
```hemlock
string.chars(): array
```

**è¿”å›å€¼ï¼š** runeï¼ˆç ç‚¹ï¼‰æ•°ç»„

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello";
let chars = s.chars();          // ['h', 'e', 'l', 'l', 'o']

// UTF-8 example
let text = "HiğŸš€!";
let chars2 = text.chars();      // ['H', 'i', 'ğŸš€', '!']
```

---

### å­—èŠ‚è®¿é—®

#### byte_at

è·å–æŒ‡å®šç´¢å¼•å¤„çš„å­—èŠ‚å€¼ã€‚

**ç­¾åï¼š**
```hemlock
string.byte_at(index: i32): u8
```

**å‚æ•°ï¼š**
- `index` - å­—èŠ‚ç´¢å¼•ï¼ˆä» 0 å¼€å§‹ï¼Œä¸æ˜¯ç ç‚¹ç´¢å¼•ï¼‰

**è¿”å›å€¼ï¼š** å­—èŠ‚å€¼ (u8)

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello";
let byte = s.byte_at(0);        // 104 (ASCII 'h')
let byte2 = s.byte_at(1);       // 101 (ASCII 'e')

// UTF-8 example
let emoji = "ğŸš€";
let byte3 = emoji.byte_at(0);   // 240 (first UTF-8 byte)
```

---

#### bytes

å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ã€‚

**ç­¾åï¼š**
```hemlock
string.bytes(): array
```

**è¿”å›å€¼ï¼š** u8 å­—èŠ‚æ•°ç»„

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello";
let bytes = s.bytes();          // [104, 101, 108, 108, 111]

// UTF-8 example
let emoji = "ğŸš€";
let bytes2 = emoji.bytes();     // [240, 159, 154, 128] (4 UTF-8 bytes)
```

---

#### to_bytes

å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºç¼“å†²åŒºã€‚

**ç­¾åï¼š**
```hemlock
string.to_bytes(): buffer
```

**è¿”å›å€¼ï¼š** åŒ…å« UTF-8 å­—èŠ‚çš„ç¼“å†²åŒº

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello";
let buf = s.to_bytes();
print(buf.length);              // 5

// UTF-8 example
let emoji = "ğŸš€";
let buf2 = emoji.to_bytes();
print(buf2.length);             // 4
```

**æ³¨æ„ï¼š** è¿™æ˜¯ä¸€ä¸ªé—ç•™æ–¹æ³•ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹æ¨èä½¿ç”¨ `.bytes()`ã€‚

---

### JSON ååºåˆ—åŒ–

#### deserialize

å°† JSON å­—ç¬¦ä¸²è§£æä¸ºå€¼ã€‚

**ç­¾åï¼š**
```hemlock
string.deserialize(): any
```

**è¿”å›å€¼ï¼š** è§£æåçš„å€¼ï¼ˆå¯¹è±¡ã€æ•°ç»„ã€æ•°å­—ã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼æˆ– nullï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let json = '{"x":10,"y":20}';
let obj = json.deserialize();
print(obj.x);                   // 10
print(obj.y);                   // 20

let arr_json = '[1,2,3]';
let arr = arr_json.deserialize();
print(arr[0]);                  // 1

let num_json = '42';
let num = num_json.deserialize();
print(num);                     // 42
```

**æ”¯æŒçš„ç±»å‹ï¼š**
- å¯¹è±¡ï¼š`{"key": value}`
- æ•°ç»„ï¼š`[1, 2, 3]`
- æ•°å­—ï¼š`42`ã€`3.14`
- å­—ç¬¦ä¸²ï¼š`"text"`
- å¸ƒå°”å€¼ï¼š`true`ã€`false`
- ç©ºå€¼ï¼š`null`

**å¦è¯·å‚é˜…ï¼š** å¯¹è±¡çš„ `.serialize()` æ–¹æ³•

---

## æ–¹æ³•é“¾

å­—ç¬¦ä¸²æ–¹æ³•å¯ä»¥é“¾æ¥èµ·æ¥è¿›è¡Œç®€æ´çš„æ“ä½œï¼š

**ç¤ºä¾‹ï¼š**
```hemlock
let result = "  Hello World  "
    .trim()
    .to_lower()
    .replace("world", "hemlock");  // "hello hemlock"

let processed = "foo,bar,baz"
    .split(",")
    .join(" | ");                  // "foo | bar | baz"

let cleaned = "  HELLO  "
    .trim()
    .to_lower();                   // "hello"
```

---

## å®Œæ•´æ–¹æ³•æ±‡æ€»

| æ–¹æ³•           | ç­¾å                                         | è¿”å›å€¼    | æè¿°                            |
|----------------|----------------------------------------------|-----------|--------------------------------|
| `substr`       | `(start: i32, length: i32)`                  | `string`  | æŒ‰ä½ç½®/é•¿åº¦æå–å­å­—ç¬¦ä¸²         |
| `slice`        | `(start: i32, end: i32)`                     | `string`  | æŒ‰èŒƒå›´æå–å­å­—ç¬¦ä¸²              |
| `find`         | `(needle: string)`                           | `i32`     | æŸ¥æ‰¾ç¬¬ä¸€æ¬¡å‡ºç°ï¼ˆæœªæ‰¾åˆ°è¿”å› -1ï¼‰ |
| `contains`     | `(needle: string)`                           | `bool`    | æ£€æŸ¥æ˜¯å¦åŒ…å«å­å­—ç¬¦ä¸²            |
| `split`        | `(delimiter: string)`                        | `array`   | åˆ†å‰²ä¸ºæ•°ç»„                      |
| `trim`         | `()`                                         | `string`  | ç§»é™¤ç©ºç™½å­—ç¬¦                    |
| `to_upper`     | `()`                                         | `string`  | è½¬æ¢ä¸ºå¤§å†™                      |
| `to_lower`     | `()`                                         | `string`  | è½¬æ¢ä¸ºå°å†™                      |
| `starts_with`  | `(prefix: string)`                           | `bool`    | æ£€æŸ¥æ˜¯å¦ä»¥å‰ç¼€å¼€å§‹              |
| `ends_with`    | `(suffix: string)`                           | `bool`    | æ£€æŸ¥æ˜¯å¦ä»¥åç¼€ç»“æŸ              |
| `replace`      | `(old: string, new: string)`                 | `string`  | æ›¿æ¢ç¬¬ä¸€æ¬¡å‡ºç°                  |
| `replace_all`  | `(old: string, new: string)`                 | `string`  | æ›¿æ¢æ‰€æœ‰å‡ºç°                    |
| `repeat`       | `(count: i32)`                               | `string`  | å°†å­—ç¬¦ä¸²é‡å¤ n æ¬¡               |
| `char_at`      | `(index: i32)`                               | `rune`    | è·å–æŒ‡å®šç´¢å¼•å¤„çš„ç ç‚¹            |
| `byte_at`      | `(index: i32)`                               | `u8`      | è·å–æŒ‡å®šç´¢å¼•å¤„çš„å­—èŠ‚            |
| `chars`        | `()`                                         | `array`   | è½¬æ¢ä¸º rune æ•°ç»„                |
| `bytes`        | `()`                                         | `array`   | è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„                  |
| `to_bytes`     | `()`                                         | `buffer`  | è½¬æ¢ä¸ºç¼“å†²åŒºï¼ˆé—ç•™ï¼‰            |
| `deserialize`  | `()`                                         | `any`     | è§£æ JSON å­—ç¬¦ä¸²                |

---

## å¦è¯·å‚é˜…

- [ç±»å‹ç³»ç»Ÿ](#reference-type-system) - å­—ç¬¦ä¸²ç±»å‹è¯¦æƒ…
- [æ•°ç»„ API](#reference-array-api) - split() ç»“æœçš„æ•°ç»„æ–¹æ³•
- [è¿ç®—ç¬¦](#reference-operators) - å­—ç¬¦ä¸²è¿æ¥è¿ç®—ç¬¦


--------------------------------------------------------------------------------
## å¹¶å‘ API
--------------------------------------------------------------------------------

# å¹¶å‘ API å‚è€ƒ

Hemlock å¼‚æ­¥/å¹¶å‘ç³»ç»Ÿçš„å®Œæ•´å‚è€ƒæ–‡æ¡£ã€‚

---

## æ¦‚è¿°

Hemlock ä½¿ç”¨ POSIX çº¿ç¨‹ï¼ˆpthreadsï¼‰æä¾›**ç»“æ„åŒ–å¹¶å‘**å’ŒçœŸæ­£çš„å¤šçº¿ç¨‹å¹¶è¡Œã€‚æ¯ä¸ªæ´¾ç”Ÿçš„ä»»åŠ¡éƒ½åœ¨å•ç‹¬çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šè¿è¡Œï¼Œæ”¯æŒè·¨å¤šä¸ª CPU æ ¸å¿ƒçš„å®é™…å¹¶è¡Œæ‰§è¡Œã€‚

**ä¸»è¦ç‰¹æ€§ï¼š**
- çœŸæ­£çš„å¤šçº¿ç¨‹å¹¶è¡Œï¼ˆä¸æ˜¯ç»¿è‰²çº¿ç¨‹ï¼‰
- å¼‚æ­¥å‡½æ•°è¯­æ³•
- ä»»åŠ¡æ´¾ç”Ÿå’ŒåŠ å…¥
- çº¿ç¨‹å®‰å…¨é€šé“
- å¼‚å¸¸ä¼ æ’­

**çº¿ç¨‹æ¨¡å‹ï¼š**
- çœŸæ­£çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼ˆPOSIX pthreadsï¼‰
- çœŸæ­£çš„å¹¶è¡Œæ€§ï¼ˆå¤šä¸ª CPU æ ¸å¿ƒï¼‰
- å†…æ ¸è°ƒåº¦ï¼ˆæŠ¢å å¼å¤šä»»åŠ¡ï¼‰
- çº¿ç¨‹å®‰å…¨åŒæ­¥ï¼ˆäº’æ–¥é”ã€æ¡ä»¶å˜é‡ï¼‰

---

## å¼‚æ­¥å‡½æ•°

### å¼‚æ­¥å‡½æ•°å£°æ˜

å‡½æ•°å¯ä»¥å£°æ˜ä¸º `async`ï¼Œè¡¨ç¤ºå®ƒä»¬æ˜¯ä¸ºå¹¶å‘æ‰§è¡Œè®¾è®¡çš„ã€‚

**è¯­æ³•ï¼š**
```hemlock
async fn function_name(params): return_type {
    // å‡½æ•°ä½“
}
```

**ç¤ºä¾‹ï¼š**
```hemlock
async fn compute(n: i32): i32 {
    let sum = 0;
    let i = 0;
    while (i < n) {
        sum = sum + i;
        i = i + 1;
    }
    return sum;
}

async fn factorial(n: i32): i32 {
    if (n <= 1) { return 1; }
    return n * factorial(n - 1);
}

async fn process_data(data: string) {
    print("Processing:", data);
    return null;
}
```

**è¡Œä¸ºï¼š**
- `async fn` å£°æ˜ä¸€ä¸ªå¼‚æ­¥å‡½æ•°
- å¯ä»¥åŒæ­¥è°ƒç”¨ï¼ˆåœ¨å½“å‰çº¿ç¨‹è¿è¡Œï¼‰
- å¯ä»¥ä½œä¸ºå¹¶å‘ä»»åŠ¡æ´¾ç”Ÿï¼ˆåœ¨æ–°çº¿ç¨‹è¿è¡Œï¼‰
- æ´¾ç”Ÿæ—¶ï¼Œåœ¨è‡ªå·±çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šè¿è¡Œ

**æ³¨æ„ï¼š** `await` å…³é”®å­—ä¿ç•™ä¾›å°†æ¥ä½¿ç”¨ï¼Œä½†ç›®å‰æœªå®ç°ã€‚

---

## ä»»åŠ¡ç®¡ç†

### spawn

åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„å¹¶å‘ä»»åŠ¡ã€‚

**ç­¾åï¼š**
```hemlock
spawn(async_fn: function, ...args): task
```

**å‚æ•°ï¼š**
- `async_fn` - è¦æ‰§è¡Œçš„å¼‚æ­¥å‡½æ•°
- `...args` - ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°

**è¿”å›å€¼ï¼š** ä»»åŠ¡å¥æŸ„

**ç¤ºä¾‹ï¼š**
```hemlock
async fn compute(n: i32): i32 {
    let sum = 0;
    let i = 0;
    while (i < n) {
        sum = sum + i;
        i = i + 1;
    }
    return sum;
}

// æ´¾ç”Ÿå•ä¸ªä»»åŠ¡
let t = spawn(compute, 1000);
let result = join(t);
print(result);

// æ´¾ç”Ÿå¤šä¸ªä»»åŠ¡ï¼ˆå¹¶è¡Œè¿è¡Œï¼ï¼‰
let t1 = spawn(compute, 100);
let t2 = spawn(compute, 200);
let t3 = spawn(compute, 300);

// ä¸‰ä¸ªä»»åŠ¡åŒæ—¶è¿è¡Œ
let r1 = join(t1);
let r2 = join(t2);
let r3 = join(t3);
```

**è¡Œä¸ºï¼š**
- é€šè¿‡ `pthread_create()` åˆ›å»ºæ–°çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹
- ç«‹å³å¼€å§‹æ‰§è¡Œå‡½æ•°
- è¿”å›ä»»åŠ¡å¥æŸ„ä¾›åç»­åŠ å…¥
- ä»»åŠ¡åœ¨å•ç‹¬çš„ CPU æ ¸å¿ƒä¸Šå¹¶è¡Œè¿è¡Œ

---

### join

ç­‰å¾…ä»»åŠ¡å®Œæˆå¹¶è·å–ç»“æœã€‚

**ç­¾åï¼š**
```hemlock
join(task: task): any
```

**å‚æ•°ï¼š**
- `task` - æ¥è‡ª `spawn()` çš„ä»»åŠ¡å¥æŸ„

**è¿”å›å€¼ï¼š** ä»»åŠ¡çš„è¿”å›å€¼

**ç¤ºä¾‹ï¼š**
```hemlock
async fn factorial(n: i32): i32 {
    if (n <= 1) { return 1; }
    return n * factorial(n - 1);
}

let t = spawn(factorial, 10);
let result = join(t);  // é˜»å¡ç›´åˆ°ä»»åŠ¡å®Œæˆ
print(result);         // 3628800
```

**è¡Œä¸ºï¼š**
- é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆ
- è¿”å›ä»»åŠ¡çš„è¿”å›å€¼
- ä¼ æ’­ä»»åŠ¡æŠ›å‡ºçš„å¼‚å¸¸
- è¿”å›åæ¸…ç†ä»»åŠ¡èµ„æº

**é”™è¯¯å¤„ç†ï¼š**
```hemlock
async fn risky_operation(should_fail: i32): i32 {
    if (should_fail == 1) {
        throw "Task failed!";
    }
    return 42;
}

let t = spawn(risky_operation, 1);
try {
    let result = join(t);
} catch (e) {
    print("Caught:", e);  // "Caught: Task failed!"
}
```

---

### detach

åˆ†ç¦»ä»»åŠ¡ï¼ˆå³å‘å³å¼ƒæ‰§è¡Œï¼‰ã€‚

**ç­¾åï¼š**
```hemlock
detach(task: task): null
```

**å‚æ•°ï¼š**
- `task` - æ¥è‡ª `spawn()` çš„ä»»åŠ¡å¥æŸ„

**è¿”å›å€¼ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
async fn background_work() {
    print("Working in background...");
    return null;
}

let t = spawn(background_work);
detach(t);  // ä»»åŠ¡ç»§ç»­ç‹¬ç«‹è¿è¡Œ

// ä¸èƒ½åŠ å…¥å·²åˆ†ç¦»çš„ä»»åŠ¡
// join(t);  // é”™è¯¯
```

**è¡Œä¸ºï¼š**
- ä»»åŠ¡ç»§ç»­ç‹¬ç«‹è¿è¡Œ
- ä¸èƒ½ `join()` å·²åˆ†ç¦»çš„ä»»åŠ¡
- ä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨æ¸…ç†ä»»åŠ¡å’Œçº¿ç¨‹

**ç”¨ä¾‹ï¼š**
- å³å‘å³å¼ƒçš„åå°ä»»åŠ¡
- æ—¥å¿—/ç›‘æ§ä»»åŠ¡
- ä¸éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡

---

## é€šé“

é€šé“æä¾›ä»»åŠ¡ä¹‹é—´çš„çº¿ç¨‹å®‰å…¨é€šä¿¡ã€‚

### channel

åˆ›å»ºä¸€ä¸ªç¼“å†²é€šé“ã€‚

**ç­¾åï¼š**
```hemlock
channel(capacity: i32): channel
```

**å‚æ•°ï¼š**
- `capacity` - ç¼“å†²åŒºå¤§å°ï¼ˆå€¼çš„æ•°é‡ï¼‰

**è¿”å›å€¼ï¼š** é€šé“å¯¹è±¡

**ç¤ºä¾‹ï¼š**
```hemlock
let ch = channel(10);  // å®¹é‡ä¸º 10 çš„ç¼“å†²é€šé“
let ch2 = channel(1);  // æœ€å°ç¼“å†²åŒºï¼ˆåŒæ­¥ï¼‰
let ch3 = channel(100); // å¤§ç¼“å†²åŒº
```

**è¡Œä¸ºï¼š**
- åˆ›å»ºçº¿ç¨‹å®‰å…¨é€šé“
- ä½¿ç”¨ pthread äº’æ–¥é”è¿›è¡ŒåŒæ­¥
- å®¹é‡åœ¨åˆ›å»ºæ—¶å›ºå®š

---

### é€šé“æ–¹æ³•

#### send

å‘é€šé“å‘é€å€¼ï¼ˆå¦‚æœå·²æ»¡åˆ™é˜»å¡ï¼‰ã€‚

**ç­¾åï¼š**
```hemlock
channel.send(value: any): null
```

**å‚æ•°ï¼š**
- `value` - è¦å‘é€çš„å€¼ï¼ˆä»»æ„ç±»å‹ï¼‰

**è¿”å›å€¼ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
async fn producer(ch, count: i32) {
    let i = 0;
    while (i < count) {
        ch.send(i * 10);
        i = i + 1;
    }
    ch.close();
    return null;
}

let ch = channel(10);
let t = spawn(producer, ch, 5);
```

**è¡Œä¸ºï¼š**
- å‘é€šé“å‘é€å€¼
- å¦‚æœé€šé“å·²æ»¡åˆ™é˜»å¡
- çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨äº’æ–¥é”ï¼‰
- å€¼å‘é€åè¿”å›

---

#### recv

ä»é€šé“æ¥æ”¶å€¼ï¼ˆå¦‚æœä¸ºç©ºåˆ™é˜»å¡ï¼‰ã€‚

**ç­¾åï¼š**
```hemlock
channel.recv(): any
```

**è¿”å›å€¼ï¼š** æ¥è‡ªé€šé“çš„å€¼ï¼Œå¦‚æœé€šé“å·²å…³é—­ä¸”ä¸ºç©ºåˆ™è¿”å› `null`

**ç¤ºä¾‹ï¼š**
```hemlock
async fn consumer(ch, count: i32): i32 {
    let sum = 0;
    let i = 0;
    while (i < count) {
        let val = ch.recv();
        sum = sum + val;
        i = i + 1;
    }
    return sum;
}

let ch = channel(10);
let t = spawn(consumer, ch, 5);
```

**è¡Œä¸ºï¼š**
- ä»é€šé“æ¥æ”¶å€¼
- å¦‚æœé€šé“ä¸ºç©ºåˆ™é˜»å¡
- å¦‚æœé€šé“å·²å…³é—­ä¸”ä¸ºç©ºåˆ™è¿”å› `null`
- çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨äº’æ–¥é”ï¼‰

---

#### close

å…³é—­é€šé“ï¼ˆä¸å†å…è®¸å‘é€ï¼‰ã€‚

**ç­¾åï¼š**
```hemlock
channel.close(): null
```

**è¿”å›å€¼ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
async fn producer(ch) {
    ch.send(1);
    ch.send(2);
    ch.send(3);
    ch.close();  // è¡¨ç¤ºæ²¡æœ‰æ›´å¤šå€¼
    return null;
}

async fn consumer(ch) {
    while (true) {
        let val = ch.recv();
        if (val == null) {
            break;  // é€šé“å·²å…³é—­
        }
        print(val);
    }
    return null;
}
```

**è¡Œä¸ºï¼š**
- å…³é—­é€šé“
- ä¸å†å…è®¸å‘é€
- é€šé“ä¸ºç©ºæ—¶ `recv()` è¿”å› `null`
- çº¿ç¨‹å®‰å…¨

---

## å®Œæ•´å¹¶å‘ç¤ºä¾‹

### ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

```hemlock
async fn producer(ch, count: i32) {
    let i = 0;
    while (i < count) {
        print("Producing:", i);
        ch.send(i * 10);
        i = i + 1;
    }
    ch.close();
    return null;
}

async fn consumer(ch, count: i32): i32 {
    let sum = 0;
    let i = 0;
    while (i < count) {
        let val = ch.recv();
        print("Consuming:", val);
        sum = sum + val;
        i = i + 1;
    }
    return sum;
}

// åˆ›å»ºé€šé“
let ch = channel(10);

// æ´¾ç”Ÿç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
let p = spawn(producer, ch, 5);
let c = spawn(consumer, ch, 5);

// ç­‰å¾…å®Œæˆ
join(p);
let total = join(c);
print("Total:", total);  // 0+10+20+30+40 = 100
```

---

## å¹¶è¡Œè®¡ç®—

### å¤šä»»åŠ¡ç¤ºä¾‹

```hemlock
async fn factorial(n: i32): i32 {
    if (n <= 1) { return 1; }
    return n * factorial(n - 1);
}

// æ´¾ç”Ÿå¤šä¸ªä»»åŠ¡ï¼ˆå¹¶è¡Œè¿è¡Œï¼ï¼‰
let t1 = spawn(factorial, 5);   // çº¿ç¨‹ 1
let t2 = spawn(factorial, 6);   // çº¿ç¨‹ 2
let t3 = spawn(factorial, 7);   // çº¿ç¨‹ 3
let t4 = spawn(factorial, 8);   // çº¿ç¨‹ 4

// å››ä¸ªä»»åŠ¡åŒæ—¶è®¡ç®—ï¼

// ç­‰å¾…ç»“æœ
let f5 = join(t1);  // 120
let f6 = join(t2);  // 720
let f7 = join(t3);  // 5040
let f8 = join(t4);  // 40320

print(f5, f6, f7, f8);
```

---

## ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ

### çŠ¶æ€è½¬æ¢

1. **å·²åˆ›å»º** - ä»»åŠ¡å·²æ´¾ç”Ÿä½†å°šæœªè¿è¡Œ
2. **è¿è¡Œä¸­** - ä»»åŠ¡åœ¨æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šæ‰§è¡Œ
3. **å·²å®Œæˆ** - ä»»åŠ¡å·²å®Œæˆï¼ˆç»“æœå¯ç”¨ï¼‰
4. **å·²åŠ å…¥** - ç»“æœå·²è·å–ï¼Œèµ„æºå·²æ¸…ç†
5. **å·²åˆ†ç¦»** - ä»»åŠ¡ç»§ç»­ç‹¬ç«‹è¿è¡Œ

### ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹

```hemlock
async fn work(n: i32): i32 {
    return n * 2;
}

// 1. åˆ›å»ºä»»åŠ¡
let t = spawn(work, 21);  // çŠ¶æ€ï¼šè¿è¡Œä¸­

// ä»»åŠ¡åœ¨å•ç‹¬çº¿ç¨‹ä¸Šæ‰§è¡Œ...

// 2. åŠ å…¥ä»»åŠ¡
let result = join(t);     // çŠ¶æ€ï¼šå·²å®Œæˆ â†’ å·²åŠ å…¥
print(result);            // 42

// åŠ å…¥åä»»åŠ¡èµ„æºè¢«æ¸…ç†
```

### åˆ†ç¦»ç”Ÿå‘½å‘¨æœŸ

```hemlock
async fn background() {
    print("Background task running");
    return null;
}

// 1. åˆ›å»ºä»»åŠ¡
let t = spawn(background);  // çŠ¶æ€ï¼šè¿è¡Œä¸­

// 2. åˆ†ç¦»ä»»åŠ¡
detach(t);                  // çŠ¶æ€ï¼šå·²åˆ†ç¦»

// ä»»åŠ¡ç»§ç»­ç‹¬ç«‹è¿è¡Œ
// å®Œæˆåç”±æ“ä½œç³»ç»Ÿæ¸…ç†èµ„æº
```

---

## é”™è¯¯å¤„ç†

### å¼‚å¸¸ä¼ æ’­

ä»»åŠ¡ä¸­æŠ›å‡ºçš„å¼‚å¸¸åœ¨åŠ å…¥æ—¶è¢«ä¼ æ’­ï¼š

```hemlock
async fn risky_operation(should_fail: i32): i32 {
    if (should_fail == 1) {
        throw "Task failed!";
    }
    return 42;
}

// æˆåŠŸçš„ä»»åŠ¡
let t1 = spawn(risky_operation, 0);
let result1 = join(t1);  // 42

// å¤±è´¥çš„ä»»åŠ¡
let t2 = spawn(risky_operation, 1);
try {
    let result2 = join(t2);
} catch (e) {
    print("Caught:", e);  // "Caught: Task failed!"
}
```

### å¤„ç†å¤šä¸ªä»»åŠ¡

```hemlock
async fn work(id: i32, should_fail: i32): i32 {
    if (should_fail == 1) {
        throw "Task " + typeof(id) + " failed";
    }
    return id * 10;
}

let t1 = spawn(work, 1, 0);
let t2 = spawn(work, 2, 1);  // å°†å¤±è´¥
let t3 = spawn(work, 3, 0);

// å¸¦é”™è¯¯å¤„ç†çš„åŠ å…¥
try {
    let r1 = join(t1);  // æ­£å¸¸
    print("Task 1:", r1);

    let r2 = join(t2);  // æŠ›å‡ºå¼‚å¸¸
    print("Task 2:", r2);  // æ°¸è¿œä¸ä¼šåˆ°è¾¾
} catch (e) {
    print("Error:", e);  // "Error: Task 2 failed"
}

// ä»ç„¶å¯ä»¥åŠ å…¥å‰©ä½™ä»»åŠ¡
let r3 = join(t3);
print("Task 3:", r3);
```

---

## æ€§èƒ½ç‰¹æ€§

### çœŸæ­£çš„å¹¶è¡Œæ€§

```hemlock
async fn cpu_intensive(n: i32): i32 {
    let sum = 0;
    let i = 0;
    while (i < n) {
        sum = sum + i;
        i = i + 1;
    }
    return sum;
}

// é¡ºåºæ‰§è¡Œ
let start = get_time();
let r1 = cpu_intensive(10000000);
let r2 = cpu_intensive(10000000);
let sequential_time = get_time() - start;

// å¹¶è¡Œæ‰§è¡Œ
let start2 = get_time();
let t1 = spawn(cpu_intensive, 10000000);
let t2 = spawn(cpu_intensive, 10000000);
join(t1);
join(t2);
let parallel_time = get_time() - start2;

// åœ¨å¤šæ ¸ç³»ç»Ÿä¸Š parallel_time åº”è¯¥çº¦ä¸º sequential_time çš„ 50%
```

**å·²è¯å®çš„ç‰¹æ€§ï¼š**
- N ä¸ªä»»åŠ¡å¯ä»¥åŒæ—¶åˆ©ç”¨ N ä¸ª CPU æ ¸å¿ƒ
- å‹åŠ›æµ‹è¯•æ˜¾ç¤º CPU æ—¶é—´ä¸å¢™é’Ÿæ—¶é—´ä¹‹æ¯”ä¸º 8-9 å€ï¼ˆå¹¶è¡Œæ€§çš„è¯æ˜ï¼‰
- çº¿ç¨‹å¼€é”€ï¼šæ¯ä¸ªä»»åŠ¡çº¦ 8KB æ ˆ + pthread å¼€é”€
- ä¸€ä¸ªä»»åŠ¡ä¸­çš„é˜»å¡æ“ä½œä¸ä¼šé˜»å¡å…¶ä»–ä»»åŠ¡

---

## å®ç°ç»†èŠ‚

### çº¿ç¨‹æ¨¡å‹

- **1:1 çº¿ç¨‹** - æ¯ä¸ªä»»åŠ¡ = 1 ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼ˆ`pthread`ï¼‰
- **å†…æ ¸è°ƒåº¦** - æ“ä½œç³»ç»Ÿå†…æ ¸åœ¨æ ¸å¿ƒä¹‹é—´åˆ†é…çº¿ç¨‹
- **æŠ¢å å¼å¤šä»»åŠ¡** - æ“ä½œç³»ç»Ÿå¯ä»¥ä¸­æ–­å’Œåˆ‡æ¢çº¿ç¨‹
- **æ—  GIL** - æ²¡æœ‰å…¨å±€è§£é‡Šå™¨é”ï¼ˆä¸ Python ä¸åŒï¼‰

### åŒæ­¥

- **äº’æ–¥é”** - é€šé“ä½¿ç”¨ `pthread_mutex_t`
- **æ¡ä»¶å˜é‡** - é˜»å¡çš„ send/recv ä½¿ç”¨ `pthread_cond_t`
- **æ— é”æ“ä½œ** - ä»»åŠ¡çŠ¶æ€è½¬æ¢æ˜¯åŸå­çš„

### å†…å­˜å’Œæ¸…ç†

- **å·²åŠ å…¥çš„ä»»åŠ¡** - `join()` åè‡ªåŠ¨æ¸…ç†
- **å·²åˆ†ç¦»çš„ä»»åŠ¡** - ä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨æ¸…ç†
- **é€šé“** - å¼•ç”¨è®¡æ•°ï¼Œä¸å†ä½¿ç”¨æ—¶é‡Šæ”¾

---

## é™åˆ¶

- æ²¡æœ‰ç”¨äºå¤šè·¯å¤ç”¨å¤šä¸ªé€šé“çš„ `select()`
- æ²¡æœ‰å·¥ä½œçªƒå–è°ƒåº¦å™¨ï¼ˆæ¯ä¸ªä»»åŠ¡ 1 ä¸ªçº¿ç¨‹ï¼‰
- æ²¡æœ‰å¼‚æ­¥ I/O é›†æˆï¼ˆæ–‡ä»¶/ç½‘ç»œæ“ä½œä¼šé˜»å¡ï¼‰
- é€šé“å®¹é‡åœ¨åˆ›å»ºæ—¶å›ºå®š

---

## å®Œæ•´ API æ€»ç»“

### å‡½æ•°

| å‡½æ•°      | ç­¾å                              | è¿”å›å€¼    | æè¿°                           |
|-----------|-----------------------------------|-----------|--------------------------------|
| `spawn`   | `(async_fn: function, ...args)`   | `task`    | åˆ›å»ºå¹¶å¯åŠ¨å¹¶å‘ä»»åŠ¡             |
| `join`    | `(task: task)`                    | `any`     | ç­‰å¾…ä»»åŠ¡ï¼Œè·å–ç»“æœ             |
| `detach`  | `(task: task)`                    | `null`    | åˆ†ç¦»ä»»åŠ¡ï¼ˆå³å‘å³å¼ƒï¼‰           |
| `channel` | `(capacity: i32)`                 | `channel` | åˆ›å»ºçº¿ç¨‹å®‰å…¨é€šé“               |

### é€šé“æ–¹æ³•

| æ–¹æ³•    | ç­¾å            | è¿”å›å€¼  | æè¿°                           |
|---------|-----------------|---------|--------------------------------|
| `send`  | `(value: any)`  | `null`  | å‘é€å€¼ï¼ˆå¦‚æœå·²æ»¡åˆ™é˜»å¡ï¼‰       |
| `recv`  | `()`            | `any`   | æ¥æ”¶å€¼ï¼ˆå¦‚æœä¸ºç©ºåˆ™é˜»å¡ï¼‰       |
| `close` | `()`            | `null`  | å…³é—­é€šé“                       |

### ç±»å‹

| ç±»å‹      | æè¿°                                 |
|-----------|--------------------------------------|
| `task`    | å¹¶å‘ä»»åŠ¡çš„å¥æŸ„                       |
| `channel` | çº¿ç¨‹å®‰å…¨é€šä¿¡é€šé“                     |

---

## æœ€ä½³å®è·µ

### åº”è¯¥åšçš„

- ä½¿ç”¨é€šé“è¿›è¡Œä»»åŠ¡ä¹‹é—´çš„é€šä¿¡
- å¤„ç†å·²åŠ å…¥ä»»åŠ¡çš„å¼‚å¸¸
- å‘é€å®Œæˆåå…³é—­é€šé“
- ä½¿ç”¨ `join()` è·å–ç»“æœå¹¶æ¸…ç†
- åªæ´¾ç”Ÿå¼‚æ­¥å‡½æ•°

### ä¸åº”è¯¥åšçš„

- ä¸è¦åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹å…±äº«å¯å˜çŠ¶æ€
- ä¸è¦å¯¹åŒä¸€ä»»åŠ¡åŠ å…¥ä¸¤æ¬¡
- ä¸è¦å‘å·²å…³é—­çš„é€šé“å‘é€
- ä¸è¦æ´¾ç”Ÿéå¼‚æ­¥å‡½æ•°
- ä¸è¦å¿˜è®°åŠ å…¥ä»»åŠ¡ï¼ˆé™¤éå·²åˆ†ç¦»ï¼‰

---

## å¦è¯·å‚é˜…

- [å†…ç½®å‡½æ•°](#reference-builtins) - `spawn()`ã€`join()`ã€`detach()`ã€`channel()`
- [ç±»å‹ç³»ç»Ÿ](#reference-type-system) - ä»»åŠ¡å’Œé€šé“ç±»å‹


--------------------------------------------------------------------------------
## æ•°ç»„ API
--------------------------------------------------------------------------------

# æ•°ç»„ API å‚è€ƒ

Hemlock æ•°ç»„ç±»å‹åŠå…¶å…¨éƒ¨ 18 ä¸ªæ•°ç»„æ–¹æ³•çš„å®Œæ•´å‚è€ƒæ–‡æ¡£ã€‚

---

## æ¦‚è¿°

Hemlock ä¸­çš„æ•°ç»„æ˜¯**åŠ¨æ€çš„ã€å †åˆ†é…çš„**åºåˆ—ï¼Œå¯ä»¥å­˜å‚¨æ··åˆç±»å‹ã€‚å®ƒä»¬æä¾›äº†å…¨é¢çš„æ•°æ®æ“ä½œå’Œå¤„ç†æ–¹æ³•ã€‚

**ä¸»è¦ç‰¹æ€§ï¼š**
- åŠ¨æ€å¤§å°ï¼ˆè‡ªåŠ¨å¢é•¿ï¼‰
- ä»é›¶å¼€å§‹ç´¢å¼•
- å…è®¸æ··åˆç±»å‹
- 18 ä¸ªå†…ç½®æ–¹æ³•
- å †åˆ†é…å¹¶è·Ÿè¸ªå®¹é‡

---

## æ•°ç»„ç±»å‹

**ç±»å‹ï¼š** `array`

**å±æ€§ï¼š**
- `.length` - å…ƒç´ æ•°é‡ (i32)

**å­—é¢é‡è¯­æ³•ï¼š** æ–¹æ‹¬å· `[elem1, elem2, ...]`

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3, 4, 5];
print(arr.length);     // 5

// æ··åˆç±»å‹
let mixed = [1, "hello", true, null];
print(mixed.length);   // 4

// ç©ºæ•°ç»„
let empty = [];
print(empty.length);   // 0
```

---

## ç´¢å¼•

æ•°ç»„æ”¯æŒä½¿ç”¨ `[]` è¿›è¡Œä»é›¶å¼€å§‹çš„ç´¢å¼•ï¼š

**è¯»å–è®¿é—®ï¼š**
```hemlock
let arr = [10, 20, 30];
print(arr[0]);         // 10
print(arr[1]);         // 20
print(arr[2]);         // 30
```

**å†™å…¥è®¿é—®ï¼š**
```hemlock
let arr = [10, 20, 30];
arr[0] = 99;
arr[1] = 88;
print(arr);            // [99, 88, 30]
```

**æ³¨æ„ï¼š** ç›´æ¥ç´¢å¼•ä¸è¿›è¡Œè¾¹ç•Œæ£€æŸ¥ã€‚è¯·ä½¿ç”¨æ–¹æ³•ä»¥ç¡®ä¿å®‰å…¨ã€‚

---

## æ•°ç»„å±æ€§

### .length

è·å–æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚

**ç±»å‹ï¼š** `i32`

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3];
print(arr.length);     // 3

let empty = [];
print(empty.length);   // 0

// é•¿åº¦åŠ¨æ€å˜åŒ–
arr.push(4);
print(arr.length);     // 4

arr.pop();
print(arr.length);     // 3
```

---

## æ•°ç»„æ–¹æ³•

### æ ˆæ“ä½œ

#### push

å°†å…ƒç´ æ·»åŠ åˆ°æ•°ç»„æœ«å°¾ã€‚

**ç­¾åï¼š**
```hemlock
array.push(value: any): null
```

**å‚æ•°ï¼š**
- `value` - è¦æ·»åŠ çš„å…ƒç´ 

**è¿”å›å€¼ï¼š** `null`

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** æ˜¯ï¼ˆåŸåœ°ä¿®æ”¹æ•°ç»„ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3];
arr.push(4);           // [1, 2, 3, 4]
arr.push(5);           // [1, 2, 3, 4, 5]
arr.push("hello");     // [1, 2, 3, 4, 5, "hello"]
```

---

#### pop

ç§»é™¤å¹¶è¿”å›æœ€åä¸€ä¸ªå…ƒç´ ã€‚

**ç­¾åï¼š**
```hemlock
array.pop(): any
```

**è¿”å›å€¼ï¼š** æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆä»æ•°ç»„ä¸­ç§»é™¤ï¼‰

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** æ˜¯ï¼ˆåŸåœ°ä¿®æ”¹æ•°ç»„ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3];
let last = arr.pop();  // 3
print(arr);            // [1, 2]

let last2 = arr.pop(); // 2
print(arr);            // [1]
```

**é”™è¯¯ï¼š** å¦‚æœæ•°ç»„ä¸ºç©ºåˆ™æŠ›å‡ºè¿è¡Œæ—¶é”™è¯¯ã€‚

---

### é˜Ÿåˆ—æ“ä½œ

#### shift

ç§»é™¤å¹¶è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚

**ç­¾åï¼š**
```hemlock
array.shift(): any
```

**è¿”å›å€¼ï¼š** ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆä»æ•°ç»„ä¸­ç§»é™¤ï¼‰

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** æ˜¯ï¼ˆåŸåœ°ä¿®æ”¹æ•°ç»„ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3];
let first = arr.shift();  // 1
print(arr);               // [2, 3]

let first2 = arr.shift(); // 2
print(arr);               // [3]
```

**é”™è¯¯ï¼š** å¦‚æœæ•°ç»„ä¸ºç©ºåˆ™æŠ›å‡ºè¿è¡Œæ—¶é”™è¯¯ã€‚

---

#### unshift

å°†å…ƒç´ æ·»åŠ åˆ°æ•°ç»„å¼€å¤´ã€‚

**ç­¾åï¼š**
```hemlock
array.unshift(value: any): null
```

**å‚æ•°ï¼š**
- `value` - è¦æ·»åŠ çš„å…ƒç´ 

**è¿”å›å€¼ï¼š** `null`

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** æ˜¯ï¼ˆåŸåœ°ä¿®æ”¹æ•°ç»„ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [2, 3];
arr.unshift(1);        // [1, 2, 3]
arr.unshift(0);        // [0, 1, 2, 3]
```

---

### æ’å…¥ä¸åˆ é™¤

#### insert

åœ¨æŒ‡å®šç´¢å¼•ä½ç½®æ’å…¥å…ƒç´ ã€‚

**ç­¾åï¼š**
```hemlock
array.insert(index: i32, value: any): null
```

**å‚æ•°ï¼š**
- `index` - æ’å…¥ä½ç½®ï¼ˆä» 0 å¼€å§‹ï¼‰
- `value` - è¦æ’å…¥çš„å…ƒç´ 

**è¿”å›å€¼ï¼š** `null`

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** æ˜¯ï¼ˆåŸåœ°ä¿®æ”¹æ•°ç»„ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 4, 5];
arr.insert(2, 3);      // [1, 2, 3, 4, 5]

let arr2 = [1, 3];
arr2.insert(1, 2);     // [1, 2, 3]

// åœ¨æœ«å°¾æ’å…¥
arr2.insert(arr2.length, 4);  // [1, 2, 3, 4]
```

**è¡Œä¸ºï¼š** å°†ç´¢å¼•ä½ç½®åŠå…¶åçš„å…ƒç´ å‘å³ç§»åŠ¨ã€‚

---

#### remove

ç§»é™¤å¹¶è¿”å›æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ ã€‚

**ç­¾åï¼š**
```hemlock
array.remove(index: i32): any
```

**å‚æ•°ï¼š**
- `index` - è¦ç§»é™¤çš„ä½ç½®ï¼ˆä» 0 å¼€å§‹ï¼‰

**è¿”å›å€¼ï¼š** è¢«ç§»é™¤çš„å…ƒç´ 

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** æ˜¯ï¼ˆåŸåœ°ä¿®æ”¹æ•°ç»„ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3, 4, 5];
let removed = arr.remove(0);  // 1
print(arr);                   // [2, 3, 4, 5]

let removed2 = arr.remove(2); // 4
print(arr);                   // [2, 3, 5]
```

**è¡Œä¸ºï¼š** å°†ç´¢å¼•ä½ç½®åçš„å…ƒç´ å‘å·¦ç§»åŠ¨ã€‚

**é”™è¯¯ï¼š** å¦‚æœç´¢å¼•è¶…å‡ºè¾¹ç•Œåˆ™æŠ›å‡ºè¿è¡Œæ—¶é”™è¯¯ã€‚

---

### æœç´¢ä¸æŸ¥æ‰¾

#### find

æŸ¥æ‰¾å€¼çš„ç¬¬ä¸€æ¬¡å‡ºç°ä½ç½®ã€‚

**ç­¾åï¼š**
```hemlock
array.find(value: any): i32
```

**å‚æ•°ï¼š**
- `value` - è¦æœç´¢çš„å€¼

**è¿”å›å€¼ï¼š** ç¬¬ä¸€æ¬¡å‡ºç°çš„ç´¢å¼•ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› `-1`

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [10, 20, 30, 40];
let idx = arr.find(30);      // 2
let idx2 = arr.find(99);     // -1ï¼ˆæœªæ‰¾åˆ°ï¼‰

// æŸ¥æ‰¾ç¬¬ä¸€ä¸ªé‡å¤é¡¹
let arr2 = [1, 2, 3, 2, 4];
let idx3 = arr2.find(2);     // 1ï¼ˆç¬¬ä¸€æ¬¡å‡ºç°ï¼‰
```

**æ¯”è¾ƒæ–¹å¼ï¼š** å¯¹åŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²ä½¿ç”¨å€¼ç›¸ç­‰æ¯”è¾ƒã€‚

---

#### contains

æ£€æŸ¥æ•°ç»„æ˜¯å¦åŒ…å«æŸä¸ªå€¼ã€‚

**ç­¾åï¼š**
```hemlock
array.contains(value: any): bool
```

**å‚æ•°ï¼š**
- `value` - è¦æœç´¢çš„å€¼

**è¿”å›å€¼ï¼š** å¦‚æœæ‰¾åˆ°è¿”å› `true`ï¼Œå¦åˆ™è¿”å› `false`

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [10, 20, 30, 40];
let has = arr.contains(20);  // true
let has2 = arr.contains(99); // false

// å¯¹å­—ç¬¦ä¸²ä¹Ÿé€‚ç”¨
let words = ["hello", "world"];
let has3 = words.contains("hello");  // true
```

---

### åˆ‡ç‰‡ä¸æå–

#### slice

æŒ‰èŒƒå›´æå–å­æ•°ç»„ï¼ˆç»“æŸä½ç½®ä¸åŒ…å«ï¼‰ã€‚

**ç­¾åï¼š**
```hemlock
array.slice(start: i32, end: i32): array
```

**å‚æ•°ï¼š**
- `start` - èµ·å§‹ç´¢å¼•ï¼ˆä» 0 å¼€å§‹ï¼ŒåŒ…å«ï¼‰
- `end` - ç»“æŸç´¢å¼•ï¼ˆä¸åŒ…å«ï¼‰

**è¿”å›å€¼ï¼š** åŒ…å« [start, end) èŒƒå›´å†…å…ƒç´ çš„æ–°æ•°ç»„

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** å¦ï¼ˆè¿”å›æ–°æ•°ç»„ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3, 4, 5];
let sub = arr.slice(1, 4);   // [2, 3, 4]
let first_three = arr.slice(0, 3);  // [1, 2, 3]
let last_two = arr.slice(3, 5);     // [4, 5]

// ç©ºåˆ‡ç‰‡
let empty = arr.slice(2, 2); // []
```

---

#### first

è·å–ç¬¬ä¸€ä¸ªå…ƒç´ ä½†ä¸ç§»é™¤ã€‚

**ç­¾åï¼š**
```hemlock
array.first(): any
```

**è¿”å›å€¼ï¼š** ç¬¬ä¸€ä¸ªå…ƒç´ 

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** å¦

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3];
let f = arr.first();         // 1
print(arr);                  // [1, 2, 3]ï¼ˆæœªæ”¹å˜ï¼‰
```

**é”™è¯¯ï¼š** å¦‚æœæ•°ç»„ä¸ºç©ºåˆ™æŠ›å‡ºè¿è¡Œæ—¶é”™è¯¯ã€‚

---

#### last

è·å–æœ€åä¸€ä¸ªå…ƒç´ ä½†ä¸ç§»é™¤ã€‚

**ç­¾åï¼š**
```hemlock
array.last(): any
```

**è¿”å›å€¼ï¼š** æœ€åä¸€ä¸ªå…ƒç´ 

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** å¦

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3];
let l = arr.last();          // 3
print(arr);                  // [1, 2, 3]ï¼ˆæœªæ”¹å˜ï¼‰
```

**é”™è¯¯ï¼š** å¦‚æœæ•°ç»„ä¸ºç©ºåˆ™æŠ›å‡ºè¿è¡Œæ—¶é”™è¯¯ã€‚

---

### æ•°ç»„æ“ä½œ

#### reverse

åŸåœ°åè½¬æ•°ç»„ã€‚

**ç­¾åï¼š**
```hemlock
array.reverse(): null
```

**è¿”å›å€¼ï¼š** `null`

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** æ˜¯ï¼ˆåŸåœ°ä¿®æ”¹æ•°ç»„ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3, 4, 5];
arr.reverse();               // [5, 4, 3, 2, 1]
print(arr);                  // [5, 4, 3, 2, 1]

let words = ["hello", "world"];
words.reverse();             // ["world", "hello"]
```

---

#### clear

ç§»é™¤æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚

**ç­¾åï¼š**
```hemlock
array.clear(): null
```

**è¿”å›å€¼ï¼š** `null`

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** æ˜¯ï¼ˆåŸåœ°ä¿®æ”¹æ•°ç»„ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3, 4, 5];
arr.clear();
print(arr);                  // []
print(arr.length);           // 0
```

---

### æ•°ç»„åˆå¹¶

#### concat

ä¸å¦ä¸€ä¸ªæ•°ç»„è¿æ¥ã€‚

**ç­¾åï¼š**
```hemlock
array.concat(other: array): array
```

**å‚æ•°ï¼š**
- `other` - è¦è¿æ¥çš„æ•°ç»„

**è¿”å›å€¼ï¼š** åŒ…å«ä¸¤ä¸ªæ•°ç»„å…ƒç´ çš„æ–°æ•°ç»„

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** å¦ï¼ˆè¿”å›æ–°æ•°ç»„ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let a = [1, 2, 3];
let b = [4, 5, 6];
let combined = a.concat(b);  // [1, 2, 3, 4, 5, 6]
print(a);                    // [1, 2, 3]ï¼ˆæœªæ”¹å˜ï¼‰
print(b);                    // [4, 5, 6]ï¼ˆæœªæ”¹å˜ï¼‰

// é“¾å¼è¿æ¥
let c = [7, 8];
let all = a.concat(b).concat(c);  // [1, 2, 3, 4, 5, 6, 7, 8]
```

---

### å‡½æ•°å¼æ“ä½œ

#### map

ä½¿ç”¨å›è°ƒå‡½æ•°è½¬æ¢æ¯ä¸ªå…ƒç´ ã€‚

**ç­¾åï¼š**
```hemlock
array.map(callback: fn): array
```

**å‚æ•°ï¼š**
- `callback` - æ¥æ”¶ä¸€ä¸ªå…ƒç´ å¹¶è¿”å›è½¬æ¢åå€¼çš„å‡½æ•°

**è¿”å›å€¼ï¼š** åŒ…å«è½¬æ¢åå…ƒç´ çš„æ–°æ•°ç»„

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** å¦ï¼ˆè¿”å›æ–°æ•°ç»„ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3, 4, 5];
let doubled = arr.map(fn(x) { return x * 2; });
print(doubled);  // [2, 4, 6, 8, 10]

let names = ["alice", "bob"];
let upper = names.map(fn(s) { return s.to_upper(); });
print(upper);  // ["ALICE", "BOB"]
```

---

#### filter

é€‰æ‹©åŒ¹é…è°“è¯çš„å…ƒç´ ã€‚

**ç­¾åï¼š**
```hemlock
array.filter(predicate: fn): array
```

**å‚æ•°ï¼š**
- `predicate` - æ¥æ”¶ä¸€ä¸ªå…ƒç´ å¹¶è¿”å› bool çš„å‡½æ•°

**è¿”å›å€¼ï¼š** åŒ…å«è°“è¯è¿”å› true çš„å…ƒç´ çš„æ–°æ•°ç»„

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** å¦ï¼ˆè¿”å›æ–°æ•°ç»„ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3, 4, 5, 6];
let evens = arr.filter(fn(x) { return x % 2 == 0; });
print(evens);  // [2, 4, 6]

let words = ["hello", "hi", "hey", "goodbye"];
let short = words.filter(fn(s) { return s.length < 4; });
print(short);  // ["hi", "hey"]
```

---

#### reduce

ä½¿ç”¨ç´¯åŠ å™¨å°†æ•°ç»„å½’çº¦ä¸ºå•ä¸ªå€¼ã€‚

**ç­¾åï¼š**
```hemlock
array.reduce(callback: fn, initial: any): any
```

**å‚æ•°ï¼š**
- `callback` - æ¥æ”¶ (ç´¯åŠ å™¨, å…ƒç´ ) å¹¶è¿”å›æ–°ç´¯åŠ å™¨çš„å‡½æ•°
- `initial` - ç´¯åŠ å™¨çš„åˆå§‹å€¼

**è¿”å›å€¼ï¼š** æœ€ç»ˆç´¯åŠ å€¼

**æ˜¯å¦ä¿®æ”¹åŸæ•°ç»„ï¼š** å¦

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3, 4, 5];
let sum = arr.reduce(fn(acc, x) { return acc + x; }, 0);
print(sum);  // 15

let product = arr.reduce(fn(acc, x) { return acc * x; }, 1);
print(product);  // 120

// æŸ¥æ‰¾æœ€å¤§å€¼
let max = arr.reduce(fn(acc, x) {
    if (x > acc) { return x; }
    return acc;
}, arr[0]);
print(max);  // 5
```

---

### å­—ç¬¦ä¸²è½¬æ¢

#### join

ä½¿ç”¨åˆ†éš”ç¬¦å°†å…ƒç´ è¿æ¥æˆå­—ç¬¦ä¸²ã€‚

**ç­¾åï¼š**
```hemlock
array.join(delimiter: string): string
```

**å‚æ•°ï¼š**
- `delimiter` - æ”¾ç½®åœ¨å…ƒç´ ä¹‹é—´çš„å­—ç¬¦ä¸²

**è¿”å›å€¼ï¼š** è¿æ¥æ‰€æœ‰å…ƒç´ çš„å­—ç¬¦ä¸²

**ç¤ºä¾‹ï¼š**
```hemlock
let words = ["hello", "world", "foo"];
let joined = words.join(" ");  // "hello world foo"

let numbers = [1, 2, 3];
let csv = numbers.join(",");   // "1,2,3"

// å¯¹æ··åˆç±»å‹ä¹Ÿé€‚ç”¨
let mixed = [1, "hello", true, null];
print(mixed.join(" | "));  // "1 | hello | true | null"

// ç©ºåˆ†éš”ç¬¦
let arr = ["a", "b", "c"];
let s = arr.join("");          // "abc"
```

**è¡Œä¸ºï¼š** è‡ªåŠ¨å°†æ‰€æœ‰å…ƒç´ è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚

---

## æ–¹æ³•é“¾å¼è°ƒç”¨

æ•°ç»„æ–¹æ³•å¯ä»¥é“¾å¼è°ƒç”¨ä»¥å®ç°ç®€æ´çš„æ“ä½œï¼š

**ç¤ºä¾‹ï¼š**
```hemlock
// é“¾å¼è°ƒç”¨ slice å’Œ join
let result = ["apple", "banana", "cherry", "date"]
    .slice(0, 2)
    .join(" and ");  // "apple and banana"

// é“¾å¼è°ƒç”¨ concat å’Œ slice
let combined = [1, 2, 3]
    .concat([4, 5, 6])
    .slice(2, 5);    // [3, 4, 5]

// å¤æ‚é“¾å¼è°ƒç”¨
let words = ["hello", "world", "foo", "bar"];
let result2 = words
    .slice(0, 3)
    .concat(["baz"])
    .join("-");      // "hello-world-foo-baz"
```

---

## å®Œæ•´æ–¹æ³•æ€»ç»“

### ä¿®æ”¹åŸæ•°ç»„çš„æ–¹æ³•

åŸåœ°ä¿®æ”¹æ•°ç»„çš„æ–¹æ³•ï¼š

| æ–¹æ³•       | ç­¾å                       | è¿”å›å€¼    | æè¿°                           |
|------------|----------------------------|-----------|--------------------------------|
| `push`     | `(value: any)`             | `null`    | æ·»åŠ åˆ°æœ«å°¾                     |
| `pop`      | `()`                       | `any`     | ä»æœ«å°¾ç§»é™¤                     |
| `shift`    | `()`                       | `any`     | ä»å¼€å¤´ç§»é™¤                     |
| `unshift`  | `(value: any)`             | `null`    | æ·»åŠ åˆ°å¼€å¤´                     |
| `insert`   | `(index: i32, value: any)` | `null`    | åœ¨ç´¢å¼•ä½ç½®æ’å…¥                 |
| `remove`   | `(index: i32)`             | `any`     | åœ¨ç´¢å¼•ä½ç½®ç§»é™¤                 |
| `reverse`  | `()`                       | `null`    | åŸåœ°åè½¬                       |
| `clear`    | `()`                       | `null`    | ç§»é™¤æ‰€æœ‰å…ƒç´                    |

### ä¸ä¿®æ”¹åŸæ•°ç»„çš„æ–¹æ³•

è¿”å›æ–°å€¼è€Œä¸ä¿®æ”¹åŸæ•°ç»„çš„æ–¹æ³•ï¼š

| æ–¹æ³•       | ç­¾å                       | è¿”å›å€¼    | æè¿°                           |
|------------|----------------------------|-----------|--------------------------------|
| `find`     | `(value: any)`             | `i32`     | æŸ¥æ‰¾ç¬¬ä¸€æ¬¡å‡ºç°ä½ç½®             |
| `contains` | `(value: any)`             | `bool`    | æ£€æŸ¥æ˜¯å¦åŒ…å«å€¼                 |
| `slice`    | `(start: i32, end: i32)`   | `array`   | æå–å­æ•°ç»„                     |
| `first`    | `()`                       | `any`     | è·å–ç¬¬ä¸€ä¸ªå…ƒç´                  |
| `last`     | `()`                       | `any`     | è·å–æœ€åä¸€ä¸ªå…ƒç´                |
| `concat`   | `(other: array)`           | `array`   | è¿æ¥æ•°ç»„                       |
| `join`     | `(delimiter: string)`      | `string`  | å°†å…ƒç´ è¿æ¥æˆå­—ç¬¦ä¸²             |
| `map`      | `(callback: fn)`           | `array`   | è½¬æ¢æ¯ä¸ªå…ƒç´                    |
| `filter`   | `(predicate: fn)`          | `array`   | é€‰æ‹©åŒ¹é…çš„å…ƒç´                  |
| `reduce`   | `(callback: fn, initial: any)` | `any` | å½’çº¦ä¸ºå•ä¸ªå€¼                   |

---

## ä½¿ç”¨æ¨¡å¼

### æ ˆç”¨æ³•

```hemlock
let stack = [];

// å‹æ ˆ
stack.push(1);
stack.push(2);
stack.push(3);

// å¼¹æ ˆ
while (stack.length > 0) {
    let item = stack.pop();
    print(item);  // 3, 2, 1
}
```

### é˜Ÿåˆ—ç”¨æ³•

```hemlock
let queue = [];

// å…¥é˜Ÿ
queue.push(1);
queue.push(2);
queue.push(3);

// å‡ºé˜Ÿ
while (queue.length > 0) {
    let item = queue.shift();
    print(item);  // 1, 2, 3
}
```

### æ•°ç»„è½¬æ¢

```hemlock
// è¿‡æ»¤ï¼ˆæ‰‹åŠ¨æ–¹å¼ï¼‰
let numbers = [1, 2, 3, 4, 5, 6];
let evens = [];
let i = 0;
while (i < numbers.length) {
    if (numbers[i] % 2 == 0) {
        evens.push(numbers[i]);
    }
    i = i + 1;
}

// æ˜ å°„ï¼ˆæ‰‹åŠ¨æ–¹å¼ï¼‰
let numbers2 = [1, 2, 3, 4, 5];
let doubled = [];
let j = 0;
while (j < numbers2.length) {
    doubled.push(numbers2[j] * 2);
    j = j + 1;
}
```

### æ„å»ºæ•°ç»„

```hemlock
let arr = [];

// ä½¿ç”¨å¾ªç¯æ„å»ºæ•°ç»„
let i = 0;
while (i < 10) {
    arr.push(i * 10);
    i = i + 1;
}

print(arr);  // [0, 10, 20, 30, 40, 50, 60, 70, 80, 90]
```

---

## å®ç°ç»†èŠ‚

**å®¹é‡ç®¡ç†ï¼š**
- æ•°ç»„åœ¨éœ€è¦æ—¶è‡ªåŠ¨å¢é•¿
- è¶…å‡ºå®¹é‡æ—¶å®¹é‡ç¿»å€
- æ— æ‰‹åŠ¨å®¹é‡æ§åˆ¶

**å€¼æ¯”è¾ƒï¼š**
- `find()` å’Œ `contains()` ä½¿ç”¨å€¼ç›¸ç­‰æ¯”è¾ƒ
- å¯¹åŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²æ­£ç¡®å·¥ä½œ
- å¯¹è±¡/æ•°ç»„æŒ‰å¼•ç”¨æ¯”è¾ƒ

**å†…å­˜ï¼š**
- å †åˆ†é…
- æ— è‡ªåŠ¨é‡Šæ”¾ï¼ˆæ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼‰
- ç›´æ¥ç´¢å¼•è®¿é—®æ— è¾¹ç•Œæ£€æŸ¥

---

## å¦è¯·å‚é˜…

- [ç±»å‹ç³»ç»Ÿ](#reference-type-system) - æ•°ç»„ç±»å‹è¯¦æƒ…
- [å­—ç¬¦ä¸² API](#reference-string-api) - å­—ç¬¦ä¸² join() ç»“æœ
- [è¿ç®—ç¬¦](#reference-operators) - æ•°ç»„ç´¢å¼•è¿ç®—ç¬¦


--------------------------------------------------------------------------------
## æ–‡ä»¶ API
--------------------------------------------------------------------------------

# æ–‡ä»¶ API å‚è€ƒ

Hemlock æ–‡ä»¶ I/O ç³»ç»Ÿçš„å®Œæ•´å‚è€ƒæ–‡æ¡£ã€‚

---

## æ¦‚è¿°

Hemlock æä¾›äº†ä¸€ä¸ª**æ–‡ä»¶å¯¹è±¡ API**ï¼Œç”¨äºå…·æœ‰é€‚å½“é”™è¯¯å¤„ç†å’Œèµ„æºç®¡ç†çš„æ–‡ä»¶æ“ä½œã€‚æ–‡ä»¶å¿…é¡»æ‰‹åŠ¨æ‰“å¼€å’Œå…³é—­ã€‚

**ä¸»è¦ç‰¹æ€§ï¼š**
- å¸¦æœ‰æ–¹æ³•çš„æ–‡ä»¶å¯¹è±¡
- è¯»å†™æ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ•°æ®
- å®šä½å’Œä½ç½®æ“ä½œ
- é€‚å½“çš„é”™è¯¯æ¶ˆæ¯
- æ‰‹åŠ¨èµ„æºç®¡ç†ï¼ˆæ—  RAIIï¼‰

---

## æ–‡ä»¶ç±»å‹

**ç±»å‹ï¼š** `file`

**æè¿°ï¼š** ç”¨äº I/O æ“ä½œçš„æ–‡ä»¶å¥æŸ„

**å±æ€§ï¼ˆåªè¯»ï¼‰ï¼š**
- `.path` - æ–‡ä»¶è·¯å¾„ (string)
- `.mode` - æ‰“å¼€æ¨¡å¼ (string)
- `.closed` - æ–‡ä»¶æ˜¯å¦å·²å…³é—­ (bool)

---

## æ‰“å¼€æ–‡ä»¶

### open

æ‰“å¼€æ–‡ä»¶ç”¨äºè¯»å–ã€å†™å…¥æˆ–ä¸¤è€…å…¼é¡¾ã€‚

**ç­¾åï¼š**
```hemlock
open(path: string, mode?: string): file
```

**å‚æ•°ï¼š**
- `path` - æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹æˆ–ç»å¯¹ï¼‰
- `mode`ï¼ˆå¯é€‰ï¼‰- æ‰“å¼€æ¨¡å¼ï¼ˆé»˜è®¤ï¼š`"r"`ï¼‰

**è¿”å›å€¼ï¼š** æ–‡ä»¶å¯¹è±¡

**æ¨¡å¼ï¼š**
- `"r"` - è¯»å–ï¼ˆé»˜è®¤ï¼‰
- `"w"` - å†™å…¥ï¼ˆæˆªæ–­ç°æœ‰æ–‡ä»¶ï¼‰
- `"a"` - è¿½åŠ 
- `"r+"` - è¯»å†™
- `"w+"` - è¯»å†™ï¼ˆæˆªæ–­ï¼‰
- `"a+"` - è¯»å–å’Œè¿½åŠ 

**ç¤ºä¾‹ï¼š**
```hemlock
// è¯»å–æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
let f = open("data.txt");
let f_read = open("data.txt", "r");

// å†™å…¥æ¨¡å¼ï¼ˆæˆªæ–­ï¼‰
let f_write = open("output.txt", "w");

// è¿½åŠ æ¨¡å¼
let f_append = open("log.txt", "a");

// è¯»å†™æ¨¡å¼
let f_rw = open("data.bin", "r+");

// è¯»å†™ï¼ˆæˆªæ–­ï¼‰
let f_rw_trunc = open("output.bin", "w+");

// è¯»å–/è¿½åŠ 
let f_ra = open("log.txt", "a+");
```

**é”™è¯¯å¤„ç†ï¼š**
```hemlock
try {
    let f = open("missing.txt", "r");
} catch (e) {
    print("Failed to open:", e);
    // é”™è¯¯ï¼šFailed to open 'missing.txt': No such file or directory
}
```

**é‡è¦ï¼š** æ–‡ä»¶å¿…é¡»ä½¿ç”¨ `f.close()` æ‰‹åŠ¨å…³é—­ä»¥é¿å…æ–‡ä»¶æè¿°ç¬¦æ³„æ¼ã€‚

---

## æ–‡ä»¶æ–¹æ³•

### è¯»å–

#### read

ä»æ–‡ä»¶è¯»å–æ–‡æœ¬ã€‚

**ç­¾åï¼š**
```hemlock
file.read(size?: i32): string
```

**å‚æ•°ï¼š**
- `size`ï¼ˆå¯é€‰ï¼‰- è¦è¯»å–çš„å­—èŠ‚æ•°ï¼ˆå¦‚æœçœç•¥ï¼Œè¯»å–åˆ°æ–‡ä»¶æœ«å°¾ï¼‰

**è¿”å›å€¼ï¼š** åŒ…å«æ–‡ä»¶å†…å®¹çš„å­—ç¬¦ä¸²

**ç¤ºä¾‹ï¼š**
```hemlock
let f = open("data.txt", "r");

// è¯»å–æ•´ä¸ªæ–‡ä»¶
let all = f.read();
print(all);

// è¯»å–æŒ‡å®šæ•°é‡çš„å­—èŠ‚
let chunk = f.read(1024);

f.close();
```

**è¡Œä¸ºï¼š**
- ä»å½“å‰æ–‡ä»¶ä½ç½®è¯»å–
- åœ¨æ–‡ä»¶æœ«å°¾è¿”å›ç©ºå­—ç¬¦ä¸²
- å‰è¿›æ–‡ä»¶ä½ç½®

**é”™è¯¯ï¼š**
- ä»å·²å…³é—­çš„æ–‡ä»¶è¯»å–
- ä»åªå†™æ–‡ä»¶è¯»å–

---

#### read_bytes

ä»æ–‡ä»¶è¯»å–äºŒè¿›åˆ¶æ•°æ®ã€‚

**ç­¾åï¼š**
```hemlock
file.read_bytes(size: i32): buffer
```

**å‚æ•°ï¼š**
- `size` - è¦è¯»å–çš„å­—èŠ‚æ•°

**è¿”å›å€¼ï¼š** åŒ…å«äºŒè¿›åˆ¶æ•°æ®çš„ç¼“å†²åŒº

**ç¤ºä¾‹ï¼š**
```hemlock
let f = open("data.bin", "r");

// è¯»å– 256 å­—èŠ‚
let binary = f.read_bytes(256);
print(binary.length);       // 256

// å¤„ç†äºŒè¿›åˆ¶æ•°æ®
let i = 0;
while (i < binary.length) {
    print(binary[i]);
    i = i + 1;
}

f.close();
```

**è¡Œä¸ºï¼š**
- è¯»å–ç¡®åˆ‡æ•°é‡çš„å­—èŠ‚
- è¿”å›ç¼“å†²åŒºï¼ˆä¸æ˜¯å­—ç¬¦ä¸²ï¼‰
- å‰è¿›æ–‡ä»¶ä½ç½®

---

### å†™å…¥

#### write

å‘æ–‡ä»¶å†™å…¥æ–‡æœ¬ã€‚

**ç­¾åï¼š**
```hemlock
file.write(data: string): i32
```

**å‚æ•°ï¼š**
- `data` - è¦å†™å…¥çš„å­—ç¬¦ä¸²

**è¿”å›å€¼ï¼š** å†™å…¥çš„å­—èŠ‚æ•° (i32)

**ç¤ºä¾‹ï¼š**
```hemlock
let f = open("output.txt", "w");

// å†™å…¥æ–‡æœ¬
let written = f.write("Hello, World!\n");
print("Wrote", written, "bytes");

// å¤šæ¬¡å†™å…¥
f.write("Line 1\n");
f.write("Line 2\n");
f.write("Line 3\n");

f.close();
```

**è¡Œä¸ºï¼š**
- åœ¨å½“å‰æ–‡ä»¶ä½ç½®å†™å…¥
- è¿”å›å†™å…¥çš„å­—èŠ‚æ•°
- å‰è¿›æ–‡ä»¶ä½ç½®

**é”™è¯¯ï¼š**
- å‘å·²å…³é—­çš„æ–‡ä»¶å†™å…¥
- å‘åªè¯»æ–‡ä»¶å†™å…¥

---

#### write_bytes

å‘æ–‡ä»¶å†™å…¥äºŒè¿›åˆ¶æ•°æ®ã€‚

**ç­¾åï¼š**
```hemlock
file.write_bytes(data: buffer): i32
```

**å‚æ•°ï¼š**
- `data` - è¦å†™å…¥çš„ç¼“å†²åŒº

**è¿”å›å€¼ï¼š** å†™å…¥çš„å­—èŠ‚æ•° (i32)

**ç¤ºä¾‹ï¼š**
```hemlock
let f = open("output.bin", "w");

// åˆ›å»ºç¼“å†²åŒº
let buf = buffer(10);
buf[0] = 65;  // 'A'
buf[1] = 66;  // 'B'
buf[2] = 67;  // 'C'

// å†™å…¥ç¼“å†²åŒº
let written = f.write_bytes(buf);
print("Wrote", written, "bytes");

f.close();
```

**è¡Œä¸ºï¼š**
- å°†ç¼“å†²åŒºå†…å®¹å†™å…¥æ–‡ä»¶
- è¿”å›å†™å…¥çš„å­—èŠ‚æ•°
- å‰è¿›æ–‡ä»¶ä½ç½®

---

### å®šä½

#### seek

å°†æ–‡ä»¶ä½ç½®ç§»åŠ¨åˆ°æŒ‡å®šçš„å­—èŠ‚åç§»é‡ã€‚

**ç­¾åï¼š**
```hemlock
file.seek(position: i32): i32
```

**å‚æ•°ï¼š**
- `position` - ä»æ–‡ä»¶å¼€å¤´çš„å­—èŠ‚åç§»é‡

**è¿”å›å€¼ï¼š** æ–°çš„æ–‡ä»¶ä½ç½® (i32)

**ç¤ºä¾‹ï¼š**
```hemlock
let f = open("data.txt", "r");

// è·³è½¬åˆ°ç¬¬ 100 å­—èŠ‚
f.seek(100);

// ä»è¯¥ä½ç½®è¯»å–
let chunk = f.read(50);

// é‡ç½®åˆ°å¼€å¤´
f.seek(0);

// ä»å¼€å¤´è¯»å–
let all = f.read();

f.close();
```

**è¡Œä¸ºï¼š**
- å°†æ–‡ä»¶ä½ç½®è®¾ç½®ä¸ºç»å¯¹åç§»é‡
- è¿”å›æ–°ä½ç½®
- å…è®¸å®šä½åˆ°æ–‡ä»¶æœ«å°¾ä¹‹åï¼ˆå†™å…¥æ—¶ä¼šåœ¨æ–‡ä»¶ä¸­åˆ›å»ºç©ºæ´ï¼‰

---

#### tell

è·å–å½“å‰æ–‡ä»¶ä½ç½®ã€‚

**ç­¾åï¼š**
```hemlock
file.tell(): i32
```

**è¿”å›å€¼ï¼š** ä»æ–‡ä»¶å¼€å¤´çš„å½“å‰å­—èŠ‚åç§»é‡ (i32)

**ç¤ºä¾‹ï¼š**
```hemlock
let f = open("data.txt", "r");

print(f.tell());        // 0ï¼ˆåœ¨å¼€å¤´ï¼‰

f.read(100);
print(f.tell());        // 100ï¼ˆè¯»å–åï¼‰

f.seek(50);
print(f.tell());        // 50ï¼ˆå®šä½åï¼‰

f.close();
```

---

### å…³é—­

#### close

å…³é—­æ–‡ä»¶ï¼ˆå¹‚ç­‰ï¼‰ã€‚

**ç­¾åï¼š**
```hemlock
file.close(): null
```

**è¿”å›å€¼ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
let f = open("data.txt", "r");
let content = f.read();
f.close();

// å¯ä»¥å®‰å…¨åœ°å¤šæ¬¡è°ƒç”¨
f.close();  // æ— é”™è¯¯
f.close();  // æ— é”™è¯¯
```

**è¡Œä¸ºï¼š**
- å…³é—­æ–‡ä»¶å¥æŸ„
- åˆ·æ–°ä»»ä½•å¾…å¤„ç†çš„å†™å…¥
- å¹‚ç­‰ï¼ˆå¯ä»¥å®‰å…¨åœ°å¤šæ¬¡è°ƒç”¨ï¼‰
- å°† `.closed` å±æ€§è®¾ç½®ä¸º `true`

**é‡è¦ï¼š** å®Œæˆåå§‹ç»ˆå…³é—­æ–‡ä»¶ä»¥é¿å…æ–‡ä»¶æè¿°ç¬¦æ³„æ¼ã€‚

---

## æ–‡ä»¶å±æ€§

### .path

è·å–æ–‡ä»¶è·¯å¾„ã€‚

**ç±»å‹ï¼š** `string`

**è®¿é—®ï¼š** åªè¯»

**ç¤ºä¾‹ï¼š**
```hemlock
let f = open("/path/to/file.txt", "r");
print(f.path);          // "/path/to/file.txt"
f.close();
```

---

### .mode

è·å–æ‰“å¼€æ¨¡å¼ã€‚

**ç±»å‹ï¼š** `string`

**è®¿é—®ï¼š** åªè¯»

**ç¤ºä¾‹ï¼š**
```hemlock
let f = open("data.txt", "r");
print(f.mode);          // "r"
f.close();

let f2 = open("output.txt", "w");
print(f2.mode);         // "w"
f2.close();
```

---

### .closed

æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å…³é—­ã€‚

**ç±»å‹ï¼š** `bool`

**è®¿é—®ï¼š** åªè¯»

**ç¤ºä¾‹ï¼š**
```hemlock
let f = open("data.txt", "r");
print(f.closed);        // false

f.close();
print(f.closed);        // true
```

---

## é”™è¯¯å¤„ç†

æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½åŒ…å«å¸¦æœ‰ä¸Šä¸‹æ–‡çš„é€‚å½“é”™è¯¯æ¶ˆæ¯ï¼š

### æ–‡ä»¶æœªæ‰¾åˆ°
```hemlock
let f = open("missing.txt", "r");
// é”™è¯¯ï¼šFailed to open 'missing.txt': No such file or directory
```

### ä»å·²å…³é—­çš„æ–‡ä»¶è¯»å–
```hemlock
let f = open("data.txt", "r");
f.close();
f.read();
// é”™è¯¯ï¼šCannot read from closed file 'data.txt'
```

### å‘åªè¯»æ–‡ä»¶å†™å…¥
```hemlock
let f = open("readonly.txt", "r");
f.write("data");
// é”™è¯¯ï¼šCannot write to file 'readonly.txt' opened in read-only mode
```

### ä½¿ç”¨ try/catch
```hemlock
let f = null;
try {
    f = open("data.txt", "r");
    let content = f.read();
    print(content);
} catch (e) {
    print("File error:", e);
} finally {
    if (f != null && !f.closed) {
        f.close();
    }
}
```

---

## èµ„æºç®¡ç†æ¨¡å¼

### åŸºæœ¬æ¨¡å¼

```hemlock
let f = open("data.txt", "r");
let content = f.read();
f.close();
```

### å¸¦é”™è¯¯å¤„ç†

```hemlock
let f = open("data.txt", "r");
try {
    let content = f.read();
    process(content);
} finally {
    f.close();  // å§‹ç»ˆå…³é—­ï¼Œå³ä½¿å‡ºé”™
}
```

### å®‰å…¨æ¨¡å¼

```hemlock
let f = null;
try {
    f = open("data.txt", "r");
    let content = f.read();
    // ... å¤„ç†å†…å®¹ ...
} catch (e) {
    print("Error:", e);
} finally {
    if (f != null && !f.closed) {
        f.close();
    }
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

### è¯»å–æ•´ä¸ªæ–‡ä»¶

```hemlock
fn read_file(filename: string): string {
    let f = open(filename, "r");
    let content = f.read();
    f.close();
    return content;
}

let text = read_file("data.txt");
print(text);
```

### å†™å…¥æ–‡æœ¬æ–‡ä»¶

```hemlock
fn write_file(filename: string, content: string) {
    let f = open(filename, "w");
    f.write(content);
    f.close();
}

write_file("output.txt", "Hello, World!\n");
```

### è¿½åŠ åˆ°æ–‡ä»¶

```hemlock
fn append_file(filename: string, line: string) {
    let f = open(filename, "a");
    f.write(line + "\n");
    f.close();
}

append_file("log.txt", "Log entry 1");
append_file("log.txt", "Log entry 2");
```

### è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶

```hemlock
fn read_binary(filename: string, size: i32): buffer {
    let f = open(filename, "r");
    let data = f.read_bytes(size);
    f.close();
    return data;
}

let binary = read_binary("data.bin", 256);
print("Read", binary.length, "bytes");
```

### å†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶

```hemlock
fn write_binary(filename: string, data: buffer) {
    let f = open(filename, "w");
    f.write_bytes(data);
    f.close();
}

let buf = buffer(10);
buf[0] = 65;
write_binary("output.bin", buf);
```

### é€è¡Œè¯»å–æ–‡ä»¶

```hemlock
fn read_lines(filename: string): array {
    let f = open(filename, "r");
    let content = f.read();
    f.close();
    return content.split("\n");
}

let lines = read_lines("data.txt");
let i = 0;
while (i < lines.length) {
    print("Line", i, ":", lines[i]);
    i = i + 1;
}
```

### å¤åˆ¶æ–‡ä»¶

```hemlock
fn copy_file(src: string, dest: string) {
    let f_in = open(src, "r");
    let f_out = open(dest, "w");

    let content = f_in.read();
    f_out.write(content);

    f_in.close();
    f_out.close();
}

copy_file("input.txt", "output.txt");
```

### åˆ†å—è¯»å–æ–‡ä»¶

```hemlock
fn process_chunks(filename: string) {
    let f = open(filename, "r");

    while (true) {
        let chunk = f.read(1024);  // æ¯æ¬¡è¯»å– 1KB
        if (chunk.length == 0) {
            break;  // æ–‡ä»¶æœ«å°¾
        }

        // å¤„ç†å—
        print("Processing", chunk.length, "bytes");
    }

    f.close();
}

process_chunks("large_file.txt");
```

---

## å®Œæ•´æ–¹æ³•æ€»ç»“

| æ–¹æ³•          | ç­¾å                     | è¿”å›å€¼    | æè¿°                         |
|---------------|--------------------------|-----------|------------------------------|
| `read`        | `(size?: i32)`           | `string`  | è¯»å–æ–‡æœ¬                     |
| `read_bytes`  | `(size: i32)`            | `buffer`  | è¯»å–äºŒè¿›åˆ¶æ•°æ®               |
| `write`       | `(data: string)`         | `i32`     | å†™å…¥æ–‡æœ¬                     |
| `write_bytes` | `(data: buffer)`         | `i32`     | å†™å…¥äºŒè¿›åˆ¶æ•°æ®               |
| `seek`        | `(position: i32)`        | `i32`     | è®¾ç½®æ–‡ä»¶ä½ç½®                 |
| `tell`        | `()`                     | `i32`     | è·å–æ–‡ä»¶ä½ç½®                 |
| `close`       | `()`                     | `null`    | å…³é—­æ–‡ä»¶ï¼ˆå¹‚ç­‰ï¼‰             |

---

## å®Œæ•´å±æ€§æ€»ç»“

| å±æ€§      | ç±»å‹     | è®¿é—®       | æè¿°                     |
|-----------|----------|------------|--------------------------|
| `.path`   | `string` | åªè¯»       | æ–‡ä»¶è·¯å¾„                 |
| `.mode`   | `string` | åªè¯»       | æ‰“å¼€æ¨¡å¼                 |
| `.closed` | `bool`   | åªè¯»       | æ–‡ä»¶æ˜¯å¦å·²å…³é—­           |

---

## ä»æ—§ API è¿ç§»

**æ—§ APIï¼ˆå·²ç§»é™¤ï¼‰ï¼š**
- `read_file(path)` - ä½¿ç”¨ `open(path, "r").read()`
- `write_file(path, data)` - ä½¿ç”¨ `open(path, "w").write(data)`
- `append_file(path, data)` - ä½¿ç”¨ `open(path, "a").write(data)`
- `file_exists(path)` - æš‚æ— æ›¿ä»£

**è¿ç§»ç¤ºä¾‹ï¼š**
```hemlock
// æ—§ç‰ˆï¼ˆv0.0ï¼‰
let content = read_file("data.txt");
write_file("output.txt", content);

// æ–°ç‰ˆï¼ˆv0.1ï¼‰
let f = open("data.txt", "r");
let content = f.read();
f.close();

let f2 = open("output.txt", "w");
f2.write(content);
f2.close();
```

---

## å¦è¯·å‚é˜…

- [å†…ç½®å‡½æ•°](#reference-builtins) - `open()` å‡½æ•°
- [å†…å­˜ API](#reference-memory-api) - ç¼“å†²åŒºç±»å‹
- [å­—ç¬¦ä¸² API](#reference-string-api) - ç”¨äºæ–‡æœ¬å¤„ç†çš„å­—ç¬¦ä¸²æ–¹æ³•


--------------------------------------------------------------------------------
## ç±»å‹ç³»ç»Ÿ
--------------------------------------------------------------------------------

# ç±»å‹ç³»ç»Ÿå‚è€ƒ

Hemlock ç±»å‹ç³»ç»Ÿçš„å®Œæ•´å‚è€ƒï¼ŒåŒ…æ‹¬æ‰€æœ‰åŸå§‹ç±»å‹å’Œå¤åˆç±»å‹ã€‚

---

## æ¦‚è¿°

Hemlock ä½¿ç”¨**åŠ¨æ€ç±»å‹ç³»ç»Ÿ**ï¼Œå…·æœ‰è¿è¡Œæ—¶ç±»å‹æ ‡ç­¾å’Œå¯é€‰çš„ç±»å‹æ³¨è§£ã€‚æ¯ä¸ªå€¼éƒ½æœ‰è¿è¡Œæ—¶ç±»å‹ï¼Œç±»å‹è½¬æ¢éµå¾ªæ˜ç¡®çš„æå‡è§„åˆ™ã€‚

**ä¸»è¦ç‰¹æ€§ï¼š**
- è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ï¼ˆè§£é‡Šå™¨ï¼‰
- ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼ˆhemlockc - é»˜è®¤å¯ç”¨ï¼‰
- å¯é€‰ç±»å‹æ³¨è§£
- å­—é¢é‡è‡ªåŠ¨ç±»å‹æ¨æ–­
- æ˜ç¡®çš„ç±»å‹æå‡è§„åˆ™
- ä¸ä¼šéšå¼è½¬æ¢å¯¼è‡´ç²¾åº¦æŸå¤±

---

## ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ (hemlockc)

Hemlock ç¼–è¯‘å™¨ï¼ˆ`hemlockc`ï¼‰åŒ…å«ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥å™¨ï¼Œåœ¨ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ä¹‹å‰éªŒè¯æ‚¨çš„ä»£ç ã€‚è¿™å¯ä»¥åœ¨ä¸è¿è¡Œç¨‹åºçš„æƒ…å†µä¸‹åŠæ—©å‘ç°ç±»å‹é”™è¯¯ã€‚

### é»˜è®¤è¡Œä¸º

ç±»å‹æ£€æŸ¥åœ¨ hemlockc ä¸­**é»˜è®¤å¯ç”¨**ï¼š

```bash
# Type checking happens automatically
hemlockc program.hml -o program

# Errors are reported before compilation
hemlockc bad_types.hml
# Output: 1 type error found
```

### ç¼–è¯‘å™¨æ ‡å¿—

| æ ‡å¿— | æè¿° |
|------|------|
| `--check` | ä»…æ£€æŸ¥ç±»å‹ï¼Œä¸ç¼–è¯‘ï¼ˆéªŒè¯åé€€å‡ºï¼‰ |
| `--no-type-check` | ç¦ç”¨ç±»å‹æ£€æŸ¥ï¼ˆä¸æ¨èï¼‰ |
| `--strict-types` | å¯ç”¨æ›´ä¸¥æ ¼çš„ç±»å‹è­¦å‘Š |

**ç¤ºä¾‹ï¼š**

```bash
# Just validate types without compiling
hemlockc --check program.hml
# Output: program.hml: no type errors

# Disable type checking (use with caution)
hemlockc --no-type-check dynamic_code.hml -o program

# Enable strict warnings for implicit any types
hemlockc --strict-types program.hml -o program
```

### ç±»å‹æ£€æŸ¥å™¨éªŒè¯çš„å†…å®¹

1. **ç±»å‹æ³¨è§£** - ç¡®ä¿èµ‹å€¼çš„å€¼ä¸å£°æ˜çš„ç±»å‹åŒ¹é…
2. **å‡½æ•°è°ƒç”¨** - éªŒè¯å‚æ•°ç±»å‹ä¸å‚æ•°ç±»å‹åŒ¹é…
3. **è¿”å›ç±»å‹** - æ£€æŸ¥è¿”å›è¯­å¥ä¸å£°æ˜çš„è¿”å›ç±»å‹åŒ¹é…
4. **è¿ç®—ç¬¦ä½¿ç”¨** - éªŒè¯æ“ä½œæ•°å…¼å®¹
5. **å±æ€§è®¿é—®** - éªŒè¯ç±»å‹åŒ–å¯¹è±¡çš„å¯¹è±¡å­—æ®µç±»å‹

### å®½æ¾çš„æ•°å€¼è½¬æ¢

ç±»å‹æ£€æŸ¥å™¨å…è®¸åœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ•°å€¼ç±»å‹è½¬æ¢ï¼ŒèŒƒå›´éªŒè¯åœ¨è¿è¡Œæ—¶è¿›è¡Œï¼š

```hemlock
let x: i8 = 100;      // OK - 100 fits in i8 (validated at runtime)
let y: u8 = 255;      // OK - within u8 range
let z: f64 = 42;      // OK - i32 to f64 is safe
```

### åŠ¨æ€ä»£ç æ”¯æŒ

æ²¡æœ‰ç±»å‹æ³¨è§£çš„ä»£ç è¢«è§†ä¸ºåŠ¨æ€çš„ï¼ˆ`any` ç±»å‹ï¼‰ï¼Œå§‹ç»ˆé€šè¿‡ç±»å‹æ£€æŸ¥å™¨ï¼š

```hemlock
let x = get_value();  // Dynamic - no annotation
process(x);           // OK - dynamic values accepted anywhere
```

---

## åŸå§‹ç±»å‹

### æ•°å€¼ç±»å‹

#### æœ‰ç¬¦å·æ•´æ•°

| ç±»å‹   | å¤§å°    | èŒƒå›´                                       | åˆ«å      |
|--------|---------|-------------------------------------------|-----------|
| `i8`   | 1 å­—èŠ‚  | -128 åˆ° 127                               | -         |
| `i16`  | 2 å­—èŠ‚  | -32,768 åˆ° 32,767                         | -         |
| `i32`  | 4 å­—èŠ‚  | -2,147,483,648 åˆ° 2,147,483,647           | `integer` |
| `i64`  | 8 å­—èŠ‚  | -9,223,372,036,854,775,808 åˆ° 9,223,372,036,854,775,807 | - |

**ç¤ºä¾‹ï¼š**
```hemlock
let a: i8 = 127;
let b: i16 = 32000;
let c: i32 = 1000000;
let d: i64 = 9223372036854775807;

// Type alias
let x: integer = 42;  // Same as i32
```

#### æ— ç¬¦å·æ•´æ•°

| ç±»å‹   | å¤§å°    | èŒƒå›´                      | åˆ«å   |
|--------|---------|---------------------------|--------|
| `u8`   | 1 å­—èŠ‚  | 0 åˆ° 255                  | `byte` |
| `u16`  | 2 å­—èŠ‚  | 0 åˆ° 65,535               | -      |
| `u32`  | 4 å­—èŠ‚  | 0 åˆ° 4,294,967,295        | -      |
| `u64`  | 8 å­—èŠ‚  | 0 åˆ° 18,446,744,073,709,551,615 | - |

**ç¤ºä¾‹ï¼š**
```hemlock
let a: u8 = 255;
let b: u16 = 65535;
let c: u32 = 4294967295;
let d: u64 = 18446744073709551615;

// Type alias
let byte_val: byte = 65;  // Same as u8
```

#### æµ®ç‚¹æ•°

| ç±»å‹   | å¤§å°    | ç²¾åº¦         | åˆ«å     |
|--------|---------|--------------|----------|
| `f32`  | 4 å­—èŠ‚  | çº¦ 7 ä½æ•°å­—  | -        |
| `f64`  | 8 å­—èŠ‚  | çº¦ 15 ä½æ•°å­— | `number` |

**ç¤ºä¾‹ï¼š**
```hemlock
let pi: f32 = 3.14159;
let precise: f64 = 3.14159265359;

// Type alias
let x: number = 2.718;  // Same as f64
```

---

### æ•´æ•°å­—é¢é‡æ¨æ–­

æ•´æ•°å­—é¢é‡æ ¹æ®å…¶å€¼è‡ªåŠ¨ç¡®å®šç±»å‹ï¼š

**è§„åˆ™ï¼š**
- åœ¨ i32 èŒƒå›´å†…çš„å€¼ï¼ˆ-2,147,483,648 åˆ° 2,147,483,647ï¼‰ï¼šæ¨æ–­ä¸º `i32`
- è¶…å‡º i32 èŒƒå›´ä½†åœ¨ i64 èŒƒå›´å†…çš„å€¼ï¼šæ¨æ–­ä¸º `i64`
- å…¶ä»–ç±»å‹ï¼ˆi8ã€i16ã€u8ã€u16ã€u32ã€u64ï¼‰ä½¿ç”¨æ˜¾å¼ç±»å‹æ³¨è§£

**ç¤ºä¾‹ï¼š**
```hemlock
let small = 42;                    // i32 (fits in i32)
let large = 5000000000;            // i64 (> i32 max)
let max_i64 = 9223372036854775807; // i64 (INT64_MAX)
let explicit: u32 = 100;           // u32 (type annotation overrides)
```

---

### å¸ƒå°”ç±»å‹

**ç±»å‹ï¼š** `bool`

**å€¼ï¼š** `true`ã€`false`

**å¤§å°ï¼š** 1 å­—èŠ‚ï¼ˆå†…éƒ¨ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
let is_active: bool = true;
let done = false;

if (is_active && !done) {
    print("working");
}
```

---

### å­—ç¬¦ç±»å‹

#### Rune

**ç±»å‹ï¼š** `rune`

**æè¿°ï¼š** Unicode ç ç‚¹ (U+0000 åˆ° U+10FFFF)

**å¤§å°ï¼š** 4 å­—èŠ‚ï¼ˆ32 ä½å€¼ï¼‰

**èŒƒå›´ï¼š** 0 åˆ° 0x10FFFF (1,114,111)

**å­—é¢é‡è¯­æ³•ï¼š** å•å¼•å· `'x'`

**ç¤ºä¾‹ï¼š**
```hemlock
// ASCII
let a = 'A';
let digit = '0';

// Multi-byte UTF-8
let rocket = 'ğŸš€';      // U+1F680
let heart = 'â¤';        // U+2764
let chinese = 'ä¸­';     // U+4E2D

// Escape sequences
let newline = '\n';
let tab = '\t';
let backslash = '\\';
let quote = '\'';
let null = '\0';

// Unicode escapes
let emoji = '\u{1F680}';   // Up to 6 hex digits
let max = '\u{10FFFF}';    // Maximum codepoint
```

**ç±»å‹è½¬æ¢ï¼š**
```hemlock
// Integer to rune
let code: rune = 65;        // 'A'
let r: rune = 128640;       // ğŸš€

// Rune to integer
let value: i32 = 'Z';       // 90

// Rune to string
let s: string = 'H';        // "H"

// u8 to rune
let byte: u8 = 65;
let rune_val: rune = byte;  // 'A'
```

**å¦è¯·å‚é˜…ï¼š** [å­—ç¬¦ä¸² API](#reference-string-api) äº†è§£å­—ç¬¦ä¸² + rune è¿æ¥

---

### å­—ç¬¦ä¸²ç±»å‹

**ç±»å‹ï¼š** `string`

**æè¿°ï¼š** UTF-8 ç¼–ç ã€å¯å˜ã€å †åˆ†é…çš„æ–‡æœ¬

**ç¼–ç ï¼š** UTF-8 (U+0000 åˆ° U+10FFFF)

**å¯å˜æ€§ï¼š** å¯å˜ï¼ˆä¸å¤§å¤šæ•°è¯­è¨€ä¸åŒï¼‰

**å±æ€§ï¼š**
- `.length` - ç ç‚¹æ•°ï¼ˆå­—ç¬¦æ•°ï¼‰
- `.byte_length` - å­—èŠ‚æ•°ï¼ˆUTF-8 ç¼–ç å¤§å°ï¼‰

**å­—é¢é‡è¯­æ³•ï¼š** åŒå¼•å· `"text"`

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello";
s[0] = 'H';             // Mutate (now "Hello")
print(s.length);        // 5 (codepoint count)
print(s.byte_length);   // 5 (UTF-8 bytes)

let emoji = "ğŸš€";
print(emoji.length);        // 1 (one codepoint)
print(emoji.byte_length);   // 4 (four UTF-8 bytes)
```

**ç´¢å¼•ï¼š**
```hemlock
let s = "hello";
let ch = s[0];          // Returns rune 'h'
s[0] = 'H';             // Set with rune
```

**å¦è¯·å‚é˜…ï¼š** [å­—ç¬¦ä¸² API](#reference-string-api) äº†è§£å®Œæ•´çš„æ–¹æ³•å‚è€ƒ

---

### ç©ºå€¼ç±»å‹

**ç±»å‹ï¼š** `null`

**æè¿°ï¼š** ç©ºå€¼ï¼ˆè¡¨ç¤ºå€¼çš„ç¼ºå¤±ï¼‰

**å¤§å°ï¼š** 8 å­—èŠ‚ï¼ˆå†…éƒ¨ï¼‰

**å€¼ï¼š** `null`

**ç¤ºä¾‹ï¼š**
```hemlock
let x = null;
let y: i32 = null;  // ERROR: type mismatch

if (x == null) {
    print("x is null");
}
```

---

## å¤åˆç±»å‹

### æ•°ç»„ç±»å‹

**ç±»å‹ï¼š** `array`

**æè¿°ï¼š** åŠ¨æ€ã€å †åˆ†é…ã€æ··åˆç±»å‹æ•°ç»„

**å±æ€§ï¼š**
- `.length` - å…ƒç´ æ•°é‡

**ä»é›¶å¼€å§‹ç´¢å¼•ï¼š** æ˜¯

**å­—é¢é‡è¯­æ³•ï¼š** `[elem1, elem2, ...]`

**ç¤ºä¾‹ï¼š**
```hemlock
let arr = [1, 2, 3, 4, 5];
print(arr[0]);         // 1
print(arr.length);     // 5

// Mixed types
let mixed = [1, "hello", true, null];
```

**å¦è¯·å‚é˜…ï¼š** [æ•°ç»„ API](#reference-array-api) äº†è§£å®Œæ•´çš„æ–¹æ³•å‚è€ƒ

---

### å¯¹è±¡ç±»å‹

**ç±»å‹ï¼š** `object`

**æè¿°ï¼š** JavaScript é£æ ¼çš„åŠ¨æ€å­—æ®µå¯¹è±¡

**å­—é¢é‡è¯­æ³•ï¼š** `{ field: value, ... }`

**ç¤ºä¾‹ï¼š**
```hemlock
let person = { name: "Alice", age: 30 };
print(person.name);  // "Alice"

// Add field dynamically
person.email = "alice@example.com";
```

**ç±»å‹å®šä¹‰ï¼š**
```hemlock
define Person {
    name: string,
    age: i32,
    active?: bool,  // Optional field
}

let p: Person = { name: "Bob", age: 25 };
print(typeof(p));  // "Person"
```

---

### æŒ‡é’ˆç±»å‹

#### åŸå§‹æŒ‡é’ˆ (ptr)

**ç±»å‹ï¼š** `ptr`

**æè¿°ï¼š** åŸå§‹å†…å­˜åœ°å€ï¼ˆä¸å®‰å…¨ï¼‰

**å¤§å°ï¼š** 8 å­—èŠ‚

**è¾¹ç•Œæ£€æŸ¥ï¼š** æ— 

**ç¤ºä¾‹ï¼š**
```hemlock
let p: ptr = alloc(64);
memset(p, 0, 64);
free(p);
```

#### ç¼“å†²åŒº (buffer)

**ç±»å‹ï¼š** `buffer`

**æè¿°ï¼š** å¸¦è¾¹ç•Œæ£€æŸ¥çš„å®‰å…¨æŒ‡é’ˆåŒ…è£…å™¨

**ç»“æ„ï¼š** æŒ‡é’ˆ + é•¿åº¦ + å®¹é‡

**å±æ€§ï¼š**
- `.length` - ç¼“å†²åŒºå¤§å°
- `.capacity` - åˆ†é…çš„å®¹é‡

**ç¤ºä¾‹ï¼š**
```hemlock
let b: buffer = buffer(64);
b[0] = 65;              // Bounds checked
print(b.length);        // 64
free(b);
```

**å¦è¯·å‚é˜…ï¼š** [å†…å­˜ API](#reference-memory-api) äº†è§£åˆ†é…å‡½æ•°

---

## ç‰¹æ®Šç±»å‹

### æ–‡ä»¶ç±»å‹

**ç±»å‹ï¼š** `file`

**æè¿°ï¼š** ç”¨äº I/O æ“ä½œçš„æ–‡ä»¶å¥æŸ„

**å±æ€§ï¼š**
- `.path` - æ–‡ä»¶è·¯å¾„ï¼ˆå­—ç¬¦ä¸²ï¼‰
- `.mode` - æ‰“å¼€æ¨¡å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰
- `.closed` - æ–‡ä»¶æ˜¯å¦å·²å…³é—­ï¼ˆå¸ƒå°”å€¼ï¼‰

**å¦è¯·å‚é˜…ï¼š** [æ–‡ä»¶ API](#reference-file-api)

---

### ä»»åŠ¡ç±»å‹

**ç±»å‹ï¼š** `task`

**æè¿°ï¼š** å¹¶å‘ä»»åŠ¡çš„å¥æŸ„

**å¦è¯·å‚é˜…ï¼š** [å¹¶å‘ API](#reference-concurrency-api)

---

### é€šé“ç±»å‹

**ç±»å‹ï¼š** `channel`

**æè¿°ï¼š** çº¿ç¨‹å®‰å…¨çš„é€šä¿¡é€šé“

**å¦è¯·å‚é˜…ï¼š** [å¹¶å‘ API](#reference-concurrency-api)

---

### å‡½æ•°ç±»å‹

**ç±»å‹ï¼š** `function`

**æè¿°ï¼š** ä¸€ç­‰å‡½æ•°å€¼

**ç¤ºä¾‹ï¼š**
```hemlock
fn add(a, b) {
    return a + b;
}

let multiply = fn(x, y) {
    return x * y;
};

print(typeof(add));      // "function"
print(typeof(multiply)); // "function"
```

---

### Void ç±»å‹

**ç±»å‹ï¼š** `void`

**æè¿°ï¼š** è¡¨ç¤ºæ²¡æœ‰è¿”å›å€¼ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰

---

## ç±»å‹æå‡è§„åˆ™

å½“åœ¨æ“ä½œä¸­æ··åˆç±»å‹æ—¶ï¼ŒHemlock ä¼šæå‡åˆ°"æ›´é«˜"çš„ç±»å‹ï¼š

**æå‡å±‚çº§ï¼š**
```
f64 (highest precision)
 â†‘
f32
 â†‘
u64
 â†‘
i64
 â†‘
u32
 â†‘
i32
 â†‘
u16
 â†‘
i16
 â†‘
u8
 â†‘
i8 (lowest)
```

**è§„åˆ™ï¼š**
1. æµ®ç‚¹æ•°å§‹ç»ˆä¼˜å…ˆäºæ•´æ•°
2. åœ¨ç›¸åŒç±»åˆ«ï¼ˆæ•´æ•°/æ— ç¬¦å·æ•´æ•°/æµ®ç‚¹æ•°ï¼‰ä¸­è¾ƒå¤§çš„å¤§å°ä¼˜å…ˆ
3. ä¸¤ä¸ªæ“ä½œæ•°éƒ½ä¼šæå‡åˆ°ç»“æœç±»å‹
4. **ç²¾åº¦ä¿æŒï¼š** i64/u64 + f32 æå‡åˆ° f64ï¼ˆè€Œä¸æ˜¯ f32ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
// Size promotion
u8 + i32    â†’ i32    // Larger size wins
i32 + i64   â†’ i64    // Larger size wins
u32 + u64   â†’ u64    // Larger size wins

// Float promotion
i32 + f32   â†’ f32    // Float wins, f32 sufficient for i32
i64 + f32   â†’ f64    // Promotes to f64 to preserve i64 precision
i64 + f64   â†’ f64    // Float always wins
i8 + f64    â†’ f64    // Float + largest wins
```

**ä¸ºä»€ä¹ˆ i64 + f32 â†’ f64ï¼Ÿ**

f32 åªæœ‰ 24 ä½å°¾æ•°ï¼Œæ— æ³•ç²¾ç¡®è¡¨ç¤ºå¤§äº 2^24ï¼ˆ16,777,216ï¼‰çš„æ•´æ•°ã€‚ç”±äº i64 å¯ä»¥ä¿å­˜é«˜è¾¾ 2^63 çš„å€¼ï¼Œå°† i64 ä¸ f32 æ··åˆä¼šå¯¼è‡´ä¸¥é‡çš„ç²¾åº¦æŸå¤±ã€‚Hemlock æ”¹ä¸ºæå‡åˆ° f64ï¼ˆ53 ä½å°¾æ•°ï¼‰ã€‚

---

## èŒƒå›´æ£€æŸ¥

ç±»å‹æ³¨è§£åœ¨èµ‹å€¼æ—¶å¼ºåˆ¶è¿›è¡ŒèŒƒå›´æ£€æŸ¥ï¼š

**æœ‰æ•ˆèµ‹å€¼ï¼š**
```hemlock
let x: u8 = 255;             // OK
let y: i8 = 127;             // OK
let a: i64 = 2147483647;     // OK
let b: u64 = 4294967295;     // OK
```

**æ— æ•ˆèµ‹å€¼ï¼ˆè¿è¡Œæ—¶é”™è¯¯ï¼‰ï¼š**
```hemlock
let x: u8 = 256;             // ERROR: out of range
let y: i8 = 128;             // ERROR: max is 127
let z: u64 = -1;             // ERROR: u64 cannot be negative
```

---

## ç±»å‹å†…çœ

### typeof(value)

ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›ç±»å‹åç§°ã€‚

**ç­¾åï¼š**
```hemlock
typeof(value: any): string
```

**è¿”å›å€¼ï¼š**
- åŸå§‹ç±»å‹ï¼š`"i8"`ã€`"i16"`ã€`"i32"`ã€`"i64"`ã€`"u8"`ã€`"u16"`ã€`"u32"`ã€`"u64"`ã€`"f32"`ã€`"f64"`ã€`"bool"`ã€`"string"`ã€`"rune"`ã€`"null"`
- å¤åˆç±»å‹ï¼š`"array"`ã€`"object"`ã€`"ptr"`ã€`"buffer"`ã€`"function"`
- ç‰¹æ®Šç±»å‹ï¼š`"file"`ã€`"task"`ã€`"channel"`
- ç±»å‹åŒ–å¯¹è±¡ï¼šè‡ªå®šä¹‰ç±»å‹åç§°ï¼ˆä¾‹å¦‚ `"Person"`ï¼‰

**ç¤ºä¾‹ï¼š**
```hemlock
print(typeof(42));              // "i32"
print(typeof(3.14));            // "f64"
print(typeof("hello"));         // "string"
print(typeof('A'));             // "rune"
print(typeof(true));            // "bool"
print(typeof([1, 2, 3]));       // "array"
print(typeof({ x: 10 }));       // "object"

define Person { name: string }
let p: Person = { name: "Alice" };
print(typeof(p));               // "Person"
```

**å¦è¯·å‚é˜…ï¼š** [å†…ç½®å‡½æ•°](builtins.md#typeof)

---

## ç±»å‹è½¬æ¢

### éšå¼è½¬æ¢

Hemlock åœ¨ç®—æœ¯è¿ç®—ä¸­æŒ‰ç…§ç±»å‹æå‡è§„åˆ™æ‰§è¡Œéšå¼ç±»å‹è½¬æ¢ã€‚

**ç¤ºä¾‹ï¼š**
```hemlock
let a: u8 = 10;
let b: i32 = 20;
let result = a + b;     // result is i32 (promoted)
```

### æ˜¾å¼è½¬æ¢

ä½¿ç”¨ç±»å‹æ³¨è§£è¿›è¡Œæ˜¾å¼è½¬æ¢ï¼š

**ç¤ºä¾‹ï¼š**
```hemlock
// Integer to float
let i: i32 = 42;
let f: f64 = i;         // 42.0

// Float to integer (truncates)
let x: f64 = 3.14;
let y: i32 = x;         // 3

// Integer to rune
let code: rune = 65;    // 'A'

// Rune to integer
let value: i32 = 'Z';   // 90

// Rune to string
let s: string = 'H';    // "H"
```

---

## ç±»å‹åˆ«å

### å†…ç½®åˆ«å

Hemlock ä¸ºå¸¸ç”¨ç±»å‹æä¾›å†…ç½®ç±»å‹åˆ«åï¼š

| åˆ«å      | å®é™…ç±»å‹ | ç”¨é€”           |
|-----------|----------|----------------|
| `integer` | `i32`    | é€šç”¨æ•´æ•°       |
| `number`  | `f64`    | é€šç”¨æµ®ç‚¹æ•°     |
| `byte`    | `u8`     | å­—èŠ‚å€¼         |

**ç¤ºä¾‹ï¼š**
```hemlock
let count: integer = 100;       // Same as i32
let price: number = 19.99;      // Same as f64
let b: byte = 255;              // Same as u8
```

### è‡ªå®šä¹‰ç±»å‹åˆ«å

ä½¿ç”¨ `type` å…³é”®å­—å®šä¹‰è‡ªå®šä¹‰ç±»å‹åˆ«åï¼š

```hemlock
// Simple aliases
type Integer = i32;
type Text = string;

// Function type aliases
type Callback = fn(i32): void;
type Predicate = fn(any): bool;
type BinaryOp = fn(i32, i32): i32;

// Compound type aliases
define HasName { name: string }
define HasAge { age: i32 }
type Person = HasName & HasAge;

// Generic type aliases
type Pair<T> = { first: T, second: T };
type Result<T, E> = { value: T?, error: E? };
```

**ä½¿ç”¨è‡ªå®šä¹‰åˆ«åï¼š**
```hemlock
let cb: Callback = fn(n) { print(n); };
let p: Person = { name: "Alice", age: 30 };
let coords: Pair<f64> = { first: 3.14, second: 2.71 };
```

**æ³¨æ„ï¼š** ç±»å‹åˆ«åæ˜¯é€æ˜çš„ - `typeof()` è¿”å›åº•å±‚ç±»å‹åç§°ã€‚

---

## å‡½æ•°ç±»å‹

å‡½æ•°ç±»å‹æŒ‡å®šå‡½æ•°å€¼çš„ç­¾åï¼š

### è¯­æ³•

```hemlock
fn(param_types): return_type
```

### ç¤ºä¾‹

```hemlock
// Basic function type
let add: fn(i32, i32): i32 = fn(a, b) { return a + b; };

// Function parameter
fn apply(f: fn(i32): i32, x: i32): i32 {
    return f(x);
}

// Higher-order function returning function
fn make_adder(n: i32): fn(i32): i32 {
    return fn(x) { return x + n; };
}

// Async function type
fn run_async(handler: async fn(): void) {
    spawn(handler);
}
```

---

## å¤åˆç±»å‹ï¼ˆäº¤å‰ç±»å‹ï¼‰

å¤åˆç±»å‹ä½¿ç”¨ `&` æ¥è¦æ±‚å¤šä¸ªç±»å‹çº¦æŸï¼š

```hemlock
define HasName { name: string }
define HasAge { age: i32 }
define HasEmail { email: string }

// Object must satisfy all types
let person: HasName & HasAge = { name: "Alice", age: 30 };

// Three or more types
fn describe(p: HasName & HasAge & HasEmail) {
    print(p.name + " <" + p.email + ">");
}
```

---

## æ±‡æ€»è¡¨

| ç±»å‹       | å¤§å°     | å¯å˜ | å †åˆ†é… | æè¿°                   |
|------------|----------|------|--------|------------------------|
| `i8`-`i64` | 1-8 å­—èŠ‚ | å¦   | å¦     | æœ‰ç¬¦å·æ•´æ•°             |
| `u8`-`u64` | 1-8 å­—èŠ‚ | å¦   | å¦     | æ— ç¬¦å·æ•´æ•°             |
| `f32`      | 4 å­—èŠ‚   | å¦   | å¦     | å•ç²¾åº¦æµ®ç‚¹æ•°           |
| `f64`      | 8 å­—èŠ‚   | å¦   | å¦     | åŒç²¾åº¦æµ®ç‚¹æ•°           |
| `bool`     | 1 å­—èŠ‚   | å¦   | å¦     | å¸ƒå°”å€¼                 |
| `rune`     | 4 å­—èŠ‚   | å¦   | å¦     | Unicode ç ç‚¹           |
| `string`   | å¯å˜     | æ˜¯   | æ˜¯     | UTF-8 æ–‡æœ¬             |
| `array`    | å¯å˜     | æ˜¯   | æ˜¯     | åŠ¨æ€æ•°ç»„               |
| `object`   | å¯å˜     | æ˜¯   | æ˜¯     | åŠ¨æ€å¯¹è±¡               |
| `ptr`      | 8 å­—èŠ‚   | å¦   | å¦     | åŸå§‹æŒ‡é’ˆ               |
| `buffer`   | å¯å˜     | æ˜¯   | æ˜¯     | å®‰å…¨æŒ‡é’ˆåŒ…è£…å™¨         |
| `file`     | ä¸é€æ˜   | æ˜¯   | æ˜¯     | æ–‡ä»¶å¥æŸ„               |
| `task`     | ä¸é€æ˜   | å¦   | æ˜¯     | å¹¶å‘ä»»åŠ¡å¥æŸ„           |
| `channel`  | ä¸é€æ˜   | æ˜¯   | æ˜¯     | çº¿ç¨‹å®‰å…¨é€šé“           |
| `function` | ä¸é€æ˜   | å¦   | æ˜¯     | å‡½æ•°å€¼                 |
| `null`     | 8 å­—èŠ‚   | å¦   | å¦     | ç©ºå€¼                   |

---

## å¦è¯·å‚é˜…

- [è¿ç®—ç¬¦å‚è€ƒ](#reference-operators) - è¿ç®—ä¸­çš„ç±»å‹è¡Œä¸º
- [å†…ç½®å‡½æ•°](#reference-builtins) - ç±»å‹å†…çœå’Œè½¬æ¢
- [å­—ç¬¦ä¸² API](#reference-string-api) - å­—ç¬¦ä¸²ç±»å‹æ–¹æ³•
- [æ•°ç»„ API](#reference-array-api) - æ•°ç»„ç±»å‹æ–¹æ³•
- [å†…å­˜ API](#reference-memory-api) - æŒ‡é’ˆå’Œç¼“å†²åŒºæ“ä½œ


--------------------------------------------------------------------------------
## è¿ç®—ç¬¦
--------------------------------------------------------------------------------

# è¿ç®—ç¬¦å‚è€ƒ

Hemlock ä¸­æ‰€æœ‰è¿ç®—ç¬¦çš„å®Œæ•´å‚è€ƒï¼ŒåŒ…æ‹¬ä¼˜å…ˆçº§ã€ç»“åˆæ€§å’Œè¡Œä¸ºã€‚

---

## æ¦‚è¿°

Hemlock æä¾› C é£æ ¼çš„è¿ç®—ç¬¦ï¼Œå…·æœ‰æ˜ç¡®çš„ä¼˜å…ˆçº§è§„åˆ™ã€‚æ‰€æœ‰è¿ç®—ç¬¦éµå¾ªä¸¥æ ¼çš„ç±»å‹è§„åˆ™ï¼Œåœ¨é€‚ç”¨æ—¶è‡ªåŠ¨è¿›è¡Œç±»å‹æå‡ã€‚

---

## ç®—æœ¯è¿ç®—ç¬¦

### äºŒå…ƒç®—æœ¯

| è¿ç®—ç¬¦ | åç§°   | ç¤ºä¾‹       | æè¿°           |
|--------|--------|------------|----------------|
| `+`    | åŠ æ³•   | `a + b`    | å°†ä¸¤ä¸ªå€¼ç›¸åŠ    |
| `-`    | å‡æ³•   | `a - b`    | ä» a ä¸­å‡å» b  |
| `*`    | ä¹˜æ³•   | `a * b`    | å°†ä¸¤ä¸ªå€¼ç›¸ä¹˜   |
| `/`    | é™¤æ³•   | `a / b`    | å°† a é™¤ä»¥ b    |

**ç±»å‹æå‡ï¼š**
ç»“æœéµå¾ªç±»å‹æå‡è§„åˆ™ï¼ˆå‚è§ [ç±»å‹ç³»ç»Ÿ](type-system.md#type-promotion-rules)ï¼‰ã€‚

**ç¤ºä¾‹ï¼š**
```hemlock
let a = 10 + 5;        // 15 (i32)
let b = 10 - 3;        // 7 (i32)
let c = 4 * 5;         // 20 (i32)
let d = 20 / 4;        // 5 (i32)

// Float division
let e = 10.0 / 3.0;    // 3.333... (f64)

// Mixed types
let f: u8 = 10;
let g: i32 = 20;
let h = f + g;         // 30 (i32, promoted)
```

**é™¤ä»¥é›¶ï¼š**
- æ•´æ•°é™¤ä»¥é›¶ï¼šè¿è¡Œæ—¶é”™è¯¯
- æµ®ç‚¹æ•°é™¤ä»¥é›¶ï¼šè¿”å› `inf` æˆ– `-inf`

---

### ä¸€å…ƒç®—æœ¯

| è¿ç®—ç¬¦ | åç§° | ç¤ºä¾‹    | æè¿°         |
|--------|------|---------|--------------|
| `-`    | å–è´Ÿ | `-a`    | å¯¹å€¼å–è´Ÿ     |
| `+`    | æ­£å· | `+a`    | æ’ç­‰ï¼ˆæ— æ“ä½œï¼‰|

**ç¤ºä¾‹ï¼š**
```hemlock
let a = 5;
let b = -a;            // -5
let c = +a;            // 5 (no change)

let x = -3.14;         // -3.14
```

---

## æ¯”è¾ƒè¿ç®—ç¬¦

| è¿ç®—ç¬¦ | åç§°       | ç¤ºä¾‹       | è¿”å›å€¼   |
|--------|------------|------------|----------|
| `==`   | ç­‰äº       | `a == b`   | `bool`   |
| `!=`   | ä¸ç­‰äº     | `a != b`   | `bool`   |
| `<`    | å°äº       | `a < b`    | `bool`   |
| `>`    | å¤§äº       | `a > b`    | `bool`   |
| `<=`   | å°äºæˆ–ç­‰äº | `a <= b`   | `bool`   |
| `>=`   | å¤§äºæˆ–ç­‰äº | `a >= b`   | `bool`   |

**ç±»å‹æå‡ï¼š**
æ“ä½œæ•°åœ¨æ¯”è¾ƒå‰ä¼šè¿›è¡Œæå‡ã€‚

**ç¤ºä¾‹ï¼š**
```hemlock
print(5 == 5);         // true
print(10 != 5);        // true
print(3 < 7);          // true
print(10 > 5);         // true
print(5 <= 5);         // true
print(10 >= 5);        // true

// String comparison
print("hello" == "hello");  // true
print("abc" < "def");       // true (lexicographic)

// Mixed types
let a: u8 = 10;
let b: i32 = 10;
print(a == b);         // true (promoted to i32)
```

---

## é€»è¾‘è¿ç®—ç¬¦

| è¿ç®—ç¬¦ | åç§°     | ç¤ºä¾‹         | æè¿°                 |
|--------|----------|--------------|----------------------|
| `&&`   | é€»è¾‘ä¸   | `a && b`     | ä¸¤è€…éƒ½ä¸ºçœŸæ—¶è¿”å›çœŸ   |
| `||`   | é€»è¾‘æˆ–   | `a || b`     | ä»»ä¸€ä¸ºçœŸæ—¶è¿”å›çœŸ     |
| `!`    | é€»è¾‘é   | `!a`         | å¯¹å¸ƒå°”å€¼å–å         |

**çŸ­è·¯æ±‚å€¼ï¼š**
- `&&` - é‡åˆ°ç¬¬ä¸€ä¸ªå‡å€¼æ—¶åœæ­¢
- `||` - é‡åˆ°ç¬¬ä¸€ä¸ªçœŸå€¼æ—¶åœæ­¢

**ç¤ºä¾‹ï¼š**
```hemlock
let a = true;
let b = false;

print(a && b);         // false
print(a || b);         // true
print(!a);             // false
print(!b);             // true

// Short-circuit
if (x != 0 && (10 / x) > 2) {
    print("safe");
}

if (x == 0 || (10 / x) > 2) {
    print("safe");
}
```

---

## ä½è¿ç®—ç¬¦

**é™åˆ¶ï¼š** ä»…é€‚ç”¨äºæ•´æ•°ç±»å‹ (i8-i64, u8-u64)

### äºŒå…ƒä½è¿ç®—

| è¿ç®—ç¬¦ | åç§°     | ç¤ºä¾‹       | æè¿°               |
|--------|----------|------------|--------------------|
| `&`    | æŒ‰ä½ä¸   | `a & b`    | å¯¹æ¯ä¸€ä½è¿›è¡Œä¸è¿ç®— |
| `|`    | æŒ‰ä½æˆ–   | `a | b`    | å¯¹æ¯ä¸€ä½è¿›è¡Œæˆ–è¿ç®— |
| `^`    | æŒ‰ä½å¼‚æˆ– | `a ^ b`    | å¯¹æ¯ä¸€ä½è¿›è¡Œå¼‚æˆ–è¿ç®— |
| `<<`   | å·¦ç§»     | `a << b`   | å‘å·¦ç§»åŠ¨ b ä½      |
| `>>`   | å³ç§»     | `a >> b`   | å‘å³ç§»åŠ¨ b ä½      |

**ç±»å‹ä¿æŒï¼š**
ç»“æœç±»å‹ä¸æ“ä½œæ•°ç±»å‹åŒ¹é…ï¼ˆç»è¿‡ç±»å‹æå‡ï¼‰ã€‚

**ç¤ºä¾‹ï¼š**
```hemlock
let a = 12;  // 1100 in binary
let b = 10;  // 1010 in binary

print(a & b);          // 8  (1000)
print(a | b);          // 14 (1110)
print(a ^ b);          // 6  (0110)
print(a << 2);         // 48 (110000)
print(a >> 1);         // 6  (110)
```

**æ— ç¬¦å·ç¤ºä¾‹ï¼š**
```hemlock
let c: u8 = 15;        // 00001111
let d: u8 = 7;         // 00000111

print(c & d);          // 7  (00000111)
print(c | d);          // 15 (00001111)
print(c ^ d);          // 8  (00001000)
```

**å³ç§»è¡Œä¸ºï¼š**
- æœ‰ç¬¦å·ç±»å‹ï¼šç®—æœ¯ç§»ä½ï¼ˆç¬¦å·æ‰©å±•ï¼‰
- æ— ç¬¦å·ç±»å‹ï¼šé€»è¾‘ç§»ä½ï¼ˆé›¶å¡«å……ï¼‰

---

### ä¸€å…ƒä½è¿ç®—

| è¿ç®—ç¬¦ | åç§°     | ç¤ºä¾‹    | æè¿°           |
|--------|----------|---------|----------------|
| `~`    | æŒ‰ä½å–å | `~a`    | ç¿»è½¬æ‰€æœ‰ä½     |

**ç¤ºä¾‹ï¼š**
```hemlock
let a = 12;            // 00001100 (i32)
print(~a);             // -13 (two's complement)

let b: u8 = 15;        // 00001111
print(~b);             // 240 (11110000)
```

---

## å­—ç¬¦ä¸²è¿ç®—ç¬¦

### è¿æ¥

| è¿ç®—ç¬¦ | åç§°   | ç¤ºä¾‹       | æè¿°       |
|--------|--------|------------|------------|
| `+`    | è¿æ¥   | `a + b`    | è¿æ¥å­—ç¬¦ä¸² |

**ç¤ºä¾‹ï¼š**
```hemlock
let s = "hello" + " " + "world";  // "hello world"
let msg = "Count: " + typeof(42); // "Count: 42"

// String + rune
let greeting = "Hello" + '!';      // "Hello!"

// Rune + string
let prefix = '>' + " Message";     // "> Message"
```

---

## èµ‹å€¼è¿ç®—ç¬¦

### åŸºæœ¬èµ‹å€¼

| è¿ç®—ç¬¦ | åç§°   | ç¤ºä¾‹       | æè¿°           |
|--------|--------|------------|----------------|
| `=`    | èµ‹å€¼   | `a = b`    | å°†å€¼èµ‹ç»™å˜é‡   |

**ç¤ºä¾‹ï¼š**
```hemlock
let x = 10;
x = 20;

let arr = [1, 2, 3];
arr[0] = 99;

let obj = { x: 10 };
obj.x = 20;
```

### å¤åˆèµ‹å€¼

#### ç®—æœ¯å¤åˆèµ‹å€¼

| è¿ç®—ç¬¦ | åç§°       | ç¤ºä¾‹       | ç­‰ä»·äº             |
|--------|------------|------------|--------------------|
| `+=`   | åŠ æ³•èµ‹å€¼   | `a += b`   | `a = a + b`        |
| `-=`   | å‡æ³•èµ‹å€¼   | `a -= b`   | `a = a - b`        |
| `*=`   | ä¹˜æ³•èµ‹å€¼   | `a *= b`   | `a = a * b`        |
| `/=`   | é™¤æ³•èµ‹å€¼   | `a /= b`   | `a = a / b`        |
| `%=`   | å–æ¨¡èµ‹å€¼   | `a %= b`   | `a = a % b`        |

**ç¤ºä¾‹ï¼š**
```hemlock
let x = 10;
x += 5;      // x is now 15
x -= 3;      // x is now 12
x *= 2;      // x is now 24
x /= 4;      // x is now 6

let count = 0;
count += 1;  // Increment by 1
```

#### ä½è¿ç®—å¤åˆèµ‹å€¼

| è¿ç®—ç¬¦ | åç§°           | ç¤ºä¾‹        | ç­‰ä»·äº              |
|--------|----------------|-------------|---------------------|
| `&=`   | æŒ‰ä½ä¸èµ‹å€¼     | `a &= b`    | `a = a & b`         |
| `\|=`  | æŒ‰ä½æˆ–èµ‹å€¼     | `a \|= b`   | `a = a \| b`        |
| `^=`   | æŒ‰ä½å¼‚æˆ–èµ‹å€¼   | `a ^= b`    | `a = a ^ b`         |
| `<<=`  | å·¦ç§»èµ‹å€¼       | `a <<= b`   | `a = a << b`        |
| `>>=`  | å³ç§»èµ‹å€¼       | `a >>= b`   | `a = a >> b`        |

**ç¤ºä¾‹ï¼š**
```hemlock
let flags = 0b1111;
flags &= 0b0011;   // flags is now 0b0011 (mask off upper bits)
flags |= 0b1000;   // flags is now 0b1011 (set a bit)
flags ^= 0b0001;   // flags is now 0b1010 (toggle a bit)

let x = 1;
x <<= 4;           // x is now 16 (shift left by 4)
x >>= 2;           // x is now 4 (shift right by 2)
```

### è‡ªå¢/è‡ªå‡

| è¿ç®—ç¬¦ | åç§°   | ç¤ºä¾‹    | æè¿°                 |
|--------|--------|---------|----------------------|
| `++`   | è‡ªå¢   | `a++`   | åŠ  1ï¼ˆåç¼€ï¼‰         |
| `--`   | è‡ªå‡   | `a--`   | å‡ 1ï¼ˆåç¼€ï¼‰         |

**ç¤ºä¾‹ï¼š**
```hemlock
let i = 0;
i++;         // i is now 1
i++;         // i is now 2
i--;         // i is now 1

// Common in loops
for (let j = 0; j < 10; j++) {
    print(j);
}
```

**æ³¨æ„ï¼š** `++` å’Œ `--` éƒ½æ˜¯åç¼€è¿ç®—ç¬¦ï¼ˆåœ¨è‡ªå¢/è‡ªå‡ä¹‹å‰è¿”å›å€¼ï¼‰

---

## ç©ºå€¼å®‰å…¨è¿ç®—ç¬¦

### ç©ºå€¼åˆå¹¶ (`??`)

å¦‚æœå·¦æ“ä½œæ•°ä¸ä¸ºç©ºåˆ™è¿”å›å·¦æ“ä½œæ•°ï¼Œå¦åˆ™è¿”å›å³æ“ä½œæ•°ã€‚

| è¿ç®—ç¬¦ | åç§°       | ç¤ºä¾‹         | æè¿°                       |
|--------|------------|--------------|----------------------------|
| `??`   | ç©ºå€¼åˆå¹¶   | `a ?? b`     | å¦‚æœ a éç©ºè¿”å› aï¼Œå¦åˆ™è¿”å› b |

**ç¤ºä¾‹ï¼š**
```hemlock
let name = null;
let display = name ?? "Anonymous";  // "Anonymous"

let value = 42;
let result = value ?? 0;            // 42

// Chaining
let a = null;
let b = null;
let c = "found";
let result2 = a ?? b ?? c;          // "found"

// With function calls
fn get_config() { return null; }
let config = get_config() ?? { default: true };
```

---

### å¯é€‰é“¾ (`?.`)

å®‰å…¨åœ°è®¿é—®å¯èƒ½ä¸ºç©ºçš„å€¼çš„å±æ€§æˆ–è°ƒç”¨æ–¹æ³•ã€‚

| è¿ç®—ç¬¦ | åç§°       | ç¤ºä¾‹           | æè¿°                             |
|--------|------------|----------------|----------------------------------|
| `?.`   | å¯é€‰é“¾     | `a?.b`         | å¦‚æœ a éç©ºè¿”å› a.bï¼Œå¦åˆ™è¿”å› null |
| `?.[`  | å¯é€‰ç´¢å¼•   | `a?.[0]`       | å¦‚æœ a éç©ºè¿”å› a[0]ï¼Œå¦åˆ™è¿”å› null |
| `?.(`  | å¯é€‰è°ƒç”¨   | `a?.()`        | å¦‚æœ a éç©ºè°ƒç”¨ a()ï¼Œå¦åˆ™è¿”å› null |

**ç¤ºä¾‹ï¼š**
```hemlock
let user = null;
let name = user?.name;              // null (no error)

let person = { name: "Alice", address: null };
let city = person?.address?.city;   // null (safe navigation)

// With arrays
let arr = null;
let first = arr?.[0];               // null

let items = [1, 2, 3];
let second = items?.[1];            // 2

// With method calls
let obj = { greet: fn() { return "Hello"; } };
let greeting = obj?.greet?.();      // "Hello"

let empty = null;
let result = empty?.method?.();     // null
```

**è¡Œä¸ºï¼š**
- å¦‚æœå·¦æ“ä½œæ•°ä¸ºç©ºï¼Œæ•´ä¸ªè¡¨è¾¾å¼çŸ­è·¯è¿”å› null
- å¦‚æœå·¦æ“ä½œæ•°éç©ºï¼Œæ­£å¸¸è¿›è¡Œè®¿é—®
- å¯ä»¥é“¾æ¥ç”¨äºæ·±å±‚å±æ€§è®¿é—®

---

## æˆå‘˜è®¿é—®è¿ç®—ç¬¦

### ç‚¹è¿ç®—ç¬¦

| è¿ç®—ç¬¦ | åç§°       | ç¤ºä¾‹         | æè¿°           |
|--------|------------|--------------|----------------|
| `.`    | æˆå‘˜è®¿é—®   | `obj.field`  | è®¿é—®å¯¹è±¡å­—æ®µ   |
| `.`    | å±æ€§è®¿é—®   | `arr.length` | è®¿é—®å±æ€§       |

**ç¤ºä¾‹ï¼š**
```hemlock
// Object field access
let person = { name: "Alice", age: 30 };
print(person.name);        // "Alice"

// Array property
let arr = [1, 2, 3];
print(arr.length);         // 3

// String property
let s = "hello";
print(s.length);           // 5

// Method call
let result = s.to_upper(); // "HELLO"
```

---

### ç´¢å¼•è¿ç®—ç¬¦

| è¿ç®—ç¬¦ | åç§°   | ç¤ºä¾‹      | æè¿°       |
|--------|--------|-----------|------------|
| `[]`   | ç´¢å¼•   | `arr[i]`  | è®¿é—®å…ƒç´    |

**ç¤ºä¾‹ï¼š**
```hemlock
// Array indexing
let arr = [10, 20, 30];
print(arr[0]);             // 10
arr[1] = 99;

// String indexing (returns rune)
let s = "hello";
print(s[0]);               // 'h'
s[0] = 'H';                // "Hello"

// Buffer indexing
let buf = buffer(10);
buf[0] = 65;
print(buf[0]);             // 65
```

---

## å‡½æ•°è°ƒç”¨è¿ç®—ç¬¦

| è¿ç®—ç¬¦ | åç§°       | ç¤ºä¾‹         | æè¿°       |
|--------|------------|--------------|------------|
| `()`   | å‡½æ•°è°ƒç”¨   | `f(a, b)`    | è°ƒç”¨å‡½æ•°   |

**ç¤ºä¾‹ï¼š**
```hemlock
fn add(a, b) {
    return a + b;
}

let result = add(5, 3);    // 8

// Method call
let s = "hello";
let upper = s.to_upper();  // "HELLO"

// Builtin call
print("message");
```

---

## è¿ç®—ç¬¦ä¼˜å…ˆçº§

è¿ç®—ç¬¦æŒ‰ä»é«˜åˆ°ä½çš„ä¼˜å…ˆçº§æ’åˆ—ï¼š

| ä¼˜å…ˆçº§ | è¿ç®—ç¬¦                       | æè¿°                           | ç»“åˆæ€§     |
|--------|------------------------------|--------------------------------|------------|
| 1      | `()` `[]` `.` `?.`           | è°ƒç”¨ã€ç´¢å¼•ã€æˆå‘˜è®¿é—®ã€å¯é€‰é“¾   | ä»å·¦åˆ°å³   |
| 2      | `++` `--`                    | åç¼€è‡ªå¢/è‡ªå‡                  | ä»å·¦åˆ°å³   |
| 3      | `!` `~` `-` (ä¸€å…ƒ) `+` (ä¸€å…ƒ)| é€»è¾‘éã€æŒ‰ä½å–åã€å–è´Ÿ         | ä»å³åˆ°å·¦   |
| 4      | `*` `/` `%`                  | ä¹˜æ³•ã€é™¤æ³•ã€å–æ¨¡               | ä»å·¦åˆ°å³   |
| 5      | `+` `-`                      | åŠ æ³•ã€å‡æ³•                     | ä»å·¦åˆ°å³   |
| 6      | `<<` `>>`                    | ä½ç§»                           | ä»å·¦åˆ°å³   |
| 7      | `<` `<=` `>` `>=`            | å…³ç³»è¿ç®—                       | ä»å·¦åˆ°å³   |
| 8      | `==` `!=`                    | ç›¸ç­‰è¿ç®—                       | ä»å·¦åˆ°å³   |
| 9      | `&`                          | æŒ‰ä½ä¸                         | ä»å·¦åˆ°å³   |
| 10     | `^`                          | æŒ‰ä½å¼‚æˆ–                       | ä»å·¦åˆ°å³   |
| 11     | `|`                          | æŒ‰ä½æˆ–                         | ä»å·¦åˆ°å³   |
| 12     | `&&`                         | é€»è¾‘ä¸                         | ä»å·¦åˆ°å³   |
| 13     | `||`                         | é€»è¾‘æˆ–                         | ä»å·¦åˆ°å³   |
| 14     | `??`                         | ç©ºå€¼åˆå¹¶                       | ä»å·¦åˆ°å³   |
| 15     | `=` `+=` `-=` `*=` `/=` `%=` `&=` `\|=` `^=` `<<=` `>>=` | èµ‹å€¼ | ä»å³åˆ°å·¦   |

---

## ä¼˜å…ˆçº§ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šç®—æœ¯å’Œæ¯”è¾ƒ
```hemlock
let result = 5 + 3 * 2;
// Evaluated as: 5 + (3 * 2) = 11
// Multiplication has higher precedence than addition

let cmp = 10 > 5 + 3;
// Evaluated as: 10 > (5 + 3) = true
// Addition has higher precedence than comparison
```

### ç¤ºä¾‹ 2ï¼šä½è¿ç®—ç¬¦
```hemlock
let result1 = 12 | 10 & 8;
// Evaluated as: 12 | (10 & 8) = 12 | 8 = 12
// & has higher precedence than |

let result2 = 8 | 1 << 2;
// Evaluated as: 8 | (1 << 2) = 8 | 4 = 12
// Shift has higher precedence than bitwise OR

// Use parentheses for clarity
let result3 = (5 & 3) | (2 << 1);
// Evaluated as: 1 | 4 = 5
```

### ç¤ºä¾‹ 3ï¼šé€»è¾‘è¿ç®—ç¬¦
```hemlock
let result = true || false && false;
// Evaluated as: true || (false && false) = true
// && has higher precedence than ||

let cmp = 5 < 10 && 10 < 20;
// Evaluated as: (5 < 10) && (10 < 20) = true
// Comparison has higher precedence than &&
```

### ç¤ºä¾‹ 4ï¼šä½¿ç”¨æ‹¬å·
```hemlock
// Without parentheses
let a = 2 + 3 * 4;        // 14

// With parentheses
let b = (2 + 3) * 4;      // 20

// Complex expression
let c = (a + b) * (a - b);
```

---

## ç±»å‹ç‰¹å®šçš„è¿ç®—ç¬¦è¡Œä¸º

### é™¤æ³•ï¼ˆå§‹ç»ˆè¿”å›æµ®ç‚¹æ•°ï¼‰

`/` è¿ç®—ç¬¦**å§‹ç»ˆè¿”å›æµ®ç‚¹æ•°** (f64)ï¼Œæ— è®ºæ“ä½œæ•°ç±»å‹ï¼š

```hemlock
print(10 / 3);             // 3.333... (f64)
print(5 / 2);              // 2.5 (f64)
print(10.0 / 4.0);         // 2.5 (f64)
print(-7 / 3);             // -2.333... (f64)
```

è¿™å¯ä»¥é˜²æ­¢å¸¸è§çš„æ„å¤–æ•´æ•°æˆªæ–­é”™è¯¯ã€‚

### åœ°æ¿é™¤æ³• (div / divi)

å¯¹äºåœ°æ¿é™¤æ³•ï¼ˆç±»ä¼¼å…¶ä»–è¯­è¨€ä¸­çš„æ•´æ•°é™¤æ³•ï¼‰ï¼Œä½¿ç”¨ `div()` å’Œ `divi()` å‡½æ•°ï¼š

```hemlock
// div(a, b) - floor division returning float
print(div(5, 2));          // 2 (f64)
print(div(-7, 3));         // -3 (f64)  -- floors toward -infinity

// divi(a, b) - floor division returning integer
print(divi(5, 2));         // 2 (i64)
print(divi(-7, 3));        // -3 (i64)
print(typeof(divi(5, 2))); // i64
```

**è¿”å›æ•´æ•°çš„æ•°å­¦å‡½æ•°ï¼š**
å¯¹äºå…¶ä»–è¿”å›æ•´æ•°çš„èˆå…¥æ“ä½œï¼š

```hemlock
print(floori(3.7));        // 3 (i64)
print(ceili(3.2));         // 4 (i64)
print(roundi(3.5));        // 4 (i64)
print(trunci(3.9));        // 3 (i64)

// These can be used directly as array indices
let arr = [10, 20, 30, 40];
print(arr[floori(1.9)]);   // 20 (index 1)
```

### å­—ç¬¦ä¸²æ¯”è¾ƒ

å­—ç¬¦ä¸²æŒ‰å­—å…¸åºæ¯”è¾ƒï¼š

```hemlock
print("abc" < "def");      // true
print("apple" > "banana"); // false
print("hello" == "hello"); // true
```

### ç©ºå€¼æ¯”è¾ƒ

```hemlock
let x = null;

print(x == null);          // true
print(x != null);          // false
```

### ç±»å‹é”™è¯¯

æŸäº›æ“ä½œä¸å…è®¸åœ¨ä¸å…¼å®¹çš„ç±»å‹ä¹‹é—´è¿›è¡Œï¼š

```hemlock
// ERROR: Cannot use bitwise operators on floats
let x = 3.14 & 2.71;

// ERROR: Cannot use bitwise operators on strings
let y = "hello" & "world";

// OK: Type promotion for arithmetic
let a: u8 = 10;
let b: i32 = 20;
let c = a + b;             // i32 (promoted)
```

---

## å¦è¯·å‚é˜…

- [ç±»å‹ç³»ç»Ÿ](#reference-type-system) - ç±»å‹æå‡å’Œè½¬æ¢è§„åˆ™
- [å†…ç½®å‡½æ•°](#reference-builtins) - å†…ç½®æ“ä½œ
- [å­—ç¬¦ä¸² API](#reference-string-api) - å­—ç¬¦ä¸²è¿æ¥å’Œæ–¹æ³•



################################################################################
# è®¾è®¡ä¸ç†å¿µ
################################################################################

--------------------------------------------------------------------------------
## å®ç°ç»†èŠ‚
--------------------------------------------------------------------------------

# Hemlock å®ç°ç»†èŠ‚

æœ¬æ–‡æ¡£æè¿°äº† Hemlock è¯­è¨€çš„æŠ€æœ¯å®ç°ï¼ŒåŒ…æ‹¬é¡¹ç›®ç»“æ„ã€ç¼–è¯‘æµæ°´çº¿ã€è¿è¡Œæ—¶æ¶æ„å’Œè®¾è®¡å†³ç­–ã€‚

---

## ç›®å½•

- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [ç¼–è¯‘æµæ°´çº¿](#ç¼–è¯‘æµæ°´çº¿)
- [æ¨¡å—åŒ–è§£é‡Šå™¨è®¾è®¡](#æ¨¡å—åŒ–è§£é‡Šå™¨è®¾è®¡)
- [è¿è¡Œæ—¶æ¶æ„](#è¿è¡Œæ—¶æ¶æ„)
- [å€¼è¡¨ç¤º](#å€¼è¡¨ç¤º)
- [ç±»å‹ç³»ç»Ÿå®ç°](#ç±»å‹ç³»ç»Ÿå®ç°)
- [å†…å­˜ç®¡ç†](#å†…å­˜ç®¡ç†)
- [å¹¶å‘æ¨¡å‹](#å¹¶å‘æ¨¡å‹)
- [æœªæ¥è®¡åˆ’](#æœªæ¥è®¡åˆ’)

---

## é¡¹ç›®ç»“æ„

```
hemlock/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ frontend/              # å…±äº«ï¼šè¯æ³•åˆ†æå™¨ã€è§£æå™¨ã€AST
â”‚   â”‚   â”œâ”€â”€ lexer.c            # è¯æ³•åˆ†æ
â”‚   â”‚   â”œâ”€â”€ parser/            # é€’å½’ä¸‹é™è§£æå™¨
â”‚   â”‚   â”œâ”€â”€ ast.c              # AST èŠ‚ç‚¹ç®¡ç†
â”‚   â”‚   â””â”€â”€ module.c           # æ¨¡å—è§£æ
â”‚   â”œâ”€â”€ backends/
â”‚   â”‚   â”œâ”€â”€ interpreter/       # hemlockï¼šæ ‘éå†è§£é‡Šå™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ main.c         # CLI å…¥å£ç‚¹
â”‚   â”‚   â”‚   â”œâ”€â”€ runtime.c      # è¡¨è¾¾å¼/è¯­å¥æ±‚å€¼
â”‚   â”‚   â”‚   â”œâ”€â”€ builtins.c     # å†…ç½®å‡½æ•°
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ compiler/          # hemlockcï¼šC ä»£ç ç”Ÿæˆå™¨
â”‚   â”‚       â”œâ”€â”€ main.c         # CLIã€ç¼–æ’
â”‚   â”‚       â”œâ”€â”€ type_check.c   # ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
â”‚   â”‚       â”œâ”€â”€ codegen.c      # ä»£ç ç”Ÿæˆä¸Šä¸‹æ–‡
â”‚   â”‚       â”œâ”€â”€ codegen_expr.c # è¡¨è¾¾å¼ä»£ç ç”Ÿæˆ
â”‚   â”‚       â”œâ”€â”€ codegen_stmt.c # è¯­å¥ä»£ç ç”Ÿæˆ
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”œâ”€â”€ lsp/               # è¯­è¨€æœåŠ¡å™¨åè®®
â”‚   â”‚   â””â”€â”€ bundler/           # æ‰“åŒ…/åŒ…å·¥å…·
â”œâ”€â”€ runtime/                   # libhemlock_runtime.aï¼ˆç”¨äºç¼–è¯‘åçš„ç¨‹åºï¼‰
â”œâ”€â”€ stdlib/                    # æ ‡å‡†åº“ï¼ˆ39 ä¸ªæ¨¡å—ï¼‰
â”‚   â””â”€â”€ docs/                  # æ¨¡å—æ–‡æ¡£
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ parity/                # å¿…é¡»åœ¨ä¸¤ä¸ªåç«¯éƒ½é€šè¿‡çš„æµ‹è¯•
â”‚   â”œâ”€â”€ interpreter/           # è§£é‡Šå™¨ç‰¹å®šæµ‹è¯•
â”‚   â””â”€â”€ compiler/              # ç¼–è¯‘å™¨ç‰¹å®šæµ‹è¯•
â”œâ”€â”€ examples/                  # ç¤ºä¾‹ç¨‹åº
â””â”€â”€ docs/                      # æ–‡æ¡£
```

### ç›®å½•ç»„ç»‡

**`include/`** - å®šä¹‰ç»„ä»¶é—´æ¥å£çš„å…¬å…± API å¤´æ–‡ä»¶ï¼š
- è¯æ³•åˆ†æå™¨ã€è§£æå™¨ã€AST å’Œè§£é‡Šå™¨ä¹‹é—´çš„æ¸…æ™°åˆ†ç¦»
- å‰å‘å£°æ˜ä»¥æœ€å°åŒ–ä¾èµ–
- ç”¨äºåœ¨å…¶ä»–ç¨‹åºä¸­åµŒå…¥ Hemlock çš„å…¬å…± API

**`src/`** - å®ç°æ–‡ä»¶ï¼š
- é¡¶å±‚æ–‡ä»¶å¤„ç†è¯æ³•åˆ†æã€è§£æã€AST ç®¡ç†
- `main.c` æä¾› CLI å’Œ REPL
- è§£é‡Šå™¨æ¨¡å—åŒ–ä¸ºç‹¬ç«‹çš„å­ç³»ç»Ÿ

**`src/interpreter/`** - æ¨¡å—åŒ–è§£é‡Šå™¨å®ç°ï¼š
- æ¯ä¸ªæ¨¡å—æœ‰å•ä¸€ã€æ¸…æ™°çš„èŒè´£
- å†…éƒ¨ API åœ¨ `internal.h` ä¸­å®šä¹‰ç”¨äºæ¨¡å—é—´é€šä¿¡
- æ¨¡å—å¯ä»¥ç‹¬ç«‹ç¼–è¯‘ä»¥åŠ å¿«æ„å»ºé€Ÿåº¦

**`tests/`** - å…¨é¢çš„æµ‹è¯•å¥—ä»¶ï¼š
- æŒ‰åŠŸèƒ½åŒºåŸŸç»„ç»‡
- æ¯ä¸ªç›®å½•åŒ…å«ä¸“æ³¨çš„æµ‹è¯•ç”¨ä¾‹
- `run_tests.sh` ç¼–æ’æµ‹è¯•æ‰§è¡Œ

---

## ç¼–è¯‘æµæ°´çº¿

Hemlock ä½¿ç”¨ä¼ ç»Ÿçš„ç¼–è¯‘æµæ°´çº¿ï¼Œå…·æœ‰ä¸åŒçš„é˜¶æ®µï¼š

### é˜¶æ®µ 1ï¼šè¯æ³•åˆ†æï¼ˆLexerï¼‰

**è¾“å…¥ï¼š**æºä»£ç æ–‡æœ¬
**è¾“å‡ºï¼š**Token æµ
**å®ç°ï¼š**`src/lexer.c`

```
æºç : "let x = 42;"
   â†“
Tokens: [LET, IDENTIFIER("x"), EQUALS, INTEGER(42), SEMICOLON]
```

**ä¸»è¦ç‰¹æ€§ï¼š**
- è¯†åˆ«å…³é”®å­—ã€æ ‡è¯†ç¬¦ã€å­—é¢é‡ã€è¿ç®—ç¬¦ã€æ ‡ç‚¹ç¬¦å·
- å¤„ç† UTF-8 å­—ç¬¦ä¸²å­—é¢é‡å’Œ rune å­—é¢é‡
- æŠ¥å‘Šè¡Œå·ç”¨äºé”™è¯¯æ¶ˆæ¯
- å•éï¼Œæ— å›æº¯

### é˜¶æ®µ 2ï¼šè¯­æ³•åˆ†æï¼ˆParserï¼‰

**è¾“å…¥ï¼š**Token æµ
**è¾“å‡ºï¼š**æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰
**å®ç°ï¼š**`src/parser.c`

```
Tokens: [LET, IDENTIFIER("x"), EQUALS, INTEGER(42), SEMICOLON]
   â†“
AST: LetStmt {
    name: "x",
    type: null,
    value: IntLiteral(42)
}
```

**ä¸»è¦ç‰¹æ€§ï¼š**
- é€’å½’ä¸‹é™è§£æå™¨
- æ„å»ºç¨‹åºç»“æ„çš„æ ‘è¡¨ç¤º
- å¤„ç†è¿ç®—ç¬¦ä¼˜å…ˆçº§
- éªŒè¯è¯­æ³•ï¼ˆå¤§æ‹¬å·ã€åˆ†å·ç­‰ï¼‰
- è¿˜æ²¡æœ‰è¯­ä¹‰åˆ†æï¼ˆåœ¨è¿è¡Œæ—¶å®Œæˆï¼‰

**è¿ç®—ç¬¦ä¼˜å…ˆçº§ï¼ˆä»ä½åˆ°é«˜ï¼‰ï¼š**
1. èµ‹å€¼ï¼š`=`
2. é€»è¾‘æˆ–ï¼š`||`
3. é€»è¾‘ä¸ï¼š`&&`
4. æŒ‰ä½æˆ–ï¼š`|`
5. æŒ‰ä½å¼‚æˆ–ï¼š`^`
6. æŒ‰ä½ä¸ï¼š`&`
7. ç›¸ç­‰ï¼š`==`ã€`!=`
8. æ¯”è¾ƒï¼š`<`ã€`>`ã€`<=`ã€`>=`
9. ä½ç§»ï¼š`<<`ã€`>>`
10. åŠ æ³•/å‡æ³•ï¼š`+`ã€`-`
11. ä¹˜æ³•/é™¤æ³•/å–æ¨¡ï¼š`*`ã€`/`ã€`%`
12. ä¸€å…ƒï¼š`!`ã€`-`ã€`~`
13. è°ƒç”¨/ç´¢å¼•/æˆå‘˜ï¼š`()`ã€`[]`ã€`.`

### é˜¶æ®µ 3aï¼šè§£é‡Šæ‰§è¡Œï¼ˆæ ‘éå†ï¼‰

**è¾“å…¥ï¼š**AST
**è¾“å‡ºï¼š**ç¨‹åºæ‰§è¡Œ
**å®ç°ï¼š**`src/backends/interpreter/runtime.c`

```
AST: LetStmt { ... }
   â†“
æ‰§è¡Œ: é€’å½’æ±‚å€¼ AST èŠ‚ç‚¹
   â†“
ç»“æœ: åˆ›å»ºå€¼ä¸º 42 çš„å˜é‡ x
```

**ä¸»è¦ç‰¹æ€§ï¼š**
- ç›´æ¥ AST éå†ï¼ˆæ ‘éå†è§£é‡Šå™¨ï¼‰
- è¿è¡Œæ—¶åŠ¨æ€ç±»å‹æ£€æŸ¥
- åŸºäºç¯å¢ƒçš„å˜é‡å­˜å‚¨

### é˜¶æ®µ 3bï¼šç¼–è¯‘ï¼ˆhemlockcï¼‰

**è¾“å…¥ï¼š**AST
**è¾“å‡ºï¼š**é€šè¿‡ C ä»£ç ç”Ÿæˆçš„åŸç”Ÿå¯æ‰§è¡Œæ–‡ä»¶
**å®ç°ï¼š**`src/backends/compiler/`

```
AST: LetStmt { ... }
   â†“
ç±»å‹æ£€æŸ¥: ç¼–è¯‘æ—¶éªŒè¯ç±»å‹
   â†“
C ä»£ç ç”Ÿæˆ: ç”Ÿæˆç­‰æ•ˆçš„ C ä»£ç 
   â†“
GCC: å°† C ç¼–è¯‘ä¸ºåŸç”ŸäºŒè¿›åˆ¶æ–‡ä»¶
   â†“
ç»“æœ: ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶
```

**ä¸»è¦ç‰¹æ€§ï¼š**
- ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
- C ä»£ç ç”Ÿæˆä»¥å®ç°å¯ç§»æ¤æ€§
- é“¾æ¥ `libhemlock_runtime.a`
- æ¯”è§£é‡Šå™¨æ‰§è¡Œé€Ÿåº¦æ˜¾è‘—æ›´å¿«

---

## ç¼–è¯‘å™¨åç«¯ï¼ˆhemlockcï¼‰

Hemlock ç¼–è¯‘å™¨ä» AST ç”Ÿæˆ C ä»£ç ï¼Œç„¶åä½¿ç”¨ GCC ç¼–è¯‘ä¸ºåŸç”Ÿå¯æ‰§è¡Œæ–‡ä»¶ã€‚

### ç¼–è¯‘å™¨æ¶æ„

```
src/backends/compiler/
â”œâ”€â”€ main.c              # CLIã€å‚æ•°è§£æã€ç¼–æ’
â”œâ”€â”€ codegen.c           # æ ¸å¿ƒä»£ç ç”Ÿæˆä¸Šä¸‹æ–‡
â”œâ”€â”€ codegen_expr.c      # è¡¨è¾¾å¼ä»£ç ç”Ÿæˆ
â”œâ”€â”€ codegen_stmt.c      # è¯­å¥ä»£ç ç”Ÿæˆ
â”œâ”€â”€ codegen_call.c      # å‡½æ•°è°ƒç”¨ç”Ÿæˆ
â”œâ”€â”€ codegen_closure.c   # é—­åŒ…å®ç°
â”œâ”€â”€ codegen_program.c   # é¡¶å±‚ç¨‹åºç”Ÿæˆ
â”œâ”€â”€ codegen_module.c    # æ¨¡å—/å¯¼å…¥å¤„ç†
â”œâ”€â”€ type_check.c        # ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
â””â”€â”€ type_check.h        # ç±»å‹æ£€æŸ¥å™¨ API
```

### ç±»å‹æ£€æŸ¥

ç¼–è¯‘å™¨åŒ…å«ç»Ÿä¸€çš„ç±»å‹æ£€æŸ¥ç³»ç»Ÿï¼Œå¯ä»¥ï¼š

1. **ç¼–è¯‘æ—¶éªŒè¯ç±»å‹** - åœ¨æ‰§è¡Œå‰æ•è·ç±»å‹é”™è¯¯
2. **æ”¯æŒåŠ¨æ€ä»£ç ** - æ— ç±»å‹ä»£ç è§†ä¸º `any`ï¼ˆå§‹ç»ˆæœ‰æ•ˆï¼‰
3. **æä¾›ä¼˜åŒ–æç¤º** - è¯†åˆ«å¯ä»¥æ‹†ç®±çš„å˜é‡

**ç±»å‹æ£€æŸ¥æ ‡å¿—ï¼š**

| æ ‡å¿— | æè¿° |
|------|-------------|
| ï¼ˆé»˜è®¤ï¼‰ | å¯ç”¨ç±»å‹æ£€æŸ¥ |
| `--check` | ä»…ç±»å‹æ£€æŸ¥ï¼Œä¸ç¼–è¯‘ |
| `--no-type-check` | ç¦ç”¨ç±»å‹æ£€æŸ¥ |
| `--strict-types` | å¯¹éšå¼ `any` ç±»å‹å‘å‡ºè­¦å‘Š |

**ç±»å‹æ£€æŸ¥å™¨å®ç°ï¼š**

```c
// type_check.h - å…³é”®ç»“æ„
typedef struct TypeCheckContext {
    const char *filename;
    int error_count;
    int warning_count;
    UnboxableVar *unboxable_vars;  // ä¼˜åŒ–æç¤º
    // ... ç±»å‹ç¯å¢ƒã€å®šä¹‰ç­‰
} TypeCheckContext;

// ä¸»å…¥å£ç‚¹
int type_check_program(TypeCheckContext *ctx, Stmt **stmts, int count);
```

### ä»£ç ç”Ÿæˆ

ä»£ç ç”Ÿæˆé˜¶æ®µå°† AST èŠ‚ç‚¹è½¬æ¢ä¸º C ä»£ç ï¼š

**è¡¨è¾¾å¼æ˜ å°„ï¼š**
```
Hemlock                 â†’  ç”Ÿæˆçš„ C
----------------------------------------
let x = 42;            â†’  HmlValue x = hml_val_i32(42);
x + y                  â†’  hml_add(x, y)
arr[i]                 â†’  hml_array_get(arr, i)
obj.field              â†’  hml_object_get_field(obj, "field")
fn(a, b) { ... }       â†’  å¸¦ç¯å¢ƒæ•è·çš„é—­åŒ…
```

**è¿è¡Œæ—¶é›†æˆï¼š**

ç”Ÿæˆçš„ C ä»£ç é“¾æ¥ `libhemlock_runtime.a`ï¼Œå®ƒæä¾›ï¼š
- `HmlValue` æ ‡è®°è”åˆç±»å‹
- å†…å­˜ç®¡ç†ï¼ˆå¼•ç”¨è®¡æ•°ï¼‰
- å†…ç½®å‡½æ•°ï¼ˆprintã€typeof ç­‰ï¼‰
- å¹¶å‘åŸè¯­ï¼ˆä»»åŠ¡ã€é€šé“ï¼‰
- FFI æ”¯æŒ

### æ‹†ç®±ä¼˜åŒ–

ç±»å‹æ£€æŸ¥å™¨è¯†åˆ«å¯ä»¥ä½¿ç”¨åŸç”Ÿ C ç±»å‹è€Œä¸æ˜¯è£…ç®± `HmlValue` çš„å˜é‡ï¼š

**å¯æ‹†ç®±æ¨¡å¼ï¼š**
- å·²çŸ¥æ•´æ•°ç±»å‹çš„å¾ªç¯è®¡æ•°å™¨
- å¾ªç¯ä¸­çš„ç´¯åŠ å™¨å˜é‡
- å¸¦æ˜¾å¼ç±»å‹æ³¨è§£çš„å˜é‡ï¼ˆi32ã€i64ã€f64ã€boolï¼‰

```hemlock
// å¾ªç¯è®¡æ•°å™¨ 'i' å¯ä»¥æ‹†ç®±ä¸ºåŸç”Ÿ int32_t
for (let i: i32 = 0; i < 1000000; i = i + 1) {
    sum = sum + i;
}
```

---

## æ¨¡å—åŒ–è§£é‡Šå™¨è®¾è®¡

è§£é‡Šå™¨è¢«åˆ†å‰²æˆä¸“æ³¨çš„æ¨¡å—ä»¥æé«˜å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

### æ¨¡å—èŒè´£

#### 1. ç¯å¢ƒï¼ˆ`environment.c`ï¼‰- 121 è¡Œ

**ç›®çš„ï¼š**å˜é‡ä½œç”¨åŸŸå’Œåç§°è§£æ

**å…³é”®å‡½æ•°ï¼š**
- `env_create()` - åˆ›å»ºå¸¦å¯é€‰çˆ¶çº§çš„æ–°ç¯å¢ƒ
- `env_define()` - åœ¨å½“å‰ä½œç”¨åŸŸå®šä¹‰æ–°å˜é‡
- `env_get()` - åœ¨å½“å‰æˆ–çˆ¶ä½œç”¨åŸŸæŸ¥æ‰¾å˜é‡
- `env_set()` - æ›´æ–°ç°æœ‰å˜é‡å€¼
- `env_free()` - é‡Šæ”¾ç¯å¢ƒåŠæ‰€æœ‰å˜é‡

**è®¾è®¡ï¼š**
- é“¾å¼ä½œç”¨åŸŸï¼ˆæ¯ä¸ªç¯å¢ƒæœ‰æŒ‡å‘çˆ¶çº§çš„æŒ‡é’ˆï¼‰
- HashMap ç”¨äºå¿«é€Ÿå˜é‡æŸ¥æ‰¾
- æ”¯æŒé—­åŒ…çš„è¯æ³•ä½œç”¨åŸŸ

#### 2. å€¼ï¼ˆ`values.c`ï¼‰- 394 è¡Œ

**ç›®çš„ï¼š**å€¼æ„é€ å‡½æ•°å’Œæ•°æ®ç»“æ„ç®¡ç†

**å…³é”®å‡½æ•°ï¼š**
- `value_create_*()` - æ¯ç§å€¼ç±»å‹çš„æ„é€ å‡½æ•°
- `value_copy()` - æ·±æ‹·è´/æµ…æ‹·è´é€»è¾‘
- `value_free()` - æ¸…ç†å’Œå†…å­˜é‡Šæ”¾
- `value_to_string()` - ç”¨äºæ‰“å°çš„å­—ç¬¦ä¸²è¡¨ç¤º

**æ•°æ®ç»“æ„ï¼š**
- å¯¹è±¡ï¼ˆåŠ¨æ€å­—æ®µæ•°ç»„ï¼‰
- æ•°ç»„ï¼ˆåŠ¨æ€è°ƒæ•´å¤§å°ï¼‰
- ç¼“å†²åŒºï¼ˆptr + length + capacityï¼‰
- é—­åŒ…ï¼ˆå‡½æ•° + æ•è·çš„ç¯å¢ƒï¼‰
- ä»»åŠ¡å’Œé€šé“ï¼ˆå¹¶å‘åŸè¯­ï¼‰

#### 3. ç±»å‹ï¼ˆ`types.c`ï¼‰- 440 è¡Œ

**ç›®çš„ï¼š**ç±»å‹ç³»ç»Ÿã€è½¬æ¢å’Œé¸­å­ç±»å‹

**å…³é”®å‡½æ•°ï¼š**
- `type_check()` - è¿è¡Œæ—¶ç±»å‹éªŒè¯
- `type_convert()` - éšå¼ç±»å‹è½¬æ¢/æå‡
- `duck_type_check()` - å¯¹è±¡çš„ç»“æ„ç±»å‹æ£€æŸ¥
- `type_name()` - è·å–å¯æ‰“å°çš„ç±»å‹åç§°

**ç‰¹æ€§ï¼š**
- ç±»å‹æå‡å±‚æ¬¡ï¼ˆi8 â†’ i16 â†’ i32 â†’ i64 â†’ f32 â†’ f64ï¼Œi64/u64 + f32 â†’ f64ï¼‰
- æ•°å€¼ç±»å‹çš„èŒƒå›´æ£€æŸ¥
- å¯¹è±¡ç±»å‹å®šä¹‰çš„é¸­å­ç±»å‹
- å¯é€‰å­—æ®µé»˜è®¤å€¼

#### 4. å†…ç½®å‡½æ•°ï¼ˆ`builtins.c`ï¼‰- 955 è¡Œ

**ç›®çš„ï¼š**å†…ç½®å‡½æ•°å’Œå…¨å±€æ³¨å†Œ

**å…³é”®å‡½æ•°ï¼š**
- `register_builtins()` - æ³¨å†Œæ‰€æœ‰å†…ç½®å‡½æ•°å’Œå¸¸é‡
- å†…ç½®å‡½æ•°å®ç°ï¼ˆprintã€typeofã€allocã€free ç­‰ï¼‰
- ä¿¡å·å¤„ç†å‡½æ•°
- å‘½ä»¤æ‰§è¡Œï¼ˆexecï¼‰

**å†…ç½®å‡½æ•°ç±»åˆ«ï¼š**
- I/Oï¼šprintã€openã€read_fileã€write_file
- å†…å­˜ï¼šallocã€freeã€memsetã€memcpyã€realloc
- ç±»å‹ï¼štypeofã€assert
- å¹¶å‘ï¼šspawnã€joinã€detachã€channel
- ç³»ç»Ÿï¼šexecã€signalã€raiseã€panic
- FFIï¼šdlopenã€dlsymã€dlcallã€dlclose

#### 5. I/Oï¼ˆ`io.c`ï¼‰- 449 è¡Œ

**ç›®çš„ï¼š**æ–‡ä»¶ I/O å’Œ JSON åºåˆ—åŒ–

**å…³é”®å‡½æ•°ï¼š**
- æ–‡ä»¶å¯¹è±¡æ–¹æ³•ï¼ˆreadã€writeã€seekã€tellã€closeï¼‰
- JSON åºåˆ—åŒ–/ååºåˆ—åŒ–
- å¾ªç¯å¼•ç”¨æ£€æµ‹

**ç‰¹æ€§ï¼š**
- å¸¦å±æ€§çš„æ–‡ä»¶å¯¹è±¡ï¼ˆpathã€modeã€closedï¼‰
- UTF-8 æ„ŸçŸ¥çš„æ–‡æœ¬ I/O
- äºŒè¿›åˆ¶ I/O æ”¯æŒ
- å¯¹è±¡å’Œæ•°ç»„çš„ JSON å¾€è¿”

#### 6. FFIï¼ˆ`ffi.c`ï¼‰- å¤–éƒ¨å‡½æ•°æ¥å£

**ç›®çš„ï¼š**ä»å…±äº«åº“è°ƒç”¨ C å‡½æ•°

**å…³é”®å‡½æ•°ï¼š**
- `dlopen()` - åŠ è½½å…±äº«åº“
- `dlsym()` - æŒ‰åç§°è·å–å‡½æ•°æŒ‡é’ˆ
- `dlcall()` - è°ƒç”¨å¸¦ç±»å‹è½¬æ¢çš„ C å‡½æ•°
- `dlclose()` - å¸è½½åº“

**ç‰¹æ€§ï¼š**
- ä¸ libffi é›†æˆç”¨äºåŠ¨æ€å‡½æ•°è°ƒç”¨
- è‡ªåŠ¨ç±»å‹è½¬æ¢ï¼ˆHemlock â†” C ç±»å‹ï¼‰
- æ”¯æŒæ‰€æœ‰åŸå§‹ç±»å‹
- æŒ‡é’ˆå’Œç¼“å†²åŒºæ”¯æŒ

#### 7. è¿è¡Œæ—¶ï¼ˆ`runtime.c`ï¼‰- 865 è¡Œ

**ç›®çš„ï¼š**è¡¨è¾¾å¼æ±‚å€¼å’Œè¯­å¥æ‰§è¡Œ

**å…³é”®å‡½æ•°ï¼š**
- `eval_expr()` - æ±‚å€¼è¡¨è¾¾å¼ï¼ˆé€’å½’ï¼‰
- `eval_stmt()` - æ‰§è¡Œè¯­å¥
- æ§åˆ¶æµå¤„ç†ï¼ˆifã€whileã€forã€switch ç­‰ï¼‰
- å¼‚å¸¸å¤„ç†ï¼ˆtry/catch/finally/throwï¼‰

**ç‰¹æ€§ï¼š**
- é€’å½’è¡¨è¾¾å¼æ±‚å€¼
- çŸ­è·¯å¸ƒå°”æ±‚å€¼
- æ–¹æ³•è°ƒç”¨æ£€æµ‹å’Œ `self` ç»‘å®š
- å¼‚å¸¸ä¼ æ’­
- break/continue/return å¤„ç†

### æ¨¡å—åŒ–è®¾è®¡çš„å¥½å¤„

**1. å…³æ³¨ç‚¹åˆ†ç¦»**
- æ¯ä¸ªæ¨¡å—æœ‰ä¸€ä¸ªæ¸…æ™°çš„èŒè´£
- å®¹æ˜“æ‰¾åˆ°ç‰¹æ€§çš„å®ç°ä½ç½®
- å‡å°‘æ›´æ”¹æ—¶çš„è®¤çŸ¥è´Ÿæ‹…

**2. æ›´å¿«çš„å¢é‡æ„å»º**
- åªæœ‰ä¿®æ”¹çš„æ¨¡å—éœ€è¦é‡æ–°ç¼–è¯‘
- å¯èƒ½è¿›è¡Œå¹¶è¡Œç¼–è¯‘
- å¼€å‘æœŸé—´æ›´çŸ­çš„è¿­ä»£æ—¶é—´

**3. æ›´å®¹æ˜“çš„æµ‹è¯•å’Œè°ƒè¯•**
- æ¨¡å—å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- é”™è¯¯å®šä½åˆ°ç‰¹å®šå­ç³»ç»Ÿ
- å¯èƒ½ä½¿ç”¨æ¨¡æ‹Ÿå®ç°è¿›è¡Œæµ‹è¯•

**4. å¯æ‰©å±•æ€§**
- æ–°ç‰¹æ€§å¯ä»¥æ·»åŠ åˆ°é€‚å½“çš„æ¨¡å—
- æ¨¡å—å¯ä»¥ç‹¬ç«‹é‡æ„
- æ¯ä¸ªæ–‡ä»¶çš„ä»£ç é‡ä¿æŒå¯ç®¡ç†

**5. ä»£ç ç»„ç»‡**
- ç›¸å…³åŠŸèƒ½çš„é€»è¾‘åˆ†ç»„
- æ¸…æ™°çš„ä¾èµ–å›¾
- æ–°è´¡çŒ®è€…æ›´å®¹æ˜“ä¸Šæ‰‹

---

## è¿è¡Œæ—¶æ¶æ„

### å€¼è¡¨ç¤º

Hemlock ä¸­çš„æ‰€æœ‰å€¼éƒ½ç”±ä½¿ç”¨æ ‡è®°è”åˆçš„ `Value` ç»“æ„è¡¨ç¤ºï¼š

```c
typedef struct Value {
    ValueType type;  // è¿è¡Œæ—¶ç±»å‹æ ‡ç­¾
    union {
        int32_t i32_value;
        int64_t i64_value;
        uint8_t u8_value;
        uint32_t u32_value;
        uint64_t u64_value;
        float f32_value;
        double f64_value;
        bool bool_value;
        char *string_value;
        uint32_t rune_value;
        void *ptr_value;
        Buffer *buffer_value;
        Array *array_value;
        Object *object_value;
        Function *function_value;
        File *file_value;
        Task *task_value;
        Channel *channel_value;
    };
} Value;
```

**è®¾è®¡å†³ç­–ï¼š**
- **æ ‡è®°è”åˆ**ç”¨äºç±»å‹å®‰å…¨åŒæ—¶ä¿æŒçµæ´»æ€§
- **è¿è¡Œæ—¶ç±»å‹æ ‡ç­¾**å¯ç”¨å¸¦ç±»å‹æ£€æŸ¥çš„åŠ¨æ€ç±»å‹
- **ç›´æ¥å€¼å­˜å‚¨**ç”¨äºåŸå§‹ç±»å‹ï¼ˆæ— è£…ç®±ï¼‰
- **æŒ‡é’ˆå­˜å‚¨**ç”¨äºå †åˆ†é…ç±»å‹ï¼ˆå­—ç¬¦ä¸²ã€å¯¹è±¡ã€æ•°ç»„ï¼‰

### å†…å­˜å¸ƒå±€ç¤ºä¾‹

**æ•´æ•°ï¼ˆi32ï¼‰ï¼š**
```
Value {
    type: TYPE_I32,
    i32_value: 42
}
```
- æ€»å¤§å°ï¼šçº¦ 16 å­—èŠ‚ï¼ˆ8 å­—èŠ‚æ ‡ç­¾ + 8 å­—èŠ‚è”åˆï¼‰
- æ ˆåˆ†é…
- ä¸éœ€è¦å †åˆ†é…

**å­—ç¬¦ä¸²ï¼š**
```
Value {
    type: TYPE_STRING,
    string_value: 0x7f8a4c000000  // æŒ‡å‘å †çš„æŒ‡é’ˆ
}

å †: "hello\0"ï¼ˆ6 å­—èŠ‚ï¼Œä»¥ null ç»“å°¾çš„ UTF-8ï¼‰
```
- å€¼åœ¨æ ˆä¸Šå  16 å­—èŠ‚
- å­—ç¬¦ä¸²æ•°æ®æ˜¯å †åˆ†é…çš„
- å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾

**å¯¹è±¡ï¼š**
```
Value {
    type: TYPE_OBJECT,
    object_value: 0x7f8a4c001000  // æŒ‡å‘å †çš„æŒ‡é’ˆ
}

å †: Object {
    type_name: "Person",
    fields: [
        { name: "name", value: Value{TYPE_STRING, "Alice"} },
        { name: "age", value: Value{TYPE_I32, 30} }
    ],
    field_count: 2,
    capacity: 4
}
```
- å¯¹è±¡ç»“æ„åœ¨å †ä¸Š
- å­—æ®µå­˜å‚¨åœ¨åŠ¨æ€æ•°ç»„ä¸­
- å­—æ®µå€¼æ˜¯åµŒå…¥çš„ Value ç»“æ„

### ç¯å¢ƒå®ç°

å˜é‡å­˜å‚¨åœ¨ç¯å¢ƒé“¾ä¸­ï¼š

```c
typedef struct Environment {
    HashMap *bindings;           // name â†’ Value
    struct Environment *parent;  // è¯æ³•çˆ¶ä½œç”¨åŸŸ
} Environment;
```

**ä½œç”¨åŸŸé“¾ç¤ºä¾‹ï¼š**
```
å…¨å±€ä½œç”¨åŸŸ: { print: <builtin>, args: <array> }
    â†‘
å‡½æ•°ä½œç”¨åŸŸ: { x: 10, y: 20 }
    â†‘
å—ä½œç”¨åŸŸ: { i: 0 }
```

**æŸ¥æ‰¾ç®—æ³•ï¼š**
1. æ£€æŸ¥å½“å‰ç¯å¢ƒçš„ hashmap
2. å¦‚æœæœªæ‰¾åˆ°ï¼Œæ£€æŸ¥çˆ¶ç¯å¢ƒ
3. é‡å¤ç›´åˆ°æ‰¾åˆ°æˆ–åˆ°è¾¾å…¨å±€ä½œç”¨åŸŸ
4. å¦‚æœåœ¨ä»»ä½•ä½œç”¨åŸŸéƒ½æœªæ‰¾åˆ°åˆ™æŠ¥é”™

---

## ç±»å‹ç³»ç»Ÿå®ç°

### ç±»å‹æ£€æŸ¥ç­–ç•¥

Hemlock ä½¿ç”¨**è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥**å’Œ**å¯é€‰ç±»å‹æ³¨è§£**ï¼š

```hemlock
let x = 42;           // æ— ç±»å‹æ£€æŸ¥ï¼Œæ¨æ–­ä¸º i32
let y: u8 = 255;      // è¿è¡Œæ—¶æ£€æŸ¥ï¼šå€¼å¿…é¡»é€‚åˆ u8
let z: i32 = x + y;   // è¿è¡Œæ—¶æ£€æŸ¥ + ç±»å‹æå‡
```

**å®ç°æµç¨‹ï¼š**
1. **å­—é¢é‡æ¨æ–­** - è¯æ³•åˆ†æå™¨/è§£æå™¨ä»å­—é¢é‡ç¡®å®šåˆå§‹ç±»å‹
2. **ç±»å‹æ³¨è§£æ£€æŸ¥** - å¦‚æœå­˜åœ¨æ³¨è§£ï¼Œåœ¨èµ‹å€¼æ—¶éªŒè¯
3. **æå‡** - äºŒå…ƒæ“ä½œæå‡åˆ°å…¬å…±ç±»å‹
4. **è½¬æ¢** - æ˜¾å¼è½¬æ¢æŒ‰éœ€å‘ç”Ÿ

### ç±»å‹æå‡å®ç°

ç±»å‹æå‡éµå¾ªå›ºå®šå±‚æ¬¡å¹¶ä¿æŒç²¾åº¦ï¼š

```c
// ç®€åŒ–çš„æå‡é€»è¾‘
ValueType promote_types(ValueType a, ValueType b) {
    // f64 å§‹ç»ˆè·èƒœ
    if (a == TYPE_F64 || b == TYPE_F64) return TYPE_F64;

    // f32 ä¸ i64/u64 æå‡åˆ° f64ï¼ˆç²¾åº¦ä¿æŒï¼‰
    if (a == TYPE_F32 || b == TYPE_F32) {
        ValueType other = (a == TYPE_F32) ? b : a;
        if (other == TYPE_I64 || other == TYPE_U64) return TYPE_F64;
        return TYPE_F32;
    }

    // è¾ƒå¤§çš„æ•´æ•°ç±»å‹è·èƒœ
    int rank_a = get_type_rank(a);
    int rank_b = get_type_rank(b);
    return (rank_a > rank_b) ? a : b;
}
```

**ç±»å‹ç­‰çº§ï¼š**
- i8: 0
- u8: 1
- i16: 2
- u16: 3
- i32: 4
- u32: 5
- i64: 6
- u64: 7
- f32: 8
- f64: 9

### é¸­å­ç±»å‹å®ç°

å¯¹è±¡ç±»å‹æ£€æŸ¥ä½¿ç”¨ç»“æ„æ¯”è¾ƒï¼š

```c
bool duck_type_check(Object *obj, TypeDef *type_def) {
    // æ£€æŸ¥æ‰€æœ‰å¿…éœ€å­—æ®µ
    for (each field in type_def) {
        if (!object_has_field(obj, field.name)) {
            return false;  // ç¼ºå°‘å­—æ®µ
        }

        Value *field_value = object_get_field(obj, field.name);
        if (!type_matches(field_value, field.type)) {
            return false;  // ç±»å‹é”™è¯¯
        }
    }

    return true;  // æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨ä¸”ç±»å‹æ­£ç¡®
}
```

**é¸­å­ç±»å‹å…è®¸ï¼š**
- å¯¹è±¡ä¸­çš„é¢å¤–å­—æ®µï¼ˆè¢«å¿½ç•¥ï¼‰
- å­ç»“æ„ç±»å‹ï¼ˆå¯¹è±¡å¯ä»¥æœ‰æ¯”è¦æ±‚æ›´å¤šçš„ï¼‰
- éªŒè¯åçš„ç±»å‹åç§°åˆ†é…

---

## å†…å­˜ç®¡ç†

### åˆ†é…ç­–ç•¥

Hemlock ä½¿ç”¨**æ‰‹åŠ¨å†…å­˜ç®¡ç†**ï¼Œæœ‰ä¸¤ç§åˆ†é…åŸè¯­ï¼š

**1. åŸå§‹æŒ‡é’ˆï¼ˆ`ptr`ï¼‰ï¼š**
```c
void *alloc(size_t bytes) {
    void *ptr = malloc(bytes);
    if (!ptr) {
        fprintf(stderr, "Out of memory\n");
        exit(1);
    }
    return ptr;
}
```
- ç›´æ¥ malloc/free
- æ— è·Ÿè¸ª
- ç”¨æˆ·è´Ÿè´£é‡Šæ”¾

**2. ç¼“å†²åŒºï¼ˆ`buffer`ï¼‰ï¼š**
```c
typedef struct Buffer {
    void *data;
    size_t length;
    size_t capacity;
} Buffer;

Buffer *create_buffer(size_t size) {
    Buffer *buf = malloc(sizeof(Buffer));
    buf->data = malloc(size);
    buf->length = size;
    buf->capacity = size;
    return buf;
}
```
- è·Ÿè¸ªå¤§å°å’Œå®¹é‡
- è®¿é—®æ—¶è¾¹ç•Œæ£€æŸ¥
- ä»ç„¶éœ€è¦æ‰‹åŠ¨ free

### å †åˆ†é…ç±»å‹

**å­—ç¬¦ä¸²ï¼š**
- å †ä¸Šçš„ UTF-8 å­—èŠ‚æ•°ç»„
- ä»¥ null ç»“å°¾ç”¨äº C äº’æ“ä½œ
- å¯å˜ï¼ˆå¯ä»¥åŸåœ°ä¿®æ”¹ï¼‰
- å¼•ç”¨è®¡æ•°ï¼ˆä½œç”¨åŸŸé€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾ï¼‰

**å¯¹è±¡ï¼š**
- åŠ¨æ€å­—æ®µæ•°ç»„
- å­—æ®µåå’Œå€¼åœ¨å †ä¸Š
- å¼•ç”¨è®¡æ•°ï¼ˆä½œç”¨åŸŸé€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾ï¼‰
- å¯èƒ½å­˜åœ¨å¾ªç¯å¼•ç”¨ï¼ˆç”¨ visited-set è·Ÿè¸ªå¤„ç†ï¼‰

**æ•°ç»„ï¼š**
- åŠ¨æ€å®¹é‡å€å¢å¢é•¿
- å…ƒç´ æ˜¯åµŒå…¥çš„ Value ç»“æ„
- å¢é•¿æ—¶è‡ªåŠ¨é‡æ–°åˆ†é…
- å¼•ç”¨è®¡æ•°ï¼ˆä½œç”¨åŸŸé€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾ï¼‰

**é—­åŒ…ï¼š**
- é€šè¿‡å¼•ç”¨æ•è·ç¯å¢ƒ
- ç¯å¢ƒæ˜¯å †åˆ†é…çš„
- é—­åŒ…ç¯å¢ƒåœ¨ä¸å†å¼•ç”¨æ—¶æ­£ç¡®é‡Šæ”¾

---

## å¹¶å‘æ¨¡å‹

### çº¿ç¨‹æ¶æ„

Hemlock ä½¿ç”¨ POSIX çº¿ç¨‹ï¼ˆpthreadsï¼‰çš„ **1:1 çº¿ç¨‹**æ¨¡å‹ï¼š

```
ç”¨æˆ·ä»»åŠ¡          æ“ä½œç³»ç»Ÿçº¿ç¨‹          CPU æ ¸å¿ƒ
---------          ---------          --------
spawn(f1) ------>  pthread_create --> Core 0
spawn(f2) ------>  pthread_create --> Core 1
spawn(f3) ------>  pthread_create --> Core 2
```

**ä¸»è¦ç‰¹å¾ï¼š**
- æ¯ä¸ª `spawn()` åˆ›å»ºä¸€ä¸ªæ–°çš„ pthread
- å†…æ ¸åœ¨æ ¸å¿ƒé—´è°ƒåº¦çº¿ç¨‹
- çœŸæ­£çš„å¹¶è¡Œæ‰§è¡Œï¼ˆæ²¡æœ‰ GILï¼‰
- æŠ¢å å¼å¤šä»»åŠ¡

### ä»»åŠ¡å®ç°

```c
typedef struct Task {
    pthread_t thread;        // æ“ä½œç³»ç»Ÿçº¿ç¨‹å¥æŸ„
    Value result;            // è¿”å›å€¼
    char *error;             // å¼‚å¸¸æ¶ˆæ¯ï¼ˆå¦‚æœæŠ›å‡ºï¼‰
    pthread_mutex_t lock;    // ä¿æŠ¤çŠ¶æ€
    TaskState state;         // RUNNINGã€FINISHEDã€ERROR
} Task;
```

**ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸï¼š**
1. `spawn(func, args)` â†’ åˆ›å»º Taskï¼Œå¯åŠ¨ pthread
2. çº¿ç¨‹ç”¨å‚æ•°è¿è¡Œå‡½æ•°
3. è¿”å›æ—¶ï¼šå­˜å‚¨ç»“æœï¼Œè®¾ç½®çŠ¶æ€ä¸º FINISHED
4. å¼‚å¸¸æ—¶ï¼šå­˜å‚¨é”™è¯¯æ¶ˆæ¯ï¼Œè®¾ç½®çŠ¶æ€ä¸º ERROR
5. `join(task)` â†’ ç­‰å¾…çº¿ç¨‹ï¼Œè¿”å›ç»“æœæˆ–æŠ›å‡ºå¼‚å¸¸

### é€šé“å®ç°

```c
typedef struct Channel {
    void **buffer;           // Value* çš„å¾ªç¯ç¼“å†²åŒº
    size_t capacity;         // æœ€å¤§ç¼“å†²é¡¹ç›®æ•°
    size_t count;            // ç¼“å†²åŒºä¸­çš„å½“å‰é¡¹ç›®æ•°
    size_t read_index;       // ä¸‹ä¸€ä¸ªè¯»å–ä½ç½®
    size_t write_index;      // ä¸‹ä¸€ä¸ªå†™å…¥ä½ç½®
    bool closed;             // é€šé“å…³é—­æ ‡å¿—
    pthread_mutex_t lock;    // ä¿æŠ¤ç¼“å†²åŒº
    pthread_cond_t not_full; // æœ‰ç©ºé—´æ—¶å‘ä¿¡å·
    pthread_cond_t not_empty;// æœ‰æ•°æ®æ—¶å‘ä¿¡å·
} Channel;
```

**å‘é€æ“ä½œï¼š**
1. é”å®š mutex
2. å¦‚æœç¼“å†²åŒºæ»¡åˆ™ç­‰å¾…ï¼ˆcond_wait on not_fullï¼‰
3. å°†å€¼å†™å…¥ buffer[write_index]
4. é€’å¢ write_indexï¼ˆå¾ªç¯ï¼‰
5. ä¿¡å· not_empty
6. è§£é” mutex

**æ¥æ”¶æ“ä½œï¼š**
1. é”å®š mutex
2. å¦‚æœç¼“å†²åŒºç©ºåˆ™ç­‰å¾…ï¼ˆcond_wait on not_emptyï¼‰
3. ä» buffer[read_index] è¯»å–å€¼
4. é€’å¢ read_indexï¼ˆå¾ªç¯ï¼‰
5. ä¿¡å· not_full
6. è§£é” mutex

**åŒæ­¥ä¿è¯ï¼š**
- çº¿ç¨‹å®‰å…¨çš„ send/recvï¼ˆç”± mutex ä¿æŠ¤ï¼‰
- é˜»å¡è¯­ä¹‰ï¼ˆæ»¡æ—¶ç”Ÿäº§è€…ç­‰å¾…ï¼Œç©ºæ—¶æ¶ˆè´¹è€…ç­‰å¾…ï¼‰
- æœ‰åºäº¤ä»˜ï¼ˆé€šé“å†… FIFOï¼‰

---

## æœªæ¥è®¡åˆ’

### å·²å®Œæˆï¼šç¼–è¯‘å™¨åç«¯

ç¼–è¯‘å™¨åç«¯ï¼ˆ`hemlockc`ï¼‰å·²å®ç°ï¼š
- ä» AST ç”Ÿæˆ C ä»£ç 
- ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
- è¿è¡Œæ—¶åº“ï¼ˆ`libhemlock_runtime.a`ï¼‰
- ä¸è§£é‡Šå™¨å®Œå…¨ä¸€è‡´ï¼ˆ98% æµ‹è¯•é€šè¿‡ç‡ï¼‰
- æ‹†ç®±ä¼˜åŒ–æ¡†æ¶

### å½“å‰é‡ç‚¹ï¼šç±»å‹ç³»ç»Ÿå¢å¼º

**æœ€è¿‘æ”¹è¿›ï¼š**
- ç»Ÿä¸€çš„ç±»å‹æ£€æŸ¥å’Œç±»å‹æ¨æ–­ç³»ç»Ÿ
- ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥é»˜è®¤å¯ç”¨
- ç”¨äºä»…ç±»å‹éªŒè¯çš„ `--check` æ ‡å¿—
- ä¼ é€’ç»™ä»£ç ç”Ÿæˆçš„ç±»å‹ä¸Šä¸‹æ–‡ç”¨äºä¼˜åŒ–æç¤º

### æœªæ¥å¢å¼º

**å¯èƒ½çš„æ·»åŠ ï¼š**
- æ³›å‹/æ¨¡æ¿
- æ¨¡å¼åŒ¹é…
- LSP é›†æˆç”¨äºç±»å‹æ„ŸçŸ¥çš„ IDE æ”¯æŒ
- æ›´æ¿€è¿›çš„æ‹†ç®±ä¼˜åŒ–
- ç”¨äºæ ˆåˆ†é…çš„é€ƒé€¸åˆ†æ

### é•¿æœŸä¼˜åŒ–

**å¯èƒ½çš„æ”¹è¿›ï¼š**
- æ–¹æ³•è°ƒç”¨çš„å†…è”ç¼“å­˜
- çƒ­ä»£ç è·¯å¾„çš„ JIT ç¼–è¯‘
- ç”¨äºæ›´å¥½å¹¶å‘çš„å·¥ä½œçªƒå–è°ƒåº¦å™¨
- é…ç½®æ–‡ä»¶å¼•å¯¼çš„ä¼˜åŒ–

---

## å®ç°æŒ‡å—

### æ·»åŠ æ–°ç‰¹æ€§

å®ç°æ–°ç‰¹æ€§æ—¶ï¼Œéµå¾ªä»¥ä¸‹æŒ‡å—ï¼š

**1. é€‰æ‹©æ­£ç¡®çš„æ¨¡å—ï¼š**
- æ–°å€¼ç±»å‹ â†’ `values.c`
- ç±»å‹è½¬æ¢ â†’ `types.c`
- å†…ç½®å‡½æ•° â†’ `builtins.c`
- I/O æ“ä½œ â†’ `io.c`
- æ§åˆ¶æµ â†’ `runtime.c`

**2. æ›´æ–°æ‰€æœ‰å±‚ï¼š**
- å¦‚éœ€è¦æ·»åŠ  AST èŠ‚ç‚¹ç±»å‹ï¼ˆ`ast.h`ã€`ast.c`ï¼‰
- å¦‚éœ€è¦æ·»åŠ è¯æ³•åˆ†æå™¨ tokenï¼ˆ`lexer.c`ï¼‰
- æ·»åŠ è§£æå™¨è§„åˆ™ï¼ˆ`parser.c`ï¼‰
- å®ç°è¿è¡Œæ—¶è¡Œä¸ºï¼ˆ`runtime.c` æˆ–é€‚å½“çš„æ¨¡å—ï¼‰
- æ·»åŠ æµ‹è¯•ï¼ˆ`tests/`ï¼‰

**3. ä¿æŒä¸€è‡´æ€§ï¼š**
- éµå¾ªç°æœ‰ä»£ç é£æ ¼
- ä½¿ç”¨ä¸€è‡´çš„å‘½åçº¦å®š
- åœ¨å¤´æ–‡ä»¶ä¸­è®°å½•å…¬å…± API
- ä¿æŒé”™è¯¯æ¶ˆæ¯æ¸…æ™°ä¸€è‡´

**4. å½»åº•æµ‹è¯•ï¼š**
- å®ç°å‰æ·»åŠ æµ‹è¯•ç”¨ä¾‹
- æµ‹è¯•æˆåŠŸå’Œé”™è¯¯è·¯å¾„
- æµ‹è¯•è¾¹ç•Œæƒ…å†µ
- éªŒè¯æ²¡æœ‰å†…å­˜æ³„æ¼ï¼ˆvalgrindï¼‰

### æ€§èƒ½è€ƒè™‘

**å½“å‰ç“¶é¢ˆï¼š**
- å˜é‡è®¿é—®çš„ HashMap æŸ¥æ‰¾
- é€’å½’å‡½æ•°è°ƒç”¨ï¼ˆæ²¡æœ‰ TCOï¼‰
- å­—ç¬¦ä¸²è¿æ¥ï¼ˆæ¯æ¬¡åˆ†é…æ–°å­—ç¬¦ä¸²ï¼‰
- æ¯æ¬¡æ“ä½œçš„ç±»å‹æ£€æŸ¥å¼€é”€

**ä¼˜åŒ–æœºä¼šï¼š**
- ç¼“å­˜å˜é‡ä½ç½®ï¼ˆå†…è”ç¼“å­˜ï¼‰
- å°¾è°ƒç”¨ä¼˜åŒ–
- ç”¨äºè¿æ¥çš„å­—ç¬¦ä¸²æ„å»ºå™¨
- ç±»å‹æ¨æ–­ä»¥è·³è¿‡è¿è¡Œæ—¶æ£€æŸ¥

### è°ƒè¯•æŠ€å·§

**æœ‰ç”¨çš„å·¥å…·ï¼š**
- `valgrind` - å†…å­˜æ³„æ¼æ£€æµ‹
- `gdb` - è°ƒè¯•å´©æºƒ
- `-g` æ ‡å¿— - è°ƒè¯•ç¬¦å·
- `printf` è°ƒè¯• - ç®€å•ä½†æœ‰æ•ˆ

**å¸¸è§é—®é¢˜ï¼š**
- æ®µé”™è¯¯ â†’ ç©ºæŒ‡é’ˆè§£å¼•ç”¨ï¼ˆæ£€æŸ¥è¿”å›å€¼ï¼‰
- å†…å­˜æ³„æ¼ â†’ ç¼ºå°‘ free() è°ƒç”¨ï¼ˆæ£€æŸ¥ value_free è·¯å¾„ï¼‰
- ç±»å‹é”™è¯¯ â†’ æ£€æŸ¥ type_convert() å’Œ type_check() é€»è¾‘
- çº¿ç¨‹å´©æºƒ â†’ ç«äº‰æ¡ä»¶ï¼ˆæ£€æŸ¥ mutex ä½¿ç”¨ï¼‰

---

## æ€»ç»“

Hemlock çš„å®ç°ä¼˜å…ˆè€ƒè™‘ï¼š
- **æ¨¡å—åŒ–** - æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»
- **ç®€å•æ€§** - ç›´æ¥çš„å®ç°
- **æ˜¾å¼æ€§** - æ²¡æœ‰éšè—çš„é­”æ³•
- **å¯ç»´æŠ¤æ€§** - æ˜“äºç†è§£å’Œä¿®æ”¹

å½“å‰çš„æ ‘éå†è§£é‡Šå™¨æœ‰æ„ä¿æŒç®€å•ï¼Œä»¥ä¿ƒè¿›å¿«é€Ÿç‰¹æ€§å¼€å‘å’Œå®éªŒã€‚æœªæ¥çš„ç¼–è¯‘å™¨åç«¯å°†åœ¨ä¿æŒç›¸åŒè¯­ä¹‰çš„åŒæ—¶æé«˜æ€§èƒ½ã€‚


--------------------------------------------------------------------------------
## ç­¾åè¯­æ³•
--------------------------------------------------------------------------------

# ç­¾åè¯­æ³•è®¾è®¡

> ç”¨å‡½æ•°ç±»å‹ã€å¯ç©ºä¿®é¥°ç¬¦ã€ç±»å‹åˆ«åã€const å‚æ•°å’Œæ–¹æ³•ç­¾åæ‰©å±• Hemlock çš„ç±»å‹ç³»ç»Ÿã€‚

**çŠ¶æ€ï¼š**å·²å®ç°ï¼ˆv1.7.0ï¼‰
**ç‰ˆæœ¬ï¼š**1.0
**ä½œè€…ï¼š**Claude

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£æå‡ºäº†äº”ä¸ªç›¸äº’å…³è”çš„ç±»å‹ç³»ç»Ÿæ‰©å±•ï¼Œå®ƒä»¬å»ºç«‹åœ¨ Hemlock ç°æœ‰åŸºç¡€è®¾æ–½ä¹‹ä¸Šï¼š

1. **å‡½æ•°ç±»å‹æ³¨è§£** - ä¸€ç­‰å‡½æ•°ç±»å‹
2. **å¯ç©ºç±»å‹ä¿®é¥°ç¬¦** - æ˜¾å¼çš„ null å¤„ç†ï¼ˆæ‰©å±•ç°æœ‰çš„ `nullable` æ ‡å¿—ï¼‰
3. **ç±»å‹åˆ«å** - å‘½åçš„ç±»å‹ç¼©å†™
4. **Const å‚æ•°** - ä¸å¯å˜æ€§å¥‘çº¦
5. **Define ä¸­çš„æ–¹æ³•ç­¾å** - ç±»æ¥å£è¡Œä¸º

è¿™äº›ç‰¹æ€§å…±äº«ç›¸åŒçš„ç†å¿µï¼š**æ˜¾å¼ä¼˜äºéšå¼ï¼Œå¯é€‰ä½†ä½¿ç”¨æ—¶å¼ºåˆ¶æ‰§è¡Œ**ã€‚

---

## 1. å‡½æ•°ç±»å‹æ³¨è§£

### åŠ¨æœº

ç›®å‰ï¼Œæ²¡æœ‰åŠæ³•å°†å‡½æ•°çš„ç­¾åè¡¨è¾¾ä¸ºç±»å‹ï¼š

```hemlock
// å½“å‰ï¼šcallback æ²¡æœ‰ç±»å‹ä¿¡æ¯
fn map(arr: array, callback) { ... }

// æè®®ï¼šæ˜¾å¼å‡½æ•°ç±»å‹
fn map(arr: array, callback: fn(any, i32): any): array { ... }
```

### è¯­æ³•

```hemlock
// åŸºæœ¬å‡½æ•°ç±»å‹
fn(i32, i32): i32

// å¸¦å‚æ•°åï¼ˆä»…ç”¨äºæ–‡æ¡£ï¼Œä¸å¼ºåˆ¶æ‰§è¡Œï¼‰
fn(a: i32, b: i32): i32

// æ— è¿”å›å€¼ï¼ˆvoidï¼‰
fn(string): void
fn(string)              // ç®€å†™ï¼šçœç•¥ `: void`

// å¯ç©ºè¿”å›
fn(i32): string?

// å¯é€‰å‚æ•°
fn(name: string, age?: i32): void

// Rest å‚æ•°
fn(...args: array): i32

// æ— å‚æ•°
fn(): bool

// é«˜é˜¶ï¼šè¿”å›å‡½æ•°çš„å‡½æ•°
fn(i32): fn(i32): i32

// å¼‚æ­¥å‡½æ•°ç±»å‹
async fn(i32): i32
```

### ä½¿ç”¨ç¤ºä¾‹

```hemlock
// å¸¦å‡½æ•°ç±»å‹çš„å˜é‡
let add: fn(i32, i32): i32 = fn(a, b) { return a + b; };

// å‡½æ•°å‚æ•°
fn apply(f: fn(i32): i32, x: i32): i32 {
    return f(x);
}

// è¿”å›ç±»å‹æ˜¯å‡½æ•°
fn make_adder(n: i32): fn(i32): i32 {
    return fn(x) { return x + n; };
}

// å‡½æ•°æ•°ç»„
let ops: array<fn(i32, i32): i32> = [add, subtract, multiply];

// å¯¹è±¡å­—æ®µ
define EventHandler {
    name: string;
    callback: fn(Event): void;
}
```

### AST æ›´æ”¹

```c
// åœ¨ TypeKind æšä¸¾ä¸­ï¼ˆinclude/ast.hï¼‰
typedef enum {
    // ... ç°æœ‰ç±»å‹ ...
    TYPE_FUNCTION,      // æ–°å¢ï¼šå‡½æ•°ç±»å‹
} TypeKind;

// åœ¨ Type ç»“æ„ä¸­ï¼ˆinclude/ast.hï¼‰
struct Type {
    TypeKind kind;
    // ... ç°æœ‰å­—æ®µ ...

    // ç”¨äº TYPE_FUNCTIONï¼š
    struct Type **param_types;      // å‚æ•°ç±»å‹
    char **param_names;             // å¯é€‰å‚æ•°åï¼ˆæ–‡æ¡£ï¼‰
    int *param_optional;            // å“ªäº›å‚æ•°æ˜¯å¯é€‰çš„
    int num_params;
    char *rest_param_name;          // Rest å‚æ•°åæˆ– NULL
    struct Type *rest_param_type;   // Rest å‚æ•°ç±»å‹
    struct Type *return_type;       // è¿”å›ç±»å‹ï¼ˆNULL = voidï¼‰
    int is_async;                   // async fn ç±»å‹
};
```

### è§£æ

å‡½æ•°ç±»å‹ä»¥ `fn`ï¼ˆæˆ– `async fn`ï¼‰å¼€å§‹ï¼Œåè·Ÿå‚æ•°åˆ—è¡¨ï¼š

```
function_type := ["async"] "fn" "(" [param_type_list] ")" [":" type]
param_type_list := param_type ("," param_type)*
param_type := [identifier ":"] ["?"] type | "..." [identifier] [":" type]
```

**æ¶ˆæ­§ä¹‰ï¼š**è§£æç±»å‹æ—¶é‡åˆ° `fn`ï¼š
- å¦‚æœåè·Ÿ `(`ï¼Œåˆ™æ˜¯å‡½æ•°ç±»å‹
- å¦åˆ™ï¼Œè¯­æ³•é”™è¯¯ï¼ˆè£¸ `fn` ä¸æ˜¯æœ‰æ•ˆç±»å‹ï¼‰

### ç±»å‹å…¼å®¹æ€§

```hemlock
// å‡½æ•°ç±»å‹éœ€è¦ç²¾ç¡®åŒ¹é…
let f: fn(i32): i32 = fn(x: i32): i32 { return x; };  // æ­£ç¡®

// å‚æ•°é€†å˜ï¼ˆæ¥å—æ›´å®½ç±»å‹æ˜¯å¯ä»¥çš„ï¼‰
let g: fn(any): i32 = fn(x: i32): i32 { return x; };  // æ­£ç¡®ï¼ši32 <: any

// è¿”å›åå˜ï¼ˆè¿”å›æ›´çª„ç±»å‹æ˜¯å¯ä»¥çš„ï¼‰
let h: fn(i32): any = fn(x: i32): i32 { return x; };  // æ­£ç¡®ï¼ši32 <: any

// å‚æ•°æ•°é‡å¿…é¡»åŒ¹é…
let bad: fn(i32): i32 = fn(a, b) { return a; };       // é”™è¯¯ï¼šå‚æ•°æ•°é‡ä¸åŒ¹é…

// å¯é€‰å‚æ•°ä¸å¿…éœ€å‚æ•°å…¼å®¹
let opt: fn(i32, i32?): i32 = fn(a, b?: 0) { return a + b; };  // æ­£ç¡®
```

---

## 2. å¯ç©ºç±»å‹ä¿®é¥°ç¬¦

### åŠ¨æœº

`?` åç¼€ä½¿ç­¾åä¸­çš„ null æ¥å—å˜å¾—æ˜¾å¼ï¼š

```hemlock
// å½“å‰ï¼šä¸æ¸…æ¥š null æ˜¯å¦æœ‰æ•ˆ
fn find(arr: array, val: any): i32 { ... }

// æè®®ï¼šæ˜¾å¼å¯ç©ºè¿”å›
fn find(arr: array, val: any): i32? { ... }
```

### è¯­æ³•

```hemlock
// å¸¦ ? åç¼€çš„å¯ç©ºç±»å‹
string?           // string æˆ– null
i32?              // i32 æˆ– null
User?             // User æˆ– null
array<i32>?       // array æˆ– null
fn(i32): i32?     // è¿”å› i32 æˆ– null çš„å‡½æ•°

// ä¸å‡½æ•°ç±»å‹ç»„åˆ
fn(string?): i32          // æ¥å— string æˆ– null
fn(string): i32?          // è¿”å› i32 æˆ– null
fn(string?): i32?         // ä¸¤è€…éƒ½å¯ç©º

// åœ¨ define ä¸­
define Result {
    value: any?;
    error: string?;
}
```

### å®ç°è¯´æ˜

**å·²å­˜åœ¨ï¼š**`Type.nullable` æ ‡å¿—å·²åœ¨ AST ä¸­ã€‚æ­¤ç‰¹æ€§ä¸»è¦éœ€è¦ï¼š
1. å¯¹ä»»ä½•ç±»å‹çš„ `?` åç¼€çš„è§£æå™¨æ”¯æŒï¼ˆéªŒè¯/æ‰©å±•ï¼‰
2. ä¸å‡½æ•°ç±»å‹çš„æ­£ç¡®ç»„åˆ
3. è¿è¡Œæ—¶å¼ºåˆ¶æ‰§è¡Œ

### ç±»å‹å…¼å®¹æ€§

```hemlock
// éç©ºå¯èµ‹å€¼ç»™å¯ç©º
let x: i32? = 42;           // æ­£ç¡®
let y: i32? = null;         // æ­£ç¡®

// å¯ç©ºä¸èƒ½èµ‹å€¼ç»™éç©º
let z: i32 = x;             // é”™è¯¯ï¼šx å¯èƒ½æ˜¯ null

// ç©ºå€¼åˆå¹¶ä»¥è§£åŒ…
let z: i32 = x ?? 0;        // æ­£ç¡®ï¼š?? æä¾›é»˜è®¤å€¼

// å¯é€‰é“¾è¿”å›å¯ç©º
let name: string? = user?.name;
```

---

## 3. ç±»å‹åˆ«å

### åŠ¨æœº

å¤æ‚ç±»å‹å—ç›Šäºå‘½åç¼©å†™ï¼š

```hemlock
// å½“å‰ï¼šé‡å¤çš„å¤åˆç±»å‹
fn process(entity: HasName & HasId & HasTimestamp) { ... }
fn validate(entity: HasName & HasId & HasTimestamp) { ... }

// æè®®ï¼šå‘½ååˆ«å
type Entity = HasName & HasId & HasTimestamp;
fn process(entity: Entity) { ... }
fn validate(entity: Entity) { ... }
```

### è¯­æ³•

```hemlock
// åŸºæœ¬åˆ«å
type Integer = i32;
type Text = string;

// å¤åˆç±»å‹åˆ«å
type Entity = HasName & HasId;
type Auditable = HasCreatedAt & HasUpdatedAt & HasCreatedBy;

// å‡½æ•°ç±»å‹åˆ«å
type Callback = fn(Event): void;
type Predicate = fn(any): bool;
type Reducer = fn(acc: any, val: any): any;
type AsyncTask = async fn(): any;

// å¯ç©ºåˆ«å
type OptionalString = string?;

// æ³›å‹åˆ«åï¼ˆå¦‚æœæˆ‘ä»¬æ”¯æŒæ³›å‹ç±»å‹åˆ«åï¼‰
type Pair<T> = { first: T, second: T };
type Result<T, E> = { value: T?, error: E? };

// æ•°ç»„ç±»å‹åˆ«å
type IntArray = array<i32>;
type Matrix = array<array<f64>>;
```

### ä½œç”¨åŸŸå’Œå¯è§æ€§

```hemlock
// é»˜è®¤æ¨¡å—ä½œç”¨åŸŸ
type Callback = fn(Event): void;

// å¯å¯¼å‡º
export type Handler = fn(Request): Response;

// åœ¨å¦ä¸€ä¸ªæ–‡ä»¶ä¸­
import { Handler } from "./handlers.hml";
fn register(h: Handler) { ... }
```

### AST æ›´æ”¹

```c
// æ–°è¯­å¥ç±»å‹
typedef enum {
    // ... ç°æœ‰è¯­å¥ ...
    STMT_TYPE_ALIAS,    // æ–°å¢
} StmtKind;

// åœ¨ Stmt union ä¸­
struct {
    char *name;                 // åˆ«ååç§°
    char **type_params;         // æ³›å‹å‚æ•°ï¼š<T, U>
    int num_type_params;
    Type *aliased_type;         // å®é™…ç±»å‹
} type_alias;
```

### è§£æ

```
type_alias := "type" identifier ["<" type_params ">"] "=" type ";"
```

**æ³¨æ„ï¼š**`type` æ˜¯ä¸€ä¸ªæ–°å…³é”®å­—ã€‚æ£€æŸ¥ä¸ç°æœ‰æ ‡è¯†ç¬¦çš„å†²çªã€‚

### è§£æ

ç±»å‹åˆ«ååœ¨ä»¥ä¸‹æ—¶æœºè§£æï¼š
- **è§£ææ—¶ï¼š**åˆ«åè®°å½•åœ¨ç±»å‹ç¯å¢ƒä¸­
- **æ£€æŸ¥æ—¶ï¼š**åˆ«åå±•å¼€ä¸ºåº•å±‚ç±»å‹
- **è¿è¡Œæ—¶ï¼š**åˆ«åæ˜¯é€æ˜çš„ï¼ˆä¸åº•å±‚ç±»å‹ç›¸åŒï¼‰

```hemlock
type MyInt = i32;
let x: MyInt = 42;
typeof(x);           // "i32"ï¼ˆä¸æ˜¯ "MyInt"ï¼‰
```

---

## 4. Const å‚æ•°

### åŠ¨æœº

åœ¨å‡½æ•°ç­¾åä¸­è¡¨ç¤ºä¸å¯å˜æ€§æ„å›¾ï¼š

```hemlock
// å½“å‰ï¼šä¸æ¸…æ¥š array æ˜¯å¦ä¼šè¢«ä¿®æ”¹
fn print_all(items: array) { ... }

// æè®®ï¼šæ˜¾å¼ä¸å¯å˜æ€§å¥‘çº¦
fn print_all(const items: array) { ... }
```

### è¯­æ³•

```hemlock
// Const å‚æ•°
fn process(const data: buffer) {
    // data[0] = 0;        // é”™è¯¯ï¼šä¸èƒ½ä¿®æ”¹ const
    let x = data[0];       // æ­£ç¡®ï¼šå…è®¸è¯»å–
    return x;
}

// å¤šä¸ª const å‚æ•°
fn compare(const a: array, const b: array): bool { ... }

// æ··åˆ const å’Œå¯å˜
fn update(const source: array, target: array) {
    for (item in source) {
        target.push(item);   // æ­£ç¡®ï¼štarget æ˜¯å¯å˜çš„
    }
}

// Const ä¸ç±»å‹æ¨æ–­
fn log(const msg) {
    print(msg);
}

// å‡½æ•°ç±»å‹ä¸­çš„ const
type Reader = fn(const buffer): i32;
```

### Const é˜»æ­¢çš„æ“ä½œ

```hemlock
fn bad(const arr: array) {
    arr.push(1);         // é”™è¯¯ï¼šä¿®æ”¹æ–¹æ³•
    arr.pop();           // é”™è¯¯ï¼šä¿®æ”¹æ–¹æ³•
    arr[0] = 5;          // é”™è¯¯ï¼šç´¢å¼•èµ‹å€¼
    arr.clear();         // é”™è¯¯ï¼šä¿®æ”¹æ–¹æ³•
}

fn ok(const arr: array) {
    let x = arr[0];      // æ­£ç¡®ï¼šè¯»å–
    let len = len(arr);  // æ­£ç¡®ï¼šé•¿åº¦æ£€æŸ¥
    let copy = arr.slice(0, 10);  // æ­£ç¡®ï¼šåˆ›å»ºæ–°æ•°ç»„
    for (item in arr) {  // æ­£ç¡®ï¼šè¿­ä»£
        print(item);
    }
}
```

### ä¿®æ”¹æ–¹æ³•ä¸éä¿®æ”¹æ–¹æ³•

| ç±»å‹ | ä¿®æ”¹ï¼ˆè¢« const é˜»æ­¢ï¼‰ | éä¿®æ”¹ï¼ˆå…è®¸ï¼‰ |
|------|----------------------------|------------------------|
| array | pushã€popã€shiftã€unshiftã€insertã€removeã€clearã€reverseï¼ˆåŸåœ°ï¼‰ | sliceã€concatã€mapã€filterã€findã€containsã€firstã€lastã€join |
| string | ç´¢å¼•èµ‹å€¼ï¼ˆ`s[0] = 'x'`ï¼‰ | æ‰€æœ‰æ–¹æ³•ï¼ˆè¿”å›æ–°å­—ç¬¦ä¸²ï¼‰ |
| buffer | ç´¢å¼•èµ‹å€¼ã€memsetã€memcpyï¼ˆç›®æ ‡ï¼‰ | ç´¢å¼•è¯»å–ã€slice |
| object | å­—æ®µèµ‹å€¼ | å­—æ®µè¯»å– |

### AST æ›´æ”¹

```c
// åœ¨å‡½æ•°è¡¨è¾¾å¼ä¸­ï¼ˆinclude/ast.hï¼‰
struct {
    // ... ç°æœ‰å­—æ®µ ...
    int *param_is_const;    // æ–°å¢ï¼š1 è¡¨ç¤º constï¼Œ0 è¡¨ç¤ºå¦
} function;

// åœ¨å‡½æ•°ç±»å‹çš„ Type ç»“æ„ä¸­
struct Type {
    // ... ç°æœ‰å­—æ®µ ...
    int *param_is_const;    // ç”¨äº TYPE_FUNCTION
};
```

### å¼ºåˆ¶æ‰§è¡Œ

**è§£é‡Šå™¨ï¼š**
- åœ¨å˜é‡ç»‘å®šä¸­è·Ÿè¸ª const æ€§
- åœ¨ä¿®æ”¹æ“ä½œå‰æ£€æŸ¥
- const è¿è§„æ—¶è¿è¡Œæ—¶é”™è¯¯

**ç¼–è¯‘å™¨ï¼š**
- åœ¨æœ‰ç›Šæ—¶ç”Ÿæˆ const é™å®šçš„ C å˜é‡
- const è¿è§„çš„é™æ€åˆ†æ
- ç¼–è¯‘æ—¶è­¦å‘Š/é”™è¯¯

---

## 5. Define ä¸­çš„æ–¹æ³•ç­¾å

### åŠ¨æœº

å…è®¸ `define` å—æŒ‡å®šé¢„æœŸçš„æ–¹æ³•ï¼Œä¸ä»…æ˜¯æ•°æ®å­—æ®µï¼š

```hemlock
// å½“å‰ï¼šä»…æ•°æ®å­—æ®µ
define User {
    name: string;
    age: i32;
}

// æè®®ï¼šæ–¹æ³•ç­¾å
define Comparable {
    fn compare(other: Self): i32;
}

define Serializable {
    fn serialize(): string;
    fn deserialize(data: string): Self;  // é™æ€æ–¹æ³•
}
```

### è¯­æ³•

```hemlock
// æ–¹æ³•ç­¾åï¼ˆæ— æ–¹æ³•ä½“ï¼‰
define Hashable {
    fn hash(): i32;
}

// å¤šä¸ªæ–¹æ³•
define Collection {
    fn size(): i32;
    fn is_empty(): bool;
    fn contains(item: any): bool;
}

// æ··åˆå­—æ®µå’Œæ–¹æ³•
define Entity {
    id: i32;
    name: string;
    fn validate(): bool;
    fn serialize(): string;
}

// ä½¿ç”¨ Self ç±»å‹
define Cloneable {
    fn clone(): Self;
}

define Comparable {
    fn compare(other: Self): i32;
    fn equals(other: Self): bool;
}

// å¯é€‰æ–¹æ³•
define Printable {
    fn to_string(): string;
    fn debug_string?(): string;  // å¯é€‰æ–¹æ³•ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰
}

// å¸¦é»˜è®¤å®ç°çš„æ–¹æ³•
define Ordered {
    fn compare(other: Self): i32;  // å¿…éœ€

    // é»˜è®¤å®ç°ï¼ˆå¦‚æœæœªè¦†ç›–åˆ™ç»§æ‰¿ï¼‰
    fn less_than(other: Self): bool {
        return self.compare(other) < 0;
    }
    fn greater_than(other: Self): bool {
        return self.compare(other) > 0;
    }
    fn equals(other: Self): bool {
        return self.compare(other) == 0;
    }
}
```

### `Self` ç±»å‹

`Self` æŒ‡çš„æ˜¯å®ç°æ¥å£çš„å…·ä½“ç±»å‹ï¼š

```hemlock
define Addable {
    fn add(other: Self): Self;
}

// ä½¿ç”¨æ—¶ï¼š
let a: Addable = {
    value: 10,
    add: fn(other) {
        return { value: self.value + other.value, add: self.add };
    }
};
```

### ç»“æ„ç±»å‹ï¼ˆé¸­å­ç±»å‹ï¼‰

æ–¹æ³•ç­¾åä½¿ç”¨ä¸å­—æ®µç›¸åŒçš„é¸­å­ç±»å‹ï¼š

```hemlock
define Stringifiable {
    fn to_string(): string;
}

// ä»»ä½•æœ‰ to_string() æ–¹æ³•çš„å¯¹è±¡éƒ½æ»¡è¶³ Stringifiable
let x: Stringifiable = {
    name: "test",
    to_string: fn() { return self.name; }
};

// å¸¦æ–¹æ³•çš„å¤åˆç±»å‹
define Named { name: string; }
define Printable { fn to_string(): string; }

type NamedPrintable = Named & Printable;

let y: NamedPrintable = {
    name: "Alice",
    to_string: fn() { return "Name: " + self.name; }
};
```

### AST æ›´æ”¹

```c
// æ‰©å±• Stmt union ä¸­çš„ define_object
struct {
    char *name;
    char **type_params;
    int num_type_params;

    // å­—æ®µï¼ˆç°æœ‰ï¼‰
    char **field_names;
    Type **field_types;
    int *field_optional;
    Expr **field_defaults;
    int num_fields;

    // æ–¹æ³•ï¼ˆæ–°å¢ï¼‰
    char **method_names;
    Type **method_types;        // TYPE_FUNCTION
    int *method_optional;       // å¯é€‰æ–¹æ³•ï¼ˆfn name?(): typeï¼‰
    Expr **method_defaults;     // é»˜è®¤å®ç°ï¼ˆå¦‚æœä»…ç­¾ååˆ™ä¸º NULLï¼‰
    int num_methods;
} define_object;
```

### ç±»å‹æ£€æŸ¥

æ£€æŸ¥ `value: InterfaceType` æ—¶ï¼š
1. æ£€æŸ¥æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨ä¸”ç±»å‹å…¼å®¹
2. æ£€æŸ¥æ‰€æœ‰å¿…éœ€æ–¹æ³•å­˜åœ¨ä¸”ç­¾åå…¼å®¹
3. å¯é€‰å­—æ®µ/æ–¹æ³•å¯ä»¥ä¸å­˜åœ¨

```hemlock
define Sortable {
    fn compare(other: Self): i32;
}

// æœ‰æ•ˆï¼šæœ‰ compare æ–¹æ³•
let valid: Sortable = {
    value: 10,
    compare: fn(other) { return self.value - other.value; }
};

// æ— æ•ˆï¼šç¼ºå°‘ compare
let invalid: Sortable = { value: 10 };  // é”™è¯¯ï¼šç¼ºå°‘æ–¹æ³• 'compare'

// æ— æ•ˆï¼šç­¾åé”™è¯¯
let wrong: Sortable = {
    compare: fn() { return 0; }  // é”™è¯¯ï¼šæœŸæœ› (Self): i32
};
```

---

## äº¤äº’ç¤ºä¾‹

### ç»„åˆæ‰€æœ‰ç‰¹æ€§

```hemlock
// å¤æ‚å‡½æ•°ç±»å‹çš„ç±»å‹åˆ«å
type EventCallback = fn(event: Event, context: Context?): bool;

// å¤åˆæ¥å£çš„ç±»å‹åˆ«å
type Entity = HasId & HasName & Serializable;

// å¸¦æ–¹æ³•ç­¾åçš„ Define
define Repository<T> {
    fn find(id: i32): T?;
    fn save(const entity: T): bool;
    fn delete(id: i32): bool;
    fn find_all(predicate: fn(T): bool): array<T>;
}

// å°†æ‰€æœ‰ç»„åˆåœ¨ä¸€èµ·ä½¿ç”¨
fn create_user_repo(): Repository<User> {
    let users: array<User> = [];

    return {
        find: fn(id) {
            for (u in users) {
                if (u.id == id) { return u; }
            }
            return null;
        },
        save: fn(const entity) {
            users.push(entity);
            return true;
        },
        delete: fn(id) {
            // ...
            return true;
        },
        find_all: fn(predicate) {
            return users.filter(predicate);
        }
    };
}
```

### æ˜¾å¼ç±»å‹çš„å›è°ƒ

```hemlock
type ClickHandler = fn(event: MouseEvent): void;
type KeyHandler = fn(event: KeyEvent, modifiers: i32): bool;

define Widget {
    x: i32;
    y: i32;
    on_click: ClickHandler?;
    on_key: KeyHandler?;
}

fn create_button(label: string, handler: ClickHandler): Widget {
    return {
        x: 0, y: 0,
        on_click: handler,
        on_key: null
    };
}
```

### å¯ç©ºå‡½æ•°ç±»å‹

```hemlock
// å¯é€‰å›è°ƒ
fn fetch(url: string, on_complete: fn(Response): void?): void {
    let response = http_get(url);
    if (on_complete != null) {
        on_complete(response);
    }
}

// å‡½æ•°ç±»å‹çš„å¯ç©ºè¿”å›
type Parser = fn(input: string): AST?;

fn try_parse(parsers: array<Parser>, input: string): AST? {
    for (p in parsers) {
        let result = p(input);
        if (result != null) {
            return result;
        }
    }
    return null;
}
```

---

## å®ç°è·¯çº¿å›¾

### é˜¶æ®µ 1ï¼šæ ¸å¿ƒåŸºç¡€è®¾æ–½
1. å°† `TYPE_FUNCTION` æ·»åŠ åˆ° TypeKind æšä¸¾
2. ç”¨å‡½æ•°ç±»å‹å­—æ®µæ‰©å±• Type ç»“æ„
3. å°† `CHECKED_FUNCTION` æ·»åŠ åˆ°ç¼–è¯‘å™¨ç±»å‹æ£€æŸ¥å™¨
4. æ·»åŠ  `Self` ç±»å‹æ”¯æŒï¼ˆTYPE_SELFï¼‰

### é˜¶æ®µ 2ï¼šè§£æ
1. åœ¨è§£æå™¨ä¸­å®ç° `parse_function_type()`
2. åœ¨ç±»å‹ä½ç½®å¤„ç† `fn(...)`
3. æ·»åŠ  `type` å…³é”®å­—å’Œ `STMT_TYPE_ALIAS` è§£æ
4. æ·»åŠ  `const` å‚æ•°ä¿®é¥°ç¬¦è§£æ
5. æ‰©å±• define è§£æä»¥æ”¯æŒæ–¹æ³•ç­¾å

### é˜¶æ®µ 3ï¼šç±»å‹æ£€æŸ¥
1. å‡½æ•°ç±»å‹å…¼å®¹æ€§è§„åˆ™
2. ç±»å‹åˆ«åè§£æå’Œå±•å¼€
3. Const å‚æ•°ä¿®æ”¹æ£€æŸ¥
4. define ç±»å‹ä¸­çš„æ–¹æ³•ç­¾åéªŒè¯
5. Self ç±»å‹è§£æ

### é˜¶æ®µ 4ï¼šè¿è¡Œæ—¶
1. è°ƒç”¨ç‚¹çš„å‡½æ•°ç±»å‹éªŒè¯
2. Const è¿è§„æ£€æµ‹
3. ç±»å‹åˆ«åé€æ˜æ€§

### é˜¶æ®µ 5ï¼šä¸€è‡´æ€§æµ‹è¯•
1. å‡½æ•°ç±»å‹æ³¨è§£æµ‹è¯•
2. å¯ç©ºç»„åˆæµ‹è¯•
3. ç±»å‹åˆ«åæµ‹è¯•
4. Const å‚æ•°æµ‹è¯•
5. æ–¹æ³•ç­¾åæµ‹è¯•

---

## è®¾è®¡å†³ç­–

### 1. æ³›å‹ç±»å‹åˆ«åï¼š**æ˜¯**

ç±»å‹åˆ«åæ”¯æŒæ³›å‹å‚æ•°ï¼š

```hemlock
// æ³›å‹ç±»å‹åˆ«å
type Pair<T> = { first: T, second: T };
type Result<T, E> = { value: T?, error: E? };
type Mapper<T, U> = fn(T): U;
type AsyncResult<T> = async fn(): T?;

// ä½¿ç”¨
let coords: Pair<f64> = { first: 3.14, second: 2.71 };
let result: Result<User, string> = { value: user, error: null };
let transform: Mapper<i32, string> = fn(n) { return n.to_string(); };
```

### 2. Const ä¼ æ’­ï¼š**æ·±å±‚**

Const å‚æ•°æ˜¯å®Œå…¨ä¸å¯å˜çš„ - é€šè¿‡ä»»ä½•è·¯å¾„éƒ½ä¸èƒ½ä¿®æ”¹ï¼š

```hemlock
fn process(const arr: array<object>) {
    arr.push({});        // é”™è¯¯ï¼šä¸èƒ½ä¿®æ”¹ const æ•°ç»„
    arr[0] = {};         // é”™è¯¯ï¼šä¸èƒ½ä¿®æ”¹ const æ•°ç»„
    arr[0].x = 5;        // é”™è¯¯ï¼šä¸èƒ½é€šè¿‡ const ä¿®æ”¹ï¼ˆæ·±å±‚ï¼‰

    let x = arr[0].x;    // æ­£ç¡®ï¼šè¯»å–æ²¡é—®é¢˜
    let copy = arr[0];   // æ­£ç¡®ï¼šåˆ›å»ºå‰¯æœ¬
    copy.x = 5;          // æ­£ç¡®ï¼šå‰¯æœ¬ä¸æ˜¯ const
}

fn nested(const obj: object) {
    obj.user.name = "x"; // é”™è¯¯ï¼šæ·±å±‚ const é˜»æ­¢åµŒå¥—ä¿®æ”¹
    obj.items[0] = 1;    // é”™è¯¯ï¼šæ·±å±‚ const é˜»æ­¢åµŒå¥—ä¿®æ”¹
}
```

**ç†ç”±ï¼š**æ·±å±‚ const æä¾›æ›´å¼ºçš„ä¿è¯ï¼Œå¯¹äºç¡®ä¿æ•°æ®å®Œæ•´æ€§æ›´æœ‰ç”¨ã€‚å¦‚æœéœ€è¦ä¿®æ”¹åµŒå¥—æ•°æ®ï¼Œå…ˆå¤åˆ¶ã€‚

### 3. ç‹¬ç«‹ç±»å‹åˆ«åä¸­çš„ Selfï¼š**å¦**

`Self` ä»…åœ¨ `define` å—å†…æœ‰æ•ˆï¼Œåœ¨é‚£é‡Œå®ƒæœ‰æ˜ç¡®çš„å«ä¹‰ï¼š

```hemlock
// æœ‰æ•ˆï¼šSelf æŒ‡çš„æ˜¯å®šä¹‰çš„ç±»å‹
define Comparable {
    fn compare(other: Self): i32;
}

// æ— æ•ˆï¼šSelf åœ¨è¿™é‡Œæ²¡æœ‰æ„ä¹‰
type Cloner = fn(Self): Self;  // é”™è¯¯ï¼šSelf åœ¨ define ä¸Šä¸‹æ–‡ä¹‹å¤–

// æ”¹ç”¨æ³›å‹ï¼š
type Cloner<T> = fn(T): T;
```

### 4. æ–¹æ³•é»˜è®¤å®ç°ï¼š**æ˜¯ï¼ˆä»…ç®€å•çš„ï¼‰**

å…è®¸ç®€å•/å®ç”¨æ–¹æ³•çš„é»˜è®¤å®ç°ï¼š

```hemlock
define Comparable {
    // å¿…éœ€ï¼šå¿…é¡»å®ç°
    fn compare(other: Self): i32;

    // é»˜è®¤å®ç°ï¼ˆç®€å•ä¾¿åˆ©æ–¹æ³•ï¼‰
    fn equals(other: Self): bool {
        return self.compare(other) == 0;
    }
    fn less_than(other: Self): bool {
        return self.compare(other) < 0;
    }
    fn greater_than(other: Self): bool {
        return self.compare(other) > 0;
    }
}

define Printable {
    fn to_string(): string;

    // é»˜è®¤ï¼šå§”æ‰˜ç»™å¿…éœ€æ–¹æ³•
    fn print() {
        print(self.to_string());
    }
    fn println() {
        print(self.to_string() + "\n");
    }
}

// å¯¹è±¡åªéœ€å®ç°å¿…éœ€æ–¹æ³•
let item: Comparable = {
    value: 42,
    compare: fn(other) { return self.value - other.value; }
    // equalsã€less_thanã€greater_than ä»é»˜è®¤ç»§æ‰¿
};

item.less_than({ value: 50, compare: item.compare });  // true
```

**é»˜è®¤å®ç°æŒ‡å—ï¼š**
- ä¿æŒç®€å•ï¼ˆ1-3 è¡Œï¼‰
- åº”è¯¥å§”æ‰˜ç»™å¿…éœ€æ–¹æ³•
- æ— å¤æ‚é€»è¾‘æˆ–å‰¯ä½œç”¨
- ä»…é™åŸå§‹ç±»å‹å’Œç›´æ¥ç»„åˆ

### 5. å‹å˜ï¼š**æ¨æ–­ï¼ˆæ— æ˜¾å¼æ³¨è§£ï¼‰**

å‹å˜æ ¹æ®ç±»å‹å‚æ•°çš„ä½¿ç”¨æ–¹å¼æ¨æ–­ï¼š

```hemlock
// å‹å˜æ ¹æ®ä½ç½®è‡ªåŠ¨ç¡®å®š
type Producer<T> = fn(): T;           // T åœ¨è¿”å›ä½ç½® = åå˜
type Consumer<T> = fn(T): void;       // T åœ¨å‚æ•°ä½ç½® = é€†å˜
type Transformer<T> = fn(T): T;       // T åœ¨ä¸¤ä¸ªä½ç½® = ä¸å˜

// ç¤ºä¾‹ï¼šDog <: Animalï¼ˆDog æ˜¯ Animal çš„å­ç±»å‹ï¼‰
let dog_producer: Producer<Dog> = fn() { return new_dog(); };
let animal_producer: Producer<Animal> = dog_producer;  // æ­£ç¡®ï¼šåå˜

let animal_consumer: Consumer<Animal> = fn(a) { print(a); };
let dog_consumer: Consumer<Dog> = animal_consumer;     // æ­£ç¡®ï¼šé€†å˜
```

**ä¸ºä»€ä¹ˆæ¨æ–­ï¼Ÿ**
- æ›´å°‘çš„æ ·æ¿ä»£ç ï¼ˆ`<out T>` / `<in T>` å¢åŠ å™ªéŸ³ï¼‰
- éµå¾ª"æ˜¾å¼ä¼˜äºéšå¼" - ä½ç½®æœ¬èº«å°±æ˜¯æ˜¾å¼çš„
- ä¸å¤§å¤šæ•°è¯­è¨€å¤„ç†å‡½æ•°ç±»å‹å‹å˜çš„æ–¹å¼ä¸€è‡´
- è¿åå‹å˜è§„åˆ™æ—¶é”™è¯¯æ¸…æ™°

---

## é™„å½•ï¼šè¯­æ³•æ›´æ”¹

```ebnf
(* ç±»å‹ *)
type := simple_type | compound_type | function_type
simple_type := base_type ["?"] | identifier ["<" type_args ">"] ["?"]
compound_type := simple_type ("&" simple_type)+
function_type := ["async"] "fn" "(" [param_types] ")" [":" type]

base_type := "i8" | "i16" | "i32" | "i64"
           | "u8" | "u16" | "u32" | "u64"
           | "f32" | "f64" | "bool" | "string" | "rune"
           | "ptr" | "buffer" | "void" | "null"
           | "array" ["<" type ">"]
           | "object"
           | "Self"

param_types := param_type ("," param_type)*
param_type := ["const"] [identifier ":"] ["?"] type
            | "..." [identifier] [":" type]

type_args := type ("," type)*

(* è¯­å¥ *)
type_alias := "type" identifier ["<" type_params ">"] "=" type ";"

define_stmt := "define" identifier ["<" type_params ">"] "{" define_members "}"
define_members := (field_def | method_def)*
field_def := identifier (":" type ["=" expr] | "?:" (type | expr)) ";"?
method_def := "fn" identifier ["?"] "(" [param_types] ")" [":" type] (block | ";")
            (* "?" æ ‡è®°å¯é€‰æ–¹æ³•ï¼Œblock æä¾›é»˜è®¤å®ç° *)

(* å‚æ•° *)
param := ["const"] ["ref"] identifier [":" type] ["?:" expr]
       | "..." identifier [":" type]
```


--------------------------------------------------------------------------------
## è®¾è®¡ç†å¿µ
--------------------------------------------------------------------------------

# Hemlock è¯­è¨€è®¾è®¡ç†å¿µ

> "ä¸€ä¸ªå°å·§çš„ã€éå®‰å…¨çš„è¯­è¨€ï¼Œç”¨äºå®‰å…¨åœ°ç¼–å†™éå®‰å…¨çš„ä»£ç ã€‚"

æœ¬æ–‡æ¡£è®°å½•äº† Hemlock çš„æ ¸å¿ƒè®¾è®¡åŸåˆ™å’Œç†å¿µã€‚åœ¨å¯¹è¯­è¨€è¿›è¡Œä»»ä½•æ›´æ”¹æˆ–æ·»åŠ ä¹‹å‰ï¼Œè¯·å…ˆé˜…è¯»æœ¬æ–‡æ¡£ã€‚

---

## ç›®å½•

- [æ ¸å¿ƒå®šä½](#æ ¸å¿ƒå®šä½)
- [è®¾è®¡åŸåˆ™](#è®¾è®¡åŸåˆ™)
- [å®‰å…¨æ€§ç†å¿µ](#å®‰å…¨æ€§ç†å¿µ)
- [ä¸åº”æ·»åŠ çš„ç‰¹æ€§](#ä¸åº”æ·»åŠ çš„ç‰¹æ€§)
- [æœªæ¥è€ƒè™‘](#æœªæ¥è€ƒè™‘)
- [ç»“è¯­](#ç»“è¯­)

---

## æ ¸å¿ƒå®šä½

Hemlock æ˜¯ä¸€ç§**ç³»ç»Ÿè„šæœ¬è¯­è¨€**ï¼Œé‡‡ç”¨æ‰‹åŠ¨å†…å­˜ç®¡ç†å’Œæ˜¾å¼æ§åˆ¶ã€‚å®ƒä¸“ä¸ºä»¥ä¸‹éœ€æ±‚çš„ç¨‹åºå‘˜è®¾è®¡ï¼š

- C è¯­è¨€çš„å¼ºå¤§èƒ½åŠ›
- ç°ä»£è„šæœ¬è¯­è¨€çš„æ˜“ç”¨æ€§
- å†…ç½®çš„ç»“æ„åŒ–å¼‚æ­¥å¹¶å‘
- æ— éšè—è¡Œä¸ºæˆ–é­”æ³•

### Hemlock ä¸æ˜¯ä»€ä¹ˆ

- **å†…å­˜å®‰å…¨çš„**ï¼ˆæ‚¬ç©ºæŒ‡é’ˆæ˜¯ä½ çš„è´£ä»»ï¼‰
- **Rustã€Go æˆ– Lua çš„æ›¿ä»£å“**
- **å‘ä½ éšè—å¤æ‚æ€§çš„è¯­è¨€**

### Hemlock æ˜¯ä»€ä¹ˆ

- **æ°¸è¿œæ˜¾å¼ä¼˜äºéšå¼**
- **æ•™è‚²æ€§å’Œå®éªŒæ€§çš„**
- **ç”¨äºç³»ç»Ÿå·¥ä½œçš„ "C è„šæœ¬å±‚"**
- **è¯šå®åœ°å¯¹å¾…æƒè¡¡**

---

## è®¾è®¡åŸåˆ™

### 1. æ˜¾å¼ä¼˜äºéšå¼

Hemlock åœ¨æ‰€æœ‰è¯­è¨€ç»“æ„ä¸­åå‘æ˜¾å¼ã€‚ä¸åº”æœ‰æƒŠå–œã€é­”æ³•å’Œéšè—è¡Œä¸ºã€‚

**ä¸å¥½çš„åšæ³•ï¼ˆéšå¼ï¼‰ï¼š**
```hemlock
let x = 5  // ç¼ºå°‘åˆ†å· - åº”è¯¥æŠ¥é”™
```

**å¥½çš„åšæ³•ï¼ˆæ˜¾å¼ï¼‰ï¼š**
```hemlock
let x = 5;
free(ptr);  // ä½ åˆ†é…çš„ï¼Œä½ é‡Šæ”¾
```

**å…³é”®è¦ç‚¹ï¼š**
- åˆ†å·æ˜¯å¼ºåˆ¶çš„ï¼ˆæ²¡æœ‰è‡ªåŠ¨åˆ†å·æ’å…¥ï¼‰
- æ²¡æœ‰åƒåœ¾å›æ”¶
- æ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼ˆalloc/freeï¼‰
- ç±»å‹æ³¨è§£æ˜¯å¯é€‰çš„ï¼Œä½†åœ¨è¿è¡Œæ—¶ä¼šè¢«æ£€æŸ¥
- æ²¡æœ‰è‡ªåŠ¨èµ„æºæ¸…ç†ï¼ˆæ²¡æœ‰ RAIIï¼‰ï¼Œä½† `defer` æä¾›æ˜¾å¼æ¸…ç†

### 2. é»˜è®¤åŠ¨æ€ï¼Œå¯é€‰ç±»å‹

æ¯ä¸ªå€¼éƒ½æœ‰è¿è¡Œæ—¶ç±»å‹æ ‡ç­¾ï¼Œä½†ç³»ç»Ÿè®¾è®¡ä¸ºçµæ´»çš„åŒæ—¶ä»èƒ½æ•è·é”™è¯¯ã€‚

**ç±»å‹æ¨æ–­ï¼š**
- å°æ•´æ•°ï¼ˆé€‚åˆ i32ï¼‰ï¼š`42` â†’ `i32`
- å¤§æ•´æ•°ï¼ˆè¶…è¿‡ i32 èŒƒå›´ï¼‰ï¼š`9223372036854775807` â†’ `i64`
- æµ®ç‚¹æ•°ï¼š`3.14` â†’ `f64`

**éœ€è¦æ—¶æ˜¾å¼ç±»å‹ï¼š**
```hemlock
let x = 42;              // æ¨æ–­ä¸º i32ï¼ˆå°å€¼ï¼‰
let y: u8 = 255;         // æ˜¾å¼ u8
let z = x + y;           // æå‡ä¸º i32
let big = 5000000000;    // æ¨æ–­ä¸º i64ï¼ˆè¶…è¿‡ i32 æœ€å¤§å€¼ï¼‰
```

**ç±»å‹æå‡è§„åˆ™**éµå¾ªä»æœ€å°åˆ°æœ€å¤§çš„æ¸…æ™°å±‚æ¬¡ï¼Œæµ®ç‚¹æ•°å§‹ç»ˆä¼˜å…ˆäºæ•´æ•°ã€‚

### 3. éå®‰å…¨æ˜¯ç‰¹æ€§ï¼Œä¸æ˜¯ç¼ºé™·

Hemlock ä¸è¯•å›¾é˜»æ­¢æ‰€æœ‰é”™è¯¯ã€‚ç›¸åï¼Œå®ƒç»™ä½ å®‰å…¨çš„å·¥å…·ï¼ŒåŒæ—¶å…è®¸ä½ åœ¨éœ€è¦æ—¶é€‰æ‹©éå®‰å…¨è¡Œä¸ºã€‚

**æœ‰æ„çš„éå®‰å…¨æ€§ç¤ºä¾‹ï¼š**
- æŒ‡é’ˆè¿ç®—å¯èƒ½æº¢å‡ºï¼ˆç”¨æˆ·çš„è´£ä»»ï¼‰
- åŸå§‹ `ptr` æ²¡æœ‰è¾¹ç•Œæ£€æŸ¥ï¼ˆå¦‚æœéœ€è¦å®‰å…¨æ€§ï¼Œä½¿ç”¨ `buffer`ï¼‰
- å…è®¸åŒé‡é‡Šæ”¾å´©æºƒï¼ˆæ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼‰
- ç±»å‹ç³»ç»Ÿé˜²æ­¢æ„å¤–ä½†å…è®¸éœ€è¦æ—¶çš„å±é™©æ“ä½œ

```hemlock
let p = alloc(10);
let q = p + 100;  // è¿œè¶…åˆ†é…èŒƒå›´ - å…è®¸ä½†å±é™©
```

**ç†å¿µï¼š**ç±»å‹ç³»ç»Ÿåº”è¯¥é˜²æ­¢*æ„å¤–*ï¼Œä½†å…è®¸*æœ‰æ„çš„*éå®‰å…¨æ“ä½œã€‚

### 4. ç»“æ„åŒ–å¹¶å‘ä½œä¸ºä¸€ç­‰å…¬æ°‘

å¹¶å‘ä¸æ˜¯ Hemlock çš„äº‹åè€ƒè™‘ã€‚å®ƒä»ä¸€å¼€å§‹å°±å†…ç½®äºè¯­è¨€ä¸­ã€‚

**ä¸»è¦ç‰¹æ€§ï¼š**
- `async`/`await` å†…ç½®äºè¯­è¨€ä¸­
- ç”¨äºé€šä¿¡çš„ Channel
- ç”¨äºä»»åŠ¡ç®¡ç†çš„ `spawn`/`join`/`detach`
- æ²¡æœ‰åŸå§‹çº¿ç¨‹ï¼Œæ²¡æœ‰é” - ä»…ç»“æ„åŒ–
- ä½¿ç”¨ POSIX çº¿ç¨‹å®ç°çœŸæ­£çš„å¤šçº¿ç¨‹å¹¶è¡Œ

**ä¸æ˜¯äº‹ä»¶å¾ªç¯æˆ–ç»¿è‰²çº¿ç¨‹** - Hemlock ä½¿ç”¨çœŸæ­£çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹åœ¨å¤šä¸ª CPU æ ¸å¿ƒä¸Šå®ç°çœŸæ­£çš„å¹¶è¡Œã€‚

### 5. ç±» C è¯­æ³•ï¼Œä½ä»ªå¼æ„Ÿ

Hemlock å¯¹ç³»ç»Ÿç¨‹åºå‘˜æ¥è¯´åº”è¯¥æ„Ÿè§‰ç†Ÿæ‚‰ï¼ŒåŒæ—¶å‡å°‘æ ·æ¿ä»£ç ã€‚

**è®¾è®¡é€‰æ‹©ï¼š**
- å§‹ç»ˆä½¿ç”¨ `{}` å—ï¼Œæ²¡æœ‰å¯é€‰å¤§æ‹¬å·
- è¿ç®—ç¬¦ä¸ C åŒ¹é…ï¼š`+`ã€`-`ã€`*`ã€`/`ã€`&&`ã€`||`ã€`!`
- ç±»å‹è¯­æ³•ä¸ Rust/TypeScript åŒ¹é…ï¼š`let x: type = value;`
- å‡½æ•°æ˜¯ä¸€ç­‰å€¼
- æœ€å°‘çš„å…³é”®å­—å’Œç‰¹æ®Šå½¢å¼

---

## å®‰å…¨æ€§ç†å¿µ

**Hemlock å¯¹å®‰å…¨æ€§çš„çœ‹æ³•ï¼š**

> "æˆ‘ä»¬ç»™ä½ å®‰å…¨çš„å·¥å…·ï¼ˆ`buffer`ã€ç±»å‹æ³¨è§£ã€è¾¹ç•Œæ£€æŸ¥ï¼‰ï¼Œä½†æˆ‘ä»¬ä¸å¼ºè¿«ä½ ä½¿ç”¨å®ƒä»¬ï¼ˆ`ptr`ã€æ‰‹åŠ¨å†…å­˜ã€éå®‰å…¨æ“ä½œï¼‰ã€‚
>
> é»˜è®¤åº”è¯¥å¼•å¯¼å‘å®‰å…¨ï¼Œä½†é€ƒç”Ÿèˆ±å£åº”è¯¥å§‹ç»ˆå¯ç”¨ã€‚"

### æä¾›çš„å®‰å…¨å·¥å…·

**1. å®‰å…¨çš„ buffer ç±»å‹ï¼š**
```hemlock
let b: buffer = buffer(64);
b[0] = 65;              // è¾¹ç•Œæ£€æŸ¥
print(b.length);        // 64
free(b);                // ä»ç„¶æ˜¯æ‰‹åŠ¨çš„
```

**2. éå®‰å…¨çš„åŸå§‹æŒ‡é’ˆï¼š**
```hemlock
let p: ptr = alloc(64);
memset(p, 0, 64);
free(p);  // ä½ å¿…é¡»è®°å¾—é‡Šæ”¾
```

**3. ç±»å‹æ³¨è§£ï¼š**
```hemlock
let x: u8 = 255;   // æ­£ç¡®
let y: u8 = 256;   // é”™è¯¯ï¼šè¶…å‡ºèŒƒå›´
```

**4. è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ï¼š**
```hemlock
let val = some_function();
if (typeof(val) == "i32") {
    // å¯ä»¥å®‰å…¨åœ°ä½œä¸ºæ•´æ•°ä½¿ç”¨
}
```

### æŒ‡å¯¼åŸåˆ™

1. **æ–‡æ¡£ä¸­é»˜è®¤ä½¿ç”¨å®‰å…¨æ¨¡å¼** - åœ¨ `ptr` ä¹‹å‰å±•ç¤º `buffer`ï¼Œé¼“åŠ±ç±»å‹æ³¨è§£
2. **ä½¿éå®‰å…¨æ“ä½œæ˜¾çœ¼** - åŸå§‹æŒ‡é’ˆè¿ç®—åº”è¯¥çœ‹èµ·æ¥æ˜¯æœ‰æ„çš„
3. **æä¾›é€ƒç”Ÿèˆ±å£** - ä¸é˜»æ­¢æœ‰ç»éªŒçš„ç”¨æˆ·è¿›è¡Œåº•å±‚å·¥ä½œ
4. **è¯šå®åœ°å¯¹å¾…æƒè¡¡** - è®°å½•å¯èƒ½å‡ºé”™çš„åœ°æ–¹

### å®‰å…¨ä¸éå®‰å…¨ç¤ºä¾‹

| å®‰å…¨æ¨¡å¼ | éå®‰å…¨æ¨¡å¼ | ä½•æ—¶ä½¿ç”¨éå®‰å…¨ |
|-------------|----------------|-------------------|
| `buffer` ç±»å‹ | `ptr` ç±»å‹ | FFIã€æ€§èƒ½å…³é”®ä»£ç  |
| ç±»å‹æ³¨è§£ | æ— æ³¨è§£ | å¤–éƒ¨æ¥å£ã€éªŒè¯ |
| è¾¹ç•Œæ£€æŸ¥è®¿é—® | æŒ‡é’ˆè¿ç®— | åº•å±‚å†…å­˜æ“ä½œ |
| å¼‚å¸¸å¤„ç† | è¿”å› null/é”™è¯¯ç  | å½“å¼‚å¸¸å¤ªé‡é‡çº§æ—¶ |

---

## ä¸åº”æ·»åŠ çš„ç‰¹æ€§

ç†è§£**ä¸åº”**æ·»åŠ ä»€ä¹ˆä¸çŸ¥é“åº”è¯¥æ·»åŠ ä»€ä¹ˆåŒæ ·é‡è¦ã€‚

### ä¸è¦æ·»åŠ éšå¼è¡Œä¸º

**ä¸å¥½çš„ç¤ºä¾‹ï¼š**

```hemlock
// ä¸å¥½ï¼šè‡ªåŠ¨åˆ†å·æ’å…¥
let x = 5
let y = 10

// ä¸å¥½ï¼šä¸¢å¤±ç²¾åº¦çš„éšå¼ç±»å‹è½¬æ¢
let x: i32 = 3.14  // åº”è¯¥æˆªæ–­è¿˜æ˜¯æŠ¥é”™ï¼Ÿ
```

**åŸå› ï¼š**éšå¼è¡Œä¸ºä¼šé€ æˆæƒŠå–œï¼Œä½¿ä»£ç æ›´éš¾ç†è§£ã€‚

### ä¸è¦éšè—å¤æ‚æ€§

**ä¸å¥½çš„ç¤ºä¾‹ï¼š**

```hemlock
// ä¸å¥½ï¼šå¹•åçš„é­”æ³•ä¼˜åŒ–
let arr = [1, 2, 3]  // è¿™æ˜¯æ ˆè¿˜æ˜¯å †ï¼Ÿç”¨æˆ·åº”è¯¥çŸ¥é“ï¼ï¼ˆå †ï¼Œå¼•ç”¨è®¡æ•°ï¼‰

// ä¸å¥½ï¼šåŸå§‹æŒ‡é’ˆè‡ªåŠ¨é‡Šæ”¾
let p = alloc(100)  // è¿™ä¼šè‡ªåŠ¨é‡Šæ”¾å—ï¼Ÿä¸ä¼šï¼åŸå§‹æŒ‡é’ˆæ€»æ˜¯éœ€è¦ free()
```

**å…³äºå¼•ç”¨è®¡æ•°çš„è¯´æ˜ï¼š**Hemlock å¯¹å­—ç¬¦ä¸²ã€æ•°ç»„ã€å¯¹è±¡å’Œç¼“å†²åŒºä½¿ç”¨å†…éƒ¨å¼•ç”¨è®¡æ•° - è¿™äº›åœ¨ä½œç”¨åŸŸé€€å‡ºæ—¶ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚è¿™æ˜¯æ˜¾å¼ä¸”å¯é¢„æµ‹çš„ï¼ˆå½“å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ç¡®å®šæ€§æ¸…ç†ï¼Œæ²¡æœ‰ GC æš‚åœï¼‰ã€‚åŸå§‹æŒ‡é’ˆï¼ˆæ¥è‡ª `alloc()` çš„ `ptr`ï¼‰ä¸æ˜¯å¼•ç”¨è®¡æ•°çš„ï¼Œå§‹ç»ˆéœ€è¦æ‰‹åŠ¨ `free()`ã€‚

**åŸå› ï¼š**éšè—çš„å¤æ‚æ€§ä½¿å¾—æ— æ³•é¢„æµ‹æ€§èƒ½å’Œè°ƒè¯•é—®é¢˜ã€‚

### ä¸è¦ç ´åç°æœ‰è¯­ä¹‰

**æ°¸è¿œä¸è¦æ”¹å˜è¿™äº›æ ¸å¿ƒå†³å®šï¼š**
- åˆ†å·æ˜¯å¼ºåˆ¶çš„ - ä¸è¦ä½¿å®ƒä»¬å¯é€‰
- æ‰‹åŠ¨å†…å­˜ç®¡ç† - ä¸è¦æ·»åŠ  GC
- å¯å˜å­—ç¬¦ä¸² - ä¸è¦ä½¿å®ƒä»¬ä¸å¯å˜
- è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ - ä¸è¦ç§»é™¤å®ƒ

**åŸå› ï¼š**ä¸€è‡´æ€§å’Œç¨³å®šæ€§æ¯”æ—¶é«¦çš„ç‰¹æ€§æ›´é‡è¦ã€‚

### ä¸è¦æ·»åŠ é™ä½æ˜¾å¼æ€§çš„"ä¾¿åˆ©"ç‰¹æ€§

**åº”é¿å…çš„ç‰¹æ€§ç¤ºä¾‹ï¼š**
- è¿ç®—ç¬¦é‡è½½ï¼ˆç”¨æˆ·ç±»å‹å¯èƒ½å¯ä»¥ï¼Œä½†è¦è°¨æ…ï¼‰
- ä¸¢å¤±ä¿¡æ¯çš„éšå¼ç±»å‹å¼ºåˆ¶è½¬æ¢
- è‡ªåŠ¨èµ„æºæ¸…ç†ï¼ˆRAIIï¼‰
- éšè—å¤æ‚æ€§çš„æ–¹æ³•é“¾
- DSL å’Œé­”æ³•è¯­æ³•

**ä¾‹å¤–ï¼š**å¦‚æœä¾¿åˆ©ç‰¹æ€§æ˜¯ç®€å•æ“ä½œçš„**æ˜¾å¼è¯­æ³•ç³–**ï¼Œåˆ™å¯ä»¥ï¼š
- `else if` å¯ä»¥ï¼ˆå®ƒåªæ˜¯åµŒå¥—çš„ if è¯­å¥ï¼‰
- å­—ç¬¦ä¸²æ’å€¼å¯èƒ½å¯ä»¥ï¼Œå¦‚æœå®ƒæ˜æ˜¾æ˜¯è¯­æ³•ç³–
- å¯¹è±¡çš„æ–¹æ³•è¯­æ³•å¯ä»¥ï¼ˆå®ƒåšä»€ä¹ˆæ˜¯æ˜¾å¼çš„ï¼‰

---

## æœªæ¥è€ƒè™‘

### å¯èƒ½æ·»åŠ ï¼ˆè®¨è®ºä¸­ï¼‰

è¿™äº›ç‰¹æ€§ç¬¦åˆ Hemlock çš„ç†å¿µï¼Œä½†éœ€è¦ä»”ç»†è®¾è®¡ï¼š

**1. æ¨¡å¼åŒ¹é…**
```hemlock
match (value) {
    case i32: print("integer");
    case string: print("text");
    case _: print("other");
}
```
- æ˜¾å¼ç±»å‹æ£€æŸ¥
- æ²¡æœ‰éšè—æˆæœ¬
- å¯èƒ½è¿›è¡Œç¼–è¯‘æ—¶ç©·å°½æ€§æ£€æŸ¥

**2. é”™è¯¯ç±»å‹ï¼ˆ`Result<T, E>`ï¼‰**
```hemlock
fn divide(a: i32, b: i32): Result<i32, string> {
    if (b == 0) {
        return Err("division by zero");
    }
    return Ok(a / b);
}
```
- æ˜¾å¼é”™è¯¯å¤„ç†
- å¼ºåˆ¶ç”¨æˆ·è€ƒè™‘é”™è¯¯
- å¼‚å¸¸çš„æ›¿ä»£æ–¹æ¡ˆ

**3. æ•°ç»„/åˆ‡ç‰‡ç±»å‹**
- å·²ç»æœ‰åŠ¨æ€æ•°ç»„
- å¯ä»¥æ·»åŠ å›ºå®šå¤§å°æ•°ç»„ç”¨äºæ ˆåˆ†é…
- éœ€è¦æ˜¾å¼è¯´æ˜æ ˆä¸å †

**4. æ”¹è¿›çš„å†…å­˜å®‰å…¨å·¥å…·**
- å¯é€‰çš„è¾¹ç•Œæ£€æŸ¥æ ‡å¿—
- è°ƒè¯•æ„å»ºä¸­çš„å†…å­˜æ³„æ¼æ£€æµ‹
- Sanitizer é›†æˆ

### å¯èƒ½æ°¸è¿œä¸ä¼šæ·»åŠ 

è¿™äº›ç‰¹æ€§è¿åæ ¸å¿ƒåŸåˆ™ï¼š

**1. åƒåœ¾å›æ”¶**
- éšè—å†…å­˜ç®¡ç†å¤æ‚æ€§
- ä¸å¯é¢„æµ‹çš„æ€§èƒ½
- è¿èƒŒæ˜¾å¼æ§åˆ¶åŸåˆ™

**2. è‡ªåŠ¨å†…å­˜ç®¡ç†**
- ä¸ GC ç›¸åŒçš„åŸå› 
- å¦‚æœæ˜¾å¼çš„è¯ï¼Œå¼•ç”¨è®¡æ•°å¯èƒ½å¯ä»¥

**3. ä¸¢å¤±æ•°æ®çš„éšå¼ç±»å‹è½¬æ¢**
- è¿èƒŒ"æ˜¾å¼ä¼˜äºéšå¼"
- å¾®å¦™é”™è¯¯çš„æ¥æº

**4. å®ï¼ˆå¤æ‚çš„ï¼‰**
- å¤ªå¤šèƒ½åŠ›ï¼Œå¤ªå¤šå¤æ‚æ€§
- ç®€å•çš„å®ç³»ç»Ÿå¯èƒ½å¯ä»¥
- ä¼˜å…ˆä½¿ç”¨ä»£ç ç”Ÿæˆæˆ–å‡½æ•°

**5. åŸºäºç±»çš„å¸¦ç»§æ‰¿çš„é¢å‘å¯¹è±¡ç¼–ç¨‹**
- å¤ªå¤šéšå¼è¡Œä¸º
- é¸­å­ç±»å‹å’Œå¯¹è±¡å°±è¶³å¤Ÿäº†
- ç»„åˆä¼˜äºç»§æ‰¿

**6. å…·æœ‰å¤æ‚è§£æçš„æ¨¡å—ç³»ç»Ÿ**
- ä¿æŒå¯¼å…¥ç®€å•å’Œæ˜¾å¼
- æ²¡æœ‰é­”æ³•æœç´¢è·¯å¾„
- æ²¡æœ‰ç‰ˆæœ¬è§£æï¼ˆä½¿ç”¨æ“ä½œç³»ç»ŸåŒ…ç®¡ç†å™¨ï¼‰

---

## ç»“è¯­

### ä¿¡ä»»ä¸è´£ä»»

Hemlock æ˜¯å…³äº**ä¿¡ä»»ä¸è´£ä»»**çš„ã€‚æˆ‘ä»¬ä¿¡ä»»ç¨‹åºå‘˜èƒ½å¤Ÿï¼š

- æ­£ç¡®ç®¡ç†å†…å­˜
- é€‚å½“ä½¿ç”¨ç±»å‹
- æ­£ç¡®å¤„ç†é”™è¯¯
- ç†è§£æƒè¡¡

ä½œä¸ºå›æŠ¥ï¼ŒHemlock æä¾›ï¼š

- æ— éšè—æˆæœ¬
- æ— æ„å¤–è¡Œä¸º
- éœ€è¦æ—¶çš„å®Œå…¨æ§åˆ¶
- éœ€è¦æ—¶çš„å®‰å…¨å·¥å…·

### æŒ‡å¯¼é—®é¢˜

**å½“è€ƒè™‘æ–°ç‰¹æ€§æ—¶ï¼Œé—®ï¼š**

> "è¿™æ˜¯ç»™ç¨‹åºå‘˜æ›´å¤šæ˜¾å¼æ§åˆ¶ï¼Œè¿˜æ˜¯éšè—äº†æŸäº›ä¸œè¥¿ï¼Ÿ"

- å¦‚æœå®ƒ**å¢åŠ æ˜¾å¼æ§åˆ¶** â†’ å¯èƒ½é€‚åˆ Hemlock
- å¦‚æœå®ƒ**éšè—å¤æ‚æ€§** â†’ å¯èƒ½ä¸å±äºè¿™é‡Œ
- å¦‚æœå®ƒæ˜¯**å¯é€‰çš„è¯­æ³•ç³–**ä¸”æœ‰æ¸…æ™°æ–‡æ¡£ â†’ å¯èƒ½å¯ä»¥

### å¥½çš„æ·»åŠ ç¤ºä¾‹

- **Switch è¯­å¥** - æ˜¾å¼æ§åˆ¶æµï¼Œæ²¡æœ‰é­”æ³•ï¼Œæ¸…æ™°çš„è¯­ä¹‰

- **å¸¦ pthreads çš„ Async/await** - æ˜¾å¼å¹¶å‘ï¼ŒçœŸæ­£çš„å¹¶è¡Œï¼Œç”¨æˆ·æ§åˆ¶ç”Ÿæˆ

- **Buffer ç±»å‹ä¸ ptr å¹¶å­˜** - åœ¨å®‰å…¨å’Œéå®‰å…¨ä¹‹é—´æä¾›é€‰æ‹©

- **å¯é€‰ç±»å‹æ³¨è§£** - å¸®åŠ©æ•è·é”™è¯¯è€Œä¸å¼ºåˆ¶ä¸¥æ ¼

- **Try/catch/finally** - å¸¦æ¸…æ™°æ§åˆ¶æµçš„æ˜¾å¼é”™è¯¯å¤„ç†

### ä¸å¥½çš„æ·»åŠ ç¤ºä¾‹

- **è‡ªåŠ¨åˆ†å·æ’å…¥** - éšè—è¯­æ³•é”™è¯¯ï¼Œä½¿ä»£ç æ¨¡ç³Š

- **RAII/ææ„å‡½æ•°** - è‡ªåŠ¨æ¸…ç†éšè—èµ„æºä½•æ—¶é‡Šæ”¾

- **éšå¼ç©ºå€¼åˆå¹¶** - éšè—ç©ºå€¼æ£€æŸ¥ï¼Œä½¿ä»£ç æ›´éš¾ç†è§£

- **è‡ªåŠ¨å¢é•¿çš„å­—ç¬¦ä¸²** - éšè—å†…å­˜åˆ†é…ï¼Œä¸å¯é¢„æµ‹çš„æ€§èƒ½

---

## æ€»ç»“

Hemlock ä¸æ˜¯è¯•å›¾æˆä¸ºæœ€å®‰å…¨çš„è¯­è¨€ã€æœ€å¿«çš„è¯­è¨€æˆ–åŠŸèƒ½æœ€ä¸°å¯Œçš„è¯­è¨€ã€‚

**Hemlock è¯•å›¾æˆä¸ºæœ€*è¯šå®*çš„è¯­è¨€ã€‚**

å®ƒç¡®åˆ‡åœ°å‘Šè¯‰ä½ å®ƒåœ¨åšä»€ä¹ˆï¼Œåœ¨ä½ éœ€è¦æ—¶ç»™ä½ æ§åˆ¶æƒï¼Œä¸éšè—é”‹åˆ©çš„è¾¹ç¼˜ã€‚å®ƒæ˜¯ä¸ºé‚£äº›æƒ³åœ¨åº•å±‚ç†è§£ä»£ç åŒæ—¶ä»äº«å—ç°ä»£æ˜“ç”¨æ€§çš„äººè®¾è®¡çš„è¯­è¨€ã€‚

å¦‚æœä½ ä¸ç¡®å®šæŸä¸ªç‰¹æ€§æ˜¯å¦å±äº Hemlockï¼Œè¯·è®°ä½ï¼š

> **æ°¸è¿œæ˜¾å¼ä¼˜äºéšå¼ã€‚**
> **éå®‰å…¨æ˜¯ç‰¹æ€§ï¼Œä¸æ˜¯ç¼ºé™·ã€‚**
> **ç”¨æˆ·è´Ÿè´£ï¼Œè¿™æ²¡é—®é¢˜ã€‚**



################################################################################
# è´¡çŒ®æŒ‡å—
################################################################################

--------------------------------------------------------------------------------
## æµ‹è¯•
--------------------------------------------------------------------------------

# Hemlock æµ‹è¯•æŒ‡å—

æœ¬æŒ‡å—è§£é‡Šäº† Hemlock çš„æµ‹è¯•ç†å¿µã€å¦‚ä½•ç¼–å†™æµ‹è¯•ä»¥åŠå¦‚ä½•è¿è¡Œæµ‹è¯•å¥—ä»¶ã€‚

---

## ç›®å½•

- [æµ‹è¯•ç†å¿µ](#æµ‹è¯•ç†å¿µ)
- [æµ‹è¯•å¥—ä»¶ç»“æ„](#æµ‹è¯•å¥—ä»¶ç»“æ„)
- [è¿è¡Œæµ‹è¯•](#è¿è¡Œæµ‹è¯•)
- [ç¼–å†™æµ‹è¯•](#ç¼–å†™æµ‹è¯•)
- [æµ‹è¯•ç±»åˆ«](#æµ‹è¯•ç±»åˆ«)
- [å†…å­˜æ³„æ¼æµ‹è¯•](#å†…å­˜æ³„æ¼æµ‹è¯•)
- [æŒç»­é›†æˆ](#æŒç»­é›†æˆ)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æµ‹è¯•ç†å¿µ

### æ ¸å¿ƒåŸåˆ™

**1. æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTDDï¼‰**

åœ¨å®ç°åŠŸèƒ½**ä¹‹å‰**ç¼–å†™æµ‹è¯•ï¼š

```
1. ç¼–å†™ä¸€ä¸ªå¤±è´¥çš„æµ‹è¯•
2. å®ç°åŠŸèƒ½
3. è¿è¡Œæµ‹è¯•ï¼ˆåº”è¯¥é€šè¿‡ï¼‰
4. å¦‚æœéœ€è¦ï¼Œè¿›è¡Œé‡æ„
5. é‡å¤
```

**å¥½å¤„ï¼š**
- ç¡®ä¿åŠŸèƒ½ç¡®å®æœ‰æ•ˆ
- é˜²æ­¢å›å½’
- è®°å½•é¢„æœŸè¡Œä¸º
- ä½¿é‡æ„æ›´å®‰å…¨

**2. å…¨é¢è¦†ç›–**

æµ‹è¯•æˆåŠŸå’Œå¤±è´¥æƒ…å†µï¼š

```hemlock
// æˆåŠŸæƒ…å†µ
let x: u8 = 255;  // åº”è¯¥æˆåŠŸ

// å¤±è´¥æƒ…å†µ
let y: u8 = 256;  // åº”è¯¥å‡ºé”™
```

**3. å°½æ—©ä¸”é¢‘ç¹åœ°æµ‹è¯•**

è¿è¡Œæµ‹è¯•ï¼š
- åœ¨æäº¤ä»£ç ä¹‹å‰
- åœ¨è¿›è¡Œæ›´æ”¹ä¹‹å
- åœ¨æäº¤ pull request ä¹‹å‰
- åœ¨ä»£ç å®¡æŸ¥æœŸé—´

**è§„åˆ™ï¼š** åˆå¹¶ä¹‹å‰æ‰€æœ‰æµ‹è¯•å¿…é¡»é€šè¿‡ã€‚

### æµ‹è¯•ä»€ä¹ˆ

**å§‹ç»ˆæµ‹è¯•ï¼š**
- åŸºæœ¬åŠŸèƒ½ï¼ˆæ­£å¸¸è·¯å¾„ï¼‰
- é”™è¯¯æ¡ä»¶ï¼ˆå¼‚å¸¸è·¯å¾„ï¼‰
- è¾¹ç•Œæƒ…å†µï¼ˆè¾¹ç•Œæ¡ä»¶ï¼‰
- ç±»å‹æ£€æŸ¥å’Œè½¬æ¢
- å†…å­˜ç®¡ç†ï¼ˆæ— æ³„æ¼ï¼‰
- å¹¶å‘å’Œç«æ€æ¡ä»¶

**ç¤ºä¾‹æµ‹è¯•è¦†ç›–ï¼š**
```hemlock
// åŠŸèƒ½ï¼šString.substr(start, length)

// æ­£å¸¸è·¯å¾„
print("hello".substr(0, 5));  // "hello"

// è¾¹ç•Œæƒ…å†µ
print("hello".substr(0, 0));  // ""ï¼ˆç©ºï¼‰
print("hello".substr(5, 0));  // ""ï¼ˆåœ¨æœ«å°¾ï¼‰
print("hello".substr(2, 100)); // "llo"ï¼ˆè¶…è¿‡æœ«å°¾ï¼‰

// é”™è¯¯æƒ…å†µ
// "hello".substr(-1, 5);  // é”™è¯¯ï¼šè´Ÿç´¢å¼•
// "hello".substr(0, -1);  // é”™è¯¯ï¼šè´Ÿé•¿åº¦
```

---

## æµ‹è¯•å¥—ä»¶ç»“æ„

### ç›®å½•ç»„ç»‡

```
tests/
â”œâ”€â”€ run_tests.sh          # ä¸»æµ‹è¯•è¿è¡Œè„šæœ¬
â”œâ”€â”€ primitives/           # ç±»å‹ç³»ç»Ÿæµ‹è¯•
â”‚   â”œâ”€â”€ integers.hml
â”‚   â”œâ”€â”€ floats.hml
â”‚   â”œâ”€â”€ booleans.hml
â”‚   â”œâ”€â”€ i64.hml
â”‚   â””â”€â”€ u64.hml
â”œâ”€â”€ conversions/          # ç±»å‹è½¬æ¢æµ‹è¯•
â”‚   â”œâ”€â”€ int_to_float.hml
â”‚   â”œâ”€â”€ promotion.hml
â”‚   â””â”€â”€ rune_conversions.hml
â”œâ”€â”€ memory/               # æŒ‡é’ˆ/ç¼“å†²åŒºæµ‹è¯•
â”‚   â”œâ”€â”€ alloc.hml
â”‚   â”œâ”€â”€ buffer.hml
â”‚   â””â”€â”€ memcpy.hml
â”œâ”€â”€ strings/              # å­—ç¬¦ä¸²æ“ä½œæµ‹è¯•
â”‚   â”œâ”€â”€ concat.hml
â”‚   â”œâ”€â”€ methods.hml
â”‚   â”œâ”€â”€ utf8.hml
â”‚   â””â”€â”€ runes.hml
â”œâ”€â”€ control/              # æ§åˆ¶æµæµ‹è¯•
â”‚   â”œâ”€â”€ if.hml
â”‚   â”œâ”€â”€ switch.hml
â”‚   â””â”€â”€ while.hml
â”œâ”€â”€ functions/            # å‡½æ•°å’Œé—­åŒ…æµ‹è¯•
â”‚   â”œâ”€â”€ basics.hml
â”‚   â”œâ”€â”€ closures.hml
â”‚   â””â”€â”€ recursion.hml
â”œâ”€â”€ objects/              # å¯¹è±¡æµ‹è¯•
â”‚   â”œâ”€â”€ literals.hml
â”‚   â”œâ”€â”€ methods.hml
â”‚   â”œâ”€â”€ duck_typing.hml
â”‚   â””â”€â”€ serialization.hml
â”œâ”€â”€ arrays/               # æ•°ç»„æ“ä½œæµ‹è¯•
â”‚   â”œâ”€â”€ basics.hml
â”‚   â”œâ”€â”€ methods.hml
â”‚   â””â”€â”€ slicing.hml
â”œâ”€â”€ loops/                # å¾ªç¯æµ‹è¯•
â”‚   â”œâ”€â”€ for.hml
â”‚   â”œâ”€â”€ while.hml
â”‚   â”œâ”€â”€ break.hml
â”‚   â””â”€â”€ continue.hml
â”œâ”€â”€ exceptions/           # é”™è¯¯å¤„ç†æµ‹è¯•
â”‚   â”œâ”€â”€ try_catch.hml
â”‚   â”œâ”€â”€ finally.hml
â”‚   â””â”€â”€ throw.hml
â”œâ”€â”€ io/                   # æ–‡ä»¶ I/O æµ‹è¯•
â”‚   â”œâ”€â”€ file_object.hml
â”‚   â”œâ”€â”€ read_write.hml
â”‚   â””â”€â”€ seek.hml
â”œâ”€â”€ async/                # å¹¶å‘æµ‹è¯•
â”‚   â”œâ”€â”€ spawn_join.hml
â”‚   â”œâ”€â”€ channels.hml
â”‚   â””â”€â”€ exceptions.hml
â”œâ”€â”€ ffi/                  # FFI æµ‹è¯•
â”‚   â”œâ”€â”€ basic_call.hml
â”‚   â”œâ”€â”€ types.hml
â”‚   â””â”€â”€ dlopen.hml
â”œâ”€â”€ signals/              # ä¿¡å·å¤„ç†æµ‹è¯•
â”‚   â”œâ”€â”€ basic.hml
â”‚   â”œâ”€â”€ handlers.hml
â”‚   â””â”€â”€ raise.hml
â””â”€â”€ args/                 # å‘½ä»¤è¡Œå‚æ•°æµ‹è¯•
    â””â”€â”€ basic.hml
```

### æµ‹è¯•æ–‡ä»¶å‘½å

**çº¦å®šï¼š**
- ä½¿ç”¨æè¿°æ€§åç§°ï¼š`method_chaining.hml` è€Œä¸æ˜¯ `test1.hml`
- åˆ†ç»„ç›¸å…³æµ‹è¯•ï¼š`string_substr.hml`ã€`string_slice.hml`
- æ¯ä¸ªæ–‡ä»¶ä¸€ä¸ªåŠŸèƒ½åŒºåŸŸ
- ä¿æŒæ–‡ä»¶ä¸“æ³¨ä¸”å°å·§

---

## è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
# ä» hemlock æ ¹ç›®å½•
make test

# æˆ–ç›´æ¥
./tests/run_tests.sh
```

**è¾“å‡ºï¼š**
```
Running tests in tests/primitives/...
  âœ“ integers.hml
  âœ“ floats.hml
  âœ“ booleans.hml

Running tests in tests/strings/...
  âœ“ concat.hml
  âœ“ methods.hml

...

Total: 251 tests
Passed: 251
Failed: 0
```

### è¿è¡Œç‰¹å®šç±»åˆ«

```bash
# åªè¿è¡Œå­—ç¬¦ä¸²æµ‹è¯•
./tests/run_tests.sh tests/strings/

# åªè¿è¡Œä¸€ä¸ªæµ‹è¯•æ–‡ä»¶
./tests/run_tests.sh tests/strings/concat.hml

# è¿è¡Œå¤šä¸ªç±»åˆ«
./tests/run_tests.sh tests/strings/ tests/arrays/
```

### ä½¿ç”¨ Valgrind è¿è¡Œï¼ˆå†…å­˜æ³„æ¼æ£€æŸ¥ï¼‰

```bash
# æ£€æŸ¥å•ä¸ªæµ‹è¯•çš„æ³„æ¼
valgrind --leak-check=full ./hemlock tests/memory/alloc.hml

# æ£€æŸ¥æ‰€æœ‰æµ‹è¯•ï¼ˆå¾ˆæ…¢ï¼ï¼‰
for test in tests/**/*.hml; do
    echo "Testing $test"
    valgrind --leak-check=full --error-exitcode=1 ./hemlock "$test"
done
```

### è°ƒè¯•å¤±è´¥çš„æµ‹è¯•

```bash
# ä½¿ç”¨è¯¦ç»†è¾“å‡ºè¿è¡Œ
./hemlock tests/failing_test.hml

# ä½¿ç”¨ gdb è¿è¡Œ
gdb --args ./hemlock tests/failing_test.hml
(gdb) run
(gdb) backtrace  # å¦‚æœå´©æºƒ
```

---

## ç¼–å†™æµ‹è¯•

### æµ‹è¯•æ–‡ä»¶æ ¼å¼

æµ‹è¯•æ–‡ä»¶åªæ˜¯å¸¦æœ‰é¢„æœŸè¾“å‡ºçš„ Hemlock ç¨‹åºï¼š

**ç¤ºä¾‹ï¼štests/primitives/integers.hml**
```hemlock
// æµ‹è¯•åŸºæœ¬æ•´æ•°å­—é¢é‡
let x = 42;
print(x);  // Expect: 42

let y: i32 = 100;
print(y);  // Expect: 100

// æµ‹è¯•ç®—æœ¯
let sum = x + y;
print(sum);  // Expect: 142

// æµ‹è¯•ç±»å‹æ¨æ–­
let small = 10;
print(typeof(small));  // Expect: i32

let large = 5000000000;
print(typeof(large));  // Expect: i64
```

**æµ‹è¯•å¦‚ä½•å·¥ä½œï¼š**
1. æµ‹è¯•è¿è¡Œå™¨æ‰§è¡Œ .hml æ–‡ä»¶
2. æ•è· stdout è¾“å‡º
3. ä¸é¢„æœŸè¾“å‡ºæ¯”è¾ƒï¼ˆä»æ³¨é‡Šæˆ–å•ç‹¬çš„ .out æ–‡ä»¶ï¼‰
4. æŠ¥å‘Šé€šè¿‡/å¤±è´¥

### é¢„æœŸè¾“å‡ºæ–¹æ³•

**æ–¹æ³• 1ï¼šå†…è”æ³¨é‡Šï¼ˆæ¨èç”¨äºç®€å•æµ‹è¯•ï¼‰**

```hemlock
print("hello");  // Expect: hello
print(42);       // Expect: 42
```

æµ‹è¯•è¿è¡Œå™¨è§£æ `// Expect: ...` æ³¨é‡Šã€‚

**æ–¹æ³• 2ï¼šå•ç‹¬çš„ .out æ–‡ä»¶**

åˆ›å»º `test_name.hml.out` åŒ…å«é¢„æœŸè¾“å‡ºï¼š

**test_name.hmlï¼š**
```hemlock
print("line 1");
print("line 2");
print("line 3");
```

**test_name.hml.outï¼š**
```
line 1
line 2
line 3
```

### æµ‹è¯•é”™è¯¯æƒ…å†µ

é”™è¯¯æµ‹è¯•åº”è¯¥å¯¼è‡´ç¨‹åºä»¥éé›¶çŠ¶æ€é€€å‡ºï¼š

**ç¤ºä¾‹ï¼štests/primitives/range_error.hml**
```hemlock
// è¿™åº”è¯¥å› ç±»å‹é”™è¯¯è€Œå¤±è´¥
let x: u8 = 256;  // è¶…å‡º u8 èŒƒå›´
```

**é¢„æœŸè¡Œä¸ºï¼š**
- ç¨‹åºä»¥éé›¶çŠ¶æ€é€€å‡º
- å‘ stderr æ‰“å°é”™è¯¯æ¶ˆæ¯

**æµ‹è¯•è¿è¡Œå™¨å¤„ç†ï¼š**
- æœŸæœ›å‡ºé”™çš„æµ‹è¯•åº”è¯¥åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­
- ä½¿ç”¨å‘½åçº¦å®šï¼š`*_error.hml` æˆ– `*_fail.hml`
- åœ¨æ³¨é‡Šä¸­è®°å½•é¢„æœŸé”™è¯¯

### æµ‹è¯•æˆåŠŸæƒ…å†µ

**ç¤ºä¾‹ï¼štests/strings/methods.hml**
```hemlock
// æµ‹è¯• substr
let s = "hello world";
let sub = s.substr(6, 5);
print(sub);  // Expect: world

// æµ‹è¯• find
let pos = s.find("world");
print(pos);  // Expect: 6

// æµ‹è¯• contains
let has = s.contains("lo");
print(has);  // Expect: true

// æµ‹è¯• trim
let padded = "  hello  ";
let trimmed = padded.trim();
print(trimmed);  // Expect: hello
```

### æµ‹è¯•è¾¹ç•Œæƒ…å†µ

**ç¤ºä¾‹ï¼štests/arrays/edge_cases.hml**
```hemlock
// ç©ºæ•°ç»„
let empty = [];
print(empty.length);  // Expect: 0

// å•ä¸ªå…ƒç´ 
let single = [42];
print(single[0]);  // Expect: 42

// è´Ÿç´¢å¼•ï¼ˆåº”è¯¥åœ¨å•ç‹¬çš„æµ‹è¯•æ–‡ä»¶ä¸­å‡ºé”™ï¼‰
// print(single[-1]);  // é”™è¯¯

// è¶…å‡ºæœ«å°¾ç´¢å¼•ï¼ˆåº”è¯¥å‡ºé”™ï¼‰
// print(single[100]);  // é”™è¯¯

// è¾¹ç•Œæ¡ä»¶
let arr = [1, 2, 3];
print(arr.slice(0, 0));  // Expect: []ï¼ˆç©ºï¼‰
print(arr.slice(3, 3));  // Expect: []ï¼ˆç©ºï¼‰
print(arr.slice(1, 2));  // Expect: [2]
```

### æµ‹è¯•ç±»å‹ç³»ç»Ÿ

**ç¤ºä¾‹ï¼štests/conversions/promotion.hml**
```hemlock
// æµ‹è¯•äºŒå…ƒè¿ç®—ä¸­çš„ç±»å‹æå‡

// i32 + i64 -> i64
let a: i32 = 10;
let b: i64 = 20;
let c = a + b;
print(typeof(c));  // Expect: i64

// i32 + f32 -> f32
let d: i32 = 10;
let e: f32 = 3.14;
let f = d + e;
print(typeof(f));  // Expect: f32

// u8 + i32 -> i32
let g: u8 = 5;
let h: i32 = 10;
let i = g + h;
print(typeof(i));  // Expect: i32
```

### æµ‹è¯•å¹¶å‘

**ç¤ºä¾‹ï¼štests/async/basic.hml**
```hemlock
async fn compute(n: i32): i32 {
    let sum = 0;
    let i = 0;
    while (i < n) {
        sum = sum + i;
        i = i + 1;
    }
    return sum;
}

// ç”Ÿæˆä»»åŠ¡
let t1 = spawn(compute, 10);
let t2 = spawn(compute, 20);

// ç­‰å¾…å¹¶æ‰“å°ç»“æœ
let r1 = join(t1);
let r2 = join(t2);
print(r1);  // Expect: 45
print(r2);  // Expect: 190
```

### æµ‹è¯•å¼‚å¸¸

**ç¤ºä¾‹ï¼štests/exceptions/try_catch.hml**
```hemlock
// æµ‹è¯•åŸºæœ¬ try/catch
try {
    throw "error message";
} catch (e) {
    print("Caught: " + e);  // Expect: Caught: error message
}

// æµ‹è¯• finally
let executed = false;
try {
    print("try");  // Expect: try
} finally {
    executed = true;
    print("finally");  // Expect: finally
}

// æµ‹è¯•å¼‚å¸¸ä¼ æ’­
fn risky(): i32 {
    throw "failure";
}

try {
    risky();
} catch (e) {
    print(e);  // Expect: failure
}
```

---

## æµ‹è¯•ç±»åˆ«

### åŸå§‹ç±»å‹æµ‹è¯•

**æµ‹è¯•ä»€ä¹ˆï¼š**
- æ•´æ•°ç±»å‹ï¼ˆi8ã€i16ã€i32ã€i64ã€u8ã€u16ã€u32ã€u64ï¼‰
- æµ®ç‚¹ç±»å‹ï¼ˆf32ã€f64ï¼‰
- å¸ƒå°”ç±»å‹
- å­—ç¬¦ä¸²ç±»å‹
- Rune ç±»å‹
- Null ç±»å‹

**ç¤ºä¾‹é¢†åŸŸï¼š**
- å­—é¢é‡è¯­æ³•
- ç±»å‹æ¨æ–­
- èŒƒå›´æ£€æŸ¥
- æº¢å‡ºè¡Œä¸º
- ç±»å‹æ³¨è§£

### è½¬æ¢æµ‹è¯•

**æµ‹è¯•ä»€ä¹ˆï¼š**
- éšå¼ç±»å‹æå‡
- æ˜¾å¼ç±»å‹è½¬æ¢
- æœ‰æŸè½¬æ¢ï¼ˆåº”è¯¥å‡ºé”™ï¼‰
- è¿ç®—ä¸­çš„ç±»å‹æå‡
- è·¨ç±»å‹æ¯”è¾ƒ

### å†…å­˜æµ‹è¯•

**æµ‹è¯•ä»€ä¹ˆï¼š**
- alloc/free æ­£ç¡®æ€§
- Buffer åˆ›å»ºå’Œè®¿é—®
- ç¼“å†²åŒºè¾¹ç•Œæ£€æŸ¥
- memsetã€memcpyã€realloc
- å†…å­˜æ³„æ¼æ£€æµ‹ï¼ˆvalgrindï¼‰

### å­—ç¬¦ä¸²æµ‹è¯•

**æµ‹è¯•ä»€ä¹ˆï¼š**
- è¿æ¥
- æ‰€æœ‰ 18 ä¸ªå­—ç¬¦ä¸²æ–¹æ³•
- UTF-8 å¤„ç†
- Rune ç´¢å¼•
- å­—ç¬¦ä¸² + rune è¿æ¥
- è¾¹ç•Œæƒ…å†µï¼ˆç©ºå­—ç¬¦ä¸²ã€å•å­—ç¬¦ç­‰ï¼‰

### æ§åˆ¶æµæµ‹è¯•

**æµ‹è¯•ä»€ä¹ˆï¼š**
- if/else/else if
- while å¾ªç¯
- for å¾ªç¯
- switch è¯­å¥
- break/continue
- return è¯­å¥

### å‡½æ•°æµ‹è¯•

**æµ‹è¯•ä»€ä¹ˆï¼š**
- å‡½æ•°å®šä¹‰å’Œè°ƒç”¨
- å‚æ•°ä¼ é€’
- è¿”å›å€¼
- é€’å½’
- é—­åŒ…å’Œæ•è·
- ä¸€ç­‰å‡½æ•°
- åŒ¿åå‡½æ•°

### å¯¹è±¡æµ‹è¯•

**æµ‹è¯•ä»€ä¹ˆï¼š**
- å¯¹è±¡å­—é¢é‡
- å­—æ®µè®¿é—®å’Œèµ‹å€¼
- æ–¹æ³•å’Œ self ç»‘å®š
- é¸­å­ç±»å‹
- å¯é€‰å­—æ®µ
- JSON åºåˆ—åŒ–/ååºåˆ—åŒ–
- å¾ªç¯å¼•ç”¨æ£€æµ‹

### æ•°ç»„æµ‹è¯•

**æµ‹è¯•ä»€ä¹ˆï¼š**
- æ•°ç»„åˆ›å»º
- ç´¢å¼•å’Œèµ‹å€¼
- æ‰€æœ‰ 15 ä¸ªæ•°ç»„æ–¹æ³•
- æ··åˆç±»å‹
- åŠ¨æ€è°ƒæ•´å¤§å°
- è¾¹ç•Œæƒ…å†µï¼ˆç©ºã€å•ä¸ªå…ƒç´ ï¼‰

### å¼‚å¸¸æµ‹è¯•

**æµ‹è¯•ä»€ä¹ˆï¼š**
- try/catch/finally
- throw è¯­å¥
- å¼‚å¸¸ä¼ æ’­
- åµŒå¥— try/catch
- try/catch/finally ä¸­çš„ return
- æœªæ•è·çš„å¼‚å¸¸

### I/O æµ‹è¯•

**æµ‹è¯•ä»€ä¹ˆï¼š**
- æ–‡ä»¶æ‰“å¼€æ¨¡å¼
- è¯»/å†™æ“ä½œ
- Seek/tell
- æ–‡ä»¶å±æ€§
- é”™è¯¯å¤„ç†ï¼ˆç¼ºå°‘æ–‡ä»¶ç­‰ï¼‰
- èµ„æºæ¸…ç†

### å¼‚æ­¥æµ‹è¯•

**æµ‹è¯•ä»€ä¹ˆï¼š**
- spawn/join/detach
- Channel send/recv
- ä»»åŠ¡ä¸­çš„å¼‚å¸¸ä¼ æ’­
- å¤šä¸ªå¹¶å‘ä»»åŠ¡
- Channel é˜»å¡è¡Œä¸º

### FFI æµ‹è¯•

**æµ‹è¯•ä»€ä¹ˆï¼š**
- dlopen/dlclose
- dlsym
- å„ç§ç±»å‹çš„ dlcall
- ç±»å‹è½¬æ¢
- é”™è¯¯å¤„ç†

---

## å†…å­˜æ³„æ¼æµ‹è¯•

### ä½¿ç”¨ Valgrind

**åŸºæœ¬ç”¨æ³•ï¼š**
```bash
valgrind --leak-check=full ./hemlock test.hml
```

**ç¤ºä¾‹è¾“å‡ºï¼ˆæ— æ³„æ¼ï¼‰ï¼š**
```
==12345== HEAP SUMMARY:
==12345==     in use at exit: 0 bytes in 0 blocks
==12345==   total heap usage: 10 allocs, 10 frees, 1,024 bytes allocated
==12345==
==12345== All heap blocks were freed -- no leaks are possible
```

**ç¤ºä¾‹è¾“å‡ºï¼ˆæœ‰æ³„æ¼ï¼‰ï¼š**
```
==12345== LEAK SUMMARY:
==12345==    definitely lost: 64 bytes in 1 blocks
==12345==    indirectly lost: 0 bytes in 0 blocks
==12345==      possibly lost: 0 bytes in 0 blocks
==12345==    still reachable: 0 bytes in 0 blocks
==12345==         suppressed: 0 bytes in 0 blocks
```

### å¸¸è§æ³„æ¼æ¥æº

**1. ç¼ºå°‘ free() è°ƒç”¨ï¼š**
```c
// å·®
char *str = malloc(100);
// ... ä½¿ç”¨ str
// å¿˜è®°é‡Šæ”¾ï¼

// å¥½
char *str = malloc(100);
// ... ä½¿ç”¨ str
free(str);
```

**2. ä¸¢å¤±çš„æŒ‡é’ˆï¼š**
```c
// å·®
char *ptr = malloc(100);
ptr = malloc(200);  // ä¸¢å¤±äº†å¯¹ç¬¬ä¸€æ¬¡åˆ†é…çš„å¼•ç”¨ï¼

// å¥½
char *ptr = malloc(100);
free(ptr);
ptr = malloc(200);
```

**3. å¼‚å¸¸è·¯å¾„ï¼š**
```c
// å·®
void func() {
    char *data = malloc(100);
    if (error_condition) {
        return;  // æ³„æ¼ï¼
    }
    free(data);
}

// å¥½
void func() {
    char *data = malloc(100);
    if (error_condition) {
        free(data);
        return;
    }
    free(data);
}
```

### å·²çŸ¥å¯æ¥å—çš„æ³„æ¼

ä¸€äº›å°çš„"æ³„æ¼"æ˜¯æœ‰æ„çš„å¯åŠ¨åˆ†é…ï¼š

**å…¨å±€å†…ç½®ï¼š**
```hemlock
// å†…ç½®å‡½æ•°ã€FFI ç±»å‹å’Œå¸¸é‡åœ¨å¯åŠ¨æ—¶åˆ†é…
// å¹¶ä¸”åœ¨é€€å‡ºæ—¶ä¸é‡Šæ”¾ï¼ˆé€šå¸¸çº¦ 200 å­—èŠ‚ï¼‰
```

è¿™äº›ä¸æ˜¯çœŸæ­£çš„æ³„æ¼ - å®ƒä»¬æ˜¯ä¸€æ¬¡æ€§åˆ†é…ï¼Œåœ¨ç¨‹åºç”Ÿå‘½å‘¨æœŸå†…æŒç»­å­˜åœ¨ï¼Œå¹¶åœ¨é€€å‡ºæ—¶ç”±æ“ä½œç³»ç»Ÿæ¸…ç†ã€‚

---

## æŒç»­é›†æˆ

### GitHub Actionsï¼ˆæœªæ¥ï¼‰

ä¸€æ—¦è®¾ç½®äº† CIï¼Œæ‰€æœ‰æµ‹è¯•å°†è‡ªåŠ¨è¿è¡Œï¼š
- æ¨é€åˆ° main åˆ†æ”¯
- Pull request åˆ›å»º/æ›´æ–°
- æ¯æ—¥å®šæ—¶è¿è¡Œ

**CI å·¥ä½œæµç¨‹ï¼š**
1. æ„å»º Hemlock
2. è¿è¡Œæµ‹è¯•å¥—ä»¶
3. æ£€æŸ¥å†…å­˜æ³„æ¼ï¼ˆvalgrindï¼‰
4. åœ¨ PR ä¸ŠæŠ¥å‘Šç»“æœ

### æäº¤å‰æ£€æŸ¥

åœ¨æäº¤ä¹‹å‰ï¼Œè¿è¡Œï¼š

```bash
# å…¨æ–°æ„å»º
make clean && make

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test

# æ£€æŸ¥ä¸€äº›æµ‹è¯•çš„æ³„æ¼
valgrind --leak-check=full ./hemlock tests/memory/alloc.hml
valgrind --leak-check=full ./hemlock tests/strings/concat.hml
```

---

## æœ€ä½³å®è·µ

### åº”è¯¥åšçš„

**å…ˆç¼–å†™æµ‹è¯•ï¼ˆTDDï¼‰**
```bash
1. åˆ›å»º tests/feature/new_feature.hml
2. åœ¨ src/ ä¸­å®ç°åŠŸèƒ½
3. è¿è¡Œæµ‹è¯•ç›´åˆ°é€šè¿‡
```

**æµ‹è¯•æˆåŠŸå’Œå¤±è´¥ä¸¤ç§æƒ…å†µ**
```hemlock
// æˆåŠŸï¼štests/feature/success.hml
let result = do_thing();
print(result);  // Expect: expected value

// å¤±è´¥ï¼štests/feature/failure.hml
do_invalid_thing();  // åº”è¯¥å‡ºé”™
```

**ä½¿ç”¨æè¿°æ€§æµ‹è¯•åç§°**
```
å¥½ï¼štests/strings/substr_utf8_boundary.hml
å·®ï¼štests/test1.hml
```

**ä¿æŒæµ‹è¯•ä¸“æ³¨**
- æ¯ä¸ªæ–‡ä»¶ä¸€ä¸ªåŠŸèƒ½åŒºåŸŸ
- æ¸…æ™°çš„è®¾ç½®å’Œæ–­è¨€
- æœ€å°‘çš„ä»£ç 

**æ·»åŠ è§£é‡Šæ£˜æ‰‹æµ‹è¯•çš„æ³¨é‡Š**
```hemlock
// æµ‹è¯•é—­åŒ…é€šè¿‡å¼•ç”¨æ•è·å¤–éƒ¨å˜é‡
fn outer() {
    let x = 10;
    let f = fn() { return x; };
    x = 20;  // åœ¨é—­åŒ…åˆ›å»ºåä¿®æ”¹
    return f();  // åº”è¯¥è¿”å› 20ï¼Œè€Œä¸æ˜¯ 10
}
```

**æµ‹è¯•è¾¹ç•Œæƒ…å†µ**
- ç©ºè¾“å…¥
- Null å€¼
- è¾¹ç•Œå€¼ï¼ˆæœ€å°/æœ€å¤§ï¼‰
- å¤§è¾“å…¥
- è´Ÿå€¼

### ä¸åº”è¯¥åšçš„

**ä¸è¦è·³è¿‡æµ‹è¯•**
- åˆå¹¶å‰æ‰€æœ‰æµ‹è¯•å¿…é¡»é€šè¿‡
- ä¸è¦æ³¨é‡Šæ‰å¤±è´¥çš„æµ‹è¯•
- ä¿®å¤é”™è¯¯æˆ–åˆ é™¤åŠŸèƒ½

**ä¸è¦ç¼–å†™ç›¸äº’ä¾èµ–çš„æµ‹è¯•**
```hemlock
// å·®ï¼štest2.hml ä¾èµ–äº test1.hml çš„è¾“å‡º
// æµ‹è¯•åº”è¯¥æ˜¯ç‹¬ç«‹çš„
```

**ä¸è¦åœ¨æµ‹è¯•ä¸­ä½¿ç”¨éšæœºå€¼**
```hemlock
// å·®ï¼šä¸ç¡®å®šæ€§
let x = random();
print(x);  // æ— æ³•é¢„æµ‹è¾“å‡º

// å¥½ï¼šç¡®å®šæ€§
let x = 42;
print(x);  // Expect: 42
```

**ä¸è¦æµ‹è¯•å®ç°ç»†èŠ‚**
```hemlock
// å·®ï¼šæµ‹è¯•å†…éƒ¨ç»“æ„
let obj = { x: 10 };
// ä¸è¦æ£€æŸ¥å†…éƒ¨å­—æ®µé¡ºåºã€å®¹é‡ç­‰

// å¥½ï¼šæµ‹è¯•è¡Œä¸º
print(obj.x);  // Expect: 10
```

**ä¸è¦å¿½ç•¥å†…å­˜æ³„æ¼**
- æ‰€æœ‰æµ‹è¯•åº”è¯¥æ˜¯ valgrind æ¸…æ´çš„
- è®°å½•å·²çŸ¥/å¯æ¥å—çš„æ³„æ¼
- åœ¨åˆå¹¶å‰ä¿®å¤æ³„æ¼

### æµ‹è¯•ç»´æŠ¤

**ä½•æ—¶æ›´æ–°æµ‹è¯•ï¼š**
- åŠŸèƒ½è¡Œä¸ºæ›´æ”¹
- é”™è¯¯ä¿®å¤éœ€è¦æ–°çš„æµ‹è¯•ç”¨ä¾‹
- å‘ç°è¾¹ç•Œæƒ…å†µ
- æ€§èƒ½æ”¹è¿›

**ä½•æ—¶åˆ é™¤æµ‹è¯•ï¼š**
- åŠŸèƒ½ä»è¯­è¨€ä¸­åˆ é™¤
- æµ‹è¯•é‡å¤äº†ç°æœ‰è¦†ç›–
- æµ‹è¯•æ˜¯é”™è¯¯çš„

**é‡æ„æµ‹è¯•ï¼š**
- å°†ç›¸å…³æµ‹è¯•åˆ†ç»„åœ¨ä¸€èµ·
- æå–å…¬å…±è®¾ç½®ä»£ç 
- ä½¿ç”¨ä¸€è‡´çš„å‘½å
- ä¿æŒæµ‹è¯•ç®€å•å’Œå¯è¯»

---

## ç¤ºä¾‹æµ‹è¯•ä¼šè¯

è¿™æ˜¯æ·»åŠ å¸¦æœ‰æµ‹è¯•çš„åŠŸèƒ½çš„å®Œæ•´ç¤ºä¾‹ï¼š

### åŠŸèƒ½ï¼šæ·»åŠ  `array.first()` æ–¹æ³•

**1. å…ˆç¼–å†™æµ‹è¯•ï¼š**

```bash
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶
cat > tests/arrays/first_method.hml << 'EOF'
// æµ‹è¯• array.first() æ–¹æ³•

// åŸºæœ¬æƒ…å†µ
let arr = [1, 2, 3];
print(arr.first());  // Expect: 1

// å•ä¸ªå…ƒç´ 
let single = [42];
print(single.first());  // Expect: 42

// ç©ºæ•°ç»„ï¼ˆåº”è¯¥å‡ºé”™ - å•ç‹¬çš„æµ‹è¯•æ–‡ä»¶ï¼‰
// let empty = [];
// print(empty.first());  // é”™è¯¯
EOF
```

**2. è¿è¡Œæµ‹è¯•ï¼ˆåº”è¯¥å¤±è´¥ï¼‰ï¼š**

```bash
./hemlock tests/arrays/first_method.hml
# Error: Method 'first' not found on array
```

**3. å®ç°åŠŸèƒ½ï¼š**

ç¼–è¾‘ `src/interpreter/builtins.c`ï¼š

```c
// æ·»åŠ  array_first æ–¹æ³•
Value *array_first(Value *self, Value **args, int arg_count)
{
    if (self->array_value->length == 0) {
        fprintf(stderr, "Error: Cannot get first element of empty array\n");
        exit(1);
    }

    return value_copy(&self->array_value->elements[0]);
}

// åœ¨æ•°ç»„æ–¹æ³•è¡¨ä¸­æ³¨å†Œ
// ... æ·»åŠ åˆ°æ•°ç»„æ–¹æ³•æ³¨å†Œ
```

**4. è¿è¡Œæµ‹è¯•ï¼ˆåº”è¯¥é€šè¿‡ï¼‰ï¼š**

```bash
./hemlock tests/arrays/first_method.hml
1
42
# æˆåŠŸï¼
```

**5. æ£€æŸ¥å†…å­˜æ³„æ¼ï¼š**

```bash
valgrind --leak-check=full ./hemlock tests/arrays/first_method.hml
# All heap blocks were freed -- no leaks are possible
```

**6. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ï¼š**

```bash
make test
# Total: 252 testsï¼ˆ251 + æ–°çš„ï¼‰
# Passed: 252
# Failed: 0
```

**7. æäº¤ï¼š**

```bash
git add tests/arrays/first_method.hml src/interpreter/builtins.c
git commit -m "Add array.first() method with tests"
```

---

## æ€»ç»“

**è®°ä½ï¼š**
- å…ˆç¼–å†™æµ‹è¯•ï¼ˆTDDï¼‰
- æµ‹è¯•æˆåŠŸå’Œå¤±è´¥æƒ…å†µ
- åœ¨æäº¤å‰è¿è¡Œæ‰€æœ‰æµ‹è¯•
- æ£€æŸ¥å†…å­˜æ³„æ¼
- è®°å½•å·²çŸ¥é—®é¢˜
- ä¿æŒæµ‹è¯•ç®€å•å’Œä¸“æ³¨

**æµ‹è¯•è´¨é‡ä¸ä»£ç è´¨é‡åŒæ ·é‡è¦ï¼**


--------------------------------------------------------------------------------
## è´¡çŒ®æŒ‡å—
--------------------------------------------------------------------------------

# Hemlock è´¡çŒ®æŒ‡å—

æ„Ÿè°¢æ‚¨æœ‰å…´è¶£ä¸º Hemlock åšè´¡çŒ®ï¼æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨äº†è§£å¦‚ä½•æœ‰æ•ˆåœ°è´¡çŒ®ä»£ç ï¼ŒåŒæ—¶ä¿æŒè¯­è¨€çš„è®¾è®¡ç†å¿µå’Œä»£ç è´¨é‡ã€‚

---

## ç›®å½•

- [å¼€å§‹ä¹‹å‰](#å¼€å§‹ä¹‹å‰)
- [è´¡çŒ®å·¥ä½œæµç¨‹](#è´¡çŒ®å·¥ä½œæµç¨‹)
- [ä»£ç é£æ ¼æŒ‡å—](#ä»£ç é£æ ¼æŒ‡å—)
- [åº”è¯¥è´¡çŒ®ä»€ä¹ˆ](#åº”è¯¥è´¡çŒ®ä»€ä¹ˆ)
- [ä¸åº”è¯¥è´¡çŒ®ä»€ä¹ˆ](#ä¸åº”è¯¥è´¡çŒ®ä»€ä¹ˆ)
- [å¸¸è§æ¨¡å¼](#å¸¸è§æ¨¡å¼)
- [æ·»åŠ æ–°åŠŸèƒ½](#æ·»åŠ æ–°åŠŸèƒ½)
- [ä»£ç å®¡æŸ¥æµç¨‹](#ä»£ç å®¡æŸ¥æµç¨‹)

---

## å¼€å§‹ä¹‹å‰

### å¿…è¯»æ–‡æ¡£

åœ¨è´¡çŒ®ä¹‹å‰ï¼Œè¯·æŒ‰é¡ºåºé˜…è¯»ä»¥ä¸‹æ–‡æ¡£ï¼š

1. **`/home/user/hemlock/docs/design/philosophy.md`** - äº†è§£ Hemlock çš„æ ¸å¿ƒåŸåˆ™
2. **`/home/user/hemlock/docs/design/implementation.md`** - å­¦ä¹ ä»£ç åº“ç»“æ„
3. **`/home/user/hemlock/docs/contributing/testing.md`** - äº†è§£æµ‹è¯•è¦æ±‚
4. **æœ¬æ–‡æ¡£** - å­¦ä¹ è´¡çŒ®æŒ‡å—

### å‰ç½®æ¡ä»¶

**æ‰€éœ€çŸ¥è¯†ï¼š**
- C ç¼–ç¨‹ï¼ˆæŒ‡é’ˆã€å†…å­˜ç®¡ç†ã€ç»“æ„ä½“ï¼‰
- ç¼–è¯‘å™¨/è§£é‡Šå™¨åŸºç¡€ï¼ˆè¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€ASTï¼‰
- Git å’Œ GitHub å·¥ä½œæµç¨‹
- Unix/Linux å‘½ä»¤è¡Œ

**æ‰€éœ€å·¥å…·ï¼š**
- GCC æˆ– Clang ç¼–è¯‘å™¨
- Make æ„å»ºç³»ç»Ÿ
- Git ç‰ˆæœ¬æ§åˆ¶
- Valgrindï¼ˆç”¨äºå†…å­˜æ³„æ¼æ£€æµ‹ï¼‰
- åŸºæœ¬çš„æ–‡æœ¬ç¼–è¾‘å™¨æˆ– IDE

### æ²Ÿé€šæ¸ é“

**åœ¨å“ªé‡Œæé—®ï¼š**
- GitHub Issues - é”™è¯¯æŠ¥å‘Šå’ŒåŠŸèƒ½è¯·æ±‚
- GitHub Discussions - ä¸€èˆ¬é—®é¢˜å’Œè®¾è®¡è®¨è®º
- Pull Request è¯„è®º - ç‰¹å®šä»£ç åé¦ˆ

---

## è´¡çŒ®å·¥ä½œæµç¨‹

### 1. æŸ¥æ‰¾æˆ–åˆ›å»º Issue

**åœ¨ç¼–å†™ä»£ç ä¹‹å‰ï¼š**
- æ£€æŸ¥æ‚¨çš„è´¡çŒ®æ˜¯å¦å·²æœ‰ç›¸å…³ issue
- å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ªæè¿°æ‚¨æƒ³åšä»€ä¹ˆçš„ issue
- åœ¨å¼€å§‹å¤§å‹æ›´æ”¹ä¹‹å‰ç­‰å¾…ç»´æŠ¤è€…åé¦ˆ
- å°çš„é”™è¯¯ä¿®å¤å¯ä»¥è·³è¿‡æ­¤æ­¥éª¤

**è‰¯å¥½çš„ issue æè¿°åŒ…æ‹¬ï¼š**
- é—®é¢˜é™ˆè¿°ï¼ˆä»€ä¹ˆæŸåæˆ–ç¼ºå¤±ï¼‰
- å»ºè®®çš„è§£å†³æ–¹æ¡ˆï¼ˆæ‚¨è®¡åˆ’å¦‚ä½•ä¿®å¤ï¼‰
- ç¤ºä¾‹ï¼ˆå±•ç¤ºé—®é¢˜çš„ä»£ç ç‰‡æ®µï¼‰
- ç†ç”±ï¼ˆä¸ºä»€ä¹ˆæ­¤æ›´æ”¹ç¬¦åˆ Hemlock çš„ç†å¿µï¼‰

### 2. Fork å’Œ Clone

```bash
# é¦–å…ˆåœ¨ GitHub ä¸Š fork ä»“åº“ï¼Œç„¶åï¼š
git clone https://github.com/YOUR_USERNAME/hemlock.git
cd hemlock
git checkout -b feature/your-feature-name
```

### 3. è¿›è¡Œæ›´æ”¹

éµå¾ªä»¥ä¸‹æŒ‡å—ï¼š
- å…ˆç¼–å†™æµ‹è¯•ï¼ˆTDD æ–¹æ³•ï¼‰
- å®ç°åŠŸèƒ½
- ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
- æ£€æŸ¥å†…å­˜æ³„æ¼
- æ›´æ–°æ–‡æ¡£

### 4. æµ‹è¯•æ‚¨çš„æ›´æ”¹

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
make test

# è¿è¡Œç‰¹å®šæµ‹è¯•ç±»åˆ«
./tests/run_tests.sh tests/category/

# æ£€æŸ¥å†…å­˜æ³„æ¼
valgrind ./hemlock tests/your_test.hml

# æ„å»ºå¹¶æµ‹è¯•
make clean && make && make test
```

### 5. æäº¤æ‚¨çš„æ›´æ”¹

**è‰¯å¥½çš„æäº¤æ¶ˆæ¯ï¼š**
```
Add bitwise operators for integer types

- Implement &, |, ^, <<, >>, ~ operators
- Add type checking to ensure integer-only operations
- Update operator precedence table
- Add comprehensive tests for all operators

Closes #42
```

**æäº¤æ¶ˆæ¯æ ¼å¼ï¼š**
- ç¬¬ä¸€è¡Œï¼šç®€çŸ­æ‘˜è¦ï¼ˆæœ€å¤š 50 ä¸ªå­—ç¬¦ï¼‰
- ç©ºè¡Œ
- è¯¦ç»†è¯´æ˜ï¼ˆæ¯è¡Œ 72 ä¸ªå­—ç¬¦æ¢è¡Œï¼‰
- å¼•ç”¨ issue ç¼–å·

### 6. æäº¤ Pull Request

**æäº¤ä¹‹å‰ï¼š**
- åœ¨æœ€æ–°çš„ main åˆ†æ”¯ä¸Š rebase
- ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
- è¿è¡Œ valgrind æ£€æŸ¥æ³„æ¼
- å¦‚æœæ·»åŠ é¢å‘ç”¨æˆ·çš„åŠŸèƒ½ï¼Œæ›´æ–° CLAUDE.md

**Pull request æè¿°åº”åŒ…æ‹¬ï¼š**
- è¿™è§£å†³äº†ä»€ä¹ˆé—®é¢˜
- å¦‚ä½•è§£å†³çš„
- ç ´åæ€§æ›´æ”¹ï¼ˆå¦‚æœæœ‰ï¼‰
- æ–°è¯­æ³•æˆ–è¡Œä¸ºçš„ç¤ºä¾‹
- æµ‹è¯•è¦†ç›–æ‘˜è¦

---

## ä»£ç é£æ ¼æŒ‡å—

### C ä»£ç é£æ ¼

**æ ¼å¼åŒ–ï¼š**
```c
// ä½¿ç”¨ 4 ä¸ªç©ºæ ¼ç¼©è¿›ï¼ˆä¸ä½¿ç”¨åˆ¶è¡¨ç¬¦ï¼‰
// å‡½æ•°ä½¿ç”¨ K&R å¤§æ‹¬å·é£æ ¼
void function_name(int arg1, char *arg2)
{
    if (condition) {
        // æ§åˆ¶ç»“æ„å¤§æ‹¬å·åœ¨åŒä¸€è¡Œ
        do_something();
    }
}

// è¡Œé•¿åº¦ï¼šæœ€å¤š 100 ä¸ªå­—ç¬¦
// è¿ç®—ç¬¦å‘¨å›´ä½¿ç”¨ç©ºæ ¼
int result = (a + b) * c;

// æŒ‡é’ˆæ˜Ÿå·ä¸ç±»å‹ä¸€èµ·
char *string;   // æ­£ç¡®
char* string;   // é¿å…
char * string;  // é¿å…
```

**å‘½åçº¦å®šï¼š**
```c
// å‡½æ•°ï¼šå°å†™åŠ ä¸‹åˆ’çº¿
void eval_expression(ASTNode *node);

// ç±»å‹ï¼šPascalCase
typedef struct Value Value;
typedef enum ValueType ValueType;

// å¸¸é‡ï¼šå¤§å†™åŠ ä¸‹åˆ’çº¿
#define MAX_BUFFER_SIZE 4096

// å˜é‡ï¼šå°å†™åŠ ä¸‹åˆ’çº¿
int item_count;
Value *current_value;

// æšä¸¾ï¼šTYPE_PREFIX_NAME
typedef enum {
    TYPE_I32,
    TYPE_STRING,
    TYPE_OBJECT
} ValueType;
```

**æ³¨é‡Šï¼š**
```c
// å•è¡Œæ³¨é‡Šç”¨äºç®€çŸ­è§£é‡Š
// ä½¿ç”¨å®Œæ•´çš„å¥å­å’Œæ­£ç¡®çš„å¤§å†™

/*
 * å¤šè¡Œæ³¨é‡Šç”¨äºè¾ƒé•¿çš„è§£é‡Š
 * å¯¹é½æ˜Ÿå·ä»¥æé«˜å¯è¯»æ€§
 */

/**
 * å‡½æ•°æ–‡æ¡£æ³¨é‡Š
 * @param node - è¦è¯„ä¼°çš„ AST èŠ‚ç‚¹
 * @return è¯„ä¼°åçš„å€¼
 */
Value eval_expr(ASTNode *node);
```

**é”™è¯¯å¤„ç†ï¼š**
```c
// æ£€æŸ¥æ‰€æœ‰ malloc è°ƒç”¨
char *buffer = malloc(size);
if (!buffer) {
    fprintf(stderr, "Error: Out of memory\n");
    exit(1);
}

// åœ¨é”™è¯¯æ¶ˆæ¯ä¸­æä¾›ä¸Šä¸‹æ–‡
if (file == NULL) {
    fprintf(stderr, "Error: Failed to open '%s': %s\n",
            filename, strerror(errno));
    exit(1);
}

// ä½¿ç”¨æœ‰æ„ä¹‰çš„é”™è¯¯æ¶ˆæ¯
// å·®ï¼šError: Invalid value
// å¥½ï¼šError: Expected integer, got string
```

**å†…å­˜ç®¡ç†ï¼š**
```c
// å§‹ç»ˆé‡Šæ”¾æ‚¨åˆ†é…çš„å†…å­˜
Value *val = value_create_i32(42);
// ... ä½¿ç”¨ val
value_free(val);

// é‡Šæ”¾åå°†æŒ‡é’ˆè®¾ç½®ä¸º NULLï¼ˆé˜²æ­¢åŒé‡é‡Šæ”¾ï¼‰
free(ptr);
ptr = NULL;

// åœ¨æ³¨é‡Šä¸­è®°å½•æ‰€æœ‰æƒ
// æ­¤å‡½æ•°è·å– 'value' çš„æ‰€æœ‰æƒå¹¶å°†é‡Šæ”¾å®ƒ
void store_value(Value *value);

// æ­¤å‡½æ•°ä¸è·å–æ‰€æœ‰æƒï¼ˆè°ƒç”¨è€…å¿…é¡»é‡Šæ”¾ï¼‰
Value *get_value(void);
```

### ä»£ç ç»„ç»‡

**æ–‡ä»¶ç»“æ„ï¼š**
```c
// 1. åŒ…å«ï¼ˆç³»ç»Ÿå¤´æ–‡ä»¶ä¼˜å…ˆï¼Œç„¶åæ˜¯æœ¬åœ°å¤´æ–‡ä»¶ï¼‰
#include <stdio.h>
#include <stdlib.h>
#include "internal.h"
#include "values.h"

// 2. å¸¸é‡å’Œå®
#define INITIAL_CAPACITY 16

// 3. ç±»å‹å®šä¹‰
typedef struct Foo Foo;

// 4. é™æ€å‡½æ•°å£°æ˜ï¼ˆå†…éƒ¨è¾…åŠ©å‡½æ•°ï¼‰
static void helper_function(void);

// 5. å…¬å…±å‡½æ•°å®ç°
void public_api_function(void)
{
    // å®ç°
}

// 6. é™æ€å‡½æ•°å®ç°
static void helper_function(void)
{
    // å®ç°
}
```

**å¤´æ–‡ä»¶ï¼š**
```c
// ä½¿ç”¨å¤´æ–‡ä»¶ä¿æŠ¤
#ifndef HEMLOCK_MODULE_H
#define HEMLOCK_MODULE_H

// å‰å‘å£°æ˜
typedef struct Value Value;

// å¤´æ–‡ä»¶ä¸­åªæ”¾å…¬å…± API
void public_function(Value *val);

// è®°å½•å‚æ•°å’Œè¿”å›å€¼
/**
 * è¯„ä¼°è¡¨è¾¾å¼ AST èŠ‚ç‚¹
 * @param node - è¦è¯„ä¼°çš„ AST èŠ‚ç‚¹
 * @param env - å½“å‰ç¯å¢ƒ
 * @return ç»“æœå€¼
 */
Value *eval_expr(ASTNode *node, Environment *env);

#endif // HEMLOCK_MODULE_H
```

---

## åº”è¯¥è´¡çŒ®ä»€ä¹ˆ

### é¼“åŠ±çš„è´¡çŒ®

**é”™è¯¯ä¿®å¤ï¼š**
- å†…å­˜æ³„æ¼
- æ®µé”™è¯¯
- ä¸æ­£ç¡®çš„è¡Œä¸º
- é”™è¯¯æ¶ˆæ¯æ”¹è¿›

**æ–‡æ¡£ï¼š**
- ä»£ç æ³¨é‡Š
- API æ–‡æ¡£
- ç”¨æˆ·æŒ‡å—å’Œæ•™ç¨‹
- ç¤ºä¾‹ç¨‹åº
- æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£

**æµ‹è¯•ï¼š**
- ç°æœ‰åŠŸèƒ½çš„é¢å¤–æµ‹è¯•ç”¨ä¾‹
- è¾¹ç•Œæƒ…å†µè¦†ç›–
- å·²ä¿®å¤é”™è¯¯çš„å›å½’æµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•

**å°åŠŸèƒ½æ·»åŠ ï¼š**
- æ–°çš„å†…ç½®å‡½æ•°ï¼ˆå¦‚æœç¬¦åˆç†å¿µï¼‰
- å­—ç¬¦ä¸²/æ•°ç»„æ–¹æ³•
- å®ç”¨å‡½æ•°
- é”™è¯¯å¤„ç†æ”¹è¿›

**æ€§èƒ½æ”¹è¿›ï¼š**
- æ›´å¿«çš„ç®—æ³•ï¼ˆä¸æ”¹å˜è¯­ä¹‰ï¼‰
- å‡å°‘å†…å­˜ä½¿ç”¨
- åŸºå‡†æµ‹è¯•å¥—ä»¶
- æ€§èƒ½åˆ†æå·¥å…·

**å·¥å…·ï¼š**
- ç¼–è¾‘å™¨è¯­æ³•é«˜äº®
- è¯­è¨€æœåŠ¡å™¨åè®®ï¼ˆLSPï¼‰
- è°ƒè¯•å™¨é›†æˆ
- æ„å»ºç³»ç»Ÿæ”¹è¿›

### å…ˆè®¨è®º

**ä¸»è¦åŠŸèƒ½ï¼š**
- æ–°çš„è¯­è¨€ç»“æ„
- ç±»å‹ç³»ç»Ÿæ›´æ”¹
- è¯­æ³•æ·»åŠ 
- å¹¶å‘åŸè¯­

**å¦‚ä½•è®¨è®ºï¼š**
1. æ‰“å¼€ GitHub issue æˆ– discussion
2. æè¿°åŠŸèƒ½å’Œç†ç”±
3. å±•ç¤ºç¤ºä¾‹ä»£ç 
4. è§£é‡Šå®ƒå¦‚ä½•ç¬¦åˆ Hemlock çš„ç†å¿µ
5. ç­‰å¾…ç»´æŠ¤è€…åé¦ˆ
6. åœ¨å®ç°ä¹‹å‰è¿­ä»£è®¾è®¡

---

## ä¸åº”è¯¥è´¡çŒ®ä»€ä¹ˆ

### ä¸é¼“åŠ±çš„è´¡çŒ®

**ä¸è¦æ·»åŠ ä»¥ä¸‹åŠŸèƒ½ï¼š**
- å¯¹ç”¨æˆ·éšè—å¤æ‚æ€§
- ä½¿è¡Œä¸ºéšå¼æˆ–ç¥å¥‡
- ç ´åç°æœ‰è¯­ä¹‰æˆ–è¯­æ³•
- æ·»åŠ åƒåœ¾å›æ”¶æˆ–è‡ªåŠ¨å†…å­˜ç®¡ç†
- è¿å"æ˜¾å¼ä¼˜äºéšå¼"åŸåˆ™

**è¢«æ‹’ç»çš„è´¡çŒ®ç¤ºä¾‹ï¼š**

**1. è‡ªåŠ¨åˆ†å·æ’å…¥**
```hemlock
// å·®ï¼šè¿™ä¼šè¢«æ‹’ç»
let x = 5  // æ²¡æœ‰åˆ†å·
let y = 10 // æ²¡æœ‰åˆ†å·
```
åŸå› ï¼šä½¿è¯­æ³•æ¨¡ç³Šï¼Œéšè—é”™è¯¯

**2. RAII/ææ„å‡½æ•°**
```hemlock
// å·®ï¼šè¿™ä¼šè¢«æ‹’ç»
let f = open("file.txt");
// æ–‡ä»¶åœ¨ä½œç”¨åŸŸç»“æŸæ—¶è‡ªåŠ¨å…³é—­
```
åŸå› ï¼šéšè—èµ„æºé‡Šæ”¾æ—¶é—´ï¼Œä¸å¤Ÿæ˜¾å¼

**3. ä¸¢å¤±æ•°æ®çš„éšå¼ç±»å‹è½¬æ¢**
```hemlock
// å·®ï¼šè¿™ä¼šè¢«æ‹’ç»
let x: i32 = 3.14;  // é™é»˜æˆªæ–­ä¸º 3
```
åŸå› ï¼šæ•°æ®ä¸¢å¤±åº”è¯¥æ˜¯æ˜¾å¼çš„ï¼Œä¸æ˜¯é™é»˜çš„

**4. åƒåœ¾å›æ”¶**
```c
// å·®ï¼šè¿™ä¼šè¢«æ‹’ç»
void *gc_malloc(size_t size) {
    // è·Ÿè¸ªåˆ†é…ä»¥è¿›è¡Œè‡ªåŠ¨æ¸…ç†
}
```
åŸå› ï¼šéšè—å†…å­˜ç®¡ç†ï¼Œæ€§èƒ½ä¸å¯é¢„æµ‹

**5. å¤æ‚çš„å®ç³»ç»Ÿ**
```hemlock
// å·®ï¼šè¿™ä¼šè¢«æ‹’ç»
macro repeat($n, $block) {
    for (let i = 0; i < $n; i++) $block
}
```
åŸå› ï¼šå¤ªå¤šé­”æ³•ï¼Œä½¿ä»£ç éš¾ä»¥æ¨ç†

### å¸¸è§æ‹’ç»åŸå› 

**"è¿™å¤ªéšå¼äº†"**
- è§£å†³æ–¹æ¡ˆï¼šä½¿è¡Œä¸ºæ˜¾å¼å¹¶è®°å½•å®ƒ

**"è¿™éšè—äº†å¤æ‚æ€§"**
- è§£å†³æ–¹æ¡ˆï¼šæš´éœ²å¤æ‚æ€§ä½†ä½¿å…¶ç¬¦åˆäººä½“å·¥ç¨‹å­¦

**"è¿™ç ´åäº†ç°æœ‰ä»£ç "**
- è§£å†³æ–¹æ¡ˆï¼šæ‰¾åˆ°éç ´åæ€§æ›¿ä»£æ–¹æ¡ˆæˆ–è®¨è®ºç‰ˆæœ¬æ§åˆ¶

**"è¿™ä¸ç¬¦åˆ Hemlock çš„ç†å¿µ"**
- è§£å†³æ–¹æ¡ˆï¼šé‡æ–°é˜…è¯» philosophy.md å¹¶é‡æ–°è€ƒè™‘æ–¹æ³•

---

## å¸¸è§æ¨¡å¼

### é”™è¯¯å¤„ç†æ¨¡å¼

```c
// åœ¨ Hemlock ä»£ç ä¸­å¯¹å¯æ¢å¤é”™è¯¯ä½¿ç”¨æ­¤æ¨¡å¼
Value *divide(Value *a, Value *b)
{
    // æ£€æŸ¥å‰ç½®æ¡ä»¶
    if (b->type != TYPE_I32) {
        // è¿”å›é”™è¯¯å€¼æˆ–æŠ›å‡ºå¼‚å¸¸
        return create_error("Expected integer divisor");
    }

    if (b->i32_value == 0) {
        return create_error("Division by zero");
    }

    // æ‰§è¡Œæ“ä½œ
    return value_create_i32(a->i32_value / b->i32_value);
}
```

### å†…å­˜ç®¡ç†æ¨¡å¼

```c
// æ¨¡å¼ï¼šåˆ†é…ã€ä½¿ç”¨ã€é‡Šæ”¾
void process_data(void)
{
    // åˆ†é…
    Buffer *buf = create_buffer(1024);
    char *str = malloc(256);

    // ä½¿ç”¨
    if (buf && str) {
        // ... æ‰§è¡Œå·¥ä½œ
    }

    // é‡Šæ”¾ï¼ˆæŒ‰åˆ†é…çš„ç›¸åé¡ºåºï¼‰
    free(str);
    free_buffer(buf);
}
```

### å€¼åˆ›å»ºæ¨¡å¼

```c
// ä½¿ç”¨æ„é€ å‡½æ•°åˆ›å»ºå€¼
Value *create_integer(int32_t n)
{
    Value *val = malloc(sizeof(Value));
    if (!val) {
        fprintf(stderr, "Out of memory\n");
        exit(1);
    }

    val->type = TYPE_I32;
    val->i32_value = n;
    return val;
}
```

### ç±»å‹æ£€æŸ¥æ¨¡å¼

```c
// åœ¨æ“ä½œä¹‹å‰æ£€æŸ¥ç±»å‹
Value *add_values(Value *a, Value *b)
{
    // ç±»å‹æ£€æŸ¥
    if (a->type != TYPE_I32 || b->type != TYPE_I32) {
        return create_error("Type mismatch");
    }

    // å¯ä»¥å®‰å…¨è¿›è¡Œ
    return value_create_i32(a->i32_value + b->i32_value);
}
```

### å­—ç¬¦ä¸²æ„å»ºæ¨¡å¼

```c
// é«˜æ•ˆæ„å»ºå­—ç¬¦ä¸²
void build_error_message(char *buffer, size_t size, const char *detail)
{
    snprintf(buffer, size, "Error: %s (line %d)", detail, line_number);
}
```

---

## æ·»åŠ æ–°åŠŸèƒ½

### åŠŸèƒ½æ·»åŠ æ¸…å•

æ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼Œè¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

#### 1. è®¾è®¡é˜¶æ®µ

- [ ] é˜…è¯» philosophy.md ä»¥ç¡®ä¿ä¸€è‡´æ€§
- [ ] åˆ›å»ºæè¿°åŠŸèƒ½çš„ GitHub issue
- [ ] è·å¾—ç»´æŠ¤è€…å¯¹è®¾è®¡çš„æ‰¹å‡†
- [ ] ç¼–å†™è§„èŒƒï¼ˆè¯­æ³•ã€è¯­ä¹‰ã€ç¤ºä¾‹ï¼‰
- [ ] è€ƒè™‘è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯æ¡ä»¶

#### 2. å®ç°é˜¶æ®µ

**å¦‚æœæ·»åŠ è¯­è¨€ç»“æ„ï¼š**

- [ ] åœ¨ `lexer.h` ä¸­æ·»åŠ  token ç±»å‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] åœ¨ `lexer.c` ä¸­æ·»åŠ è¯æ³•è§„åˆ™ï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] åœ¨ `ast.h` ä¸­æ·»åŠ  AST èŠ‚ç‚¹ç±»å‹
- [ ] åœ¨ `ast.c` ä¸­æ·»åŠ  AST æ„é€ å‡½æ•°
- [ ] åœ¨ `parser.c` ä¸­æ·»åŠ è§£æè§„åˆ™
- [ ] åœ¨ `runtime.c` æˆ–é€‚å½“çš„æ¨¡å—ä¸­æ·»åŠ è¿è¡Œæ—¶è¡Œä¸º
- [ ] åœ¨ AST é‡Šæ”¾å‡½æ•°ä¸­å¤„ç†æ¸…ç†

**å¦‚æœæ·»åŠ å†…ç½®å‡½æ•°ï¼š**

- [ ] åœ¨ `builtins.c` ä¸­æ·»åŠ å‡½æ•°å®ç°
- [ ] åœ¨ `register_builtins()` ä¸­æ³¨å†Œå‡½æ•°
- [ ] å¤„ç†æ‰€æœ‰å‚æ•°ç±»å‹ç»„åˆ
- [ ] è¿”å›é€‚å½“çš„é”™è¯¯å€¼
- [ ] è®°å½•å‚æ•°å’Œè¿”å›ç±»å‹

**å¦‚æœæ·»åŠ å€¼ç±»å‹ï¼š**

- [ ] åœ¨ `values.h` ä¸­æ·»åŠ ç±»å‹æšä¸¾
- [ ] å‘ Value è”åˆæ·»åŠ å­—æ®µ
- [ ] åœ¨ `values.c` ä¸­æ·»åŠ æ„é€ å‡½æ•°
- [ ] æ·»åŠ åˆ° `value_free()` è¿›è¡Œæ¸…ç†
- [ ] æ·»åŠ åˆ° `value_copy()` è¿›è¡Œå¤åˆ¶
- [ ] æ·»åŠ åˆ° `value_to_string()` è¿›è¡Œæ‰“å°
- [ ] å¦‚æœæ˜¯æ•°å­—ç±»å‹ï¼Œæ·»åŠ ç±»å‹æå‡è§„åˆ™

#### 3. æµ‹è¯•é˜¶æ®µ

- [ ] ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼ˆå‚è§ testing.mdï¼‰
- [ ] æµ‹è¯•æˆåŠŸæƒ…å†µ
- [ ] æµ‹è¯•é”™è¯¯æƒ…å†µ
- [ ] æµ‹è¯•è¾¹ç•Œæƒ…å†µ
- [ ] è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆ`make test`ï¼‰
- [ ] ä½¿ç”¨ valgrind æ£€æŸ¥å†…å­˜æ³„æ¼
- [ ] åœ¨å¤šä¸ªå¹³å°ä¸Šæµ‹è¯•ï¼ˆå¦‚æœå¯èƒ½ï¼‰

#### 4. æ–‡æ¡£é˜¶æ®µ

- [ ] ä½¿ç”¨é¢å‘ç”¨æˆ·çš„æ–‡æ¡£æ›´æ–° CLAUDE.md
- [ ] æ·»åŠ è§£é‡Šå®ç°çš„ä»£ç æ³¨é‡Š
- [ ] åœ¨ `examples/` ä¸­åˆ›å»ºç¤ºä¾‹
- [ ] æ›´æ–°ç›¸å…³çš„ docs/ æ–‡ä»¶
- [ ] è®°å½•ä»»ä½•ç ´åæ€§æ›´æ”¹

#### 5. æäº¤é˜¶æ®µ

- [ ] æ¸…ç†è°ƒè¯•ä»£ç å’Œæ³¨é‡Š
- [ ] éªŒè¯ä»£ç é£æ ¼åˆè§„æ€§
- [ ] åœ¨æœ€æ–°çš„ main ä¸Š rebase
- [ ] åˆ›å»ºå¸¦æœ‰è¯¦ç»†æè¿°çš„ pull request
- [ ] å“åº”ä»£ç å®¡æŸ¥åé¦ˆ

### ç¤ºä¾‹ï¼šæ·»åŠ æ–°è¿ç®—ç¬¦

è®©æˆ‘ä»¬ä»¥æ·»åŠ å–æ¨¡è¿ç®—ç¬¦ `%` ä¸ºä¾‹ï¼š

**1. è¯æ³•åˆ†æå™¨ï¼ˆlexer.cï¼‰ï¼š**
```c
// åœ¨ get_next_token() çš„ switch è¯­å¥ä¸­æ·»åŠ 
case '%':
    return create_token(TOKEN_PERCENT, "%", line);
```

**2. è¯æ³•åˆ†æå™¨å¤´æ–‡ä»¶ï¼ˆlexer.hï¼‰ï¼š**
```c
typedef enum {
    // ... ç°æœ‰ token
    TOKEN_PERCENT,
    // ...
} TokenType;
```

**3. ASTï¼ˆast.hï¼‰ï¼š**
```c
typedef enum {
    // ... ç°æœ‰è¿ç®—ç¬¦
    OP_MOD,
    // ...
} BinaryOp;
```

**4. è§£æå™¨ï¼ˆparser.cï¼‰ï¼š**
```c
// æ·»åŠ åˆ° parse_multiplicative() æˆ–é€‚å½“çš„ä¼˜å…ˆçº§çº§åˆ«
if (match(TOKEN_PERCENT)) {
    BinaryOp op = OP_MOD;
    ASTNode *right = parse_unary();
    left = create_binary_op_node(op, left, right);
}
```

**5. è¿è¡Œæ—¶ï¼ˆruntime.cï¼‰ï¼š**
```c
// æ·»åŠ åˆ° eval_binary_op()
case OP_MOD:
    // ç±»å‹æ£€æŸ¥
    if (left->type == TYPE_I32 && right->type == TYPE_I32) {
        if (right->i32_value == 0) {
            fprintf(stderr, "Error: Modulo by zero\n");
            exit(1);
        }
        return value_create_i32(left->i32_value % right->i32_value);
    }
    // ... å¤„ç†å…¶ä»–ç±»å‹ç»„åˆ
    break;
```

**6. æµ‹è¯•ï¼ˆtests/operators/modulo.hmlï¼‰ï¼š**
```hemlock
// åŸºæœ¬å–æ¨¡
print(10 % 3);  // Expect: 2

// è´Ÿæ•°å–æ¨¡
print(-10 % 3); // Expect: -1

// é”™è¯¯æƒ…å†µï¼ˆåº”è¯¥å¤±è´¥ï¼‰
// print(10 % 0);  // Division by zero
```

**7. æ–‡æ¡£ï¼ˆCLAUDE.mdï¼‰ï¼š**
```markdown
### ç®—æœ¯è¿ç®—ç¬¦
- `+` - åŠ æ³•
- `-` - å‡æ³•
- `*` - ä¹˜æ³•
- `/` - é™¤æ³•
- `%` - å–æ¨¡ï¼ˆä½™æ•°ï¼‰
```

---

## ä»£ç å®¡æŸ¥æµç¨‹

### å®¡æŸ¥è€…å…³æ³¨ä»€ä¹ˆ

**1. æ­£ç¡®æ€§**
- ä»£ç æ˜¯å¦åšäº†å®ƒå£°ç§°çš„äº‹æƒ…ï¼Ÿ
- æ˜¯å¦å¤„ç†äº†è¾¹ç•Œæƒ…å†µï¼Ÿ
- æ˜¯å¦æœ‰å†…å­˜æ³„æ¼ï¼Ÿ
- æ˜¯å¦æ­£ç¡®å¤„ç†äº†é”™è¯¯ï¼Ÿ

**2. ç†å¿µä¸€è‡´æ€§**
- è¿™æ˜¯å¦ç¬¦åˆ Hemlock çš„è®¾è®¡åŸåˆ™ï¼Ÿ
- æ˜¯æ˜¾å¼çš„è¿˜æ˜¯éšå¼çš„ï¼Ÿ
- æ˜¯å¦éšè—äº†å¤æ‚æ€§ï¼Ÿ

**3. ä»£ç è´¨é‡**
- ä»£ç æ˜¯å¦å¯è¯»å’Œå¯ç»´æŠ¤ï¼Ÿ
- å˜é‡åæ˜¯å¦å…·æœ‰æè¿°æ€§ï¼Ÿ
- å‡½æ•°å¤§å°æ˜¯å¦åˆç†ï¼Ÿ
- æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ–‡æ¡£ï¼Ÿ

**4. æµ‹è¯•**
- æ˜¯å¦æœ‰è¶³å¤Ÿçš„æµ‹è¯•ç”¨ä¾‹ï¼Ÿ
- æµ‹è¯•æ˜¯å¦è¦†ç›–æˆåŠŸå’Œå¤±è´¥è·¯å¾„ï¼Ÿ
- æ˜¯å¦æµ‹è¯•äº†è¾¹ç•Œæƒ…å†µï¼Ÿ

**5. æ–‡æ¡£**
- é¢å‘ç”¨æˆ·çš„æ–‡æ¡£æ˜¯å¦å·²æ›´æ–°ï¼Ÿ
- ä»£ç æ³¨é‡Šæ˜¯å¦æ¸…æ™°ï¼Ÿ
- æ˜¯å¦æä¾›äº†ç¤ºä¾‹ï¼Ÿ

### å“åº”åé¦ˆ

**åº”è¯¥åšçš„ï¼š**
- æ„Ÿè°¢å®¡æŸ¥è€…çš„æ—¶é—´
- å¦‚æœä¸ç†è§£ï¼Œè¯·æå‡ºæ¾„æ¸…é—®é¢˜
- å¦‚æœä¸åŒæ„ï¼Œè§£é‡Šæ‚¨çš„ç†ç”±
- åŠæ—¶è¿›è¡Œè¯·æ±‚çš„æ›´æ”¹
- å¦‚æœèŒƒå›´æ›´æ”¹ï¼Œæ›´æ–° PR æè¿°

**ä¸åº”è¯¥åšçš„ï¼š**
- æŠŠæ‰¹è¯„å½“ä½œä¸ªäººæ”»å‡»
- é˜²å¾¡æ€§åœ°äº‰è®º
- å¿½ç•¥åé¦ˆ
- åœ¨å®¡æŸ¥è¯„è®ºä¸Šå¼ºåˆ¶æ¨é€ï¼ˆé™¤é rebaseï¼‰
- å‘ PR æ·»åŠ ä¸ç›¸å…³çš„æ›´æ”¹

### è®©æ‚¨çš„ PR åˆå¹¶

**åˆå¹¶è¦æ±‚ï¼š**
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ— å†…å­˜æ³„æ¼ï¼ˆvalgrind æ¸…æ´ï¼‰
- [ ] ç»´æŠ¤è€…çš„ä»£ç å®¡æŸ¥æ‰¹å‡†
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] éµå¾ªä»£ç é£æ ¼æŒ‡å—
- [ ] ç¬¦åˆ Hemlock çš„ç†å¿µ

**æ—¶é—´çº¿ï¼š**
- å°å‹ PRï¼ˆé”™è¯¯ä¿®å¤ï¼‰ï¼šé€šå¸¸åœ¨å‡ å¤©å†…å®¡æŸ¥
- ä¸­å‹ PRï¼ˆæ–°åŠŸèƒ½ï¼‰ï¼šå¯èƒ½éœ€è¦ 1-2 å‘¨
- å¤§å‹ PRï¼ˆé‡å¤§æ›´æ”¹ï¼‰ï¼šéœ€è¦å¹¿æ³›è®¨è®º

---

## å…¶ä»–èµ„æº

### å­¦ä¹ èµ„æº

**ç†è§£è§£é‡Šå™¨ï¼š**
- "Crafting Interpreters" by Robert Nystrom
- "Writing An Interpreter In Go" by Thorsten Ball
- "Modern Compiler Implementation in C" by Andrew Appel

**C ç¼–ç¨‹ï¼š**
- "The C Programming Language" by K&R
- "Expert C Programming" by Peter van der Linden
- "C Interfaces and Implementations" by David Hanson

**å†…å­˜ç®¡ç†ï¼š**
- Valgrind æ–‡æ¡£
- "Understanding and Using C Pointers" by Richard Reese

### æœ‰ç”¨çš„å‘½ä»¤

```bash
# ä½¿ç”¨è°ƒè¯•ç¬¦å·æ„å»º
make clean && make CFLAGS="-g -O0"

# ä½¿ç”¨ valgrind è¿è¡Œ
valgrind --leak-check=full ./hemlock script.hml

# è¿è¡Œç‰¹å®šæµ‹è¯•ç±»åˆ«
./tests/run_tests.sh tests/strings/

# ç”Ÿæˆç”¨äºä»£ç å¯¼èˆªçš„ tags æ–‡ä»¶
ctags -R .

# æŸ¥æ‰¾æ‰€æœ‰ TODO å’Œ FIXME
grep -rn "TODO\|FIXME" src/ include/
```

---

## æœ‰é—®é¢˜ï¼Ÿ

å¦‚æœæ‚¨å¯¹è´¡çŒ®æœ‰ç–‘é—®ï¼š

1. æŸ¥çœ‹ `docs/` ä¸­çš„æ–‡æ¡£
2. æœç´¢ç°æœ‰çš„ GitHub issues
3. åœ¨ GitHub Discussions ä¸­æé—®
4. ç”¨æ‚¨çš„é—®é¢˜æ‰“å¼€ä¸€ä¸ªæ–° issue

**æ„Ÿè°¢æ‚¨ä¸º Hemlock åšè´¡çŒ®ï¼**



################################################################################
# HPM: å¿«é€Ÿå…¥é—¨
################################################################################

--------------------------------------------------------------------------------
## å®‰è£…
--------------------------------------------------------------------------------

# å®‰è£…

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•åœ¨ä½ çš„ç³»ç»Ÿä¸Šå®‰è£… hpmã€‚

## å¿«é€Ÿå®‰è£…ï¼ˆæ¨èï¼‰

ä½¿ç”¨å•ä¸ªå‘½ä»¤å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼š

```bash
curl -fsSL https://raw.githubusercontent.com/hemlang/hpm/main/install.sh | sh
```

è¿™ä¼šè‡ªåŠ¨ï¼š
- æ£€æµ‹ä½ çš„æ“ä½œç³»ç»Ÿï¼ˆLinuxã€macOSï¼‰
- æ£€æµ‹ä½ çš„æ¶æ„ï¼ˆx86_64ã€arm64ï¼‰
- ä¸‹è½½ç›¸åº”çš„é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶
- å®‰è£…åˆ° `/usr/local/bin`ï¼ˆå¦‚éœ€è¦ä¼šä½¿ç”¨ sudoï¼‰

### å®‰è£…é€‰é¡¹

```bash
# å®‰è£…åˆ°è‡ªå®šä¹‰ä½ç½®ï¼ˆæ— éœ€ sudoï¼‰
curl -fsSL https://raw.githubusercontent.com/hemlang/hpm/main/install.sh | sh -s -- --prefix ~/.local

# å®‰è£…ç‰¹å®šç‰ˆæœ¬
curl -fsSL https://raw.githubusercontent.com/hemlang/hpm/main/install.sh | sh -s -- --version 1.0.5

# ç»„åˆé€‰é¡¹
curl -fsSL https://raw.githubusercontent.com/hemlang/hpm/main/install.sh | sh -s -- --prefix ~/.local --version 1.0.5
```

### æ”¯æŒçš„å¹³å°

| å¹³å° | æ¶æ„ | çŠ¶æ€ |
|----------|--------------|--------|
| Linux    | x86_64       | æ”¯æŒ |
| macOS    | x86_64       | æ”¯æŒ |
| macOS    | arm64 (M1/M2/M3) | æ”¯æŒ |
| Linux    | arm64        | ä»æºç æ„å»º |

## ä»æºç æ„å»º

å¦‚æœä½ å¸Œæœ›ä»æºç æ„å»ºï¼Œæˆ–éœ€è¦é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶æœªè¦†ç›–çš„å¹³å°ï¼Œè¯·æŒ‰ä»¥ä¸‹è¯´æ˜æ“ä½œã€‚

### å‰ææ¡ä»¶

hpm éœ€è¦å…ˆå®‰è£… [Hemlock](https://github.com/hemlang/hemlock)ã€‚è¯·å…ˆæŒ‰ç…§ Hemlock å®‰è£…è¯´æ˜è¿›è¡Œæ“ä½œã€‚

éªŒè¯ Hemlock æ˜¯å¦å·²å®‰è£…ï¼š

```bash
hemlock --version
```

## å®‰è£…æ–¹æ³•

### æ–¹æ³• 1ï¼šMake Install

ä»æºç æ„å»ºå¹¶å®‰è£…ã€‚

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/hemlang/hpm.git
cd hpm

# å®‰è£…åˆ° /usr/local/binï¼ˆéœ€è¦ sudoï¼‰
sudo make install
```

å®‰è£…åï¼ŒéªŒè¯æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š

```bash
hpm --version
```

### æ–¹æ³• 2ï¼šè‡ªå®šä¹‰ä½ç½®

å®‰è£…åˆ°è‡ªå®šä¹‰ç›®å½•ï¼ˆæ— éœ€ sudoï¼‰ï¼š

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/hemlang/hpm.git
cd hpm

# å®‰è£…åˆ° ~/.local/bin
make install PREFIX=$HOME/.local

# æˆ–ä»»ä½•è‡ªå®šä¹‰ä½ç½®
make install PREFIX=/opt/hemlock
```

ç¡®ä¿ä½ çš„è‡ªå®šä¹‰ bin ç›®å½•åœ¨ PATH ä¸­ï¼š

```bash
# æ·»åŠ åˆ° ~/.bashrc æˆ– ~/.zshrc
export PATH="$HOME/.local/bin:$PATH"
```

### æ–¹æ³• 3ï¼šä¸å®‰è£…ç›´æ¥è¿è¡Œ

ä½ å¯ä»¥ç›´æ¥è¿è¡Œ hpm è€Œæ— éœ€å®‰è£…ï¼š

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/hemlang/hpm.git
cd hpm

# åˆ›å»ºæœ¬åœ°åŒ…è£…è„šæœ¬
make

# ä» hpm ç›®å½•è¿è¡Œ
./hpm --help

# æˆ–ç›´æ¥é€šè¿‡ hemlock è¿è¡Œ
hemlock src/main.hml --help
```

### æ–¹æ³• 4ï¼šæ‰‹åŠ¨å®‰è£…

åˆ›å»ºä½ è‡ªå·±çš„åŒ…è£…è„šæœ¬ï¼š

```bash
# å…‹éš†åˆ°æ°¸ä¹…ä½ç½®
git clone https://github.com/hemlang/hpm.git ~/.hpm-source

# åˆ›å»ºåŒ…è£…è„šæœ¬
cat > ~/.local/bin/hpm << 'EOF'
#!/bin/sh
exec hemlock "$HOME/.hpm-source/src/main.hml" "$@"
EOF

chmod +x ~/.local/bin/hpm
```

## å®‰è£…å˜é‡

Makefile æ”¯æŒä»¥ä¸‹å˜é‡ï¼š

| å˜é‡ | é»˜è®¤å€¼ | æè¿° |
|----------|---------|-------------|
| `PREFIX` | `/usr/local` | å®‰è£…å‰ç¼€ |
| `BINDIR` | `$(PREFIX)/bin` | äºŒè¿›åˆ¶æ–‡ä»¶ç›®å½• |
| `HEMLOCK` | `hemlock` | hemlock è§£é‡Šå™¨è·¯å¾„ |

ä½¿ç”¨è‡ªå®šä¹‰å˜é‡çš„ç¤ºä¾‹ï¼š

```bash
make install PREFIX=/opt/hemlock BINDIR=/opt/hemlock/bin HEMLOCK=/usr/bin/hemlock
```

## å·¥ä½œåŸç†

å®‰è£…ç¨‹åºåˆ›å»ºä¸€ä¸ª shell åŒ…è£…è„šæœ¬ï¼Œä½¿ç”¨ hpm æºä»£ç è°ƒç”¨ Hemlock è§£é‡Šå™¨ï¼š

```bash
#!/bin/sh
exec hemlock "/path/to/hpm/src/main.hml" "$@"
```

è¿™ç§æ–¹æ³•ï¼š
- æ— éœ€ç¼–è¯‘
- å§‹ç»ˆè¿è¡Œæœ€æ–°æºä»£ç 
- åœ¨æ‰€æœ‰å¹³å°ä¸Šå¯é è¿è¡Œ

## æ›´æ–° hpm

è¦å°† hpm æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼š

```bash
cd /path/to/hpm
git pull origin main

# å¦‚æœè·¯å¾„æ”¹å˜äº†ï¼Œé‡æ–°å®‰è£…
sudo make install
```

## å¸è½½

ä»ç³»ç»Ÿä¸­ç§»é™¤ hpmï¼š

```bash
cd /path/to/hpm
sudo make uninstall
```

æˆ–æ‰‹åŠ¨ç§»é™¤ï¼š

```bash
sudo rm /usr/local/bin/hpm
```

## éªŒè¯å®‰è£…

å®‰è£…åï¼ŒéªŒè¯ä¸€åˆ‡æ­£å¸¸ï¼š

```bash
# æ£€æŸ¥ç‰ˆæœ¬
hpm --version

# æŸ¥çœ‹å¸®åŠ©
hpm --help

# æµ‹è¯•åˆå§‹åŒ–ï¼ˆåœ¨ç©ºç›®å½•ä¸­ï¼‰
mkdir test-project && cd test-project
hpm init --yes
cat package.json
```

## æ•…éšœæ’é™¤

### "hemlock: command not found"

Hemlock æœªå®‰è£…æˆ–ä¸åœ¨ PATH ä¸­ã€‚è¯·å…ˆå®‰è£… Hemlockï¼š

```bash
# æ£€æŸ¥ hemlock æ˜¯å¦å­˜åœ¨
which hemlock

# å¦‚æœæœªæ‰¾åˆ°ï¼Œä» https://github.com/hemlang/hemlock å®‰è£… Hemlock
```

### "Permission denied"

ä½¿ç”¨ sudo è¿›è¡Œç³»ç»ŸèŒƒå›´å®‰è£…ï¼Œæˆ–å®‰è£…åˆ°ç”¨æˆ·ç›®å½•ï¼š

```bash
# é€‰é¡¹ 1ï¼šä½¿ç”¨ sudo
sudo make install

# é€‰é¡¹ 2ï¼šå®‰è£…åˆ°ç”¨æˆ·ç›®å½•
make install PREFIX=$HOME/.local
```

### å®‰è£…å "hpm: command not found"

ä½ çš„ PATH å¯èƒ½ä¸åŒ…å«å®‰è£…ç›®å½•ï¼š

```bash
# æ£€æŸ¥ hpm å®‰è£…ä½ç½®
ls -la /usr/local/bin/hpm

# å¦‚æœä½¿ç”¨è‡ªå®šä¹‰ä½ç½®ï¼Œæ·»åŠ åˆ° PATH
export PATH="$HOME/.local/bin:$PATH"
```

## å¹³å°ç‰¹å®šè¯´æ˜

### Linux

æ ‡å‡†å®‰è£…é€‚ç”¨äºæ‰€æœ‰ Linux å‘è¡Œç‰ˆã€‚æŸäº›å‘è¡Œç‰ˆå¯èƒ½éœ€è¦ï¼š

```bash
# Debian/Ubuntuï¼šç¡®ä¿å®‰è£…æ„å»ºå·¥å…·
sudo apt-get install build-essential git

# Fedora/RHEL
sudo dnf install make git
```

### macOS

æ ‡å‡†å®‰è£…å¯ç”¨ã€‚å¦‚æœä½¿ç”¨ Homebrewï¼š

```bash
# ç¡®ä¿å®‰è£… Xcode å‘½ä»¤è¡Œå·¥å…·
xcode-select --install
```

### Windows (WSL)

hpm åœ¨ Windows Subsystem for Linux ä¸­å¯ç”¨ï¼š

```bash
# åœ¨ WSL ç»ˆç«¯ä¸­
git clone https://github.com/hemlang/hpm.git
cd hpm
make install PREFIX=$HOME/.local
```

## åç»­æ­¥éª¤

å®‰è£…åï¼š

1. [å¿«é€Ÿå¼€å§‹](#hpm-installation-quick-start) - åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªé¡¹ç›®
2. [å‘½ä»¤å‚è€ƒ](#hpm-installation-commands) - å­¦ä¹ æ‰€æœ‰å‘½ä»¤
3. [é…ç½®](#hpm-installation-configuration) - é…ç½® hpm


--------------------------------------------------------------------------------
## å¿«é€Ÿå¼€å§‹
--------------------------------------------------------------------------------

# å¿«é€Ÿå¼€å§‹

5 åˆ†é’Ÿå†…å¼€å§‹ä½¿ç”¨ hpmã€‚

## å®‰è£… hpm

```bash
curl -fsSL https://raw.githubusercontent.com/hemlang/hpm/main/install.sh | sh
```

æ›´å¤šå®‰è£…é€‰é¡¹è¯·å‚é˜…[å®‰è£…æŒ‡å—](#hpm-quick-start-installation)ã€‚

## åˆ›å»ºæ–°é¡¹ç›®

é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°ç›®å½•å¹¶åˆå§‹åŒ–åŒ…ï¼š

```bash
mkdir my-project
cd my-project
hpm init
```

ç³»ç»Ÿä¼šæç¤ºä½ è¾“å…¥é¡¹ç›®è¯¦æƒ…ï¼š

```
Package name (owner/repo): myname/my-project
Version (1.0.0):
Description: My awesome Hemlock project
Author: Your Name <you@example.com>
License (MIT):
Main file (src/index.hml):

Created package.json
```

ä½¿ç”¨ `--yes` æ¥å—æ‰€æœ‰é»˜è®¤å€¼ï¼š

```bash
hpm init --yes
```

## é¡¹ç›®ç»“æ„

åˆ›å»ºåŸºæœ¬é¡¹ç›®ç»“æ„ï¼š

```
my-project/
â”œâ”€â”€ package.json        # é¡¹ç›®æ¸…å•
â”œâ”€â”€ src/
â”‚   â””â”€â”€ index.hml      # ä¸»å…¥å£ç‚¹
â””â”€â”€ test/
    â””â”€â”€ test.hml       # æµ‹è¯•æ–‡ä»¶
```

åˆ›å»ºä¸»æ–‡ä»¶ï¼š

```bash
mkdir -p src test
```

**src/index.hml:**
```hemlock
// Main entry point
export fn greet(name: string): string {
    return "Hello, " + name + "!";
}

export fn main() {
    print(greet("World"));
}
```

## å®‰è£…ä¾èµ–

åœ¨ GitHub ä¸Šæœç´¢åŒ…ï¼ˆåŒ…ä½¿ç”¨ `owner/repo` æ ¼å¼ï¼‰ï¼š

```bash
# å®‰è£…ä¸€ä¸ªåŒ…
hpm install hemlang/sprout

# ä½¿ç”¨ç‰ˆæœ¬çº¦æŸå®‰è£…
hpm install hemlang/json@^1.0.0

# å®‰è£…ä¸ºå¼€å‘ä¾èµ–
hpm install hemlang/test-utils --dev
```

å®‰è£…åï¼Œä½ çš„é¡¹ç›®ç»“æ„å°†åŒ…å« `hem_modules/`ï¼š

```
my-project/
â”œâ”€â”€ package.json
â”œâ”€â”€ package-lock.json   # é”å®šæ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”œâ”€â”€ hem_modules/        # å·²å®‰è£…çš„åŒ…
â”‚   â””â”€â”€ hemlang/
â”‚       â””â”€â”€ sprout/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ index.hml
â””â”€â”€ test/
    â””â”€â”€ test.hml
```

## ä½¿ç”¨å·²å®‰è£…çš„åŒ…

ä½¿ç”¨ GitHub è·¯å¾„å¯¼å…¥åŒ…ï¼š

```hemlock
// Import from installed package
import { app, router } from "hemlang/sprout";
import { parse, stringify } from "hemlang/json";

// Import from subpath
import { middleware } from "hemlang/sprout/middleware";

// Standard library (built-in)
import { HashMap } from "@stdlib/collections";
import { readFile } from "@stdlib/fs";
```

## æ·»åŠ è„šæœ¬

åœ¨ `package.json` ä¸­æ·»åŠ è„šæœ¬ï¼š

```json
{
  "name": "myname/my-project",
  "version": "1.0.0",
  "scripts": {
    "start": "hemlock src/index.hml",
    "test": "hemlock test/test.hml",
    "build": "hemlock --bundle src/index.hml -o dist/app.hmlc"
  }
}
```

ä½¿ç”¨ `hpm run` è¿è¡Œè„šæœ¬ï¼š

```bash
hpm run start
hpm run build

# test çš„ç®€å†™å½¢å¼
hpm test
```

## å¸¸ç”¨å·¥ä½œæµ

### å®‰è£…æ‰€æœ‰ä¾èµ–

å½“ä½ å…‹éš†ä¸€ä¸ªå¸¦æœ‰ `package.json` çš„é¡¹ç›®æ—¶ï¼š

```bash
git clone https://github.com/someone/project.git
cd project
hpm install
```

### æ›´æ–°ä¾èµ–

å°†æ‰€æœ‰åŒ…æ›´æ–°åˆ°çº¦æŸèŒƒå›´å†…çš„æœ€æ–°ç‰ˆæœ¬ï¼š

```bash
hpm update
```

æ›´æ–°ç‰¹å®šçš„åŒ…ï¼š

```bash
hpm update hemlang/sprout
```

### æŸ¥çœ‹å·²å®‰è£…çš„åŒ…

åˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„åŒ…ï¼š

```bash
hpm list
```

è¾“å‡ºæ˜¾ç¤ºä¾èµ–æ ‘ï¼š

```
my-project@1.0.0
â”œâ”€â”€ hemlang/sprout@2.1.0
â”‚   â””â”€â”€ hemlang/router@1.5.0
â””â”€â”€ hemlang/json@1.2.3
```

### æ£€æŸ¥æ›´æ–°

æŸ¥çœ‹å“ªäº›åŒ…æœ‰æ›´æ–°ç‰ˆæœ¬ï¼š

```bash
hpm outdated
```

### ç§»é™¤åŒ…

```bash
hpm uninstall hemlang/sprout
```

## ç¤ºä¾‹ï¼šWeb åº”ç”¨

è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ Web æ¡†æ¶çš„å®Œæ•´ç¤ºä¾‹ï¼š

**package.json:**
```json
{
  "name": "myname/my-web-app",
  "version": "1.0.0",
  "description": "A web application",
  "main": "src/index.hml",
  "dependencies": {
    "hemlang/sprout": "^2.0.0"
  },
  "scripts": {
    "start": "hemlock src/index.hml",
    "dev": "hemlock --watch src/index.hml"
  }
}
```

**src/index.hml:**
```hemlock
import { App, Router } from "hemlang/sprout";

fn main() {
    let app = App.new();
    let router = Router.new();

    router.get("/", fn(req, res) {
        res.send("Hello, World!");
    });

    router.get("/api/status", fn(req, res) {
        res.json({ status: "ok" });
    });

    app.use(router);
    app.listen(3000);

    print("Server running on http://localhost:3000");
}
```

è¿è¡Œåº”ç”¨ï¼š

```bash
hpm install
hpm run start
```

## åç»­æ­¥éª¤

- [å‘½ä»¤å‚è€ƒ](#hpm-quick-start-commands) - å­¦ä¹ æ‰€æœ‰ hpm å‘½ä»¤
- [åˆ›å»ºåŒ…](#hpm-quick-start-creating-packages) - å‘å¸ƒä½ è‡ªå·±çš„åŒ…
- [é…ç½®](#hpm-quick-start-configuration) - é…ç½® hpm å’Œ GitHub token
- [é¡¹ç›®è®¾ç½®](#hpm-quick-start-project-setup) - è¯¦ç»†çš„é¡¹ç›®é…ç½®


--------------------------------------------------------------------------------
## é¡¹ç›®è®¾ç½®
--------------------------------------------------------------------------------

# é¡¹ç›®è®¾ç½®

ä½¿ç”¨ hpm è®¾ç½® Hemlock é¡¹ç›®çš„å®Œæ•´æŒ‡å—ã€‚

## åˆ›å»ºæ–°é¡¹ç›®

### åŸºæœ¬è®¾ç½®

ä»å¤´åˆ›å»ºæ–°é¡¹ç›®ï¼š

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir my-project
cd my-project

# åˆå§‹åŒ– package.json
hpm init

# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p src test
```

### é¡¹ç›®æ¨¡æ¿

ä»¥ä¸‹æ˜¯ä¸åŒç”¨ä¾‹çš„å¸¸è§é¡¹ç›®ç»“æ„ï¼š

#### åº“åŒ…

ç”¨äºå¯å¤ç”¨çš„åº“ï¼š

```
my-library/
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â”œâ”€â”€ LICENSE
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.hml          # ä¸»å…¥å£ï¼Œå¯¼å‡ºå…¬å…± API
â”‚   â”œâ”€â”€ core.hml           # æ ¸å¿ƒåŠŸèƒ½
â”‚   â”œâ”€â”€ utils.hml          # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ types.hml          # ç±»å‹å®šä¹‰
â””â”€â”€ test/
    â”œâ”€â”€ framework.hml      # æµ‹è¯•æ¡†æ¶
    â”œâ”€â”€ run.hml            # æµ‹è¯•è¿è¡Œå™¨
    â””â”€â”€ test_core.hml      # æµ‹è¯•
```

**package.json:**

```json
{
  "name": "yourusername/my-library",
  "version": "1.0.0",
  "description": "A reusable Hemlock library",
  "main": "src/index.hml",
  "scripts": {
    "test": "hemlock test/run.hml"
  },
  "dependencies": {},
  "devDependencies": {}
}
```

#### åº”ç”¨ç¨‹åº

ç”¨äºç‹¬ç«‹åº”ç”¨ç¨‹åºï¼š

```
my-app/
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.hml           # åº”ç”¨ç¨‹åºå…¥å£ç‚¹
â”‚   â”œâ”€â”€ config.hml         # é…ç½®
â”‚   â”œâ”€â”€ commands/          # CLI å‘½ä»¤
â”‚   â”‚   â”œâ”€â”€ index.hml
â”‚   â”‚   â””â”€â”€ run.hml
â”‚   â””â”€â”€ lib/               # å†…éƒ¨åº“
â”‚       â””â”€â”€ utils.hml
â”œâ”€â”€ test/
â”‚   â””â”€â”€ run.hml
â””â”€â”€ data/                  # æ•°æ®æ–‡ä»¶
```

**package.json:**

```json
{
  "name": "yourusername/my-app",
  "version": "1.0.0",
  "description": "A Hemlock application",
  "main": "src/main.hml",
  "scripts": {
    "start": "hemlock src/main.hml",
    "dev": "hemlock --watch src/main.hml",
    "test": "hemlock test/run.hml",
    "build": "hemlock --bundle src/main.hml -o dist/app.hmlc"
  },
  "dependencies": {
    "hemlang/json": "^1.0.0"
  },
  "devDependencies": {}
}
```

#### Web åº”ç”¨ç¨‹åº

ç”¨äº Web æœåŠ¡å™¨ï¼š

```
my-web-app/
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.hml           # æœåŠ¡å™¨å…¥å£ç‚¹
â”‚   â”œâ”€â”€ routes/            # è·¯ç”±å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ index.hml
â”‚   â”‚   â”œâ”€â”€ api.hml
â”‚   â”‚   â””â”€â”€ auth.hml
â”‚   â”œâ”€â”€ middleware/        # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ index.hml
â”‚   â”‚   â””â”€â”€ auth.hml
â”‚   â”œâ”€â”€ models/            # æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ user.hml
â”‚   â””â”€â”€ services/          # ä¸šåŠ¡é€»è¾‘
â”‚       â””â”€â”€ user.hml
â”œâ”€â”€ test/
â”‚   â””â”€â”€ run.hml
â”œâ”€â”€ static/                # é™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ css/
â”‚   â””â”€â”€ js/
â””â”€â”€ views/                 # æ¨¡æ¿
    â””â”€â”€ index.hml
```

**package.json:**

```json
{
  "name": "yourusername/my-web-app",
  "version": "1.0.0",
  "description": "A Hemlock web application",
  "main": "src/main.hml",
  "scripts": {
    "start": "hemlock src/main.hml",
    "dev": "hemlock --watch src/main.hml",
    "test": "hemlock test/run.hml"
  },
  "dependencies": {
    "hemlang/sprout": "^2.0.0",
    "hemlang/json": "^1.0.0"
  },
  "devDependencies": {
    "hemlang/test-utils": "^1.0.0"
  }
}
```

## package.json æ–‡ä»¶

### å¿…éœ€å­—æ®µ

```json
{
  "name": "owner/repo",
  "version": "1.0.0"
}
```

### æ‰€æœ‰å­—æ®µ

```json
{
  "name": "yourusername/my-package",
  "version": "1.0.0",
  "description": "Package description",
  "author": "Your Name <you@example.com>",
  "license": "MIT",
  "repository": "https://github.com/yourusername/my-package",
  "homepage": "https://yourusername.github.io/my-package",
  "bugs": "https://github.com/yourusername/my-package/issues",
  "main": "src/index.hml",
  "keywords": ["utility", "parser"],
  "dependencies": {
    "owner/package": "^1.0.0"
  },
  "devDependencies": {
    "owner/test-lib": "^1.0.0"
  },
  "scripts": {
    "start": "hemlock src/main.hml",
    "test": "hemlock test/run.hml",
    "build": "hemlock --bundle src/main.hml -o dist/app.hmlc"
  },
  "files": [
    "src/",
    "LICENSE",
    "README.md"
  ],
  "native": {
    "requires": ["libcurl", "openssl"]
  }
}
```

### å­—æ®µå‚è€ƒ

| å­—æ®µ | ç±»å‹ | æè¿° |
|-------|------|-------------|
| `name` | string | owner/repo æ ¼å¼çš„åŒ…åç§°ï¼ˆå¿…éœ€ï¼‰ |
| `version` | string | è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆå¿…éœ€ï¼‰ |
| `description` | string | ç®€çŸ­æè¿° |
| `author` | string | ä½œè€…å§“åå’Œé‚®ç®± |
| `license` | string | è®¸å¯è¯æ ‡è¯†ç¬¦ï¼ˆMITã€Apache-2.0 ç­‰ï¼‰ |
| `repository` | string | ä»“åº“ URL |
| `homepage` | string | é¡¹ç›®ä¸»é¡µ |
| `bugs` | string | é—®é¢˜è·Ÿè¸ªå™¨ URL |
| `main` | string | å…¥å£ç‚¹æ–‡ä»¶ï¼ˆé»˜è®¤ï¼šsrc/index.hmlï¼‰ |
| `keywords` | array | æœç´¢å…³é”®è¯ |
| `dependencies` | object | è¿è¡Œæ—¶ä¾èµ– |
| `devDependencies` | object | å¼€å‘ä¾èµ– |
| `scripts` | object | å‘½åè„šæœ¬ |
| `files` | array | å‘å¸ƒæ—¶åŒ…å«çš„æ–‡ä»¶ |
| `native` | object | åŸç”Ÿåº“è¦æ±‚ |

## package-lock.json æ–‡ä»¶

é”å®šæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆï¼Œåº”æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ã€‚å®ƒç¡®ä¿å¯é‡ç°çš„å®‰è£…ã€‚

```json
{
  "lockVersion": 1,
  "hemlock": "1.0.0",
  "dependencies": {
    "hemlang/sprout": {
      "version": "2.1.0",
      "resolved": "https://github.com/hemlang/sprout/archive/v2.1.0.tar.gz",
      "integrity": "sha256-abc123...",
      "dependencies": {
        "hemlang/router": "^1.5.0"
      }
    },
    "hemlang/router": {
      "version": "1.5.0",
      "resolved": "https://github.com/hemlang/router/archive/v1.5.0.tar.gz",
      "integrity": "sha256-def456...",
      "dependencies": {}
    }
  }
}
```

### é”å®šæ–‡ä»¶æœ€ä½³å®è·µ

- **æäº¤** package-lock.json åˆ°ç‰ˆæœ¬æ§åˆ¶
- **ä¸è¦æ‰‹åŠ¨ç¼–è¾‘** - å®ƒæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„
- **æ‹‰å–æ›´æ”¹åè¿è¡Œ `hpm install`**
- **å¦‚æœæŸååˆ™åˆ é™¤å¹¶é‡æ–°ç”Ÿæˆ**ï¼š
  ```bash
  rm package-lock.json
  hpm install
  ```

## hem_modules ç›®å½•

å·²å®‰è£…çš„åŒ…å­˜å‚¨åœ¨ `hem_modules/` ä¸­ï¼š

```
hem_modules/
â”œâ”€â”€ hemlang/
â”‚   â”œâ”€â”€ sprout/
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ src/
â”‚   â””â”€â”€ router/
â”‚       â”œâ”€â”€ package.json
â”‚       â””â”€â”€ src/
â””â”€â”€ alice/
    â””â”€â”€ http-client/
        â”œâ”€â”€ package.json
        â””â”€â”€ src/
```

### hem_modules æœ€ä½³å®è·µ

- **æ·»åŠ åˆ° .gitignore** - ä¸è¦æäº¤ä¾èµ–
- **ä¸è¦ä¿®æ”¹** - æ›´æ”¹ä¼šè¢«è¦†ç›–
- **åˆ é™¤ä»¥é‡æ–°å®‰è£…**ï¼š
  ```bash
  rm -rf hem_modules
  hpm install
  ```

## .gitignore

Hemlock é¡¹ç›®æ¨èçš„ .gitignoreï¼š

```gitignore
# Dependencies
hem_modules/

# Build output
dist/
*.hmlc

# IDE files
.idea/
.vscode/
*.swp
*.swo

# OS files
.DS_Store
Thumbs.db

# Logs
*.log
logs/

# Environment
.env
.env.local

# Test coverage
coverage/
```

## ä½¿ç”¨ä¾èµ–

### æ·»åŠ ä¾èµ–

```bash
# æ·»åŠ è¿è¡Œæ—¶ä¾èµ–
hpm install hemlang/json

# ä½¿ç”¨ç‰ˆæœ¬çº¦æŸæ·»åŠ 
hpm install hemlang/sprout@^2.0.0

# æ·»åŠ å¼€å‘ä¾èµ–
hpm install hemlang/test-utils --dev
```

### å¯¼å…¥ä¾èµ–

```hemlock
// Import from package (uses "main" entry)
import { parse, stringify } from "hemlang/json";

// Import from subpath
import { Router } from "hemlang/sprout/router";

// Import standard library
import { HashMap } from "@stdlib/collections";
import { readFile, writeFile } from "@stdlib/fs";
```

### å¯¼å…¥è§£æ

hpm æŒ‰ä»¥ä¸‹é¡ºåºè§£æå¯¼å…¥ï¼š

1. **æ ‡å‡†åº“**ï¼š`@stdlib/*` å¯¼å…¥å†…ç½®æ¨¡å—
2. **åŒ…æ ¹ç›®å½•**ï¼š`owner/repo` ä½¿ç”¨ `main` å­—æ®µ
3. **å­è·¯å¾„**ï¼š`owner/repo/path` æ£€æŸ¥ï¼š
   - `hem_modules/owner/repo/path.hml`
   - `hem_modules/owner/repo/path/index.hml`
   - `hem_modules/owner/repo/src/path.hml`
   - `hem_modules/owner/repo/src/path/index.hml`

## è„šæœ¬

### å®šä¹‰è„šæœ¬

åœ¨ package.json ä¸­æ·»åŠ è„šæœ¬ï¼š

```json
{
  "scripts": {
    "start": "hemlock src/main.hml",
    "dev": "hemlock --watch src/main.hml",
    "test": "hemlock test/run.hml",
    "test:unit": "hemlock test/unit/run.hml",
    "test:integration": "hemlock test/integration/run.hml",
    "build": "hemlock --bundle src/main.hml -o dist/app.hmlc",
    "clean": "rm -rf dist hem_modules",
    "lint": "hemlock-lint src/",
    "format": "hemlock-fmt src/"
  }
}
```

### è¿è¡Œè„šæœ¬

```bash
hpm run start
hpm run dev
hpm run build

# test çš„ç®€å†™
hpm test

# ä¼ é€’å‚æ•°
hpm run test -- --verbose --filter=unit
```

### è„šæœ¬å‘½åçº¦å®š

| è„šæœ¬ | ç”¨é€” |
|--------|---------|
| `start` | è¿è¡Œåº”ç”¨ç¨‹åº |
| `dev` | ä»¥å¼€å‘æ¨¡å¼è¿è¡Œ |
| `test` | è¿è¡Œæ‰€æœ‰æµ‹è¯• |
| `build` | ä¸ºç”Ÿäº§ç¯å¢ƒæ„å»º |
| `clean` | ç§»é™¤ç”Ÿæˆçš„æ–‡ä»¶ |
| `lint` | æ£€æŸ¥ä»£ç é£æ ¼ |
| `format` | æ ¼å¼åŒ–ä»£ç  |

## å¼€å‘å·¥ä½œæµ

### åˆå§‹è®¾ç½®

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/yourusername/my-project.git
cd my-project

# å®‰è£…ä¾èµ–
hpm install

# è¿è¡Œæµ‹è¯•
hpm test

# å¼€å§‹å¼€å‘
hpm run dev
```

### æ—¥å¸¸å·¥ä½œæµ

```bash
# æ‹‰å–æœ€æ–°æ›´æ”¹
git pull

# å®‰è£…ä»»ä½•æ–°ä¾èµ–
hpm install

# è¿›è¡Œæ›´æ”¹...

# è¿è¡Œæµ‹è¯•
hpm test

# æäº¤
git add .
git commit -m "Add feature"
git push
```

### æ·»åŠ æ–°åŠŸèƒ½

```bash
# åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/new-feature

# å¦‚æœéœ€è¦ï¼Œæ·»åŠ æ–°ä¾èµ–
hpm install hemlang/new-lib

# å®ç°åŠŸèƒ½...

# æµ‹è¯•
hpm test

# æäº¤å¹¶æ¨é€
git add .
git commit -m "Add new feature"
git push -u origin feature/new-feature
```

## ç¯å¢ƒç‰¹å®šé…ç½®

### ä½¿ç”¨ç¯å¢ƒå˜é‡

```hemlock
import { getenv } from "@stdlib/env";

let db_host = getenv("DATABASE_HOST") ?? "localhost";
let api_key = getenv("API_KEY") ?? "";

if api_key == "" {
    print("Warning: API_KEY not set");
}
```

### é…ç½®æ–‡ä»¶

**config.hml:**

```hemlock
import { getenv } from "@stdlib/env";

export let config = {
    environment: getenv("HEMLOCK_ENV") ?? "development",
    database: {
        host: getenv("DB_HOST") ?? "localhost",
        port: int(getenv("DB_PORT") ?? "5432"),
        name: getenv("DB_NAME") ?? "myapp"
    },
    server: {
        port: int(getenv("PORT") ?? "3000"),
        host: getenv("HOST") ?? "0.0.0.0"
    }
};

export fn is_production(): bool {
    return config.environment == "production";
}
```

## å¦è¯·å‚é˜…

- [å¿«é€Ÿå¼€å§‹](#hpm-project-setup-quick-start) - å¿«é€Ÿå…¥é—¨
- [å‘½ä»¤](#hpm-project-setup-commands) - å‘½ä»¤å‚è€ƒ
- [åˆ›å»ºåŒ…](#hpm-project-setup-creating-packages) - å‘å¸ƒåŒ…
- [é…ç½®](#hpm-project-setup-configuration) - hpm é…ç½®



################################################################################
# HPM: ç”¨æˆ·æŒ‡å—
################################################################################

--------------------------------------------------------------------------------
## å‘½ä»¤
--------------------------------------------------------------------------------

# å‘½ä»¤å‚è€ƒ

æ‰€æœ‰ hpm å‘½ä»¤çš„å®Œæ•´å‚è€ƒã€‚

## å…¨å±€é€‰é¡¹

è¿™äº›é€‰é¡¹é€‚ç”¨äºä»»ä½•å‘½ä»¤ï¼š

| é€‰é¡¹ | æè¿° |
|--------|-------------|
| `--help`, `-h` | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ |
| `--version`, `-v` | æ˜¾ç¤º hpm ç‰ˆæœ¬ |
| `--verbose` | æ˜¾ç¤ºè¯¦ç»†è¾“å‡º |

## å‘½ä»¤

### hpm init

åˆ›å»ºæ–°çš„ `package.json` æ–‡ä»¶ã€‚

```bash
hpm init        # äº¤äº’æ¨¡å¼
hpm init --yes  # æ¥å—æ‰€æœ‰é»˜è®¤å€¼
hpm init -y     # ç®€å†™å½¢å¼
```

**é€‰é¡¹ï¼š**

| é€‰é¡¹ | æè¿° |
|--------|-------------|
| `--yes`, `-y` | å¯¹æ‰€æœ‰æç¤ºæ¥å—é»˜è®¤å€¼ |

**äº¤äº’æç¤ºï¼š**
- åŒ…åç§°ï¼ˆowner/repo æ ¼å¼ï¼‰
- ç‰ˆæœ¬ï¼ˆé»˜è®¤ï¼š1.0.0ï¼‰
- æè¿°
- ä½œè€…
- è®¸å¯è¯ï¼ˆé»˜è®¤ï¼šMITï¼‰
- ä¸»æ–‡ä»¶ï¼ˆé»˜è®¤ï¼šsrc/index.hmlï¼‰

**ç¤ºä¾‹ï¼š**

```bash
$ hpm init
Package name (owner/repo): alice/my-lib
Version (1.0.0):
Description: A utility library
Author: Alice <alice@example.com>
License (MIT):
Main file (src/index.hml):

Created package.json
```

---

### hpm install

å®‰è£…ä¾èµ–æˆ–æ·»åŠ æ–°åŒ…ã€‚

```bash
hpm install                           # ä» package.json å®‰è£…æ‰€æœ‰ä¾èµ–
hpm install owner/repo                # æ·»åŠ å¹¶å®‰è£…åŒ…
hpm install owner/repo@^1.0.0        # ä½¿ç”¨ç‰ˆæœ¬çº¦æŸ
hpm install owner/repo --dev         # ä½œä¸ºå¼€å‘ä¾èµ–
hpm i owner/repo                      # ç®€å†™å½¢å¼
```

**é€‰é¡¹ï¼š**

| é€‰é¡¹ | æè¿° |
|--------|-------------|
| `--dev`, `-D` | æ·»åŠ åˆ° devDependencies |
| `--verbose` | æ˜¾ç¤ºè¯¦ç»†è¿›åº¦ |
| `--dry-run` | é¢„è§ˆè€Œä¸å®‰è£… |
| `--offline` | ä»…ä»ç¼“å­˜å®‰è£…ï¼ˆæ— ç½‘ç»œï¼‰ |
| `--parallel` | å¯ç”¨å¹¶è¡Œä¸‹è½½ï¼ˆå®éªŒæ€§ï¼‰ |

**ç‰ˆæœ¬çº¦æŸè¯­æ³•ï¼š**

| è¯­æ³• | ç¤ºä¾‹ | å«ä¹‰ |
|--------|---------|---------|
| ï¼ˆæ— ï¼‰ | `owner/repo` | æœ€æ–°ç‰ˆæœ¬ |
| ç²¾ç¡® | `owner/repo@1.2.3` | æ­£å¥½æ˜¯ 1.2.3 |
| æ’å…¥ç¬¦ | `owner/repo@^1.2.3` | >=1.2.3 <2.0.0 |
| æ³¢æµªå· | `owner/repo@~1.2.3` | >=1.2.3 <1.3.0 |
| èŒƒå›´ | `owner/repo@>=1.0.0` | è‡³å°‘ 1.0.0 |

**ç¤ºä¾‹ï¼š**

```bash
# å®‰è£…æ‰€æœ‰ä¾èµ–
hpm install

# å®‰è£…ç‰¹å®šåŒ…
hpm install hemlang/json

# ä½¿ç”¨ç‰ˆæœ¬çº¦æŸå®‰è£…
hpm install hemlang/sprout@^2.0.0

# å®‰è£…ä¸ºå¼€å‘ä¾èµ–
hpm install hemlang/test-utils --dev

# é¢„è§ˆå°†è¦å®‰è£…çš„å†…å®¹
hpm install hemlang/sprout --dry-run

# è¯¦ç»†è¾“å‡º
hpm install --verbose

# ä»…ä»ç¼“å­˜å®‰è£…ï¼ˆç¦»çº¿ï¼‰
hpm install --offline
```

**è¾“å‡ºï¼š**

```
Installing dependencies...
  + hemlang/sprout@2.1.0
  + hemlang/router@1.5.0 (dependency of hemlang/sprout)

Installed 2 packages in 1.2s
```

---

### hpm uninstall

ç§»é™¤ä¸€ä¸ªåŒ…ã€‚

```bash
hpm uninstall owner/repo
hpm rm owner/repo          # ç®€å†™å½¢å¼
hpm remove owner/repo      # æ›¿ä»£å½¢å¼
```

**ç¤ºä¾‹ï¼š**

```bash
hpm uninstall hemlang/sprout
```

**è¾“å‡ºï¼š**

```
Removed hemlang/sprout@2.1.0
Updated package.json
Updated package-lock.json
```

---

### hpm update

å°†åŒ…æ›´æ–°åˆ°çº¦æŸèŒƒå›´å†…çš„æœ€æ–°ç‰ˆæœ¬ã€‚

```bash
hpm update              # æ›´æ–°æ‰€æœ‰åŒ…
hpm update owner/repo   # æ›´æ–°ç‰¹å®šåŒ…
hpm up owner/repo       # ç®€å†™å½¢å¼
```

**é€‰é¡¹ï¼š**

| é€‰é¡¹ | æè¿° |
|--------|-------------|
| `--verbose` | æ˜¾ç¤ºè¯¦ç»†è¿›åº¦ |
| `--dry-run` | é¢„è§ˆè€Œä¸æ›´æ–° |

**ç¤ºä¾‹ï¼š**

```bash
# æ›´æ–°æ‰€æœ‰åŒ…
hpm update

# æ›´æ–°ç‰¹å®šåŒ…
hpm update hemlang/sprout

# é¢„è§ˆæ›´æ–°
hpm update --dry-run
```

**è¾“å‡ºï¼š**

```
Updating dependencies...
  hemlang/sprout: 2.0.0 â†’ 2.1.0
  hemlang/router: 1.4.0 â†’ 1.5.0

Updated 2 packages
```

---

### hpm list

æ˜¾ç¤ºå·²å®‰è£…çš„åŒ…ã€‚

```bash
hpm list              # æ˜¾ç¤ºå®Œæ•´ä¾èµ–æ ‘
hpm list --depth=0    # ä»…ç›´æ¥ä¾èµ–
hpm list --depth=1    # ä¸€çº§ä¼ é€’ä¾èµ–
hpm ls                # ç®€å†™å½¢å¼
```

**é€‰é¡¹ï¼š**

| é€‰é¡¹ | æè¿° |
|--------|-------------|
| `--depth=N` | é™åˆ¶æ ‘æ·±åº¦ï¼ˆé»˜è®¤ï¼šå…¨éƒ¨ï¼‰ |

**ç¤ºä¾‹ï¼š**

```bash
$ hpm list
my-project@1.0.0
â”œâ”€â”€ hemlang/sprout@2.1.0
â”‚   â”œâ”€â”€ hemlang/router@1.5.0
â”‚   â””â”€â”€ hemlang/middleware@1.2.0
â”œâ”€â”€ hemlang/json@1.2.3
â””â”€â”€ hemlang/test-utils@1.0.0 (dev)

$ hpm list --depth=0
my-project@1.0.0
â”œâ”€â”€ hemlang/sprout@2.1.0
â”œâ”€â”€ hemlang/json@1.2.3
â””â”€â”€ hemlang/test-utils@1.0.0 (dev)
```

---

### hpm outdated

æ˜¾ç¤ºæœ‰æ›´æ–°ç‰ˆæœ¬çš„åŒ…ã€‚

```bash
hpm outdated
```

**è¾“å‡ºï¼š**

```
Package            Current  Wanted  Latest
hemlang/sprout     2.0.0    2.0.5   2.1.0
hemlang/router     1.4.0    1.4.2   1.5.0
```

- **Current**ï¼šå·²å®‰è£…ç‰ˆæœ¬
- **Wanted**ï¼šç¬¦åˆçº¦æŸçš„æœ€é«˜ç‰ˆæœ¬
- **Latest**ï¼šæœ€æ–°å¯ç”¨ç‰ˆæœ¬

---

### hpm run

æ‰§è¡Œ package.json ä¸­çš„è„šæœ¬ã€‚

```bash
hpm run <script>
hpm run <script> -- <args>
```

**ç¤ºä¾‹ï¼š**

ç»™å®šä»¥ä¸‹ package.jsonï¼š

```json
{
  "scripts": {
    "start": "hemlock src/index.hml",
    "test": "hemlock test/run.hml",
    "build": "hemlock --bundle src/index.hml -o dist/app.hmlc"
  }
}
```

è¿è¡Œè„šæœ¬ï¼š

```bash
hpm run start
hpm run test
hpm run build

# å‘è„šæœ¬ä¼ é€’å‚æ•°
hpm run test -- --verbose
```

---

### hpm test

`hpm run test` çš„ç®€å†™ã€‚

```bash
hpm test
hpm test -- --verbose
```

ç­‰åŒäºï¼š

```bash
hpm run test
```

---

### hpm why

è§£é‡Šä¸ºä»€ä¹ˆå®‰è£…äº†æŸä¸ªåŒ…ï¼ˆæ˜¾ç¤ºä¾èµ–é“¾ï¼‰ã€‚

```bash
hpm why owner/repo
```

**ç¤ºä¾‹ï¼š**

```bash
$ hpm why hemlang/router

hemlang/router@1.5.0 is installed because:

my-project@1.0.0
â””â”€â”€ hemlang/sprout@2.1.0
    â””â”€â”€ hemlang/router@1.5.0
```

---

### hpm cache

ç®¡ç†å…¨å±€åŒ…ç¼“å­˜ã€‚

```bash
hpm cache list    # åˆ—å‡ºç¼“å­˜çš„åŒ…
hpm cache clean   # æ¸…é™¤æ‰€æœ‰ç¼“å­˜çš„åŒ…
```

**å­å‘½ä»¤ï¼š**

| å­å‘½ä»¤ | æè¿° |
|------------|-------------|
| `list` | æ˜¾ç¤ºæ‰€æœ‰ç¼“å­˜çš„åŒ…åŠå¤§å° |
| `clean` | ç§»é™¤æ‰€æœ‰ç¼“å­˜çš„åŒ… |

**ç¤ºä¾‹ï¼š**

```bash
$ hpm cache list
Cached packages in ~/.hpm/cache:

hemlang/sprout
  2.0.0 (1.2 MB)
  2.1.0 (1.3 MB)
hemlang/router
  1.5.0 (450 KB)

Total: 2.95 MB

$ hpm cache clean
Cleared cache (2.95 MB freed)
```

---

## å‘½ä»¤å¿«æ·æ–¹å¼

ä¸ºæ–¹ä¾¿èµ·è§ï¼Œå¤šä¸ªå‘½ä»¤æœ‰ç®€çŸ­åˆ«åï¼š

| å‘½ä»¤ | å¿«æ·æ–¹å¼ |
|---------|-----------|
| `install` | `i` |
| `uninstall` | `rm`, `remove` |
| `list` | `ls` |
| `update` | `up` |

**ç¤ºä¾‹ï¼š**

```bash
hpm i hemlang/sprout        # hpm install hemlang/sprout
hpm rm hemlang/sprout       # hpm uninstall hemlang/sprout
hpm ls                      # hpm list
hpm up                      # hpm update
```

---

## é€€å‡ºç 

hpm ä½¿ç”¨ç‰¹å®šçš„é€€å‡ºç æ¥æŒ‡ç¤ºä¸åŒçš„é”™è¯¯æ¡ä»¶ï¼š

| ä»£ç  | å«ä¹‰ |
|------|---------|
| 0 | æˆåŠŸ |
| 1 | ä¾èµ–å†²çª |
| 2 | åŒ…æœªæ‰¾åˆ° |
| 3 | ç‰ˆæœ¬æœªæ‰¾åˆ° |
| 4 | ç½‘ç»œé”™è¯¯ |
| 5 | æ— æ•ˆçš„ package.json |
| 6 | å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥ |
| 7 | è¶…å‡º GitHub é€Ÿç‡é™åˆ¶ |
| 8 | å¾ªç¯ä¾èµ– |

åœ¨è„šæœ¬ä¸­ä½¿ç”¨é€€å‡ºç ï¼š

```bash
hpm install
if [ $? -ne 0 ]; then
    echo "Installation failed"
    exit 1
fi
```

---

## ç¯å¢ƒå˜é‡

hpm æ”¯æŒä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

| å˜é‡ | æè¿° |
|----------|-------------|
| `GITHUB_TOKEN` | GitHub API token ç”¨äºè®¤è¯ |
| `HPM_CACHE_DIR` | è¦†ç›–ç¼“å­˜ç›®å½•ä½ç½® |
| `HOME` | ç”¨æˆ·ä¸»ç›®å½•ï¼ˆç”¨äºé…ç½®/ç¼“å­˜ï¼‰ |

**ç¤ºä¾‹ï¼š**

```bash
# ä½¿ç”¨ GitHub token è·å¾—æ›´é«˜çš„é€Ÿç‡é™åˆ¶
export GITHUB_TOKEN=ghp_xxxxxxxxxxxx
hpm install

# ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜ç›®å½•
export HPM_CACHE_DIR=/tmp/hpm-cache
hpm install
```

---

## å¦è¯·å‚é˜…

- [é…ç½®](#hpm-commands-configuration) - é…ç½®æ–‡ä»¶
- [åŒ…è§„èŒƒ](#hpm-commands-package-spec) - package.json æ ¼å¼
- [æ•…éšœæ’é™¤](#hpm-commands-troubleshooting) - å¸¸è§é—®é¢˜


--------------------------------------------------------------------------------
## æ•…éšœæ’é™¤
--------------------------------------------------------------------------------

# æ•…éšœæ’é™¤

å¸¸è§ hpm é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚

## å®‰è£…é—®é¢˜

### "hemlock: command not found"

**åŸå› ï¼š** Hemlock æœªå®‰è£…æˆ–ä¸åœ¨ PATH ä¸­ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# æ£€æŸ¥ hemlock æ˜¯å¦å­˜åœ¨
which hemlock

# å¦‚æœæœªæ‰¾åˆ°ï¼Œè¯·å…ˆå®‰è£… Hemlock
# è®¿é—®ï¼šhttps://github.com/hemlang/hemlock

# å®‰è£…åï¼ŒéªŒè¯
hemlock --version
```

### "hpm: command not found"

**åŸå› ï¼š** hpm æœªå®‰è£…æˆ–ä¸åœ¨ PATH ä¸­ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# æ£€æŸ¥ hpm å®‰è£…ä½ç½®
ls -la /usr/local/bin/hpm
ls -la ~/.local/bin/hpm

# å¦‚æœä½¿ç”¨è‡ªå®šä¹‰ä½ç½®ï¼Œæ·»åŠ åˆ° PATH
export PATH="$HOME/.local/bin:$PATH"

# æ·»åŠ åˆ° ~/.bashrc æˆ– ~/.zshrc ä»¥æŒä¹…åŒ–
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc

# å¦‚éœ€è¦é‡æ–°å®‰è£…
cd /path/to/hpm
sudo make install
```

### å®‰è£…æ—¶ "Permission denied"

**åŸå› ï¼š** å¯¹å®‰è£…ç›®å½•æ²¡æœ‰å†™æƒé™ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# é€‰é¡¹ 1ï¼šä½¿ç”¨ sudo è¿›è¡Œç³»ç»ŸèŒƒå›´å®‰è£…
sudo make install

# é€‰é¡¹ 2ï¼šå®‰è£…åˆ°ç”¨æˆ·ç›®å½•ï¼ˆæ— éœ€ sudoï¼‰
make install PREFIX=$HOME/.local
```

## ä¾èµ–é—®é¢˜

### "Package not found"ï¼ˆé€€å‡ºç  2ï¼‰

**åŸå› ï¼š** åŒ…åœ¨ GitHub ä¸Šä¸å­˜åœ¨ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# éªŒè¯åŒ…æ˜¯å¦å­˜åœ¨
# æ£€æŸ¥ï¼šhttps://github.com/owner/repo

# éªŒè¯æ‹¼å†™
hpm install hemlang/sprout  # æ­£ç¡®
hpm install hemlan/sprout   # é”™è¯¯çš„ owner
hpm install hemlang/spout   # é”™è¯¯çš„ repo

# æ£€æŸ¥ package.json ä¸­çš„æ‹¼å†™é”™è¯¯
cat package.json | grep -A 5 dependencies
```

### "Version not found"ï¼ˆé€€å‡ºç  3ï¼‰

**åŸå› ï¼š** æ²¡æœ‰å‘å¸ƒç‰ˆæœ¬åŒ¹é…ç‰ˆæœ¬çº¦æŸã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# åˆ—å‡ºå¯ç”¨ç‰ˆæœ¬ï¼ˆæ£€æŸ¥ GitHub releases/tagsï¼‰
# æ ‡ç­¾å¿…é¡»ä»¥ 'v' å¼€å¤´ï¼ˆä¾‹å¦‚ v1.0.0ï¼‰

# ä½¿ç”¨æœ‰æ•ˆçš„ç‰ˆæœ¬çº¦æŸ
hpm install owner/repo@^1.0.0

# å°è¯•æœ€æ–°ç‰ˆæœ¬
hpm install owner/repo

# åœ¨ GitHub ä¸Šæ£€æŸ¥å¯ç”¨æ ‡ç­¾
# https://github.com/owner/repo/tags
```

### "Dependency conflict"ï¼ˆé€€å‡ºç  1ï¼‰

**åŸå› ï¼š** ä¸¤ä¸ªåŒ…éœ€è¦ä¸å…¼å®¹ç‰ˆæœ¬çš„ä¾èµ–ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# æŸ¥çœ‹å†²çª
hpm install --verbose

# æ£€æŸ¥ä»€ä¹ˆéœ€è¦è¯¥ä¾èµ–
hpm why conflicting/package

# è§£å†³æ–¹æ¡ˆï¼š
# 1. æ›´æ–°å†²çªçš„åŒ…
hpm update problem/package

# 2. æ›´æ”¹ package.json ä¸­çš„ç‰ˆæœ¬çº¦æŸ
# ç¼–è¾‘ä»¥å…è®¸å…¼å®¹çš„ç‰ˆæœ¬

# 3. ç§»é™¤å†²çªçš„åŒ…ä¹‹ä¸€
hpm uninstall one/package
```

### "Circular dependency"ï¼ˆé€€å‡ºç  8ï¼‰

**åŸå› ï¼š** åŒ… A ä¾èµ– Bï¼ŒB åˆä¾èµ– Aã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# è¯†åˆ«å¾ªç¯
hpm install --verbose

# è¿™é€šå¸¸æ˜¯åŒ…ä¸­çš„ bug
# è”ç³»åŒ…ç»´æŠ¤è€…

# å˜é€šæ–¹æ³•ï¼šé¿å…ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªåŒ…
```

## ç½‘ç»œé—®é¢˜

### "Network error"ï¼ˆé€€å‡ºç  4ï¼‰

**åŸå› ï¼š** æ— æ³•è¿æ¥åˆ° GitHub APIã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping github.com

# æ£€æŸ¥ GitHub API æ˜¯å¦å¯è®¿é—®
curl -I https://api.github.com

# é‡è¯•ï¼ˆhpm ä¼šè‡ªåŠ¨é‡è¯•ï¼‰
hpm install

# å¦‚æœåŒ…å·²ç¼“å­˜ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼
hpm install --offline

# å¦‚æœåœ¨é˜²ç«å¢™åé¢ï¼Œæ£€æŸ¥ä»£ç†è®¾ç½®
export HTTPS_PROXY=http://proxy:8080
hpm install
```

### "GitHub rate limit exceeded"ï¼ˆé€€å‡ºç  7ï¼‰

**åŸå› ï¼š** æœªè®¤è¯æ—¶ API è¯·æ±‚è¿‡å¤šã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# é€‰é¡¹ 1ï¼šä½¿ç”¨ GitHub token è®¤è¯ï¼ˆæ¨èï¼‰
export GITHUB_TOKEN=ghp_xxxxxxxxxxxx
hpm install

# åˆ›å»º tokenï¼šGitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens

# é€‰é¡¹ 2ï¼šå°† token ä¿å­˜åœ¨é…ç½®æ–‡ä»¶ä¸­
mkdir -p ~/.hpm
echo '{"github_token": "ghp_xxxxxxxxxxxx"}' > ~/.hpm/config.json

# é€‰é¡¹ 3ï¼šç­‰å¾…é€Ÿç‡é™åˆ¶é‡ç½®ï¼ˆæ¯å°æ—¶é‡ç½®ï¼‰

# é€‰é¡¹ 4ï¼šä½¿ç”¨ç¦»çº¿æ¨¡å¼
hpm install --offline
```

### è¿æ¥è¶…æ—¶

**åŸå› ï¼š** ç½‘ç»œæ…¢æˆ– GitHub API é—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# hpm ä¼šè‡ªåŠ¨ä½¿ç”¨æŒ‡æ•°é€€é¿é‡è¯•

# æ£€æŸ¥ GitHub æ˜¯å¦æœ‰é—®é¢˜
# è®¿é—®ï¼šhttps://www.githubstatus.com

# ç¨åé‡è¯•
hpm install

# ä½¿ç”¨ç¼“å­˜çš„åŒ…
hpm install --offline
```

## Package.json é—®é¢˜

### "Invalid package.json"ï¼ˆé€€å‡ºç  5ï¼‰

**åŸå› ï¼š** æ ¼å¼é”™è¯¯æˆ–ç¼ºå°‘å¿…éœ€å­—æ®µã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# éªŒè¯ JSON è¯­æ³•
cat package.json | python -m json.tool

# æ£€æŸ¥å¿…éœ€å­—æ®µ
cat package.json

# å¿…éœ€å­—æ®µï¼š
# - "name"ï¼šowner/repo æ ¼å¼
# - "version"ï¼šX.Y.Z æ ¼å¼

# å¦‚éœ€è¦é‡æ–°ç”Ÿæˆ
rm package.json
hpm init
```

### "name" æ ¼å¼é”™è¯¯

**åŸå› ï¼š** åŒ…åç§°ä¸æ˜¯ `owner/repo` æ ¼å¼ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```json
// é”™è¯¯
{
  "name": "my-package"
}

// æ­£ç¡®
{
  "name": "yourusername/my-package"
}
```

### "version" æ ¼å¼é”™è¯¯

**åŸå› ï¼š** ç‰ˆæœ¬ä¸æ˜¯ semver æ ¼å¼ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```json
// é”™è¯¯
{
  "version": "1.0"
}

// æ­£ç¡®
{
  "version": "1.0.0"
}
```

## é”å®šæ–‡ä»¶é—®é¢˜

### é”å®šæ–‡ä»¶ä¸åŒæ­¥

**åŸå› ï¼š** package.json ä¿®æ”¹åæœªè¿è¡Œ installã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# é‡æ–°ç”Ÿæˆé”å®šæ–‡ä»¶
rm package-lock.json
hpm install
```

### é”å®šæ–‡ä»¶æŸå

**åŸå› ï¼š** æ— æ•ˆçš„ JSON æˆ–æ‰‹åŠ¨ç¼–è¾‘ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# æ£€æŸ¥ JSON æœ‰æ•ˆæ€§
cat package-lock.json | python -m json.tool

# é‡æ–°ç”Ÿæˆ
rm package-lock.json
hpm install
```

## hem_modules é—®é¢˜

### åŒ…æœªå®‰è£…

**åŸå› ï¼š** å„ç§å¯èƒ½çš„é—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# æ¸…ç†å¹¶é‡æ–°å®‰è£…
rm -rf hem_modules
hpm install

# æ£€æŸ¥è¯¦ç»†è¾“å‡º
hpm install --verbose
```

### Import ä¸å·¥ä½œ

**åŸå› ï¼š** åŒ…æœªæ­£ç¡®å®‰è£…æˆ–å¯¼å…¥è·¯å¾„é”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# éªŒè¯åŒ…å·²å®‰è£…
ls hem_modules/owner/repo/

# æ£€æŸ¥ package.json çš„ main å­—æ®µ
cat hem_modules/owner/repo/package.json

# æ­£ç¡®çš„å¯¼å…¥æ ¼å¼
import { x } from "owner/repo";          # ä½¿ç”¨ main å…¥å£
import { y } from "owner/repo/subpath";  # å­è·¯å¾„å¯¼å…¥
```

### "Module not found" é”™è¯¯

**åŸå› ï¼š** å¯¼å…¥è·¯å¾„æœªè§£æåˆ°æ–‡ä»¶ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# æ£€æŸ¥å¯¼å…¥è·¯å¾„
ls hem_modules/owner/repo/src/

# æ£€æŸ¥ index.hml
ls hem_modules/owner/repo/src/index.hml

# éªŒè¯ package.json ä¸­çš„ main å­—æ®µ
cat hem_modules/owner/repo/package.json | grep main
```

## ç¼“å­˜é—®é¢˜

### ç¼“å­˜å ç”¨å¤ªå¤šç©ºé—´

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# æŸ¥çœ‹ç¼“å­˜å¤§å°
hpm cache list

# æ¸…é™¤ç¼“å­˜
hpm cache clean
```

### ç¼“å­˜æƒé™

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# ä¿®å¤æƒé™
chmod -R u+rw ~/.hpm/cache

# æˆ–ç§»é™¤å¹¶é‡æ–°å®‰è£…
rm -rf ~/.hpm/cache
hpm install
```

### ä½¿ç”¨é”™è¯¯çš„ç¼“å­˜

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# æ£€æŸ¥ç¼“å­˜ä½ç½®
echo $HPM_CACHE_DIR
ls ~/.hpm/cache

# å¦‚æœä¸æ­£ç¡®ï¼Œæ¸…é™¤ç¯å¢ƒå˜é‡
unset HPM_CACHE_DIR
```

## è„šæœ¬é—®é¢˜

### "Script not found"

**åŸå› ï¼š** è„šæœ¬åç§°åœ¨ package.json ä¸­ä¸å­˜åœ¨ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# åˆ—å‡ºå¯ç”¨è„šæœ¬
cat package.json | grep -A 20 scripts

# æ£€æŸ¥æ‹¼å†™
hpm run test    # æ­£ç¡®
hpm run tests   # å¦‚æœè„šæœ¬åä¸º "test" åˆ™é”™è¯¯
```

### è„šæœ¬å¤±è´¥

**åŸå› ï¼š** è„šæœ¬å‘½ä»¤ä¸­æœ‰é”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# ç›´æ¥è¿è¡Œå‘½ä»¤ä»¥æŸ¥çœ‹é”™è¯¯
hemlock test/run.hml

# æ£€æŸ¥è„šæœ¬å®šä¹‰
cat package.json | grep test
```

## è°ƒè¯•

### å¯ç”¨è¯¦ç»†è¾“å‡º

```bash
hpm install --verbose
```

### æ£€æŸ¥ hpm ç‰ˆæœ¬

```bash
hpm --version
```

### æ£€æŸ¥ hemlock ç‰ˆæœ¬

```bash
hemlock --version
```

### å¹²è¿è¡Œ

é¢„è§ˆè€Œä¸è¿›è¡Œæ›´æ”¹ï¼š

```bash
hpm install --dry-run
```

### ä»å¤´å¼€å§‹

é‡æ–°å¼€å§‹ï¼š

```bash
rm -rf hem_modules package-lock.json
hpm install
```

## è·å–å¸®åŠ©

### å‘½ä»¤å¸®åŠ©

```bash
hpm --help
hpm install --help
```

### æŠ¥å‘Šé—®é¢˜

å¦‚æœé‡åˆ° bugï¼š

1. æ£€æŸ¥ç°æœ‰é—®é¢˜ï¼šhttps://github.com/hemlang/hpm/issues
2. åˆ›å»ºæ–°é—®é¢˜ï¼ŒåŒ…å«ï¼š
   - hpm ç‰ˆæœ¬ï¼ˆ`hpm --version`ï¼‰
   - Hemlock ç‰ˆæœ¬ï¼ˆ`hemlock --version`ï¼‰
   - æ“ä½œç³»ç»Ÿ
   - é‡ç°æ­¥éª¤
   - é”™è¯¯æ¶ˆæ¯ï¼ˆä½¿ç”¨ `--verbose`ï¼‰

## é€€å‡ºç å‚è€ƒ

| ä»£ç  | å«ä¹‰ | å¸¸è§è§£å†³æ–¹æ¡ˆ |
|------|---------|-----------------|
| 0 | æˆåŠŸ | - |
| 1 | ä¾èµ–å†²çª | æ›´æ–°æˆ–æ›´æ”¹çº¦æŸ |
| 2 | åŒ…æœªæ‰¾åˆ° | æ£€æŸ¥æ‹¼å†™ï¼ŒéªŒè¯ä»“åº“å­˜åœ¨ |
| 3 | ç‰ˆæœ¬æœªæ‰¾åˆ° | åœ¨ GitHub ä¸Šæ£€æŸ¥å¯ç”¨ç‰ˆæœ¬ |
| 4 | ç½‘ç»œé”™è¯¯ | æ£€æŸ¥è¿æ¥ï¼Œé‡è¯• |
| 5 | æ— æ•ˆçš„ package.json | ä¿®å¤ JSON è¯­æ³•å’Œå¿…éœ€å­—æ®µ |
| 6 | å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥ | æ¸…é™¤ç¼“å­˜ï¼Œé‡æ–°å®‰è£… |
| 7 | GitHub é€Ÿç‡é™åˆ¶ | æ·»åŠ  GITHUB_TOKEN |
| 8 | å¾ªç¯ä¾èµ– | è”ç³»åŒ…ç»´æŠ¤è€… |

## å¦è¯·å‚é˜…

- [å®‰è£…](#hpm-troubleshooting-installation) - å®‰è£…æŒ‡å—
- [é…ç½®](#hpm-troubleshooting-configuration) - é…ç½®é€‰é¡¹
- [å‘½ä»¤](#hpm-troubleshooting-commands) - å‘½ä»¤å‚è€ƒ


--------------------------------------------------------------------------------
## é…ç½®
--------------------------------------------------------------------------------

# é…ç½®

æœ¬æŒ‡å—æ¶µç›– hpm çš„æ‰€æœ‰é…ç½®é€‰é¡¹ã€‚

## æ¦‚è¿°

hpm å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼é…ç½®ï¼š

1. **ç¯å¢ƒå˜é‡** - ç”¨äºè¿è¡Œæ—¶è®¾ç½®
2. **å…¨å±€é…ç½®æ–‡ä»¶** - `~/.hpm/config.json`
3. **é¡¹ç›®æ–‡ä»¶** - `package.json` å’Œ `package-lock.json`

## ç¯å¢ƒå˜é‡

### GITHUB_TOKEN

ç”¨äºè®¤è¯çš„ GitHub API tokenã€‚

```bash
export GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxx
```

**è®¤è¯çš„å¥½å¤„ï¼š**
- æ›´é«˜çš„ API é€Ÿç‡é™åˆ¶ï¼ˆ5000 vs 60 è¯·æ±‚/å°æ—¶ï¼‰
- è®¿é—®ç§æœ‰ä»“åº“
- æ›´å¿«çš„ä¾èµ–è§£æ

**åˆ›å»º tokenï¼š**

1. å‰å¾€ GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens
2. ç‚¹å‡» "Generate new token (classic)"
3. é€‰æ‹©æƒé™èŒƒå›´ï¼š
   - `repo` - ç”¨äºç§æœ‰ä»“åº“è®¿é—®
   - `read:packages` - ç”¨äº GitHub Packagesï¼ˆå¦‚æœä½¿ç”¨ï¼‰
4. ç”Ÿæˆå¹¶å¤åˆ¶ token

### HPM_CACHE_DIR

è¦†ç›–é»˜è®¤ç¼“å­˜ç›®å½•ã€‚

```bash
export HPM_CACHE_DIR=/custom/cache/path
```

é»˜è®¤å€¼ï¼š`~/.hpm/cache`

**ä½¿ç”¨åœºæ™¯ï¼š**
- å…·æœ‰è‡ªå®šä¹‰ç¼“å­˜ä½ç½®çš„ CI/CD ç³»ç»Ÿ
- è·¨é¡¹ç›®å…±äº«ç¼“å­˜
- éš”ç¦»æ„å»ºçš„ä¸´æ—¶ç¼“å­˜

### HOME

ç”¨æˆ·ä¸»ç›®å½•ã€‚ç”¨äºå®šä½ï¼š
- é…ç½®ç›®å½•ï¼š`$HOME/.hpm/`
- ç¼“å­˜ç›®å½•ï¼š`$HOME/.hpm/cache/`

é€šå¸¸ç”±ç³»ç»Ÿè®¾ç½®ï¼›ä»…åœ¨éœ€è¦æ—¶è¦†ç›–ã€‚

### .bashrc / .zshrc ç¤ºä¾‹

```bash
# GitHub authentication (recommended)
export GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxx

# Custom cache location (optional)
# export HPM_CACHE_DIR=/path/to/cache

# Add hpm to PATH (if using custom install location)
export PATH="$HOME/.local/bin:$PATH"
```

## å…¨å±€é…ç½®æ–‡ä»¶

### ä½ç½®

`~/.hpm/config.json`

### æ ¼å¼

```json
{
  "github_token": "ghp_xxxxxxxxxxxxxxxxxxxx"
}
```

### åˆ›å»ºé…ç½®æ–‡ä»¶

```bash
# Create config directory
mkdir -p ~/.hpm

# Create config file
cat > ~/.hpm/config.json << 'EOF'
{
  "github_token": "ghp_your_token_here"
}
EOF

# Secure the file (recommended)
chmod 600 ~/.hpm/config.json
```

### Token ä¼˜å…ˆçº§

å¦‚æœä¸¤è€…éƒ½è®¾ç½®ï¼Œç¯å¢ƒå˜é‡ä¼˜å…ˆï¼š

1. `GITHUB_TOKEN` ç¯å¢ƒå˜é‡ï¼ˆæœ€é«˜ï¼‰
2. `~/.hpm/config.json` çš„ `github_token` å­—æ®µ
3. æ— è®¤è¯ï¼ˆé»˜è®¤ï¼‰

## ç›®å½•ç»“æ„

### å…¨å±€ç›®å½•

```
~/.hpm/
â”œâ”€â”€ config.json          # å…¨å±€é…ç½®
â””â”€â”€ cache/               # åŒ…ç¼“å­˜
    â””â”€â”€ owner/
        â””â”€â”€ repo/
            â””â”€â”€ 1.0.0.tar.gz
```

### é¡¹ç›®ç›®å½•

```
my-project/
â”œâ”€â”€ package.json         # é¡¹ç›®æ¸…å•
â”œâ”€â”€ package-lock.json    # ä¾èµ–é”å®šæ–‡ä»¶
â”œâ”€â”€ hem_modules/         # å·²å®‰è£…çš„åŒ…
â”‚   â””â”€â”€ owner/
â”‚       â””â”€â”€ repo/
â”‚           â”œâ”€â”€ package.json
â”‚           â””â”€â”€ src/
â”œâ”€â”€ src/                 # æºä»£ç 
â””â”€â”€ test/                # æµ‹è¯•
```

## åŒ…ç¼“å­˜

### ä½ç½®

é»˜è®¤ï¼š`~/.hpm/cache/`

ä½¿ç”¨ `HPM_CACHE_DIR` ç¯å¢ƒå˜é‡è¦†ç›–

### ç»“æ„

```
~/.hpm/cache/
â”œâ”€â”€ hemlang/
â”‚   â”œâ”€â”€ sprout/
â”‚   â”‚   â”œâ”€â”€ 2.0.0.tar.gz
â”‚   â”‚   â””â”€â”€ 2.1.0.tar.gz
â”‚   â””â”€â”€ router/
â”‚       â””â”€â”€ 1.5.0.tar.gz
â””â”€â”€ alice/
    â””â”€â”€ http-client/
        â””â”€â”€ 1.0.0.tar.gz
```

### ç®¡ç†ç¼“å­˜

```bash
# æŸ¥çœ‹ç¼“å­˜çš„åŒ…
hpm cache list

# æ¸…é™¤æ•´ä¸ªç¼“å­˜
hpm cache clean
```

### ç¼“å­˜è¡Œä¸º

- åŒ…åœ¨é¦–æ¬¡ä¸‹è½½åè¢«ç¼“å­˜
- åç»­å®‰è£…ä½¿ç”¨ç¼“å­˜ç‰ˆæœ¬
- ä½¿ç”¨ `--offline` ä»…ä»ç¼“å­˜å®‰è£…
- ç¼“å­˜åœ¨æ‰€æœ‰é¡¹ç›®é—´å…±äº«

## GitHub API é€Ÿç‡é™åˆ¶

### æ— è®¤è¯

- **æ¯å°æ—¶ 60 ä¸ªè¯·æ±‚**ï¼ŒæŒ‰ IP åœ°å€è®¡ç®—
- åœ¨åŒä¸€ IP ä¸Šçš„æ‰€æœ‰æœªè®¤è¯ç”¨æˆ·é—´å…±äº«
- åœ¨ CI/CD æˆ–æœ‰å¤šä¸ªä¾èµ–æ—¶ä¼šå¾ˆå¿«è€—å°½

### æœ‰è®¤è¯

- **æ¯å°æ—¶ 5000 ä¸ªè¯·æ±‚**ï¼ŒæŒ‰è®¤è¯ç”¨æˆ·è®¡ç®—
- ä¸ªäººé€Ÿç‡é™åˆ¶ï¼Œä¸å…±äº«

### å¤„ç†é€Ÿç‡é™åˆ¶

hpm è‡ªåŠ¨ï¼š
- ä½¿ç”¨æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆ1ç§’ã€2ç§’ã€4ç§’ã€8ç§’ï¼‰
- ä»¥é€€å‡ºç  7 æŠ¥å‘Šé€Ÿç‡é™åˆ¶é”™è¯¯
- å¦‚æœè¢«é€Ÿç‡é™åˆ¶åˆ™å»ºè®®è®¤è¯

**é€Ÿç‡é™åˆ¶æ—¶çš„è§£å†³æ–¹æ¡ˆï¼š**

```bash
# é€‰é¡¹ 1ï¼šä½¿ç”¨ GitHub token è®¤è¯
export GITHUB_TOKEN=ghp_xxxxxxxxxxxx
hpm install

# é€‰é¡¹ 2ï¼šç­‰å¾…é€Ÿç‡é™åˆ¶é‡ç½®
# ï¼ˆé™åˆ¶æ¯å°æ—¶é‡ç½®ï¼‰

# é€‰é¡¹ 3ï¼šä½¿ç”¨ç¦»çº¿æ¨¡å¼ï¼ˆå¦‚æœåŒ…å·²ç¼“å­˜ï¼‰
hpm install --offline
```

## ç¦»çº¿æ¨¡å¼

æ— ç½‘ç»œè®¿é—®æ—¶å®‰è£…åŒ…ï¼š

```bash
hpm install --offline
```

**è¦æ±‚ï¼š**
- æ‰€æœ‰åŒ…å¿…é¡»åœ¨ç¼“å­˜ä¸­
- é”å®šæ–‡ä»¶å¿…é¡»å­˜åœ¨ä¸”æœ‰ç²¾ç¡®ç‰ˆæœ¬

**ä½¿ç”¨åœºæ™¯ï¼š**
- éš”ç¦»ç½‘ç»œçš„ç¯å¢ƒ
- æ›´å¿«çš„ CI/CD æ„å»ºï¼ˆæœ‰çƒ­ç¼“å­˜ï¼‰
- é¿å…é€Ÿç‡é™åˆ¶

## CI/CD é…ç½®

### GitHub Actions

```yaml
name: CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup Hemlock
      run: |
        # Install Hemlock (adjust based on your setup)
        curl -sSL https://hemlock.dev/install.sh | sh

    - name: Cache hpm packages
      uses: actions/cache@v3
      with:
        path: ~/.hpm/cache
        key: ${{ runner.os }}-hpm-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-hpm-

    - name: Install dependencies
      run: hpm install
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Run tests
      run: hpm test
```

### GitLab CI

```yaml
stages:
  - build
  - test

variables:
  HPM_CACHE_DIR: $CI_PROJECT_DIR/.hpm-cache

cache:
  paths:
    - .hpm-cache/
  key: $CI_COMMIT_REF_SLUG

build:
  stage: build
  script:
    - hpm install
  artifacts:
    paths:
      - hem_modules/

test:
  stage: test
  script:
    - hpm test
```

### Docker

**Dockerfile:**

```dockerfile
FROM hemlock:latest

WORKDIR /app

# Copy package files first (for layer caching)
COPY package.json package-lock.json ./

# Install dependencies
RUN hpm install

# Copy source code
COPY . .

# Run application
CMD ["hemlock", "src/main.hml"]
```

**docker-compose.yml:**

```yaml
version: '3.8'

services:
  app:
    build: .
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
    volumes:
      - hpm-cache:/root/.hpm/cache

volumes:
  hpm-cache:
```

## ä»£ç†é…ç½®

å¯¹äºä»£ç†åé¢çš„ç¯å¢ƒï¼Œåœ¨ç³»ç»Ÿçº§åˆ«é…ç½®ï¼š

```bash
export HTTP_PROXY=http://proxy.example.com:8080
export HTTPS_PROXY=http://proxy.example.com:8080
export NO_PROXY=localhost,127.0.0.1

hpm install
```

## å®‰å…¨æœ€ä½³å®è·µ

### Token å®‰å…¨

1. **æ°¸è¿œä¸è¦æäº¤ token** åˆ°ç‰ˆæœ¬æ§åˆ¶
2. **åœ¨ CI/CD ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡**
3. **å°† token æƒé™èŒƒå›´é™åˆ¶**åˆ°æœ€å°éœ€è¦
4. **å®šæœŸè½®æ¢ token**
5. **ä¿æŠ¤é…ç½®æ–‡ä»¶**ï¼š
   ```bash
   chmod 600 ~/.hpm/config.json
   ```

### ç§æœ‰ä»“åº“

è¦è®¿é—®ç§æœ‰åŒ…ï¼š

1. åˆ›å»ºå…·æœ‰ `repo` æƒé™èŒƒå›´çš„ token
2. é…ç½®è®¤è¯ï¼ˆç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ï¼‰
3. ç¡®ä¿ token æœ‰ä»“åº“è®¿é—®æƒé™

```bash
# æµ‹è¯•è®¿é—®
export GITHUB_TOKEN=ghp_xxxxxxxxxxxx
hpm install yourorg/private-package
```

## é…ç½®æ•…éšœæ’é™¤

### éªŒè¯é…ç½®

```bash
# æ£€æŸ¥ token æ˜¯å¦è®¾ç½®
echo $GITHUB_TOKEN | head -c 10

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat ~/.hpm/config.json

# æ£€æŸ¥ç¼“å­˜ç›®å½•
ls -la ~/.hpm/cache/

# ä½¿ç”¨è¯¦ç»†è¾“å‡ºæµ‹è¯•
hpm install --verbose
```

### å¸¸è§é—®é¢˜

**"GitHub rate limit exceeded"**
- ä½¿ç”¨ `GITHUB_TOKEN` è®¾ç½®è®¤è¯
- ç­‰å¾…é€Ÿç‡é™åˆ¶é‡ç½®
- å¦‚æœåŒ…å·²ç¼“å­˜ï¼Œä½¿ç”¨ `--offline`

**ç¼“å­˜ä¸Šçš„ "Permission denied"**
```bash
# ä¿®å¤ç¼“å­˜æƒé™
chmod -R u+rw ~/.hpm/cache
```

**"Config file not found"**
```bash
# åˆ›å»ºé…ç½®ç›®å½•
mkdir -p ~/.hpm
touch ~/.hpm/config.json
```

## å¦è¯·å‚é˜…

- [å®‰è£…](#hpm-configuration-installation) - å®‰è£… hpm
- [æ•…éšœæ’é™¤](#hpm-configuration-troubleshooting) - å¸¸è§é—®é¢˜
- [å‘½ä»¤](#hpm-configuration-commands) - å‘½ä»¤å‚è€ƒ



################################################################################
# HPM: åŒ…å¼€å‘
################################################################################

--------------------------------------------------------------------------------
## åˆ›å»ºåŒ…
--------------------------------------------------------------------------------

# åˆ›å»ºåŒ…

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•åˆ›å»ºã€ç»„ç»‡å’Œå‘å¸ƒ Hemlock åŒ…ã€‚

## æ¦‚è¿°

hpm ä½¿ç”¨ GitHub ä½œä¸ºå…¶åŒ…æ³¨å†Œè¡¨ã€‚åŒ…é€šè¿‡å…¶ GitHub `owner/repo` è·¯å¾„æ ‡è¯†ï¼Œç‰ˆæœ¬æ˜¯ Git æ ‡ç­¾ã€‚å‘å¸ƒåªéœ€æ¨é€å¸¦æ ‡ç­¾çš„å‘å¸ƒç‰ˆæœ¬ã€‚

## åˆ›å»ºæ–°åŒ…

### 1. åˆå§‹åŒ–åŒ…

åˆ›å»ºæ–°ç›®å½•å¹¶åˆå§‹åŒ–ï¼š

```bash
mkdir my-package
cd my-package
hpm init
```

å›ç­”æç¤ºï¼š

```
Package name (owner/repo): yourusername/my-package
Version (1.0.0):
Description: A useful Hemlock package
Author: Your Name <you@example.com>
License (MIT):
Main file (src/index.hml):

Created package.json
```

### 2. åˆ›å»ºé¡¹ç›®ç»“æ„

åŒ…çš„æ¨èç»“æ„ï¼š

```
my-package/
â”œâ”€â”€ package.json          # åŒ…æ¸…å•
â”œâ”€â”€ README.md             # æ–‡æ¡£
â”œâ”€â”€ LICENSE               # è®¸å¯è¯æ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.hml         # ä¸»å…¥å£ç‚¹ï¼ˆå¯¼å‡ºå…¬å…± APIï¼‰
â”‚   â”œâ”€â”€ utils.hml         # å†…éƒ¨å·¥å…·
â”‚   â””â”€â”€ types.hml         # ç±»å‹å®šä¹‰
â””â”€â”€ test/
    â”œâ”€â”€ framework.hml     # æµ‹è¯•æ¡†æ¶
    â””â”€â”€ test_utils.hml    # æµ‹è¯•
```

### 3. å®šä¹‰ä½ çš„å…¬å…± API

**src/index.hml** - ä¸»å…¥å£ç‚¹ï¼š

```hemlock
// Re-export public API
export { parse, stringify } from "./parser.hml";
export { Config, Options } from "./types.hml";
export { process } from "./processor.hml";

// Direct exports
export fn create(options: Options): Config {
    // Implementation
}

export fn validate(config: Config): bool {
    // Implementation
}
```

### 4. ç¼–å†™ä½ çš„ package.json

å®Œæ•´çš„ package.json ç¤ºä¾‹ï¼š

```json
{
  "name": "yourusername/my-package",
  "version": "1.0.0",
  "description": "A useful Hemlock package",
  "author": "Your Name <you@example.com>",
  "license": "MIT",
  "repository": "https://github.com/yourusername/my-package",
  "main": "src/index.hml",
  "dependencies": {
    "hemlang/json": "^1.0.0"
  },
  "devDependencies": {
    "hemlang/test-utils": "^1.0.0"
  },
  "scripts": {
    "test": "hemlock test/run.hml",
    "build": "hemlock --bundle src/index.hml -o dist/bundle.hmlc"
  },
  "keywords": ["utility", "parser", "config"],
  "files": [
    "src/",
    "LICENSE",
    "README.md"
  ]
}
```

## åŒ…å‘½å

### è¦æ±‚

- å¿…é¡»æ˜¯ `owner/repo` æ ¼å¼
- `owner` åº”è¯¥æ˜¯ä½ çš„ GitHub ç”¨æˆ·åæˆ–ç»„ç»‡
- `repo` åº”è¯¥æ˜¯ä»“åº“åç§°
- å¤šè¯åç§°ä½¿ç”¨å°å†™å­—æ¯å’Œè¿å­—ç¬¦

### å¥½çš„åç§°

```
hemlang/sprout
alice/http-client
myorg/json-utils
bob/date-formatter
```

### é¿å…

```
my-package          # ç¼ºå°‘ owner
alice/MyPackage     # PascalCase
alice/my_package    # ä¸‹åˆ’çº¿
```

## åŒ…ç»“æ„æœ€ä½³å®è·µ

### å…¥å£ç‚¹

package.json ä¸­çš„ `main` å­—æ®µæŒ‡å®šå…¥å£ç‚¹ï¼š

```json
{
  "main": "src/index.hml"
}
```

æ­¤æ–‡ä»¶åº”å¯¼å‡ºä½ çš„å…¬å…± APIï¼š

```hemlock
// Export everything users need
export { Parser, parse } from "./parser.hml";
export { Formatter, format } from "./formatter.hml";

// Types
export type { Config, Options } from "./types.hml";
```

### å†…éƒ¨ä¸å…¬å…±

ä¿æŒå†…éƒ¨å®ç°ç»†èŠ‚ç§æœ‰ï¼š

```
src/
â”œâ”€â”€ index.hml          # å…¬å…±ï¼šå¯¼å‡ºçš„ API
â”œâ”€â”€ parser.hml         # å…¬å…±ï¼šè¢« index.hml ä½¿ç”¨
â”œâ”€â”€ formatter.hml      # å…¬å…±ï¼šè¢« index.hml ä½¿ç”¨
â””â”€â”€ internal/
    â”œâ”€â”€ helpers.hml    # ç§æœ‰ï¼šä»…ä¾›å†…éƒ¨ä½¿ç”¨
    â””â”€â”€ constants.hml  # ç§æœ‰ï¼šä»…ä¾›å†…éƒ¨ä½¿ç”¨
```

ç”¨æˆ·ä»ä½ çš„åŒ…æ ¹ç›®å½•å¯¼å…¥ï¼š

```hemlock
// Good - imports from public API
import { parse, Parser } from "yourusername/my-package";

// Also works - subpath import
import { validate } from "yourusername/my-package/validator";

// Discouraged - accessing internals
import { helper } from "yourusername/my-package/internal/helpers";
```

### å­è·¯å¾„å¯¼å‡º

æ”¯æŒä»å­è·¯å¾„å¯¼å…¥ï¼š

```
src/
â”œâ”€â”€ index.hml              # ä¸»å…¥å£
â”œâ”€â”€ parser/
â”‚   â””â”€â”€ index.hml          # yourusername/pkg/parser
â”œâ”€â”€ formatter/
â”‚   â””â”€â”€ index.hml          # yourusername/pkg/formatter
â””â”€â”€ utils/
    â””â”€â”€ index.hml          # yourusername/pkg/utils
```

ç”¨æˆ·å¯ä»¥å¯¼å…¥ï¼š

```hemlock
import { parse } from "yourusername/my-package";           // Main
import { Parser } from "yourusername/my-package/parser";   // Subpath
import { format } from "yourusername/my-package/formatter";
```

## ä¾èµ–

### æ·»åŠ ä¾èµ–

```bash
# è¿è¡Œæ—¶ä¾èµ–
hpm install hemlang/json

# å¼€å‘ä¾èµ–
hpm install hemlang/test-utils --dev
```

### ä¾èµ–æœ€ä½³å®è·µ

1. **å¤§å¤šæ•°ä¾èµ–ä½¿ç”¨æ’å…¥ç¬¦èŒƒå›´**ï¼š
   ```json
   {
     "dependencies": {
       "hemlang/json": "^1.0.0"
     }
   }
   ```

2. **ä»…åœ¨å¿…è¦æ—¶é”å®šç‰ˆæœ¬**ï¼ˆAPI ä¸ç¨³å®šï¼‰ï¼š
   ```json
   {
     "dependencies": {
       "unstable/lib": "1.2.3"
     }
   }
   ```

3. **é¿å…è¿‡äºä¸¥æ ¼çš„èŒƒå›´**ï¼š
   ```json
   // Bad: too restrictive
   "hemlang/json": ">=1.2.3 <1.2.5"

   // Good: allows compatible updates
   "hemlang/json": "^1.2.3"
   ```

4. **åˆ†ç¦»å¼€å‘ä¾èµ–**ï¼š
   ```json
   {
     "dependencies": {
       "hemlang/json": "^1.0.0"
     },
     "devDependencies": {
       "hemlang/test-utils": "^1.0.0"
     }
   }
   ```

## æµ‹è¯•ä½ çš„åŒ…

### ç¼–å†™æµ‹è¯•

**test/run.hml:**

```hemlock
import { suite, test, assert_eq } from "./framework.hml";
import { parse, stringify } from "../src/index.hml";

fn run_tests() {
    suite("Parser", fn() {
        test("parses valid input", fn() {
            let result = parse("hello");
            assert_eq(result.value, "hello");
        });

        test("handles empty input", fn() {
            let result = parse("");
            assert_eq(result.value, "");
        });
    });

    suite("Stringify", fn() {
        test("stringifies object", fn() {
            let obj = { name: "test" };
            let result = stringify(obj);
            assert_eq(result, '{"name":"test"}');
        });
    });
}

run_tests();
```

### è¿è¡Œæµ‹è¯•

æ·»åŠ æµ‹è¯•è„šæœ¬ï¼š

```json
{
  "scripts": {
    "test": "hemlock test/run.hml"
  }
}
```

è¿è¡Œï¼š

```bash
hpm test
```

## å‘å¸ƒ

### å‰ææ¡ä»¶

1. åˆ›å»ºä¸ä½ çš„åŒ…åç§°åŒ¹é…çš„ GitHub ä»“åº“
2. ç¡®ä¿ `package.json` å®Œæ•´æœ‰æ•ˆ
3. æ‰€æœ‰æµ‹è¯•é€šè¿‡

### å‘å¸ƒæµç¨‹

å‘å¸ƒåªéœ€æ¨é€ Git æ ‡ç­¾ï¼š

```bash
# 1. ç¡®ä¿æ‰€æœ‰å†…å®¹å·²æäº¤
git add .
git commit -m "Prepare v1.0.0 release"

# 2. åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¿…é¡»ä»¥ 'v' å¼€å¤´ï¼‰
git tag v1.0.0

# 3. æ¨é€ä»£ç å’Œæ ‡ç­¾
git push origin main
git push origin v1.0.0
# æˆ–ä¸€æ¬¡æ¨é€æ‰€æœ‰æ ‡ç­¾
git push origin main --tags
```

### ç‰ˆæœ¬æ ‡ç­¾

æ ‡ç­¾å¿…é¡»éµå¾ª `vX.Y.Z` æ ¼å¼ï¼š

```bash
git tag v1.0.0      # å‘å¸ƒç‰ˆ
git tag v1.0.1      # è¡¥ä¸
git tag v1.1.0      # æ¬¡è¦ç‰ˆæœ¬
git tag v2.0.0      # ä¸»è¦ç‰ˆæœ¬
git tag v1.0.0-beta.1  # é¢„å‘å¸ƒ
```

### å‘å¸ƒæ¸…å•

å‘å¸ƒæ–°ç‰ˆæœ¬ä¹‹å‰ï¼š

1. **æ›´æ–°** package.json ä¸­çš„ç‰ˆæœ¬
2. **è¿è¡Œæµ‹è¯•**ï¼š`hpm test`
3. **æ›´æ–° CHANGELOG**ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
4. **æ›´æ–° README**ï¼ˆå¦‚æœ API æ”¹å˜äº†ï¼‰
5. **æäº¤æ›´æ”¹**
6. **åˆ›å»ºæ ‡ç­¾**
7. **æ¨é€åˆ° GitHub**

### è‡ªåŠ¨åŒ–ç¤ºä¾‹

åˆ›å»ºå‘å¸ƒè„šæœ¬ï¼š

```bash
#!/bin/bash
# release.sh - Release a new version

VERSION=$1

if [ -z "$VERSION" ]; then
    echo "Usage: ./release.sh 1.0.0"
    exit 1
fi

# Run tests
hpm test || exit 1

# Update version in package.json
sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json

# Commit and tag
git add package.json
git commit -m "Release v$VERSION"
git tag "v$VERSION"

# Push
git push origin main --tags

echo "Released v$VERSION"
```

## ç”¨æˆ·å®‰è£…ä½ çš„åŒ…

å‘å¸ƒåï¼Œç”¨æˆ·å¯ä»¥å®‰è£…ï¼š

```bash
# æœ€æ–°ç‰ˆæœ¬
hpm install yourusername/my-package

# ç‰¹å®šç‰ˆæœ¬
hpm install yourusername/my-package@1.0.0

# ç‰ˆæœ¬çº¦æŸ
hpm install yourusername/my-package@^1.0.0
```

å¹¶å¯¼å…¥ï¼š

```hemlock
import { parse, stringify } from "yourusername/my-package";
```

## æ–‡æ¡£

### README.md

æ¯ä¸ªåŒ…éƒ½åº”è¯¥æœ‰ READMEï¼š

```markdown
# my-package

A brief description of what this package does.

## Installation

\`\`\`bash
hpm install yourusername/my-package
\`\`\`

## Usage

\`\`\`hemlock
import { parse } from "yourusername/my-package";

let result = parse("input");
\`\`\`

## API

### parse(input: string): Result

Parses the input string.

### stringify(obj: any): string

Converts object to string.

## License

MIT
```

### API æ–‡æ¡£

è®°å½•æ‰€æœ‰å…¬å…±å¯¼å‡ºï¼š

```hemlock
/// Parses the input string into a structured Result.
///
/// # Arguments
/// * `input` - The string to parse
///
/// # Returns
/// A Result containing the parsed data or an error
///
/// # Example
/// ```
/// let result = parse("hello world");
/// print(result.value);
/// ```
export fn parse(input: string): Result {
    // Implementation
}
```

## ç‰ˆæœ¬æŒ‡å—

éµå¾ª[è¯­ä¹‰åŒ–ç‰ˆæœ¬](https://semver.org/)ï¼š

- **MAJOR**ï¼ˆ1.0.0 â†’ 2.0.0ï¼‰ï¼šç ´åæ€§æ›´æ”¹
- **MINOR**ï¼ˆ1.0.0 â†’ 1.1.0ï¼‰ï¼šæ–°åŠŸèƒ½ï¼Œå‘åå…¼å®¹
- **PATCH**ï¼ˆ1.0.0 â†’ 1.0.1ï¼‰ï¼šé”™è¯¯ä¿®å¤ï¼Œå‘åå…¼å®¹

### ä½•æ—¶é€’å¢

| æ›´æ”¹ç±»å‹ | ç‰ˆæœ¬é€’å¢ |
|-------------|--------------|
| ç ´åæ€§ API æ›´æ”¹ | MAJOR |
| ç§»é™¤å‡½æ•°/ç±»å‹ | MAJOR |
| æ›´æ”¹å‡½æ•°ç­¾å | MAJOR |
| æ·»åŠ æ–°å‡½æ•° | MINOR |
| æ·»åŠ æ–°åŠŸèƒ½ | MINOR |
| é”™è¯¯ä¿®å¤ | PATCH |
| æ–‡æ¡£æ›´æ–° | PATCH |
| å†…éƒ¨é‡æ„ | PATCH |

## å¦è¯·å‚é˜…

- [åŒ…è§„èŒƒ](#hpm-creating-packages-package-spec) - å®Œæ•´çš„ package.json å‚è€ƒ
- [ç‰ˆæœ¬æ§åˆ¶](#hpm-creating-packages-versioning) - è¯­ä¹‰åŒ–ç‰ˆæœ¬è¯¦æƒ…
- [é…ç½®](#hpm-creating-packages-configuration) - GitHub è®¤è¯


--------------------------------------------------------------------------------
## åŒ…è§„èŒƒ
--------------------------------------------------------------------------------

# åŒ…è§„èŒƒ

`package.json` æ–‡ä»¶æ ¼å¼çš„å®Œæ•´å‚è€ƒã€‚

## æ¦‚è¿°

æ¯ä¸ª hpm åŒ…éƒ½éœ€è¦åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­æœ‰ä¸€ä¸ª `package.json` æ–‡ä»¶ã€‚æ­¤æ–‡ä»¶å®šä¹‰åŒ…å…ƒæ•°æ®ã€ä¾èµ–é¡¹å’Œè„šæœ¬ã€‚

## æœ€å°ç¤ºä¾‹

```json
{
  "name": "owner/repo",
  "version": "1.0.0"
}
```

## å®Œæ•´ç¤ºä¾‹

```json
{
  "name": "hemlang/example-package",
  "version": "1.2.3",
  "description": "An example Hemlock package",
  "author": "Hemlock Team <team@hemlock.dev>",
  "license": "MIT",
  "repository": "https://github.com/hemlang/example-package",
  "homepage": "https://hemlang.github.io/example-package",
  "bugs": "https://github.com/hemlang/example-package/issues",
  "main": "src/index.hml",
  "keywords": ["example", "utility", "hemlock"],
  "dependencies": {
    "hemlang/json": "^1.0.0",
    "hemlang/http": "^2.1.0"
  },
  "devDependencies": {
    "hemlang/test-utils": "^1.0.0"
  },
  "scripts": {
    "start": "hemlock src/main.hml",
    "test": "hemlock test/run.hml",
    "build": "hemlock --bundle src/main.hml -o dist/bundle.hmlc"
  },
  "files": [
    "src/",
    "LICENSE",
    "README.md"
  ],
  "native": {
    "requires": ["libcurl", "openssl"]
  }
}
```

## å­—æ®µå‚è€ƒ

### nameï¼ˆå¿…éœ€ï¼‰

`owner/repo` æ ¼å¼çš„åŒ…åç§°ã€‚

```json
{
  "name": "hemlang/sprout"
}
```

**è¦æ±‚ï¼š**
- å¿…é¡»æ˜¯ `owner/repo` æ ¼å¼
- `owner` åº”è¯¥æ˜¯ä½ çš„ GitHub ç”¨æˆ·åæˆ–ç»„ç»‡
- `repo` åº”è¯¥æ˜¯ä»“åº“åç§°
- ä½¿ç”¨å°å†™å­—æ¯ã€æ•°å­—å’Œè¿å­—ç¬¦
- æ€»å…±æœ€å¤š 214 ä¸ªå­—ç¬¦

**æœ‰æ•ˆåç§°ï¼š**
```
hemlang/sprout
alice/http-client
myorg/json-utils
bob123/my-lib
```

**æ— æ•ˆåç§°ï¼š**
```
my-package          # ç¼ºå°‘ owner
hemlang/My_Package  # å¤§å†™å’Œä¸‹åˆ’çº¿
hemlang             # ç¼ºå°‘ repo
```

### versionï¼ˆå¿…éœ€ï¼‰

éµå¾ª[è¯­ä¹‰åŒ–ç‰ˆæœ¬](https://semver.org/)çš„åŒ…ç‰ˆæœ¬ã€‚

```json
{
  "version": "1.2.3"
}
```

**æ ¼å¼ï¼š** `MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]`

**æœ‰æ•ˆç‰ˆæœ¬ï¼š**
```
1.0.0
2.1.3
1.0.0-alpha
1.0.0-beta.1
1.0.0-rc.1+build.123
0.1.0
```

### description

åŒ…çš„ç®€çŸ­æè¿°ã€‚

```json
{
  "description": "A fast JSON parser for Hemlock"
}
```

- ä¿æŒåœ¨ 200 ä¸ªå­—ç¬¦ä»¥å†…
- æè¿°åŒ…åšä»€ä¹ˆï¼Œè€Œä¸æ˜¯æ€ä¹ˆåš

### author

åŒ…ä½œè€…ä¿¡æ¯ã€‚

```json
{
  "author": "Your Name <email@example.com>"
}
```

**æ¥å—çš„æ ¼å¼ï¼š**
```json
"author": "Your Name"
"author": "Your Name <email@example.com>"
"author": "Your Name <email@example.com> (https://website.com)"
```

### license

è®¸å¯è¯æ ‡è¯†ç¬¦ã€‚

```json
{
  "license": "MIT"
}
```

**å¸¸è§è®¸å¯è¯ï¼š**
- `MIT` - MIT è®¸å¯è¯
- `Apache-2.0` - Apache è®¸å¯è¯ 2.0
- `GPL-3.0` - GNU é€šç”¨å…¬å…±è®¸å¯è¯ v3.0
- `BSD-3-Clause` - BSD 3-Clause è®¸å¯è¯
- `ISC` - ISC è®¸å¯è¯
- `UNLICENSED` - ä¸“æœ‰/ç§æœ‰

å°½å¯èƒ½ä½¿ç”¨ [SPDX æ ‡è¯†ç¬¦](https://spdx.org/licenses/)ã€‚

### repository

æºä»“åº“é“¾æ¥ã€‚

```json
{
  "repository": "https://github.com/hemlang/sprout"
}
```

### homepage

é¡¹ç›®ä¸»é¡µ URLã€‚

```json
{
  "homepage": "https://sprout.hemlock.dev"
}
```

### bugs

é—®é¢˜è·Ÿè¸ªå™¨ URLã€‚

```json
{
  "bugs": "https://github.com/hemlang/sprout/issues"
}
```

### main

åŒ…çš„å…¥å£ç‚¹æ–‡ä»¶ã€‚

```json
{
  "main": "src/index.hml"
}
```

**é»˜è®¤å€¼ï¼š** `src/index.hml`

å½“ç”¨æˆ·å¯¼å…¥ä½ çš„åŒ…æ—¶ï¼š
```hemlock
import { x } from "owner/repo";
```

hpm åŠ è½½ `main` ä¸­æŒ‡å®šçš„æ–‡ä»¶ã€‚

**å¯¼å…¥çš„è§£æé¡ºåºï¼š**
1. ç²¾ç¡®è·¯å¾„ï¼š`src/index.hml`
2. å¸¦ .hml æ‰©å±•åï¼š`src/index` â†’ `src/index.hml`
3. ç´¢å¼•æ–‡ä»¶ï¼š`src/index/` â†’ `src/index/index.hml`

### keywords

ç”¨äºå¯å‘ç°æ€§çš„å…³é”®è¯æ•°ç»„ã€‚

```json
{
  "keywords": ["json", "parser", "utility", "hemlock"]
}
```

- ä½¿ç”¨å°å†™
- å…·ä½“ä¸”ç›¸å…³
- å¦‚æœé€‚å½“ï¼ŒåŒ…å«è¯­è¨€ï¼ˆ"hemlock"ï¼‰

### dependencies

åŒ…å·¥ä½œæ‰€éœ€çš„è¿è¡Œæ—¶ä¾èµ–ã€‚

```json
{
  "dependencies": {
    "hemlang/json": "^1.0.0",
    "hemlang/http": "~2.1.0",
    "alice/logger": ">=1.0.0 <2.0.0"
  }
}
```

**é”®ï¼š** åŒ…åç§°ï¼ˆ`owner/repo`ï¼‰
**å€¼ï¼š** ç‰ˆæœ¬çº¦æŸ

**ç‰ˆæœ¬çº¦æŸè¯­æ³•ï¼š**

| çº¦æŸ | å«ä¹‰ |
|------------|---------|
| `1.2.3` | ç²¾ç¡®ç‰ˆæœ¬ |
| `^1.2.3` | >=1.2.3 <2.0.0 |
| `~1.2.3` | >=1.2.3 <1.3.0 |
| `>=1.0.0` | è‡³å°‘ 1.0.0 |
| `>=1.0.0 <2.0.0` | èŒƒå›´ |
| `*` | ä»»æ„ç‰ˆæœ¬ |

### devDependencies

ä»…ç”¨äºå¼€å‘çš„ä¾èµ–ï¼ˆæµ‹è¯•ã€æ„å»ºç­‰ï¼‰ã€‚

```json
{
  "devDependencies": {
    "hemlang/test-utils": "^1.0.0",
    "hemlang/linter": "^2.0.0"
  }
}
```

å¼€å‘ä¾èµ–æ˜¯ï¼š
- åœ¨å¼€å‘æœŸé—´å®‰è£…
- å½“åŒ…ä½œä¸ºä¾èµ–ä½¿ç”¨æ—¶ä¸å®‰è£…
- ç”¨äºæµ‹è¯•ã€æ„å»ºã€æ£€æŸ¥ç­‰

### scripts

å¯ä»¥ä½¿ç”¨ `hpm run` è¿è¡Œçš„å‘½åå‘½ä»¤ã€‚

```json
{
  "scripts": {
    "start": "hemlock src/main.hml",
    "dev": "hemlock --watch src/main.hml",
    "test": "hemlock test/run.hml",
    "test:unit": "hemlock test/unit/run.hml",
    "test:integration": "hemlock test/integration/run.hml",
    "build": "hemlock --bundle src/main.hml -o dist/app.hmlc",
    "clean": "rm -rf dist hem_modules",
    "lint": "hemlock-lint src/",
    "format": "hemlock-fmt src/"
  }
}
```

**è¿è¡Œè„šæœ¬ï¼š**
```bash
hpm run start
hpm run build
hpm test        # 'hpm run test' çš„ç®€å†™
```

**ä¼ é€’å‚æ•°ï¼š**
```bash
hpm run test -- --verbose --filter=unit
```

**å¸¸è§è„šæœ¬ï¼š**

| è„šæœ¬ | ç”¨é€” |
|--------|---------|
| `start` | å¯åŠ¨åº”ç”¨ç¨‹åº |
| `dev` | å¸¦çƒ­é‡è½½çš„å¼€å‘æ¨¡å¼ |
| `test` | è¿è¡Œæµ‹è¯• |
| `build` | ä¸ºç”Ÿäº§ç¯å¢ƒæ„å»º |
| `clean` | ç§»é™¤æ„å»ºäº§ç‰© |
| `lint` | æ£€æŸ¥ä»£ç é£æ ¼ |
| `format` | æ ¼å¼åŒ–ä»£ç  |

### files

å®‰è£…åŒ…æ—¶è¦åŒ…å«çš„æ–‡ä»¶å’Œç›®å½•ã€‚

```json
{
  "files": [
    "src/",
    "lib/",
    "LICENSE",
    "README.md"
  ]
}
```

**é»˜è®¤è¡Œä¸ºï¼š** å¦‚æœæœªæŒ‡å®šï¼ŒåŒ…å«ï¼š
- ä»“åº“ä¸­çš„æ‰€æœ‰æ–‡ä»¶
- æ’é™¤ `.git/`ã€`node_modules/`ã€`hem_modules/`

**ç”¨äºï¼š**
- å‡å°‘åŒ…å¤§å°
- ä»åˆ†å‘ä¸­æ’é™¤æµ‹è¯•æ–‡ä»¶
- ä»…åŒ…å«å¿…è¦æ–‡ä»¶

### native

åŸç”Ÿåº“è¦æ±‚ã€‚

```json
{
  "native": {
    "requires": ["libcurl", "openssl", "sqlite3"]
  }
}
```

è®°å½•å¿…é¡»åœ¨ç³»ç»Ÿä¸Šå®‰è£…çš„åŸç”Ÿä¾èµ–ã€‚

## éªŒè¯

hpm åœ¨å„ç§æ“ä½œä¸­éªŒè¯ package.jsonã€‚å¸¸è§éªŒè¯é”™è¯¯ï¼š

### ç¼ºå°‘å¿…éœ€å­—æ®µ

```
Error: package.json missing required field: name
```

**ä¿®å¤ï¼š** æ·»åŠ å¿…éœ€å­—æ®µã€‚

### æ— æ•ˆçš„åç§°æ ¼å¼

```
Error: Invalid package name. Must be in owner/repo format.
```

**ä¿®å¤ï¼š** ä½¿ç”¨ `owner/repo` æ ¼å¼ã€‚

### æ— æ•ˆçš„ç‰ˆæœ¬

```
Error: Invalid version "1.0". Must be semver format (X.Y.Z).
```

**ä¿®å¤ï¼š** ä½¿ç”¨å®Œæ•´çš„ semver æ ¼å¼ï¼ˆ`1.0.0`ï¼‰ã€‚

### æ— æ•ˆçš„ JSON

```
Error: package.json is not valid JSON
```

**ä¿®å¤ï¼š** æ£€æŸ¥ JSON è¯­æ³•ï¼ˆé€—å·ã€å¼•å·ã€æ‹¬å·ï¼‰ã€‚

## åˆ›å»º package.json

### äº¤äº’å¼

```bash
hpm init
```

äº¤äº’å¼æç¤ºæ¯ä¸ªå­—æ®µã€‚

### ä½¿ç”¨é»˜è®¤å€¼

```bash
hpm init --yes
```

ä½¿ç”¨é»˜è®¤å€¼åˆ›å»ºï¼š
```json
{
  "name": "directory-name/directory-name",
  "version": "1.0.0",
  "description": "",
  "author": "",
  "license": "MIT",
  "main": "src/index.hml",
  "dependencies": {},
  "devDependencies": {},
  "scripts": {
    "test": "hemlock test/run.hml"
  }
}
```

### æ‰‹åŠ¨

æ‰‹åŠ¨åˆ›å»ºæ–‡ä»¶ï¼š

```bash
cat > package.json << 'EOF'
{
  "name": "yourname/your-package",
  "version": "1.0.0",
  "description": "Your package description",
  "main": "src/index.hml",
  "dependencies": {},
  "scripts": {
    "test": "hemlock test/run.hml"
  }
}
EOF
```

## æœ€ä½³å®è·µ

1. **å§‹ç»ˆæŒ‡å®š main** - ä¸è¦ä¾èµ–é»˜è®¤å€¼
2. **ä½¿ç”¨æ’å…¥ç¬¦èŒƒå›´** - å¤§å¤šæ•°ä¾èµ–ä½¿ç”¨ `^1.0.0`
3. **åˆ†ç¦»å¼€å‘ä¾èµ–** - å°†æµ‹è¯•/æ„å»ºä¾èµ–æ”¾åœ¨ devDependencies ä¸­
4. **åŒ…å«å…³é”®è¯** - å¸®åŠ©ç”¨æˆ·æ‰¾åˆ°ä½ çš„åŒ…
5. **è®°å½•è„šæœ¬** - æ¸…æ™°å‘½åè„šæœ¬
6. **æŒ‡å®šè®¸å¯è¯** - å¼€æºé¡¹ç›®å¿…éœ€
7. **æ·»åŠ æè¿°** - å¸®åŠ©ç”¨æˆ·ç†è§£ç”¨é€”

## å¦è¯·å‚é˜…

- [åˆ›å»ºåŒ…](#hpm-package-spec-creating-packages) - å‘å¸ƒæŒ‡å—
- [ç‰ˆæœ¬æ§åˆ¶](#hpm-package-spec-versioning) - ç‰ˆæœ¬çº¦æŸ
- [é¡¹ç›®è®¾ç½®](#hpm-package-spec-project-setup) - é¡¹ç›®ç»“æ„


--------------------------------------------------------------------------------
## ç‰ˆæœ¬æ§åˆ¶
--------------------------------------------------------------------------------

# ç‰ˆæœ¬æ§åˆ¶

hpm ä¸­è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶çš„å®Œæ•´æŒ‡å—ã€‚

## è¯­ä¹‰åŒ–ç‰ˆæœ¬

hpm ä½¿ç”¨[è¯­ä¹‰åŒ–ç‰ˆæœ¬ 2.0.0](https://semver.org/)ï¼ˆsemverï¼‰è¿›è¡ŒåŒ…ç‰ˆæœ¬ç®¡ç†ã€‚

### ç‰ˆæœ¬æ ¼å¼

```
MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]
```

**ç¤ºä¾‹ï¼š**
```
1.0.0           # å‘å¸ƒç‰ˆæœ¬
2.1.3           # å‘å¸ƒç‰ˆæœ¬
1.0.0-alpha     # é¢„å‘å¸ƒ
1.0.0-beta.1    # å¸¦ç¼–å·çš„é¢„å‘å¸ƒ
1.0.0-rc.1      # å€™é€‰å‘å¸ƒ
1.0.0+20231201  # å¸¦æ„å»ºå…ƒæ•°æ®
1.0.0-beta+exp  # é¢„å‘å¸ƒå¸¦æ„å»ºå…ƒæ•°æ®
```

### ç‰ˆæœ¬ç»„æˆéƒ¨åˆ†

| ç»„æˆéƒ¨åˆ† | æè¿° | ç¤ºä¾‹ |
|-----------|-------------|---------|
| MAJOR | ç ´åæ€§æ›´æ”¹ | `1.0.0` â†’ `2.0.0` |
| MINOR | æ–°åŠŸèƒ½ï¼ˆå‘åå…¼å®¹ï¼‰ | `1.0.0` â†’ `1.1.0` |
| PATCH | é”™è¯¯ä¿®å¤ï¼ˆå‘åå…¼å®¹ï¼‰ | `1.0.0` â†’ `1.0.1` |
| PRERELEASE | é¢„å‘å¸ƒæ ‡è¯†ç¬¦ | `1.0.0-alpha` |
| BUILD | æ„å»ºå…ƒæ•°æ®ï¼ˆæ¯”è¾ƒæ—¶å¿½ç•¥ï¼‰ | `1.0.0+build123` |

### ä½•æ—¶é€’å¢

| æ›´æ”¹ç±»å‹ | é€’å¢ | ç¤ºä¾‹ |
|-------------|-----------|---------|
| ç ´åæ€§ API æ›´æ”¹ | MAJOR | ç§»é™¤å‡½æ•° |
| é‡å‘½åå…¬å…±å‡½æ•° | MAJOR | `parse()` â†’ `decode()` |
| æ›´æ”¹å‡½æ•°ç­¾å | MAJOR | æ·»åŠ å¿…éœ€å‚æ•° |
| æ·»åŠ æ–°å‡½æ•° | MINOR | æ·»åŠ  `validate()` |
| æ·»åŠ å¯é€‰å‚æ•° | MINOR | æ–°çš„å¯é€‰ `options` å‚æ•° |
| é”™è¯¯ä¿®å¤ | PATCH | ä¿®å¤ç©ºæŒ‡é’ˆ |
| æ€§èƒ½æ”¹è¿› | PATCH | æ›´å¿«çš„ç®—æ³• |
| å†…éƒ¨é‡æ„ | PATCH | æ—  API æ›´æ”¹ |

## ç‰ˆæœ¬çº¦æŸ

### çº¦æŸè¯­æ³•

| è¯­æ³• | å«ä¹‰ | è§£æä¸º |
|--------|---------|-------------|
| `1.2.3` | ç²¾ç¡®ç‰ˆæœ¬ | ä»… 1.2.3 |
| `^1.2.3` | æ’å…¥ç¬¦ï¼ˆå…¼å®¹ï¼‰ | â‰¥1.2.3 ä¸” <2.0.0 |
| `~1.2.3` | æ³¢æµªå·ï¼ˆè¡¥ä¸æ›´æ–°ï¼‰ | â‰¥1.2.3 ä¸” <1.3.0 |
| `>=1.0.0` | è‡³å°‘ | 1.0.0 æˆ–æ›´é«˜ |
| `>1.0.0` | å¤§äº | é«˜äº 1.0.0 |
| `<2.0.0` | å°äº | ä½äº 2.0.0 |
| `<=2.0.0` | æœ€å¤š | 2.0.0 æˆ–æ›´ä½ |
| `>=1.0.0 <2.0.0` | èŒƒå›´ | åœ¨ 1.0.0 å’Œ 2.0.0 ä¹‹é—´ |
| `*` | ä»»æ„ | ä»»æ„ç‰ˆæœ¬ |

### æ’å…¥ç¬¦èŒƒå›´ (^)

æ’å…¥ç¬¦ï¼ˆ`^`ï¼‰å…è®¸ä¸ä¿®æ”¹æœ€å·¦è¾¹éé›¶æ•°å­—çš„æ›´æ”¹ï¼š

```
^1.2.3  â†’  >=1.2.3 <2.0.0   # å…è®¸ 1.x.x
^0.2.3  â†’  >=0.2.3 <0.3.0   # å…è®¸ 0.2.x
^0.0.3  â†’  >=0.0.3 <0.0.4   # ä»…å…è®¸ 0.0.3
```

**ä½¿ç”¨åœºæ™¯ï¼š** ä½ å¸Œæœ›åœ¨ä¸»ç‰ˆæœ¬å†…è·å¾—å…¼å®¹æ›´æ–°ã€‚

**æœ€å¸¸è§çš„çº¦æŸ** - æ¨èç”¨äºå¤§å¤šæ•°ä¾èµ–ã€‚

### æ³¢æµªå·èŒƒå›´ (~)

æ³¢æµªå·ï¼ˆ`~`ï¼‰ä»…å…è®¸è¡¥ä¸çº§åˆ«çš„æ›´æ”¹ï¼š

```
~1.2.3  â†’  >=1.2.3 <1.3.0   # å…è®¸ 1.2.x
~1.2    â†’  >=1.2.0 <1.3.0   # å…è®¸ 1.2.x
~1      â†’  >=1.0.0 <2.0.0   # å…è®¸ 1.x.x
```

**ä½¿ç”¨åœºæ™¯ï¼š** ä½ åªå¸Œæœ›è·å¾—é”™è¯¯ä¿®å¤ï¼Œä¸è¦æ–°åŠŸèƒ½ã€‚

### æ¯”è¾ƒèŒƒå›´

ç»„åˆæ¯”è¾ƒè¿ç®—ç¬¦è¿›è¡Œç²¾ç¡®æ§åˆ¶ï¼š

```json
{
  "dependencies": {
    "owner/pkg": ">=1.0.0 <2.0.0",
    "owner/other": ">1.5.0 <=2.1.0"
  }
}
```

### ä»»æ„ç‰ˆæœ¬ (*)

åŒ¹é…ä»»æ„ç‰ˆæœ¬ï¼š

```json
{
  "dependencies": {
    "owner/pkg": "*"
  }
}
```

**è­¦å‘Šï¼š** ä¸æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒã€‚å°†å§‹ç»ˆè·å–æœ€æ–°ç‰ˆæœ¬ã€‚

## é¢„å‘å¸ƒç‰ˆæœ¬

### é¢„å‘å¸ƒæ ‡è¯†ç¬¦

é¢„å‘å¸ƒç‰ˆæœ¬çš„ä¼˜å…ˆçº§ä½äºæ­£å¼å‘å¸ƒç‰ˆæœ¬ï¼š

```
1.0.0-alpha < 1.0.0-alpha.1 < 1.0.0-beta < 1.0.0-rc.1 < 1.0.0
```

### å¸¸è§é¢„å‘å¸ƒæ ‡ç­¾

| æ ‡ç­¾ | å«ä¹‰ | é˜¶æ®µ |
|-----|---------|-------|
| `alpha` | æ—©æœŸå¼€å‘ | éå¸¸ä¸ç¨³å®š |
| `beta` | åŠŸèƒ½å®Œæ•´ | æµ‹è¯•ä¸­ |
| `rc` | å€™é€‰å‘å¸ƒ | æœ€ç»ˆæµ‹è¯• |
| `dev` | å¼€å‘å¿«ç…§ | ä¸ç¨³å®š |

### çº¦æŸä¸­çš„é¢„å‘å¸ƒ

çº¦æŸé»˜è®¤ä¸åŒ¹é…é¢„å‘å¸ƒç‰ˆæœ¬ï¼š

```
^1.0.0    # ä¸åŒ¹é… 1.1.0-beta
>=1.0.0   # ä¸åŒ¹é… 2.0.0-alpha
```

è¦åŒ…å«é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œè¯·æ˜ç¡®å¼•ç”¨å®ƒä»¬ï¼š

```
>=1.0.0-alpha <2.0.0   # åŒ…å«æ‰€æœ‰ 1.x é¢„å‘å¸ƒç‰ˆæœ¬
```

## ç‰ˆæœ¬æ¯”è¾ƒ

### æ¯”è¾ƒè§„åˆ™

1. æŒ‰æ•°å€¼æ¯”è¾ƒ MAJORã€MINORã€PATCH
2. å‘å¸ƒç‰ˆæœ¬ > ç›¸åŒç‰ˆæœ¬å·çš„é¢„å‘å¸ƒç‰ˆæœ¬
3. é¢„å‘å¸ƒç‰ˆæœ¬æŒ‰å­—æ¯æ•°å­—é¡ºåºæ¯”è¾ƒ
4. æ„å»ºå…ƒæ•°æ®è¢«å¿½ç•¥

### ç¤ºä¾‹

```
1.0.0 < 1.0.1 < 1.1.0 < 2.0.0

1.0.0-alpha < 1.0.0-alpha.1 < 1.0.0-beta < 1.0.0

1.0.0 = 1.0.0+build123  # æ„å»ºå…ƒæ•°æ®è¢«å¿½ç•¥
```

### æ’åº

ç‰ˆæœ¬æŒ‰å‡åºæ’åºï¼š

```
1.0.0
1.0.1
1.1.0
1.1.1
2.0.0-alpha
2.0.0-beta
2.0.0
```

## ç‰ˆæœ¬è§£æ

### è§£æç®—æ³•

å½“å¤šä¸ªåŒ…éœ€è¦åŒä¸€ä¸ªä¾èµ–æ—¶ï¼š

1. æ”¶é›†æ‰€æœ‰çº¦æŸ
2. æ‰¾åˆ°æ‰€æœ‰èŒƒå›´çš„äº¤é›†
3. é€‰æ‹©äº¤é›†ä¸­çš„æœ€é«˜ç‰ˆæœ¬
4. å¦‚æœæ²¡æœ‰ç‰ˆæœ¬æ»¡è¶³æ‰€æœ‰çº¦æŸåˆ™æŠ¥é”™

### è§£æç¤ºä¾‹

```
package-a requires hemlang/json@^1.0.0  (>=1.0.0 <2.0.0)
package-b requires hemlang/json@~1.2.0  (>=1.2.0 <1.3.0)

Intersection: >=1.2.0 <1.3.0
Available: [1.0.0, 1.1.0, 1.2.0, 1.2.1, 1.2.5, 1.3.0]
Resolved: 1.2.5 (highest in intersection)
```

### å†²çªæ£€æµ‹

å½“æ²¡æœ‰ç‰ˆæœ¬æ»¡è¶³æ‰€æœ‰çº¦æŸæ—¶å‘ç”Ÿå†²çªï¼š

```
package-a requires hemlang/json@^1.0.0  (>=1.0.0 <2.0.0)
package-b requires hemlang/json@^2.0.0  (>=2.0.0 <3.0.0)

Intersection: (empty)
Result: CONFLICT - no version satisfies both
```

## æœ€ä½³å®è·µ

### å¯¹äºåŒ…ä½¿ç”¨è€…

1. **å¤§å¤šæ•°ä¾èµ–ä½¿ç”¨æ’å…¥ç¬¦èŒƒå›´**ï¼š
   ```json
   "hemlang/json": "^1.2.0"
   ```

2. **å…³é”®ä¾èµ–ä½¿ç”¨æ³¢æµªå·èŒƒå›´**ï¼š
   ```json
   "critical/lib": "~1.2.0"
   ```

3. **ä»…åœ¨å¿…è¦æ—¶é”å®šç‰ˆæœ¬**ï¼š
   ```json
   "unstable/pkg": "1.2.3"
   ```

4. **æäº¤é”å®šæ–‡ä»¶**ä»¥å®ç°å¯é‡ç°çš„æ„å»º

5. **å®šæœŸæ›´æ–°**ä»¥è·å–å®‰å…¨ä¿®å¤ï¼š
   ```bash
   hpm update
   hpm outdated
   ```

### å¯¹äºåŒ…ä½œè€…

1. **åˆå§‹å¼€å‘ä» 0.1.0 å¼€å§‹**ï¼š
   - API å¯èƒ½é¢‘ç¹æ›´æ”¹
   - ç”¨æˆ·é¢„æœŸä¸ç¨³å®š

2. **API ç¨³å®šåå‡çº§åˆ° 1.0.0**ï¼š
   - å¯¹ç¨³å®šæ€§çš„å…¬å¼€æ‰¿è¯º
   - ç ´åæ€§æ›´æ”¹éœ€è¦é€’å¢ä¸»ç‰ˆæœ¬

3. **ä¸¥æ ¼éµå¾ª semver**ï¼š
   - ç ´åæ€§æ›´æ”¹ = MAJOR
   - æ–°åŠŸèƒ½ = MINOR
   - é”™è¯¯ä¿®å¤ = PATCH

4. **ä½¿ç”¨é¢„å‘å¸ƒç‰ˆæœ¬è¿›è¡Œæµ‹è¯•**ï¼š
   ```bash
   git tag v2.0.0-beta.1
   git push --tags
   ```

5. **åœ¨ CHANGELOG ä¸­è®°å½•ç ´åæ€§æ›´æ”¹**

## å‘å¸ƒç‰ˆæœ¬

### åˆ›å»ºå‘å¸ƒ

```bash
# Update version in package.json
# Edit package.json: "version": "1.1.0"

# Commit version change
git add package.json
git commit -m "Bump version to 1.1.0"

# Create and push tag
git tag v1.1.0
git push origin main --tags
```

### æ ‡ç­¾æ ¼å¼

æ ‡ç­¾**å¿…é¡»**ä»¥ `v` å¼€å¤´ï¼š

```
v1.0.0      âœ“ æ­£ç¡®
v1.0.0-beta âœ“ æ­£ç¡®
1.0.0       âœ— ä¸ä¼šè¢«è¯†åˆ«
```

### å‘å¸ƒå·¥ä½œæµ

```bash
# 1. Ensure tests pass
hpm test

# 2. Update version in package.json
# 3. Update CHANGELOG.md
# 4. Commit changes
git add -A
git commit -m "Release v1.2.0"

# 5. Create tag
git tag v1.2.0

# 6. Push everything
git push origin main --tags
```

## æ£€æŸ¥ç‰ˆæœ¬

### åˆ—å‡ºå·²å®‰è£…ç‰ˆæœ¬

```bash
hpm list
```

### æ£€æŸ¥æ›´æ–°

```bash
hpm outdated
```

è¾“å‡ºï¼š
```
Package         Current  Wanted  Latest
hemlang/json    1.0.0    1.0.5   1.2.0
hemlang/sprout  2.0.0    2.0.3   2.1.0
```

- **Current**ï¼šå·²å®‰è£…ç‰ˆæœ¬
- **Wanted**ï¼šç¬¦åˆçº¦æŸçš„æœ€é«˜ç‰ˆæœ¬
- **Latest**ï¼šæœ€æ–°å¯ç”¨ç‰ˆæœ¬

### æ›´æ–°åŒ…

```bash
# æ›´æ–°æ‰€æœ‰
hpm update

# æ›´æ–°ç‰¹å®šåŒ…
hpm update hemlang/json
```

## å¦è¯·å‚é˜…

- [åˆ›å»ºåŒ…](#hpm-versioning-creating-packages) - å‘å¸ƒæŒ‡å—
- [åŒ…è§„èŒƒ](#hpm-versioning-package-spec) - package.json æ ¼å¼
- [å‘½ä»¤](#hpm-versioning-commands) - CLI å‚è€ƒ



################################################################################
# HPM: å‚è€ƒ
################################################################################

--------------------------------------------------------------------------------
## æ¶æ„
--------------------------------------------------------------------------------

# æ¶æ„

hpm çš„å†…éƒ¨æ¶æ„å’Œè®¾è®¡ã€‚æœ¬æ–‡æ¡£é¢å‘è´¡çŒ®è€…å’Œæœ‰å…´è¶£äº†è§£ hpm å·¥ä½œåŸç†çš„äººã€‚

## æ¦‚è¿°

hpm ä½¿ç”¨ Hemlock ç¼–å†™ï¼Œç”±å¤šä¸ªæ¨¡å—ç»„æˆï¼Œå¤„ç†åŒ…ç®¡ç†çš„ä¸åŒæ–¹é¢ï¼š

```
src/
â”œâ”€â”€ main.hml        # CLI å…¥å£ç‚¹å’Œå‘½ä»¤è·¯ç”±
â”œâ”€â”€ manifest.hml    # package.json å¤„ç†
â”œâ”€â”€ lockfile.hml    # package-lock.json å¤„ç†
â”œâ”€â”€ semver.hml      # è¯­ä¹‰åŒ–ç‰ˆæœ¬
â”œâ”€â”€ resolver.hml    # ä¾èµ–è§£æ
â”œâ”€â”€ github.hml      # GitHub API å®¢æˆ·ç«¯
â”œâ”€â”€ installer.hml   # åŒ…ä¸‹è½½å’Œæå–
â””â”€â”€ cache.hml       # å…¨å±€ç¼“å­˜ç®¡ç†
```

## æ¨¡å—èŒè´£

### main.hml

CLI åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚

**èŒè´£ï¼š**
- è§£æå‘½ä»¤è¡Œå‚æ•°
- å°†å‘½ä»¤è·¯ç”±åˆ°é€‚å½“çš„å¤„ç†å™¨
- æ˜¾ç¤ºå¸®åŠ©å’Œç‰ˆæœ¬ä¿¡æ¯
- å¤„ç†å…¨å±€æ ‡å¿—ï¼ˆ--verboseã€--dry-run ç­‰ï¼‰
- ä»¥é€‚å½“çš„ä»£ç é€€å‡º

**å…³é”®å‡½æ•°ï¼š**
- `main()` - å…¥å£ç‚¹ï¼Œè§£æå‚æ•°å¹¶åˆ†æ´¾å‘½ä»¤
- `cmd_init()` - å¤„ç† `hpm init`
- `cmd_install()` - å¤„ç† `hpm install`
- `cmd_uninstall()` - å¤„ç† `hpm uninstall`
- `cmd_update()` - å¤„ç† `hpm update`
- `cmd_list()` - å¤„ç† `hpm list`
- `cmd_outdated()` - å¤„ç† `hpm outdated`
- `cmd_run()` - å¤„ç† `hpm run`
- `cmd_why()` - å¤„ç† `hpm why`
- `cmd_cache()` - å¤„ç† `hpm cache`

**å‘½ä»¤å¿«æ·æ–¹å¼ï¼š**
```hemlock
let shortcuts = {
    "i": "install",
    "rm": "uninstall",
    "remove": "uninstall",
    "ls": "list",
    "up": "update"
};
```

### manifest.hml

å¤„ç† `package.json` æ–‡ä»¶çš„è¯»å†™ã€‚

**èŒè´£ï¼š**
- è¯»å†™ package.json
- éªŒè¯åŒ…ç»“æ„
- ç®¡ç†ä¾èµ–
- è§£æåŒ…è¯´æ˜ç¬¦ï¼ˆowner/repo@versionï¼‰

**å…³é”®å‡½æ•°ï¼š**
```hemlock
create_default(): Manifest           // åˆ›å»ºç©ºæ¸…å•
read_manifest(): Manifest            // ä»æ–‡ä»¶è¯»å–
write_manifest(m: Manifest)          // å†™å…¥æ–‡ä»¶
validate(m: Manifest): bool          // éªŒè¯ç»“æ„
get_all_dependencies(m): Map         // è·å– deps + devDeps
add_dependency(m, pkg, ver, dev)     // æ·»åŠ ä¾èµ–
remove_dependency(m, pkg)            // ç§»é™¤ä¾èµ–
parse_specifier(spec): (name, ver)   // è§£æ "owner/repo@^1.0.0"
split_name(name): (owner, repo)      // è§£æ "owner/repo"
```

**Manifest ç»“æ„ï¼š**
```hemlock
type Manifest = {
    name: string,
    version: string,
    description: string?,
    author: string?,
    license: string?,
    repository: string?,
    main: string?,
    dependencies: Map<string, string>,
    devDependencies: Map<string, string>,
    scripts: Map<string, string>
};
```

### lockfile.hml

ç®¡ç† `package-lock.json` æ–‡ä»¶ä»¥å®ç°å¯é‡ç°çš„å®‰è£…ã€‚

**èŒè´£ï¼š**
- åˆ›å»º/è¯»å–/å†™å…¥é”å®šæ–‡ä»¶
- è·Ÿè¸ªç²¾ç¡®è§£æçš„ç‰ˆæœ¬
- å­˜å‚¨ä¸‹è½½ URL å’Œå®Œæ•´æ€§å“ˆå¸Œ
- æ¸…ç†å­¤ç«‹çš„ä¾èµ–

**å…³é”®å‡½æ•°ï¼š**
```hemlock
create_empty(): Lockfile              // åˆ›å»ºç©ºé”å®šæ–‡ä»¶
read_lockfile(): Lockfile             // ä»æ–‡ä»¶è¯»å–
write_lockfile(l: Lockfile)           // å†™å…¥æ–‡ä»¶
create_entry(ver, url, hash, deps)    // åˆ›å»ºé”å®šæ¡ç›®
get_locked(l, pkg): LockEntry?        // è·å–é”å®šç‰ˆæœ¬
set_locked(l, pkg, entry)             // è®¾ç½®é”å®šç‰ˆæœ¬
remove_locked(l, pkg)                 // ç§»é™¤æ¡ç›®
prune(l, keep: Set)                   // ç§»é™¤å­¤ç«‹é¡¹
needs_update(l, m): bool              // æ£€æŸ¥æ˜¯å¦ä¸åŒæ­¥
```

**Lockfile ç»“æ„ï¼š**
```hemlock
type Lockfile = {
    lockVersion: int,
    hemlock: string,
    dependencies: Map<string, LockEntry>
};

type LockEntry = {
    version: string,
    resolved: string,     // ä¸‹è½½ URL
    integrity: string,    // SHA256 å“ˆå¸Œ
    dependencies: Map<string, string>
};
```

### semver.hml

è¯­ä¹‰åŒ–ç‰ˆæœ¬ 2.0.0 çš„å®Œæ•´å®ç°ã€‚

**èŒè´£ï¼š**
- è§£æç‰ˆæœ¬å­—ç¬¦ä¸²
- æ¯”è¾ƒç‰ˆæœ¬
- è§£æå’Œè¯„ä¼°ç‰ˆæœ¬çº¦æŸ
- æŸ¥æ‰¾æ»¡è¶³çº¦æŸçš„ç‰ˆæœ¬

**å…³é”®å‡½æ•°ï¼š**
```hemlock
// è§£æ
parse(s: string): Version             // "1.2.3-beta+build" â†’ Version
stringify(v: Version): string         // Version â†’ "1.2.3-beta+build"

// æ¯”è¾ƒ
compare(a, b: Version): int           // -1ã€0 æˆ– 1
gt(a, b), gte(a, b), lt(a, b), lte(a, b), eq(a, b): bool

// çº¦æŸ
parse_constraint(s: string): Constraint    // "^1.2.3" â†’ Constraint
satisfies(v: Version, c: Constraint): bool // æ£€æŸ¥ v æ˜¯å¦åŒ¹é… c
max_satisfying(versions, c): Version?      // æŸ¥æ‰¾æœ€é«˜åŒ¹é…
sort(versions): [Version]                  // å‡åºæ’åº

// å·¥å…·
constraints_overlap(a, b: Constraint): bool  // æ£€æŸ¥å…¼å®¹æ€§
```

**Version ç»“æ„ï¼š**
```hemlock
type Version = {
    major: int,
    minor: int,
    patch: int,
    prerelease: [string]?,  // ä¾‹å¦‚ ["beta", "1"]
    build: string?          // ä¾‹å¦‚ "20230101"
};
```

**Constraint ç±»å‹ï¼š**
```hemlock
type Constraint =
    | Exact(Version)           // "1.2.3"
    | Caret(Version)           // "^1.2.3" â†’ >=1.2.3 <2.0.0
    | Tilde(Version)           // "~1.2.3" â†’ >=1.2.3 <1.3.0
    | Range(op, Version)       // ">=1.0.0", "<2.0.0"
    | And(Constraint, Constraint)  // ç»„åˆèŒƒå›´
    | Any;                     // "*"
```

### resolver.hml

å®ç° npm é£æ ¼çš„ä¾èµ–è§£æã€‚

**èŒè´£ï¼š**
- è§£æä¾èµ–æ ‘
- æ£€æµ‹ç‰ˆæœ¬å†²çª
- æ£€æµ‹å¾ªç¯ä¾èµ–
- æ„å»ºå¯è§†åŒ–æ ‘

**å…³é”®å‡½æ•°ï¼š**
```hemlock
resolve(manifest, lockfile): ResolveResult
    // ä¸»è§£æå™¨ï¼šè¿”å›æ‰€æœ‰ä¾èµ–åŠè§£æç‰ˆæœ¬çš„æ‰å¹³æ˜ å°„

resolve_version(pkg, constraints: [string]): ResolvedPackage?
    // æŸ¥æ‰¾æ»¡è¶³æ‰€æœ‰çº¦æŸçš„ç‰ˆæœ¬

detect_cycles(deps: Map): [Cycle]?
    // ä½¿ç”¨ DFS æŸ¥æ‰¾å¾ªç¯ä¾èµ–

build_tree(lockfile): Tree
    // åˆ›å»ºç”¨äºæ˜¾ç¤ºçš„æ ‘ç»“æ„

find_why(pkg, lockfile): [Chain]
    // æŸ¥æ‰¾è§£é‡Šä¸ºä»€ä¹ˆå®‰è£… pkg çš„ä¾èµ–é“¾
```

**è§£æç®—æ³•ï¼š**

1. **æ”¶é›†çº¦æŸ**ï¼šéå†æ¸…å•å’Œä¼ é€’ä¾èµ–
2. **è§£ææ¯ä¸ªåŒ…**ï¼šå¯¹äºæ¯ä¸ªåŒ…ï¼š
   - ä»ä¾èµ–æ–¹è·å–æ‰€æœ‰ç‰ˆæœ¬çº¦æŸ
   - ä» GitHub è·å–å¯ç”¨ç‰ˆæœ¬
   - æŸ¥æ‰¾æ»¡è¶³æ‰€æœ‰çº¦æŸçš„æœ€é«˜ç‰ˆæœ¬
   - å¦‚æœæ²¡æœ‰ç‰ˆæœ¬æ»¡è¶³æ‰€æœ‰çº¦æŸåˆ™æŠ¥é”™ï¼ˆå†²çªï¼‰
3. **æ£€æµ‹å¾ªç¯**ï¼šè¿è¡Œ DFS æŸ¥æ‰¾å¾ªç¯ä¾èµ–
4. **è¿”å›æ‰å¹³æ˜ å°„**ï¼šåŒ…å â†’ è§£æçš„ç‰ˆæœ¬ä¿¡æ¯

**ResolveResult ç»“æ„ï¼š**
```hemlock
type ResolveResult = {
    packages: Map<string, ResolvedPackage>,
    conflicts: [Conflict]?,
    cycles: [Cycle]?
};

type ResolvedPackage = {
    name: string,
    version: Version,
    url: string,
    dependencies: Map<string, string>
};
```

### github.hml

ç”¨äºåŒ…å‘ç°å’Œä¸‹è½½çš„ GitHub API å®¢æˆ·ç«¯ã€‚

**èŒè´£ï¼š**
- è·å–å¯ç”¨ç‰ˆæœ¬ï¼ˆæ ‡ç­¾ï¼‰
- ä»ä»“åº“ä¸‹è½½ package.json
- ä¸‹è½½å‘å¸ƒ tarball
- å¤„ç†è®¤è¯å’Œé€Ÿç‡é™åˆ¶

**å…³é”®å‡½æ•°ï¼š**
```hemlock
get_token(): string?
    // ä»ç¯å¢ƒæˆ–é…ç½®è·å– token

github_request(url, headers?): Response
    // å¸¦é‡è¯•çš„ API è¯·æ±‚

get_tags(owner, repo): [string]
    // è·å–ç‰ˆæœ¬æ ‡ç­¾ï¼ˆv1.0.0ã€v1.1.0 ç­‰ï¼‰

get_package_json(owner, repo, ref): Manifest
    // åœ¨ç‰¹å®šæ ‡ç­¾/æäº¤å¤„è·å– package.json

download_tarball(owner, repo, tag): bytes
    // ä¸‹è½½å‘å¸ƒå½’æ¡£

repo_exists(owner, repo): bool
    // æ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨

get_repo_info(owner, repo): RepoInfo
    // è·å–ä»“åº“å…ƒæ•°æ®
```

**é‡è¯•é€»è¾‘ï¼š**
- æŒ‡æ•°é€€é¿ï¼š1ç§’ã€2ç§’ã€4ç§’ã€8ç§’
- é‡è¯•æ¡ä»¶ï¼š403ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰ã€5xxï¼ˆæœåŠ¡å™¨é”™è¯¯ï¼‰ã€ç½‘ç»œé”™è¯¯
- æœ€å¤š 4 æ¬¡é‡è¯•
- æ¸…æ™°æŠ¥å‘Šé€Ÿç‡é™åˆ¶é”™è¯¯

**ä½¿ç”¨çš„ API ç«¯ç‚¹ï¼š**
```
GET /repos/{owner}/{repo}/tags
GET /repos/{owner}/{repo}/contents/package.json?ref={tag}
GET /repos/{owner}/{repo}/tarball/{tag}
GET /repos/{owner}/{repo}
```

### installer.hml

å¤„ç†åŒ…çš„ä¸‹è½½å’Œæå–ã€‚

**èŒè´£ï¼š**
- ä» GitHub ä¸‹è½½åŒ…
- å°† tarball æå–åˆ° hem_modules
- æ£€æŸ¥/ä½¿ç”¨ç¼“å­˜çš„åŒ…
- å®‰è£…/å¸è½½åŒ…

**å…³é”®å‡½æ•°ï¼š**
```hemlock
install_package(pkg: ResolvedPackage): bool
    // ä¸‹è½½å¹¶å®‰è£…å•ä¸ªåŒ…

install_all(packages: Map, options): InstallResult
    // å®‰è£…æ‰€æœ‰è§£æçš„åŒ…

uninstall_package(name: string): bool
    // ä» hem_modules ç§»é™¤åŒ…

get_installed(): Map<string, string>
    // åˆ—å‡ºå½“å‰å·²å®‰è£…çš„åŒ…

verify_integrity(pkg): bool
    // éªŒè¯åŒ…å®Œæ•´æ€§

prefetch_packages(packages: Map): void
    // å¹¶è¡Œä¸‹è½½åˆ°ç¼“å­˜ï¼ˆå®éªŒæ€§ï¼‰
```

**å®‰è£…è¿‡ç¨‹ï¼š**

1. æ£€æŸ¥æ˜¯å¦å·²å®‰è£…æ­£ç¡®ç‰ˆæœ¬
2. æ£€æŸ¥ç¼“å­˜ä¸­çš„ tarball
3. å¦‚æœæœªç¼“å­˜ï¼Œä» GitHub ä¸‹è½½
4. å­˜å‚¨åˆ°ç¼“å­˜ä¾›å°†æ¥ä½¿ç”¨
5. æå–åˆ° `hem_modules/owner/repo/`
6. éªŒè¯å®‰è£…

**åˆ›å»ºçš„ç›®å½•ç»“æ„ï¼š**
```
hem_modules/
â””â”€â”€ owner/
    â””â”€â”€ repo/
        â”œâ”€â”€ package.json
        â”œâ”€â”€ src/
        â””â”€â”€ ...
```

### cache.hml

ç®¡ç†å…¨å±€åŒ…ç¼“å­˜ã€‚

**èŒè´£ï¼š**
- å­˜å‚¨ä¸‹è½½çš„ tarball
- æ£€ç´¢ç¼“å­˜çš„åŒ…
- åˆ—å‡ºç¼“å­˜çš„åŒ…
- æ¸…é™¤ç¼“å­˜
- ç®¡ç†é…ç½®

**å…³é”®å‡½æ•°ï¼š**
```hemlock
get_cache_dir(): string
    // è·å–ç¼“å­˜ç›®å½•ï¼ˆå°Šé‡ HPM_CACHE_DIRï¼‰

get_config_dir(): string
    // è·å–é…ç½®ç›®å½•ï¼ˆ~/.hpmï¼‰

is_cached(owner, repo, version): bool
    // æ£€æŸ¥ tarball æ˜¯å¦å·²ç¼“å­˜

get_cached_path(owner, repo, version): string
    // è·å–ç¼“å­˜ tarball çš„è·¯å¾„

store_tarball_file(owner, repo, version, data): void
    // å°† tarball ä¿å­˜åˆ°ç¼“å­˜

list_cached(): [CachedPackage]
    // åˆ—å‡ºæ‰€æœ‰ç¼“å­˜çš„åŒ…

clear_cache(): int
    // ç§»é™¤æ‰€æœ‰ç¼“å­˜çš„åŒ…ï¼Œè¿”å›é‡Šæ”¾çš„å­—èŠ‚æ•°

get_cache_size(): int
    // è®¡ç®—ç¼“å­˜æ€»å¤§å°

read_config(): Config
    // è¯»å– ~/.hpm/config.json

write_config(c: Config): void
    // å†™å…¥é…ç½®æ–‡ä»¶
```

**ç¼“å­˜ç»“æ„ï¼š**
```
~/.hpm/
â”œâ”€â”€ config.json
â””â”€â”€ cache/
    â””â”€â”€ owner/
        â””â”€â”€ repo/
            â”œâ”€â”€ 1.0.0.tar.gz
            â””â”€â”€ 1.1.0.tar.gz
```

## æ•°æ®æµ

### Install å‘½ä»¤æµç¨‹

```
hpm install owner/repo@^1.0.0
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ main.hml â”‚ è§£æå‚æ•°ï¼Œè°ƒç”¨ cmd_install
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚manifest.hmlâ”‚ è¯»å– package.jsonï¼Œæ·»åŠ ä¾èµ–
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚resolver.hmlâ”‚ è§£ææ‰€æœ‰ä¾èµ–
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ github.hmlâ”‚    â”‚ semver.hmlâ”‚ è·å–ç‰ˆæœ¬ï¼ŒæŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„ç‰ˆæœ¬
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚installer.hmlâ”‚ ä¸‹è½½å¹¶æå–åŒ…
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ github.hmlâ”‚    â”‚ cache.hmlâ”‚ ä¸‹è½½æˆ–ä½¿ç”¨ç¼“å­˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚lockfile.hmlâ”‚ æ›´æ–° package-lock.json
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§£æç®—æ³•è¯¦æƒ…

```
è¾“å…¥ï¼šmanifest.dependenciesã€manifest.devDependenciesã€ç°æœ‰ lockfile

1. åˆå§‹åŒ–ï¼š
   - constraints = {} // Map<string, [Constraint]>
   - resolved = {}    // Map<string, ResolvedPackage>
   - queue = [ç›´æ¥ä¾èµ–]

2. å½“é˜Ÿåˆ—ä¸ä¸ºç©ºæ—¶ï¼š
   a. pkg = queue.pop()
   b. å¦‚æœ pkg å·²è§£æï¼Œè·³è¿‡
   c. ä»ä¾èµ–æ–¹è·å– pkg çš„æ‰€æœ‰çº¦æŸ
   d. ä» GitHub è·å–å¯ç”¨ç‰ˆæœ¬ï¼ˆå·²ç¼“å­˜ï¼‰
   e. æŸ¥æ‰¾æ»¡è¶³æ‰€æœ‰çº¦æŸçš„æœ€é«˜ç‰ˆæœ¬
   f. å¦‚æœæœªæ‰¾åˆ°ï¼šå†²çª
   g. resolved[pkg] = {version, url, deps}
   h. å°† pkg çš„ä¾èµ–æ·»åŠ åˆ°é˜Ÿåˆ—

3. åœ¨è§£æå›¾ä¸­æ£€æµ‹å¾ªç¯
   - å¦‚æœå‘ç°å¾ªç¯ï¼šé”™è¯¯

4. è¿”å›è§£ææ˜ å°„
```

## é”™è¯¯å¤„ç†

### é€€å‡ºç 

åœ¨ main.hml ä¸­å®šä¹‰ï¼š

```hemlock
let EXIT_SUCCESS = 0;
let EXIT_CONFLICT = 1;
let EXIT_NOT_FOUND = 2;
let EXIT_VERSION_NOT_FOUND = 3;
let EXIT_NETWORK = 4;
let EXIT_INVALID_MANIFEST = 5;
let EXIT_INTEGRITY = 6;
let EXIT_RATE_LIMIT = 7;
let EXIT_CIRCULAR = 8;
```

### é”™è¯¯ä¼ æ’­

é”™è¯¯é€šè¿‡è¿”å›å€¼å‘ä¸Šå†’æ³¡ï¼š

```hemlock
fn resolve_version(pkg): Result<Version, ResolveError> {
    let versions = github.get_tags(owner, repo)?;  // ? ä¼ æ’­é”™è¯¯
    // ...
}
```

## æµ‹è¯•

### æµ‹è¯•æ¡†æ¶

`test/framework.hml` ä¸­çš„è‡ªå®šä¹‰æµ‹è¯•æ¡†æ¶ï¼š

```hemlock
fn suite(name: string, tests: fn()) {
    print("Suite: " + name);
    tests();
}

fn test(name: string, body: fn()) {
    try {
        body();
        print("  âœ“ " + name);
    } catch e {
        print("  âœ— " + name + ": " + e);
        failed += 1;
    }
}

fn assert_eq<T>(actual: T, expected: T) {
    if actual != expected {
        throw "Expected " + expected + ", got " + actual;
    }
}
```

### æµ‹è¯•æ–‡ä»¶

- `test/test_semver.hml` - ç‰ˆæœ¬è§£æã€æ¯”è¾ƒã€çº¦æŸ
- `test/test_manifest.hml` - æ¸…å•è¯»å†™ã€éªŒè¯
- `test/test_lockfile.hml` - é”å®šæ–‡ä»¶æ“ä½œ
- `test/test_cache.hml` - ç¼“å­˜ç®¡ç†

### è¿è¡Œæµ‹è¯•

```bash
# æ‰€æœ‰æµ‹è¯•
make test

# ç‰¹å®šæµ‹è¯•
make test-semver
make test-manifest
make test-lockfile
make test-cache
```

## æœªæ¥æ”¹è¿›

### è®¡åˆ’åŠŸèƒ½

1. **å®Œæ•´æ€§éªŒè¯** - å®Œæ•´çš„ SHA256 å“ˆå¸Œæ£€æŸ¥
2. **å·¥ä½œåŒº** - Monorepo æ”¯æŒ
3. **æ’ä»¶ç³»ç»Ÿ** - å¯æ‰©å±•å‘½ä»¤
4. **å®¡è®¡** - å®‰å…¨æ¼æ´æ£€æŸ¥
5. **ç§æœ‰æ³¨å†Œè¡¨** - è‡ªæ‰˜ç®¡åŒ…æ‰˜ç®¡

### å·²çŸ¥é™åˆ¶

1. **æ‰“åŒ…å™¨ bug** - æ— æ³•åˆ›å»ºç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶
2. **å¹¶è¡Œä¸‹è½½** - å®éªŒæ€§ï¼Œå¯èƒ½æœ‰ç«æ€æ¡ä»¶
3. **å®Œæ•´æ€§** - SHA256 æœªå®Œå…¨å®ç°

## è´¡çŒ®

### ä»£ç é£æ ¼

- ä½¿ç”¨ 4 ç©ºæ ¼ç¼©è¿›
- å‡½æ•°åº”è¯¥åªåšä¸€ä»¶äº‹
- æ³¨é‡Šå¤æ‚é€»è¾‘
- ä¸ºæ–°åŠŸèƒ½ç¼–å†™æµ‹è¯•

### æ·»åŠ å‘½ä»¤

1. åœ¨ `main.hml` ä¸­æ·»åŠ å¤„ç†å™¨ï¼š
   ```hemlock
   fn cmd_newcmd(args: [string]) {
       // Implementation
   }
   ```

2. æ·»åŠ åˆ°å‘½ä»¤åˆ†æ´¾ï¼š
   ```hemlock
   match command {
       "newcmd" => cmd_newcmd(args),
       // ...
   }
   ```

3. æ›´æ–°å¸®åŠ©æ–‡æœ¬

### æ·»åŠ æ¨¡å—

1. åˆ›å»º `src/newmodule.hml`
2. å¯¼å‡ºå…¬å…±æ¥å£
3. åœ¨éœ€è¦å®ƒçš„æ¨¡å—ä¸­å¯¼å…¥
4. åœ¨ `test/test_newmodule.hml` ä¸­æ·»åŠ æµ‹è¯•

## å¦è¯·å‚é˜…

- [å‘½ä»¤](#hpm-architecture-commands) - CLI å‚è€ƒ
- [åˆ›å»ºåŒ…](#hpm-architecture-creating-packages) - åŒ…å¼€å‘
- [ç‰ˆæœ¬æ§åˆ¶](#hpm-architecture-versioning) - è¯­ä¹‰åŒ–ç‰ˆæœ¬


--------------------------------------------------------------------------------
## é€€å‡ºç 
--------------------------------------------------------------------------------

# é€€å‡ºç 

hpm é€€å‡ºç åŠå…¶å«ä¹‰çš„å‚è€ƒã€‚

## é€€å‡ºç è¡¨

| ä»£ç  | åç§° | æè¿° |
|------|------|-------------|
| 0 | SUCCESS | å‘½ä»¤æˆåŠŸå®Œæˆ |
| 1 | CONFLICT | ä¾èµ–ç‰ˆæœ¬å†²çª |
| 2 | NOT_FOUND | åŒ…æœªæ‰¾åˆ° |
| 3 | VERSION_NOT_FOUND | è¯·æ±‚çš„ç‰ˆæœ¬æœªæ‰¾åˆ° |
| 4 | NETWORK | ç½‘ç»œé”™è¯¯ |
| 5 | INVALID_MANIFEST | æ— æ•ˆçš„ package.json |
| 6 | INTEGRITY | å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥ |
| 7 | RATE_LIMIT | è¶…å‡º GitHub API é€Ÿç‡é™åˆ¶ |
| 8 | CIRCULAR | æ£€æµ‹åˆ°å¾ªç¯ä¾èµ– |

## è¯¦ç»†æè¿°

### é€€å‡ºç  0: SUCCESS

å‘½ä»¤æˆåŠŸå®Œæˆã€‚

```bash
$ hpm install
Installed 5 packages
$ echo $?
0
```

### é€€å‡ºç  1: CONFLICT

ä¸¤ä¸ªæˆ–å¤šä¸ªåŒ…éœ€è¦ä¸å…¼å®¹ç‰ˆæœ¬çš„ä¾èµ–ã€‚

**ç¤ºä¾‹ï¼š**
```
Error: Dependency conflict for hemlang/json

  package-a requires hemlang/json@^1.0.0 (>=1.0.0 <2.0.0)
  package-b requires hemlang/json@^2.0.0 (>=2.0.0 <3.0.0)

No version satisfies all constraints.
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥å“ªäº›åŒ…æœ‰å†²çªï¼š
   ```bash
   hpm why hemlang/json
   ```
2. æ›´æ–°å†²çªçš„åŒ…ï¼š
   ```bash
   hpm update package-a
   ```
3. æ”¾å®½ package.json ä¸­çš„ç‰ˆæœ¬çº¦æŸ
4. ç§»é™¤å†²çªçš„åŒ…ä¹‹ä¸€

### é€€å‡ºç  2: NOT_FOUND

æŒ‡å®šçš„åŒ…åœ¨ GitHub ä¸Šä¸å­˜åœ¨ã€‚

**ç¤ºä¾‹ï¼š**
```
Error: Package not found: hemlang/nonexistent

The repository hemlang/nonexistent does not exist on GitHub.
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. éªŒè¯åŒ…åç§°æ‹¼å†™
2. æ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨ï¼š`https://github.com/owner/repo`
3. éªŒè¯ä½ æœ‰è®¿é—®æƒé™ï¼ˆå¯¹äºç§æœ‰ä»“åº“ï¼Œè®¾ç½® GITHUB_TOKENï¼‰

### é€€å‡ºç  3: VERSION_NOT_FOUND

æ²¡æœ‰ç‰ˆæœ¬åŒ¹é…æŒ‡å®šçš„çº¦æŸã€‚

**ç¤ºä¾‹ï¼š**
```
Error: No version of hemlang/json matches constraint ^5.0.0

Available versions: 1.0.0, 1.1.0, 1.2.0, 2.0.0
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. åœ¨ GitHub releases/tags ä¸Šæ£€æŸ¥å¯ç”¨ç‰ˆæœ¬
2. ä½¿ç”¨æœ‰æ•ˆçš„ç‰ˆæœ¬çº¦æŸ
3. ç‰ˆæœ¬æ ‡ç­¾å¿…é¡»ä»¥ 'v' å¼€å¤´ï¼ˆä¾‹å¦‚ `v1.0.0`ï¼‰

### é€€å‡ºç  4: NETWORK

å‘ç”Ÿç½‘ç»œç›¸å…³é”™è¯¯ã€‚

**ç¤ºä¾‹ï¼š**
```
Error: Network error: could not connect to api.github.com

Please check your internet connection and try again.
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. æ£€æŸ¥ GitHub æ˜¯å¦å¯è®¿é—®
3. å¦‚æœåœ¨é˜²ç«å¢™åé¢ï¼ŒéªŒè¯ä»£ç†è®¾ç½®
4. å¦‚æœåŒ…å·²ç¼“å­˜ï¼Œä½¿ç”¨ `--offline`ï¼š
   ```bash
   hpm install --offline
   ```
5. ç­‰å¾…å¹¶é‡è¯•ï¼ˆhpm ä¼šè‡ªåŠ¨é‡è¯•ï¼‰

### é€€å‡ºç  5: INVALID_MANIFEST

package.json æ–‡ä»¶æ— æ•ˆæˆ–æ ¼å¼é”™è¯¯ã€‚

**ç¤ºä¾‹ï¼š**
```
Error: Invalid package.json

  - Missing required field: name
  - Invalid version format: "1.0"
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ JSON è¯­æ³•ï¼ˆä½¿ç”¨ JSON éªŒè¯å™¨ï¼‰
2. ç¡®ä¿å¿…éœ€å­—æ®µå­˜åœ¨ï¼ˆ`name`ã€`version`ï¼‰
3. éªŒè¯å­—æ®µæ ¼å¼ï¼š
   - nameï¼š`owner/repo` æ ¼å¼
   - versionï¼š`X.Y.Z` semver æ ¼å¼
4. é‡æ–°ç”Ÿæˆï¼š
   ```bash
   rm package.json
   hpm init
   ```

### é€€å‡ºç  6: INTEGRITY

åŒ…å®Œæ•´æ€§éªŒè¯å¤±è´¥ã€‚

**ç¤ºä¾‹ï¼š**
```
Error: Integrity check failed for hemlang/json@1.0.0

Expected: sha256-abc123...
Actual:   sha256-def456...

The downloaded package may be corrupted.
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°å®‰è£…ï¼š
   ```bash
   hpm cache clean
   hpm install
   ```
2. æ£€æŸ¥ç½‘ç»œé—®é¢˜ï¼ˆéƒ¨åˆ†ä¸‹è½½ï¼‰
3. éªŒè¯åŒ…æœªè¢«ç¯¡æ”¹

### é€€å‡ºç  7: RATE_LIMIT

è¶…å‡º GitHub API é€Ÿç‡é™åˆ¶ã€‚

**ç¤ºä¾‹ï¼š**
```
Error: GitHub API rate limit exceeded

Unauthenticated rate limit: 60 requests/hour
Current usage: 60/60

Rate limit resets at: 2024-01-15 10:30:00 UTC
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. **ä½¿ç”¨ GitHub è®¤è¯**ï¼ˆæ¨èï¼‰ï¼š
   ```bash
   export GITHUB_TOKEN=ghp_xxxxxxxxxxxx
   hpm install
   ```
2. ç­‰å¾…é€Ÿç‡é™åˆ¶é‡ç½®ï¼ˆæ¯å°æ—¶é‡ç½®ï¼‰
3. å¦‚æœåŒ…å·²ç¼“å­˜ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼ï¼š
   ```bash
   hpm install --offline
   ```

### é€€å‡ºç  8: CIRCULAR

åœ¨ä¾èµ–å›¾ä¸­æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–ã€‚

**ç¤ºä¾‹ï¼š**
```
Error: Circular dependency detected

  package-a@1.0.0
  â””â”€â”€ package-b@1.0.0
      â””â”€â”€ package-a@1.0.0  (circular!)

Cannot resolve dependency tree.
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. è¿™é€šå¸¸æ˜¯åŒ…æœ¬èº«çš„ bug
2. è”ç³»åŒ…ç»´æŠ¤è€…
3. é¿å…ä½¿ç”¨å¾ªç¯åŒ…ä¹‹ä¸€

## åœ¨è„šæœ¬ä¸­ä½¿ç”¨é€€å‡ºç 

### Bash

```bash
#!/bin/bash

hpm install
exit_code=$?

case $exit_code in
  0)
    echo "Installation successful"
    ;;
  1)
    echo "Dependency conflict - check version constraints"
    exit 1
    ;;
  2)
    echo "Package not found - check package name"
    exit 1
    ;;
  4)
    echo "Network error - check connection"
    exit 1
    ;;
  7)
    echo "Rate limited - set GITHUB_TOKEN"
    exit 1
    ;;
  *)
    echo "Unknown error: $exit_code"
    exit 1
    ;;
esac
```

### CI/CD

```yaml
# GitHub Actions
- name: Install dependencies
  run: |
    hpm install
    if [ $? -eq 7 ]; then
      echo "::error::GitHub rate limit exceeded. Add GITHUB_TOKEN."
      exit 1
    fi
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### Make

```makefile
install:
	@hpm install || (echo "Installation failed with code $$?"; exit 1)

test: install
	@hpm test
```

## æŒ‰é€€å‡ºç æ•…éšœæ’é™¤

### å¿«é€Ÿå‚è€ƒ

| ä»£ç  | é¦–å…ˆæ£€æŸ¥ |
|------|---------------------|
| 1 | è¿è¡Œ `hpm why <package>` æŸ¥çœ‹å†²çª |
| 2 | åœ¨ GitHub ä¸ŠéªŒè¯åŒ…åç§° |
| 3 | åœ¨ GitHub æ ‡ç­¾ä¸Šæ£€æŸ¥å¯ç”¨ç‰ˆæœ¬ |
| 4 | æ£€æŸ¥ç½‘ç»œè¿æ¥ |
| 5 | éªŒè¯ package.json è¯­æ³• |
| 6 | è¿è¡Œ `hpm cache clean && hpm install` |
| 7 | è®¾ç½® `GITHUB_TOKEN` ç¯å¢ƒå˜é‡ |
| 8 | è”ç³»åŒ…ç»´æŠ¤è€… |

## å¦è¯·å‚é˜…

- [æ•…éšœæ’é™¤](#hpm-exit-codes-troubleshooting) - è¯¦ç»†è§£å†³æ–¹æ¡ˆ
- [å‘½ä»¤](#hpm-exit-codes-commands) - å‘½ä»¤å‚è€ƒ
- [é…ç½®](#hpm-exit-codes-configuration) - è®¾ç½® GitHub token



================================================================================
END OF DOCUMENTATION
================================================================================