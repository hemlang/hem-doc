// Hemlock Documentation Server
// Serves the docs.html and llms.txt files using Sprout

import { App } from "hemlang/sprout";
import { read_file } from "@stdlib/fs";

// Supported languages for documentation (excluding English which is the default)
let non_english_langs = ["de", "es", "fr", "ja", "pt", "zh"];

// Language display names for logging
let lang_names = {
    de: "German",
    es: "Spanish",
    fr: "French",
    ja: "Japanese",
    pt: "Portuguese",
    zh: "Chinese"
};

// Read the docs HTML at startup (English is required)
let docs_html = read_file("docs.html");
if (docs_html == null) {
    print("Error: docs.html not found");
    print("Run this from the hem-doc directory");
    exit(1);
}

// Read language-specific documentation files into objects
let docs = {};
let llms = {};

for (let lang in non_english_langs) {
    let doc_file = read_file("docs-" + lang + ".html");
    if (doc_file == null) {
        print("Warning: docs-" + lang + ".html not found, " + lang_names[lang] + " docs will fall back to English");
    }
    docs[lang] = doc_file;

    let llm_file = read_file("llms-" + lang + ".txt");
    if (llm_file == null) {
        print("Warning: llms-" + lang + ".txt not found, " + lang_names[lang] + " LLM docs will fall back to English");
    }
    llms[lang] = llm_file;
}

// Read the LLM-friendly documentation at startup
let llms_txt = read_file("llms.txt");
if (llms_txt == null) {
    print("Warning: llms.txt not found, /llms.txt endpoint will be unavailable");
}

let app = App(null);

// Serve the documentation (English at root and /docs.html)
app.get("/", fn(req, res, next) {
    res.type("html").send(docs_html);
});

app.get("/docs.html", fn(req, res, next) {
    res.type("html").send(docs_html);
});

// Serve language-specific documentation
app.get("/docs-de.html", fn(req, res, next) {
    if (docs["de"] != null) {
        res.type("html").send(docs["de"]);
    } else {
        res.type("html").send(docs_html);
    }
});

app.get("/docs-es.html", fn(req, res, next) {
    if (docs["es"] != null) {
        res.type("html").send(docs["es"]);
    } else {
        res.type("html").send(docs_html);
    }
});

app.get("/docs-fr.html", fn(req, res, next) {
    if (docs["fr"] != null) {
        res.type("html").send(docs["fr"]);
    } else {
        res.type("html").send(docs_html);
    }
});

app.get("/docs-ja.html", fn(req, res, next) {
    if (docs["ja"] != null) {
        res.type("html").send(docs["ja"]);
    } else {
        res.type("html").send(docs_html);
    }
});

app.get("/docs-pt.html", fn(req, res, next) {
    if (docs["pt"] != null) {
        res.type("html").send(docs["pt"]);
    } else {
        res.type("html").send(docs_html);
    }
});

app.get("/docs-zh.html", fn(req, res, next) {
    if (docs["zh"] != null) {
        res.type("html").send(docs["zh"]);
    } else {
        res.type("html").send(docs_html);
    }
});

// Serve LLM-friendly documentation
app.get("/llms.txt", fn(req, res, next) {
    if (llms_txt == null) {
        res.status(404).type("text").send("llms.txt not found. Run 'make docs' to generate it.");
    } else {
        res.type("text").send(llms_txt);
    }
});

// Serve language-specific LLM documentation
app.get("/llms-de.txt", fn(req, res, next) {
    if (llms["de"] != null) {
        res.type("text").send(llms["de"]);
    } else if (llms_txt != null) {
        res.type("text").send(llms_txt);
    } else {
        res.status(404).type("text").send("llms-de.txt not found. Run 'make docs' to generate it.");
    }
});

app.get("/llms-es.txt", fn(req, res, next) {
    if (llms["es"] != null) {
        res.type("text").send(llms["es"]);
    } else if (llms_txt != null) {
        res.type("text").send(llms_txt);
    } else {
        res.status(404).type("text").send("llms-es.txt not found. Run 'make docs' to generate it.");
    }
});

app.get("/llms-fr.txt", fn(req, res, next) {
    if (llms["fr"] != null) {
        res.type("text").send(llms["fr"]);
    } else if (llms_txt != null) {
        res.type("text").send(llms_txt);
    } else {
        res.status(404).type("text").send("llms-fr.txt not found. Run 'make docs' to generate it.");
    }
});

app.get("/llms-ja.txt", fn(req, res, next) {
    if (llms["ja"] != null) {
        res.type("text").send(llms["ja"]);
    } else if (llms_txt != null) {
        res.type("text").send(llms_txt);
    } else {
        res.status(404).type("text").send("llms-ja.txt not found. Run 'make docs' to generate it.");
    }
});

app.get("/llms-pt.txt", fn(req, res, next) {
    if (llms["pt"] != null) {
        res.type("text").send(llms["pt"]);
    } else if (llms_txt != null) {
        res.type("text").send(llms_txt);
    } else {
        res.status(404).type("text").send("llms-pt.txt not found. Run 'make docs' to generate it.");
    }
});

app.get("/llms-zh.txt", fn(req, res, next) {
    if (llms["zh"] != null) {
        res.type("text").send(llms["zh"]);
    } else if (llms_txt != null) {
        res.type("text").send(llms_txt);
    } else {
        res.status(404).type("text").send("llms-zh.txt not found. Run 'make docs' to generate it.");
    }
});

// Health check endpoint
app.get("/health", fn(req, res, next) {
    res.json({
        status: "ok",
        docs_size: docs_html.length,
        docs_de_size: docs["de"] != null ? docs["de"].length : 0,
        docs_es_size: docs["es"] != null ? docs["es"].length : 0,
        docs_fr_size: docs["fr"] != null ? docs["fr"].length : 0,
        docs_ja_size: docs["ja"] != null ? docs["ja"].length : 0,
        docs_pt_size: docs["pt"] != null ? docs["pt"].length : 0,
        docs_zh_size: docs["zh"] != null ? docs["zh"].length : 0,
        llms_size: llms_txt != null ? llms_txt.length : 0,
        llms_de_size: llms["de"] != null ? llms["de"].length : 0,
        llms_es_size: llms["es"] != null ? llms["es"].length : 0,
        llms_fr_size: llms["fr"] != null ? llms["fr"].length : 0,
        llms_ja_size: llms["ja"] != null ? llms["ja"].length : 0,
        llms_pt_size: llms["pt"] != null ? llms["pt"].length : 0,
        llms_zh_size: llms["zh"] != null ? llms["zh"].length : 0
    });
});

// Serve on port 5169
let port = 5169;

app.listen(port, fn() {
    print("Hemlock Documentation Server");
    print("Serving docs at http://localhost:" + port);
    print("  English:    http://localhost:" + port + "/");
    print("  German:     http://localhost:" + port + "/docs-de.html");
    print("  Spanish:    http://localhost:" + port + "/docs-es.html");
    print("  French:     http://localhost:" + port + "/docs-fr.html");
    print("  Japanese:   http://localhost:" + port + "/docs-ja.html");
    print("  Portuguese: http://localhost:" + port + "/docs-pt.html");
    print("  Chinese:    http://localhost:" + port + "/docs-zh.html");
    print("LLM docs:");
    print("  English:    http://localhost:" + port + "/llms.txt");
    print("  German:     http://localhost:" + port + "/llms-de.txt");
    print("  Spanish:    http://localhost:" + port + "/llms-es.txt");
    print("  French:     http://localhost:" + port + "/llms-fr.txt");
    print("  Japanese:   http://localhost:" + port + "/llms-ja.txt");
    print("  Portuguese: http://localhost:" + port + "/llms-pt.txt");
    print("  Chinese:    http://localhost:" + port + "/llms-zh.txt");
});
