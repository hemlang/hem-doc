# Профилирование

Hemlock включает встроенный профайлер для **анализа времени CPU**, **отслеживания памяти** и **обнаружения утечек**. Профайлер помогает выявлять узкие места производительности и проблемы с памятью в ваших программах.

## Содержание

- [Обзор](#обзор)
- [Быстрый старт](#быстрый-старт)
- [Режимы профилирования](#режимы-профилирования)
- [Форматы вывода](#форматы-вывода)
- [Обнаружение утечек](#обнаружение-утечек)
- [Понимание отчётов](#понимание-отчётов)
- [Генерация Flamegraph](#генерация-flamegraph)
- [Лучшие практики](#лучшие-практики)

---

## Обзор

Профайлер доступен через подкоманду `profile`:

```bash
hemlock profile [OPTIONS] <FILE>
```

**Ключевые возможности:**
- **Профилирование CPU** - Измерение времени, проведённого в каждой функции (собственное время и общее время)
- **Профилирование памяти** - Отслеживание всех выделений с указанием местоположения в исходном коде
- **Обнаружение утечек** - Выявление памяти, которая никогда не была освобождена
- **Несколько форматов вывода** - Текст, JSON и формат, совместимый с flamegraph
- **Статистика памяти по функциям** - Показывает, какие функции выделяют больше всего памяти

---

## Быстрый старт

### Профилирование времени CPU (по умолчанию)

```bash
hemlock profile script.hml
```

### Профилирование выделений памяти

```bash
hemlock profile --memory script.hml
```

### Обнаружение утечек памяти

```bash
hemlock profile --leaks script.hml
```

### Генерация данных для flamegraph

```bash
hemlock profile --flamegraph script.hml > profile.folded
flamegraph.pl profile.folded > profile.svg
```

---

## Режимы профилирования

### Профилирование CPU (по умолчанию)

Измеряет время, проведённое в каждой функции, различая:
- **Собственное время** - Время, затраченное на выполнение собственного кода функции
- **Общее время** - Собственное время плюс время в вызываемых функциях

```bash
hemlock profile script.hml
hemlock profile --cpu script.hml  # Явно
```

**Пример вывода:**
```
=== Отчёт профайлера Hemlock ===

Общее время: 1.234мс
Вызвано функций: 5 уникальных

--- Топ 5 по собственному времени ---

Функция                         Собств.   Общее    Вызовы
--------                        ------    -----    ------
expensive_calc              0.892мс    0.892мс     100  (72.3%)
process_data                0.234мс    1.126мс      10  (19.0%)
helper                      0.067мс    0.067мс     500  (5.4%)
main                        0.041мс    1.234мс       1  (3.3%)
```

---

### Профилирование памяти

Отслеживает все выделения памяти (`alloc`, `buffer`, `talloc`, `realloc`) с указанием местоположения в исходном коде.

```bash
hemlock profile --memory script.hml
```

**Пример вывода:**
```
=== Отчёт профайлера Hemlock ===

Общее время: 0.543мс
Вызвано функций: 3 уникальных
Всего выделений: 15 (4.2KB)

--- Топ 3 по собственному времени ---

Функция                         Собств.   Общее    Вызовы     Выдел.     Кол-во
--------                        ------    -----    ------     ------     ------
allocator                   0.312мс    0.312мс      10      3.2KB         10  (57.5%)
buffer_ops                  0.156мс    0.156мс       5       1KB          5  (28.7%)
main                        0.075мс    0.543мс       1        0B          0  (13.8%)

--- Топ 10 мест выделения ---

Местоположение                                Всего    Кол-во
----------                                    -----    ------
src/data.hml:42                               1.5KB        5
src/data.hml:67                               1.0KB       10
src/main.hml:15                               512B         1
```

---

### Режим подсчёта вызовов

Режим с минимальными накладными расходами, который только подсчитывает вызовы функций (без измерения времени).

```bash
hemlock profile --calls script.hml
```

---

## Форматы вывода

### Текст (по умолчанию)

Человекочитаемая сводка с таблицами.

```bash
hemlock profile script.hml
```

---

### JSON

Машиночитаемый формат для интеграции с другими инструментами.

```bash
hemlock profile --json script.hml
```

**Пример вывода:**
```json
{
  "total_time_ns": 1234567,
  "function_count": 5,
  "total_alloc_bytes": 4096,
  "total_alloc_count": 15,
  "functions": [
    {
      "name": "expensive_calc",
      "source_file": "script.hml",
      "line": 10,
      "self_time_ns": 892000,
      "total_time_ns": 892000,
      "call_count": 100,
      "alloc_bytes": 0,
      "alloc_count": 0
    }
  ],
  "alloc_sites": [
    {
      "source_file": "script.hml",
      "line": 42,
      "total_bytes": 1536,
      "alloc_count": 5,
      "current_bytes": 0
    }
  ]
}
```

---

### Flamegraph

Генерирует формат свёрнутого стека, совместимый с [flamegraph.pl](https://github.com/brendangregg/FlameGraph).

```bash
hemlock profile --flamegraph script.hml > profile.folded

# Генерация SVG с помощью flamegraph.pl
flamegraph.pl profile.folded > profile.svg
```

**Пример свёрнутого вывода:**
```
main;process_data;expensive_calc 892
main;process_data;helper 67
main;process_data 234
main 41
```

---

## Обнаружение утечек

Флаг `--leaks` показывает только выделения, которые никогда не были освобождены, что упрощает выявление утечек памяти.

```bash
hemlock profile --leaks script.hml
```

**Пример программы с утечками:**
```hemlock
fn leaky() {
    let p1 = alloc(100);    // Утечка - никогда не освобождается
    let p2 = alloc(200);    // OK - освобождается ниже
    free(p2);
}

fn clean() {
    let b = buffer(64);
    free(b);                // Правильно освобождено
}

leaky();
clean();
```

**Вывод с --leaks:**
```
=== Отчёт профайлера Hemlock ===

Общее время: 0.034мс
Вызвано функций: 2 уникальных
Всего выделений: 3 (388B)

--- Топ 2 по собственному времени ---

Функция                         Собств.   Общее    Вызовы     Выдел.     Кол-во
--------                        ------    -----    ------     ------     ------
leaky                       0.021мс    0.021мс       1       300B          2  (61.8%)
clean                       0.013мс    0.013мс       1        88B          1  (38.2%)

--- Утечки памяти (1 место) ---

Местоположение                                  Утечка      Всего    Кол-во
----------                                      ------      -----    ------
script.hml:2                                   100B       100B        1
```

Отчёт об утечках показывает:
- **Утечка** - Байты, не освобождённые на момент завершения программы
- **Всего** - Всего байт, когда-либо выделенных в этом месте
- **Кол-во** - Количество выделений в этом месте

---

## Понимание отчётов

### Статистика функций

| Колонка | Описание |
|---------|----------|
| Функция | Имя функции |
| Собств. | Время в функции без учёта вызываемых |
| Общее | Время включая все вызываемые функции |
| Вызовы | Количество вызовов функции |
| Выдел. | Всего байт, выделенных этой функцией |
| Кол-во | Количество выделений этой функцией |
| (%) | Процент от общего времени программы |

### Места выделения

| Колонка | Описание |
|---------|----------|
| Местоположение | Файл исходного кода и номер строки |
| Всего | Всего байт, выделенных в этом месте |
| Кол-во | Количество выделений |
| Утечка | Байты, всё ещё выделенные при завершении программы (только --leaks) |

### Единицы времени

Профайлер автоматически выбирает подходящие единицы:
- `нс` - Наносекунды (< 1мкс)
- `мкс` - Микросекунды (< 1мс)
- `мс` - Миллисекунды (< 1с)
- `с` - Секунды

---

## Справочник команд

```
hemlock profile [OPTIONS] <FILE>

OPTIONS:
    --cpu           Профилирование CPU/времени (по умолчанию)
    --memory        Профилирование выделения памяти
    --calls         Только подсчёт вызовов (минимальные накладные расходы)
    --leaks         Показать только неосвобождённые выделения (подразумевает --memory)
    --json          Вывод в формате JSON
    --flamegraph    Вывод в формате, совместимом с flamegraph
    --top N         Показать топ N записей (по умолчанию: 20)
```

---

## Генерация Flamegraph

Flamegraph визуализирует, где ваша программа тратит время, более широкие полосы указывают на большее время.

### Создание Flamegraph

1. Установите flamegraph.pl:
   ```bash
   git clone https://github.com/brendangregg/FlameGraph
   ```

2. Профилируйте вашу программу:
   ```bash
   hemlock profile --flamegraph script.hml > profile.folded
   ```

3. Сгенерируйте SVG:
   ```bash
   ./FlameGraph/flamegraph.pl profile.folded > profile.svg
   ```

4. Откройте `profile.svg` в браузере для интерактивной визуализации.

### Чтение Flamegraph

- **Ось X**: Процент от общего времени (ширина = пропорция времени)
- **Ось Y**: Глубина стека вызовов (низ = точка входа, верх = листовые функции)
- **Цвет**: Случайный, только для визуального различения
- **Клик**: Увеличение масштаба функции для просмотра вызываемых

---

## Лучшие практики

### 1. Профилируйте репрезентативные нагрузки

Профилируйте с реалистичными данными и паттернами использования. Маленькие тестовые случаи могут не выявить настоящие узкие места.

```bash
# Хорошо: Профилирование с данными, похожими на продакшн
hemlock profile --memory process_large_file.hml large_input.txt

# Менее полезно: Крошечный тестовый случай
hemlock profile quick_test.hml
```

### 2. Используйте --leaks во время разработки

Регулярно запускайте обнаружение утечек, чтобы выявлять утечки памяти на ранней стадии:

```bash
hemlock profile --leaks my_program.hml
```

### 3. Сравнивайте до и после

Профилируйте до и после оптимизаций для измерения эффекта:

```bash
# До оптимизации
hemlock profile --json script.hml > before.json

# После оптимизации
hemlock profile --json script.hml > after.json

# Сравнение результатов
```

### 4. Используйте --top для больших программ

Ограничьте вывод, чтобы сфокусироваться на самых значимых функциях:

```bash
hemlock profile --top 10 large_program.hml
```

### 5. Комбинируйте с Flamegraph

Для сложных паттернов вызовов flamegraph обеспечивает лучшую визуализацию, чем текстовый вывод:

```bash
hemlock profile --flamegraph complex_app.hml > app.folded
flamegraph.pl app.folded > app.svg
```

---

## Накладные расходы профайлера

Профайлер добавляет некоторые накладные расходы к выполнению программы:

| Режим | Накладные расходы | Случай использования |
|-------|-------------------|----------------------|
| `--calls` | Минимальные | Только подсчёт вызовов функций |
| `--cpu` | Низкие | Общее профилирование производительности |
| `--memory` | Умеренные | Анализ памяти и обнаружение утечек |

Для наиболее точных результатов профилируйте несколько раз и ищите устойчивые паттерны.

---

## Смотрите также

- [Управление памятью](../language-guide/memory.md) - Указатели и буферы
- [API памяти](../reference/memory-api.md) - Функции alloc, free, buffer
- [Асинхронность/Конкурентность](async-concurrency.md) - Профилирование асинхронного кода
