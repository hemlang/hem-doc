# Сборка и упаковка

Hemlock предоставляет встроенные инструменты для объединения многофайловых проектов в единые распространяемые файлы и создания самодостаточных исполняемых файлов.

## Обзор

| Команда | Выход | Применение |
|---------|-------|------------|
| `--bundle` | `.hmlc` или `.hmlb` | Распространение байткода (требует Hemlock для запуска) |
| `--package` | Исполняемый файл | Автономный бинарник (без зависимостей) |
| `--compile` | `.hmlc` | Компиляция одного файла (без разрешения импортов) |

## Сборка

Сборщик разрешает все операторы `import` из точки входа и объединяет их в единый файл.

### Базовое использование

```bash
# Собрать app.hml и все его импорты в app.hmlc
hemlock --bundle app.hml

# Указать выходной путь
hemlock --bundle app.hml -o dist/app.hmlc

# Создать сжатый бандл (.hmlb) - меньший размер файла
hemlock --bundle app.hml --compress -o app.hmlb

# Подробный вывод (показывает разрешённые модули)
hemlock --bundle app.hml --verbose
```

### Форматы вывода

**`.hmlc` (Несжатый)**
- Сериализованный формат AST
- Быстрая загрузка и выполнение
- Формат вывода по умолчанию

**`.hmlb` (Сжатый)**
- Сжатый zlib `.hmlc`
- Меньший размер файла (обычно уменьшение на 50-70%)
- Немного медленнее запуск из-за декомпрессии

### Запуск собранных файлов

```bash
# Запуск несжатого бандла
hemlock app.hmlc

# Запуск сжатого бандла
hemlock app.hmlb

# Передача аргументов
hemlock app.hmlc arg1 arg2
```

### Пример: Многомодульный проект

```
myapp/
├── main.hml
├── lib/
│   ├── math.hml
│   └── utils.hml
└── config.hml
```

```hemlock
// main.hml
import { add, multiply } from "./lib/math.hml";
import { log } from "./lib/utils.hml";
import { VERSION } from "./config.hml";

log(`App v${VERSION}`);
print(add(2, 3));
```

```bash
hemlock --bundle myapp/main.hml -o myapp.hmlc
hemlock myapp.hmlc  # Запуск со всеми собранными зависимостями
```

### Импорты stdlib

Сборщик автоматически разрешает импорты `@stdlib/`:

```hemlock
import { HashMap } from "@stdlib/collections";
import { now } from "@stdlib/time";
```

При сборке модули stdlib включаются в вывод.

## Упаковка

Упаковка создаёт самодостаточный исполняемый файл путём встраивания собранного байткода в копию интерпретатора Hemlock.

### Базовое использование

```bash
# Создать исполняемый файл из app.hml
hemlock --package app.hml

# Указать имя выхода
hemlock --package app.hml -o myapp

# Пропустить сжатие (быстрее запуск, больший файл)
hemlock --package app.hml --no-compress

# Подробный вывод
hemlock --package app.hml --verbose
```

### Запуск упакованных исполняемых файлов

```bash
# Упакованный исполняемый файл запускается напрямую
./myapp

# Аргументы передаются скрипту
./myapp arg1 arg2
```

### Формат пакета

Упакованные исполняемые файлы используют формат HMLP:

```
[бинарник hemlock][HMLB/HMLC payload][payload_size:u64][HMLP magic:u32]
```

Когда упакованный исполняемый файл запускается:
1. Он проверяет наличие встроенного payload в конце файла
2. Если найден, декомпрессирует и выполняет payload
3. Если не найден, работает как обычный интерпретатор Hemlock

### Опции сжатия

| Флаг | Формат | Запуск | Размер |
|------|--------|--------|--------|
| (по умолчанию) | HMLB | Обычный | Меньше |
| `--no-compress` | HMLC | Быстрее | Больше |

Для CLI-инструментов, где важно время запуска, используйте `--no-compress`.

## Инспектирование бандлов

Используйте `--info` для инспектирования собранных или скомпилированных файлов:

```bash
hemlock --info app.hmlc
```

Вывод:
```
=== Информация о файле: app.hmlc ===
Размер: 12847 байт
Формат: HMLC (скомпилированный AST)
Версия: 1
Флаги: 0x0001 [DEBUG]
Строки: 42
Операторы: 156
```

```bash
hemlock --info app.hmlb
```

Вывод:
```
=== Информация о файле: app.hmlb ===
Размер: 5234 байт
Формат: HMLB (сжатый бандл)
Версия: 1
Несжатый: 12847 байт
Сжатый: 5224 байт
Соотношение: уменьшение на 59.3%
```

## Нативная компиляция

Для настоящих нативных исполняемых файлов (без интерпретатора) используйте компилятор Hemlock:

```bash
# Компиляция в нативный исполняемый файл через C
hemlockc app.hml -o app

# Сохранить сгенерированный код C
hemlockc app.hml -o app --keep-c

# Выдать только C (не компилировать)
hemlockc app.hml -c -o app.c

# Уровень оптимизации
hemlockc app.hml -o app -O2
```

Компилятор генерирует код C и вызывает GCC для создания нативного бинарника. Это требует:
- Библиотеку рантайма Hemlock (`libhemlock_runtime`)
- Компилятор C (по умолчанию GCC)

### Опции компилятора

| Опция | Описание |
|-------|----------|
| `-o <file>` | Имя выходного исполняемого файла |
| `-c` | Только выдать код C |
| `--emit-c <file>` | Записать C в указанный файл |
| `-k, --keep-c` | Сохранить сгенерированный C после компиляции |
| `-O<level>` | Уровень оптимизации (0-3) |
| `--cc <path>` | Компилятор C для использования |
| `--runtime <path>` | Путь к библиотеке рантайма |
| `-v, --verbose` | Подробный вывод |

## Сравнение

| Подход | Портируемость | Запуск | Размер | Зависимости |
|--------|---------------|--------|--------|-------------|
| `.hml` | Только исходник | Время парсинга | Наименьший | Hemlock |
| `.hmlc` | Только Hemlock | Быстрый | Маленький | Hemlock |
| `.hmlb` | Только Hemlock | Быстрый | Меньше | Hemlock |
| `--package` | Автономный | Быстрый | Больше | Нет |
| `hemlockc` | Нативный | Самый быстрый | Варьируется | Библиотеки рантайма |

## Лучшие практики

1. **Разработка**: Запускайте файлы `.hml` напрямую для быстрой итерации
2. **Распространение (с Hemlock)**: Собирайте с `--compress` для меньших файлов
3. **Распространение (автономное)**: Упаковывайте для развёртывания без зависимостей
4. **Критичная производительность**: Используйте `hemlockc` для нативной компиляции

## Устранение неполадок

### "Cannot find stdlib"

Сборщик ищет stdlib в:
1. `./stdlib` (относительно исполняемого файла)
2. `../stdlib` (относительно исполняемого файла)
3. `/usr/local/lib/hemlock/stdlib`

Убедитесь, что Hemlock правильно установлен или запускайте из директории с исходниками.

### Циклические зависимости

```
Error: Circular dependency detected when loading 'path/to/module.hml'
```

Рефакторите ваши импорты, чтобы разорвать цикл. Рассмотрите использование общего модуля для общих типов.

### Большой размер пакета

- Используйте сжатие по умолчанию (не используйте `--no-compress`)
- Размер пакета включает полный интерпретатор (~500KB-1MB базовый)
- Для минимального размера используйте `hemlockc` для нативной компиляции
