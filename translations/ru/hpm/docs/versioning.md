# Версионирование

Полное руководство по семантическому версионированию в hpm.

## Семантическое версионирование

hpm использует [Семантическое версионирование 2.0.0](https://semver.org/) (semver) для версий пакетов.

### Формат версии

```
MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]
```

**Примеры:**
```
1.0.0           # Релизная версия
2.1.3           # Релизная версия
1.0.0-alpha     # Пре-релиз
1.0.0-beta.1    # Пре-релиз с номером
1.0.0-rc.1      # Релиз-кандидат
1.0.0+20231201  # С метаданными сборки
1.0.0-beta+exp  # Пре-релиз с метаданными сборки
```

### Компоненты версии

| Компонент | Описание | Пример |
|-----------|----------|--------|
| MAJOR | Несовместимые изменения | `1.0.0` → `2.0.0` |
| MINOR | Новые возможности (обратно совместимые) | `1.0.0` → `1.1.0` |
| PATCH | Исправления ошибок (обратно совместимые) | `1.0.0` → `1.0.1` |
| PRERELEASE | Идентификатор пре-релиза | `1.0.0-alpha` |
| BUILD | Метаданные сборки (игнорируются при сравнении) | `1.0.0+build123` |

### Когда увеличивать

| Тип изменения | Увеличение | Пример |
|---------------|------------|--------|
| Несовместимое изменение API | MAJOR | Удаление функции |
| Переименование публичной функции | MAJOR | `parse()` → `decode()` |
| Изменение сигнатуры функции | MAJOR | Добавление обязательного параметра |
| Добавление новой функции | MINOR | Добавление `validate()` |
| Добавление опционального параметра | MINOR | Новый опциональный аргумент `options` |
| Исправление ошибки | PATCH | Исправление null pointer |
| Улучшение производительности | PATCH | Более быстрый алгоритм |
| Внутренний рефакторинг | PATCH | Нет изменений API |

## Ограничения версий

### Синтаксис ограничений

| Синтаксис | Значение | Разрешается в |
|-----------|----------|---------------|
| `1.2.3` | Точная версия | Только 1.2.3 |
| `^1.2.3` | Caret (совместимые) | ≥1.2.3 и <2.0.0 |
| `~1.2.3` | Tilde (патч-обновления) | ≥1.2.3 и <1.3.0 |
| `>=1.0.0` | Минимум | 1.0.0 или выше |
| `>1.0.0` | Больше чем | Выше 1.0.0 |
| `<2.0.0` | Меньше чем | Ниже 2.0.0 |
| `<=2.0.0` | Максимум | 2.0.0 или ниже |
| `>=1.0.0 <2.0.0` | Диапазон | Между 1.0.0 и 2.0.0 |
| `*` | Любая | Любая версия |

### Caret-диапазоны (^)

Caret (`^`) позволяет изменения, не затрагивающие крайнюю левую ненулевую цифру:

```
^1.2.3  →  >=1.2.3 <2.0.0   # Позволяет 1.x.x
^0.2.3  →  >=0.2.3 <0.3.0   # Позволяет 0.2.x
^0.0.3  →  >=0.0.3 <0.0.4   # Позволяет только 0.0.3
```

**Используйте когда:** Хотите совместимые обновления в рамках мажорной версии.

**Наиболее распространённое ограничение** — рекомендуется для большинства зависимостей.

### Tilde-диапазоны (~)

Tilde (`~`) позволяет только патч-изменения:

```
~1.2.3  →  >=1.2.3 <1.3.0   # Позволяет 1.2.x
~1.2    →  >=1.2.0 <1.3.0   # Позволяет 1.2.x
~1      →  >=1.0.0 <2.0.0   # Позволяет 1.x.x
```

**Используйте когда:** Хотите только исправления ошибок, без новых возможностей.

### Диапазоны сравнения

Комбинируйте операторы сравнения для точного контроля:

```json
{
  "dependencies": {
    "owner/pkg": ">=1.0.0 <2.0.0",
    "owner/other": ">1.5.0 <=2.1.0"
  }
}
```

### Любая версия (*)

Соответствует любой версии:

```json
{
  "dependencies": {
    "owner/pkg": "*"
  }
}
```

**Предупреждение:** Не рекомендуется для продакшена. Всегда получает последнюю версию.

## Пре-релизные версии

### Идентификаторы пре-релизов

Пре-релизы имеют более низкий приоритет, чем релизы:

```
1.0.0-alpha < 1.0.0-alpha.1 < 1.0.0-beta < 1.0.0-rc.1 < 1.0.0
```

### Распространённые теги пре-релизов

| Тег | Значение | Стадия |
|-----|----------|--------|
| `alpha` | Ранняя разработка | Очень нестабильный |
| `beta` | Функционально завершён | Тестирование |
| `rc` | Релиз-кандидат | Финальное тестирование |
| `dev` | Снимок разработки | Нестабильный |

### Пре-релизы в ограничениях

Ограничения по умолчанию не соответствуют пре-релизам:

```
^1.0.0    # НЕ соответствует 1.1.0-beta
>=1.0.0   # НЕ соответствует 2.0.0-alpha
```

Чтобы включить пре-релизы, укажите их явно:

```
>=1.0.0-alpha <2.0.0   # Включает все пре-релизы 1.x
```

## Сравнение версий

### Правила сравнения

1. Сравнение MAJOR, MINOR, PATCH численно
2. Релиз > пре-релиз с той же версией
3. Пре-релизы сравниваются алфавитно-численно
4. Метаданные сборки игнорируются

### Примеры

```
1.0.0 < 1.0.1 < 1.1.0 < 2.0.0

1.0.0-alpha < 1.0.0-alpha.1 < 1.0.0-beta < 1.0.0

1.0.0 = 1.0.0+build123  # Метаданные сборки игнорируются
```

### Сортировка

Версии сортируются по возрастанию:

```
1.0.0
1.0.1
1.1.0
1.1.1
2.0.0-alpha
2.0.0-beta
2.0.0
```

## Разрешение версий

### Алгоритм разрешения

Когда несколько пакетов требуют одну зависимость:

1. Собрать все ограничения
2. Найти пересечение всех диапазонов
3. Выбрать максимальную версию в пересечении
4. Ошибка, если ни одна версия не удовлетворяет всем

### Пример разрешения

```
package-a requires hemlang/json@^1.0.0  (>=1.0.0 <2.0.0)
package-b requires hemlang/json@~1.2.0  (>=1.2.0 <1.3.0)

Пересечение: >=1.2.0 <1.3.0
Доступные: [1.0.0, 1.1.0, 1.2.0, 1.2.1, 1.2.5, 1.3.0]
Разрешённая: 1.2.5 (максимальная в пересечении)
```

### Обнаружение конфликтов

Конфликт происходит, когда ни одна версия не удовлетворяет всем ограничениям:

```
package-a requires hemlang/json@^1.0.0  (>=1.0.0 <2.0.0)
package-b requires hemlang/json@^2.0.0  (>=2.0.0 <3.0.0)

Пересечение: (пусто)
Результат: КОНФЛИКТ - ни одна версия не удовлетворяет обоим
```

## Лучшие практики

### Для потребителей пакетов

1. **Используйте caret-диапазоны** для большинства зависимостей:
   ```json
   "hemlang/json": "^1.2.0"
   ```

2. **Используйте tilde-диапазоны** для критических зависимостей:
   ```json
   "critical/lib": "~1.2.0"
   ```

3. **Фиксируйте версии** только при необходимости:
   ```json
   "unstable/pkg": "1.2.3"
   ```

4. **Коммитьте файл блокировки** для воспроизводимых сборок

5. **Обновляйте регулярно** для получения исправлений безопасности:
   ```bash
   hpm update
   hpm outdated
   ```

### Для авторов пакетов

1. **Начинайте с 0.1.0** для начальной разработки:
   - API может часто меняться
   - Пользователи ожидают нестабильность

2. **Переходите к 1.0.0**, когда API стабилен:
   - Публичное обязательство стабильности
   - Несовместимые изменения требуют увеличения мажорной версии

3. **Строго следуйте semver**:
   - Несовместимое изменение = MAJOR
   - Новая возможность = MINOR
   - Исправление ошибки = PATCH

4. **Используйте пре-релизы** для тестирования:
   ```bash
   git tag v2.0.0-beta.1
   git push --tags
   ```

5. **Документируйте несовместимые изменения** в CHANGELOG

## Публикация версий

### Создание релизов

```bash
# Обновить версию в package.json
# Отредактировать package.json: "version": "1.1.0"

# Закоммитить изменение версии
git add package.json
git commit -m "Bump version to 1.1.0"

# Создать и отправить тег
git tag v1.1.0
git push origin main --tags
```

### Формат тегов

Теги **должны** начинаться с `v`:

```
v1.0.0      ✓ Правильно
v1.0.0-beta ✓ Правильно
1.0.0       ✗ Не будет распознан
```

### Рабочий процесс релиза

```bash
# 1. Убедиться, что тесты проходят
hpm test

# 2. Обновить версию в package.json
# 3. Обновить CHANGELOG.md
# 4. Закоммитить изменения
git add -A
git commit -m "Release v1.2.0"

# 5. Создать тег
git tag v1.2.0

# 6. Отправить всё
git push origin main --tags
```

## Проверка версий

### Список установленных версий

```bash
hpm list
```

### Проверка обновлений

```bash
hpm outdated
```

Вывод:
```
Package         Current  Wanted  Latest
hemlang/json    1.0.0    1.0.5   1.2.0
hemlang/sprout  2.0.0    2.0.3   2.1.0
```

- **Current**: Установленная версия
- **Wanted**: Максимальная, соответствующая ограничению
- **Latest**: Последняя доступная

### Обновление пакетов

```bash
# Обновить все
hpm update

# Обновить конкретный пакет
hpm update hemlang/json
```

## См. также

- [Создание пакетов](creating-packages.md) — Руководство по публикации
- [Спецификация пакетов](package-spec.md) — Формат package.json
- [Команды](commands.md) — Справочник CLI
