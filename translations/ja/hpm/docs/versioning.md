# バージョニング

hpmにおけるセマンティックバージョニングの完全ガイド。

## セマンティックバージョニング

hpmはパッケージバージョンに[セマンティックバージョニング2.0.0](https://semver.org/)（semver）を使用します。

### バージョン形式

```
MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]
```

**例:**
```
1.0.0           # リリースバージョン
2.1.3           # リリースバージョン
1.0.0-alpha     # プレリリース
1.0.0-beta.1    # 番号付きプレリリース
1.0.0-rc.1      # リリース候補
1.0.0+20231201  # ビルドメタデータ付き
1.0.0-beta+exp  # プレリリース＋ビルドメタデータ
```

### バージョンコンポーネント

| コンポーネント | 説明 | 例 |
|-----------|-------------|---------|
| MAJOR | 破壊的変更 | `1.0.0` → `2.0.0` |
| MINOR | 新機能（後方互換） | `1.0.0` → `1.1.0` |
| PATCH | バグ修正（後方互換） | `1.0.0` → `1.0.1` |
| PRERELEASE | プレリリース識別子 | `1.0.0-alpha` |
| BUILD | ビルドメタデータ（比較で無視） | `1.0.0+build123` |

### いつインクリメントするか

| 変更タイプ | インクリメント | 例 |
|-------------|-----------|---------|
| 破壊的なAPI変更 | MAJOR | 関数の削除 |
| パブリック関数の名前変更 | MAJOR | `parse()` → `decode()` |
| 関数シグネチャの変更 | MAJOR | 必須パラメータの追加 |
| 新しい関数の追加 | MINOR | `validate()`の追加 |
| オプションパラメータの追加 | MINOR | 新しいオプション`options`引数 |
| バグ修正 | PATCH | nullポインタの修正 |
| パフォーマンス改善 | PATCH | より高速なアルゴリズム |
| 内部リファクタリング | PATCH | API変更なし |

## バージョン制約

### 制約の構文

| 構文 | 意味 | 解決範囲 |
|--------|---------|-------------|
| `1.2.3` | 正確なバージョン | 1.2.3のみ |
| `^1.2.3` | キャレット（互換） | ≥1.2.3 かつ <2.0.0 |
| `~1.2.3` | チルダ（パッチ更新） | ≥1.2.3 かつ <1.3.0 |
| `>=1.0.0` | 以上 | 1.0.0以上 |
| `>1.0.0` | より大きい | 1.0.0より上 |
| `<2.0.0` | 未満 | 2.0.0未満 |
| `<=2.0.0` | 以下 | 2.0.0以下 |
| `>=1.0.0 <2.0.0` | 範囲 | 1.0.0と2.0.0の間 |
| `*` | 任意 | 任意のバージョン |

### キャレット範囲（^）

キャレット（`^`）は最左の非ゼロ桁を変更しない変更を許可:

```
^1.2.3  →  >=1.2.3 <2.0.0   # 1.x.xを許可
^0.2.3  →  >=0.2.3 <0.3.0   # 0.2.xを許可
^0.0.3  →  >=0.0.3 <0.0.4   # 0.0.3のみを許可
```

**使用場面:** メジャーバージョン内で互換性のある更新が必要な場合。

**最も一般的な制約** - ほとんどの依存関係に推奨。

### チルダ範囲（~）

チルダ（`~`）はパッチレベルの変更のみを許可:

```
~1.2.3  →  >=1.2.3 <1.3.0   # 1.2.xを許可
~1.2    →  >=1.2.0 <1.3.0   # 1.2.xを許可
~1      →  >=1.0.0 <2.0.0   # 1.x.xを許可
```

**使用場面:** バグ修正のみが必要で、新機能は不要な場合。

### 比較範囲

比較演算子を組み合わせて正確に制御:

```json
{
  "dependencies": {
    "owner/pkg": ">=1.0.0 <2.0.0",
    "owner/other": ">1.5.0 <=2.1.0"
  }
}
```

### 任意のバージョン（*）

任意のバージョンに一致:

```json
{
  "dependencies": {
    "owner/pkg": "*"
  }
}
```

**警告:** 本番環境には推奨しません。常に最新バージョンを取得します。

## プレリリースバージョン

### プレリリース識別子

プレリリースはリリースより優先順位が低い:

```
1.0.0-alpha < 1.0.0-alpha.1 < 1.0.0-beta < 1.0.0-rc.1 < 1.0.0
```

### 一般的なプレリリースタグ

| タグ | 意味 | ステージ |
|-----|---------|-------|
| `alpha` | 初期開発 | 非常に不安定 |
| `beta` | 機能完了 | テスト中 |
| `rc` | リリース候補 | 最終テスト |
| `dev` | 開発スナップショット | 不安定 |

### 制約でのプレリリース

制約はデフォルトでプレリリースに一致しない:

```
^1.0.0    # 1.1.0-betaに一致しない
>=1.0.0   # 2.0.0-alphaに一致しない
```

プレリリースを含めるには、明示的に参照:

```
>=1.0.0-alpha <2.0.0   # すべての1.xプレリリースを含む
```

## バージョン比較

### 比較ルール

1. MAJOR、MINOR、PATCHを数値比較
2. 同じバージョンではリリース > プレリリース
3. プレリリースは英数字順で比較
4. ビルドメタデータは無視

### 例

```
1.0.0 < 1.0.1 < 1.1.0 < 2.0.0

1.0.0-alpha < 1.0.0-alpha.1 < 1.0.0-beta < 1.0.0

1.0.0 = 1.0.0+build123  # ビルドメタデータは無視
```

### ソート

バージョンは昇順でソート:

```
1.0.0
1.0.1
1.1.0
1.1.1
2.0.0-alpha
2.0.0-beta
2.0.0
```

## バージョン解決

### 解決アルゴリズム

複数のパッケージが同じ依存関係を要求する場合:

1. すべての制約を収集
2. すべての範囲の共通部分を見つける
3. 共通部分内で最高バージョンを選択
4. すべてを満たすバージョンがない場合はエラー

### 解決例

```
package-a requires hemlang/json@^1.0.0  (>=1.0.0 <2.0.0)
package-b requires hemlang/json@~1.2.0  (>=1.2.0 <1.3.0)

共通部分: >=1.2.0 <1.3.0
利用可能: [1.0.0, 1.1.0, 1.2.0, 1.2.1, 1.2.5, 1.3.0]
解決: 1.2.5（共通部分内で最高）
```

### 競合検出

すべての制約を満たすバージョンがない場合に競合が発生:

```
package-a requires hemlang/json@^1.0.0  (>=1.0.0 <2.0.0)
package-b requires hemlang/json@^2.0.0  (>=2.0.0 <3.0.0)

共通部分: （空）
結果: 競合 - 両方を満たすバージョンがない
```

## ベストプラクティス

### パッケージ利用者向け

1. **ほとんどの依存関係にキャレット範囲を使用**:
   ```json
   "hemlang/json": "^1.2.0"
   ```

2. **重要な依存関係にはチルダ範囲を使用**:
   ```json
   "critical/lib": "~1.2.0"
   ```

3. **必要な場合のみバージョンを固定**:
   ```json
   "unstable/pkg": "1.2.3"
   ```

4. **再現可能なビルドのためにロックファイルをコミット**

5. **セキュリティ修正を得るために定期的に更新**:
   ```bash
   hpm update
   hpm outdated
   ```

### パッケージ作成者向け

1. **初期開発は0.1.0から開始**:
   - APIは頻繁に変更される可能性
   - ユーザーは不安定さを期待

2. **APIが安定したら1.0.0に移行**:
   - 安定性へのパブリックコミットメント
   - 破壊的変更にはメジャーバンプが必要

3. **semverを厳密に守る**:
   - 破壊的変更 = MAJOR
   - 新機能 = MINOR
   - バグ修正 = PATCH

4. **テストにはプレリリースを使用**:
   ```bash
   git tag v2.0.0-beta.1
   git push --tags
   ```

5. **破壊的変更をCHANGELOGにドキュメント化**

## バージョンの公開

### リリースの作成

```bash
# package.jsonのバージョンを更新
# package.jsonを編集: "version": "1.1.0"

# バージョン変更をコミット
git add package.json
git commit -m "Bump version to 1.1.0"

# タグを作成してプッシュ
git tag v1.1.0
git push origin main --tags
```

### タグ形式

タグは`v`で始まる**必要あり**:

```
v1.0.0      ✓ 正しい
v1.0.0-beta ✓ 正しい
1.0.0       ✗ 認識されない
```

### リリースワークフロー

```bash
# 1. テストが合格することを確認
hpm test

# 2. package.jsonのバージョンを更新
# 3. CHANGELOG.mdを更新
# 4. 変更をコミット
git add -A
git commit -m "Release v1.2.0"

# 5. タグを作成
git tag v1.2.0

# 6. すべてをプッシュ
git push origin main --tags
```

## バージョンの確認

### インストールされたバージョンをリスト

```bash
hpm list
```

### 更新を確認

```bash
hpm outdated
```

出力:
```
Package         Current  Wanted  Latest
hemlang/json    1.0.0    1.0.5   1.2.0
hemlang/sprout  2.0.0    2.0.3   2.1.0
```

- **Current**: インストールされているバージョン
- **Wanted**: 制約に一致する最高バージョン
- **Latest**: 最新の利用可能バージョン

### パッケージの更新

```bash
# すべてを更新
hpm update

# 特定のパッケージを更新
hpm update hemlang/json
```

## 参照

- [パッケージの作成](creating-packages.md) - 公開ガイド
- [パッケージ仕様](package-spec.md) - package.jsonの形式
- [コマンド](commands.md) - CLIリファレンス
